<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>2022-04-20-è¯‘-ä½¿ç”¨-Tokio-å¤„ç†-CPU-å¯†é›†å‹ä»»åŠ¡ - Trdthg&#x27;s Self</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">trans</li><li class="chapter-item expanded "><a href="../trans/2022-04-20-è¯‘-ä½¿ç”¨-Tokio-å¤„ç†-CPU-å¯†é›†å‹ä»»åŠ¡.html" class="active"><strong aria-hidden="true">1.</strong> 2022-04-20-è¯‘-ä½¿ç”¨-Tokio-å¤„ç†-CPU-å¯†é›†å‹ä»»åŠ¡</a></li><li class="chapter-item expanded "><a href="../trans/2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde.html"><strong aria-hidden="true">2.</strong> 2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde</a></li><li class="chapter-item expanded "><a href="../trans/2023-01-01-è¯‘-æ‹“å±•-Rust-ä¸­çš„-Map.html"><strong aria-hidden="true">3.</strong> 2023-01-01-è¯‘-æ‹“å±•-Rust-ä¸­çš„-Map</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-01-è¯‘-search_engine.html"><strong aria-hidden="true">4.</strong> 2022-04-01-è¯‘-search_engine</a></li><li class="chapter-item expanded "><a href="../trans/2022-05-04-è¯‘-å¯è§†åŒ–-Rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€.html"><strong aria-hidden="true">5.</strong> 2022-05-04-è¯‘-å¯è§†åŒ–-Rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-13-è¯‘-tail_latency.html"><strong aria-hidden="true">6.</strong> 2022-04-13-è¯‘-tail_latency</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-30-è¯‘-ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-Rust-ï¼Ÿ.html"><strong aria-hidden="true">7.</strong> 2022-04-30-è¯‘-ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-Rust-ï¼Ÿ</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-11-è¯‘-å¼‚æ­¥-Rustï¼šåä½œä¸æŠ¢å å¼è°ƒåº¦.html"><strong aria-hidden="true">8.</strong> 2022-04-11-è¯‘-å¼‚æ­¥-Rustï¼šåä½œä¸æŠ¢å å¼è°ƒåº¦</a></li><li class="chapter-item expanded "><a href="../trans/2023-01-02-è¯‘-æœªåˆå§‹åŒ–å†…å­˜:-unsafe-Rustå¤ªéš¾äº†.html"><strong aria-hidden="true">9.</strong> 2023-01-02-è¯‘-æœªåˆå§‹åŒ–å†…å­˜:-unsafe-Rustå¤ªéš¾äº†</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/index.html"><strong aria-hidden="true">10.</strong> 2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-4-é‡æ„.html"><strong aria-hidden="true">10.1.</strong> Rust-å…­è¾¹å½¢æ¶æ„-4-é‡æ„</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-2-å†…å­˜å­˜å‚¨åº“.html"><strong aria-hidden="true">10.2.</strong> Rust-å…­è¾¹å½¢æ¶æ„-2-å†…å­˜å­˜å‚¨åº“</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-7-é•¿æœŸå­˜å‚¨åº“.html"><strong aria-hidden="true">10.3.</strong> Rust-å…­è¾¹å½¢æ¶æ„-7-é•¿æœŸå­˜å‚¨åº“</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ.html"><strong aria-hidden="true">10.4.</strong> Rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-5-å…¶ä»–ç”¨ä¾‹.html"><strong aria-hidden="true">10.5.</strong> Rust-å…­è¾¹å½¢æ¶æ„-5-å…¶ä»–ç”¨ä¾‹</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-6-CLI.html"><strong aria-hidden="true">10.6.</strong> Rust-å…­è¾¹å½¢æ¶æ„-6-CLI</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-3-HTTP-API.html"><strong aria-hidden="true">10.7.</strong> Rust-å…­è¾¹å½¢æ¶æ„-3-HTTP-API</a></li><li class="chapter-item expanded "><a href="../trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/index.html"><strong aria-hidden="true">10.8.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">note</li><li class="chapter-item expanded "><a href="../note/java/index.html"><strong aria-hidden="true">11.</strong> java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../note/java/java.html"><strong aria-hidden="true">11.1.</strong> java</a></li><li class="chapter-item expanded "><a href="../note/java/springboot.html"><strong aria-hidden="true">11.2.</strong> springboot</a></li><li class="chapter-item expanded "><a href="../note/java/spring.html"><strong aria-hidden="true">11.3.</strong> spring</a></li><li class="chapter-item expanded "><a href="../note/java/sourceread.html"><strong aria-hidden="true">11.4.</strong> sourceread</a></li><li class="chapter-item expanded "><a href="../note/java/index.html"><strong aria-hidden="true">11.5.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="../note/frontend/index.html"><strong aria-hidden="true">12.</strong> frontend</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../note/frontend/mini_bundle.html"><strong aria-hidden="true">12.1.</strong> mini_bundle</a></li><li class="chapter-item expanded "><a href="../note/frontend/js_advanced.html"><strong aria-hidden="true">12.2.</strong> js_advanced</a></li><li class="chapter-item expanded "><a href="../note/frontend/mini_vue.html"><strong aria-hidden="true">12.3.</strong> mini_vue</a></li><li class="chapter-item expanded "><a href="../note/frontend/vue.html"><strong aria-hidden="true">12.4.</strong> vue</a></li><li class="chapter-item expanded "><a href="../note/frontend/list.html"><strong aria-hidden="true">12.5.</strong> list</a></li><li class="chapter-item expanded "><a href="../note/frontend/http.html"><strong aria-hidden="true">12.6.</strong> http</a></li><li class="chapter-item expanded "><a href="../note/frontend/flutter.html"><strong aria-hidden="true">12.7.</strong> flutter</a></li><li class="chapter-item expanded "><a href="../note/frontend/css.html"><strong aria-hidden="true">12.8.</strong> css</a></li><li class="chapter-item expanded "><a href="../note/frontend/vdom.html"><strong aria-hidden="true">12.9.</strong> vdom</a></li><li class="chapter-item expanded "><a href="../note/frontend/index.html"><strong aria-hidden="true">12.10.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">blog</li><li class="chapter-item expanded "><a href="../blog/index.html"><strong aria-hidden="true">13.</strong> README</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">docs</li><li class="chapter-item expanded "><a href="../docs/log.html"><strong aria-hidden="true">14.</strong> log</a></li><li class="chapter-item expanded "><a href="../docs/intro.html"><strong aria-hidden="true">15.</strong> intro</a></li><li class="chapter-item expanded "><a href="../docs/magic/index.html"><strong aria-hidden="true">16.</strong> magic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../docs/magic/riscv.html"><strong aria-hidden="true">16.1.</strong> riscv</a></li><li class="chapter-item expanded "><a href="../docs/magic/haskell.html"><strong aria-hidden="true">16.2.</strong> haskell</a></li><li class="chapter-item expanded "><a href="../docs/magic/bash.html"><strong aria-hidden="true">16.3.</strong> bash</a></li><li class="chapter-item expanded "><a href="../docs/magic/memory_ordering.html"><strong aria-hidden="true">16.4.</strong> memory_ordering</a></li><li class="chapter-item expanded "><a href="../docs/magic/linuxIO.html"><strong aria-hidden="true">16.5.</strong> linuxIO</a></li><li class="chapter-item expanded "><a href="../docs/magic/cicd.html"><strong aria-hidden="true">16.6.</strong> cicd</a></li><li class="chapter-item expanded "><a href="../docs/magic/fd.html"><strong aria-hidden="true">16.7.</strong> fd</a></li><li class="chapter-item expanded "><a href="../docs/magic/hadoop.html"><strong aria-hidden="true">16.8.</strong> hadoop</a></li><li class="chapter-item expanded "><a href="../docs/magic/go.html"><strong aria-hidden="true">16.9.</strong> go</a></li><li class="chapter-item expanded "><a href="../docs/magic/async.html"><strong aria-hidden="true">16.10.</strong> async</a></li><li class="chapter-item expanded "><a href="../docs/magic/index.html"><strong aria-hidden="true">16.11.</strong> README</a></li><li class="chapter-item expanded "><a href="../docs/magic/software_arch.html"><strong aria-hidden="true">16.12.</strong> software_arch</a></li></ol></li><li class="chapter-item expanded "><a href="../docs/riscv/index.html"><strong aria-hidden="true">17.</strong> riscv</a></li><li class="chapter-item expanded "><a href="../docs/common/index.html"><strong aria-hidden="true">18.</strong> common</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../docs/common/pgsql.html"><strong aria-hidden="true">18.1.</strong> pgsql</a></li><li class="chapter-item expanded "><a href="../docs/common/git.html"><strong aria-hidden="true">18.2.</strong> git</a></li><li class="chapter-item expanded "><a href="../docs/common/linux.html"><strong aria-hidden="true">18.3.</strong> linux</a></li><li class="chapter-item expanded "><a href="../docs/common/datastructure.html"><strong aria-hidden="true">18.4.</strong> datastructure</a></li><li class="chapter-item expanded "><a href="../docs/common/docker.html"><strong aria-hidden="true">18.5.</strong> docker</a></li><li class="chapter-item expanded "><a href="../docs/common/analyze.html"><strong aria-hidden="true">18.6.</strong> analyze</a></li><li class="chapter-item expanded "><a href="../docs/common/oci.html"><strong aria-hidden="true">18.7.</strong> oci</a></li><li class="chapter-item expanded "><a href="../docs/common/unsorted.html"><strong aria-hidden="true">18.8.</strong> unsorted</a></li><li class="chapter-item expanded "><a href="../docs/common/oauth2.html"><strong aria-hidden="true">18.9.</strong> oauth2</a></li><li class="chapter-item expanded "><a href="../docs/common/vim.html"><strong aria-hidden="true">18.10.</strong> vim</a></li><li class="chapter-item expanded "><a href="../docs/common/python.html"><strong aria-hidden="true">18.11.</strong> python</a></li><li class="chapter-item expanded "><a href="../docs/common/index.html"><strong aria-hidden="true">18.12.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="../docs/rust/index.html"><strong aria-hidden="true">19.</strong> rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../docs/rust/mini_tokio.html"><strong aria-hidden="true">19.1.</strong> mini_tokio</a></li><li class="chapter-item expanded "><a href="../docs/rust/wasm.html"><strong aria-hidden="true">19.2.</strong> wasm</a></li><li class="chapter-item expanded "><a href="../docs/rust/rust_quiz.html"><strong aria-hidden="true">19.3.</strong> rust_quiz</a></li><li class="chapter-item expanded "><a href="../docs/rust/rust.html"><strong aria-hidden="true">19.4.</strong> rust</a></li><li class="chapter-item expanded "><a href="../docs/rust/print_into_detail.html"><strong aria-hidden="true">19.5.</strong> print_into_detail</a></li><li class="chapter-item expanded "><a href="../docs/rust/net-piercer.html"><strong aria-hidden="true">19.6.</strong> net-piercer</a></li><li class="chapter-item expanded "><a href="../docs/rust/rs_channel.html"><strong aria-hidden="true">19.7.</strong> rs_channel</a></li><li class="chapter-item expanded "><a href="../docs/rust/lists.html"><strong aria-hidden="true">19.8.</strong> lists</a></li><li class="chapter-item expanded "><a href="../docs/rust/index.html"><strong aria-hidden="true">19.9.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="../docs/riscv/index.html"><strong aria-hidden="true">20.</strong> riscv</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../docs/riscv/index.html"><strong aria-hidden="true">20.1.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">other</li><li class="chapter-item expanded "><a href="../other/2023-04-12-remote-usb.html"><strong aria-hidden="true">21.</strong> 2023-04-12-remote-usb</a></li><li class="chapter-item expanded "><a href="../other/resources.html"><strong aria-hidden="true">22.</strong> resources</a></li><li class="chapter-item expanded "><a href="../other/i3wm.html"><strong aria-hidden="true">23.</strong> i3wm</a></li><li class="chapter-item expanded "><a href="../other/lsm.html"><strong aria-hidden="true">24.</strong> lsm</a></li><li class="chapter-item expanded "><a href="../other/site_update_log.html"><strong aria-hidden="true">25.</strong> site_update_log</a></li><li class="chapter-item expanded "><a href="../other/ioclub/index.html"><strong aria-hidden="true">26.</strong> ioclub</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../other/ioclub/share_1.html"><strong aria-hidden="true">26.1.</strong> share_1</a></li><li class="chapter-item expanded "><a href="../other/ioclub/index.html"><strong aria-hidden="true">26.2.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/index.html"><strong aria-hidden="true">27.</strong> 2021-åç«¯</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_1.html"><strong aria-hidden="true">27.1.</strong> backend_1</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_2.html"><strong aria-hidden="true">27.2.</strong> backend_2</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_3.html"><strong aria-hidden="true">27.3.</strong> backend_3</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_4.html"><strong aria-hidden="true">27.4.</strong> backend_4</a></li></ol></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/index.html"><strong aria-hidden="true">28.</strong> 2021-åç«¯</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_1.html"><strong aria-hidden="true">28.1.</strong> backend_1</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_2.html"><strong aria-hidden="true">28.2.</strong> backend_2</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_3.html"><strong aria-hidden="true">28.3.</strong> backend_3</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/backend_4.html"><strong aria-hidden="true">28.4.</strong> backend_4</a></li><li class="chapter-item expanded "><a href="../other/2021-åç«¯/index.html"><strong aria-hidden="true">28.5.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">draft</li><li class="chapter-item expanded "><a href="../draft/ç»„æˆåŸç†.html"><strong aria-hidden="true">29.</strong> ç»„æˆåŸç†</a></li><li class="chapter-item expanded "><a href="../draft/è®¡ç®—æœºç½‘ç»œ.html"><strong aria-hidden="true">30.</strong> è®¡ç®—æœºç½‘ç»œ</a></li><li class="chapter-item expanded "><a href="../draft/è¯‘-pkg_mng.html"><strong aria-hidden="true">31.</strong> è¯‘-pkg_mng</a></li><li class="chapter-item expanded "><a href="../draft/DistributedSystem.html"><strong aria-hidden="true">32.</strong> DistributedSystem</a></li><li class="chapter-item expanded "><a href="../draft/oscamp2022.html"><strong aria-hidden="true">33.</strong> oscamp2022</a></li><li class="chapter-item expanded "><a href="../draft/compile.html"><strong aria-hidden="true">34.</strong> compile</a></li><li class="chapter-item expanded "><a href="../draft/test.html"><strong aria-hidden="true">35.</strong> test</a></li><li class="chapter-item expanded "><a href="../draft/ld.html"><strong aria-hidden="true">36.</strong> ld</a></li><li class="chapter-item expanded "><a href="../draft/æ•°æ®åº“è®¾è®¡.html"><strong aria-hidden="true">37.</strong> æ•°æ®åº“è®¾è®¡</a></li><li class="chapter-item expanded "><a href="../draft/index.html"><strong aria-hidden="true">38.</strong> README</a></li><li class="chapter-item expanded "><a href="../draft/computer_network/index.html"><strong aria-hidden="true">39.</strong> computer_network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../draft/computer_network/index.html"><strong aria-hidden="true">39.1.</strong> README</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Trdthg&#x27;s Self</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://thenewstack.io/using-rustlangs-async-tokio-runtime-for-cpu-bound-tasks/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/Akagi201">Akagi201</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡"><a class="header" href="#ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡">ä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h1>
<p>å°½ç®¡ async é€šå¸¸éƒ½è¢«åº”ç”¨äºå¼‚æ­¥ç½‘ç»œ I/Oï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šåƒä½ ä»‹ç»ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°æ®åˆ†æå¼•æ“ç­‰ï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<h2 id="tokio-æ˜¯ä»€ä¹ˆ"><a class="header" href="#tokio-æ˜¯ä»€ä¹ˆ">Tokio æ˜¯ä»€ä¹ˆï¼Ÿ</a></h2>
<p>Rust æœ¬èº«æä¾›äº†ä¸€ä¸ªç±»ä¼¼äº JavaScript çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸å’Œå¼‚æ­¥ I/Oã€‚ä¸€ä¸ªè¿è¡Œæ—¶æ˜¯å¿…é¡»çš„ï¼Œå°½ç®¡ç¤¾åŒºæœ‰å¾ˆå¤šå¼‚æ­¥è¿è¡Œæ—¶çš„é€‰æ‹©ï¼Œä½†æ˜¯ Tokio æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†ã€‚å°½ç®¡ Tokio åœ¨å®˜ç½‘ä¸Šæè¿°åˆ°å®ƒæ˜¯
Rust è¯­è¨€çš„ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æä¾›äº†ç¼–å†™ç½‘ç»œæœåŠ¡æ‰€éœ€è¦çš„æ¨¡å—ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«ç”¨åœ¨å…¶å®ƒåœºæ™¯ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡"><a class="header" href="#ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡">ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h2>
<p>ç°ä»£åŒ–çš„æ•°æ®åˆ†æå¼•æ“æ€»æ˜¯ä¸å¯é¿å…çš„è¦å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥åŠé€šè¿‡ç½‘ç»œå’Œå¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼ˆæ¯”å¦‚ ASW S3ã€GCP Cloudã€Azure
ç­‰ï¼‰è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œä»»ä½•ä½¿ç”¨ Rust å®ç°çš„ç³»ç»Ÿï¼Œå¤§å¤šéƒ½ä¼šç”¨ Tokio å»å¤„ç†è¿™éƒ¨åˆ†ç½‘ç»œç›¸å…³çš„æœåŠ¡ï¼Œæˆ–è€…æ˜¯ä¸€éƒ¨åˆ†æ–‡ä»¶ I/O æœåŠ¡ã€‚</p>
<p>é™¤äº†åº”å¯¹ç½‘ç»œå¤–ï¼Œæ•°æ®åˆ†æå¼•æ“è¿˜éœ€è¦åšå¤§é‡ç¹é‡çš„çš„ CPU è®¡ç®—ï¼Œæ¶ˆè€—å¤§é‡ CPU
èµ„æºå»è¿›è¡Œè¯¸å¦‚ï¼šé‡æ–°ç»„ç»‡æ•°æ®å­˜å‚¨ã€æå‰è®¡ç®—å„ç§ç´¢å¼•ã€æˆ–è€…æ˜¯ç›´æ¥å›å¤å®¢æˆ·ç«¯è¯·æ±‚ç­‰å·¥ä½œã€‚è¿™äº›å¤æ‚è®¡ç®—é€šå¸¸ä¼šè¢«åˆ‡æˆè®¸å¤šå•ç‹¬çš„å—ï¼ˆæˆ‘æŠŠå®ƒä»¬ç§°ä¸º
&quot;ä»»åŠ¡&quot;ï¼‰ï¼Œç„¶åè¢«å¹¶è¡Œçš„å¤„ç†ï¼Œä»¥åˆ©ç”¨åˆ°ç°ä»£ CPU çš„å¤šæ ¸ç‰¹æ€§ã€‚</p>
<p>ä»»åŠ¡è°ƒåº¦å™¨ä¼šå†³å®šå“ªä¸ªä»»åŠ¡åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œå®ƒä¼šå°†ä»»åŠ¡æ˜ å°„åˆ°åˆé€‚çš„ CPU å†…æ ¸æˆ–è€…æ˜¯çº¿ç¨‹ä¸Šã€‚</p>
<p>å­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œå¯¹äºå„ç§ä»»åŠ¡è°ƒåº¦å™¨ã€å·¥ä½œæ± ã€çº¿ç¨‹æ± ç­‰å·²ç»ç§¯ç´¯äº†å¾ˆå¤šå¹´çš„ç ”ç©¶ã€‚</p>
<p>æˆ‘è‡ªå·±å·²ç»å®ç°å¹¶ä¸”ä½¿ç”¨è¿‡å‡ ä¸ªè‡ªå®šä¹‰çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚ä»–ä»¬åœ¨å¤§å¤šæ•°æ—¶é—´ (99.9%)
éƒ½å·¥ä½œçš„å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å¤„ç†è¾¹ç¼˜æƒ…å†µï¼ˆæ¯”å¦‚å¿«é€Ÿåœæœºã€ä»»åŠ¡å–æ¶ˆã€æ¸…ç†ç­‰ï¼‰æ—¶ï¼Œä»–ä»¬çš„æ•ˆæœéå¸¸ä¸å°½äººæ„ã€‚ç”±äºè¿™äº›ä»»åŠ¡è°ƒåº¦å™¨ä½¿ç”¨äº†è¾ƒä½çº§åˆ«çš„çº¿ç¨‹åŸè¯­ï¼Œå‡ºç°çº¿ç¨‹é—´ç«äº‰çš„æƒ…å†µæ¯”æ¯”çš†æ˜¯ï¼Œæ‰€ä»¥æˆ‘ä¸å»ºè®®è¿™æ ·åšã€‚</p>
<p>å› æ­¤ï¼Œå½“æˆ‘åœ¨ Rust ç”Ÿæ€ä¸­å¯»æ‰¾ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨æ—¶ï¼Œä½ ä¼šå¾ˆè‡ªç„¶çš„é€‰æ‹© Tokioã€‚Tokio æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼š</p>
<ol>
<li>ä½ åªéœ€è¦ Tokioï¼Œå¹¶ä¸éœ€è¦æ·»åŠ å…¶ä»–ä¾èµ–é¡¹ã€‚</li>
<li>Tokio å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ <a href="https://tokio.rs/blog/2019-10-scheduler">æ”¯æŒä»»åŠ¡çªƒå–çš„è°ƒåº¦å™¨</a>ã€‚</li>
<li>Tokio å†…éƒ¨å®ç°äº†å¯¹ async/await çš„æ”¯æŒã€‚å¹¶ä¸”æœ‰è®¸å¤šç›¸å¯¹æˆç†Ÿçš„åº“å»å¤„ç†æµã€å¼‚æ­¥é”ã€ç®¡é“ã€å¼‚æ­¥å–æ¶ˆç­‰ã€‚</li>
<li>Tokio åœ¨ Rust ç”Ÿæ€ç³»ç»Ÿä¸­ç»è¿‡äº†è‰¯å¥½æµ‹è¯•ï¼Œå¹¶ä¸”æœ‰ç€å¤§é‡ä½¿ç”¨æ¡ˆä¾‹ã€‚</li>
<li>Tokio é€šå¸¸ä¼šå°†æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å’Œ <code>Future</code> æ”¾åœ¨åŒä¸€ä¸ªæ‰§è¡Œå™¨å†…ï¼Œè¿™æœ‰åˆ©äºå®ç°å±€éƒ¨ç¼“å­˜ã€‚</li>
<li>Tokio çš„ <a href="https://tokio.rs/tokio/tutorial">æ–‡æ¡£</a> å¾ˆå®Œå–„ï¼Œå¹¶ä¸”åœ¨ç§¯ææ›´æ–°ç»´æŠ¤ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œé€‰æ‹© Tokio ä½œä¸º CPU å¯†é›†å‹ä»»åŠ¡çš„ä»»åŠ¡è°ƒåº¦ç¨‹åºæ˜¯ç†æ‰€åº”å½“çš„ï¼Œå¯¹å§ï¼ŸWROOOOOOOONGï¼</p>
<h2 id="ä½¿ç”¨-tokio-çš„åå¯¹æ„è§"><a class="header" href="#ä½¿ç”¨-tokio-çš„åå¯¹æ„è§">ä½¿ç”¨ Tokio çš„åå¯¹æ„è§</a></h2>
<p>é€‰æ‹© Tokio åœ¨æˆ‘ä»¬å›¢é˜Ÿä¸­å˜æˆäº†ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œåˆ°ç°åœ¨ä¾ç„¶ä¸æ˜¯æ‰€æœ‰äººéƒ½è®¤å¯è¿™ä¸ªå†³å®šã€‚åœ¨æˆ‘ä»¬åš DataFusion å’Œ InfluxDB IOx
çš„æ—©æœŸï¼Œæˆ‘ä»¬å¾ˆæ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åå¯¹æ„è§ï¼š</p>
<h3 id="tokio-æ–‡æ¡£çš„è­¦å‘Š"><a class="header" href="#tokio-æ–‡æ¡£çš„è­¦å‘Š">Tokio æ–‡æ¡£çš„è­¦å‘Šï¼š</a></h3>
<p>è€ç‰ˆæœ¬çš„ Tokio æ–‡æ¡£ï¼ˆæ¯”å¦‚ 1.10 ç‰ˆï¼‰é‡Œé¢æœ‰ä¸€æ¡è‘—åçš„è­¦å‘Šï¼š</p>
<blockquote>
<p>If your code is CPU-bound and you wish to limit the number of threads used to
run it, you should run it on another thread pool such as Rayon.</p>
</blockquote>
<p>å¦‚æœä½ çš„ä»£ç è¦å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå¹¶ä¸”æƒ³è¦å°½é‡å‡å°‘ä½¿ç”¨åˆ°çš„çº¿ç¨‹æ•°ï¼Œä½ åº”è¯¥å°†è¿™äº›ä»»åŠ¡åˆ†é…åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ± æ¯”å¦‚ Rayonã€‚</p>
<p>è¿™ä¸ªè­¦å‘Šå¯¹æˆ‘ä»¬å›¢é˜Ÿå’Œç¤¾åŒºéƒ½é€ æˆäº†å¾ˆå¤§çš„å›°æƒ‘ã€‚å¾ˆå¤šäººè¯»äº†ä¹‹åéƒ½ä»¥ä¸º Tokio æ°¸è¿œä¸åº”è¯¥ç”¨æ¥å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ã€‚ä½†æ˜¯æ–‡æ¡£çš„å…³é”®å…¶å®æ˜¯è¯´ï¼Œä¸€ä¸ªè¿è¡Œæ—¶å®ä¾‹ï¼ˆåŒä¸€ä¸ªçº¿ç¨‹æ± ï¼‰ä¸åº”è¯¥åŒæ—¶ç”¨äº I/O å’Œ CPU
è®¡ç®—ï¼Œæˆ‘ä»¬ä¹‹åæ¾„æ¸…äº†<a href="https://docs.rs/tokio/1.14.0/tokio/#cpu-bound-tasks-and-blocking-code">æ–‡æ¡£</a>
çš„æ„å›¾ã€‚</p>
<blockquote>
<p>é¡ºä¾¿è¯´ä¸€å¥ï¼ŒTokio æ–‡æ¡£å»ºè®®ç”¨ Rayon å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ã€‚Rayon
å¯¹äºå¾ˆå¤šç¨‹åºéƒ½æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ”¯æŒå¼‚æ­¥ã€‚å¦‚æœä½ çš„ä»£ç ä¸­å“ªæ€•åªæœ‰ä¸€ç‚¹éœ€è¦ä½¿ç”¨å¼‚æ­¥ï¼Œé‚£ä½ å°±ä¸å¾—ä¸è·¨è¿‡åŒæ­¥å’Œå¼‚æ­¥çš„ç—›è‹¦è¾¹ç•Œã€‚æˆ‘è¿˜å‘ç°å®ç°ä¸€ä¸ª
<a href="http://justinjaffray.com/query-engines-push-vs.-pull/">åŸºäºæ‹‰å–çš„æ‰§è¡Œå™¨æ¨¡å‹</a>
ä¼šæ›´å›°éš¾ï¼Œè¿™ç§æ¨¡å‹è¦æ±‚æŸä¸ªä»»åŠ¡å¿…é¡»ç­‰å¾…æ‰€æœ‰çš„è¾“å…¥éƒ½å‡†å¤‡å¥½åœ¨èƒ½åœ¨ Rayon ä¸­è¿è¡Œ</p>
</blockquote>
<h3 id="å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ "><a class="header" href="#å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ ">å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ </a></h3>
<p>èªæ˜çš„äººä¼šè¯´ï¼šä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ä¼šå¢åŠ è¯·æ±‚çš„<a href="https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577">å°¾éƒ¨å»¶è¿Ÿ</a>ï¼Œè¿™æ˜¯éš¾ä»¥ä»¤äººæ¥å—çš„ã€‚</p>
<p>å°¾éƒ¨å»¶è¿Ÿï¼ŸğŸ™„</p>
<p>ä½ å¯èƒ½è®¤ä¸ºï¼šæˆ‘æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ•°æ®åº“ï¼Œå°¾éƒ¨å»¶è¿Ÿå¬èµ·æ¥åƒæ˜¯å¯¹äºé«˜è´Ÿè½½çš„ Web æœåŠ¡å™¨çš„ä¸€ä¸ªå­¦æœ¯é—®é¢˜â€¦â€¦â€</p>
<p>ä½†å…¶å®ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ï¼šæ€è€ƒä¸€ä¸‹å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥å¯¹äºä½¿ç”¨å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼ˆæ¯”å¦‚ Kubernetesï¼‰éƒ¨ç½²çš„æœåŠ¡æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æ£€æŸ¥çš„æ–¹å¼é€šå¸¸æ˜¯å‘é€ä¸€ä¸ª HTTP
è¯·æ±‚åˆ°æŸä¸ª APIï¼Œä¾‹å¦‚ <code>/health</code>ã€‚å¦‚æœè¯¥è¯·æ±‚å·²ç»è¢«åˆ†æ´¾åˆ°æŸä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ Tokio æ­£åœ¨å¿™äºä½¿ç”¨ CPU è¿›è¡Œå¤§é‡æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œé‚£ä¹ˆ
Kubernetes å°†ä¸èƒ½åŠæ—¶å¾—åˆ°â€œç³»ç»Ÿæ­£å¸¸â€çš„å“åº”ï¼Œä½ çš„è¿›ç¨‹å°±ä¼šè¢« K8s æ€æ­»ã€‚å› æ­¤å¾—åˆ°ç»“è®ºï¼šç”±äºå°¾éƒ¨å»¶è¿Ÿï¼Œä½ ä¸èƒ½å°† Tokio ç”¨äº CPU
å¯†é›†å‹ä»»åŠ¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œå°±åƒ Tokio åœ¨æ–‡æ¡£ä¸­é˜è¿°çš„ï¼Œæƒ³è¦é˜²æ­¢ä½ çš„ç¨‹åºåœ¨ CPU å®Œå…¨é¥±å’Œçš„æƒ…å†µä¸‹è¢« K8s
è¯¯æ€ï¼Œä½ åº”è¯¥ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ã€‚ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå¯¹å°¾éƒ¨å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå°±æ¯”å¦‚å“åº” <code>/health</code> æ¥å£ã€‚å¦ä¸€ä¸ªç”¨æ¥æ‰§è¡Œ CPU
å¯†é›†å‹ä»»åŠ¡ã€‚è¿™äº›çº¿ç¨‹æ± çš„çš„æœ€ä½³çº¿ç¨‹æ•°éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å»è°ƒæ•´ã€‚</p>
<p>å¦‚æœä½ å°† Tokio è¿è¡Œæ—¶åªæ˜¯è§†ä¸ºä¸€ä¸ªå¤æ‚ç‚¹çš„çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶å®ä¾‹çš„æƒ³æ³•å¯èƒ½æ›´å®¹æ˜“æ¥å—ï¼Œæˆ‘ä»¬å°†åœ¨æœ€åä½¿ç”¨ä¸“ç”¨çš„æ‰§è¡Œå™¨æ¼”ç¤ºå¦‚ä½•å®ç°è¿™ä¸ªæƒ³æ³•ã€‚</p>
<h3 id="å•ä»»åŠ¡å¼€é”€å¾ˆé«˜"><a class="header" href="#å•ä»»åŠ¡å¼€é”€å¾ˆé«˜">å•ä»»åŠ¡å¼€é”€å¾ˆé«˜</a></h3>
<p>Tokio çš„æ¯ä¸ªä»»åŠ¡å¼€é”€å¾ˆé«˜ã€‚</p>
<p>å¯¹äºè¿™ç‚¹ï¼Œæˆ‘ä¸€ç‚¹ä¹Ÿä¸æƒŠè®¶ã€‚äººä»¬æ€»æ˜¯å¯ä»¥å®ç°æ¯” Tokio è¿è¡Œé€Ÿåº¦æ›´å¿«çš„çº¿ç¨‹æ± ã€‚ä½†æ˜¯ï¼Œè¿™äº›çº¿ç¨‹æ± å¹¶ä¸æ˜¯è¶³å¤Ÿç¨³å®šï¼Œéš¾ä»¥åº”å¯¹ç”Ÿäº§ç¯å¢ƒçš„è´Ÿè½½ï¼Œå¹¶ä¸”ä»–ä»¬ä¹Ÿä¸å…·å¤‡åƒ
Tokio ä¸€æ ·çš„åºå¤§ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<p>åœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼Œå•ä»»åŠ¡çš„å¼€é”€å¯ä»¥ä½¿ç”¨â€œçŸ¢é‡åŒ–å¤„ç†â€
æ¥åˆ†æ‘Šã€‚æ„æ€æ˜¯æ¯ä¸ªä»»åŠ¡å›åŒæ—¶å¤„ç†å‡ åƒè¡Œæ•°æ®è€Œä¸æ˜¯å•å•ä¸€è¡Œï¼Œä½ éœ€è¦å°†ä»»åŠ¡åˆ†æˆåˆç†å¤§å°çš„å—ã€‚ä½ ä¹Ÿä¸èƒ½åˆ†æ‘Šæ‰€æœ‰å·¥ä½œåœºæ™¯ä¸‹çš„å¼€é”€ã€‚ä½†æ˜¯ï¼Œå¯¹äºæˆ‘ä»¬çš„ç¨‹åºå…³å¿ƒçš„å®ä¾‹æ¥è¯´ï¼ŒTokio
çš„ä»»åŠ¡å¼€é”€å·²ç»å¾®ä¹å…¶å¾®äº†</p>
<h2 id="å®è·µ"><a class="header" href="#å®è·µ">å®è·µ</a></h2>
<p>å‡è®¾ä½ å·²ç»è¢«è¯´æœäº†ä½¿ç”¨ Tokio å»å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡æ˜¯å¯è¡Œçš„ã€‚ç°åœ¨ä½ åº”è¯¥æ€ä¹ˆåšï¼Ÿ</p>
<p>é¦–å…ˆï¼Œè‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä½ çš„ä»£ç åº”è¯¥ç¬¦åˆä»¥ä¸‹åŸåˆ™ï¼šå¼‚æ­¥ä»£ç æ°¸è¿œä¸åº”è¯¥èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆï¼Œè¿™ä¸€ç‚¹è¯·å‚è€ƒ Alice Ryhl çš„
<a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a>ã€‚è¿™æ˜¯ä¸ºäº†è®©è°ƒåº¦å™¨æœ‰æœºä¼šå®‰æ’å…¶ä»–äº‹æƒ…ï¼Œæ¯”å¦‚ä»»åŠ¡çªƒå–ç­‰ã€‚</p>
<p>å½“ç„¶äº†ï¼Œè¿™ä¸ªâ€œå¾ˆé•¿æ—¶é—´â€å–å†³äºä½ çš„ç¨‹åºï¼›Ryhl å»ºè®®åœ¨ä¼˜åŒ–å“åº”çš„å°¾éƒ¨å»¶è¿Ÿæ—¶ï¼Œå•ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶é—´åº”è¯¥åœ¨ 10 ~ 100 å¾®ç§’ã€‚æˆ‘è®¤ä¸ºåœ¨é’ˆå¯¹ CPU
è¿›è¡Œä¼˜åŒ–æ—¶ 10~100 æ¯«ç§’ä¹Ÿèƒ½æœ‰ä¸é”™çš„æ•ˆæœã€‚ä½†æ˜¯åœ¨æˆ‘çš„æµ‹è¯•
<a href="https://github.com/alamb/rust_tokio_overhead">estimated per-task Tokio overhead</a>
ä¸­ï¼ŒTokio å•ä»»åŠ¡çš„å¼€é”€åœ¨çº¦ 10 çº³ç§’èŒƒå›´å†…ï¼Œå› æ­¤å‡ ä¹ä¸å¯èƒ½ç”¨ 10 æ¯«ç§’çš„ä»»åŠ¡æ¥æµ‹é‡ Tokio è¿è¡Œæ—¶å¼€é”€ã€‚</p>
<p>å…¶æ¬¡ï¼Œå°†ä»»åŠ¡åˆ†æ´¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ‰§è¡Œå™¨</p>
<h3 id="ä¸“ç”¨çš„æ‰§è¡Œå™¨"><a class="header" href="#ä¸“ç”¨çš„æ‰§è¡Œå™¨">ä¸“ç”¨çš„æ‰§è¡Œå™¨</a></h3>
<p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¼”ç¤ºäº†æˆ‘ä»¬å¦‚ä½•åœ¨ InfluxDB IOx ä¸Šå°†ä»»åŠ¡åˆ†é…åˆ°ä¸€ä¸ªå•ç‹¬çš„ Tokio
è¿è¡Œæ—¶ä¸Šï¼ˆå®Œæ•´ä»£ç å¯ä»¥åœ¨æˆ‘ä»¬çš„<a href="https://github.com/influxdata/influxdb_iox/blob/fe155e15fb2ad166aee66b0458e63c24a8128dd4/query/src/exec/task.rs#L101-L118">ä»“åº“</a>é‡ŒæŸ¥çœ‹ï¼Œé‡Œé¢è¿˜æœ‰å…³äºæ¸…ç†ã€åœæœºã€åˆå¹¶çš„å†…å®¹ï¼‰</p>
<pre><code class="language-rs">pub struct DedicatedExecutor {
    state: Arc&lt;Mutex&lt;State&gt;&gt;,
}

/// Runs futures (and any `tasks` that are `tokio::task::spawned` by
/// them) on a separate Tokio Executor
struct State {
    /// Channel for requests -- the dedicated executor takes requests
    /// from here and runs them.
    requests: Option&lt;std::sync::mpsc::Sender&lt;Task&gt;&gt;,

    /// Thread which has a different Tokio runtime
    /// installed and spawns tasks there
    thread: Option&lt;std::thread::JoinHandle&lt;()&gt;&gt;,
}

impl DedicatedExecutor {
    /// Creates a new `DedicatedExecutor` with a dedicated Tokio
    /// executor that is separate from the threadpool created via
    /// `[tokio::main]`.
    pub fn new(thread_name: &amp;str, num_threads: usize) -&gt; Self {
        let thread_name = thread_name.to_string();

        let (tx, rx) = std::sync::mpsc::channel::&lt;Task&gt;();

        let thread = std::thread::spawn(move || {
            // Create a new Runtime to run tasks
            let runtime = Tokio::runtime::Builder::new_multi_thread()
                .enable_all()
                .thread_name(&amp;thread_name)
                .worker_threads(num_threads)
                // Lower OS priority of worker threads to prioritize main runtime
                .on_thread_start(move || set_current_thread_priority_low())
                .build()
                .expect(&quot;Creating Tokio runtime&quot;);

         // Pull task requests off the channel and send them to the executor
         runtime.block_on(async move {
                while let Ok(task) = rx.recv() {
                    Tokio::task::spawn(async move {
                        task.run().await;
                    });
                }

        let state = State {
            requests: Some(tx),
            thread: Some(thread),
        };

        Self {
            state: Arc::new(Mutex::new(state)),
        }
    }
</code></pre>
<p>è¿™æ®µä»£ç ä¼šåœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ <code>std::thread</code>ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Tokio è¿è¡Œæ—¶ã€‚è¿è¡Œæ—¶ä¼šä» <code>channel</code> è·å–ä»»åŠ¡å¹¶è¿è¡Œã€‚</p>
<p>æ³¨æ„ï¼šè¿™ä¸ªæ–°çš„çº¿ç¨‹å¾ˆå…³é”®ï¼Œå¦‚æœä½ å°è¯•åœ¨ä¸»çº¿ç¨‹é‡Œæˆ–è€…æ˜¯ä»»ä½•å·²ç»åˆ›å»ºè¿‡ Tokio è¿è¡Œæ—¶çš„çº¿ç¨‹é‡Œå†æ¬¡åˆ›å»ºæ–°çš„è¿è¡Œæ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå·²ç»æœ‰ä¸€ä¸ªè¿è¡Œæ—¶äº†ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°†ä»»åŠ¡åˆ†æ´¾åˆ°ç¬¬äºŒä¸ªè¿è¡Œæ—¶ã€‚</p>
<pre><code class="language-rs">impl DedicatedExecutor {

    /// Runs the specified Future (and any tasks it spawns) on the
    /// `DedicatedExecutor`.
    pub fn spawn&lt;T&gt;(&amp;self, task: T) -&gt; Job&lt;T::Output&gt;
    where
        T: Future + Send + 'static,
        T::Output: Send + 'static,
    {
        let (tx, rx) = tokio::sync::oneshot::channel();

        let fut = Box::pin(async move {
            let task_output = task.await;
            tx.send(task_output).ok()
        });
        let mut state = self.state.lock();
        let task = Task {
            fut,
        };

        if let Some(requests) = &amp;mut state.requests {
            // would fail if someone has started shutdown
            requests.send(task).ok();
        } else {
            warn!(&quot;tried to schedule task on an executor that was shutdown&quot;);
        }

        Job { rx, cancel }
    }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†ä¸€ä¸ªåä¸º Job çš„ç»“æ„ä½“ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹ Future çš„ç®€å•åŒ…è£…ï¼ŒJob èƒ½å¤Ÿå°† Future
çš„æ‰§è¡Œç»“æœä»å•ç‹¬çš„æ‰§è¡Œå™¨å†…ä¼ è¾“å›ä¸»çº¿ç¨‹ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ã€‚</p>
<pre><code class="language-rs">#[pin_project(PinnedDrop)]
pub struct Job&lt;T&gt; {
    #[pin]
    rx: Receiver&lt;T&gt;,
}

impl&lt;T&gt; Future for Job&lt;T&gt; {
    type Output = Result&lt;T, Error&gt;;

    fn poll(
        self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut std::task::Context&lt;'_&gt;,
    ) -&gt; std::task::Poll&lt;Self::Output&gt; {
        let this = self.project();
        this.rx.poll(cx)
    }
}
</code></pre>
<p>å°±æ˜¯è¿™æ ·ï¼ä½ å¯ä»¥åœ¨
<a href="https://gist.github.com/alamb/bd0e086448ef9b438aeebd6f550e23ed">Github gist</a>
ä¸­æ‰¾åˆ°æ‰€æœ‰ä»£ç ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                                                    <a rel="next" href="../trans/2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                                    <a rel="next" href="../trans/2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
