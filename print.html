<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Trdthg&#x27;s Self</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><li class="part-title">trans</li><li class="chapter-item expanded "><a href="trans/2022-04-20-è¯‘-ä½¿ç”¨-Tokio-å¤„ç†-CPU-å¯†é›†å‹ä»»åŠ¡.html"><strong aria-hidden="true">1.</strong> 2022-04-20-è¯‘-ä½¿ç”¨-Tokio-å¤„ç†-CPU-å¯†é›†å‹ä»»åŠ¡</a></li><li class="chapter-item expanded "><a href="trans/2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde.html"><strong aria-hidden="true">2.</strong> 2023-01-03-è¯‘-Rustå†’é™©:-æ»¥ç”¨-Serde</a></li><li class="chapter-item expanded "><a href="trans/2023-01-01-è¯‘-æ‹“å±•-Rust-ä¸­çš„-Map.html"><strong aria-hidden="true">3.</strong> 2023-01-01-è¯‘-æ‹“å±•-Rust-ä¸­çš„-Map</a></li><li class="chapter-item expanded "><a href="trans/2022-04-01-è¯‘-search_engine.html"><strong aria-hidden="true">4.</strong> 2022-04-01-è¯‘-search_engine</a></li><li class="chapter-item expanded "><a href="trans/2022-05-04-è¯‘-å¯è§†åŒ–-Rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€.html"><strong aria-hidden="true">5.</strong> 2022-05-04-è¯‘-å¯è§†åŒ–-Rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€</a></li><li class="chapter-item expanded "><a href="trans/2022-04-13-è¯‘-tail_latency.html"><strong aria-hidden="true">6.</strong> 2022-04-13-è¯‘-tail_latency</a></li><li class="chapter-item expanded "><a href="trans/2022-04-30-è¯‘-ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-Rust-ï¼Ÿ.html"><strong aria-hidden="true">7.</strong> 2022-04-30-è¯‘-ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-Rust-ï¼Ÿ</a></li><li class="chapter-item expanded "><a href="trans/2022-04-11-è¯‘-å¼‚æ­¥-Rustï¼šåä½œä¸æŠ¢å å¼è°ƒåº¦.html"><strong aria-hidden="true">8.</strong> 2022-04-11-è¯‘-å¼‚æ­¥-Rustï¼šåä½œä¸æŠ¢å å¼è°ƒåº¦</a></li><li class="chapter-item expanded "><a href="trans/2023-01-02-è¯‘-æœªåˆå§‹åŒ–å†…å­˜:-unsafe-Rustå¤ªéš¾äº†.html"><strong aria-hidden="true">9.</strong> 2023-01-02-è¯‘-æœªåˆå§‹åŒ–å†…å­˜:-unsafe-Rustå¤ªéš¾äº†</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/index.html"><strong aria-hidden="true">10.</strong> 2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-4-é‡æ„.html"><strong aria-hidden="true">10.1.</strong> Rust-å…­è¾¹å½¢æ¶æ„-4-é‡æ„</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-2-å†…å­˜å­˜å‚¨åº“.html"><strong aria-hidden="true">10.2.</strong> Rust-å…­è¾¹å½¢æ¶æ„-2-å†…å­˜å­˜å‚¨åº“</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-7-é•¿æœŸå­˜å‚¨åº“.html"><strong aria-hidden="true">10.3.</strong> Rust-å…­è¾¹å½¢æ¶æ„-7-é•¿æœŸå­˜å‚¨åº“</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ.html"><strong aria-hidden="true">10.4.</strong> Rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-5-å…¶ä»–ç”¨ä¾‹.html"><strong aria-hidden="true">10.5.</strong> Rust-å…­è¾¹å½¢æ¶æ„-5-å…¶ä»–ç”¨ä¾‹</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-6-CLI.html"><strong aria-hidden="true">10.6.</strong> Rust-å…­è¾¹å½¢æ¶æ„-6-CLI</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/Rust-å…­è¾¹å½¢æ¶æ„-3-HTTP-API.html"><strong aria-hidden="true">10.7.</strong> Rust-å…­è¾¹å½¢æ¶æ„-3-HTTP-API</a></li><li class="chapter-item expanded "><a href="trans/2022-04-03-è¯‘-Rust-å…­è¾¹å½¢æ¶æ„/index.html"><strong aria-hidden="true">10.8.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">note</li><li class="chapter-item expanded "><a href="note/java/index.html"><strong aria-hidden="true">11.</strong> java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="note/java/java.html"><strong aria-hidden="true">11.1.</strong> java</a></li><li class="chapter-item expanded "><a href="note/java/springboot.html"><strong aria-hidden="true">11.2.</strong> springboot</a></li><li class="chapter-item expanded "><a href="note/java/spring.html"><strong aria-hidden="true">11.3.</strong> spring</a></li><li class="chapter-item expanded "><a href="note/java/sourceread.html"><strong aria-hidden="true">11.4.</strong> sourceread</a></li><li class="chapter-item expanded "><a href="note/java/index.html"><strong aria-hidden="true">11.5.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="note/frontend/index.html"><strong aria-hidden="true">12.</strong> frontend</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="note/frontend/mini_bundle.html"><strong aria-hidden="true">12.1.</strong> mini_bundle</a></li><li class="chapter-item expanded "><a href="note/frontend/js_advanced.html"><strong aria-hidden="true">12.2.</strong> js_advanced</a></li><li class="chapter-item expanded "><a href="note/frontend/mini_vue.html"><strong aria-hidden="true">12.3.</strong> mini_vue</a></li><li class="chapter-item expanded "><a href="note/frontend/vue.html"><strong aria-hidden="true">12.4.</strong> vue</a></li><li class="chapter-item expanded "><a href="note/frontend/list.html"><strong aria-hidden="true">12.5.</strong> list</a></li><li class="chapter-item expanded "><a href="note/frontend/http.html"><strong aria-hidden="true">12.6.</strong> http</a></li><li class="chapter-item expanded "><a href="note/frontend/flutter.html"><strong aria-hidden="true">12.7.</strong> flutter</a></li><li class="chapter-item expanded "><a href="note/frontend/css.html"><strong aria-hidden="true">12.8.</strong> css</a></li><li class="chapter-item expanded "><a href="note/frontend/vdom.html"><strong aria-hidden="true">12.9.</strong> vdom</a></li><li class="chapter-item expanded "><a href="note/frontend/index.html"><strong aria-hidden="true">12.10.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">blog</li><li class="chapter-item expanded "><a href="blog/index.html"><strong aria-hidden="true">13.</strong> README</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">docs</li><li class="chapter-item expanded "><a href="docs/log.html"><strong aria-hidden="true">14.</strong> log</a></li><li class="chapter-item expanded "><a href="docs/intro.html"><strong aria-hidden="true">15.</strong> intro</a></li><li class="chapter-item expanded "><a href="docs/magic/index.html"><strong aria-hidden="true">16.</strong> magic</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/magic/riscv.html"><strong aria-hidden="true">16.1.</strong> riscv</a></li><li class="chapter-item expanded "><a href="docs/magic/haskell.html"><strong aria-hidden="true">16.2.</strong> haskell</a></li><li class="chapter-item expanded "><a href="docs/magic/bash.html"><strong aria-hidden="true">16.3.</strong> bash</a></li><li class="chapter-item expanded "><a href="docs/magic/memory_ordering.html"><strong aria-hidden="true">16.4.</strong> memory_ordering</a></li><li class="chapter-item expanded "><a href="docs/magic/linuxIO.html"><strong aria-hidden="true">16.5.</strong> linuxIO</a></li><li class="chapter-item expanded "><a href="docs/magic/cicd.html"><strong aria-hidden="true">16.6.</strong> cicd</a></li><li class="chapter-item expanded "><a href="docs/magic/fd.html"><strong aria-hidden="true">16.7.</strong> fd</a></li><li class="chapter-item expanded "><a href="docs/magic/hadoop.html"><strong aria-hidden="true">16.8.</strong> hadoop</a></li><li class="chapter-item expanded "><a href="docs/magic/go.html"><strong aria-hidden="true">16.9.</strong> go</a></li><li class="chapter-item expanded "><a href="docs/magic/async.html"><strong aria-hidden="true">16.10.</strong> async</a></li><li class="chapter-item expanded "><a href="docs/magic/index.html"><strong aria-hidden="true">16.11.</strong> README</a></li><li class="chapter-item expanded "><a href="docs/magic/software_arch.html"><strong aria-hidden="true">16.12.</strong> software_arch</a></li></ol></li><li class="chapter-item expanded "><a href="docs/riscv/index.html"><strong aria-hidden="true">17.</strong> riscv</a></li><li class="chapter-item expanded "><a href="docs/common/index.html"><strong aria-hidden="true">18.</strong> common</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/common/pgsql.html"><strong aria-hidden="true">18.1.</strong> pgsql</a></li><li class="chapter-item expanded "><a href="docs/common/git.html"><strong aria-hidden="true">18.2.</strong> git</a></li><li class="chapter-item expanded "><a href="docs/common/linux.html"><strong aria-hidden="true">18.3.</strong> linux</a></li><li class="chapter-item expanded "><a href="docs/common/datastructure.html"><strong aria-hidden="true">18.4.</strong> datastructure</a></li><li class="chapter-item expanded "><a href="docs/common/docker.html"><strong aria-hidden="true">18.5.</strong> docker</a></li><li class="chapter-item expanded "><a href="docs/common/analyze.html"><strong aria-hidden="true">18.6.</strong> analyze</a></li><li class="chapter-item expanded "><a href="docs/common/oci.html"><strong aria-hidden="true">18.7.</strong> oci</a></li><li class="chapter-item expanded "><a href="docs/common/unsorted.html"><strong aria-hidden="true">18.8.</strong> unsorted</a></li><li class="chapter-item expanded "><a href="docs/common/oauth2.html"><strong aria-hidden="true">18.9.</strong> oauth2</a></li><li class="chapter-item expanded "><a href="docs/common/vim.html"><strong aria-hidden="true">18.10.</strong> vim</a></li><li class="chapter-item expanded "><a href="docs/common/python.html"><strong aria-hidden="true">18.11.</strong> python</a></li><li class="chapter-item expanded "><a href="docs/common/index.html"><strong aria-hidden="true">18.12.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="docs/rust/index.html"><strong aria-hidden="true">19.</strong> rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/rust/mini_tokio.html"><strong aria-hidden="true">19.1.</strong> mini_tokio</a></li><li class="chapter-item expanded "><a href="docs/rust/wasm.html"><strong aria-hidden="true">19.2.</strong> wasm</a></li><li class="chapter-item expanded "><a href="docs/rust/rust_quiz.html"><strong aria-hidden="true">19.3.</strong> rust_quiz</a></li><li class="chapter-item expanded "><a href="docs/rust/rust.html"><strong aria-hidden="true">19.4.</strong> rust</a></li><li class="chapter-item expanded "><a href="docs/rust/print_into_detail.html"><strong aria-hidden="true">19.5.</strong> print_into_detail</a></li><li class="chapter-item expanded "><a href="docs/rust/net-piercer.html"><strong aria-hidden="true">19.6.</strong> net-piercer</a></li><li class="chapter-item expanded "><a href="docs/rust/rs_channel.html"><strong aria-hidden="true">19.7.</strong> rs_channel</a></li><li class="chapter-item expanded "><a href="docs/rust/lists.html"><strong aria-hidden="true">19.8.</strong> lists</a></li><li class="chapter-item expanded "><a href="docs/rust/index.html"><strong aria-hidden="true">19.9.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="docs/riscv/index.html"><strong aria-hidden="true">20.</strong> riscv</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="docs/riscv/index.html"><strong aria-hidden="true">20.1.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">other</li><li class="chapter-item expanded "><a href="other/2023-04-12-remote-usb.html"><strong aria-hidden="true">21.</strong> 2023-04-12-remote-usb</a></li><li class="chapter-item expanded "><a href="other/resources.html"><strong aria-hidden="true">22.</strong> resources</a></li><li class="chapter-item expanded "><a href="other/i3wm.html"><strong aria-hidden="true">23.</strong> i3wm</a></li><li class="chapter-item expanded "><a href="other/lsm.html"><strong aria-hidden="true">24.</strong> lsm</a></li><li class="chapter-item expanded "><a href="other/site_update_log.html"><strong aria-hidden="true">25.</strong> site_update_log</a></li><li class="chapter-item expanded "><a href="other/ioclub/index.html"><strong aria-hidden="true">26.</strong> ioclub</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="other/ioclub/share_1.html"><strong aria-hidden="true">26.1.</strong> share_1</a></li><li class="chapter-item expanded "><a href="other/ioclub/index.html"><strong aria-hidden="true">26.2.</strong> README</a></li></ol></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/index.html"><strong aria-hidden="true">27.</strong> 2021-åç«¯</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_1.html"><strong aria-hidden="true">27.1.</strong> backend_1</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_2.html"><strong aria-hidden="true">27.2.</strong> backend_2</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_3.html"><strong aria-hidden="true">27.3.</strong> backend_3</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_4.html"><strong aria-hidden="true">27.4.</strong> backend_4</a></li></ol></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/index.html"><strong aria-hidden="true">28.</strong> 2021-åç«¯</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_1.html"><strong aria-hidden="true">28.1.</strong> backend_1</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_2.html"><strong aria-hidden="true">28.2.</strong> backend_2</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_3.html"><strong aria-hidden="true">28.3.</strong> backend_3</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/backend_4.html"><strong aria-hidden="true">28.4.</strong> backend_4</a></li><li class="chapter-item expanded "><a href="other/2021-åç«¯/index.html"><strong aria-hidden="true">28.5.</strong> README</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">draft</li><li class="chapter-item expanded "><a href="draft/ç»„æˆåŸç†.html"><strong aria-hidden="true">29.</strong> ç»„æˆåŸç†</a></li><li class="chapter-item expanded "><a href="draft/è®¡ç®—æœºç½‘ç»œ.html"><strong aria-hidden="true">30.</strong> è®¡ç®—æœºç½‘ç»œ</a></li><li class="chapter-item expanded "><a href="draft/è¯‘-pkg_mng.html"><strong aria-hidden="true">31.</strong> è¯‘-pkg_mng</a></li><li class="chapter-item expanded "><a href="draft/DistributedSystem.html"><strong aria-hidden="true">32.</strong> DistributedSystem</a></li><li class="chapter-item expanded "><a href="draft/oscamp2022.html"><strong aria-hidden="true">33.</strong> oscamp2022</a></li><li class="chapter-item expanded "><a href="draft/compile.html"><strong aria-hidden="true">34.</strong> compile</a></li><li class="chapter-item expanded "><a href="draft/test.html"><strong aria-hidden="true">35.</strong> test</a></li><li class="chapter-item expanded "><a href="draft/ld.html"><strong aria-hidden="true">36.</strong> ld</a></li><li class="chapter-item expanded "><a href="draft/æ•°æ®åº“è®¾è®¡.html"><strong aria-hidden="true">37.</strong> æ•°æ®åº“è®¾è®¡</a></li><li class="chapter-item expanded "><a href="draft/index.html"><strong aria-hidden="true">38.</strong> README</a></li><li class="chapter-item expanded "><a href="draft/computer_network/index.html"><strong aria-hidden="true">39.</strong> computer_network</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="draft/computer_network/index.html"><strong aria-hidden="true">39.1.</strong> README</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Trdthg&#x27;s Self</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://thenewstack.io/using-rustlangs-async-tokio-runtime-for-cpu-bound-tasks/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/Akagi201">Akagi201</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡"><a class="header" href="#ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡">ä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h1>
<p>å°½ç®¡ async é€šå¸¸éƒ½è¢«åº”ç”¨äºå¼‚æ­¥ç½‘ç»œ I/Oï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šåƒä½ ä»‹ç»ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°æ®åˆ†æå¼•æ“ç­‰ï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<h2 id="tokio-æ˜¯ä»€ä¹ˆ"><a class="header" href="#tokio-æ˜¯ä»€ä¹ˆ">Tokio æ˜¯ä»€ä¹ˆï¼Ÿ</a></h2>
<p>Rust æœ¬èº«æä¾›äº†ä¸€ä¸ªç±»ä¼¼äº JavaScript çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸å’Œå¼‚æ­¥ I/Oã€‚ä¸€ä¸ªè¿è¡Œæ—¶æ˜¯å¿…é¡»çš„ï¼Œå°½ç®¡ç¤¾åŒºæœ‰å¾ˆå¤šå¼‚æ­¥è¿è¡Œæ—¶çš„é€‰æ‹©ï¼Œä½†æ˜¯ Tokio æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†ã€‚å°½ç®¡ Tokio åœ¨å®˜ç½‘ä¸Šæè¿°åˆ°å®ƒæ˜¯
Rust è¯­è¨€çš„ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æä¾›äº†ç¼–å†™ç½‘ç»œæœåŠ¡æ‰€éœ€è¦çš„æ¨¡å—ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«ç”¨åœ¨å…¶å®ƒåœºæ™¯ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡"><a class="header" href="#ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡">ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h2>
<p>ç°ä»£åŒ–çš„æ•°æ®åˆ†æå¼•æ“æ€»æ˜¯ä¸å¯é¿å…çš„è¦å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥åŠé€šè¿‡ç½‘ç»œå’Œå¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼ˆæ¯”å¦‚ ASW S3ã€GCP Cloudã€Azure
ç­‰ï¼‰è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œä»»ä½•ä½¿ç”¨ Rust å®ç°çš„ç³»ç»Ÿï¼Œå¤§å¤šéƒ½ä¼šç”¨ Tokio å»å¤„ç†è¿™éƒ¨åˆ†ç½‘ç»œç›¸å…³çš„æœåŠ¡ï¼Œæˆ–è€…æ˜¯ä¸€éƒ¨åˆ†æ–‡ä»¶ I/O æœåŠ¡ã€‚</p>
<p>é™¤äº†åº”å¯¹ç½‘ç»œå¤–ï¼Œæ•°æ®åˆ†æå¼•æ“è¿˜éœ€è¦åšå¤§é‡ç¹é‡çš„çš„ CPU è®¡ç®—ï¼Œæ¶ˆè€—å¤§é‡ CPU
èµ„æºå»è¿›è¡Œè¯¸å¦‚ï¼šé‡æ–°ç»„ç»‡æ•°æ®å­˜å‚¨ã€æå‰è®¡ç®—å„ç§ç´¢å¼•ã€æˆ–è€…æ˜¯ç›´æ¥å›å¤å®¢æˆ·ç«¯è¯·æ±‚ç­‰å·¥ä½œã€‚è¿™äº›å¤æ‚è®¡ç®—é€šå¸¸ä¼šè¢«åˆ‡æˆè®¸å¤šå•ç‹¬çš„å—ï¼ˆæˆ‘æŠŠå®ƒä»¬ç§°ä¸º
&quot;ä»»åŠ¡&quot;ï¼‰ï¼Œç„¶åè¢«å¹¶è¡Œçš„å¤„ç†ï¼Œä»¥åˆ©ç”¨åˆ°ç°ä»£ CPU çš„å¤šæ ¸ç‰¹æ€§ã€‚</p>
<p>ä»»åŠ¡è°ƒåº¦å™¨ä¼šå†³å®šå“ªä¸ªä»»åŠ¡åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œå®ƒä¼šå°†ä»»åŠ¡æ˜ å°„åˆ°åˆé€‚çš„ CPU å†…æ ¸æˆ–è€…æ˜¯çº¿ç¨‹ä¸Šã€‚</p>
<p>å­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œå¯¹äºå„ç§ä»»åŠ¡è°ƒåº¦å™¨ã€å·¥ä½œæ± ã€çº¿ç¨‹æ± ç­‰å·²ç»ç§¯ç´¯äº†å¾ˆå¤šå¹´çš„ç ”ç©¶ã€‚</p>
<p>æˆ‘è‡ªå·±å·²ç»å®ç°å¹¶ä¸”ä½¿ç”¨è¿‡å‡ ä¸ªè‡ªå®šä¹‰çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚ä»–ä»¬åœ¨å¤§å¤šæ•°æ—¶é—´ (99.9%)
éƒ½å·¥ä½œçš„å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å¤„ç†è¾¹ç¼˜æƒ…å†µï¼ˆæ¯”å¦‚å¿«é€Ÿåœæœºã€ä»»åŠ¡å–æ¶ˆã€æ¸…ç†ç­‰ï¼‰æ—¶ï¼Œä»–ä»¬çš„æ•ˆæœéå¸¸ä¸å°½äººæ„ã€‚ç”±äºè¿™äº›ä»»åŠ¡è°ƒåº¦å™¨ä½¿ç”¨äº†è¾ƒä½çº§åˆ«çš„çº¿ç¨‹åŸè¯­ï¼Œå‡ºç°çº¿ç¨‹é—´ç«äº‰çš„æƒ…å†µæ¯”æ¯”çš†æ˜¯ï¼Œæ‰€ä»¥æˆ‘ä¸å»ºè®®è¿™æ ·åšã€‚</p>
<p>å› æ­¤ï¼Œå½“æˆ‘åœ¨ Rust ç”Ÿæ€ä¸­å¯»æ‰¾ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨æ—¶ï¼Œä½ ä¼šå¾ˆè‡ªç„¶çš„é€‰æ‹© Tokioã€‚Tokio æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼š</p>
<ol>
<li>ä½ åªéœ€è¦ Tokioï¼Œå¹¶ä¸éœ€è¦æ·»åŠ å…¶ä»–ä¾èµ–é¡¹ã€‚</li>
<li>Tokio å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ <a href="https://tokio.rs/blog/2019-10-scheduler">æ”¯æŒä»»åŠ¡çªƒå–çš„è°ƒåº¦å™¨</a>ã€‚</li>
<li>Tokio å†…éƒ¨å®ç°äº†å¯¹ async/await çš„æ”¯æŒã€‚å¹¶ä¸”æœ‰è®¸å¤šç›¸å¯¹æˆç†Ÿçš„åº“å»å¤„ç†æµã€å¼‚æ­¥é”ã€ç®¡é“ã€å¼‚æ­¥å–æ¶ˆç­‰ã€‚</li>
<li>Tokio åœ¨ Rust ç”Ÿæ€ç³»ç»Ÿä¸­ç»è¿‡äº†è‰¯å¥½æµ‹è¯•ï¼Œå¹¶ä¸”æœ‰ç€å¤§é‡ä½¿ç”¨æ¡ˆä¾‹ã€‚</li>
<li>Tokio é€šå¸¸ä¼šå°†æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å’Œ <code>Future</code> æ”¾åœ¨åŒä¸€ä¸ªæ‰§è¡Œå™¨å†…ï¼Œè¿™æœ‰åˆ©äºå®ç°å±€éƒ¨ç¼“å­˜ã€‚</li>
<li>Tokio çš„ <a href="https://tokio.rs/tokio/tutorial">æ–‡æ¡£</a> å¾ˆå®Œå–„ï¼Œå¹¶ä¸”åœ¨ç§¯ææ›´æ–°ç»´æŠ¤ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œé€‰æ‹© Tokio ä½œä¸º CPU å¯†é›†å‹ä»»åŠ¡çš„ä»»åŠ¡è°ƒåº¦ç¨‹åºæ˜¯ç†æ‰€åº”å½“çš„ï¼Œå¯¹å§ï¼ŸWROOOOOOOONGï¼</p>
<h2 id="ä½¿ç”¨-tokio-çš„åå¯¹æ„è§"><a class="header" href="#ä½¿ç”¨-tokio-çš„åå¯¹æ„è§">ä½¿ç”¨ Tokio çš„åå¯¹æ„è§</a></h2>
<p>é€‰æ‹© Tokio åœ¨æˆ‘ä»¬å›¢é˜Ÿä¸­å˜æˆäº†ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œåˆ°ç°åœ¨ä¾ç„¶ä¸æ˜¯æ‰€æœ‰äººéƒ½è®¤å¯è¿™ä¸ªå†³å®šã€‚åœ¨æˆ‘ä»¬åš DataFusion å’Œ InfluxDB IOx
çš„æ—©æœŸï¼Œæˆ‘ä»¬å¾ˆæ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åå¯¹æ„è§ï¼š</p>
<h3 id="tokio-æ–‡æ¡£çš„è­¦å‘Š"><a class="header" href="#tokio-æ–‡æ¡£çš„è­¦å‘Š">Tokio æ–‡æ¡£çš„è­¦å‘Šï¼š</a></h3>
<p>è€ç‰ˆæœ¬çš„ Tokio æ–‡æ¡£ï¼ˆæ¯”å¦‚ 1.10 ç‰ˆï¼‰é‡Œé¢æœ‰ä¸€æ¡è‘—åçš„è­¦å‘Šï¼š</p>
<blockquote>
<p>If your code is CPU-bound and you wish to limit the number of threads used to
run it, you should run it on another thread pool such as Rayon.</p>
</blockquote>
<p>å¦‚æœä½ çš„ä»£ç è¦å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå¹¶ä¸”æƒ³è¦å°½é‡å‡å°‘ä½¿ç”¨åˆ°çš„çº¿ç¨‹æ•°ï¼Œä½ åº”è¯¥å°†è¿™äº›ä»»åŠ¡åˆ†é…åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ± æ¯”å¦‚ Rayonã€‚</p>
<p>è¿™ä¸ªè­¦å‘Šå¯¹æˆ‘ä»¬å›¢é˜Ÿå’Œç¤¾åŒºéƒ½é€ æˆäº†å¾ˆå¤§çš„å›°æƒ‘ã€‚å¾ˆå¤šäººè¯»äº†ä¹‹åéƒ½ä»¥ä¸º Tokio æ°¸è¿œä¸åº”è¯¥ç”¨æ¥å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ã€‚ä½†æ˜¯æ–‡æ¡£çš„å…³é”®å…¶å®æ˜¯è¯´ï¼Œä¸€ä¸ªè¿è¡Œæ—¶å®ä¾‹ï¼ˆåŒä¸€ä¸ªçº¿ç¨‹æ± ï¼‰ä¸åº”è¯¥åŒæ—¶ç”¨äº I/O å’Œ CPU
è®¡ç®—ï¼Œæˆ‘ä»¬ä¹‹åæ¾„æ¸…äº†<a href="https://docs.rs/tokio/1.14.0/tokio/#cpu-bound-tasks-and-blocking-code">æ–‡æ¡£</a>
çš„æ„å›¾ã€‚</p>
<blockquote>
<p>é¡ºä¾¿è¯´ä¸€å¥ï¼ŒTokio æ–‡æ¡£å»ºè®®ç”¨ Rayon å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ã€‚Rayon
å¯¹äºå¾ˆå¤šç¨‹åºéƒ½æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ”¯æŒå¼‚æ­¥ã€‚å¦‚æœä½ çš„ä»£ç ä¸­å“ªæ€•åªæœ‰ä¸€ç‚¹éœ€è¦ä½¿ç”¨å¼‚æ­¥ï¼Œé‚£ä½ å°±ä¸å¾—ä¸è·¨è¿‡åŒæ­¥å’Œå¼‚æ­¥çš„ç—›è‹¦è¾¹ç•Œã€‚æˆ‘è¿˜å‘ç°å®ç°ä¸€ä¸ª
<a href="http://justinjaffray.com/query-engines-push-vs.-pull/">åŸºäºæ‹‰å–çš„æ‰§è¡Œå™¨æ¨¡å‹</a>
ä¼šæ›´å›°éš¾ï¼Œè¿™ç§æ¨¡å‹è¦æ±‚æŸä¸ªä»»åŠ¡å¿…é¡»ç­‰å¾…æ‰€æœ‰çš„è¾“å…¥éƒ½å‡†å¤‡å¥½åœ¨èƒ½åœ¨ Rayon ä¸­è¿è¡Œ</p>
</blockquote>
<h3 id="å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ "><a class="header" href="#å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ ">å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ </a></h3>
<p>èªæ˜çš„äººä¼šè¯´ï¼šä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ä¼šå¢åŠ è¯·æ±‚çš„<a href="https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577">å°¾éƒ¨å»¶è¿Ÿ</a>ï¼Œè¿™æ˜¯éš¾ä»¥ä»¤äººæ¥å—çš„ã€‚</p>
<p>å°¾éƒ¨å»¶è¿Ÿï¼ŸğŸ™„</p>
<p>ä½ å¯èƒ½è®¤ä¸ºï¼šæˆ‘æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ•°æ®åº“ï¼Œå°¾éƒ¨å»¶è¿Ÿå¬èµ·æ¥åƒæ˜¯å¯¹äºé«˜è´Ÿè½½çš„ Web æœåŠ¡å™¨çš„ä¸€ä¸ªå­¦æœ¯é—®é¢˜â€¦â€¦â€</p>
<p>ä½†å…¶å®ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ï¼šæ€è€ƒä¸€ä¸‹å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥å¯¹äºä½¿ç”¨å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼ˆæ¯”å¦‚ Kubernetesï¼‰éƒ¨ç½²çš„æœåŠ¡æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æ£€æŸ¥çš„æ–¹å¼é€šå¸¸æ˜¯å‘é€ä¸€ä¸ª HTTP
è¯·æ±‚åˆ°æŸä¸ª APIï¼Œä¾‹å¦‚ <code>/health</code>ã€‚å¦‚æœè¯¥è¯·æ±‚å·²ç»è¢«åˆ†æ´¾åˆ°æŸä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ Tokio æ­£åœ¨å¿™äºä½¿ç”¨ CPU è¿›è¡Œå¤§é‡æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œé‚£ä¹ˆ
Kubernetes å°†ä¸èƒ½åŠæ—¶å¾—åˆ°â€œç³»ç»Ÿæ­£å¸¸â€çš„å“åº”ï¼Œä½ çš„è¿›ç¨‹å°±ä¼šè¢« K8s æ€æ­»ã€‚å› æ­¤å¾—åˆ°ç»“è®ºï¼šç”±äºå°¾éƒ¨å»¶è¿Ÿï¼Œä½ ä¸èƒ½å°† Tokio ç”¨äº CPU
å¯†é›†å‹ä»»åŠ¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œå°±åƒ Tokio åœ¨æ–‡æ¡£ä¸­é˜è¿°çš„ï¼Œæƒ³è¦é˜²æ­¢ä½ çš„ç¨‹åºåœ¨ CPU å®Œå…¨é¥±å’Œçš„æƒ…å†µä¸‹è¢« K8s
è¯¯æ€ï¼Œä½ åº”è¯¥ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ã€‚ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå¯¹å°¾éƒ¨å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå°±æ¯”å¦‚å“åº” <code>/health</code> æ¥å£ã€‚å¦ä¸€ä¸ªç”¨æ¥æ‰§è¡Œ CPU
å¯†é›†å‹ä»»åŠ¡ã€‚è¿™äº›çº¿ç¨‹æ± çš„çš„æœ€ä½³çº¿ç¨‹æ•°éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å»è°ƒæ•´ã€‚</p>
<p>å¦‚æœä½ å°† Tokio è¿è¡Œæ—¶åªæ˜¯è§†ä¸ºä¸€ä¸ªå¤æ‚ç‚¹çš„çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶å®ä¾‹çš„æƒ³æ³•å¯èƒ½æ›´å®¹æ˜“æ¥å—ï¼Œæˆ‘ä»¬å°†åœ¨æœ€åä½¿ç”¨ä¸“ç”¨çš„æ‰§è¡Œå™¨æ¼”ç¤ºå¦‚ä½•å®ç°è¿™ä¸ªæƒ³æ³•ã€‚</p>
<h3 id="å•ä»»åŠ¡å¼€é”€å¾ˆé«˜"><a class="header" href="#å•ä»»åŠ¡å¼€é”€å¾ˆé«˜">å•ä»»åŠ¡å¼€é”€å¾ˆé«˜</a></h3>
<p>Tokio çš„æ¯ä¸ªä»»åŠ¡å¼€é”€å¾ˆé«˜ã€‚</p>
<p>å¯¹äºè¿™ç‚¹ï¼Œæˆ‘ä¸€ç‚¹ä¹Ÿä¸æƒŠè®¶ã€‚äººä»¬æ€»æ˜¯å¯ä»¥å®ç°æ¯” Tokio è¿è¡Œé€Ÿåº¦æ›´å¿«çš„çº¿ç¨‹æ± ã€‚ä½†æ˜¯ï¼Œè¿™äº›çº¿ç¨‹æ± å¹¶ä¸æ˜¯è¶³å¤Ÿç¨³å®šï¼Œéš¾ä»¥åº”å¯¹ç”Ÿäº§ç¯å¢ƒçš„è´Ÿè½½ï¼Œå¹¶ä¸”ä»–ä»¬ä¹Ÿä¸å…·å¤‡åƒ
Tokio ä¸€æ ·çš„åºå¤§ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<p>åœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼Œå•ä»»åŠ¡çš„å¼€é”€å¯ä»¥ä½¿ç”¨â€œçŸ¢é‡åŒ–å¤„ç†â€
æ¥åˆ†æ‘Šã€‚æ„æ€æ˜¯æ¯ä¸ªä»»åŠ¡å›åŒæ—¶å¤„ç†å‡ åƒè¡Œæ•°æ®è€Œä¸æ˜¯å•å•ä¸€è¡Œï¼Œä½ éœ€è¦å°†ä»»åŠ¡åˆ†æˆåˆç†å¤§å°çš„å—ã€‚ä½ ä¹Ÿä¸èƒ½åˆ†æ‘Šæ‰€æœ‰å·¥ä½œåœºæ™¯ä¸‹çš„å¼€é”€ã€‚ä½†æ˜¯ï¼Œå¯¹äºæˆ‘ä»¬çš„ç¨‹åºå…³å¿ƒçš„å®ä¾‹æ¥è¯´ï¼ŒTokio
çš„ä»»åŠ¡å¼€é”€å·²ç»å¾®ä¹å…¶å¾®äº†</p>
<h2 id="å®è·µ"><a class="header" href="#å®è·µ">å®è·µ</a></h2>
<p>å‡è®¾ä½ å·²ç»è¢«è¯´æœäº†ä½¿ç”¨ Tokio å»å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡æ˜¯å¯è¡Œçš„ã€‚ç°åœ¨ä½ åº”è¯¥æ€ä¹ˆåšï¼Ÿ</p>
<p>é¦–å…ˆï¼Œè‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä½ çš„ä»£ç åº”è¯¥ç¬¦åˆä»¥ä¸‹åŸåˆ™ï¼šå¼‚æ­¥ä»£ç æ°¸è¿œä¸åº”è¯¥èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆï¼Œè¿™ä¸€ç‚¹è¯·å‚è€ƒ Alice Ryhl çš„
<a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a>ã€‚è¿™æ˜¯ä¸ºäº†è®©è°ƒåº¦å™¨æœ‰æœºä¼šå®‰æ’å…¶ä»–äº‹æƒ…ï¼Œæ¯”å¦‚ä»»åŠ¡çªƒå–ç­‰ã€‚</p>
<p>å½“ç„¶äº†ï¼Œè¿™ä¸ªâ€œå¾ˆé•¿æ—¶é—´â€å–å†³äºä½ çš„ç¨‹åºï¼›Ryhl å»ºè®®åœ¨ä¼˜åŒ–å“åº”çš„å°¾éƒ¨å»¶è¿Ÿæ—¶ï¼Œå•ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶é—´åº”è¯¥åœ¨ 10 ~ 100 å¾®ç§’ã€‚æˆ‘è®¤ä¸ºåœ¨é’ˆå¯¹ CPU
è¿›è¡Œä¼˜åŒ–æ—¶ 10~100 æ¯«ç§’ä¹Ÿèƒ½æœ‰ä¸é”™çš„æ•ˆæœã€‚ä½†æ˜¯åœ¨æˆ‘çš„æµ‹è¯•
<a href="https://github.com/alamb/rust_tokio_overhead">estimated per-task Tokio overhead</a>
ä¸­ï¼ŒTokio å•ä»»åŠ¡çš„å¼€é”€åœ¨çº¦ 10 çº³ç§’èŒƒå›´å†…ï¼Œå› æ­¤å‡ ä¹ä¸å¯èƒ½ç”¨ 10 æ¯«ç§’çš„ä»»åŠ¡æ¥æµ‹é‡ Tokio è¿è¡Œæ—¶å¼€é”€ã€‚</p>
<p>å…¶æ¬¡ï¼Œå°†ä»»åŠ¡åˆ†æ´¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ‰§è¡Œå™¨</p>
<h3 id="ä¸“ç”¨çš„æ‰§è¡Œå™¨"><a class="header" href="#ä¸“ç”¨çš„æ‰§è¡Œå™¨">ä¸“ç”¨çš„æ‰§è¡Œå™¨</a></h3>
<p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¼”ç¤ºäº†æˆ‘ä»¬å¦‚ä½•åœ¨ InfluxDB IOx ä¸Šå°†ä»»åŠ¡åˆ†é…åˆ°ä¸€ä¸ªå•ç‹¬çš„ Tokio
è¿è¡Œæ—¶ä¸Šï¼ˆå®Œæ•´ä»£ç å¯ä»¥åœ¨æˆ‘ä»¬çš„<a href="https://github.com/influxdata/influxdb_iox/blob/fe155e15fb2ad166aee66b0458e63c24a8128dd4/query/src/exec/task.rs#L101-L118">ä»“åº“</a>é‡ŒæŸ¥çœ‹ï¼Œé‡Œé¢è¿˜æœ‰å…³äºæ¸…ç†ã€åœæœºã€åˆå¹¶çš„å†…å®¹ï¼‰</p>
<pre><code class="language-rs">pub struct DedicatedExecutor {
    state: Arc&lt;Mutex&lt;State&gt;&gt;,
}

/// Runs futures (and any `tasks` that are `tokio::task::spawned` by
/// them) on a separate Tokio Executor
struct State {
    /// Channel for requests -- the dedicated executor takes requests
    /// from here and runs them.
    requests: Option&lt;std::sync::mpsc::Sender&lt;Task&gt;&gt;,

    /// Thread which has a different Tokio runtime
    /// installed and spawns tasks there
    thread: Option&lt;std::thread::JoinHandle&lt;()&gt;&gt;,
}

impl DedicatedExecutor {
    /// Creates a new `DedicatedExecutor` with a dedicated Tokio
    /// executor that is separate from the threadpool created via
    /// `[tokio::main]`.
    pub fn new(thread_name: &amp;str, num_threads: usize) -&gt; Self {
        let thread_name = thread_name.to_string();

        let (tx, rx) = std::sync::mpsc::channel::&lt;Task&gt;();

        let thread = std::thread::spawn(move || {
            // Create a new Runtime to run tasks
            let runtime = Tokio::runtime::Builder::new_multi_thread()
                .enable_all()
                .thread_name(&amp;thread_name)
                .worker_threads(num_threads)
                // Lower OS priority of worker threads to prioritize main runtime
                .on_thread_start(move || set_current_thread_priority_low())
                .build()
                .expect(&quot;Creating Tokio runtime&quot;);

         // Pull task requests off the channel and send them to the executor
         runtime.block_on(async move {
                while let Ok(task) = rx.recv() {
                    Tokio::task::spawn(async move {
                        task.run().await;
                    });
                }

        let state = State {
            requests: Some(tx),
            thread: Some(thread),
        };

        Self {
            state: Arc::new(Mutex::new(state)),
        }
    }
</code></pre>
<p>è¿™æ®µä»£ç ä¼šåœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ <code>std::thread</code>ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Tokio è¿è¡Œæ—¶ã€‚è¿è¡Œæ—¶ä¼šä» <code>channel</code> è·å–ä»»åŠ¡å¹¶è¿è¡Œã€‚</p>
<p>æ³¨æ„ï¼šè¿™ä¸ªæ–°çš„çº¿ç¨‹å¾ˆå…³é”®ï¼Œå¦‚æœä½ å°è¯•åœ¨ä¸»çº¿ç¨‹é‡Œæˆ–è€…æ˜¯ä»»ä½•å·²ç»åˆ›å»ºè¿‡ Tokio è¿è¡Œæ—¶çš„çº¿ç¨‹é‡Œå†æ¬¡åˆ›å»ºæ–°çš„è¿è¡Œæ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå·²ç»æœ‰ä¸€ä¸ªè¿è¡Œæ—¶äº†ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°†ä»»åŠ¡åˆ†æ´¾åˆ°ç¬¬äºŒä¸ªè¿è¡Œæ—¶ã€‚</p>
<pre><code class="language-rs">impl DedicatedExecutor {

    /// Runs the specified Future (and any tasks it spawns) on the
    /// `DedicatedExecutor`.
    pub fn spawn&lt;T&gt;(&amp;self, task: T) -&gt; Job&lt;T::Output&gt;
    where
        T: Future + Send + 'static,
        T::Output: Send + 'static,
    {
        let (tx, rx) = tokio::sync::oneshot::channel();

        let fut = Box::pin(async move {
            let task_output = task.await;
            tx.send(task_output).ok()
        });
        let mut state = self.state.lock();
        let task = Task {
            fut,
        };

        if let Some(requests) = &amp;mut state.requests {
            // would fail if someone has started shutdown
            requests.send(task).ok();
        } else {
            warn!(&quot;tried to schedule task on an executor that was shutdown&quot;);
        }

        Job { rx, cancel }
    }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†ä¸€ä¸ªåä¸º Job çš„ç»“æ„ä½“ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹ Future çš„ç®€å•åŒ…è£…ï¼ŒJob èƒ½å¤Ÿå°† Future
çš„æ‰§è¡Œç»“æœä»å•ç‹¬çš„æ‰§è¡Œå™¨å†…ä¼ è¾“å›ä¸»çº¿ç¨‹ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ã€‚</p>
<pre><code class="language-rs">#[pin_project(PinnedDrop)]
pub struct Job&lt;T&gt; {
    #[pin]
    rx: Receiver&lt;T&gt;,
}

impl&lt;T&gt; Future for Job&lt;T&gt; {
    type Output = Result&lt;T, Error&gt;;

    fn poll(
        self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut std::task::Context&lt;'_&gt;,
    ) -&gt; std::task::Poll&lt;Self::Output&gt; {
        let this = self.project();
        this.rx.poll(cx)
    }
}
</code></pre>
<p>å°±æ˜¯è¿™æ ·ï¼ä½ å¯ä»¥åœ¨
<a href="https://gist.github.com/alamb/bd0e086448ef9b438aeebd6f550e23ed">Github gist</a>
ä¸­æ‰¾åˆ°æ‰€æœ‰ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://lucumr.pocoo.org/2021/11/14/abusing-serde/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="rust-å†’é™©æ»¥ç”¨-serde"><a class="header" href="#rust-å†’é™©æ»¥ç”¨-serde">Rust å†’é™©ï¼šæ»¥ç”¨ Serde</a></h1>
<p>å½“ä½ è®©ä¸€ä¸ª Rust ç¨‹åºå‘˜æŒ‡å‡ºè‡ªå·±æœ€å–œæ¬¢çš„ä¸œè¥¿æ—¶ï¼Œä»–ä»¬ä¼šå¾ˆå¿«çš„æŒ‡å‡º serde æ˜¯ä¸€ä¸ªè®©å·¥ä½œæ„‰å¿«å¥½å¸®æ‰‹ã€‚serde æ˜¯ä¸€ä¸ª Rust
çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¡†æ¶ã€‚å®ƒçš„æ ¼å¼ç›¸å¯¹ç‹¬ç«‹ï¼Œå¯ä»¥è®©ä½ å¤„ç† JSONï¼ŒYAML ä»¥åŠä¸€ç³»åˆ—ä¸åŒçš„æ ¼å¼ã€‚</p>
<p>é™¤äº†ä¸Šé¢çš„ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤šä¸œè¥¿å¯ä»¥ç”¨ serve å®Œæˆã€‚æˆ‘è®¤ä¸ºæœ‰ä¸€äº›ç”¨ä¾‹ç›¸å½“æœ‰è¶£ï¼Œå€¼å¾—åˆ†äº«ã€‚</p>
<h2 id="æ»¥ç”¨åºåˆ—åŒ–"><a class="header" href="#æ»¥ç”¨åºåˆ—åŒ–">æ»¥ç”¨åºåˆ—åŒ–</a></h2>
<p><em>Abusing Serialization</em></p>
<p>å…¶ä¸­ä¸€ä¸ªæœ‰è¶£çš„ç”¨ä¾‹æ˜¯ç”¨ serde ä½œä¸ºæŸç§å½¢å¼çš„åå°„æ¡†æ¶ï¼Œå°†ç»“æ„ä½“æš´éœ²ç»™å…¶ä»–çš„ä¸èƒ½åŸç”Ÿæ”¯æŒ Rust
ç»“æ„ä½“çš„ç¯å¢ƒã€‚åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œä½ åºåˆ—åŒ–äº†ä¸€ä¸ªå¯ä»¥è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œæ¥ç€ç«‹å³ä»¥æŸç§ç¨å¾®ä¸åŒçš„æ ¼å¼å†æ¬¡ååºåˆ—åŒ–å®ƒã€‚ç›¸æ¯”äºååºåˆ—åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåºåˆ—åŒ–å™¨ç”¨æ¥
'æ•è·' åºåˆ—åŒ–çš„è°ƒç”¨ã€‚è¿™æ˜¯åœ¨ IPCï¼Œæ¨¡æ¿å¼•æ“ä¸Šä¸‹æ–‡ã€æ ¼å¼è½¬æ¢ä¸­å¸¸ç”¨çš„æ¨¡å¼ã€‚</p>
<p>è¿™åœ¨å®è·µä¸­å¤§æ¦‚æ˜¯ä»€ä¹ˆæ ·å‘¢ï¼Ÿè®©æˆ‘ä»¬ä»ç”¨æˆ·çš„è§’åº¦çœ‹ä¸€ä¸‹æˆ‘å†™çš„ <a href="https://github.com/mitsuhiko/minijinja">MiniJinja</a>
æ¨¡æ¿å¼•æ“ã€‚MiniJinja ä½¿ç”¨ serde ä½œä¸ºæ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼Œå°†ç»“æ„åŒ–çš„æ•°æ®ä¼ é€’ç»™æ¨¡æ¿ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œè¯„ä¼°ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç»™å¼€å‘è€…çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-rs">#[derive(Serialize, Debug)]
pub struct User {
    name: String,
}

fn main() {
    let mut env = Environment::new();
    env.add_template(&quot;hello.txt&quot;, &quot;Hello {{ user.name }}!&quot;)
        .unwrap();
    let template = env.get_template(&quot;hello.txt&quot;).unwrap();
    let user = User {
        name: &quot;John&quot;.into(),
    };
    println!(&quot;{}&quot;, template.render(context!(user)).unwrap());
}
</code></pre>
<p>å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå« User çš„ç»“æ„ä½“ï¼Œå¯ä»¥ä½¿ç”¨é»˜è®¤çš„ Serialize å®ç°å°†å®ƒåºåˆ—åŒ–ã€‚è¿™ä¸ªå¯¹è±¡æ¥ç€è¢«ä¼ é€’åˆ°
<code>context!()</code>ã€‚<code>context!()</code> æ‰€åšçš„å°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª mapï¼Œç„¶åå°†ä¸€ä¸ªé”®è®¾ä¸º
userï¼Œæ¥ç€è®¾ç½®ä¸ºè¯¥å˜é‡çš„å€¼ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å…è®¸æ¨¡æ¿å¼•æ“è®¿é—®åˆ° user çš„ 'å±æ€§'ï¼Œä¾‹å¦‚ nameã€‚Rust
ä¸æ˜¯åŠ¨æ€è¯­è¨€ï¼Œè¿™æ„å‘³ç€é€šå¸¸åœ¨è¿è¡Œæ—¶åšè¿™æ ·çš„äº‹æƒ…æ˜¯ä¸å¯èƒ½çš„ã€‚ä½†æ˜¯ç”±äº serde ä¸º User å®ç°äº†
Seralizeï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšã€‚å…·ä½“çš„å®ç°å¤§è‡´å¦‚ä¸‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š</p>
<pre><code class="language-rs">impl Serialize for User {
    fn serialize(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
        where S: Serializer
    {
        let s = serializer.serialize_struct(&quot;User&quot;, 1);
        s.serialize_field(&quot;name&quot;, &amp;self.name)?;
        s.end()
    }
}
</code></pre>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œserializer æ˜¯ä¸€ä¸ªç±»ä¼¼äº JSON åºåˆ—åŒ–å™¨çš„ä¸œè¥¿ï¼Œå®ƒå¯ä»¥å°†ç»“æ„ä½“å†™å…¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…æ˜¯æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æŠŠå®ƒç¼–ç ä¸º JSONã€‚ä½†æ˜¯
serde æä¾›çš„æ¥å£å¹¶ä¸è¦æ±‚ç”¨æˆ·å¿…é¡»è¿™æ ·ã€‚å®é™…ä¸Šï¼ŒMiniJinja ç›´æ¥å°†ç»“æ„ä½“ç¼–ç ä¸ºä¸€ä¸ªå†…å­˜ä¸­çš„ç»“æ„ï¼Œæ¨¡æ¿å¼•æ“å¯ä»¥è§£æå®ƒã€‚</p>
<p>è¿™ç§æ¨¡å¼å¹¶ä¸æ–°é¢–ï¼Œserde æœ¬èº«å…¶å®ä¹Ÿæœ‰ä½¿ç”¨ã€‚å½“ä½ ä½¿ç”¨ serde çš„ flatter åŠŸèƒ½æ—¶ï¼Œserde ä¼šå¯ç”¨ä¸€ä¸ªå†…éƒ¨ç¼“å†²æ¨¡å¼ï¼Œæ•°æ®ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªå†…éƒ¨çš„
Context ç±»å‹ä¸­ï¼ŒContext ç±»å‹å¯ä»¥è¡¨ç¤º serde æ•°æ®æ¨¡å‹çš„å…¨éƒ¨å†…å®¹ã€‚ç„¶åè¿™ä¸ª context å¯ä»¥è¢«ä¼ é€’ç»™å¦ä¸€ä¸ªåºåˆ—åŒ–å™¨ä¸­ã€‚</p>
<p>æˆ‘ä¸ä»…åœ¨ MiniJinjaï¼ŒåŒæ—¶ä¹Ÿåœ¨ <a href="https://insta.rs/">insta</a>
ï¼ˆä¸€ä¸ªå¿«ç…§æµ‹è¯•å·¥å…·ï¼‰ä½¿ç”¨åˆ°è¿™ç§æ¨¡å¼ã€‚ä¸ºäº†é¿å…ç”±äºéç¡®å®šæ€§æ•°æ®å¯¼è‡´çš„æµ‹è¯•å¿«ç…§çš„ä¸ç¨³å®šæ€§ï¼Œæˆ‘é¦–å…ˆå°†å…¶åºåˆ—åŒ–ä¸ºä¸€ç§å†…éƒ¨çš„æ ¼å¼ï¼Œæ¥ç€åœ¨è¯¥æ ¼å¼ä¸Šè¿›è¡Œä¸€ä¸ªå†åŠ å·¥ï¼Œæœ€åå†å°†å…¶åºåˆ—åŒ–ä¸ºæœ€ç»ˆçš„æ ¼å¼ï¼ˆä¾‹å¦‚
YAMLï¼‰ã€‚</p>
<h2 id="tls-æ¶ä½œå‰§"><a class="header" href="#tls-æ¶ä½œå‰§">TLS æ¶ä½œå‰§</a></h2>
<p><em>TLS Shenanigans</em></p>
<blockquote>
<p>TLSï¼šThread Local Storageï¼ŒShenanigansï¼šæ¶ä½œå‰§</p>
</blockquote>
<p>ç„¶è€Œï¼ŒMiniJinja åœ¨æ­¤å¤„ä½¿ç”¨ serde çš„æœ‰è¶£ä¹‹å¤„åœ¨äºï¼Œå®ƒå…è®¸åœ¨åºåˆ—åŒ–å’Œåºåˆ—åŒ–å™¨ä¹‹é—´ä¼ é€’ä¸å…¼å®¹çš„æ•°æ®ã€‚å¦‚å‰æ‰€è¿°ï¼Œserde
æœ‰ä¸€ä¸ªç‰¹å®šçš„æ•°æ®æ¨¡å‹ï¼Œä¸ç¬¦åˆè¯¥æ•°æ®æ¨¡å‹çš„ä¸œè¥¿éƒ½ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚ä¾‹å¦‚ï¼Œserde å¯ä»¥ç¼–ç çš„æœ€å¤§æ•´å‹æ˜¯
i128ã€‚å¦‚æœä½ éœ€è¦ä¸€ä¸ªä»»æ„ç²¾åº¦çš„æ•´å‹ï¼Œé‚£å°±ä¸èµ°è¿äº†ã€‚ä½†æ˜¯è¿˜æ˜¯æœ‰åŠæ³•çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨
<a href="https://en.wikipedia.org/wiki/In-band_signaling">å¸¦å†…ä¿¡ä»¤ï¼ˆin-band signallingï¼‰</a>ä¼ é€’é¢å¤–æ•°æ®ã€‚ä¾‹å¦‚ï¼Œserde
JSON åºåˆ—åŒ–å™¨èƒ½å¤Ÿè¡¨ç¤ºä»»æ„ç²¾åº¦æ•´å‹ï¼Œå› ä¸ºå®ƒåœ¨å•å€¼å¯¹è±¡ä¸­ä¿ç•™äº†ä¸€ä¸ªç‰¹æ®Šçš„é”®ï¼Œå¹¶ç”¨å®ƒå»æŒ‡ç¤º JSON åºåˆ—åŒ– /
ååºåˆ—åŒ–å™¨ç»„åˆï¼Œå†³å®šè¿™ä¸ªä»»æ„ç²¾åº¦çš„æ•´å‹æ˜¯å¦è¦è¢«åºåˆ—åŒ–ã€‚å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<pre><code class="language-json">{ &quot;$serde_json::private::Number&quot;: &quot;value&quot; }
</code></pre>
<p>ä½†æ˜¯ä½ åº”è¯¥èƒ½å‘ç°ï¼Œå¦‚æœä¸€ä¸ªäººç»™å‡ºäº†è¿™æ ·çš„ JSON æ–‡æ¡£ï¼Œserde JSON ä¼šæŠŠå®ƒå½“ä½œä»»æ„ç²¾åº¦çš„æ•´å½¢å»è§£æï¼Œè¿™æ„å‘³ç€ 'value' éƒ¨åˆ†æœ¬èº«ä¹Ÿéœ€è¦äº
serde å…¼å®¹ã€‚å¯¹äºä»»æ„ç²¾åº¦çš„æ•´å‹ï¼Œè¿™æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºå®ƒå¯ä»¥ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºã€‚ä½†æ˜¯å‡å¦‚ä½ æƒ³åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­ä¼ é€’çš„ä¸œè¥¿æ ¹æœ¬ä¸èƒ½åºåˆ—åŒ–å‘¢ï¼Ÿ</p>
<p>è¿™æ—¶ï¼Œå·§å¦™åœ°åˆ©ç”¨ <strong>thread local</strong> å°±æ˜¯ä¸€ç§å˜é€šæ–¹æ³•ã€‚</p>
<p>åœ¨ MiniJinja ä¸­ï¼Œè¿è¡Œæ—¶å€¼çš„å†…éƒ¨è¡¨ç¤ºæ˜¯ä¸€ä¸ªå«åš <code>Value</code>
çš„ç»“æ„ä½“ã€‚æ­£å¦‚ä½ æ‰€æœŸæœ›çš„ï¼Œå®ƒå¯ä»¥å®¹çº³æ•´å‹ï¼Œæµ®ç‚¹æ•°ï¼Œå­—ç¬¦ä¸²ï¼Œåˆ—è¡¨ï¼Œå¯¹è±¡ç­‰ç­‰ã€‚ç„¶è€Œï¼Œä»–ä¹Ÿå¯ä»¥å®¹çº³ä¸€äº› serde
å®Œå…¨æ— æ³•è§£æçš„ç±»å‹ã€‚ç‰¹åˆ«æ˜¯å®ƒå¯ä»¥ä¿å­˜ä¸€ç§ç‰¹æ®Šç±»å‹çš„å­—ç¬¦ä¸²ï¼Œç§°ä¸º <code>'safe' string</code>, å®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨äº†å®‰å…¨çš„ HTML
ä»£ç çš„å­—ç¬¦ä¸²ï¼Œä¸éœ€è¦è½¬ä¹‰ï¼Œä¹Ÿä¸éœ€è¦æ‰€è°“çš„ 'åŠ¨æ€å€¼'ã€‚åè€…ç‰¹åˆ«æœ‰è¶£ï¼Œå› ä¸ºå®ƒä¸èƒ½è¢«åºåˆ—åŒ–ã€‚</p>
<p>ä»€ä¹ˆæ˜¯åŠ¨æ€å€¼ï¼Ÿå®ƒå®é™…ä¸Šæ˜¯å…·æœ‰çŠ¶æ€çš„å¯¹è±¡çš„å¥æŸ„ï¼Œåº”è¯¥ç›´æ¥ä¼ é€’ç»™æ¨¡æ¿ã€‚è¿™é‡Œçš„ä¸€ä¸ªä¾‹å­æ˜¯ MiniJinja ä¸­çš„ loop å˜é‡ï¼š</p>
<pre><code class="language-rs">&lt;ul&gt;
{% for item in seq %}
    &lt;li&gt;{{ loop.index }}: {{ item }}&lt;/li&gt;
{% endfor %}
&lt;/ul&gt;
</code></pre>
<p>MiniJinjaï¼ˆç±»ä¼¼äº Jinja2ï¼‰æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„ loop å˜é‡å¯ä»¥è®¿é—®å¾ªç¯çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡ <code>loop.index</code>
æ¥è·å–å½“å‰å¾ªç¯çš„è¿­ä»£æ¬¡æ•°ã€‚åœ¨ MiniJinja çš„å·¥ä½œåŸç†ä¸­ï¼Œ'å¾ªç¯æ§åˆ¶å™¨' æœ¬èº«ä¼šè¢«ç›´æ¥ä¼ é€’ç»™æ¨¡æ¿ï¼Œå¹¶ä¸”æŠŠå€¼æœ¬èº«å½“ä½œå¼•ç”¨è®¡æ•°å­˜è¿›å»ã€‚</p>
<pre><code class="language-rs">pub struct LoopState {
    len: AtomicUsize,
    idx: AtomicUsize,
}

let controller = Rc::new(LoopState {
    idx: AtomicUsize::new(!0usize),
    len: AtomicUsize::new(len),
});
</code></pre>
<p>å½“å¾ªç¯è¿­ä»£æ—¶ï¼Œæ§åˆ¶å™¨ä¸Šçš„ç´¢å¼•ä¼š +1ã€‚</p>
<pre><code class="language-rs">controller.idx.fetch_add(1, Ordering::Relaxed);
</code></pre>
<p>æ§åˆ¶å™¨æœ¬èº«ä¼šè¢«ç›´æ¥æ·»åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼š</p>
<pre><code class="language-rs">let template_side_controller = Value::from_object(controller);
</code></pre>
<p>ä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæ§åˆ¶å™¨éœ€è¦å®ç° MiniJinja å†…éƒ¨çš„ <code>Object</code> ç‰¹å¾ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæœ€å°å®ç°ï¼š</p>
<pre><code class="language-rs">impl Object for LoopState {
    fn attributes(&amp;self) -&gt; &amp;[&amp;str] {
        &amp;[&quot;index&quot;, &quot;length&quot;][..]
    }

    fn get_attr(&amp;self, name: &amp;str) -&gt; Option&lt;Value&gt; {
        let idx = self.idx.load(Ordering::Relaxed) as u64;
        let len = self.len.load(Ordering::Relaxed) as u64;
        match name {
            &quot;index&quot; =&gt; Some(Value::from(idx + 1)),
            &quot;length&quot; =&gt; Some(Value::from(len)),
            _ =&gt; None,
        }
    }
}
</code></pre>
<p>åœ¨æ¨¡æ¿å¼•æ“é‚£ä¸€è¾¹ï¼Œç³»ç»ŸçŸ¥é“å½“ <code>index</code> å±æ€§è¢«ä½¿ç”¨æ—¶ï¼Œéœ€è¦è°ƒç”¨ <code>get_attr()</code> æ–¹æ³•ã€‚</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬æ‰€è¯´çš„éƒ½æ˜¯ç†è®ºï¼Œserde ç©¶ç«Ÿæ˜¯å¦‚ä½•åšçš„å‘¢ï¼Ÿå½“ <code>Value::from_object</code> è°ƒç”¨æ—¶ï¼Œä¼ å…¥çš„å€¼ä¼šè¢« <code>move</code> åˆ° value
å¯¹è±¡é‡Œã€‚è¿™æ ·åšä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œç‰¹åˆ«æ˜¯ç”±äºå·²ç»ä½¿ç”¨äº†å¼•ç”¨è®¡æ•°ã€‚ä½†æ˜¯ç°åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¯¹äºåƒ <code>LoopState</code> è¿™æ ·æœ¬èº«æ²¡æœ‰å®ç° <code>Serialize</code>
çš„ä¸œè¥¿ï¼Œå®ƒçš„å€¼æ˜¯å¦‚ä½•è¢«åºåˆ—åŒ–çš„ï¼Ÿç­”æ¡ˆæ˜¯çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼ˆthread local storageï¼‰å’Œä¸€ä¸ªåˆä½œçš„ï¼ˆco-operatingï¼‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨ã€‚</p>
<h2 id="è¶Šè¿‡è¾¹ç•Œçš„-state"><a class="header" href="#è¶Šè¿‡è¾¹ç•Œçš„-state">è¶Šè¿‡è¾¹ç•Œçš„ State</a></h2>
<p><em>Out of Bound State</em></p>
<p>éšè—åœ¨ MiniJinja çš„ Value å®ç°æœ‰è¿™æ ·ä¸€æ®µä»£ç ï¼š</p>
<pre><code class="language-rs">const VALUE_HANDLE_MARKER: &amp;str = &quot;\x01__minijinja_ValueHandle&quot;;
thread_local! {
     static INTERNAL_SERIALIZATION: AtomicBool = AtomicBool::new(false);
     static LAST_VALUE_HANDLE: AtomicUsize = AtomicUsize::new(0);
     static VALUE_HANDLES: RefCell&lt;BTreeMap&lt;usize, Value&gt;&gt; = RefCell::new(BTreeMap::new());
 }

fn in_internal_serialization() -&gt; bool {
    INTERNAL_SERIALIZATION.with(|flag| flag.load(atomic::Ordering::Relaxed))
}
</code></pre>
<p>å®ƒä»¬çš„ç”¨å¤„æ˜¯ï¼ŒValue
è‡ªèº«èƒ½å¤Ÿæ„ŸçŸ¥åˆ°ä»€ä¹ˆæ—¶å€™ä½¿ç”¨å†…éƒ¨åºåˆ—åŒ–çš„ç‰¹æ®Šå½¢å¼ã€‚è¿™ç§å†…éƒ¨åºåˆ—åŒ–æ˜¯ä¸€ç§ç‰¹æ®Šå½¢å¼çš„åºåˆ—åŒ–ï¼Œæˆ‘ä»¬æ˜ç¡®çŸ¥é“æˆ‘ä»¬çš„åºåˆ—åŒ–æ•°æ®çš„æ¥æ”¶è€…æ˜¯ä¸€ä¸ªå¯ä»¥ç†è§£è¯¥æ•°æ®çš„ååºåˆ—åŒ–å™¨ã€‚æˆ‘ä»¬æ²¡æœ‰ç›´æ¥å¯¹æ•°æ®è¿›è¡Œåºåˆ—åŒ–ï¼Œè€Œæ˜¯å°†å…¶å­˜å…¥åˆ°
TLS ä¸­ï¼Œç„¶åæŠŠæ•°æ®çš„å¥æŸ„åºåˆ—åŒ–åˆ° serde åºåˆ—åŒ–å™¨ä¸­ã€‚ååºåˆ—åŒ–å™¨ä¼šå…ˆååºåˆ—åŒ–å¥æŸ„ï¼Œæ¥ç€å†ä» TLS ä¸­æå–å€¼ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬çš„å¾ªç¯æ§åˆ¶å™¨åºåˆ—åŒ–çš„å®ç°å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rs">impl Serialize for Value {
    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
    where
        S: Serializer,
    {
        // enable round tripping of values
        if in_internal_serialization() {
            use serde::ser::SerializeStruct;
            let handle = LAST_VALUE_HANDLE.with(|x| x.fetch_add(1, atomic::Ordering::Relaxed));
            VALUE_HANDLES.with(|handles| handles.borrow_mut().insert(handle, self.clone()));
            let mut s = serializer.serialize_struct(VALUE_HANDLE_MARKER, 1)?;
            s.serialize_field(&quot;handle&quot;, &amp;handle)?;
            return s.end();
        }

        // ... here follows implementation for serializing to JSON etc.
    }
}
</code></pre>
<p>å¦‚æœå®ƒè¢«åºåˆ—åŒ–ä¸º JSONï¼Œæˆ‘ä»¬å¤§è‡´èƒ½çœ‹åˆ°è¿™æ ·çš„ä¸œè¥¿ï¼š</p>
<pre><code class="language-json">{ &quot;\u0001__minijinja_ValueHandle&quot;: 1 }
</code></pre>
<p>è€ŒçœŸæ­£çš„å¾ªç¯æ§åˆ¶å™¨å°†è¢«å­˜å‚¨åœ¨ <code>VALUE_HANDLES</code> ä¸­å¥æŸ„ä¸º 1 å¤„ã€‚ç°åœ¨æˆ‘ä»¬å¦‚ä½•ä»é‡Œé¢çš„åˆ°æ•°å€¼å‘¢ï¼Ÿåœ¨ MiniJinja
ä¸­ï¼Œååºåˆ—åŒ–å…¶å®ä»æœªå‘ç”Ÿï¼Œåªæœ‰åºåˆ—åŒ–ã€‚è€Œä¸”åºåˆ—åŒ–ä¹Ÿåªæ˜¯å°†å†…å­˜ä¸­çš„å¯¹è±¡ç»„è£…èµ·æ¥ã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦è®©åºåˆ—åŒ–å™¨ç†è§£å¸¦å†…ä¿¡ä»¤å¦‚ä½•å¤„ç†ï¼Œå¹¶ä»¥æ­¤æ‰¾åˆ°å¸¦å¤–çš„å€¼ã€‚</p>
<pre><code class="language-rs">impl ser::SerializeStruct for SerializeStruct {
    type Ok = Value;
    type Error = Error;

    fn serialize_field&lt;T: ?Sized&gt;(&amp;mut self, key: &amp;'static str, value: &amp;T) -&gt; Result&lt;(), Error&gt;
    where
        T: Serialize,
    {
        let value = value.serialize(ValueSerializer)?;
        self.fields.insert(key, value);
        Ok(())
    }

    fn end(self) -&gt; Result&lt;Value, Error&gt; {
        match self.name {
            VALUE_HANDLE_MARKER =&gt; {
                let handle_id = self.fields[&quot;handle&quot;].as_usize();
                Ok(VALUE_HANDLES.with(|handles| {
                    let mut handles = handles.borrow_mut();
                    handles
                        .remove(&amp;handle_id)
                        .expect(&quot;value handle not in registry&quot;)
                }))
            }
            _ =&gt; /* regular struct code */
        }
    }
}
</code></pre>
<h2 id="ser-to-de"><a class="header" href="#ser-to-de">Ser-to-De</a></h2>
<p>ä¸Šé¢çš„ä¾‹å­æ˜¯ä½ å¯ä»¥æ»¥ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œä½†æ˜¯åŒæ ·çš„æ¨¡å¼åœ¨çœŸå®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸­ä¹Ÿå¯ä»¥ç”¨åˆ°ã€‚åœ¨ MiniJinja
ä¸­ï¼Œæˆ‘å¯ä»¥ä¸ä½¿ç”¨åºåˆ—åŒ–ï¼Œå› ä¸ºæˆ‘æœ‰æ•ˆåœ°åˆ©ç”¨äº†åºåˆ—åŒ–ä»£ç ï¼Œä»ä¸€ç§å†…å­˜æ ¼å¼è½¬æ¢åˆ°å¦ä¸€ç§å†…å­˜æ ¼å¼ã€‚å¦‚æœä½ æƒ³åœ¨è¿›ç¨‹é—´ä¼ é€’æ•°æ®ï¼Œæƒ…å†µå°±ä¼šå˜å¾—æ£˜æ‰‹ä¸€äº›ï¼Œå®é™…çš„åºåˆ—åŒ–å°±æ˜¯å¿…è¦çš„ã€‚ä¾‹å¦‚ï¼Œä½ æƒ³å»ºç«‹ä¸€ä¸ª
IPC
ç³»ç»Ÿï¼Œåœ¨è¿›ç¨‹ä¹‹é—´äº¤æ¢æ•°æ®ï¼Œè¿™é‡Œçš„æŒ‘æˆ˜æ˜¯ï¼Œå‡ºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œå¯¹äºæ¯”è¾ƒå¤§çš„å†…å­˜æ®µï¼Œä½ å¿…é¡»ä½¿ç”¨å…±äº«å†…å­˜ï¼Œæˆ–è€…æ˜¯ä»¥æ–‡ä»¶æè¿°ç¬¦çš„å½¢å¼ä¼ é€’æ‰“å¼€çš„æ–‡ä»¶ï¼ˆå› ä¸ºè¿™äº›æ–‡ä»¶æœ‰å¯èƒ½æ˜¯
socketï¼‰ã€‚åœ¨æˆ‘çš„å®éªŒæ€§ <a href="https://github.com/mitsuhiko/unix-ipc">unix-ipc</a> crate
ä¸­ï¼Œæˆ‘å°±æ˜¯è¿™æ ·åšçš„ã€‚</p>
<p>æˆ‘åœ¨è¿™é‡Œå»ºç«‹äº†ä¸€ä¸ªäºŒçº§ç¼“å†²åŒºï¼Œå®ƒå¯ä»¥æ”¾ç½®æ–‡ä»¶æè¿°ç¬¦ã€‚åŒæ ·ï¼Œè¿™é‡Œå¿…é¡»ä½¿ç”¨ TLSã€‚</p>
<p>API å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rs">pub fn serialize&lt;S: Serialize&gt;(s: S) -&gt; io::Result&lt;(Vec&lt;u8&gt;, Vec&lt;RawFd&gt;)&gt; {
    let mut fds = Vec::new();
    let mut out = Vec::new();
    enter_ipc_mode(|| bincode::serialize_into(&amp;mut out, &amp;s), &amp;mut fds)
        .map_err(bincode_to_io_error)?;
    Ok((out, fds))
}
</code></pre>
<p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œè¿™äº›éƒ½æ˜¯é€æ˜çš„ã€‚å½“ä¸€ä¸ª Serailize å®ç°é‡åˆ°äº†ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡æ—¶ï¼Œå®ƒå¯ä»¥æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨ IPC çš„åºåˆ—åŒ–ï¼Œå¦‚æœæ˜¯ï¼Œå®ƒå¯ä»¥æŠŠ FD
å­˜èµ·æ¥ï¼Œ<code>enter_ipc_mode</code> åŸºæœ¬ä¸Šå°† fds ç»‘å®šåˆ°äº†ä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡é‡Œï¼Œæ¥ç€è°ƒç”¨ <code>register_fd</code>
æ³¨å†Œå®ƒã€‚ä¾‹å¦‚ï¼Œä¸‹é¢å±•ç¤ºäº†å†…éƒ¨å¥æŸ„çš„åºåˆ—åŒ–æ–¹å¼ï¼š</p>
<pre><code class="language-rs">impl&lt;F: IntoRawFd&gt; Serialize for Handle&lt;F&gt; {
    fn serialize&lt;S&gt;(&amp;self, serializer: S) -&gt; Result&lt;S::Ok, S::Error&gt;
    where
        S: ser::Serializer,
    {
        if is_ipc_mode() {
            // effectively a weird version of `into_raw_fd` that does
            // consume
            let fd = self.extract_raw_fd();
            let idx = register_fd(fd);
            idx.serialize(serializer)
        } else {
            Err(ser::Error::custom(&quot;can only serialize in ipc mode&quot;))
        }
    }
}
</code></pre>
<p>ç„¶åæ˜¯ååºåˆ—åŒ–ï¼š</p>
<pre><code class="language-rs">impl&lt;'de, F: FromRawFd + IntoRawFd&gt; Deserialize&lt;'de&gt; for Handle&lt;F&gt; {
    fn deserialize&lt;D&gt;(deserializer: D) -&gt; Result&lt;Handle&lt;F&gt;, D::Error&gt;
    where
        D: de::Deserializer&lt;'de&gt;,
    {
        if is_ipc_mode() {
            let idx = u32::deserialize(deserializer)?;
            let fd = lookup_fd(idx).ok_or_else(|| de::Error::custom(&quot;fd not found in mapping&quot;))?;
            unsafe { Ok(Handle(Mutex::new(Some(FromRawFd::from_raw_fd(fd))))) }
        } else {
            Err(de::Error::custom(&quot;can only deserialize in ipc mode&quot;))
        }
    }
}
</code></pre>
<p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œä»–åªéœ€è¦é€šè¿‡ IPC channel ä¼ é€’ä¸€ä¸ª <code>Handle::new(my_file)</code> å°±èƒ½å®ç°ã€‚</p>
<h2 id="serde-çš„ç°çŠ¶"><a class="header" href="#serde-çš„ç°çŠ¶">Serde çš„ç°çŠ¶</a></h2>
<p><em>State of Serde</em></p>
<p>ä¸å¹¸çš„æ˜¯ï¼Œä¸Šé¢æ‰€æœ‰çš„ä¸œè¥¿éƒ½ä¾èµ–çº¿ç¨‹æœ¬åœ°å˜é‡å’Œå¯¹å†…ä¿¡ä»¤ã€‚æ•´ä½“ä¸Šéƒ½ä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœæœ‰ä¸€å¤©å‡ºäº† serde 2.0ï¼Œæˆ‘å¸Œæœ›æœ‰æ›´å¥½çš„æ–¹æ³•å®ç°ä¸Šé¢çš„å†…å®¹ã€‚</p>
<p>å®é™…ä¸Šï¼Œç°åœ¨çš„ serde ä»ç„¶æœ‰ä¸å°‘é—®é¢˜å’Œä¸Šè¿°çš„ Hack è¡Œä¸ºç›¸å…³ã€‚</p>
<ul>
<li><a href="https://github.com/serde-rs/serde/issues/1463">serde requires in-band signalling</a></li>
<li><a href="https://github.com/serde-rs/serde/issues/1183">Internal buffering disrupts format-specific deserialization features</a></li>
<li><a href="https://github.com/serde-rs/json/issues/721">serde_json's arbitrary precision feature incompatible with flatten</a></li>
</ul>
<p>è¯´åˆ°è¿™é‡Œï¼Œåœ¨æˆ‘ä»¬éœ€è¦é‡å†™ serde ä¹‹å‰ï¼Œè‚¯å®šè¿˜æœ‰è¿›ä¸€æ­¥å¯ä»¥è¢«æ»¥ç”¨çš„åœ°æ–¹ã€‚ä½†æ˜¯ç°åœ¨æ˜¯æ—¶å€™åº”è¯¥æ…¢æ…¢è€ƒè™‘ serve
æœªæ¥ç‰ˆæœ¬çš„è®¾æƒ³äº†å®ƒåº”è¯¥å¯¹æ•°æ®æ¨¡å‹çš„æ”¯æŒæ›´å‹å¥½ï¼Œå¯ä»¥ç”¨æ›´å°‘çš„ Hack æ¥è„±ç¦»è§„å®šæ¡†æ¶ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://lucumr.pocoo.org/2022/1/6/rust-extension-map/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="æ‹“å±•-rust-ä¸­çš„-map"><a class="header" href="#æ‹“å±•-rust-ä¸­çš„-map">æ‹“å±• Rust ä¸­çš„ Map</a></h1>
<p>åœ¨ Rust ä¸­ï¼Œå¦‚æœä½ æƒ³ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªçµæ´»çš„ APIï¼Œä¸€èˆ¬å¯ä»¥å¼•å…¥æ³›å‹å‚æ•°ã€‚ä»¥ä¸€ä¸ª web
æ¡†æ¶ä¸ºä¾‹ï¼Œå®ƒå¯èƒ½éœ€è¦ä¸€ä¸ªç¨‹åºç±»å‹ï¼Œå¹¶ä¸”éœ€è¦ä¼ é€’ç»™å¾ˆå¤šå‡½æ•°ã€‚è¿™ä¸ªç¨‹åºç±»å‹éœ€è¦èƒ½å¤Ÿä»¥é…ç½®çš„å½¢å¼è¢«å‚æ•°åŒ–ã€‚</p>
<h2 id="å¼•å…¥-any-ç‰¹å¾"><a class="header" href="#å¼•å…¥-any-ç‰¹å¾">å¼•å…¥ Any ç‰¹å¾</a></h2>
<p>ä¸€ä¸ªè§£å†³æ–¹æ³•æ˜¯ä½¿ç”¨ <code>Any</code> ç‰¹å¾ã€‚å®ƒéœ€è¦ä¸€ä¸ª <code>'static</code> çš„ç”Ÿå‘½å‘¨æœŸï¼Œå½“ä½ ä¹‹åä½¿ç”¨å®ƒæ—¶ï¼Œè¿˜éœ€è¦ç”¨ <code>Box</code>
è¿›è¡Œè£…ç®±ã€‚æ¯”å¦‚æˆ‘ä»¬å¯èƒ½å¯¹å®ƒè¿›è¡Œå‘ä¸‹è½¬å‹ï¼Œå³è½¬æ¢ä¸ºåŸå§‹çš„ç±»å‹ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨æŸä¸ªåœ°æ–¹ï¼ˆæ¯”å¦‚æˆ‘ä»¬çš„ Appï¼‰ä¸­å­˜å‚¨å’Œè·å–ä»»æ„ç±»å‹ã€‚</p>
<p>æˆ‘ä»¬æœŸæœ›çš„ API å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rs">let app = App::new();

// place in extension map
app.extensions().insert(Config { ... });
app.extensions().insert(Database { ... });

// retrieve from extension map
let config = app.extensions().get::&lt;Config&gt;();
</code></pre>
<p>æˆ‘ä»¬çš„ app éœ€è¦å®¹çº³å…¶ä»–æ‹“å±•çš„ç±»å‹ï¼Œä»¥ä¾¿ä¹‹åä½¿ç”¨ã€‚</p>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è¯•è¯•æœ€ç®€å•çš„å®ç°æ–¹å¼ï¼šå‡†å¤‡ä¸€ä¸ª <code>Extensions</code> å¯¹è±¡ï¼Œè®©å®ƒå®ç°æ’å…¥å’Œè·å–çš„æ–¹æ³•ã€‚å¦‚æœä¸€ä¸ªæ‹“å±•è¿˜ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬å°±è‡ªåŠ¨æ’å…¥ä¸€ä¸ªé»˜è®¤çš„ï¼ˆéœ€è¦å®ç°
<code>Default</code> ç‰¹å¾ï¼‰ã€‚</p>
<pre><code class="language-rs">use std::collections::HashMap;
use std::any::{Any, TypeId};

#[derive(Default)]
pub struct Extensions {
    map: HashMap&lt;TypeId, Box&lt;dyn Any&gt;&gt;,
}

impl Extensions {
    pub fn insert&lt;T: 'static&gt;(&amp;mut self, value: T) {
        self.map.insert(TypeId::of::&lt;T&gt;(), Box::new(value));
    }

    pub fn get&lt;T: 'static&gt;(&amp;self) -&gt; &amp;T {
        self.map.get(&amp;TypeId::of::&lt;T&gt;())
            .and_then(|b| b.downcast_ref())
            .unwrap()
    }

    pub fn get_mut&lt;T: Default + 'static&gt;(&amp;mut self) -&gt; &amp;mut T {
        self.ensure::&lt;T&gt;();
        self.map.get_mut(&amp;TypeId::of::&lt;T&gt;())
            .and_then(|b| b.downcast_mut())
            .unwrap()
    }

    fn ensure&lt;T: Default + 'static&gt;(&amp;mut self) {
        if self.map.get(&amp;TypeId::of::&lt;T&gt;()).is_none() {
            self.insert(T::default());
        }
    }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç éå¸¸ç›´æ¥ï¼Œä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼šé¦–å…ˆï¼Œåªæœ‰ <code>get_mut</code> èƒ½å¤Ÿè°ƒç”¨ <code>ensure</code> å»æ’å…¥é»˜è®¤å€¼ï¼Œå¦‚æœæœ‰äººç›´æ¥è°ƒç”¨ <code>get</code> å°±ä¼šå¯¼è‡´
panicã€‚ç¬¬äºŒä¸ªé—®é¢˜æ˜¯ï¼Œå€Ÿç”¨æ£€æŸ¥å™¨ä¼šè®©ä¹‹åçš„ç¼–å†™éå¸¸å›°éš¾ã€‚ä¸Šé¢çš„ map å¯¹äºè§£å†³ç»å…¸çš„é—®é¢˜ï¼ˆä¾‹å¦‚ appï¼‰æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä½ åªéœ€è¦é…ç½®ä¸€æ¬¡ï¼Œè‡ªé‚£ä¹‹å map
å°±åƒæ˜¯è¢«å†»ç»“äº†ä¸€æ ·ï¼Œå› ä¸ºæœ‰å¤ªå¤šçš„å¼•ç”¨åœ¨é£æ¥åˆ†é£å»ï¼Œä»¥è‡³äºæ²¡æœ‰äººèƒ½å¤Ÿå¾—åˆ° <code>&amp;mut</code> çš„å¼•ç”¨ã€‚</p>
<p>how does it workï¼Ÿ</p>
<p>ä¸Šé¢çš„ä»£ç æ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼ŒRust ä¸­çš„æ¯ä¸€ç§ç±»å‹éƒ½ä¼šæœ‰ä¸€ä¸ª type IDï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>TypeId::of::&lt;T&gt;()</code>
è·å–ã€‚ä»–æ˜¯å”¯ä¸€çš„ï¼Œä½ å¯ä»¥ç”¨å®ƒè¿›è¡Œæ¯”è¾ƒï¼Œæˆ–è€…æ˜¯ä½œä¸º map çš„é”®æ¥ä½¿ç”¨ã€‚æ¯ç§ç±»å‹åªå…è®¸æœ‰ä¸€ä¸ªå€¼ã€‚æ¥ç€æˆ‘ä»¬æŠŠ T ä½œä¸º <code>dyn Any</code> å­˜å‚¨åœ¨ map
é‡Œï¼Œ<code>Any</code> ç‰¹å¾å…è®¸æˆ‘ä»¬ä½¿ç”¨ <code>downcast_ref</code> å’Œ <code>downcast_mut</code> æ–¹æ³•æ‹¿åˆ°åŸå§‹ç±»å‹ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨äº† ensure
æ–¹æ³•ç¡®ä¿è¿™é‡Œçš„ç±»å‹å­˜åœ¨ï¼Œå› æ­¤å¯ä»¥å®‰å…¨çš„ unwrapã€‚</p>
<h2 id="å†…éƒ¨å¯å˜æ€§"><a class="header" href="#å†…éƒ¨å¯å˜æ€§">å†…éƒ¨å¯å˜æ€§</a></h2>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª web æ¡†æ¶æˆ–è€…æ˜¯æ¨¡æ¿å¼•æ“çš„å¸¸è§æ¡ˆä¾‹ã€‚ä»¥
<a href="https://github.com/mitsuhiko/minijinja">MiniJinja</a>ï¼ˆæ¨¡æ¿å¼•æ“ï¼‰ä¸ºä¾‹ï¼Œå®ƒé‡Œé¢æœ‰ä¸€ä¸ª State
å¯¹è±¡ï¼Œæ¯æ¬¡æ¨¡æ¿åˆå§‹åŒ–æ—¶éƒ½ä¼šåˆ›å»ºä¸€æ¬¡ï¼ŒState æ²¡æœ‰å®ç° Send å’Œ Syncï¼ŒMiniJinja åœ¨è¯„ä¼°æ—¶éœ€è¦ Stateã€‚å¦‚æœä½ æƒ³è®©ç”¨æˆ·èƒ½å¤Ÿæ”¾å…¥è‡ªå®šä¹‰çš„
State å‘¢ï¼Ÿåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨å†…éƒ¨ä½¿ç”¨ <code>RefCell</code> æ¥è°ƒæ•´ä¸Šé¢çš„ç±»å‹ã€‚</p>
<pre><code class="language-rs">use std::collections::HashMap;
use std::any::{Any, TypeId};
use std::cell::{Ref, RefCell, RefMut};

#[derive(Default)]
pub struct Extensions {
    map: RefCell&lt;HashMap&lt;TypeId, Box&lt;dyn Any&gt;&gt;&gt;,
}

impl Extensions {
    pub fn insert&lt;T: 'static&gt;(&amp;self, value: T) {
        self.map.borrow_mut().insert(TypeId::of::&lt;T&gt;(), Box::new(value));
    }

    pub fn get&lt;T: Default + 'static&gt;(&amp;self) -&gt; Ref&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        Ref::map(self.map.borrow(), |m| {
            m.get(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| b.downcast_ref())
                .unwrap()
        })
    }

    pub fn get_mut&lt;T: Default + 'static&gt;(&amp;self) -&gt; RefMut&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        RefMut::map(self.map.borrow_mut(), |m| {
            m.get_mut(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| b.downcast_mut())
                .unwrap()
        })
    }

    fn ensure&lt;T: Default + 'static&gt;(&amp;self) {
        if self.map.borrow().get(&amp;TypeId::of::&lt;T&gt;()).is_none() {
            self.insert(T::default());
        }
    }
}
</code></pre>
<p>ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹ï¼Œå‡ ä¹æ²¡æœ‰å˜åŒ–ã€‚ä¸»è¦çš„åŒºåˆ«æ˜¯ä½ ä¸éœ€è¦ä¸€ä¸ªå¯å˜å¼•ç”¨å°±èƒ½è°ƒç”¨ <code>get_mut</code>ï¼Œè¿™ä¸€å£®ä¸¾æ˜¯ç”± <code>RefCell</code> å®ç°çš„ï¼ŒRefcell
èƒ½å¤Ÿå°†æ£€æŸ¥ç§»åŠ¨åˆ°è¿è¡Œæ—¶ã€‚å½“ä¸€ä¸ª <code>RefMut</code> è¢«ç»™å‡ºæ—¶ï¼Œå¦‚æœå·²ç»å­˜åœ¨ä»»ä½•çš„å¯å˜æˆ–ä¸å¯å˜å¼•ç”¨ï¼Œå°±ä¼šå‘ç”Ÿ
panicã€‚å¯¹äºè¿™é‡Œçš„ç”¨æˆ·æ¥è¯´ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ç¡®ä¿åªæœ‰ä¸€ä¸ªå¯å˜çš„å¼•ç”¨åœ¨ä½¿ç”¨ã€‚ç‰¹åˆ«æ£’çš„æ˜¯ï¼ŒRef å’Œ RefMut
ç±»å‹æä¾›äº†ä¸€ä¸ªé™æ€çš„ map æ–¹æ³•ï¼Œè®©ä½ å¯ä»¥è½»æ¾æ´¾ç”Ÿå‡ºå¦ä¸€ä¸ª Ref æˆ– RefMutï¼Œå¹¶ä¿æŒåŸæ¥çš„å¼•ç”¨ï¼Œä½†å¯¹å€¼è¿›è¡Œè½¬æ¢ã€‚</p>
<h2 id="åŒæ­¥æ”¯æŒ"><a class="header" href="#åŒæ­¥æ”¯æŒ">åŒæ­¥æ”¯æŒ</a></h2>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦ç”¨ Send å’Œ Sync æ¥å®ç°å’Œä¸Šé¢ç›¸åŒçš„æ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé”ã€‚å¯æƒœçš„æ˜¯æ ‡å‡†åº“æä¾›çš„ Mutex å’Œ RwLock ä¸èƒ½è®©ä½ åœ¨æ‹¿åˆ°é”çš„åŒæ—¶
mapï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>parking_lot</code> æ›¿ä»£ï¼Œå®ƒå®ç°äº†å¿…è¦çš„ä¸€äº›æ–¹æ³•ã€‚</p>
<pre><code class="language-rs">use parking_lot::{
    MappedRwLockReadGuard,
    MappedRwLockWriteGuard,
    RwLock,
    RwLockReadGuard,
    RwLockWriteGuard,
};
use std::any::{Any, TypeId};
use std::collections::HashMap;

#[derive(Default)]
pub struct Extensions {
    map: RwLock&lt;HashMap&lt;TypeId, Box&lt;dyn Any&gt;&gt;&gt;,
}

impl Extensions {
    pub fn insert&lt;T: Send + Sync + 'static&gt;(&amp;self, value: T) {
        self.map.write().insert(TypeId::of::&lt;T&gt;(), Box::new(value));
    }

    pub fn get&lt;T: Send + Sync + Default + 'static&gt;(&amp;self) -&gt; MappedRwLockReadGuard&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        RwLockReadGuard::map(self.map.read(), |m| {
            m.get(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| b.downcast_ref())
                .unwrap()
        })
    }

    pub fn get_mut&lt;T: Send + Sync + Default + 'static&gt;(&amp;self) -&gt; MappedRwLockWriteGuard&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        RwLockWriteGuard::map(self.map.write(), |m| {
            m.get_mut(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| b.downcast_mut())
                .unwrap()
        })
    }

    fn ensure&lt;T: Default + Send + Sync + 'static&gt;(&amp;self) {
        if self.map.read().get(&amp;TypeId::of::&lt;T&gt;()).is_none() {
            self.insert(T::default());
        }
    }
}
</code></pre>
<p>æ³¨æ„ï¼šç”±äº Any å¹¶æ²¡æœ‰å®ç° Debugï¼Œæ‰€ä»¥æˆ‘ä»¬å¾ˆéš¾ä¸ºæˆ‘ä»¬çš„ map å®ç° Debug ç‰¹å¾ï¼Œä¸€äº›ç®€å•çš„æ”¹å˜å¹¶ä¸èƒ½è§£å†³ç›®å‰çš„é—®é¢˜ã€‚ä¸‹åŠéƒ¨åˆ†æˆ‘ä»¬å°†ä»‹ç»
<code>as-any</code> æ¨¡å¼</p>
<p>æˆ‘ä»¬é¢ä¸´çš„æŒ‘æˆ˜æ˜¯ï¼Œåœ¨ Rust é‡Œï¼Œä½ ä¸èƒ½ä½¿ç”¨ <code>Box&lt;Any + Debug&gt;</code>ï¼Œç„¶è€Œè¿˜æ˜¯æœ‰ä¸€äº›æ–¹æ³•è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="ä¸º-map-å®ç°-debug"><a class="header" href="#ä¸º-map-å®ç°-debug">ä¸º map å®ç° Debug</a></h2>
<h3 id="ç®€åŒ–é—®é¢˜"><a class="header" href="#ç®€åŒ–é—®é¢˜">ç®€åŒ–é—®é¢˜</a></h3>
<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¯¹ <code>Box&lt;dyn Any&gt;</code> åšä¸€ä¸ªåŒ…è£…ï¼Œå¹¶è®© Wrapper å®ç° Debugã€‚</p>
<pre><code class="language-rs">#[derive(Debug)]
struct AnyBox(Box&lt;dyn Any + Debug&gt;);
</code></pre>
<p>å¦‚æœä½ å°è¯•ç¼–è¯‘ï¼Œç¼–è¯‘å™¨åº”è¯¥ä¼šå¾ˆä¸é«˜å…´çš„æŠ›å‡ºé”™è¯¯ï¼š</p>
<pre><code class="language-rs">error[E0225]: only auto traits can be used as additional traits in a trait object
 --&gt; src/main.rs:9:29
  |
9 | struct AnyBox(Box&lt;dyn Any + Debug&gt;);
  |                       ---   ^^^^^ additional non-auto trait
  |                       |
  |                       first non-auto trait
  |
  = help: consider creating a new trait with all of these as supertraits and
    using that trait here instead: `trait NewTrait: Any + Debug {}`
</code></pre>
<h3 id="è¶…çº§ç‰¹å¾"><a class="header" href="#è¶…çº§ç‰¹å¾">è¶…çº§ç‰¹å¾</a></h3>
<p>å¹¸è¿çš„æ˜¯ï¼Œç¼–è¯‘å™¨å†æ¬¡ä¸ºæˆ‘ä»¬æŒ‡æ˜äº†è§£å†³ä¹‹é“ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªçˆ¶ç‰¹å¾ï¼Œå¹¶åˆ©ç”¨ç‰¹å¾çº¦æŸã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¸ºæ‰€æœ‰å®ç°äº† Any å’Œ Debug
çš„ç±»å‹å®ç°æˆ‘ä»¬çš„è¶…çº§ç‰¹å¾ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code class="language-rs">#[derive(Debug)]
struct AnyBox(Box&lt;dyn DebugAny&gt;);

trait DebugAny: Any + Debug {}

impl&lt;T: Any + Debug + 'static&gt; DebugAny for T {}
</code></pre>
<p>ä½ å¯ä»¥æƒ³è¿™æ ·æ„å»ºä¸€ä¸ª Boxï¼Œä½†æ˜¯çœŸæ­£ä¸èƒ½é€šè¿‡ç¼–è¯‘çš„æ˜¯å‘ä¸‹è½¬å‹</p>
<pre><code class="language-rs">fn main() {
    let any_box = AnyBox(Box::new(42i32));
    dbg!(any_box.0.downcast_ref::&lt;i32&gt;());
}
</code></pre>
<p>ç¼–è¯‘å™¨ä¼šå‘Šè¯‰æˆ‘ä»¬ï¼ŒAnyBox ä¸­çš„å€¼å¹¶æ²¡æœ‰ <code>downcast_ref</code> æ–¹æ³•</p>
<pre><code class="language-rs">error[E0599]: no method named `downcast_ref` found for struct
  `Box&lt;(dyn DebugAny + 'static)&gt;` in the current scope
  --&gt; src/main.rs:15:20
   |
15 |     dbg!(any_box.0.downcast_ref::&lt;i32&gt;());
   |                    ^^^^^^^^^^^^ method not found in `Box&lt;(dyn DebugAny + 'static)&gt;`
</code></pre>
<p>åŸå› æ˜¯ <code>Box&lt;dyn DebugAny&gt;</code> å¹¶ä¸æ˜¯ <code>Box&lt;dyn Any&gt;</code>ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½é‚£é‡Œå¾—åˆ° Any
ç‰¹å¾æ‹¥æœ‰çš„æ–¹æ³•ã€‚é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ€ç®€å•çš„æ–¹æ³•æ˜¯ <strong>&quot;as any&quot;</strong> æ¨¡å¼ï¼Œæˆ‘ä»¬åœ¨æˆ‘ä»¬çš„ DebugAny
ç‰¹å¾ä¸Šå®ç°ä¸€ä¸ªæ–¹æ³•ï¼Œå°†å…¶å‘ä¸Šè½¬æ¢ä¸ºä¸€ä¸ª Anyã€‚çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>
<pre><code class="language-rs">trait DebugAny: Any + Debug {
    fn as_any(&amp;self) -&gt; &amp;dyn Any;
    fn as_any_mut(&amp;mut self) -&gt; &amp;mut dyn Any;
}

impl&lt;T: Any + Debug + 'static&gt; DebugAny for T {
    fn as_any(&amp;self) -&gt; &amp;dyn Any { self }
    fn as_any_mut(&amp;mut self) -&gt; &amp;mut dyn Any { self }
}
</code></pre>
<p>ç°åœ¨è™½ç„¶æˆ‘ä»¬ä¾ç„¶ä¸èƒ½åœ¨ DebugAny ä¸Šè°ƒç”¨ <code>downcast_ref</code>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‹¿èµ°å®ƒçš„å€¼ï¼Œå¹¶è°ƒç”¨ <code>as_any</code> å¾—åˆ°ä¸€ä¸ª
<code>&amp;dyn Any</code>ï¼š</p>
<pre><code class="language-rs">fn main() {
    let any_box = AnyBox(Box::new(42i32));
    dbg!(any_box.0.as_any().downcast_ref::&lt;i32&gt;());
    dbg!(&amp;any_box);
}
</code></pre>
<p>ä½†æ˜¯å½“æˆ‘ä»¬è¿è¡Œåï¼Œå´å¾—åˆ°äº†ä¸€ä¸ª Noneã€‚å‘ç”Ÿä»€ä¹ˆäº‹äº†ï¼Ÿï¼Ÿï¼Ÿ</p>
<pre><code class="language-rs">[src/main.rs:23] any_box.0.as_any().downcast_ref::&lt;i32&gt;() = None
</code></pre>
<p>è¿™ä¸ªè°œé¢˜çš„ç­”æ¡ˆä¸æ–¹æ³•è§£æçš„å·¥ä½œæ–¹å¼å’Œç©ºç™½å®ç°æœ‰å…³ã€‚å½“æˆ‘ä»¬åœ¨ <code>Box&lt;dyn DebugAny&gt;</code> ä¸Šè°ƒç”¨ <code>as_any</code> æ—¶ï¼ŒBox
å¹¶æ²¡æœ‰å‘ç”Ÿè‡ªåŠ¨è§£å¼•ç”¨ï¼Œäº‹å®ä¸Šè°ƒç”¨çš„æ˜¯ <code>Box&lt;dyn DebugAny&gt;</code> çš„ as_anyï¼Œå› ä¸º Box ç°åœ¨ä¹Ÿå®ç°äº†æˆ‘ä»¬çš„
DebugAnyã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•ç©¿è¿‡è¿™ä¸ª Box å‘¢ï¼Ÿé€šè¿‡æ‰‹åŠ¨è§£å¼•ç”¨ã€‚</p>
<pre><code class="language-rs">fn main() {
    let any_box = AnyBox(Box::new(42i32));
    dbg!((*any_box.0).as_any().downcast_ref::&lt;i32&gt;());
    dbg!(&amp;any_box);
}
</code></pre>
<p>è¿™æ ·å°±æ˜¯æˆ‘ä»¬é¢„æœŸçš„å€¼äº†</p>
<pre><code class="language-rs">[src/main.rs:23] (*any_box.0).as_any().downcast_ref::&lt;i32&gt;() = Some(
    42,
)
[src/main.rs:24] &amp;any_box = AnyBox(
    42,
)
</code></pre>
<h2 id="å¯è°ƒè¯•çš„-extension-map"><a class="header" href="#å¯è°ƒè¯•çš„-extension-map">å¯è°ƒè¯•çš„ Extension Map</a></h2>
<p>æœ‰äº†ä¸Šé¢çš„ç»éªŒï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥æ‹¿å‡ºä¹‹å‰çš„éåŒæ­¥ mapï¼Œç¨åŠ æ”¹é€ å°±èƒ½ä¸ºå…¶å®ç° Debugã€‚</p>
<pre><code class="language-rs">use std::any::{Any, TypeId};
use std::cell::{Ref, RefCell, RefMut};
use std::collections::HashMap;
use std::fmt::Debug;

trait DebugAny: Any + Debug {
    fn as_any(&amp;self) -&gt; &amp;dyn Any;
    fn as_any_mut(&amp;mut self) -&gt; &amp;mut dyn Any;
}

impl&lt;T: Any + Debug + 'static&gt; DebugAny for T {
    fn as_any(&amp;self) -&gt; &amp;dyn Any { self }
    fn as_any_mut(&amp;mut self) -&gt; &amp;mut dyn Any { self }
}

#[derive(Default, Debug)]
pub struct Extensions {
    map: RefCell&lt;HashMap&lt;TypeId, Box&lt;dyn DebugAny&gt;&gt;&gt;,
}

impl Extensions {
    pub fn insert&lt;T: Debug + 'static&gt;(&amp;self, value: T) {
        self.map
            .borrow_mut()
            .insert(TypeId::of::&lt;T&gt;(), Box::new(value));
    }

    pub fn get&lt;T: Default + Debug + 'static&gt;(&amp;self) -&gt; Ref&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        Ref::map(self.map.borrow(), |m| {
            m.get(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| (**b).as_any().downcast_ref())
                .unwrap()
        })
    }

    pub fn get_mut&lt;T: Default + Debug + 'static&gt;(&amp;self) -&gt; RefMut&lt;'_, T&gt; {
        self.ensure::&lt;T&gt;();
        RefMut::map(self.map.borrow_mut(), |m| {
            m.get_mut(&amp;TypeId::of::&lt;T&gt;())
                .and_then(|b| (**b).as_any_mut().downcast_mut())
                .unwrap()
        })
    }

    fn ensure&lt;T: Default + Debug + 'static&gt;(&amp;self) {
        if self.map.borrow().get(&amp;TypeId::of::&lt;T&gt;()).is_none() {
            self.insert(T::default());
        }
    }
}
</code></pre>
<p>å‘ map é‡Œé¢æ·»åŠ ç‚¹ä¸œè¥¿ï¼Œæ‰“å°ä¸€ä¸‹ï¼š</p>
<pre><code class="language-rs">[src/main.rs:63] &amp;extensions = Extensions {
    map: RefCell {
        value: {
            TypeId {
                t: 13431306602944299956,
            }: 42,
        },
    },
}
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘åœ¨ map ä¸­æ”¾ç½®äº†ä¸€ä¸ª 32 ä½çš„æ•´æ•° 42ï¼Œå®ƒæ‰“å°å‡ºäº†ä½œä¸ºé”®çš„ TypeIdï¼Œå’Œä½œä¸ºå€¼çš„ 42ã€‚</p>
<h2 id="ä¿ç•™ç±»å‹åç§°"><a class="header" href="#ä¿ç•™ç±»å‹åç§°">ä¿ç•™ç±»å‹åç§°</a></h2>
<p>å¦‚æœä½ æƒ³ä¿ç•™åŸæ¥çš„ç±»å‹åç§°ï¼Œè€Œä¸ä»…ä»…æ˜¯ç±»å‹çš„ IDï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»å‹ä½œä¸º map çš„é”®ã€‚é€šè¿‡å¯¹ TypeId å’Œ TypeName
åšä¸€æ¬¡ç®€å•çš„åŒ…è£…å°±èƒ½è½»æ¾å®ç°ï¼š</p>
<pre><code class="language-rs">use std::any::{TypeId, type_name};
use std::hash::{Hash, Hasher};
use std::fmt::{self, Debug};

pub struct TypeKey(TypeId, &amp;'static str);

impl TypeKey {
    pub fn of&lt;T: 'static&gt;() -&gt; TypeKey {
        TypeKey(TypeId::of::&lt;T&gt;(), type_name::&lt;T&gt;())
    }
}

impl Hash for TypeKey {
    fn hash&lt;H: Hasher&gt;(&amp;self, state: &amp;mut H) {
        self.0.hash(state);
    }
}

impl PartialEq for TypeKey {
    fn eq(&amp;self, other: &amp;Self) -&gt; bool {
        self.0 == other.0
    }
}

impl Eq for TypeKey {}

impl Debug for TypeKey {
    fn fmt(&amp;self, f: &amp;mut fmt::Formatter&lt;'_&gt;) -&gt; fmt::Result {
        write!(f, &quot;{}&quot;, self.1)
    }
}
</code></pre>
<p>æ¥ç€ç”¨å®ƒæ›¿æ¢æ‰åŸæ¥çš„é”®ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼š</p>
<pre><code class="language-rs">[src/main.rs:90] &amp;extensions = Extensions {
    map: RefCell {
        value: {
            i32: 42,
            alloc::vec::Vec&lt;i32&gt;: [
                1,
                2,
                3,
            ],
        },
    },
}
</code></pre>
<p>æ³¨æ„ï¼Œæˆ‘åœ¨ map ä¸­é¢å¤–æ’å…¥äº†ä¸€ä¸ª <code>Vec&lt;i32&gt;</code>ï¼Œä»¥è·å¾—æ›´æ˜æ˜¾çš„è¾“å‡ºã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æŸ¥è¯¢å¼•æ“æ¨é€ä¸æ‹‰å–"><a class="header" href="#æŸ¥è¯¢å¼•æ“æ¨é€ä¸æ‹‰å–">æŸ¥è¯¢å¼•æ“ï¼šæ¨é€ä¸æ‹‰å–</a></h1>
<p><a href="http://justinjaffray.com/query-engines-push-vs.-pull/">Query Engines: Push vs. Pull</a></p>
<p>è€ƒè™‘ä»¥ä¸‹çš„ SQL è¯­å¥</p>
<pre><code class="language-sql">SELECT DISTINCT customer_first_name
FROM customer
WHERE customer_balance &gt; 0
</code></pre>
<p>æŸ¥è¯¢ä¼˜åŒ–å™¨é€šå¸¸å°†è¿™æ ·çš„ SQL æŸ¥è¯¢ç¼–è¯‘æˆä¸€ç³»åˆ—ç¦»æ•£è¿ç®—ç¬¦ï¼š
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204202254060.png" alt="" /></p>
<pre><code>Distinct
&lt;- Map(customer_first_name)
&lt;- Select(customer_balance &gt; 0)
&lt;- customer
</code></pre>
<p>åœ¨åŸºäº Pull çš„ç³»ç»Ÿä¸­ï¼Œæ¶ˆè´¹è€… <code>customers</code> é©±åŠ¨ç³»ç»Ÿã€‚æ¯ä¸ªè¿ç®—ç¬¦è¿ç®—åéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°è¡Œï¼šç”¨æˆ·å°†å‘æ ¹èŠ‚ç‚¹ï¼ˆDistinctï¼‰è¯·æ±‚ä¸€è¡Œï¼Œè¿™ä¸€è¡Œå›å‘
Map è¯¢é—®ä¸€è¡Œï¼Œæ¥ç€å‘ Select è¯¢é—®ä¸€è¡Œï¼Œä¾æ­¤ç±»æ¨ã€‚</p>
<p>åœ¨åŸºäº Push çš„ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€… <code>producers</code> é©±åŠ¨ç³»ç»Ÿã€‚æ¯ä¸ªè¿ç®—ç¬¦ï¼Œå½“ä»–æ¥æ”¶åˆ°æ•°æ®æ—¶ï¼Œå°±ä¼šå‘ŠçŸ¥ä¸‹æ¸¸çš„è¿ç®—ç¬¦ï¼Œ<code>customer</code>
ä½œä¸ºæŸ¥è¯¢åŸºè¡¨å›å‘Šè¯‰ Select è‡ªå·±çš„ä¿¡æ¯ï¼Œæ¥ç€æ˜¯ Mapã€Distinctã€‚</p>
<h3 id="pull-based-æŸ¥è¯¢å¼•æ“"><a class="header" href="#pull-based-æŸ¥è¯¢å¼•æ“">Pull-Based æŸ¥è¯¢å¼•æ“</a></h3>
<p>åŸºäºæ‹‰å–çš„æŸ¥è¯¢å¼•æ“ä¸€èˆ¬ä¹Ÿè¢«ç§°ä¸ºä½¿ç”¨ Volcano æˆ– Iterator æ¨¡å‹ã€‚è¿™æ˜¯æœ€å¤è€å’Œæœ€è‘—åçš„æŸ¥è¯¢æ‰§è¡Œæ¨¡å‹ï¼Œå¹¶ä»¥ 1994 å¹´æ ‡å‡†åŒ–å…¶çº¦å®šçš„è®ºæ–‡å‘½åã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªå…³ç³»ï¼Œæˆ‘ä»¬é€šè¿‡ Scan æŠŠå®ƒä¸“ä¸ºä¸€ä¸ªè¿­ä»£å™¨</p>
<pre><code class="language-js">let customer = [
  { id: 1, firstName: &quot;justin&quot;, balance: 10 },
  { id: 2, firstName: &quot;sissel&quot;, balance: 0 },
  { id: 3, firstName: &quot;justin&quot;, balance: -3 },
  { id: 4, firstName: &quot;smudge&quot;, balance: 2 },
  { id: 5, firstName: &quot;smudge&quot;, balance: 0 },
];

function* Scan(coll) {
  for (let x of coll) {
    yield x;
  }
}
</code></pre>
<p>æ¥ä¸‹æ¥ä¸ºä»–å®ç°ä¸€äº›æ“ä½œç¬¦</p>
<pre><code class="language-js">function* Select(p, iter) {
  for (let x of iter) {
    if (p(x)) {
      yield x;
    }
  }
}

function* Map(f, iter) {
  for (let x of iter) {
    yield f(x);
  }
}

function* Distinct(iter) {
  let seen = new Set();
  for (let x of iter) {
    if (!seen.has(x)) {
      yield x;
      seen.add(x);
    }
  }
}
</code></pre>
<p>ç¿»è¯‘æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥</p>
<pre><code class="language-sql">SELECT DISTINCT customer_first_name FROM customer WHERE customer_balance &gt; 0
</code></pre>
<pre><code class="language-js">Distinct(
    Map(
        (c) =&gt; c.firstName,
        Select((c) =&gt; c.balance &gt; 0, Scan(customer))
    )
),
</code></pre>
<h2 id="push-based-æŸ¥è¯¢å¼•æ“"><a class="header" href="#push-based-æŸ¥è¯¢å¼•æ“">Push-Based æŸ¥è¯¢å¼•æ“</a></h2>
<p>åŸºäºæ¨é€çš„æŸ¥è¯¢å¼•æ“ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸º Reactiveã€Observerã€Stream æˆ–å›è°ƒåœ°ç‹±æ¨¡å‹ï¼Œå¦‚æ‚¨æ‰€æ–™ï¼Œä¸æˆ‘ä»¬ä¹‹å‰çš„ç¤ºä¾‹ç±»ä¼¼ï¼Œä½†å®ƒé¢ è¦†äº†å®ƒã€‚è®©æˆ‘ä»¬ä»å®šä¹‰
Scan å¼€å§‹</p>
<pre><code class="language-js">let customer = [
  { id: 1, firstName: &quot;justin&quot;, balance: 10 },
  { id: 2, firstName: &quot;sissel&quot;, balance: 0 },
  { id: 3, firstName: &quot;justin&quot;, balance: -3 },
  { id: 4, firstName: &quot;smudge&quot;, balance: 2 },
  { id: 5, firstName: &quot;smudge&quot;, balance: 0 },
];

function Scan(relation, out) {
  for (r of relation) {
    out(r);
  }
}
</code></pre>
<p>æˆ‘ä»¬å°†â€œæ­¤è¿ç®—ç¬¦å‘Šè¯‰ä¸‹æ¸¸è¿ç®—ç¬¦â€æ„å»ºä¸ºå®ƒéœ€è¦è°ƒç”¨çš„é—­åŒ…ã€‚</p>
<p>å‰©ä¸‹çš„è¿ç®—ç¬¦ä¹Ÿæ˜¯å¦‚æ­¤</p>
<pre><code class="language-js">function Select(p, out) {
  return (x) =&gt; {
    if (p(x)) out(x);
  };
}

function Map(f, out) {
  return (x) =&gt; {
    out(f(x));
  };
}

function Distinct(out) {
  let seen = new Set();
  return (x) =&gt; {
    if (!seen.has(x)) {
      seen.add(x);
      out(x);
    }
  };
}
</code></pre>
<p>æŸ¥è¯¢è¯­å¥å»ºæ¨¡ï¼š</p>
<pre><code class="language-js">let result = [];
Scan(
  customer,
  Select(
    (c) =&gt; c.balance &gt; 0,
    Map(
      (c) =&gt; c.firstName,
      Distinct((r) =&gt; result.push(r)),
    ),
  ),
);
</code></pre>
<h2 id="åŒºåˆ«"><a class="header" href="#åŒºåˆ«">åŒºåˆ«</a></h2>
<p>åœ¨åŸºäº Pull çš„ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰çš„æ“ä½œç¬¦éƒ½æ˜¯æƒ°æ€§çš„ï¼Œåªæœ‰å½“æ•°æ®éœ€è¦æ—¶ï¼Œæ“ä½œç¬¦æ‰ä¼šå¼€å§‹è®¡ç®—ï¼ˆyieldï¼‰ã€‚è¿™ä¹Ÿæ„å‘³ç€ç³»ç»Ÿçš„è¡Œä¸ºå’Œç”¨æˆ·çš„è¡Œä¸ºç´§å¯†è€¦åˆã€‚</p>
<p>å†åŸºäº Push çš„ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿå¼€å§‹å¤„äºç©ºé—²çŠ¶æ€ï¼Œç›´åˆ°ä»–æ¥å—åˆ°ä¸€è¡Œæ•°æ®ã€‚å› æ­¤ç³»ç»Ÿçš„å·¥ä½œå’Œæ¶ˆè´¹è€…æ˜¯è§£è€¦çš„ã€‚</p>
<p>åŸºäº Push çš„ç³»ç»Ÿè¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœæ”¾åˆ°é‡Œé¢ã€‚è¿™å°±æ˜¯åŸºäº Push çš„ç³»ç»Ÿç»™äººçš„æ„Ÿè§‰ã€‚å®ƒä¼šå‡è®¾æ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œå½“è¢«è¯·æ±‚æ—¶ï¼Œèƒ½å¤Ÿç«‹å³ä½œå‡ºå“åº”ã€‚</p>
<h2 id="dag-yo"><a class="header" href="#dag-yo">DAG, yo</a></h2>
<p>SQL ä¸­æœ‰ä¸€ä¸ª With ç»“æ„ï¼Œå®ƒå…è®¸åœ¨æŸ¥è¯¢ä¸­å¤šæ¬¡å¼•ç”¨åŒä¸€ä¸ªç»“æœé›†ï¼š</p>
<pre><code class="language-sql">WITH foo as (&lt;some complex query&gt;)
SELECT * FROM
    (SELECT * FROM foo WHERE c) AS foo1
  JOIN
    foo AS foo2
  ON foo1.a = foo2.b
</code></pre>
<p>åŸºäº Push çš„ç³»ç»Ÿèƒ½å¤Ÿä¼˜åŒ–æŸ¥è¯¢ç»“æ„ï¼Œå¤ç”¨ç»“æœé›†ï¼Œè€ŒåŸºäº Pull çš„ç³»ç»Ÿæ— æ³•åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://www.youtube.com/watch?v=rDoqT-a6UFg</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://hirust.cn">RustCn</a> è£èª‰æ¨å‡º</p>
</blockquote>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205051415470.png?raw=true"  />
<h1 id="å¯è§†åŒ–-rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€"><a class="header" href="#å¯è§†åŒ–-rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€">å¯è§†åŒ– Rust å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€</a></h1>
<blockquote>
<p>æœ¬æ–‡å·²è·å¾—ä½œè€…ç¿»è¯‘è®¸å¯ã€‚ç”±äºè¯‘è€…ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œå¦‚æœ‰ç¿»è¯‘é”™è¯¯ï¼Œå¸Œæœ›è¯»è€…åŠ ä»¥æŒ‡æ­£ã€‚
è§†é¢‘ç‰ˆç¿»è¯‘ï¼š<a href="https://www.bilibili.com/video/BV1KT4y167f1/">B ç«™è§†é¢‘é“¾æ¥</a></p>
</blockquote>
<pre><code class="language-rs">// file: main.rs
fn main() {
    println!(&quot;Hello World!&quot;);
}
</code></pre>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ Rust ä¸­ç¼–å†™ç¨‹åºæ—¶ï¼Œç”±äº Rust çš„ ç”Ÿå‘½å‘¨æœŸå’Œæ‰€æœ‰æƒæ¨¡å‹ï¼Œä½ æœ€å¥½ä¸ºç¨‹åºå¯èƒ½ç”¨åˆ°çš„æ•°æ®ç»“æ„åšä¸€äº›å‰æœŸè®¾è®¡ï¼Œä¸ç„¶ Rust
ç¼–è¯‘å™¨å¯èƒ½è®©ä½ ååˆ†ç—›è‹¦ã€‚äº†è§£æ¯ä¸ªæ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€æœ‰åŠ©äºé”»ç‚¼ä½ çš„ç›´è§‰ï¼Œå¯ä»¥æå‰è§„é¿ä¸€äº›ç¼–è¯‘é”™è¯¯å’Œæ€§èƒ½é—®é¢˜ã€‚</p>
<p>åœ¨è¿™ä¸ªæ–‡ç« é‡Œï¼Œæˆ‘ä»¬ä¼šè®¨è®º</p>
<ul>
<li>åœ¨è®¡ç®—æœºè¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</li>
<li>å¸¸è§æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€ (åŒ…æ‹¬ï¼šæ•´å½¢ï¼Œå…ƒç»„ï¼Œåˆ‡ç‰‡ï¼Œå‘é‡ï¼Œå­—ç¬¦ä¸²ï¼Œç»“æ„ä½“ï¼Œæšä¸¾ï¼Œæ™ºèƒ½æŒ‡é’ˆï¼Œç‰¹å¾å¯¹è±¡ï¼Œè¿˜æœ‰å„ç§ <code>Fn</code> ç‰¹å¾)</li>
</ul>
<h2 id="äºŒè¿›åˆ¶æ•°æ®æ®µ"><a class="header" href="#äºŒè¿›åˆ¶æ•°æ®æ®µ">äºŒè¿›åˆ¶æ•°æ®æ®µ</a></h2>
<p>å½“ä½ ç¼–å†™ä¸€ä¸ª Rust ç¨‹åºæ—¶ï¼Œè¦ä¹ˆç›´æ¥è°ƒç”¨ rustcï¼Œè¦ä¸å°±æ˜¯é€šè¿‡ cargo å»ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<pre><code class="language-shell">$ rustc main.rs
$ cargo build
</code></pre>
<p>è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ä»¥ä¸€ç§ç‰¹å®šçš„æ ¼å¼å­˜å‚¨æ•°æ®ã€‚å¯¹äº linux ç³»ç»Ÿï¼Œæœ€å¸¸è§çš„æ ¼å¼æ˜¯ <code>elf64</code> ã€‚ä¸åŒçš„æ“ä½œç³»ç»Ÿæ¯”å¦‚ linux, mac, windows
ä½¿ç”¨ä¸åŒçš„æ ¼å¼ã€‚è™½ç„¶äºŒè¿›åˆ¶æ–‡ä»¶çš„æ ¼å¼ä¸å°½ç›¸åŒï¼Œä½†æ˜¯å®ƒåœ¨å„ç§çš„æ“ä½œç³»ç»Ÿä¸­çš„è¿è¡Œæ–¹å¼å‡ ä¹ç›¸åŒã€‚</p>
<p>å¸¸è§çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸€èˆ¬ç”± <strong>æ–‡ä»¶å¤´ + åˆ†åŒº</strong> ç»„æˆã€‚å¯¹äº <code>elf</code> æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå®ƒçš„ç»“æ„å¤§è‡´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205031746097.png?raw=true"  height = "250"  />
<blockquote>
<p>æ®µçš„æ•°é‡æ ¹æ®ç¼–è¯‘å™¨è€Œä¸åŒã€‚è¿™é‡Œåªå±•ç¤ºäº†ä¸€äº›é‡è¦çš„ä¸€äº›æ®µã€‚</p>
</blockquote>
<p>å½“ä½ è¿è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶æ—¶</p>
<p>ä»¥ <code>elf64</code> æ ¼å¼çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå†…æ ¸ä¼šä¸ºç¨‹åºåˆ†é…ä¸€æ®µè¿ç»­çš„å†…å­˜åœ°å€ï¼Œå¹¶å°†è¿™äº›åˆ†åŒºæ˜ å°„åˆ°å†…å­˜ä¸­å»ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205031816710.png?raw=true"  height = "400" />
<p><strong>æ³¨æ„</strong>ï¼šè¿™é‡Œçš„å†…å­˜åœ°å€å¹¶ä¸æ˜¯å†…å­˜æ¡é‡Œå®é™…çš„å†…å­˜åœ°å€ã€‚ä½†æ˜¯å½“ç¨‹åºå¼€å§‹ä½¿ç”¨å†…å­˜æ—¶ï¼Œå†…æ ¸å’Œç¡¬ä»¶ä¼šæŠŠå®ƒä»¬æ˜ å°„åˆ°çœŸæ­£çš„ç‰©ç†å†…å­˜åœ°å€ã€‚è¿™è¢«ç§°ä¸º
<strong>è™šæ‹Ÿåœ°å€ç©ºé—´</strong>ã€‚ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºè¢«ç§°ä¸ºä¸€ä¸ªè¿›ç¨‹ã€‚ä»è¿›ç¨‹çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒåªèƒ½çœ‹åˆ°ä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œä» 0 åˆ°åœ°å€é«˜ä½çš„æœ€å¤§å€¼ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä¼šä»‹ç»è¿›ç¨‹åœ°å€ç©ºé—´ä¸­å„ä¸ªåŒºåŸŸçš„ä½œç”¨ï¼š</p>
<ol>
<li>
<p>ä»£ç æ®µ (text)</p>
<p>ä»£ç æ®µåŒ…å«äº†å¯æ‰§è¡ŒæŒ‡ä»¤çš„é›†åˆã€‚</p>
<p>ç¼–è¯‘å™¨èƒ½æŠŠæˆ‘ä»¬ç”¨é«˜çº§è¯­è¨€å†™çš„ç¨‹åºè½¬æ¢ä¸º CPU å¯ä»¥æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼Œä»£ç æ®µå°±åŒ…å«äº†è¿™äº›æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤æ ¹æ® CPU æ¶æ„è€Œæœ‰æ‰€ä¸åŒã€‚ç¼–è¯‘ç»™ x86-64
æ¶æ„ CPU è¿è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸èƒ½åœ¨ ARM æ¶æ„çš„ CPU ä¸Šè¿è¡Œã€‚</p>
<p>ä»£ç æ®µæ˜¯ <strong>åªè¯»</strong> çš„ï¼Œè¿è¡Œçš„ç¨‹åºä¸èƒ½æ›´æ”¹å®ƒã€‚</p>
</li>
<li>
<p>æ•°æ®æ®µ (data)</p>
<p>æ•°æ®æ®µåŒ…å« <strong>å·²ç»åˆå§‹åŒ–</strong> è¿‡çš„æ•°æ®ã€‚æ¯”å¦‚å…¨å±€å˜é‡ï¼Œå…¨å±€é™æ€å˜é‡ï¼Œå±€éƒ¨é™æ€å˜é‡ã€‚</p>
</li>
<li>
<p>BSS æ®µ (bss)</p>
<p>bss ä»£è¡¨ <code>Block started by symbol</code>, è¿™é‡Œä¿å­˜ç€ <strong>æœªè¢«åˆå§‹åŒ–</strong> è¿‡çš„å…¨å±€å˜é‡ã€‚ç”±äº bss
æ®µçš„å˜é‡æœªè¢«åˆå§‹åŒ–ï¼Œè¿™ä¸€æ®µå¹¶ä¸ä¼šç›´æ¥å æ®äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½“ç§¯ï¼Œå®ƒåªè´Ÿè´£è®°å½•æ•°æ®æ‰€éœ€ç©ºé—´çš„å¤§å°</p>
</li>
<li>
<p>åœ°å€é«˜ä½</p>
<p>å†…æ ¸ä¼šæŠŠä¸€äº›é¢å¤–çš„æ•°æ®ï¼Œæ¯”å¦‚ç¯å¢ƒå˜é‡ï¼Œä¼ é€’ç»™ç¨‹åºçš„å‚æ•°å’Œå‚æ•°çš„æ•°é‡æ˜ å°„åˆ°åœ°å€é«˜ä½ã€‚</p>
</li>
</ol>
<h2 id="å †--æ ˆ"><a class="header" href="#å †--æ ˆ">å † &amp; æ ˆ</a></h2>
<h3 id="å †æ ˆç®€ä»‹"><a class="header" href="#å †æ ˆç®€ä»‹">å †æ ˆç®€ä»‹</a></h3>
<p>å½“ç¨‹åºè¿è¡Œæ—¶ï¼ˆè¿è¡Œæ€ï¼‰ï¼Œè¿˜éœ€è¦éœ€è¦å¦å¤–ä¸¤ä¸ªåŸŸï¼šå †å’Œæ ˆ</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205031946093.png?raw=true"  height = "400" />
<p><strong>æ ˆ</strong>ï¼š</p>
<ul>
<li>
<p>æ“ä½œç³»ç»Ÿä½¿ç”¨æ ˆå­˜å‚¨ä¸€ä¸ªè¿›ç¨‹çš„æŠ½è±¡ç»†èŠ‚ï¼ŒåŒ…æ‹¬ (è¿›ç¨‹åå­—ï¼Œè¿›ç¨‹ ID ç­‰)ã€‚</p>
</li>
<li>
<p>ä¸€ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªæ‰§è¡Œçº¿ç¨‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æ ˆå†…å­˜ã€‚</p>
</li>
<li>
<p>åœ¨ 64 ä½çš„ linux ç³»ç»Ÿä¸Šï¼ŒRust ç¨‹åºä¸ºä¸»çº¿ç¨‹åˆ†é… 8MB çš„æ ˆå†…å­˜ã€‚å¯¹äºç”¨æˆ·åˆ›å»ºçš„å…¶ä»–çº¿ç¨‹ï¼Œrust æ ‡å‡†åº“æ”¯æŒè‡ªå®šä¹‰å¤§å°ï¼Œé»˜è®¤çš„å¤§å°æ˜¯
2MBã€‚</p>
</li>
<li>
<p>æ ˆå†…å­˜çš„ç©ºé—´ä¼šä»åœ°å€é«˜ä½å‘ä½ä½å¢é•¿ï¼Œä½†æ˜¯ä¸ä¼šè¶…è¿‡çº¿ç¨‹å¯ä»¥æ‹¥æœ‰çš„æœ€å¤§å€¼ã€‚å¯¹äºä¸»çº¿ç¨‹æ¥è¯´å°±æ˜¯ 8MBã€‚å¦‚æœå®ƒä½¿ç”¨çš„æ ˆå†…å­˜è¶…è¿‡äº†
8MBï¼Œç¨‹åºå°±ä¼šè¢«å†…æ ¸ç»ˆæ­¢ï¼Œå¹¶è¿”å›ä¸€ä¸ª <code>stackoverflow</code> é”™è¯¯ã€‚</p>
</li>
<li>
<p>æ ˆå†…å­˜è¢«ç”¨äºæ‰§è¡Œå‡½æ•° (è§ä¸‹æ–¹å¯¹æ ˆçš„å…·ä½“è®²è§£)ã€‚</p>
</li>
</ul>
<blockquote>
<p>è™½ç„¶ä¸»çº¿ç¨‹çš„æ ˆå†…å­˜å¤§å°æœ‰ 8MBï¼Œä½†æ˜¯è¿™ 8MB ä¹Ÿä¸ä¼šè¢«ç«‹å³åˆ†é…ï¼Œåªæœ‰å½“ç¨‹åºå¼€å§‹ä½¿ç”¨æ—¶ï¼Œå†…æ ¸æ‰ä¼šå¼€å§‹ä¸ºå®ƒåˆ†é…å†…å­˜ã€‚</p>
</blockquote>
<p><strong>å †</strong>ï¼š</p>
<ul>
<li>æ‰€æœ‰çº¿ç¨‹å…±äº«ä¸€å—å †å†…å­˜</li>
<li>å †å†…å­˜ä»åœ°å€ä½ä½å‘é«˜ä½å¢é•¿ã€‚</li>
</ul>
<p>æ“ä½œç³»ç»Ÿé€šå¸¸ä¼šæä¾›ä¸€äº›æ¥å£è®©æˆ‘ä»¬æ£€æŸ¥ç¨‹åºè¿è¡Œæ—¶çš„å†…å­˜æ˜ å°„çŠ¶æ€ï¼Œå¯¹äº linux ç³»ç»Ÿï¼Œä½ å¯ä»¥åœ¨ <em>/proc/PID/maps</em> æ–‡ä»¶ä¸­æŸ¥çœ‹</p>
<p>ä¸‹é¢å±•ç¤ºäº†ä¸€ä¸ªè¿›ç¨‹çš„æ˜ å°„çŠ¶æ€ï¼ˆéƒ¨åˆ†ï¼‰ï¼š</p>
<pre><code>$ cat /proc/844154/maps
55e6c3f44000-55e6c412c000 r-xp 00000000 103:03 22331679                  /usr/bin/fish
55e6c412c000-55e6c4133000 r--p 001e7000 103:03 22331679                  /usr/bin/fish
55e6c4133000-55e6c4134000 rw-p 001ee000 103:03 22331679                  /usr/bin/fish
55e6c4134000-55e6c4135000 rw-p 00000000 00:00 0
55e6c4faa000-55e6c5103000 rw-p 00000000 00:00 0                          [heap]
7fd62326d000-7fd62326f000 r--p 00034000 103:03 22285665                  /usr/lib/ld-linux-x86-64.so.2
7fd62326f000-7fd623271000 rw-p 00036000 103:03 22285665                  /usr/lib/ld-linux-x86-64.so.2
7ffecf8c5000-7ffecf8f5000 rw-p 00000000 00:00 0                          [stack]
</code></pre>
<p>ä½ å¯èƒ½ä¼šæƒ³é—®ï¼šå †å†…å­˜å’Œæ ˆå†…å­˜æ˜¯å¦ä¼šç›¸äº’è¦†ç›–ï¼Ÿå› ä¸ºä»–ä»¬ä¸¤ä¸ªå‘å¯¹æ–¹çš„æ–¹å‘å¢é•¿ã€‚</p>
<p>é€šè¿‡ç”¨ stack çš„ä½ä½å‡å» heap çš„é«˜ä½</p>
<pre><code class="language-py">&gt;&gt;&gt; (0x7ffecf8c5000 - 0x55e6c5103000) / (10 ** 12)
46.282743488512
</code></pre>
<p>å·®è·ä¸º 47TBï¼Œæ‰€ä»¥æ ˆå †å†²çªçš„æƒ…å†µå‡ ä¹ä¸å¯èƒ½å‡ºç°</p>
<p>å¦‚æœç¡®å®å‘ç”Ÿäº†ï¼Œå†…æ ¸ä¼šæä¾›å®ˆå«å»ç»ˆæ­¢ç¨‹åºã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„å†…å­˜æ˜¯æŒ‡è™šæ‹Ÿå†…å­˜ï¼Œå¹¶éç”µè„‘çš„çœŸå®å†…å­˜å¤§å°ã€‚</p>
<h3 id="cpu-å­—é•¿"><a class="header" href="#cpu-å­—é•¿">CPU å­—é•¿</a></h3>
<p>è™šæ‹Ÿå†…å­˜åœ°å€çš„èŒƒå›´ç”± CPU å­—é•¿ (word size) å†³å®šï¼Œå­—é•¿æ˜¯æŒ‡ CPU ä¸€æ¬¡å¯ä»¥å¹¶è¡Œå¤„ç†çš„äºŒè¿›åˆ¶ä½æ•°ï¼Œå¯¹äº 64 ä½çš„ CPU æ¥è¯´ï¼Œå®ƒçš„å­—é•¿ä¸º
64 ä½ (8 å­—èŠ‚)ã€‚CPU ä¸­å¤§å¤šæ•°æˆ–è€…å…¨éƒ¨å¯„å­˜å™¨ä¸€èˆ¬éƒ½æ˜¯ä¸€æ ·å¤§ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205031946032.png?raw=true" />
<p>å› æ­¤å¯ä»¥å¾—å‡ºï¼š64 ä½ CPU çš„å¯»å€ç©ºé—´ä¸º 0 ~ 2^64-1ã€‚è€Œå¯¹äº 32 ä½çš„ CPU æ¥è¯´ï¼Œå®ƒçš„å¯»å€ç©ºé—´åªæœ‰ä» 0 åˆ° 2^32ï¼Œå¤§æ¦‚ 4GBã€‚</p>
<p>ç›®å‰ï¼Œåœ¨ 64 ä½ CPU ä¸Šï¼Œæˆ‘ä»¬ä¸€èˆ¬åªä½¿ç”¨å‰ 48 ä½ç”¨äºå¯»å€ï¼Œå¤§å°å¤§æ¦‚æ˜¯ 282TB çš„å†…å­˜</p>
<pre><code>&gt;&gt;&gt; 2**48 / (10**12)
281.474976710656
</code></pre>
<p>è¿™å…¶ä¸­ï¼Œåªæœ‰å‰ 47 ä½æ˜¯åˆ†é…ç»™ç”¨æˆ·ç©ºé—´ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å¤§æ¦‚æœ‰ 141TB çš„è™šæ‹Ÿå†…å­˜ç©ºé—´æ˜¯ä¸ºæˆ‘ä»¬çš„ç¨‹åºåˆ†é…çš„ï¼Œå‰©ä¸‹çš„ä½äºåœ°å€é«˜ä½çš„ 141TB
æ˜¯ä¸ºä¿ç•™ç»™å†…æ ¸ä½¿ç”¨çš„ã€‚å¦‚æœä½ å»æŸ¥çœ‹ç¨‹åºçš„è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼Œä½ èƒ½ä½¿ç”¨çš„æœ€å¤§å†…å­˜åœ°å€åº”è¯¥æ˜¯ <code>0x7fffffffffff</code></p>
<pre><code>&gt;&gt;&gt; hex(2**47-1)
'0x7fffffffffff'
</code></pre>
<h3 id="æ ˆå†…å­˜"><a class="header" href="#æ ˆå†…å­˜">æ ˆå†…å­˜</a></h3>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·±å…¥äº†è§£æ ˆå†…å­˜çš„ç”¨é€”</p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ•´ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹åœ¨è¿è¡Œï¼Œæˆ‘ä»¬åœ¨ <code>main</code> é‡Œè°ƒç”¨äº† <code>add1</code> å‡½æ•°ã€‚</p>
<pre><code class="language-rs">fn main() {
    let a = 22;
    let b = add_one(a);
}

fn add_one(i: i32) -&gt; i32 {
    i + 1
}
</code></pre>
<p>æ ˆä¸»è¦ç”¨æ¥ä¿å­˜æ­£åœ¨è°ƒç”¨çš„å‡½æ•°çš„æ•°æ® (åŒ…æ‹¬å‡½æ•°å‚æ•°ï¼Œå‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œå’Œå®ƒçš„è¿”å›åœ°å€)ã€‚ä¸ºä¸€ä¸ªè¿è¡Œä¸­çš„å‡½æ•°åˆ†é…çš„æ€»å†…å­˜è¢«ç§°ä¸ºä¸€ä¸ª <strong>æ ˆå¸§</strong>ã€‚</p>
<ol>
<li>
<p><code>main</code> å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£ï¼Œé¦–å…ˆ <code>main</code> å‡½æ•°çš„æ ˆå¸§è¢«åˆ›å»ºã€‚</p>
<p><code>main</code> å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªä¸¤ä¸ª <code>i32</code> ç±»å‹çš„å±€éƒ¨å˜é‡ <code>a</code> å’Œ <code>b</code>ï¼Œå¤§å°éƒ½æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­ <code>a</code> çš„å€¼ä¸º 22ã€‚<code>main</code>
å‡½æ•°çš„æ ˆå¸§ä¼šç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´å»ä¿å­˜è¿™äº›å±€éƒ¨å˜é‡ã€‚</p>
<p>ESP å’Œ EBP å¯„å­˜å™¨å†…åˆ†åˆ«ä¿å­˜ç€æ ˆé¡¶æŒ‡é’ˆå’Œæ ˆåº•æŒ‡é’ˆï¼Œç”¨æ¥è¿½è¸ªå½“å‰çš„æ ˆçš„é¡¶éƒ¨å’Œåº•éƒ¨ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032036717.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
</li>
<li>
<p>å½“ <code>main</code> å‡½æ•°è°ƒç”¨ <code>add1</code> æ—¶ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§è¢«åˆ›å»ºç”¨æ¥ä¿å­˜ <code>add1</code> å‡½æ•°çš„æ•°æ®ã€‚æ ˆé¡¶æŒ‡é’ˆè¢«ä¿®æ”¹ä¸ºæ–°æ ˆçš„é¡¶éƒ¨ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032039168.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
<ol>
<li><code>add1</code> å‡½æ•°è¦æ¥å—ä¸€ä¸ª <code>i32</code> ç±»å‹çš„å‚æ•°ï¼Œå› æ­¤ 4 å­—èŠ‚çš„ç©ºé—´ä¼šè¢«ä¿ç•™åœ¨ <code>add1</code> å‡½æ•°çš„æ ˆå¸§ä¸Šã€‚</li>
<li><code>add1</code> å‡½æ•°å¹¶æ²¡æœ‰å±€éƒ¨å˜é‡</li>
<li>æ ˆå¸§è¿˜ä¼šä¿å­˜ä¸€ä¸ªè¿”å›åœ°å€ï¼Œå½“å‡½æ•°è¿è¡Œç»“æŸåï¼Œä¼šæ ¹æ®è¯¥è¿”å›åœ°å€å›åˆ°ä¹‹å‰çš„æŒ‡ä»¤ã€‚</li>
</ol>
</li>
<li>
<p>å‡½æ•°è°ƒç”¨ç»“æŸ</p>
<p>å½“å‡½æ•°è°ƒç”¨ç»“æŸåï¼Œå°±ä¼šæŠŠè¿”å›å€¼ 23 èµ‹å€¼ç»™å±€éƒ¨å˜é‡ <code>b</code>ã€‚åŒæ—¶æ ˆé¡¶æŒ‡é’ˆä¹Ÿè¢«ä¿®æ”¹ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032040616.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
<blockquote>
<p>æ³¨æ„ï¼šå‡½æ•°è¿è¡Œç»“æŸåï¼Œadd1
çš„æ ˆå¸§å¹¶æ²¡æœ‰è¢«é‡Šæ”¾ã€‚å½“ä½ çš„ç¨‹åºå¼€å§‹è°ƒç”¨ä¸‹ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œæ–°çš„æ ˆå¸§ä¼šç›´æ¥å°†å…¶è¦†ç›–ã€‚å¯¹äºæ ˆæ¥è¯´ï¼Œå¼€è¾Ÿå’Œé‡Šæ”¾å†…å­˜åªéœ€è¦ä¿®æ”¹æ ˆæŒ‡é’ˆå³å¯ã€‚</p>
</blockquote>
</li>
</ol>
<p>ç”±æ­¤å¯è§ï¼Œå› ä¸ºåœ¨æ ˆä¸Šå¼€è¾Ÿå’Œé‡Šæ”¾å†…å­˜åªéœ€è¦ç§»åŠ¨æŒ‡é’ˆï¼Œä¸éœ€è¦è¿›è¡Œä»»ä½•ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒçš„æ•ˆç‡æ˜¯å¾ˆé«˜çš„ã€‚</p>
<p>å½“ç„¶æ ˆä¹Ÿæœ‰ä¸€äº›é™åˆ¶ï¼š</p>
<ul>
<li>åªæœ‰åœ¨ç¼–è¯‘æ—¶å·²çŸ¥å¤§å°çš„å˜é‡æ‰èƒ½è¢«å­˜å‚¨åœ¨æ ˆä¸Šã€‚</li>
<li>å‡½æ•°ä¸èƒ½è¿”å›ä¸€ä¸ªä½äºå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡çš„å¼•ç”¨</li>
</ul>
<p>å¦‚æœä½ æŠŠ add_one æ”¹æˆä¸‹é¢çš„æ ·å­ï¼Œå°±ä¼šç¼–è¯‘å¤±è´¥ï¼š</p>
<pre><code class="language-rs">fn add_one(i: i32) -&gt; &amp;'static i32 {
    let result = i + 1;
    &amp;result
}
</code></pre>
<pre><code>error[E0515]: cannot return reference to local variable `result`
 --&gt; src/main.rs:8:5
  |
8 |     &amp;result
  |     ^^^^^^^ returns a reference to data owned by the current function
</code></pre>
<p>æ ¹æ®æˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡æ ˆçš„å·¥ä½œåŸç†ï¼Œå‡è®¾ä½ ç°åœ¨è¿”å›äº†ä¸€ä¸ªå‡½æ•°å†…å±€éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œä½†æ˜¯å½“å‡½æ•°è¿”å›æ—¶ï¼Œæœ¬è´¨ä¸Šå‡½æ•°çš„å†…å­˜å°±è¢«é‡Šæ”¾äº†ã€‚å½“ä¸‹ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒçš„æ ˆå¸§å°±ä¼šé‡å†™è¿™å—å†…å­˜ç©ºé—´ã€‚</p>
<p>åœ¨ä¸€ä¸ªå¸¦æœ‰ GC çš„è¯­è¨€é‡Œï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿæ£€æµ‹åˆ°è¿™ç§è¦†ç›–ï¼Œå¹¶åœ¨ä¼šä¸ºè¿™ä¸ªå˜é‡åœ¨å †ä¸Šåˆ†é…ä¸€å—ç©ºé—´ï¼Œå¹¶è¿”å›å®ƒçš„å¼•ç”¨ã€‚ä½†æ˜¯åœ¨å †ä¸Šåˆ†é…ä¼šå¸¦æ¥éƒ¨åˆ†é¢å¤–å¼€é”€ã€‚å› ä¸º Rust æ²¡æœ‰
GCï¼Œè€Œä¸”ä¸ä¼šå¼ºåˆ¶ä½ å»æ˜¾å¼çš„åˆ†é…å †å†…å­˜ï¼Œæ‰€ä»¥è¿™é‡Œä¼šç¼–è¯‘å¤±è´¥ã€‚</p>
<h3 id="å †å†…å­˜"><a class="header" href="#å †å†…å­˜">å †å†…å­˜</a></h3>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åœ¨ <code>main</code> å‡½æ•°ä¸­è°ƒç”¨äº† <code>heap</code> å‡½æ•°ã€‚</p>
<pre><code class="language-rs">fn main() {
    let result = heap();
}

fn heap() -&gt; Box&lt;i32&gt; {
    let b = Box::new(23);
    b
}
</code></pre>
<p>é¦–å…ˆä¼šä¸ºä¸¤ä¸ªå‡½æ•°å†æ ˆä¸Šåˆ›å»ºæ ˆå¸§ã€‚æ¥ç€ä½¿ç”¨ <code>box</code> å°† 23 åˆ†é…åœ¨å †ä¸Šã€‚ç„¶åæŠŠ 23 åœ¨å †ä¸Šçš„åœ°å€èµ‹å€¼ç»™äº†å˜é‡ <code>b</code>ã€‚<code>box</code>
åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ‰€ä»¥æ ˆä¸Šæœ‰è¶³å¤Ÿçš„ç©ºé—´å»ä¿å­˜ <code>box</code>ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032154186.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
<blockquote>
<p>åœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼ŒæŒ‡é’ˆçš„å¤§å°æ˜¯ 8 å­—èŠ‚ï¼Œæ‰€ä»¥åœ¨æ ˆä¸Šçš„å˜é‡ b çš„å¤§å°æ˜¯ 8 å­—èŠ‚ã€‚è€Œ b æŒ‡å‘çš„å˜é‡ 23 æ˜¯ <code>i32</code> ç±»å‹ï¼Œå®ƒåœ¨å †ä¸Šåªéœ€è¦å ç”¨ 4
å­—èŠ‚ã€‚</p>
</blockquote>
<p>å½“å‡½æ•°è°ƒç”¨ç»“æŸåï¼Œ<code>heap</code> å‡½æ•°è¿”å›çš„ <code>box</code> æŒ‡é’ˆå°±ä¼šè¢«ä¿å­˜åœ¨ main å‡½æ•°çš„å±€éƒ¨å˜é‡é‡Œã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032155624.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
<p>å½“ä½ å¯¹æ ˆä¸Šçš„æ•°æ®è¿›è¡Œèµ‹å€¼æ“ä½œæ—¶ï¼Œå®ƒçš„æ ˆå†…å­˜å°±ä¼šè¢«ç›´æ¥ <code>copy</code> è¿‡å»ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œç”¨æ¥ä¿å­˜ <code>box</code> çš„ 8 ä¸ªå­—èŠ‚å°±æ˜¯ä» <code>heap</code>
å‡½æ•°çš„æ ˆå¸§ç›´æ¥å¤åˆ¶åˆ° <code>main</code> çš„å±€éƒ¨å˜é‡ <code>result</code>ã€‚ç°åœ¨å³ä½¿ <code>heap</code> å‡½æ•°çš„æ ˆå¸§è¢«é‡Šæ”¾ï¼Œ<code>result</code>
å˜é‡ä¾ç„¶ä¿å­˜ç€æ•°æ®çš„åœ°å€ã€‚å †å…è®¸ä½ å…±äº«å˜é‡ã€‚</p>
<h3 id="å†…å­˜åˆ†é…å™¨"><a class="header" href="#å†…å­˜åˆ†é…å™¨">å†…å­˜åˆ†é…å™¨</a></h3>
<p>æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å„è‡ªçš„æ ˆå†…å­˜ï¼Œä»–ä»¬å…±äº«ä¸€å—å †å†…å­˜ã€‚</p>
<p>å‡è®¾ä½ çš„ç¨‹åºä¸æ–­åœ¨å †ä¸Šåˆ†é…æ–°çš„æ•°æ®ï¼Œç°åœ¨å †å†…å­˜å‡ ä¹è€—å°½äº†ï¼Œéœ€è¦å¯¹å †å†…å­˜è¿›è¡Œæ‰©å®¹ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205032243927.png?raw=true"  alt="å›¾ç‰‡åç§°"  />
<p>ç¨‹åºçš„å†…å­˜åˆ†é…å™¨ä¸€èˆ¬ä¼šä½¿ç”¨ç³»ç»Ÿè°ƒç”¨è¯·æ±‚æ“ä½œç³»ç»Ÿåˆ†é…æ›´å¤šå†…å­˜ã€‚å¯¹äº linux ç³»ç»Ÿæ¥è¯´ï¼Œä¸€èˆ¬æ˜¯ <code>brk</code> æˆ–è€… <code>sbrk</code> ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<p>åœ¨ Rust é‡Œï¼Œå †å†…å­˜åˆ†é…å™¨éœ€è¦å®ç° <code>GlobalAlloc</code> ç‰¹å¾ã€‚ä½ å‡ ä¹ä¸ä¼šç›´æ¥ç”¨åˆ°å®ƒï¼Œç¼–è¯‘å™¨ä¼šåœ¨éœ€è¦æ—¶æ’å…¥åˆé€‚çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p>
<pre><code class="language-rs">// /rust/library/std/src/sys/unix/alloc.rs
#[stable(feature = &quot;alloc_system_type&quot;, since = &quot;1.28.0&quot;)]
unsafe impl GlobalAlloc for System {
    #[inline]
    unsafe fn alloc(&amp;self, layout: Layout) -&gt; *mut u8 {
        if layout.align() &lt;= MIN_ALIGN &amp;&amp; layout.align() &lt;= layout.size() {
            libc::malloc(layout.size()) as *mut u8
        }
        ...
    }
    ...
}
</code></pre>
<p>ä½ å¯èƒ½å¾ˆç†Ÿæ‚‰ C è¯­è¨€é‡Œçš„ <code>malloc</code> å‡½æ•°ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œ<code>malloc</code> ä¾ç„¶ä¼šè°ƒç”¨ <code>brk</code> æˆ–è€… <code>sbrk</code> å»è¯·æ±‚å†…æ ¸ã€‚Rust
çš„å†…å­˜åˆ†é…å™¨ä¾é  C æ ‡å‡†åº“é‡Œæä¾›çš„ <code>malloc</code> å‡½æ•°ï¼Œå¦‚æœä½ ä½¿ç”¨åƒ <code>ldd</code> è¿™æ ·çš„å·¥å…·å»æ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–çš„åŠ¨æ€é“¾æ¥åº“ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ° <code>libc</code></p>
<pre><code class="language-shell">$ ldd target/debug/demo
    linux-vdso.so.1 (0x00007fff60bd8000)
    libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f08d0c21000)
    /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f08d0ebf000)
</code></pre>
<blockquote>
<p>Linux ä¸‹ Rust é»˜è®¤ä½¿ç”¨ GNU ä½œä¸ºé“¾æ¥å™¨ï¼Œå› æ­¤ Rust äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–äºæ“ä½œç³»ç»Ÿä¸Šçš„ C æ ‡å‡†åº“æˆ–è€… <code>libc</code> åº“ã€‚<code>libc</code>
æ›´åƒæ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä½¿ç”¨åƒ <code>libc</code> è¿™æ ·çš„åŠ¨æ€é“¾æ¥åº“æœ‰åŠ©äºå‡å°‘äºŒè¿›åˆ¶æ–‡ä»¶ä½“ç§¯ã€‚</p>
</blockquote>
<p>åŒæ—¶ï¼Œå†…å­˜åˆ†é…å™¨ä¹Ÿä¸æ€»æ˜¯ä¾èµ–äºç³»ç»Ÿè°ƒç”¨åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼š</p>
<ol>
<li>
<p>æ¯æ¬¡ç¨‹åºä½¿ç”¨ box ç­‰æŠŠæ•°æ®åˆ†é…åœ¨å †ä¸Šæ—¶ï¼Œç¨‹åºçš„å†…å­˜åˆ†é…å™¨éƒ½ä¼šæˆå—çš„è¯·æ±‚å†…å­˜å»å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ã€‚</p>
</li>
<li>
<p>å †å’Œæ ˆä¸ä¸€æ ·ï¼Œå†…å­˜ä¸ä¸€å®šæ€»æ˜¯åœ¨å †çš„æœ«å°¾è¢«é‡Šæ”¾ã€‚å½“ä¸€äº›åœ°æ–¹çš„å†…å­˜è¢«é‡Šæ”¾åï¼Œå®ƒå¹¶æ²¡æœ‰ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œå†…å­˜åˆ†é…å™¨ä¼šè¿½è¸ªå†…å­˜åˆ†é¡µï¼ŒçŸ¥é“é‚£äº›é¡µæ­£åœ¨ä½¿ç”¨ï¼Œé‚£äº›é¡µè¢«é‡Šæ”¾äº†ã€‚æ‰€ä»¥å½“éœ€è¦æ›´å¤šå †å†…å­˜æ—¶ï¼Œå®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å·²ç»é‡Šæ”¾ä½†è¿˜æœªå½’è¿˜çš„å†…å­˜åˆ†é¡µã€‚</p>
</li>
</ol>
<p>ç°åœ¨ä½ åº”è¯¥çŸ¥é“ä¸ºä»€ä¹ˆåˆ†é…å †å†…å­˜æ¯”æ ˆå†…å­˜æ›´æ¶ˆè€—æ€§èƒ½äº†ã€‚åˆ†é…å †å†…å­˜å¯èƒ½ä½¿ç”¨åˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œä¸”å†…å­˜åˆ†é…å™¨æ¯ä¸€æ¬¡åˆ†é…å†…å‰ï¼Œéƒ½å¿…é¡»ä»å †ä¸Šæ‰¾åˆ°ä¸€ä¸ªç©ºé—²å†…å­˜å—ã€‚</p>
<h2 id="rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€"><a class="header" href="#rust-å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€">Rust å„æ•°æ®ç±»å‹çš„å†…å­˜å¸ƒå±€</a></h2>
<h3 id="æ•´å½¢"><a class="header" href="#æ•´å½¢">æ•´å½¢</a></h3>
<table><thead><tr><th>é•¿åº¦ (byte)</th><th>é•¿åº¦ (bit)</th><th>æœ‰ç¬¦å·</th><th>æ— ç¬¦å·</th></tr></thead><tbody>
<tr><td>1 å­—èŠ‚</td><td>8 ä½</td><td>i8</td><td>u8</td></tr>
<tr><td>2 å­—èŠ‚</td><td>16 ä½</td><td>i16</td><td>u16</td></tr>
<tr><td>4 å­—èŠ‚</td><td>32 ä½</td><td>i32</td><td>u32</td></tr>
<tr><td>8 å­—èŠ‚</td><td>64 ä½</td><td>i64</td><td>u64</td></tr>
<tr><td>16 å­—èŠ‚</td><td>128 ä½</td><td>i128</td><td>u128</td></tr>
</tbody></table>
<p>æœ‰ç¬¦å·å’Œæ— ç¬¦å·æ•´å½¢çš„åå­—å·²ç»å±•ç¤ºäº†å®ƒæ‰€å çš„ä½æ•°ï¼Œæ¯”å¦‚ <code>i16</code> å’Œ <code>u16</code> åœ¨å†…å­˜éƒ½æ˜¯ 16 ä½ (2 å­—èŠ‚)ã€‚å®ƒä»¬éƒ½è¢«å®Œæ•´çš„åˆ†é…åœ¨å‡½æ•°çš„æ ˆå¸§ä¸Šã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041123992.png?raw=true" />
<p><code>isize</code> å’Œ <code>usize</code> çš„å¤§å°åˆ™å–å†³äºä½ çš„ç³»ç»Ÿï¼Œ32 ä½ç³»ç»Ÿå°±å ç”¨ 4 å­—èŠ‚ï¼Œ64 ä½ç³»ç»Ÿå°±å ç”¨ 8 å­—èŠ‚ã€‚</p>
<h3 id="å­—ç¬¦å‹"><a class="header" href="#å­—ç¬¦å‹">å­—ç¬¦å‹</a></h3>
<p><code>char</code> Rust çš„å­—ç¬¦ä¸ä»…ä»…æ˜¯ ASCIIï¼Œæ‰€æœ‰çš„ Unicode å€¼éƒ½å¯ä»¥ä½œä¸º Rust å­—ç¬¦ã€‚ä¾‹å¦‚
<code>a</code>ã€<code>\u{CA0}</code>ã€<code>*</code>ã€<code>å­—</code>ã€<code>\n</code>ã€<code>ğŸ¦€</code></p>
<p>char ç±»å‹é•¿åº¦æ˜¯ 4 å­—èŠ‚ï¼Œç›´æ¥åˆ†é…åœ¨æ ˆä¸Š</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041113512.png?raw=true"  />
<h3 id="å…ƒç»„"><a class="header" href="#å…ƒç»„">å…ƒç»„</a></h3>
<p>å…ƒç»„æ˜¯ä¸€äº›ç±»å‹çš„é›†åˆ</p>
<pre><code class="language-rs">let a: (char, u8, i32) = ('a', 7, 354);
</code></pre>
<p>æ¯”å¦‚è¿™é‡Œï¼Œå˜é‡ a åŒ…å«äº† char, u8, i32 ä¸‰ç§æ•°æ®ç±»å‹ï¼Œå®ƒçš„å†…å­˜å¸ƒå±€å°±æ˜¯å°†å„ä¸ªæˆå‘˜ä¾æ¬¡æ’åˆ—ã€‚</p>
<p>åœ¨è¿™é‡Œ char å ç”¨ 4 å­—èŠ‚ï¼Œu8 å ç”¨ 1 å­—èŠ‚ï¼Œi32 å ç”¨ 4 å­—èŠ‚ã€‚å› ä¸ºè¿™ä¸‰ç§ç±»å‹éƒ½æ˜¯åªåœ¨æ ˆä¸Šåˆ†é…çš„ï¼Œæ‰€ä»¥æ•´ä¸ªå…ƒç»„ä¹Ÿå…¨åœ¨æ ˆä¸Šåˆ†é…ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041124139.png?raw=true"  />
<p>è™½ç„¶çœ‹èµ·æ¥è¿™ä¸ªå…ƒç»„åªä¼šå ç”¨ 9 å­—èŠ‚çš„ç©ºé—´ï¼Œä½†æ˜¯å…¶å®å¹¶ä¸æ˜¯è¿™æ ·ï¼Œä½ å¯ä»¥ç”¨ <code>size_of</code> å»æŸ¥çœ‹è¿™ä¸ªå…ƒç»„å ç”¨çš„çœŸæ­£å­—èŠ‚æ•°</p>
<pre><code class="language-rs">std::mem::size_of::&lt;T&gt;()
</code></pre>
<h3 id="size_of-å’Œ-align_of"><a class="header" href="#size_of-å’Œ-align_of">size_of å’Œ align_of</a></h3>
<pre><code class="language-rs">use std::mem::{size_of, align_of};

size_of::&lt;(char, u8, i32)&gt;(); // 12 å­—èŠ‚

align_of::&lt;(char, u8, i32)&gt;(); // 4 å­—èŠ‚
</code></pre>
<p>æ‰€æœ‰çš„æ•°æ®ç±»å‹è¿˜æœ‰ä¸€ä¸ªå¯¹é½å±æ€§ï¼Œä½ å¯ä»¥é€šè¿‡ <code>align_of</code> æŸ¥çœ‹ã€‚</p>
<p>æ•°æ®ç±»å‹çš„å¤§å°å¿…é¡»æ˜¯å¯¹é½å±æ€§çš„æ•´æ•°å€ã€‚è¿™ä¸€ç‚¹ä¸ä»…ä»…æ˜¯ Rustï¼Œæ‰€æœ‰çš„ç¼–è¯‘å™¨éƒ½æ˜¯è¿™æ ·ã€‚æ•°æ®å¯¹é½å¯¹ CPU æ“ä½œåŠç¼“å­˜éƒ½æœ‰è¾ƒå¤§çš„å¥½å¤„ï¼Œæœ‰åŠ©äº CPU
æ›´å¿«çš„è¯»å–æ•°æ®ã€‚</p>
<p>å¯¹äºè¿™ä¸ªå…ƒç»„ï¼Œå®ƒçš„å¯¹é½å±æ€§å€¼æ˜¯ 4ï¼Œå› æ­¤å®ƒå ç”¨çš„å­—èŠ‚æ•°æ˜¯ 12ã€‚å‰©ä¸‹çš„ 3 å­—èŠ‚ä¼šè¢«ç¼–è¯‘å™¨å¡«å……ç©ºç™½æ•°æ®</p>
<h3 id="å¼•ç”¨"><a class="header" href="#å¼•ç”¨">å¼•ç”¨</a></h3>
<p>æ¥ä¸‹æ¥æ˜¯å¼•ç”¨ç±»å‹ <code>&amp;T</code></p>
<pre><code class="language-rs">let a: i32 = 25;

let b: &amp;i32 = &amp;a;
</code></pre>
<p><code>a</code> æ˜¯ i32 ç±»å‹ï¼Œ<code>b</code> æ˜¯å¯¹ <code>a</code> çš„å¼•ç”¨ã€‚</p>
<blockquote>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä¸ä¼šåœ¨è¯¦ç»†å±•ç¤ºæ¯ä¸ªæ•°æ®çš„å­—èŠ‚å¤§å°ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å»å…³æ³¨æ•´ä½“ï¼Œå…³æ³¨ä»–ä»¬æ˜¯å­˜å‚¨åœ¨å †ä¸Šè¿˜æ˜¯æ ˆä¸Šã€‚</p>
</blockquote>
<p>åœ¨è¿™é‡Œï¼Œ<code>a</code> å­˜å‚¨åœ¨æ ˆä¸Šï¼Œå®ƒå æ® 4 ä¸ªå­—èŠ‚ã€‚<code>b</code> ä¹Ÿå­˜å‚¨åœ¨æ ˆä¸Šï¼Œé‡Œé¢ä¿å­˜äº†å˜é‡ <code>a</code> çš„åœ°å€ã€‚å¼•ç”¨ç±»å‹çš„å¤§å°å–å†³äºä½ çš„æœºå™¨ä½æ•°ï¼Œæ‰€ä»¥ 64 ä½ç³»ç»Ÿä¸Šå®ƒå 
8 å­—èŠ‚ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041147802.png?raw=true"  />
<p>å¦‚æœæˆ‘ä»¬å†ç”¨ <code>c</code> ä¿å­˜ <code>b</code> çš„å¼•ç”¨ï¼Œc çš„ç±»å‹å°±æ˜¯ <code>&amp;&amp;i32</code></p>
<pre><code class="language-rs">let c: &amp;&amp;i32 = &amp;b;
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041147049.png?raw=true"  />
<p>å¼•ç”¨ä¹Ÿèƒ½æŒ‡å‘å †ä¸Šçš„æ•°æ®ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041147762.png?raw=true"  />
<p>å¯å˜å¼•ç”¨ä¹Ÿæœ‰ç›¸åŒçš„å†…å­˜å¸ƒå±€ã€‚</p>
<p>å¯å˜å¼•ç”¨å’Œä¸å¯å˜å¼•ç”¨çš„åŒºåˆ«æ˜¯ä»–ä»¬çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠç¼–è¯‘å™¨ä¸ºå¯å˜å¼•ç”¨æ·»åŠ çš„é¢å¤–é™åˆ¶ã€‚</p>
<h3 id="æ•°ç»„"><a class="header" href="#æ•°ç»„">æ•°ç»„</a></h3>
<pre><code class="language-rs">let a: [i32; 3] = [55, 66, 77];
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041201858.png?raw=true"  />
<p>ä¸€ä¸ªæ•°ç»„çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œè€Œä¸”å®ƒçš„å¤§å°æ˜¯æ•°æ®ç±»å‹çš„ä¸€éƒ¨åˆ†ã€‚æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¼šåœ¨æ ˆä¸Šç›¸é‚»æ’æ”¾ã€‚ä½†æ˜¯å½“æ•°ç»„åˆ›å»ºåï¼Œå®ƒçš„å¤§å°å°±ä¸èƒ½å†æ”¹å˜ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šåªæœ‰å¤§å°å›ºå®šè€Œä¸”åœ¨ç¼–è¯‘æ—¶å·²çŸ¥çš„æ•°æ®ç±»å‹æ‰èƒ½å­˜å‚¨åœ¨æ ˆä¸Šã€‚</p>
</blockquote>
<h3 id="vec"><a class="header" href="#vec">Vec</a></h3>
<p>Vec ç±»å‹æ˜¯å¯æ‰©å®¹çš„ï¼Œå®ƒçš„å¤§å°èƒ½å¤Ÿæ”¹å˜ï¼Œä½ å¯ä»¥ç”¨å®ƒä»£æ›¿æ•°ç»„ã€‚</p>
<pre><code class="language-rs">let v: Vec&lt;i32&gt; = vec![55, 66, 77];
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041443929.png?raw=true"  />
<p>è¿™é‡Œæˆ‘ä»¬çš„å˜é‡ <code>v</code> å­˜å‚¨äº†å’Œæ•°ç»„ç›¸åŒçš„æ•°æ®ï¼Œä½†æ˜¯å®ƒæ˜¯åœ¨å †ä¸Šåˆ†é…çš„ã€‚</p>
<p>å˜é‡ <code>v</code> åœ¨æ ˆä¸Šå ç”¨çš„å¤§å°æ˜¯å›ºå®šçš„ï¼ŒåŒ…å« 3 ä¸ª <code>usize</code>ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ•°æ®åœ¨å †ä¸Šçš„åœ°å€ï¼Œ</li>
<li>å‰©ä¸‹çš„ä¸¤ä¸ªè¡¨ç¤º Vec çš„å®¹é‡å’Œé•¿åº¦ã€‚</li>
</ul>
<p>å®¹é‡è¡¨ç¤º Vec çš„æœ€å¤§ç©ºé—´ã€‚å½“æˆ‘ä»¬å‘ Vec ä¸­æ·»åŠ æ›´å¤šæ•°æ®æ—¶ï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°è¿˜æ²¡æœ‰è¾¾åˆ°å®¹é‡å¤§å°ï¼ŒRust å°±ä¸å¿…ä¸ºå †å†…å­˜åˆ†é…æ›´å¤šç©ºé—´ã€‚</p>
<p>å¦‚æœé•¿åº¦å’Œå®¹é‡å·²ç»ç›¸ç­‰äº†ï¼Œæˆ‘ä»¬è¿˜è¦å‘ Vec æ·»åŠ æ›´å¤šæ•°æ®ï¼ŒRust å°±ä¼šåœ¨å †ä¸­é‡æ–°åˆ†é…å‡ºä¸€å—æ›´å¤§çš„å†…å­˜ï¼Œå°†åŸæ•°æ®å¤åˆ¶åˆ°æ–°çš„å†…å­˜åŒºåŸŸï¼Œå¹¶æ›´æ–°æ ˆä¸­çš„æŒ‡é’ˆã€‚</p>
<h3 id="åˆ‡ç‰‡"><a class="header" href="#åˆ‡ç‰‡">åˆ‡ç‰‡</a></h3>
<pre><code class="language-rs">let s1: [i32] = a[0..2];

let s2: [i32] = v[0..2];
</code></pre>
<p>åˆ‡ç‰‡ <code>[T]</code> å’Œæ•°ç»„éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯ä¸ç”¨æŒ‡å®šå¤§å°ã€‚åˆ‡ç‰‡å°±åƒæ˜¯åº•å±‚æ•°ç»„çš„ä¸€ä¸ªè§†å›¾ï¼Œs1 è¡¨ç¤ºæ•°ç»„ a çš„å‰ä¸¤ä¸ªå…ƒç´ ï¼Œs2 è¡¨ç¤ºå‘é‡çš„å‰ä¸¤ä¸ªå…ƒç´ ã€‚</p>
<p>ç”±äºåˆ‡ç‰‡æ²¡æœ‰æŒ‡å®šå…ƒç´ æ•°é‡ï¼Œç¼–è¯‘æ—¶ Rust
ç¼–è¯‘å™¨ä¸çŸ¥é“å®ƒå…·ä½“å äº†å¤šå°‘å­—èŠ‚ã€‚åŒæ—¶ï¼Œä½ ä¹Ÿä¸èƒ½å°†åˆ‡ç‰‡å­˜åœ¨å˜é‡ä¸­ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å·²çŸ¥å¤§å°ï¼Œæ‰€ä»¥ä¸èƒ½è¢«åˆ†é…åœ¨æ ˆä¸Šï¼Œè¿™æ ·çš„ç±»å‹è¢«ç§°ä¸º <strong>DST åŠ¨æ€å¤§å°ç±»å‹</strong> ã€‚</p>
<blockquote>
<p>è¿˜æœ‰å…¶ä»–çš„ DST ç±»å‹ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²åˆ‡ç‰‡å’Œç‰¹å¾å¯¹è±¡ã€‚</p>
</blockquote>
<p>å¦‚æœä½ å°è¯•è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œåº”è¯¥ä¼šç¼–è¯‘å¤±è´¥ï¼š</p>
<pre><code class="language-rs">error[E0277]: the size for values of type `[i32]` cannot be known at compilation time
 --&gt; examples/vec.rs:8:9
  |
8 |     let s1: [i32] = a[0..2];
  |         ^^ doesn't have a size known at compile-time
  |
help: consider borrowing here
  |
8 |     let s1: [i32] = &amp;a[0..2];
  |                     +
</code></pre>
<p>å› æ­¤ï¼Œå‡ ä¹åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªä¼šä½¿ç”¨åˆ°åˆ‡ç‰‡çš„å¼•ç”¨ <strong><code>&amp;[T]</code></strong>ã€‚è¢«å¼•ç”¨çš„æ•°æ®æ—¢èƒ½åœ¨æ ˆä¸Šï¼Œä¹Ÿèƒ½åœ¨å †ä¸Šï¼š</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042149818.png?raw=true"  />
<p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œå¼•ç”¨åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒå æ®ä¸€ä¸ª <code>usize</code> å»å­˜å‚¨å®ƒæ‰€æŒ‡å‘çš„æ•°æ®çš„åœ°å€ã€‚</p>
<p>ä½†æ˜¯å½“ä½ ç”¨æŒ‡é’ˆå»æŒ‡å‘ä¸€ä¸ªåŠ¨æ€å¤§å°ç±»å‹æ—¶ (æ¯”å¦‚åˆ‡ç‰‡)ï¼ŒRust ä¼šä½¿ç”¨ä¸€ä¸ªé¢å¤–çš„ <code>usize</code> å»å­˜å‚¨æ•°æ®çš„é•¿åº¦ã€‚è¿™ç§å¼•ç”¨ä¹Ÿå«åš <strong>èƒ–æŒ‡é’ˆ</strong>
(å°†ä¸€äº›é™„åŠ ä¿¡æ¯å’ŒæŒ‡é’ˆä¸€èµ·å­˜å‚¨)ã€‚</p>
<p>åˆ‡ç‰‡å¼•ç”¨å¯ä»¥ç”¨ä¸¤ä¸ª <code>usize</code> è¡¨ç¤ºï¼Œæ‰€ä»¥å®ƒå¯ä»¥å­˜åœ¨æ ˆä¸Šã€‚</p>
<h3 id="å­—ç¬¦ä¸²"><a class="header" href="#å­—ç¬¦ä¸²">å­—ç¬¦ä¸²</a></h3>
<p>ä¸å­—ç¬¦ä¸²ç›¸å…³çš„æœ‰ä¸‰ç§ç±»å‹ï¼š<code>String</code>, <code>str</code>, <code>&amp;str</code>ï¼Œä»–ä»¬åˆ†åˆ«å¯¹åº” <code>Vec</code>, <code>[T]</code>ï¼Œ <code>&amp;[T}</code></p>
<p>å­—ç¬¦ä¸²ç±»å‹ <code>String</code> çš„å†…å­˜å¸ƒå±€å’Œå‘é‡ç›¸åŒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼Œå­—ç¬¦ä¸²ç±»å‹å¿…é¡»æ˜¯ UTF-8 ç¼–ç ã€‚</p>
<p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rs">let s1: String = String::from(&quot;hello&quot;);
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041444837.png?raw=true"  />
<p>ä½†æ˜¯ï¼Œå¦‚æœä½ æŠŠä¸€ä¸ªå­—ç¬¦ä¸²ç›´æ¥ä¿å­˜åœ¨å˜é‡ä¸­ï¼š</p>
<pre><code class="language-rs">let s2: &amp;str = &quot;hello&quot;;
</code></pre>
<p><code>s2</code> çš„ç±»å‹å°±ä¼šå˜æˆå­—ç¬¦ä¸²åˆ‡ç‰‡çš„å¼•ç”¨ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²çš„æ•°æ®ä¸ä¼šåœ¨å †ä¸Šï¼Œè€Œæ˜¯ç›´æ¥å­˜å‚¨åœ¨ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚è¿™ç§å­—ç¬¦ä¸²æœ‰ <code>'static</code>
çš„ç”Ÿå‘½å‘¨æœŸï¼Œå®ƒæ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ï¼Œåœ¨ç¨‹åºè¿è¡Œæ—¶éƒ½æ˜¯å¯ç”¨çš„ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041445745.png?raw=true"  />
<blockquote>
<p>æ®æˆ‘æ‰€çŸ¥ï¼ŒRust ä¸ä¼šæŒ‡å®šå­—ç¬¦ä¸²è¢«ä¿å­˜åœ¨æ–‡ä»¶çš„é‚£ä¸ªéƒ¨åˆ†ï¼Œä½†æ˜¯å¾ˆå¯èƒ½å°±åœ¨ä»£ç æ®µ (text segment)</p>
</blockquote>
<p>å’Œåˆ‡ç‰‡å¼•ç”¨ä¸€æ ·ï¼Œå¯¹å­—ç¬¦ä¸²çš„åˆ‡ç‰‡çš„å¼•ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼ŒåŒ…å«ä¸¤ä¸ª <code>usize</code>ï¼Œä¸€ä¸ªç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²çš„å†…å­˜èµ·å§‹åœ°å€ï¼Œå¦ä¸€ä¸ªå­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ã€‚</p>
<p>ä½ ä¸èƒ½ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²åˆ‡ç‰‡ <code>str</code>:</p>
<pre><code class="language-rs">// error: size can not be known at compile time
let s: str = s1[1..3];
</code></pre>
<p>å¯¹å­—ç¬¦ä¸²çš„åˆ‡ç‰‡å¼•ç”¨æ˜¯å¯è¡Œçš„ï¼š</p>
<pre><code class="language-rs">let s: &amp;str = &amp;s1[1..3];
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042150544.png?raw=true"  />
<h3 id="ç»“æ„ä½“"><a class="header" href="#ç»“æ„ä½“">ç»“æ„ä½“</a></h3>
<p>Rust æœ‰ä¸‰ç§ç»“æ„ä½“ç±»å‹ï¼šç»“æ„ä½“ï¼Œå…ƒç»„ç»“æ„ä½“ (Tuple Struct) å’Œå•å…ƒç»“æ„ä½“ (Unit-like Struct)ã€‚</p>
<p>æ™®é€šç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">struct Data {
    nums: Vec&lt;usize&gt;,
    dimension: (usize, usize),
}
</code></pre>
<p>å…ƒç»„ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">struct Data(Vec&lt;usize&gt;);
</code></pre>
<p>å•å…ƒç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">struct Data;
</code></pre>
<p>å•å…ƒç»“æ„ä½“ä¸ä¿å­˜ä»»ä½•æ•°æ®ï¼Œæ‰€ä»¥ Rust ç¼–è¯‘å™¨ç”šè‡³ä¸ä¼šä¸ºä»–åˆ†é…å†…å­˜ã€‚</p>
<p>å¦å¤–ä¸¤ç§ç»“æ„ä½“çš„å†…å­˜æ’å¸ƒéå¸¸ç±»ä¼¼äºä¹‹å‰æ‰€è¯´çš„å…ƒç»„ï¼Œæˆ‘ä»¬ä»¥æ™®é€šçš„ç»“æ„ä½“ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rs">struct Data {
    nums: Vec&lt;usize&gt;,
    dimension: (usize, usize),
}
</code></pre>
<p>å®ƒæœ‰ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ª Vec å’Œä¸€ä¸ªå…ƒç»„ï¼Œç»“æ„ä½“çš„å„ä¸ªæˆå‘˜ä¼šåœ¨æ ˆä¸Šä¾æ¬¡ç›¸é‚»æ’åˆ—ã€‚</p>
<ul>
<li>Vec éœ€è¦å ç”¨ 3 ä¸ª <code>usize</code>ï¼Œnums çš„æˆå‘˜ä¼šè¢«åˆ†é…åœ¨å †ä¸Šã€‚</li>
<li>å…ƒç»„éœ€è¦å ç”¨ 2 ä¸ª <code>usize</code>ã€‚</li>
</ul>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041441096.png?raw=true"  />
<blockquote>
<p>æ³¨æ„ï¼šæˆ‘ä»¬åœ¨è¿™é‡Œå¿½è§†äº†å†…å­˜å¯¹é½å’Œç¼–è¯‘å™¨å¡«å……çš„ paddingã€‚</p>
</blockquote>
<h3 id="æšä¸¾"><a class="header" href="#æšä¸¾">æšä¸¾</a></h3>
<p>åƒç»“æ„ä½“ä¸€æ ·ï¼ŒRust æ”¯æŒç”¨ä¸åŒçš„è¯­æ³•è¡¨ç¤ºæšä¸¾ã€‚</p>
<p>ä¸‹é¢å±•ç¤ºçš„æ˜¯ä¸€ä¸ª C é£æ ¼çš„æšä¸¾ï¼Œåœ¨å†…å­˜ä¸­ä»–ä»¬è¢«ä¿å­˜ä¸ºä»é›¶å¼€å§‹çš„æ•´æ•°ï¼ŒRust ç¼–è¯‘å™¨ä¼šè‡ªåŠ¨é€‰æ‹©æœ€çŸ­çš„æ•´æ•°ç±»å‹ã€‚</p>
<pre><code class="language-rs">enum HTTPStatus {
    Ok,
    NotFound,
}
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041451028.png?raw=true"  />
<p>åœ¨è¿™é‡Œæœ€å¤§å€¼ä¸º 1ï¼Œå› æ­¤è¯¥æšä¸¾å¯ä»¥ä½¿ç”¨ 1 å­—èŠ‚å­˜å‚¨ã€‚</p>
<p>ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¸ºæšä¸¾çš„æ¯ä¸ªå˜ä½“æŒ‡å®šå®ƒçš„å€¼ï¼š</p>
<pre><code class="language-rs">enum HTTPStatus {
    Ok = 200,
    NotFound = 404,
}
</code></pre>
<p>è¿™ä¸ªä¾‹å­é‡Œæœ€å¤§çš„æ•°æ˜¯ 404ï¼Œéœ€è¦è‡³å°‘ 2 å­—èŠ‚å­˜å‚¨ã€‚æ‰€ä»¥è¿™ä¸ªæšä¸¾çš„æ¯ç§å˜ä½“éƒ½éœ€è¦ 2 å­—èŠ‚ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041452340.png?raw=true"  />
<p>æšä¸¾å€¼ä¹Ÿå¯ä»¥é€‰æ‹©å…·ä½“çš„ç±»å‹</p>
<pre><code class="language-rs">enum Data {
    Empty,
    Number(i32),
    Array(Vec&lt;i32&gt;)
}
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­</p>
<ul>
<li><code>Empty</code> å˜ä½“ä¸å­˜å‚¨ä»»ä½•æ•°æ®</li>
<li><code>Number</code> å†…éƒ¨æœ‰ä¸€ä¸ª <code>i32</code></li>
<li><code>Array</code> é‡Œé¢æœ‰ä¸ª <code>Vec</code></li>
</ul>
<p>å®ƒä»¬çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041511443.png?raw=true"  />
<p>é¦–å…ˆæˆ‘ä»¬çœ‹ <code>Array</code> å˜ä½“ï¼š</p>
<p>é¦–å…ˆæ˜¯ä¸€ä¸ªæ•´æ•°æ ‡è®° 2 å ç”¨ 1 å­—èŠ‚ï¼Œæ¥ç€å°±æ˜¯ <code>Vec</code> æ‰€éœ€çš„ä¸‰ä¸ª <code>usize</code> ï¼Œç¼–è¯‘å™¨è¿˜ä¼šå¡«å……ä¸€äº›ç©ºç™½åŒºåŸŸè®©ä»–ä»¬å†…å­˜å¯¹é½ï¼Œæ‰€ä»¥è¿™ä¸ªå˜ä½“éœ€è¦ 32
å­—èŠ‚ (1 + 7 + 3 * 8)ã€‚</p>
<p>æ¥ç€æ˜¯ <code>Number</code> å˜ä½“ï¼Œé¦–å…ˆæ˜¯æ•´æ•°æ ‡è®° 1ï¼Œæ¥ç€æ˜¯ Number é‡Œå­˜å‚¨çš„ i32ï¼Œå ç”¨ 4
å­—èŠ‚ã€‚å› ä¸ºæ‰€æœ‰å˜ä½“çš„å¤§å°åº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šä¸ºå®ƒä»¬ä¸¤ä¸ªéƒ½æ·»åŠ  Padding è¾¾åˆ° 32 å­—èŠ‚</p>
<p>å¯¹äº <code>Empty</code>ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ªå­—èŠ‚å»å­˜å‚¨æ•´æ•°æ ‡è®°ï¼Œä½†æ˜¯ç¼–è¯‘å™¨ä¹Ÿå¿…é¡»æ·»åŠ  31 å­—èŠ‚çš„ Padding</p>
<p>æ‰€ä»¥ï¼Œæšä¸¾å ç”¨çš„ç©ºé—´å–å†³äºæœ€å¤§å˜ä½“å ç”¨çš„ç©ºé—´ã€‚</p>
<p>å‡å°‘å†…å­˜ä½¿ç”¨çš„ä¸€ä¸ªæŠ€å·§å°±æ˜¯é™ä½æšä¸¾æœ€å¤§å˜ä½“å ç”¨çš„å†…å­˜ï¼š</p>
<pre><code class="language-rs">enum Data {
    Empty,
    Number(i32),
    Array(Box&lt;Vec&lt;i32&gt;&gt;) // ä½¿ç”¨ Box ä»£æ›¿
}
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬å­˜é™¤äº† Vec çš„æŒ‡é’ˆï¼Œæ­¤æ—¶ Array å˜ä½“éœ€è¦çš„å†…å­˜åªæœ‰ 16 å­—èŠ‚ï¼š</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041523525.png?raw=true"  />
<h3 id="box"><a class="header" href="#box">Box</a></h3>
<p>Box æ˜¯ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å †ä¸Šçš„æ•°æ®ï¼Œæ‰€ä»¥ Box åœ¨æ ˆä¸Šåªéœ€è¦ 1 ä¸ª <code>usize</code> å»å­˜å‚¨åœ°å€ã€‚</p>
<p>åœ¨ä¸Šä¸ªä¾‹å­ä¸­ï¼ŒBox æŒ‡å‘äº†ä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„ Vecã€‚</p>
<blockquote>
<p>å¦‚æœå‘é‡é‡Œé¢æœ‰å€¼ï¼Œè¿™äº›å€¼ä¹Ÿä¼šè¢«å­˜å‚¨åœ¨å †ä¸Šã€‚æŒ‡å‘æ•°æ®çš„æŒ‡é’ˆå°†ä¿å­˜åœ¨ Vec çš„æŒ‡é’ˆå­—æ®µé‡Œ</p>
</blockquote>
<h3 id="å¯¹-option-çš„ä¼˜åŒ–"><a class="header" href="#å¯¹-option-çš„ä¼˜åŒ–">å¯¹ Option çš„ä¼˜åŒ–</a></h3>
<pre><code class="language-rs">pub enum Option&lt;T&gt; {
    None,
    Some(T)
}
</code></pre>
<p>ç”±äº Rust ä¸å…è®¸å‡ºç°ç©ºæŒ‡é’ˆï¼Œæƒ³è¦å®ç°åŒæ ·çš„æ•ˆæœï¼Œä½ éœ€è¦ä½¿ç”¨</p>
<pre><code class="language-rs">Option&lt;Box&lt;i32&gt;&gt;
</code></pre>
<p>è¿™èƒ½å¤Ÿè®© Rust ç¼–è¯‘å™¨ç¡®ä¿ä¸ä¼šå‡ºç°ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041541105.png?raw=true"  />
<p>åœ¨å…¶ä»–è¯­è¨€é‡Œï¼Œä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå°±èƒ½è¡¨ç¤ºè¿™ä¸¤ç§çŠ¶æ€ã€‚ä½†æ˜¯ Rust å´éœ€è¦ä¸€ä¸ªé¢å¤–çš„æ•´æ•°æ ‡è®°å’Œéšä¹‹å¸¦æ¥çš„ paddingï¼Œè¿™ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚</p>
<p>ç¼–è¯‘å™¨èƒ½å¯¹æ­¤åšå‡ºä¸€äº›ä¼˜åŒ–ï¼Œå¦‚æœ <code>Option</code> é‡Œæ˜¯ <code>Box</code> æˆ–è€…æ˜¯ç±»ä¼¼çš„æŒ‡é’ˆç±»å‹ï¼Œç¼–è¯‘å™¨å°±ä¼šçœç•¥æ‰æ•´æ•°æ ‡è®°ï¼Œå¹¶ä½¿ç”¨å€¼ä¸º 0 çš„æŒ‡é’ˆè¡¨ç¤º Noneã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041703687.png?raw=true"  />
<p>è¿™ç§ç‰¹æ€§ä½¿å¾— Rust ä¸­è¢«åŒ…è£…åœ¨ <code>Option</code> å†…çš„æ™ºèƒ½æŒ‡é’ˆåƒå…¶ä»–è¯­è¨€é‡Œçš„æŒ‡é’ˆä¸€æ ·ï¼Œä¸ä¼šå ç”¨å¤šä½™çš„å†…å­˜ã€‚åŒæ—¶è¿˜èƒ½å¤Ÿæå‰æ‰¾åˆ°å¹¶æ¶ˆé™¤ç©ºæŒ‡é’ˆå¼‚å¸¸</p>
<h3 id="copy-å’Œ-move"><a class="header" href="#copy-å’Œ-move">Copy å’Œ Move</a></h3>
<p>åœ¨ç»§ç»­å‘ä¸‹è®¨è®ºä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹ Copy å’Œ Move</p>
<pre><code class="language-rs">let numï¼ši32 = 42;
let num_copy = num;
</code></pre>
<p>å¯¹äºåŸå§‹ç±»å‹æ•°æ®ï¼Œä»–ä»¬çš„å¤§å°æ˜¯åœ¨ç¼–è¯‘æ—¶å·²çŸ¥çš„ï¼Œä¼šè¢«å­˜å‚¨åœ¨æ ˆä¸Šã€‚å¦‚æœä½ å°†ä¸€ä¸ªå˜é‡èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡ï¼Œå®ƒå¾—åˆ°çš„å®é™…ä¸Šæ˜¯åŸå§‹æ•°æ®çš„ä¸€ä»½æ‹·ï¼ŒRust ä¼šé€ä½è¿›è¡Œå¤åˆ¶ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041713211.png?raw=true"  />
<p>è¿™ä¸¤ä¸ªå˜é‡ä¹‹åèƒ½åŒæ—¶ä½¿ç”¨</p>
<p>å¯¹äºåœ¨å †ä¸Šå­˜å‚¨çš„æ•°æ®æ¥è¯´ï¼š</p>
<pre><code class="language-rs">let v: Vec&lt;String&gt; = vec![
    &quot;Odin&quot;.to_String(),
    &quot;Thor&quot;.to_String(),
    &quot;Loki&quot;.to_String(),
]
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªåœ¨å †ä¸Šåˆ†é…çš„å­—ç¬¦ä¸²å‘é‡ã€‚</p>
<p>å˜é‡ v è¢«ä¿å­˜åœ¨æ ˆä¸Šï¼Œå®ƒéœ€è¦ 3 ä¸ª <code>usize</code> å»å­˜å‚¨ Vec çš„ä¿¡æ¯ï¼Œå¹¶æŒ‡å‘æ•°æ®åœ¨å †ä¸­çš„åœ°å€ã€‚</p>
<p>æ¯ä¸ªå­—ç¬¦ä¸²ä¹Ÿéœ€è¦ 3 ä¸ª <code>usize</code> æ¥å­˜å‚¨å®é™…å­—ç¬¦ä¸²çš„ä¿¡æ¯ã€‚</p>
<p>çœŸæ­£çš„å­—ç¬¦ä¸²ä¼šè¢«åˆ†é…åˆ°å †ä¸Šçš„å…¶ä»–åœ°æ–¹ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041728077.png?raw=true"  />
<p>ä»æ‰€æœ‰æƒè§’åº¦æ¥è¯´ï¼Œå˜é‡ v æ‹¥æœ‰æ‰€æœ‰åœ¨å †ä¸Šåˆ†é…çš„å†…å­˜ã€‚å› ä¸º Rust æ²¡æœ‰ GCï¼Œå½“å˜é‡ v è‡ªå·±è¶…å‡ºä½œç”¨åŸŸåï¼Œå®ƒéœ€è¦è‡ªå·±é‡Šæ”¾è‡ªå·±æ‹¥æœ‰çš„å †å†…å­˜ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°† v èµ‹å€¼ç»™äº† v2ï¼š</p>
<pre><code class="language-rs">let v2 = v;
</code></pre>
<p>å¯¹äºæœ‰ GC çš„è¯­è¨€æ¥è¯´ï¼Œç¨‹åºä¼šå¯¹å˜é‡ <code>v</code> åœ¨æ ˆä¸Šçš„æ•°æ®è¿›è¡Œäº†æŒ‰ä½å¤åˆ¶ï¼Œæœ€å <code>v2</code> ä¹Ÿå°†æ‹¥æœ‰æŒ‡å‘å †ä¸Šæ•°æ®çš„æŒ‡é’ˆã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041741726.png?raw=true"  />
<p>è¿™ç§æ–¹æ¡ˆå¾ˆèŠ‚çœå†…å­˜ï¼Œæ— è®ºåœ¨å †ä¸­çš„æ•°æ®æœ‰å¤šå¤§ï¼Œæˆ‘ä»¬åªéœ€è¦å¤åˆ¶æ ˆä¸Šçš„æ•°æ®ã€‚åƒåœ¾å›æ”¶å™¨ä¼šè¿½è¸ªå †å†…å­˜çš„å¼•ç”¨æ•°é‡ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå¸®æˆ‘ä»¬é‡Šæ”¾å †å†…å­˜ã€‚</p>
<p>ä½†æ˜¯ Rust æ²¡æœ‰ GCï¼Œå®ƒåªæœ‰æ‰€æœ‰æƒæ¨¡å‹ã€‚æˆ‘ä»¬ä¸æ¸…æ¥šåˆ°åº•å“ªä¸ªå˜é‡éœ€è¦å¯¹é‡Šæ”¾å†…å­˜è´Ÿè´£ã€‚</p>
<p>å¦ä¸€ç§æ–¹æ¡ˆæ˜¯ï¼šåœ¨èµ‹å€¼æ—¶ä¸ºå †å†…å­˜ä¹Ÿåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ã€‚ä½†æ˜¯è¿™ä¼šå¯¼è‡´å†…å­˜ä½¿ç”¨é‡å‡é«˜ï¼Œé™ä½æ€§èƒ½ã€‚</p>
<p>Rust çš„é€‰æ‹©æ˜¯è®©ç”¨æˆ·å¿…é¡»åšå‡ºé€‰æ‹©ï¼šå¦‚æœä½ åœ¨å¯¹å˜é‡èµ‹å€¼æ—¶æƒ³è®©å®ƒæ‹¥æœ‰ä¸€ä»½å±äºè‡ªå·±çš„å †å†…å­˜ï¼Œä½ åº”è¯¥ä½¿ç”¨ <code>clone</code> æ–¹æ³•ã€‚å¦‚æœä½ ä¸ä½¿ç”¨ <code>clone</code>
æ–¹æ³•ï¼ŒRust ç¼–è¯‘å™¨å°±ä¸å…è®¸ä½ å†ä½¿ç”¨ä¹‹å‰çš„å˜é‡ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041754565.png?raw=true"  />
<p>æˆ‘ä»¬æŠŠå®ƒç§°ä¸ºï¼šå˜é‡ v å·²ç»è¢« move äº†ï¼Œç°åœ¨ v2 æ˜¯æ•°æ®çš„æ‹¥æœ‰è€…ã€‚å½“ v2 è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œå®ƒä¼šè´Ÿè´£é‡Šæ”¾å †ä¸Šçš„æ•°æ®ã€‚</p>
<h3 id="rc"><a class="header" href="#rc">Rc</a></h3>
<p>æœ‰æ—¶å€™æˆ‘ä»¬æƒ³è®©ä¸€ä¸ªå€¼æ‹¥æœ‰å¤šä¸ªæ‹¥æœ‰è€…ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ç”¨æ™®é€šçš„å¼•ç”¨å»è§£å†³ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•çš„é—®é¢˜åœ¨äºï¼Œå½“æ•°æ®çš„æ‹¥æœ‰è€…è¶…å‡ºä½œç”¨åŸŸåï¼Œæ‰€æœ‰çš„å¼•ç”¨ä¹Ÿä¸èƒ½å†ç»§ç»­ä½¿ç”¨ã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦çš„æ˜¯æ‰€æœ‰å˜é‡éƒ½æ˜¯æ•°æ®çš„æ‹¥æœ‰è€…ï¼Œåªæœ‰æ‰€æœ‰å˜é‡éƒ½è¶…å‡ºä½œç”¨åŸŸåï¼Œæ•°æ®æ‰ä¼šè¢«é‡Šæ”¾ã€‚Rc æ™ºèƒ½æŒ‡é’ˆé€šè¿‡å¼•ç”¨è®¡æ•°èƒ½å¤Ÿå®ç°è¿™ä¸ªåŠŸèƒ½ï¼š</p>
<pre><code class="language-rs">use std::rc::Rc;

let v: Rc&lt;Vec&lt;String&gt;&gt; = Rc::new(vec![
    &quot;Odin&quot;.to_String(),
    &quot;Thor&quot;.to_String(),
    &quot;Loki&quot;.to_String(),
]);

let v2 = v.clone();
println!(&quot;{}, {}&quot;, v.capacity(), v2.capacity())
</code></pre>
<p>å½“ä½ ä½¿ç”¨ Rc å»åŒ…è£¹ä¸€ä¸ª Vec æ—¶ï¼ŒVec çš„ 3 ä¸ª <code>usize</code> ä¼šå’Œå¼•ç”¨è®¡æ•°ä¸€èµ·åˆ†é…åœ¨å †ä¸Šã€‚å˜é‡ v åœ¨æ ˆåªå ç”¨ä¸€ä¸ª <code>usize</code>ï¼Œé‡Œé¢å­˜å‚¨äº†
Rc åœ¨å †ä¸Šçš„åœ°å€ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041812961.png?raw=true"  />
<p>ç°åœ¨ä½ èƒ½é€šè¿‡å…‹éš† v æ¥åˆ›å»º v2ï¼Œè¿™ä¸ªå…‹éš†ä¸ä¼šå…‹éš†ä»»ä½•ä½äºå †ä¸Šçš„æ•°æ®ï¼Œä»–åªä¼šå…‹éš†ä¸€ä»½æ ˆä¸Šçš„åœ°å€ï¼Œç„¶åå°† Rc çš„å¼•ç”¨è®¡æ•°åŠ  1ï¼Œç°åœ¨ v å’Œ v2
éƒ½æŒæœ‰ç›¸åŒçš„ä¸€ä»½æ•°æ®ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¢«ç§°ä¸ºå¼•ç”¨æŠ€æœ¯æŒ‡é’ˆã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041814163.png?raw=true"  />
<p>ä½†æ˜¯ Rc ä¹Ÿæœ‰é™åˆ¶ï¼ŒRc å†…éƒ¨çš„æ•°æ®æ˜¯ä¸å¯å˜çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨å†…éƒ¨å¯å˜æ€§å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æ¯å½“æœ‰ä¸€ä¸ªå…±äº«è€…è¶…å‡ºä½œç”¨åŸŸï¼Œå¼•ç”¨è®¡æ•°å°±ä¼šå‡ 1ï¼Œè®©å¼•ç”¨è®¡æ•°å‡åˆ° 0 æ—¶ï¼Œæ•´ä¸ªå †å†…å­˜å°±ä¼šè¢«é‡Šæ”¾ã€‚</p>
<h3 id="send-å’Œ-sync"><a class="header" href="#send-å’Œ-sync">Send å’Œ Sync</a></h3>
<p>Rust æœ‰ä¸€äº›ç‰¹æ®Šçš„æ ‡è®°ç‰¹å¾ï¼Œä¾‹å¦‚ Send å’Œ Syncã€‚</p>
<p>å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº† Sendï¼Œé‚£å°±æ„å‘³ç€æ•°æ®å¯ä»¥ä»ä¸€ä¸ªçº¿ç¨‹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>å¦‚æœä¸€ä¸ªç±»å‹å®ç°äº† Syncï¼Œå¤šä¸ªçº¿ç¨‹å°±å¯ä»¥ä½¿ç”¨å¼•ç”¨å»å…±äº«è¯¥æ•°æ®ã€‚</p>
<p>Rc æ²¡æœ‰å®ç° Send å’Œ Syncã€‚å‡è®¾ä¸¤ä¸ªçº¿ç¨‹åœ¨æŸä¸ªæ—¶é—´ç‚¹åŒæ—¶æ‹¥æœ‰å¯¹æŸæ•°æ®çš„å¼•ç”¨ï¼Œå¹¶ä¸”åŒæ—¶å¯¹è¯¥å¼•ç”¨è¿›è¡Œå…‹éš†ã€‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ›´æ–°å¼•ç”¨è®¡æ•°å°±ä¼šå¼•å‘çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205041839368.png?raw=true"  />
<h3 id="arc"><a class="header" href="#arc">Arc</a></h3>
<p>å¦‚æœä½ çœŸçš„æƒ³è¦åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®ï¼Œä½ åº”è¯¥ä½¿ç”¨ <strong>åŸå­</strong> å¼•ç”¨è®¡æ•°æŒ‡é’ˆ <strong>Arc</strong>ã€‚</p>
<p>Arc çš„å·¥ä½œæ–¹å¼å‡ ä¹å’Œ Rc ç›¸åŒï¼Œåªæ˜¯å¼•ç”¨è®¡æ•°çš„æ›´æ–°æ˜¯åŸå­æ€§çš„ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯åŸå­æ“ä½œä¼šå¸¦æ¥ä¸€äº›å¾®å°çš„æ€§èƒ½æŸè€—ã€‚å¦‚æœä½ åªéœ€è¦åœ¨å•çº¿ç¨‹å†…å…±äº«æ•°æ®ï¼Œä½¿ç”¨
Rc å°±å¤Ÿäº†ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ Arc ä¹Ÿæ˜¯ä¸å˜çš„ï¼Œå¦‚æœä½ æƒ³è®©æ•°æ®æ˜¯å¯å˜çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>Mutex</code>ã€‚</p>
<pre><code class="language-rs">// Arc&lt;Mutex&lt;T&gt;&gt;

let data: Arc&lt;Mutex&lt;i32&gt;&gt; = Arc::new(Mutex::new(0));
</code></pre>
<p>ç°åœ¨å³ä½¿æœ‰ä¸¤ä¸ªçº¿ç¨‹å°è¯•åŒæ—¶ä¿®æ”¹æ•°æ®ï¼Œä»–ä»¬éœ€è¦é¦–å…ˆè·å–é”ï¼ŒåŒæ—¶åªæœ‰æœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‹¿åˆ°é”ï¼Œå› æ­¤åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æ•°æ®ã€‚</p>
<h3 id="ç‰¹å¾å¯¹è±¡"><a class="header" href="#ç‰¹å¾å¯¹è±¡">ç‰¹å¾å¯¹è±¡</a></h3>
<p>å®ç°äº†ç‰¹å¾çš„å®ä¾‹è¢«ç§°ä¸ºç‰¹å¾å¯¹è±¡ã€‚</p>
<p>ä¸‹é¢åˆ—ä¸¾äº†å°†ä¸€ç§å…·ä½“ç±»å‹è½¬åŒ–ä¸ºç‰¹å¾å¯¹è±¡çš„æ–¹æ³•ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::io::Write;

let mur buffer: Vec&lt;u8&gt; = vec![];
let w: &amp;mut dyn Write = &amp;mut buffer;
<span class="boring">}
</span></code></pre></pre>
<p>ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œè½¬åŒ–å‘ç”Ÿåœ¨ä¸ºå˜é‡ <code>w</code> èµ‹å€¼æ—¶</p>
<pre><code class="language-rs">fn main() {
    let mut buffer: Vec&lt;u8&gt; = vec![];
    writer(&amp;mut buffer);
}

fn writer(w: &amp;mut dyn Write) {
    // ...
}
</code></pre>
<p>ç¬¬äºŒä¸ªä¾‹å­ä¸­ï¼Œè½¬åŒ–å‘ç”Ÿåœ¨å°†å…·ä½“ç±»å‹å˜é‡ä¼ é€’ç»™æ¥å—ç‰¹å¾å¯¹è±¡çš„å‡½æ•°æ—¶</p>
<p>è¿™ä¸¤ä¸ªä¾‹å­é‡Œ <code>Vec&lt;u8&gt;</code> ç±»å‹çš„å˜é‡éƒ½è¢«è½¬åŒ–ä¸ºå®ç°äº† <code>Write</code> çš„ç‰¹å¾å¯¹è±¡ã€‚</p>
<p>Rust ç”¨èƒ–æŒ‡é’ˆè¡¨ç¤ºä¸€ä¸ªç‰¹å¾å¯¹è±¡ã€‚è¯¥èƒ–æŒ‡é’ˆç”±ä¸¤ä¸ªæ™®é€šæŒ‡é’ˆç»„æˆï¼Œå ç”¨ 2 ä¸ªæœºå™¨å­—é•¿ã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å€¼ï¼Œè¿™é‡Œå°±æ˜¯ <code>Vec&lt;u8&gt;</code></li>
<li>å¦ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ vtable (è™šè¡¨)ã€‚</li>
</ul>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042022927.png?raw=true"  />
<p><code>vtable</code> åœ¨ç¼–è¯‘æ—¶ç”Ÿæˆï¼Œè¢«æ‰€æœ‰ç›¸åŒç±»å‹çš„å¯¹è±¡å…±äº«ã€‚<code>vtable</code> åŒ…å«äº†å®ç° <code>Writer</code>
å¿…é¡»å®ç°çš„æ–¹æ³•çš„æŒ‡é’ˆã€‚å½“ä½ åœ¨è°ƒç”¨ç‰¹å¾å¯¹è±¡çš„æ–¹æ³•æ—¶ï¼ŒRust è‡ªåŠ¨ä½¿ç”¨ <code>vtable</code> æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<p>æ³¨æ„ï¼š<code>dyn Write</code> ä¹Ÿæ˜¯åŠ¨æ€å¤§å°ç±»å‹ï¼Œå› æ­¤æˆ‘ä»¬æ€»æ˜¯ä½¿ç”¨å®ƒçš„å¼•ç”¨ï¼Œå³ <code>&amp;dyn Write</code>ã€‚</p>
<p>æˆ‘ä»¬èƒ½æŠŠ <code>Vec&lt;u8&gt;</code> è½¬æ¢æˆç‰¹å¾å¯¹è±¡æ˜¯å› ä¸ºæ ‡å‡†åº“å·²ç»ä¸ºå®ƒå®ç°äº† <code>Write</code> ç‰¹å¾ã€‚</p>
<pre><code class="language-rs">impl Write for Vec&lt;u8&gt;
</code></pre>
<p>Rust ä¸ä»…èƒ½å°†æ™®é€šå¼•ç”¨è½¬åŒ–ä¸ºç‰¹å¾å¯¹è±¡ï¼Œrust ä¹Ÿèƒ½å°†æ™ºèƒ½æŒ‡é’ˆè½¬æ¢ä¸ºç‰¹å¾å¯¹è±¡ï¼š</p>
<pre><code class="language-rs">// Box
use std::io::Write;

let mut buffer: Vec&lt;u8&gt; = vec![];
let w: Box&lt;dyn Write&gt; = Box::new(buffer);
</code></pre>
<pre><code class="language-rs">// Rc
use std::io::Write;
use std::rc::Rc;

let mut buffer: Vec&lt;u8&gt; = vec![]

let mut w: Rc&lt;dyn Write&gt; = Rc::new(buffer);
</code></pre>
<p>æ— è®ºæ˜¯æ™®é€šå¼•ç”¨è¿˜æ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Œåœ¨è½¬æ¢å‘ç”Ÿçš„æ—¶å€™ï¼ŒRust åªæ˜¯æ·»åŠ äº†é€‚å½“çš„ <code>vtable</code> æŒ‡é’ˆï¼ŒæŠŠåŸå§‹æŒ‡é’ˆè½¬æ¢ä¸ºäº†ä¸€ä¸ªèƒ–æŒ‡é’ˆã€‚</p>
<h3 id="å‡½æ•°æŒ‡é’ˆ"><a class="header" href="#å‡½æ•°æŒ‡é’ˆ">å‡½æ•°æŒ‡é’ˆ</a></h3>
<p>å‡½æ•°æŒ‡é’ˆåªéœ€è¦ä¸€ä¸ª <code>usize</code> å»å­˜å‚¨å‡½æ•°çš„åœ°å€ã€‚</p>
<p><code>test_func</code> æ˜¯ä¸€ä¸ªä¼šè¿”å› bool çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒå­˜åœ¨äº†ä¸€ä¸ªå˜é‡é‡Œã€‚</p>
<pre><code class="language-rs">fn main() {
    let f: fn() -&gt; bool = test_func;
}

fn test_func() -&gt; bool {
    true
}
</code></pre>
<p><img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042044987.png" alt="" /></p>
<h3 id="é—­åŒ…"><a class="header" href="#é—­åŒ…">é—­åŒ…</a></h3>
<p>Rust æ²¡æœ‰å…·ä½“çš„é—­åŒ…ç±»å‹ï¼Œå®ƒåˆ¶å®šäº† 3 ä¸ªç‰¹å¾ <code>Fn</code>ã€<code>FnMut</code>ã€<code>FnOnce</code>ã€‚</p>
<h4 id="fnonce"><a class="header" href="#fnonce">FnOnce</a></h4>
<p>é¦–å…ˆæ˜¯ <code>FnOnce</code>ï¼Œ<code>create_closere</code> å‡½æ•°è¿”å›äº†ä¸€ä¸ªå®ç° <code>FnOnce</code> çš„å¯¹è±¡</p>
<pre><code class="language-rs">fn main() {
    let c = create_closure();
}

fn create_closure() -&gt; impl FnOnce() {
    let name = String::from(&quot;john&quot;);
    || {
        drop(name);
    }
}
</code></pre>
<p>åœ¨å‡½æ•°ä½“å†…éƒ¨æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå±€éƒ¨å˜é‡ <code>name</code>ï¼Œå®ƒæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåœ¨æ ˆä¸Šå æ® 3 ä¸ª <code>usize</code>
ï¼Œæ¥ç€åˆåˆ›å»ºäº†ä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…å¯ä»¥æ•è·å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ã€‚åœ¨é—­åŒ…å†…éƒ¨ï¼Œæˆ‘ä»¬ drop äº† nameã€‚</p>
<p>FnOnce åªæ˜¯ä¸€ä¸ªç‰¹å¾ï¼Œå®ƒåªå®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡çš„è¡Œä¸ºæˆ–æ–¹æ³•ã€‚Rust
å†…éƒ¨ä¼šä½¿ç”¨ç»“æ„ä½“è¡¨ç¤ºé—­åŒ…ï¼Œå®ƒä¼šæ ¹æ®é—­åŒ…æ•è·çš„å˜é‡åˆ›å»ºå¯¹åº”çš„ç»“æ„ä½“ï¼Œå¹¶ä¸ºè¯¥ç»“æ„ä½“å®ç°æœ€åˆé€‚çš„ç‰¹å¾</p>
<pre><code class="language-rs">struct MyClosure {
    name: String
}

impl FnOnce for MyClosure {
    fn call_once(self) {
        drop(self.name)
    }
}
</code></pre>
<blockquote>
<p><code>FnOnce</code> ç‰¹å¾çš„çœŸå®å‡½æ•°ç­¾åæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œåªå±•ç¤ºä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬ã€‚</p>
</blockquote>
<p>ç»“æ„ä½“å†…éƒ¨åªæœ‰ä¸€ä¸ª name å­—æ®µï¼Œæ˜¯é—­åŒ…ä» <code>create_closure</code> å‡½æ•°å†…éƒ¨æ•è·è€Œæ¥ï¼Œ<code>call_once</code> æ˜¯ <code>FnOnce</code>
ç‰¹å¾å¿…é¡»å®ç°çš„æ–¹æ³•ã€‚å› ä¸ºé—­åŒ…å¯¹åº”çš„ç»“æ„ä½“åªæœ‰ä¸€ä¸ª String ç±»å‹å­—æ®µï¼Œæ‰€ä»¥ä»–çš„å†…å­˜å¸ƒå±€å’Œ String ä¸€æ ·ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042058375.png?raw=true" />
<p>æ³¨æ„ call_once å‡½æ•°çš„å‚æ•°ï¼Œä»–éœ€è¦ä¸€ä¸ª <code>self</code> ï¼Œè¿™æ„å‘³ç€ <code>call_once</code>
åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨ä¸¤æ¬¡è¿™ä¸ªé—­åŒ…ï¼Œæ‹¿ä»–å°±ä¼š drop <code>name</code> ä¸¤æ¬¡ã€‚</p>
<h4 id="fnmut"><a class="header" href="#fnmut">FnMut</a></h4>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¯å˜çš„é—­åŒ…ï¼š</p>
<pre><code class="language-rs">let mut i: i32 = 0;

let mut f = || {
    i += 1;
};

f();
f();
println!(&quot;{}&quot;, i); // 2
</code></pre>
<p>è¿™ä¸ªé—­åŒ…çš„ç±»å‹æ˜¯ <code>FnMut</code> ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨é—­åŒ…é‡Œå°è¯•ä¿®æ”¹å˜é‡ iã€‚å› æ­¤è¯¥é—­åŒ…ç”Ÿæˆçš„ç»“æ„ä½“ä¸­å°†ä¼šæœ‰ä¸€ä¸ªå¯¹å˜é‡ i çš„å¯å˜å¼•ç”¨ï¼Œ<code>call_mut</code>
æ–¹æ³•ä¹Ÿéœ€è¦ä¸€ä¸ªå¯¹ <code>self</code> çš„å¯å˜å¼•ç”¨ï¼š</p>
<pre><code class="language-rs">struct MyClosure {
    i: &amp;mut i32
}

impl FnMut for MyClosure {
    fn call_mut(&amp;mut self) {
        *self.i += 1;
    }
}
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042118777.png?raw=true" />
<p>å¦‚æœä½ åœ¨é—­åŒ… f æ”¹ä¸ºä¸å¯å˜çš„ï¼š</p>
<pre><code class="language-rs">let f = || {
    i += 1;
};
</code></pre>
<p>å°±ä¼šç¼–è¯‘å¤±è´¥ï¼š</p>
<pre><code class="language-rs">error[E0596]: cannot borrow `f` as mutable, as it is not declared as mutable
  --&gt; src/main.rs:16:5
   |
12 |     let f = || {
   |         - help: consider changing this to be mutable: `mut f`
13 |         i += 1;
   |         - calling `f` requires mutable binding due to mutable borrow of `i`
...
16 |     f();
   |     ^ cannot borrow as mutable
For more information about this error, try `rustc --explain E0596`.
</code></pre>
<p>é”™è¯¯ä¿¡æ¯æç¤ºæˆ‘ä»¬ï¼Œè¯¥é—­åŒ…éœ€è¦è®¾ä¸ºå¯å˜çš„</p>
<h4 id="fn"><a class="header" href="#fn">Fn</a></h4>
<p>æœ€åæ˜¯ <code>Fn</code> ç‰¹å¾ï¼š</p>
<pre><code class="language-rs">fn create_closure() {
    let msg = String::from(&quot;hello&quot;);

    let my_print = || {
        println!(&quot;{}&quot;, msg);
    };

    my_print();
    my_print();
}
</code></pre>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬çš„é—­åŒ…åªæ˜¯æ‰“å°äº†ä¸€ä¸‹å®ƒæ•è·åˆ°çš„ msg å˜é‡ï¼Œ<code>print</code> å®æ¥å—çš„æ˜¯å˜é‡çš„å¼•ç”¨ï¼Œæ‰€ä»¥ Rust ä¼šè‡ªåŠ¨ä¸ºé—­åŒ…å®ç° Fn ç‰¹å¾ï¼š</p>
<pre><code class="language-rs">struct MyClosure {
    msg: &amp;String,
}

impl Fn for MyClosure {
    fn call(&amp;self) {
        println!(&quot;{}&quot;, self.msg);
    }
}
</code></pre>
<p>ç”Ÿæˆçš„ç»“æ„ä½“å†…éƒ¨åªæœ‰ä¸€ä¸ªå¯¹ <code>msg</code> çš„å¼•ç”¨ã€‚<code>call</code> æ–¹æ³•åªéœ€è¦ä¸€ä¸ª <code>self</code> çš„å¼•ç”¨ï¼Œå› æ­¤è¿™ä¸ªé—­åŒ…èƒ½å¤Ÿè¢«å¤šæ¬¡è°ƒç”¨ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042118165.png?raw=true" />
<h4 id="move"><a class="header" href="#move">move</a></h4>
<p>è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å°†ä½¿ç”¨å’Œåˆšåˆšç›¸åŒçš„é—­åŒ…ï¼Œåªä¸è¿‡æ˜¯ç”¨ä¸€ä¸ªå‡½æ•°å»è¿”å›ï¼š</p>
<pre><code class="language-rs">fn create_closure() -&gt; impl Fn() {
    let msg = String::from(&quot;hello&quot;);

    || {
        println!(&quot;{}&quot;, msg);
    }
}
</code></pre>
<p>ä½†æ˜¯è¿™æ ·ä¼šç¼–è¯‘é”™è¯¯ï¼š</p>
<pre><code class="language-rs">error[E0597]: `msg` does not live long enough
  --&gt; src/main.rs:30:24
   |
29 |     || {
   |     -- value captured here
30 |         println!(&quot;{}&quot;, msg);
   |                        ^^^ borrowed value does not live long enough
31 |     }
32 | }
   | -- borrow later used here
   | |
   | `msg` dropped here while still borrowed

For more information about this error, try `rustc --explain E0597`.
</code></pre>
<p>é”™è¯¯ä¿¡æ¯æç¤ºæˆ‘ä»¬ï¼Œå˜é‡ <code>msg</code> çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½æ¯”é—­åŒ…çŸ­ã€‚</p>
<p>ç°åœ¨å›æƒ³ä¸€ä¸‹é—­åŒ…çš„å†…å­˜å¸ƒå±€ï¼Œé—­åŒ…çš„ç»“æ„ä½“å†…éƒ¨åªæœ‰ä¸€ä¸ªå¯¹ <code>msg</code> çš„å¼•ç”¨ã€‚æ‰€ä»¥å½“å‡½æ•°è°ƒç”¨ç»“æŸåï¼Œå®ƒçš„æ ˆå¸§å°†è¢«é‡Šæ”¾ï¼Œé—­åŒ…å°±ä¸èƒ½å†å¼•ç”¨åˆ°è¯¥å‡½æ•°æ ˆå¸§é‡Œçš„å±€éƒ¨å˜é‡ã€‚</p>
<p>Rust å¸Œæœ›æˆ‘ä»¬ä½¿ç”¨ <code>move</code> å…³é”®å­—å»æ˜ç¡®è¡¨ç¤ºæˆ‘ä»¬æƒ³è®©é—­åŒ…æ‹¿èµ°é—­åŒ…æ•è·åˆ°çš„å˜é‡çš„æ‰€æœ‰æƒ</p>
<pre><code class="language-rs">fn create_closure() -&gt; impl Fn() {
    let msg = String::from(&quot;hello&quot;);

    move || {
        println!(&quot;{}&quot;, msg);
    }
}
</code></pre>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ move ä¹‹åï¼Œé—­åŒ…çš„ç»“æ„ä½“å°±ä¸å†æ˜¯å¼•ç”¨ï¼Œè€Œæ˜¯å­—ç¬¦ä¸²æœ¬èº«ã€‚</p>
<pre><code class="language-rs">struct MyClosure {
    msg: String,
}

impl Fn for MyClosure {
    fn call(&amp;self) {
        println!(&quot;{}&quot;, self.msg);
    }
}
</code></pre>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042120583.png?raw=true"  />
<h4 id="æ•è·å¤šä¸ªå˜é‡"><a class="header" href="#æ•è·å¤šä¸ªå˜é‡">æ•è·å¤šä¸ªå˜é‡</a></h4>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„é—­åŒ…è¿˜åªæ˜¯æ•è·ä¸€ä¸ªå˜é‡ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œé—­åŒ…æ•è·äº†ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ª Vecï¼š</p>
<pre><code class="language-rs">fn create_closure() -&gt; impl Fn() {
    let msg = String::from(&quot;hello&quot;);
    let v: Vec&lt;i32&gt; = vec![1, 2];

    move || {
        println!(&quot;{}&quot;, msg);
        println!(&quot;{:?}&quot;, v);
    }
}
</code></pre>
<p>å®ƒçš„ç»“æ„ä½“å¤§è‡´å¦‚ä¸‹ï¼š</p>
<pre><code class="language-rs">struct MyClosure {
    msg: String,
    v: Vec&lt;i32&gt;,
}

impl Fn for MyClosure {
    fn call(&amp;self) {
        println!(&quot;{}&quot;, self.msg);
        println!(&quot;{:?}&quot;, self.v);
    }
}
</code></pre>
<p>å®ƒçš„å†…å­˜å¸ƒå±€å’Œç»“æ„ä½“çš„ä¸€æ ·ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹æ®Šçš„ã€‚</p>
<img src="https://gitee.com/rustcn/rustt-assets/raw/main/20220504-Visualizing-memory-layout-of-Rust-data-types/202205042120232.png?raw=true" />
<p>è¿™ä¸ªæ¨¡å¼åœ¨å…¶ä»–åœ°æ–¹ä¹Ÿéµå¾ªï¼Œæ¯”å¦‚ å¼‚æ­¥ç”Ÿæ€ä¸­å¤§é‡ä½¿ç”¨çš„ Future ç‰¹å¾ã€‚åœ¨å†…å­˜ä¸­ç¼–è¯‘å™¨ä¼šä½¿ç”¨æšä¸¾è¡¨ç¤ºå®é™…çš„å¯¹è±¡ï¼Œå¹¶ä¸ºè¿™ä¸ªæšä¸¾å®ç° Future
ç‰¹å¾ã€‚è¿™é‡Œä¸ä¼šè¯¦ç»†è®²è§£ Future çš„å®ç°ç»†èŠ‚ï¼Œæˆ‘æä¾›äº†ä¸€ä¸ªé“¾æ¥ï¼Œè§†é¢‘é‡Œè¯¦ç»†çš„è§£é‡Šäº†å¼‚æ­¥å‡½æ•°çš„å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="èµ„æ–™"><a class="header" href="#èµ„æ–™">èµ„æ–™</a></h2>
<ul>
<li><a href="https://www.youtube.com/watch?v=ZHP9sUqB3Qs">å¼‚æ­¥å‡½æ•°çš„ä¸€ç”Ÿ RustFest Barcelona - Tyler Mandry: Life of an async fn</a></li>
<li><a href="https://lwn.net/Articles/738975/">å †æ ˆ KAISER: hiding the kernel from user space</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/virtual-address-spaces">è™šæ‹Ÿåœ°å€ç©ºé—´ Virtual address spaces</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¯¹é‡è¯·æ±‚---åº”å¯¹å°¾éƒ¨å»¶è¿Ÿ"><a class="header" href="#å¯¹é‡è¯·æ±‚---åº”å¯¹å°¾éƒ¨å»¶è¿Ÿ">å¯¹é‡è¯·æ±‚ - åº”å¯¹å°¾éƒ¨å»¶è¿Ÿ</a></h1>
<p><a href="https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577">Hedged requests â€” Tackling tail latency</a></p>
<p>é€šå¸¸å‡ºç°åœ¨å‡ºç°åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰å¾ˆå¤šä¼˜ç¼ºç‚¹</p>
<p>ä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„å¸¸è§åŸå› ï¼š</p>
<ul>
<li>å¯ç”¨æ€§</li>
<li>å¯æ‰©å±•æ€§</li>
<li>åˆ†åŒºå®¹é”™</li>
<li>ç‹¬ç«‹éƒ¨ç½²</li>
<li>ä¸ºä¸åŒç›®çš„ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯</li>
</ul>
<p>è¿™äº›å¯èƒ½æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„é—®é¢˜ï¼š</p>
<ul>
<li>æˆæœ¬</li>
<li>å¤æ‚</li>
<li>ä¸€è‡´æ€§</li>
<li><strong>å»¶è¿Ÿ</strong></li>
</ul>
<p>æˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨å»¶è¿Ÿï¼Œæ›´å…·ä½“åœ°è¯´æ˜¯å°¾éƒ¨å»¶è¿Ÿã€‚</p>
<h2 id="å»¶è¿Ÿ"><a class="header" href="#å»¶è¿Ÿ">å»¶è¿Ÿ</a></h2>
<p>å½“æˆ‘ä»¬ä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ï¼Œå»¶è¿Ÿä¼šä¸å¯é¿å…çš„å¢åŠ ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ¯ä¸€è·³éƒ½ä¸æ˜¯å…è´¹çš„ï¼Œé™¤äº†ç½‘ç»œå»¶è¿Ÿè¿˜æœ‰å…¶ä»–æˆæœ¬ï¼Œå¦‚æœä½¿ç”¨ HTTP
é€šä¿¡ï¼Œæˆ‘ä»¬è¿˜è¦å¤„ç†æ¶ˆæ¯ã€è§£ææ¶ˆæ¯ã€éªŒè¯èº«ä»½ä»¤ç‰Œã€ä»¥åŠæˆ‘ä»¬æƒ³è¦æ·»åŠ åˆ°ç®¡é“ä¸­çš„ä»»ä½•æ•°æ®ã€‚è¿™äº›æ˜¯åœ¨è®¾è®¡åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶éœ€è¦è€ƒè™‘çš„é—®é¢˜ã€‚æˆ‘ä»¬å¿…é¡»è€ƒè™‘æ˜¯å¦æœ‰å¿…è¦åˆ†å‘æ–°çš„ç³»ç»Ÿã€‚</p>
<p>è¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä½•æµ‹é‡å»¶è¿Ÿã€‚æœ€ç®€å•çš„ç­”æ¡ˆä¹‹ä¸€æ˜¯ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</p>
<h2 id="ç™¾åˆ†æ¯”"><a class="header" href="#ç™¾åˆ†æ¯”">ç™¾åˆ†æ¯”</a></h2>
<p>é¦–å…ˆæ˜¯å®šä¹‰æˆ‘ä»¬çš„è§‚å¯Ÿç»„ã€‚å¯¹äºå»¶è¿Ÿï¼Œæœ€å¸¸è§çš„è§‚å¯Ÿç»„æ˜¯ç»™å®šè¯·æ±‚ç±»åˆ«çš„å“åº”æ—¶é—´ã€‚è®¡ç®—çš„æ–¹å¼å¦‚ä¸‹ï¼š</p>
<ol>
<li>è·å–è¯·æ±‚çš„æ‰€æœ‰å“åº”æ—¶é—´å¹¶æ’åºã€‚</li>
<li>å–å‰ x% çš„å…ƒç´ ã€‚</li>
<li>è·å–é›†åˆçš„æœ€å¤§ï¼ˆæœ€é•¿ï¼‰å€¼ã€‚</li>
</ol>
<p>ä»¥è¯·æ±‚ <code>/hello-world</code> æ¥å£ä¸ºä¾‹</p>
<ol>
<li>è·å–è¯·æ±‚çš„æ‰€æœ‰å“åº”æ—¶é—´å¹¶æ’åºã€‚
<ul>
<li>è·å–å“åº”æ—¶é—´ï¼š23, 20, 21, 20, 23, 20, 45, 21, 25, 25</li>
<li>æ’åºï¼š20, 20, 20, 21, 21, 23, 23, 25, 25, 45</li>
</ul>
</li>
<li>å–å‰ 50% å…ƒç´ ï¼š20, 20, 20, 21, 21</li>
<li>å¾—åˆ°æœ€å¤§å€¼ï¼š21</li>
</ol>
<p>æ‰€ä»¥ P50 å°±æ˜¯ 21 msï¼Œå¦‚æœå–å‰ 90 % å…ƒç´ ï¼ŒP90 å°±æ˜¯ 25 ms</p>
<h2 id="å°¾éƒ¨å»¶è¿Ÿ"><a class="header" href="#å°¾éƒ¨å»¶è¿Ÿ">å°¾éƒ¨å»¶è¿Ÿ</a></h2>
<p>å°¾éƒ¨å»¶è¿Ÿæ˜¯ç™¾åˆ†ä½è°±æœ€æœ«ç«¯çš„å»¶è¿Ÿã€‚ä¸€èˆ¬ç³»ç»Ÿå¯¹ 99% çš„è¯·æ±‚çš„å“åº”éƒ½å¾ˆå¿«ï¼Œä½†æ˜¯å¯¹äºå‰©ä¸‹çš„ 1% å¯èƒ½éå¸¸å·®ã€‚
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204202210071.png" alt="" />
å¯¹äºä¸€ä¸ªæ¯åˆ†é’Ÿæ¥å—æ•°ç™¾ä¸‡è¯·æ±‚çš„ç³»ç»Ÿæ¥è¯´ï¼Œè¿™ 1% å°±ä¸æ˜¯å¾®ä¸è¶³é“äº†</p>
<p>2013 å¹´ Google å‘è¡¨çš„è®ºæ–‡ä»‹ç»äº†ä¸€äº›è§£å†³æ–¹æ³•</p>
<ul>
<li>Hedged requests</li>
<li>Tied requests</li>
<li>Micro partitions</li>
<li>Selective replication</li>
<li>Latency-induced probation</li>
<li>Good enough responses</li>
<li>Canary requests</li>
</ul>
<p>P99 = 140ms P95 = 70ms</p>
<p>å‰©ä¸‹çš„ 5% è¯·æ±‚å äº†æ€»è¯·æ±‚ä¸€åŠçš„å»¶è¿Ÿ</p>
<h2 id="å¯¹å†²è¯·æ±‚"><a class="header" href="#å¯¹å†²è¯·æ±‚">å¯¹å†²è¯·æ±‚</a></h2>
<p>å¦‚æœè¯·æ±‚çš„æ—¶é•¿è¶…è¿‡ P95 è¿˜æ²¡æœ‰ç»“æœï¼Œé‚£ä¹ˆå°±é‡å‘</p>
<h2 id="æ¨¡æ‹Ÿå°¾éƒ¨å»¶è¿Ÿ"><a class="header" href="#æ¨¡æ‹Ÿå°¾éƒ¨å»¶è¿Ÿ">æ¨¡æ‹Ÿå°¾éƒ¨å»¶è¿Ÿ</a></h2>
<p>ä¸‹é¢çš„ä»£ç æ¨¡æ‹Ÿäº†æœ‰ %4 çš„è¯·æ±‚ä¼šç­‰å¾… 100ms</p>
<pre><code class="language-go">package main

import (
	&quot;math/rand&quot;
	&quot;net/http&quot;
	&quot;time&quot;

	&quot;github.com/gorilla/mux&quot;
)

func main() {
	router := mux.NewRouter()

	router.HandleFunc(&quot;/ishealthy&quot;, func(w http.ResponseWriter, r *http.Request) {
		rd := rand.New(rand.NewSource(time.Now().UnixNano()))
		requestPercentile := rd.Intn(100)
		waitTime := 0

		if requestPercentile &gt; 96 {
			waitTime = 100
		}

		time.Sleep(time.Duration(waitTime+15) * time.Millisecond)
		w.WriteHeader(http.StatusOK)
		w.Write([]byte(&quot;Healthy&quot;))
	}).Methods(http.MethodGet)
	http.ListenAndServe(&quot;:8080&quot;, router)
}
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204202241384.png" alt="" />
ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°</p>
<ul>
<li>p50 å°äº 20ms</li>
<li>p95 20ms å·¦å³</li>
<li>p99 è¶…è¿‡ 115ms</li>
</ul>
<h2 id="å¯¹é‡æµ‹è¯•"><a class="header" href="#å¯¹é‡æµ‹è¯•">å¯¹é‡æµ‹è¯•</a></h2>
<p>æ–°å¢ä¸¤ä¸ªæ¥å£</p>
<ul>
<li><code>/falout</code>ï¼šå¯¹äºæ¯ä¸ªè¯·æ±‚éƒ½è½¬å‘å‡º 3 ä¸ªå‰¯æœ¬ã€‚åº”è¯¥èƒ½åˆ°è¾¾ P99 æ€§èƒ½ã€‚ä½†ä¼šå‘å‡º 3 å€ä»¥ä¸Šçš„è¯·æ±‚ã€‚</li>
<li><code>/hedged</code>ï¼šåœ¨ç¬¬ä¸€ä¸ªæœªè¾¾åˆ°é¢„æœŸ P95 (21ms) ä¹‹åè§¦å‘å¯¹å†²è¯·æ±‚ã€‚åº”è¯¥åœ¨ 40 æ¯«ç§’å·¦å³å°†å°¾éƒ¨æ€§èƒ½æé«˜åˆ° P99ã€‚æœ€å¤šåªèƒ½å¤šå‘å‡º 5%
çš„è¯·æ±‚ã€‚</li>
</ul>
<p><strong>falout</strong></p>
<pre><code class="language-go">func queryFanOut(urls []string) string {
	ch := make(chan string, len(urls))
	for _, url := range urls {
		go func(u string) {
			ch &lt;- executeQuery(u)
		}(url)
	}
	return &lt;-ch
}
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204202248476.png" alt="" /></p>
<p><strong>hedged</strong></p>
<pre><code class="language-go">func queryWithHedgedRequests(urls []string) string {
	ch := make(chan string, len(urls))
	for _, url := range urls {
		go func(u string, c chan string) {
			c &lt;- executeQuery(u)
		}(url, ch)

		select {
		case r := &lt;-ch:
			return r
		case &lt;-time.After(21 * time.Millisecond):
		}
	}

	return &lt;-ch
}
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204202248260.png" alt="" /></p>
<h2 id="ç»“è®º"><a class="header" href="#ç»“è®º">ç»“è®º</a></h2>
<p>ä»…ç”¨å‡ è¡Œä»£ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¤§å¹…æ”¹å–„å°¾éƒ¨å»¶è¿Ÿã€‚åœ¨å°†å…¶ç”¨ä½œç”Ÿäº§ç³»ç»Ÿä¹‹å‰ï¼Œè¯¥ç¤ºä¾‹è¿˜æœ‰å¾ˆå¤šéœ€è¦æ”¹è¿›çš„åœ°æ–¹ï¼Œä½†æ ¸å¿ƒå®ç°ä¸æ­¤æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚
è¯¥æŠ€æœ¯é’ˆå¯¹ä¸€ä¸ªéå¸¸å…·ä½“çš„é—®é¢˜ï¼Œåœ¨ç”¨äºå®é™…ç”Ÿäº§åº”ç”¨ä¹‹å‰åº”è¿›è¡Œå½»åº•åˆ†æã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://kerkour.com/why-not-rust</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/allenli178">å­æ®Š</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-rust"><a class="header" href="#ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨-rust">ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨ Rustï¼Ÿ</a></h1>
<p>æˆ‘éå¸¸ç›¸ä¿¡ Rust æ˜¯æé«˜è½¯ä»¶æ€§èƒ½å’Œå¯é æ€§çš„ä¸€å¤§æ­¥ï¼Œè¿™ä¸ä»…èƒ½è¿›ä¸€æ­¥åŠ é€Ÿè½¯ä»¶å¼€å‘ï¼Œè¿˜èƒ½èµšæ›´å¤šçš„ $$! Rust çš„ Immutable
å’Œè¾ƒå¥½çš„æŠ½è±¡èƒ½åŠ›èƒ½å¤Ÿæå¤§çš„ä¾¿åˆ©å¼€å‘è€…ã€‚</p>
<p>ä½†æ˜¯ä»»ä½•äº‹ç‰©æ€»æœ‰ä¸¤é¢æ€§ï¼ŒRust ä¸å¯èƒ½æ€»æ˜¯æœ€ä¼˜é€‰æ‹©ã€‚æˆ‘å°†åœ¨ä¸‹é¢è®¨è®ºä¸€äº›ä¸é€‚åˆä½¿ç”¨ Rust çš„åœºæ™¯ã€‚</p>
<h2 id="åŸå‹è®¾è®¡--é»‘å®¢æ¾"><a class="header" href="#åŸå‹è®¾è®¡--é»‘å®¢æ¾">åŸå‹è®¾è®¡ &amp; é»‘å®¢æ¾</a></h2>
<p>Rust è¯­è¨€æœ¬èº«æ›´å€¾å‘äºå¯é æ€§è€Œä¸æ˜¯å¼€å‘é€Ÿåº¦ã€‚å› æ­¤ï¼Œå¦‚æœä½ åªæœ‰ 1ï½2
å¤©çš„æ—¶é—´è¿›è¡Œå¼€å‘ï¼Œä½ åº”è¯¥æŠŠå®è´µçš„æ—¶é—´ç”¨åœ¨æ›´æœ‰ç”¨çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯èŠ±åœ¨æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œå¤„ç†æ¯ä¸€ä¸ªè¾¹ç¼˜æƒ…å†µä¸Šã€‚</p>
<p>ç›¸åï¼Œå¦‚æœä½ çš„é¡¹ç›®è¦å¼€å‘å‡ å‘¨ï¼ŒRust çš„å¯é æ€§èƒ½å¸®ä½ å‡è½»åæœŸçš„ç›‘æ§å’Œè°ƒè¯•çš„å‹åŠ›ï¼Œçœä¸‹å¤§æŠŠçš„æ—¶é—´å’Œé‡‘é’±ã€‚</p>
<h2 id="ç‹¬ç«‹å¼€å‘è€…"><a class="header" href="#ç‹¬ç«‹å¼€å‘è€…">ç‹¬ç«‹å¼€å‘è€…</a></h2>
<p>Rust çš„ç¬¬ä¸‰æ–¹åº“ç”Ÿæ€å°šä¸”å¹´è½»ã€‚å¦‚æœä½ æ˜¯ä¸€ä¸ªç‹¬ç«‹å¼€å‘è€…ï¼Œä½ å¯èƒ½åƒè¦å¤–åŒ…å°½å¯èƒ½å¤šçš„å·¥ä½œï¼Œå› æ­¤ Rust
å¯èƒ½ä¸æ˜¯æœ€é€‚åˆçš„ã€‚ä½ å¯èƒ½æ›´å–œæ¬¢ä½¿ç”¨ç”Ÿæ€å®Œå–„çš„è¯­è¨€ï¼Œä»–ä»¬æœ‰å¤§é‡å¼€ç®±å³ç”¨çš„ç¬¬ä¸‰æ–¹åº“ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼ŒRust çš„å¯é æ€§å…¶å®ä¹Ÿé™ä½äº†ç‹¬ç«‹å¼€å‘è€…å¯¹ç›‘æ§å’Œè°ƒè¯•çš„éœ€æ±‚ã€‚</p>
<h2 id="ä¸-saas-æœåŠ¡é›†æˆ"><a class="header" href="#ä¸-saas-æœåŠ¡é›†æˆ">ä¸ SaaS æœåŠ¡é›†æˆ</a></h2>
<p>å¦‚æœä½ çš„åº”ç”¨éœ€è¦ä¸ç¬¬ä¸‰æ–¹ API è¿›è¡Œäº¤äº’ï¼Œä½ åº”è¯¥ä½¿ç”¨é‚£äº›æœ‰å®˜æ–¹ SDK æ”¯æŒçš„è¯­è¨€ï¼Œæ¯”å¦‚ TypeSript æˆ–è€… Pythonã€‚</p>
<p>è¯è™½è¿™ä¹ˆè¯´ï¼Œç°åœ¨ AWS ä¹Ÿæœ‰äº†è®¸å¤šå®˜æ–¹çš„ Rust SDKï¼Œæˆ‘å¸Œæœ›æ›´å¤šçš„å…¬å¸èƒ½å¤Ÿå­¦ä¹ å¹¶æä¾› Rust SDKã€‚</p>
<h2 id="åªæ˜¯æƒ³å®Œæˆè€Œä¸æ˜¯åšåˆ°å®Œç¾"><a class="header" href="#åªæ˜¯æƒ³å®Œæˆè€Œä¸æ˜¯åšåˆ°å®Œç¾">åªæ˜¯æƒ³å®Œæˆè€Œä¸æ˜¯åšåˆ°å®Œç¾</a></h2>
<p>è€å®è¯´ï¼Œå¹¶éæ‰€æœ‰è½¯ä»¶éƒ½éœ€è¦ Rust æä¾›çš„å¯é æ€§å’Œæ€§èƒ½ã€‚æœ‰æ—¶å€™ï¼Œä¸€äº› bug æ˜¯å¯ä»¥æ¥å—çš„ï¼ŒRust åªä¼šè®©ä½ æ…¢ä¸‹æ¥ã€‚åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œæ‚¨åº”è¯¥ä¼šæ›´å–œæ¬¢åƒ Go
ç­‰æ›´æ— èŠçš„è¯­è¨€ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://thenewstack.io/using-rustlangs-async-tokio-runtime-for-cpu-bound-tasks/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/Akagi201">Akagi201</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡-1"><a class="header" href="#ä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡-1">ä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h1>
<p>å°½ç®¡ async é€šå¸¸éƒ½è¢«åº”ç”¨äºå¼‚æ­¥ç½‘ç»œ I/Oï¼Œä½†æ˜¯åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šåƒä½ ä»‹ç»ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ï¼ˆæ¯”å¦‚æ•°æ®åˆ†æå¼•æ“ç­‰ï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p>
<h2 id="tokio-æ˜¯ä»€ä¹ˆ-1"><a class="header" href="#tokio-æ˜¯ä»€ä¹ˆ-1">Tokio æ˜¯ä»€ä¹ˆï¼Ÿ</a></h2>
<p>Rust æœ¬èº«æä¾›äº†ä¸€ä¸ªç±»ä¼¼äº JavaScript çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹ã€‚</p>
<p>ä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸å’Œå¼‚æ­¥ I/Oã€‚ä¸€ä¸ªè¿è¡Œæ—¶æ˜¯å¿…é¡»çš„ï¼Œå°½ç®¡ç¤¾åŒºæœ‰å¾ˆå¤šå¼‚æ­¥è¿è¡Œæ—¶çš„é€‰æ‹©ï¼Œä½†æ˜¯ Tokio æ˜¯äº‹å®ä¸Šçš„æ ‡å‡†ã€‚å°½ç®¡ Tokio åœ¨å®˜ç½‘ä¸Šæè¿°åˆ°å®ƒæ˜¯
Rust è¯­è¨€çš„ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¹¶ä¸”æä¾›äº†ç¼–å†™ç½‘ç»œæœåŠ¡æ‰€éœ€è¦çš„æ¨¡å—ï¼Œå®ƒä¹Ÿå¯ä»¥è¢«ç”¨åœ¨å…¶å®ƒåœºæ™¯ã€‚</p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡-1"><a class="header" href="#ä¸ºä»€ä¹ˆä½¿ç”¨-tokio-å¤„ç†-cpu-å¯†é›†å‹ä»»åŠ¡-1">ä¸ºä»€ä¹ˆä½¿ç”¨ Tokio å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡</a></h2>
<p>ç°ä»£åŒ–çš„æ•°æ®åˆ†æå¼•æ“æ€»æ˜¯ä¸å¯é¿å…çš„è¦å¤„ç†æ¥è‡ªå®¢æˆ·ç«¯çš„ç½‘ç»œè¯·æ±‚ï¼Œä»¥åŠé€šè¿‡ç½‘ç»œå’Œå¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼ˆæ¯”å¦‚ ASW S3ã€GCP Cloudã€Azure
ç­‰ï¼‰è¿›è¡Œé€šä¿¡ã€‚å› æ­¤ï¼Œä»»ä½•ä½¿ç”¨ Rust å®ç°çš„ç³»ç»Ÿï¼Œå¤§å¤šéƒ½ä¼šç”¨ Tokio å»å¤„ç†è¿™éƒ¨åˆ†ç½‘ç»œç›¸å…³çš„æœåŠ¡ï¼Œæˆ–è€…æ˜¯ä¸€éƒ¨åˆ†æ–‡ä»¶ I/O æœåŠ¡ã€‚</p>
<p>é™¤äº†åº”å¯¹ç½‘ç»œå¤–ï¼Œæ•°æ®åˆ†æå¼•æ“è¿˜éœ€è¦åšå¤§é‡ç¹é‡çš„çš„ CPU è®¡ç®—ï¼Œæ¶ˆè€—å¤§é‡ CPU
èµ„æºå»è¿›è¡Œè¯¸å¦‚ï¼šé‡æ–°ç»„ç»‡æ•°æ®å­˜å‚¨ã€æå‰è®¡ç®—å„ç§ç´¢å¼•ã€æˆ–è€…æ˜¯ç›´æ¥å›å¤å®¢æˆ·ç«¯è¯·æ±‚ç­‰å·¥ä½œã€‚è¿™äº›å¤æ‚è®¡ç®—é€šå¸¸ä¼šè¢«åˆ‡æˆè®¸å¤šå•ç‹¬çš„å—ï¼ˆæˆ‘æŠŠå®ƒä»¬ç§°ä¸º
&quot;ä»»åŠ¡&quot;ï¼‰ï¼Œç„¶åè¢«å¹¶è¡Œçš„å¤„ç†ï¼Œä»¥åˆ©ç”¨åˆ°ç°ä»£ CPU çš„å¤šæ ¸ç‰¹æ€§ã€‚</p>
<p>ä»»åŠ¡è°ƒåº¦å™¨ä¼šå†³å®šå“ªä¸ªä»»åŠ¡åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™è¿è¡Œï¼Œå®ƒä¼šå°†ä»»åŠ¡æ˜ å°„åˆ°åˆé€‚çš„ CPU å†…æ ¸æˆ–è€…æ˜¯çº¿ç¨‹ä¸Šã€‚</p>
<p>å­¦æœ¯ç•Œå’Œå·¥ä¸šç•Œå¯¹äºå„ç§ä»»åŠ¡è°ƒåº¦å™¨ã€å·¥ä½œæ± ã€çº¿ç¨‹æ± ç­‰å·²ç»ç§¯ç´¯äº†å¾ˆå¤šå¹´çš„ç ”ç©¶ã€‚</p>
<p>æˆ‘è‡ªå·±å·²ç»å®ç°å¹¶ä¸”ä½¿ç”¨è¿‡å‡ ä¸ªè‡ªå®šä¹‰çš„ä»»åŠ¡è°ƒåº¦å™¨ã€‚ä»–ä»¬åœ¨å¤§å¤šæ•°æ—¶é—´ (99.9%)
éƒ½å·¥ä½œçš„å¾ˆå¥½ï¼Œä½†æ˜¯åœ¨å¤„ç†è¾¹ç¼˜æƒ…å†µï¼ˆæ¯”å¦‚å¿«é€Ÿåœæœºã€ä»»åŠ¡å–æ¶ˆã€æ¸…ç†ç­‰ï¼‰æ—¶ï¼Œä»–ä»¬çš„æ•ˆæœéå¸¸ä¸å°½äººæ„ã€‚ç”±äºè¿™äº›ä»»åŠ¡è°ƒåº¦å™¨ä½¿ç”¨äº†è¾ƒä½çº§åˆ«çš„çº¿ç¨‹åŸè¯­ï¼Œå‡ºç°çº¿ç¨‹é—´ç«äº‰çš„æƒ…å†µæ¯”æ¯”çš†æ˜¯ï¼Œæ‰€ä»¥æˆ‘ä¸å»ºè®®è¿™æ ·åšã€‚</p>
<p>å› æ­¤ï¼Œå½“æˆ‘åœ¨ Rust ç”Ÿæ€ä¸­å¯»æ‰¾ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨æ—¶ï¼Œä½ ä¼šå¾ˆè‡ªç„¶çš„é€‰æ‹© Tokioã€‚Tokio æœ‰å¾ˆå¤šä¼˜åŠ¿ï¼š</p>
<ol>
<li>ä½ åªéœ€è¦ Tokioï¼Œå¹¶ä¸éœ€è¦æ·»åŠ å…¶ä»–ä¾èµ–é¡¹ã€‚</li>
<li>Tokio å®ç°äº†ä¸€ä¸ªå¤æ‚çš„ <a href="https://tokio.rs/blog/2019-10-scheduler">æ”¯æŒä»»åŠ¡çªƒå–çš„è°ƒåº¦å™¨</a>ã€‚</li>
<li>Tokio å†…éƒ¨å®ç°äº†å¯¹ async/await çš„æ”¯æŒã€‚å¹¶ä¸”æœ‰è®¸å¤šç›¸å¯¹æˆç†Ÿçš„åº“å»å¤„ç†æµã€å¼‚æ­¥é”ã€ç®¡é“ã€å¼‚æ­¥å–æ¶ˆç­‰ã€‚</li>
<li>Tokio åœ¨ Rust ç”Ÿæ€ç³»ç»Ÿä¸­ç»è¿‡äº†è‰¯å¥½æµ‹è¯•ï¼Œå¹¶ä¸”æœ‰ç€å¤§é‡ä½¿ç”¨æ¡ˆä¾‹ã€‚</li>
<li>Tokio é€šå¸¸ä¼šå°†æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡å’Œ <code>Future</code> æ”¾åœ¨åŒä¸€ä¸ªæ‰§è¡Œå™¨å†…ï¼Œè¿™æœ‰åˆ©äºå®ç°å±€éƒ¨ç¼“å­˜ã€‚</li>
<li>Tokio çš„ <a href="https://tokio.rs/tokio/tutorial">æ–‡æ¡£</a> å¾ˆå®Œå–„ï¼Œå¹¶ä¸”åœ¨ç§¯ææ›´æ–°ç»´æŠ¤ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œé€‰æ‹© Tokio ä½œä¸º CPU å¯†é›†å‹ä»»åŠ¡çš„ä»»åŠ¡è°ƒåº¦ç¨‹åºæ˜¯ç†æ‰€åº”å½“çš„ï¼Œå¯¹å§ï¼ŸWROOOOOOOONGï¼</p>
<h2 id="ä½¿ç”¨-tokio-çš„åå¯¹æ„è§-1"><a class="header" href="#ä½¿ç”¨-tokio-çš„åå¯¹æ„è§-1">ä½¿ç”¨ Tokio çš„åå¯¹æ„è§</a></h2>
<p>é€‰æ‹© Tokio åœ¨æˆ‘ä»¬å›¢é˜Ÿä¸­å˜æˆäº†ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œåˆ°ç°åœ¨ä¾ç„¶ä¸æ˜¯æ‰€æœ‰äººéƒ½è®¤å¯è¿™ä¸ªå†³å®šã€‚åœ¨æˆ‘ä»¬åš DataFusion å’Œ InfluxDB IOx
çš„æ—©æœŸï¼Œæˆ‘ä»¬å¾ˆæ‹…å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›åå¯¹æ„è§ï¼š</p>
<h3 id="tokio-æ–‡æ¡£çš„è­¦å‘Š-1"><a class="header" href="#tokio-æ–‡æ¡£çš„è­¦å‘Š-1">Tokio æ–‡æ¡£çš„è­¦å‘Šï¼š</a></h3>
<p>è€ç‰ˆæœ¬çš„ Tokio æ–‡æ¡£ï¼ˆæ¯”å¦‚ 1.10 ç‰ˆï¼‰é‡Œé¢æœ‰ä¸€æ¡è‘—åçš„è­¦å‘Šï¼š</p>
<blockquote>
<p>If your code is CPU-bound and you wish to limit the number of threads used to
run it, you should run it on another thread pool such as Rayon.</p>
</blockquote>
<p>å¦‚æœä½ çš„ä»£ç è¦å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ï¼Œå¹¶ä¸”æƒ³è¦å°½é‡å‡å°‘ä½¿ç”¨åˆ°çš„çº¿ç¨‹æ•°ï¼Œä½ åº”è¯¥å°†è¿™äº›ä»»åŠ¡åˆ†é…åˆ°å¦ä¸€ä¸ªçº¿ç¨‹æ± æ¯”å¦‚ Rayonã€‚</p>
<p>è¿™ä¸ªè­¦å‘Šå¯¹æˆ‘ä»¬å›¢é˜Ÿå’Œç¤¾åŒºéƒ½é€ æˆäº†å¾ˆå¤§çš„å›°æƒ‘ã€‚å¾ˆå¤šäººè¯»äº†ä¹‹åéƒ½ä»¥ä¸º Tokio æ°¸è¿œä¸åº”è¯¥ç”¨æ¥å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ã€‚ä½†æ˜¯æ–‡æ¡£çš„å…³é”®å…¶å®æ˜¯è¯´ï¼Œä¸€ä¸ªè¿è¡Œæ—¶å®ä¾‹ï¼ˆåŒä¸€ä¸ªçº¿ç¨‹æ± ï¼‰ä¸åº”è¯¥åŒæ—¶ç”¨äº I/O å’Œ CPU
è®¡ç®—ï¼Œæˆ‘ä»¬ä¹‹åæ¾„æ¸…äº†<a href="https://docs.rs/tokio/1.14.0/tokio/#cpu-bound-tasks-and-blocking-code">æ–‡æ¡£</a>
çš„æ„å›¾ã€‚</p>
<blockquote>
<p>é¡ºä¾¿è¯´ä¸€å¥ï¼ŒTokio æ–‡æ¡£å»ºè®®ç”¨ Rayon å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡ã€‚Rayon
å¯¹äºå¾ˆå¤šç¨‹åºéƒ½æ˜¯å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ”¯æŒå¼‚æ­¥ã€‚å¦‚æœä½ çš„ä»£ç ä¸­å“ªæ€•åªæœ‰ä¸€ç‚¹éœ€è¦ä½¿ç”¨å¼‚æ­¥ï¼Œé‚£ä½ å°±ä¸å¾—ä¸è·¨è¿‡åŒæ­¥å’Œå¼‚æ­¥çš„ç—›è‹¦è¾¹ç•Œã€‚æˆ‘è¿˜å‘ç°å®ç°ä¸€ä¸ª
<a href="http://justinjaffray.com/query-engines-push-vs.-pull/">åŸºäºæ‹‰å–çš„æ‰§è¡Œå™¨æ¨¡å‹</a>
ä¼šæ›´å›°éš¾ï¼Œè¿™ç§æ¨¡å‹è¦æ±‚æŸä¸ªä»»åŠ¡å¿…é¡»ç­‰å¾…æ‰€æœ‰çš„è¾“å…¥éƒ½å‡†å¤‡å¥½åœ¨èƒ½åœ¨ Rayon ä¸­è¿è¡Œ</p>
</blockquote>
<h3 id="å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ -1"><a class="header" href="#å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ -1">å°¾éƒ¨å»¶è¿Ÿä¼šæ‹–ç´¯ä½ </a></h3>
<p>èªæ˜çš„äººä¼šè¯´ï¼šä½¿ç”¨ Tokio å¤„ç† CPU
å¯†é›†å‹ä»»åŠ¡ä¼šå¢åŠ è¯·æ±‚çš„<a href="https://medium.com/swlh/hedged-requests-tackling-tail-latency-9cea0a05f577">å°¾éƒ¨å»¶è¿Ÿ</a>ï¼Œè¿™æ˜¯éš¾ä»¥ä»¤äººæ¥å—çš„ã€‚</p>
<p>å°¾éƒ¨å»¶è¿Ÿï¼ŸğŸ™„</p>
<p>ä½ å¯èƒ½è®¤ä¸ºï¼šæˆ‘æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ•°æ®åº“ï¼Œå°¾éƒ¨å»¶è¿Ÿå¬èµ·æ¥åƒæ˜¯å¯¹äºé«˜è´Ÿè½½çš„ Web æœåŠ¡å™¨çš„ä¸€ä¸ªå­¦æœ¯é—®é¢˜â€¦â€¦â€</p>
<p>ä½†å…¶å®ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦è€ƒè™‘çš„ï¼šæ€è€ƒä¸€ä¸‹å¥åº·æ£€æŸ¥ï¼Œå¥åº·æ£€æŸ¥å¯¹äºä½¿ç”¨å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼ˆæ¯”å¦‚ Kubernetesï¼‰éƒ¨ç½²çš„æœåŠ¡æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æ£€æŸ¥çš„æ–¹å¼é€šå¸¸æ˜¯å‘é€ä¸€ä¸ª HTTP
è¯·æ±‚åˆ°æŸä¸ª API ï¼Œä¾‹å¦‚ <code>/health</code>ã€‚å¦‚æœè¯¥è¯·æ±‚å·²ç»è¢«åˆ†æ´¾åˆ°æŸä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä½†æ˜¯ Tokio æ­£åœ¨å¿™äºä½¿ç”¨ CPU è¿›è¡Œå¤§é‡æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œé‚£ä¹ˆ
Kubernetes å°†ä¸èƒ½åŠæ—¶å¾—åˆ° â€œç³»ç»Ÿæ­£å¸¸â€ çš„å“åº”ï¼Œä½ çš„è¿›ç¨‹å°±ä¼šè¢« K8s æ€æ­»ã€‚å› æ­¤å¾—åˆ°ç»“è®ºï¼šç”±äºå°¾éƒ¨å»¶è¿Ÿï¼Œä½ ä¸èƒ½å°† Tokio ç”¨äº CPU
å¯†é›†å‹ä»»åŠ¡ã€‚</p>
<p>ä½†æ˜¯ï¼Œå°±åƒ Tokio åœ¨æ–‡æ¡£ä¸­é˜è¿°çš„ï¼Œæƒ³è¦é˜²æ­¢ä½ çš„ç¨‹åºåœ¨ CPU å®Œå…¨é¥±å’Œçš„æƒ…å†µä¸‹è¢« K8s
è¯¯æ€ï¼Œä½ åº”è¯¥ä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ã€‚ä¸€ä¸ªç”¨æ¥æ‰§è¡Œå¯¹å°¾éƒ¨å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå°±æ¯”å¦‚å“åº” <code>/health</code> æ¥å£ã€‚å¦ä¸€ä¸ªç”¨æ¥æ‰§è¡Œ CPU
å¯†é›†å‹ä»»åŠ¡ã€‚è¿™äº›çº¿ç¨‹æ± çš„çš„æœ€ä½³çº¿ç¨‹æ•°éœ€è¦æ ¹æ®å…·ä½“éœ€æ±‚å»è°ƒæ•´ã€‚</p>
<p>å¦‚æœä½ å°† Tokio è¿è¡Œæ—¶åªæ˜¯è§†ä¸ºä¸€ä¸ªå¤æ‚ç‚¹çš„çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆä½¿ç”¨å¤šä¸ªè¿è¡Œæ—¶å®ä¾‹çš„æƒ³æ³•å¯èƒ½æ›´å®¹æ˜“æ¥å—ï¼Œæˆ‘ä»¬å°†åœ¨æœ€åä½¿ç”¨ä¸“ç”¨çš„æ‰§è¡Œå™¨æ¼”ç¤ºå¦‚ä½•å®ç°è¿™ä¸ªæƒ³æ³•ã€‚</p>
<h3 id="å•ä»»åŠ¡å¼€é”€å¾ˆé«˜-1"><a class="header" href="#å•ä»»åŠ¡å¼€é”€å¾ˆé«˜-1">å•ä»»åŠ¡å¼€é”€å¾ˆé«˜</a></h3>
<p>Tokio çš„æ¯ä¸ªä»»åŠ¡å¼€é”€å¾ˆé«˜ã€‚</p>
<p>å¯¹äºè¿™ç‚¹ï¼Œæˆ‘ä¸€ç‚¹ä¹Ÿä¸æƒŠè®¶ã€‚äººä»¬æ€»æ˜¯å¯ä»¥å®ç°æ¯” Tokio è¿è¡Œé€Ÿåº¦æ›´å¿«çš„çº¿ç¨‹æ± ã€‚ä½†æ˜¯ï¼Œè¿™äº›çº¿ç¨‹æ± å¹¶ä¸æ˜¯è¶³å¤Ÿç¨³å®šï¼Œéš¾ä»¥åº”å¯¹ç”Ÿäº§ç¯å¢ƒçš„è´Ÿè½½ï¼Œå¹¶ä¸”ä»–ä»¬ä¹Ÿä¸å…·å¤‡åƒ
Tokio ä¸€æ ·çš„åºå¤§ç”Ÿæ€ç³»ç»Ÿã€‚</p>
<p>åœ¨è®¸å¤šåœºæ™¯ä¸‹ï¼Œå•ä»»åŠ¡çš„å¼€é”€å¯ä»¥ä½¿ç”¨ â€œçŸ¢é‡åŒ–å¤„ç†â€
æ¥åˆ†æ‘Šã€‚æ„æ€æ˜¯æ¯ä¸ªä»»åŠ¡å›åŒæ—¶å¤„ç†å‡ åƒè¡Œæ•°æ®è€Œä¸æ˜¯å•å•ä¸€è¡Œï¼Œä½ éœ€è¦å°†ä»»åŠ¡åˆ†æˆåˆç†å¤§å°çš„å—ã€‚ä½ ä¹Ÿä¸èƒ½åˆ†æ‘Šæ‰€æœ‰å·¥ä½œåœºæ™¯ä¸‹çš„å¼€é”€ã€‚ä½†æ˜¯ï¼Œå¯¹äºæˆ‘ä»¬çš„ç¨‹åºå…³å¿ƒçš„å®ä¾‹æ¥è¯´ï¼ŒTokio
çš„ä»»åŠ¡å¼€é”€å·²ç»å¾®ä¹å…¶å¾®äº†</p>
<h2 id="å®è·µ-1"><a class="header" href="#å®è·µ-1">å®è·µ</a></h2>
<p>å‡è®¾ä½ å·²ç»è¢«è¯´æœäº†ä½¿ç”¨ Tokio å»å¤„ç† CPU å¯†é›†å‹ä»»åŠ¡æ˜¯å¯è¡Œçš„ã€‚ç°åœ¨ä½ åº”è¯¥æ€ä¹ˆåšï¼Ÿ</p>
<p>é¦–å…ˆï¼Œè‡³å…³é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œä½ çš„ä»£ç åº”è¯¥ç¬¦åˆä»¥ä¸‹åŸåˆ™ï¼šå¼‚æ­¥ä»£ç æ°¸è¿œä¸åº”è¯¥èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆï¼Œè¿™ä¸€ç‚¹è¯·å‚è€ƒ Alice Ryhl çš„
<a href="https://ryhl.io/blog/async-what-is-blocking/">Async: What is blocking?</a>ã€‚è¿™æ˜¯ä¸ºäº†è®©è°ƒåº¦å™¨æœ‰æœºä¼šå®‰æ’å…¶ä»–äº‹æƒ…ï¼Œæ¯”å¦‚ä»»åŠ¡çªƒå–ç­‰ã€‚</p>
<p>å½“ç„¶äº†ï¼Œè¿™ä¸ª â€œå¾ˆé•¿æ—¶é—´â€ å–å†³äºä½ çš„ç¨‹åºï¼›Ryhl å»ºè®®åœ¨ä¼˜åŒ–å“åº”çš„å°¾éƒ¨å»¶è¿Ÿæ—¶ï¼Œå•ä¸ªå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶é—´åº”è¯¥åœ¨ 10 ~ 100 å¾®ç§’ã€‚æˆ‘è®¤ä¸ºåœ¨é’ˆå¯¹ CPU
è¿›è¡Œä¼˜åŒ–æ—¶ 10~100 æ¯«ç§’ä¹Ÿèƒ½æœ‰ä¸é”™çš„æ•ˆæœã€‚ä½†æ˜¯åœ¨æˆ‘çš„æµ‹è¯•
<a href="https://github.com/alamb/rust_tokio_overhead">estimated per-task Tokio overhead</a>
ä¸­ï¼ŒTokio å•ä»»åŠ¡çš„å¼€é”€åœ¨çº¦ 10 çº³ç§’èŒƒå›´å†…ï¼Œå› æ­¤å‡ ä¹ä¸å¯èƒ½ç”¨ 10 æ¯«ç§’çš„ä»»åŠ¡æ¥æµ‹é‡ Tokio è¿è¡Œæ—¶å¼€é”€ã€‚</p>
<p>å…¶æ¬¡ï¼Œå°†ä»»åŠ¡åˆ†æ´¾åˆ°ä¸€ä¸ªå•ç‹¬çš„æ‰§è¡Œå™¨</p>
<h3 id="ä¸“ç”¨çš„æ‰§è¡Œå™¨-1"><a class="header" href="#ä¸“ç”¨çš„æ‰§è¡Œå™¨-1">ä¸“ç”¨çš„æ‰§è¡Œå™¨</a></h3>
<p>è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œæ¼”ç¤ºäº†æˆ‘ä»¬å¦‚ä½•åœ¨ InfluxDB IOx ä¸Šå°†ä»»åŠ¡åˆ†é…åˆ°ä¸€ä¸ªå•ç‹¬çš„ Tokio
è¿è¡Œæ—¶ä¸Šï¼ˆå®Œæ•´ä»£ç å¯ä»¥åœ¨æˆ‘ä»¬çš„<a href="https://github.com/influxdata/influxdb_iox/blob/fe155e15fb2ad166aee66b0458e63c24a8128dd4/query/src/exec/task.rs#L101-L118">ä»“åº“</a>é‡ŒæŸ¥çœ‹ï¼Œé‡Œé¢è¿˜æœ‰å…³äºæ¸…ç†ã€åœæœºã€åˆå¹¶çš„å†…å®¹ï¼‰</p>
<pre><code class="language-rs">pub struct DedicatedExecutor {
    state: Arc&lt;Mutex&lt;State&gt;&gt;,
}

/// Runs futures (and any `tasks` that are `tokio::task::spawned` by
/// them) on a separate Tokio Executor
struct State {
    /// Channel for requests -- the dedicated executor takes requests
    /// from here and runs them.
    requests: Option&lt;std::sync::mpsc::Sender&lt;Task&gt;&gt;,

    /// Thread which has a different Tokio runtime
    /// installed and spawns tasks there
    thread: Option&lt;std::thread::JoinHandle&lt;()&gt;&gt;,
}

impl DedicatedExecutor {
    /// Creates a new `DedicatedExecutor` with a dedicated Tokio
    /// executor that is separate from the threadpool created via
    /// `[tokio::main]`.
    pub fn new(thread_name: &amp;str, num_threads: usize) -&gt; Self {
        let thread_name = thread_name.to_string();

        let (tx, rx) = std::sync::mpsc::channel::&lt;Task&gt;();

        let thread = std::thread::spawn(move || {
            // Create a new Runtime to run tasks
            let runtime = Tokio::runtime::Builder::new_multi_thread()
                .enable_all()
                .thread_name(&amp;thread_name)
                .worker_threads(num_threads)
                // Lower OS priority of worker threads to prioritize main runtime
                .on_thread_start(move || set_current_thread_priority_low())
                .build()
                .expect(&quot;Creating Tokio runtime&quot;);

         // Pull task requests off the channel and send them to the executor
         runtime.block_on(async move {
                while let Ok(task) = rx.recv() {
                    Tokio::task::spawn(async move {
                        task.run().await;
                    });
                }

        let state = State {
            requests: Some(tx),
            thread: Some(thread),
        };

        Self {
            state: Arc::new(Mutex::new(state)),
        }
    }
</code></pre>
<p>è¿™æ®µä»£ç ä¼šåœ¨ä¸€ä¸ªæ–°çº¿ç¨‹ <code>std::thread</code>ï¼Œå¹¶åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ Tokio è¿è¡Œæ—¶ã€‚è¿è¡Œæ—¶ä¼šä» <code>channel</code> è·å–ä»»åŠ¡å¹¶è¿è¡Œã€‚</p>
<p>æ³¨æ„ï¼šè¿™ä¸ªæ–°çš„çº¿ç¨‹å¾ˆå…³é”®ï¼Œå¦‚æœä½ å°è¯•åœ¨ä¸»çº¿ç¨‹é‡Œæˆ–è€…æ˜¯ä»»ä½•å·²ç»åˆ›å»ºè¿‡ Tokio è¿è¡Œæ—¶çš„çº¿ç¨‹é‡Œå†æ¬¡åˆ›å»ºæ–°çš„è¿è¡Œæ—¶ï¼Œç¨‹åºå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå·²ç»æœ‰ä¸€ä¸ªè¿è¡Œæ—¶äº†ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°†ä»»åŠ¡åˆ†æ´¾åˆ°ç¬¬äºŒä¸ªè¿è¡Œæ—¶ã€‚</p>
<pre><code class="language-rs">impl DedicatedExecutor {

    /// Runs the specified Future (and any tasks it spawns) on the
    /// `DedicatedExecutor`.
    pub fn spawn&lt;T&gt;(&amp;self, task: T) -&gt; Job&lt;T::Output&gt;
    where
        T: Future + Send + 'static,
        T::Output: Send + 'static,
    {
        let (tx, rx) = tokio::sync::oneshot::channel();

        let fut = Box::pin(async move {
            let task_output = task.await;
            tx.send(task_output).ok()
        });
        let mut state = self.state.lock();
        let task = Task {
            fut,
        };

        if let Some(requests) = &amp;mut state.requests {
            // would fail if someone has started shutdown
            requests.send(task).ok();
        } else {
            warn!(&quot;tried to schedule task on an executor that was shutdown&quot;);
        }

        Job { rx, cancel }
    }
}
</code></pre>
<p>ä¸Šé¢çš„ä»£ç ä½¿ç”¨äº†ä¸€ä¸ªåä¸º Job çš„ç»“æ„ä½“ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹ Future çš„ç®€å•åŒ…è£…ï¼ŒJob èƒ½å¤Ÿå°† Future
çš„æ‰§è¡Œç»“æœä»å•ç‹¬çš„æ‰§è¡Œå™¨å†…ä¼ è¾“å›ä¸»çº¿ç¨‹ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ã€‚</p>
<pre><code class="language-rs">#[pin_project(PinnedDrop)]
pub struct Job&lt;T&gt; {
    #[pin]
    rx: Receiver&lt;T&gt;,
}

impl&lt;T&gt; Future for Job&lt;T&gt; {
    type Output = Result&lt;T, Error&gt;;

    fn poll(
        self: Pin&lt;&amp;mut Self&gt;,
        cx: &amp;mut std::task::Context&lt;'_&gt;,
    ) -&gt; std::task::Poll&lt;Self::Output&gt; {
        let this = self.project();
        this.rx.poll(cx)
    }
}
</code></pre>
<p>å°±æ˜¯è¿™æ ·ï¼ ä½ å¯ä»¥åœ¨
<a href="https://gist.github.com/alamb/bd0e086448ef9b438aeebd6f550e23ed">Github gist</a>
ä¸­æ‰¾åˆ°æ‰€æœ‰ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://lucumr.pocoo.org/2022/1/30/unsafe-rust/</p>
<p><strong>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></strong></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="æœªåˆå§‹åŒ–å†…å­˜unsafe-rust-å¤ªéš¾äº†"><a class="header" href="#æœªåˆå§‹åŒ–å†…å­˜unsafe-rust-å¤ªéš¾äº†">æœªåˆå§‹åŒ–å†…å­˜ï¼šunsafe Rust å¤ªéš¾äº†</a></h1>
<p>Rust
åœ¨å¾ˆå¤šæ„ä¹‰ä¸Šä¸ä»…ä»…æ˜¯ä¸€ä¸ªç°ä»£çš„ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå®ç”¨çš„è¯­è¨€ã€‚å®ƒæ‰¿è¯ºäº†è‡ªå·±çš„å®‰å…¨æ€§ï¼Œå¹¶ä¸”æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æ¡†æ¶ï¼Œä½¿å¾—åˆ›å»ºå®‰å…¨çš„æŠ½è±¡æˆä¸ºå¯èƒ½ï¼ŒåŒæ—¶è¿è¡Œæ—¶å¼€é”€å¾ˆå°ç”šè‡³ä¸º
0ã€‚ä½ å¯ä»¥ä½¿ç”¨ unsafe æ¥æ˜ç¡®çš„è„±ç¦»å®‰å…¨çš„ Rustã€‚</p>
<p>å¦‚æœä½ ä¹‹å‰çœ‹è¿‡è¿™ç¯‡æ–‡ç« ï¼Œä½ ä¼šæƒŠè®¶çš„å‘ç°ï¼Œå®ƒå’Œä¹‹å‰çš„ç‰ˆæœ¬å¤§ä¸ç›¸åŒã€‚è¿™ç¯‡æ–‡ç« çš„ä½œè€…æ˜¯è¢« unsafe
çš„è§„åˆ™æ‰€å›°æƒ‘çš„å—å®³è€…ã€‚æˆ‘åœ¨æ–‡ç« ä¸­å¢åŠ äº†ä¸€ä¸ªä¾‹å­ï¼Œç”¨æ¥æ›´å¥½çš„å±•ç¤ºå…¶ä¸­çš„é™·é˜±ã€‚æˆ‘ä¹‹å‰åœ¨ Twitter ä¸Šè¯´è¿‡ï¼Œç¼–å†™ unsafe Rust æ¯” C / C++
æ›´å›°éš¾ï¼Œæ‰€ä»¥æˆ‘æƒ³ä¸ºæˆ‘çš„è§‚ç‚¹ä½œå‡ºä¸€äº›è§£é‡Šã€‚</p>
<h2 id="ä»-c-åˆ°-rust"><a class="header" href="#ä»-c-åˆ°-rust">ä» C åˆ° Rust</a></h2>
<p>æˆ‘ä»¬ä»ä¸‹é¢çš„ä¾‹å­å¼€å§‹ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªå¾…åˆå§‹åŒ–çš„ç»“æ„ä½“ã€‚æ¯”è¾ƒæœ‰è¶£çš„å­—æ®µæ˜¯
<code>name</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå·²ç»åˆ†é…å¥½çš„å­—ç¬¦ä¸²ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåˆ†é…åˆ°å“ªé‡Œå¯¹æˆ‘ä»¬å¹¶ä¸é‡è¦ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªç»“æ„ä½“è‡ªèº«åˆ†é…åœ¨æ ˆä¸Šã€‚æˆ‘ä»¬çš„æƒ³æ³•æ˜¯ï¼Œå½“è¿™ä¸ªç»“æ„ä½“è¢«åˆå§‹åŒ–ä¹‹åï¼Œå®ƒå°±å¯ä»¥è¢«å®‰å…¨çš„ä¼ é€’å’Œæ‰“å°ã€‚</p>
<pre><code class="language-cpp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;stdbool.h&gt;

struct role {
    char *name;
    bool disabled;
    int flag;
};

int main() {
    struct role r;
    r.name = strdup(&quot;basic&quot;);
    r.flag = 1;
    r.disabled = false;
    printf(&quot;%s (%d, %s)\n&quot;, r.name, r.flag, r.disabled ? &quot;true&quot; : &quot;false&quot;);
    free(r.name);
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ Rust å»å®ç°ä¸Šé¢çš„ä»£ç ã€‚ç°åœ¨æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿‡å¤šçš„å…³æ³¨ Rust
æ–‡æ¡£ï¼Œåªéœ€è¦ä¸“æ³¨äºä¸€å¯¹ä¸€ç¿»è¯‘å³å¯ã€‚åœ¨ä½ é˜…è¯»ä¸‹é¢çš„ä»£ç ä¹‹å‰è¿˜æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼šæˆ‘ä»¬æ­£åœ¨æœ‰æ„çš„åˆ›å»ºä¸€ä¸ªå¯¹ Rust ç¨‹åºå‘˜æ›´ç†Ÿæ‚‰çš„å¯¹è±¡ï¼Œå¹¶ä¸”å¯ä»¥è¢«çœ‹ä½œå…¬å…±
APIã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œç›´æ¥ä½¿ç”¨ Stringï¼Œè€Œä¸æ˜¯ C è¯­è¨€çš„å­—ç¬¦ä¸²ã€‚</p>
<pre><code class="language-rs">use std::mem;

struct Role {
    name: String,
    disabled: bool,
    flag: u32,
}

fn main() {
    let role = unsafe {
        let mut role: Role = mem::zeroed();
        role.name = &quot;basic&quot;.to_string();
        role.flag = 1;
        role.disabled = false;
        role
    };

    println!(&quot;{} ({}, {})&quot;, role.name, role.flag, role.disabled);
}
</code></pre>
<p>çœ‹åˆ°è¿™é‡Œï¼Œç«‹å³å°±æœ‰äººæƒ³é—®ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆéœ€è¦
unsafeï¼Ÿå½“ç„¶äº†ï¼Œä½ çš„ç¡®ä¸éœ€è¦ã€‚ä½†æ˜¯è¿™æ®µä»£ç ä½¿ç”¨äº†ä¸€ä¸ªå‡½æ•°ï¼š<code>std::mem::zeroed</code>ã€‚å¦‚æœä½ å°è¯•åœ¨æœ€è¿‘çš„ Rust
ç¼–è¯‘å™¨è¿è¡Œï¼Œåº”è¯¥ä¼šçš„å¾—åˆ°è¿™ä¸ªé”™è¯¯ï¼š</p>
<pre><code class="language-rs">thread 'main' panicked at 'attempted to zero-initialize type `Role`,
  which is invalid', src/main.rs:11:30
</code></pre>
<p>è€ç‰ˆæœ¬çš„ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯é‚£å…¶å®ä¹Ÿæ˜¯é”™è¯¯çš„ã€‚æ€ä¹ˆè§£å†³å‘¢ï¼Ÿç¼–è¯‘å™¨åˆä¸€æ¬¡å‘Šè¯‰æˆ‘ä»¬è§£å†³ä¹‹æ³•ï¼š</p>
<pre><code class="language-rs">warning: the type `Role` does not permit zero-initialization
  --&gt; src/main.rs:11:30
   |
11 | let mut role: Role = mem::zeroed();
   |                      ^^^^^^^^^^^^^
   |                      |
   |                      this code causes undefined behavior when executed
   |                      help: use `MaybeUninit&lt;T&gt;` instead, and only call
   |                         `assume_init` after initialization is done
   |
</code></pre>
<p>ä¸ºä»€ä¹ˆ <code>Role</code> ç±»å‹ä¸æ”¯æŒä½¿ç”¨ 0 åˆå§‹åŒ–å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æ”¹åŠ¨é‚£äº›ä»£ç ï¼Ÿæˆ‘ä»¬èƒ½ä¸èƒ½ä¸åˆå§‹åŒ–ï¼Ÿ</p>
<p>æœ‰äººå¯èƒ½ä¼šæƒ³ï¼Œä½¿ç”¨ <code>#[repr(C)]</code> å¼ºåˆ¶ç»“æ„ä½“ä½¿ç”¨ C è¯­è¨€çš„å†…å­˜å¸ƒå±€ï¼Œä½†æ˜¯è¿™ä¸èƒ½è§£å†³é—®é¢˜ã€‚æ­£å¦‚ç¼–è¯‘å™¨ç»™å‡ºçš„å»ºè®®ï¼Œæˆ‘ä»¬éœ€è¦
<code>MaybeUninit</code>ã€‚</p>
<pre><code class="language-rs">use std::mem::MaybeUninit;

struct Role {
    name: String,
    disabled: bool,
    flag: u32,
}

fn main() {
    let role = unsafe {
        let mut uninit = MaybeUninit::&lt;Role&gt;::zeroed();
        let role = uninit.as_mut_ptr();
        (*role).name = &quot;basic&quot;.to_string();
        (*role).flag = 1;
        (*role).disabled = false;
        uninit.assume_init()
    };

    println!(&quot;{} ({}, {})&quot;, role.name, role.flag, role.disabled);
}
</code></pre>
<p>å°† <code>zeroed</code> æ¢ä¸º <code>MaybeUninit::zeroed</code> ä¹‹åï¼Œä¸€åˆ‡éƒ½å˜äº†ã€‚ç°åœ¨æˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨ç»“æ„ä½“ï¼Œè€Œæ˜¯è¦æ“ä½œä¸€ä¸ªè£¸æŒ‡é’ˆã€‚ç”±äºè£¸æŒ‡é’ˆæ²¡æœ‰å®ç°
<code>deref</code>ï¼Œå¹¶ä¸” Rust ä¸­æ²¡æœ‰ <code>-&gt;</code> æ“ä½œç¬¦ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è§£å¼•ç”¨ï¼Œå¹¶ç”¨è¿™ç§ç¬¨æ‹™çš„è¯­æ³•åˆ†é…æ¯ä¸€ä¸ªå­—æ®µã€‚</p>
<p>é¦–å…ˆï¼šè¿™æ ·åšå¯è¡Œå—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ä½†æ˜¯å®ƒæ­£ç¡®å—ï¼Ÿä¸æ­£ç¡®ã€‚</p>
<p>ç­”æ¡ˆåœ¨äºï¼Œä»»ä½•åƒå¯å˜å¼•ç”¨ï¼ˆ&amp;mutï¼‰æˆ–è€…æ˜¯æ ˆä¸Šçš„å€¼æœ¬èº«è¿™æ ·çš„æ„é€ ï¼Œåœ¨ unsafe ä»£ç ä¹‹å¤–ä»ç„¶éœ€è¦ä¸€ç›´å¤„äºæœ‰æ•ˆçš„çŠ¶æ€ã€‚<code>zeroed</code> è¿”å›ä¸€ä¸ªå€¼ä¸º 0
çš„ç»“æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ä¿è¯å®ƒå¯ä»¥æœ‰æ•ˆçš„è¡¨ç¤ºç»“æ„ä½“æˆ–è€…ä»»ä½•å…¶ä¸­çš„å­—æ®µã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„å­—ç¬¦ä¸²åœ¨æ‰€æœ‰å†…å®¹è¢«æ¸…é›¶çš„æƒ…å†µä¸‹æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯è¿™å¹¶ä¸èƒ½ä¿è¯ï¼Œè€Œä¸”æ˜¯æœªå®šä¹‰è¡Œä¸ºã€‚</p>
<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸€ä¸ªå¯å˜å¼•ç”¨æ°¸è¿œä¸èƒ½æŒ‡å‘ä¸€ä¸ªæ— æ•ˆçš„å¯¹è±¡ï¼Œæ‰€ä»¥åœ¨å¯¹è±¡çš„æ‰€æœ‰å­—æ®µéƒ½è¢«åˆå§‹åŒ–ä¹‹å‰ï¼Œä¸‹é¢çš„æ“ä½œæ˜¯é”™è¯¯çš„ï¼š</p>
<pre><code class="language-rs">let role = &amp;mut *uninit.as_mut_ptr()
</code></pre>
<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æŠŠ <code>zeroed</code> æ”¹ä¸º <code>uninit</code>ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡è¿è¡Œï¼Œç¨‹åºå°±ä¼šå´©æºƒã€‚</p>
<pre><code class="language-rs">// let mut uninit = MaybeUninit::&lt;Role&gt;::uninit();
free(): invalid pointer
</code></pre>
<p>ä¸ºä»€ä¹ˆä¼šå´©æºƒå‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œé€šè¿‡ç»™ name èµ‹å€¼ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä¹Ÿ drop äº†ä¹‹å‰çš„æ—§å­—ç¬¦ä¸²ã€‚æˆ‘ä»¬ä¹‹å‰åªæ˜¯ç¢°å·§æ²¡æœ‰é‡åˆ°è¿™ç§æƒ…å†µï¼Œå› ä¸º Drop
ç¢°å·§èƒ½å¤Ÿå¤„ç†ä¸€ä¸ªè¢«æ¸…é›¶çš„å­—ç¬¦ä¸²ã€‚ä½†ç°åœ¨ï¼Œæˆ‘ä»¬æ·±å…¥äº†æœªå®šä¹‰è¡Œä¸ºã€‚æˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦ä»¥æŸç§æ–¹å¼ç›´æ¥å°†å­—ç¬¦ä¸²å†™åˆ°é‚£é‡Œçš„æŒ‡é’ˆã€‚</p>
<p>æˆ‘ä»¬é¦–å…ˆè¦æ¥å— MaybeUninit æ˜¯å¿…è¦çš„ï¼Œç°åœ¨æˆ‘ä»¬è¦å¤„ç†è¿™é‡Œçš„è£¸æŒ‡é’ˆã€‚è¿™æœ‰äº›éº»çƒ¦ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯ç‰¹åˆ«éš¾ã€‚ç°åœ¨æˆ‘ä»¬æœ‰ä¸¤ä¸ªæ–°é—®é¢˜ï¼šæˆ‘ä»¬çŸ¥é“ <code>&amp;mut X</code>
æ˜¯ä¸å…è®¸çš„ï¼Œä½†æ˜¯ <code>*mut X</code> æ˜¯å…è®¸çš„ã€‚æˆ‘ä»¬å¦‚ä½•åœ¨ä¸ä½¿ç”¨ <code>&amp;mut X</code> çš„æƒ…å†µä¸‹å¾—åˆ°ä¸€ä¸ª <code>*mut X</code>? è®½åˆºçš„æ˜¯ï¼Œåœ¨ Rust 1.51
ä¹‹å‰ï¼Œå†ä¸æ‰“ç ´ä»»ä½•è§„åˆ™ä¹‹å‰ï¼Œè¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†æ˜¯ç°åœ¨ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>addr_of_mut!</code> å®ã€‚</p>
<pre><code class="language-rs">let name_ptr = std::ptr::addr_of_mut!((*role).name);
</code></pre>
<p>å¤ªæ£’äº†ï¼Œç°åœ¨æˆ‘ä»¬æ‹¿åˆ°äº† name çš„æŒ‡é’ˆï¼Œå¦‚ä½•å†™å…¥å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>write</code> æ–¹æ³•ã€‚</p>
<pre><code class="language-rs">addr_of_mut!((*role).name).write(&quot;basic&quot;.to_string());
</code></pre>
<p>ç°åœ¨å®Œæˆäº†å—ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨æ™®é€šç»“æ„ä½“çš„å—ï¼Ÿå¦‚æœé˜…è¯»ä¸€ä¸‹æ–‡æ¡£ï¼Œä½ å°±ä¼šå‘ç°ï¼Œç»“æ„ä½“çš„å†…å­˜å¸ƒå±€æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚äº‹å®è¡¨æ˜ï¼Œ<a href="https://github.com/rust-lang/reference/issues/1151">å°½ç®¡ç›®å‰çš„æ–‡æ¡£æ˜¯è¿™æ ·è¯´çš„</a>ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¾é å­—æ®µçš„å¯¹é½æ€§ã€‚å¦‚æœæˆ‘ä»¬å¤„ç†çš„æ˜¯
<code>#[repr(packed)]</code>ï¼Œæˆ‘ä»¬å°±å¿…é¡»ä½¿ç”¨ <code>write_unaligned</code> æ–¹æ³•æ¥ä»£æ›¿ã€‚å¦‚æœ Rust
é€‰æ‹©çš„ç»“æ„ä½“çš„ä¸€ä¸ªæˆå‘˜æ˜¯ä¸å¯¹é½çš„ï¼Œè¿™æ˜¯åˆæ³•çš„ã€‚</p>
<p>æœ€ç»ˆçš„ä»£ç ï¼š</p>
<pre><code class="language-rs">use std::mem::MaybeUninit;
use std::ptr::addr_of_mut;

struct Role {
    name: String,
    disabled: bool,
    flag: u32,
}

fn main() {
    let role = unsafe {
        let mut uninit = MaybeUninit::&lt;Role&gt;::uninit();
        let role = uninit.as_mut_ptr();
        addr_of_mut!((*role).name).write(&quot;basic&quot;.to_string());
        (*role).flag = 1;
        (*role).disabled = false;
        uninit.assume_init()
    };

    println!(&quot;{} ({}, {})&quot;, role.name, role.flag, role.disabled);
}
</code></pre>
<h2 id="ä»€ä¹ˆæ—¶å€™ç”¨-addr_of_mut"><a class="header" href="#ä»€ä¹ˆæ—¶å€™ç”¨-addr_of_mut">ä»€ä¹ˆæ—¶å€™ç”¨ <code>addr_of_mut!</code></a></h2>
<p>ä¸€èˆ¬æœ‰ä¸¤ç§æƒ…å†µï¼šæœªåˆå§‹åŒ–çš„å†…å­˜ï¼Œæœªå¯¹é½çš„å¼•ç”¨ã€‚Rust
ä¸å…è®¸ç”¨æˆ·åˆ›å»ºä¸€ä¸ªæœªå¯¹é½çš„å¼•ç”¨ï¼ˆå³æ—¶åªæ˜¯æš‚æ—¶çš„ï¼‰ï¼ŒåŒæ—¶ä¹Ÿä¸å…è®¸åˆ›å»ºä¸€ä¸ªå¯¹æœªåˆå§‹åŒ–å†…å­˜çš„å¼•ç”¨ã€‚é‚£ä¹ˆï¼Œè¿™äº›å¼•ç”¨æ˜¯ä»€ä¹ˆæ—¶å€™è¢«åˆ›å»ºçš„å‘¢ï¼Ÿ</p>
<p>å¯¹äºä¸‹é¢çš„ä»£ç ï¼š<code>(*flag).flag = 1</code>ï¼Œæ ¹æ® Rust çš„è§„åˆ™ï¼Œå¦‚æœä¸€ä¸ªç±»å‹æ²¡æœ‰å®ç° Dropï¼Œè¿™æ˜¯å¯ä»¥çš„ã€‚å¦‚æœè¯¥ç±»å‹å®ç°äº†
Dropï¼Œè¿™è¡Œä»£ç ä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼šå½“ <code>Drop::drop</code> è¢«è°ƒç”¨æ—¶ï¼Œå¹¶ä¸”è°ƒç”¨åœ¨æœªåˆå§‹åŒ–çš„å†…å­˜ä¸Šï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦
<code>addr_of_mut!</code>ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ä¸º flag å­—æ®µèµ‹å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬å´éœ€è¦é€šè¿‡ <code>addr_of_mut!</code> æ¥è·å– name
å­—æ®µï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<h2 id="maybeuninit"><a class="header" href="#maybeuninit">MaybeUninit</a></h2>
<p>å¯¹å®‰å…¨çš„ç†è§£éšç€æ—¶é—´çš„æ¨ç§»è€Œä¸æ–­æ”¹å˜ã€‚æ›¾ç»ï¼Œ<code>mem::uninitialized</code> è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå¥å…¨çš„ APIï¼Œä½†æ˜¯åœ¨åæ¥ï¼Œ<code>MaybeUninit</code>
è¢«å¼•å…¥å»è§£å†³å‘ç°çš„ç¼ºç‚¹ã€‚ä½†æ˜¯ï¼Œç”±äºéƒ¨åˆ†åˆå§‹åŒ–çš„ç±»å‹çš„å­˜åœ¨ï¼ŒMaybeUninit åœ¨å®è·µä¸­å¹¶ä¸ç†æƒ³ã€‚è™½ç„¶ç”±äº <code>#[repr(transparent)]</code>ï¼Œ
MaybeUninit å’Œ T æ˜¯å†…å­˜å…¼å®¹çš„ï¼Œä½†æ˜¯åœ¨åµŒå¥—ä½¿ç”¨æ—¶çš„æ•ˆæœå¹¶ä¸ä½³ã€‚</p>
<p>æœ‰æ—¶ä½ éœ€è¦ç»“æ„ä½“çš„æŸä¸ªå­—æ®µä¸Šæœ‰ä¸€ä¸ª MaybeUninitï¼Œä½†æ˜¯åªåä½ åˆå¸Œæœ›è¿™ä¸ªæŠ½è±¡ä¸å­˜åœ¨ï¼Œè¿™ç§æƒ…å†µå¹¶ä¸ç½•è§ã€‚å®é™…ä¸Šï¼Œåœ¨å®è·µä¸­ä½¿ç”¨ MaybeUninit
æ˜¯ä¸€ä¸ªå……æ»¡æŒ‘æˆ˜çš„ä½“éªŒï¼Œä½†æ˜¯è¿™ç¯‡æ–‡ç« å¹¶æ²¡æœ‰ä½“ç°å‡ºæ¥ã€‚</p>
<h2 id="æˆ‘çš„-unsafe-ä»£ç æ­£ç¡®å—"><a class="header" href="#æˆ‘çš„-unsafe-ä»£ç æ­£ç¡®å—">æˆ‘çš„ unsafe ä»£ç æ­£ç¡®å—ï¼Ÿ</a></h2>
<p>åœ¨ 2022 å¹´ï¼Œæˆ‘æ‰¿è®¤ï¼Œæˆ‘ä¸å†å¯¹ç¼–å†™ Rust ä»£ç æ„Ÿåˆ°è‡ªä¿¡ã€‚unsafe çš„è§„åˆ™å¯èƒ½å¯èƒ½éƒ½æ˜¯å¦‚æ­¤å¤æ‚ï¼Œä½†æ˜¯ä»æˆ‘å¤šå¹´æ¥é˜…è¯»è¿‡çš„ unsafe ä»£ç æ¥è¯´ï¼Œå¤§å¤šæ•°
unsafe ä»£ç éƒ½ä¸å¤ªå…³å¿ƒè¿™äº›è§„åˆ™ï¼Œå¹¶ä¸”æ— è§†äº†å®ƒä»¬ã€‚<code>addr_of_mut!</code>ç›´åˆ° 1.53 æ‰è¢«æ·»åŠ åˆ°è¯­è¨€ä¸­æ˜¯æœ‰åŸå› çš„ã€‚å³ä½¿åˆ°äº†ä»Šå¤©ï¼Œæ–‡æ¡£ä¸­éƒ½è¯´å®ƒ
Rust ç»“æ„ä½“ repr çš„å¯¹é½æ–¹å¼æ²¡æœ‰ä»»ä½•ä¿è¯ã€‚</p>
<p>åœ¨è¿‡å»çš„å‡ å¹´é‡Œï¼Œä¼¼ä¹å‘ç”Ÿäº†è¿™æ ·çš„äº‹æƒ…ï¼šRust å¼€å‘è€…åœ¨å®è·µä¸­ç¼–å†™ unsafe
è¶Šæ¥è¶Šå›°éš¾ï¼Œç°åœ¨çš„è§„åˆ™æ˜¯å¦‚æ­¤å¤æ‚ï¼Œä»¥è‡³äºå¯¹ä¸€ä¸ªéšæ„çš„ç¨‹åºå‘˜æ¥è¯´éå¸¸éš¾ä»¥ç†è§£ï¼Œå›´ç»•ä»–çš„æ–‡æ¡£ä¹Ÿå¾ˆå®¹æ˜“è¢«æ›²è§£ã€‚æˆ‘åœ¨è¿™ç¯‡æ–‡ç« çš„<a href="https://github.com/mitsuhiko/lucumr/blob/48440d3cf151f0d774bc9ad62f903034ca2b30ff/2022/1/30/unsafe-rust.rst">ä¸Šä¸€ä¸ªç‰ˆæœ¬</a>ä¸­è®¤ä¸º
<code>addr_of_mut!</code> çš„ä¸€äº›ä½¿ç”¨æ˜¯å¿…è¦çš„ï¼Œä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤ã€‚åœ¨æœ‰äººæŒ‡å‡ºè¿™ä¸ªé”™è¯¯ä¹‹å‰ï¼Œæ–‡ç« å·²ç»å¾—åˆ°äº†å¤§é‡å…³æ³¨ã€‚</p>
<p>è¿™äº›è§„åˆ™ä½¿å¾— Rust æœ€å¥½çš„åŠŸèƒ½ä¹‹ä¸€è¶Šæ¥è¶Šéš¾ä»¥æ¥è¿‘ï¼ŒåŒæ—¶ä¹Ÿè¶Šæ¥è¶Šéš¾ä»¥ç†è§£ã€‚è¦æ±‚å­˜åœ¨ MaybeUninitï¼Œè€Œä¸ä»…ä»…æ˜¯è¿‡å»çš„
mem::uninitialized API æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä½†æ˜¯å´å±•ç¤ºäº†è¯­è¨€è§„åˆ™æ˜¯å¤šä¹ˆçš„å¤æ‚ã€‚</p>
<p>æˆ‘ä¸è®¤ä¸ºè¿™æ˜¯å¥½çš„ã€‚äº‹å®ä¸Šï¼Œæˆ‘è®¤ä¸ºè¿™æ ¹æœ¬ä¸æ˜¯ä¸€ä¸ªå¥½çš„è¶‹åŠ¿ï¼Œå¥½åƒè¶Šæ¥è¶Šå°‘çš„äººäº†è§£ unsafe Rustã€‚ä¸ C çš„äº’æ“ä½œæ€§æ˜¯è®© Rust
ä¼Ÿå¤§çš„ä¸€ä¸ªåŸå› ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨æ­£åœ¨åˆ›å»ºå·¨å¤§çš„å±éšœï¼Œè¿™æ˜¯ä¸å¯å–çš„ã€‚æ›´é‡è¦çš„æ˜¯ï¼šç¼–è¯‘å™¨åœ¨æŒ‡å‡ºæˆ‘çš„é”™è¯¯æ—¶æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©ã€‚</p>
<p>è®© unsafe å˜å¾—æ›´ç¬¦åˆäººä½“å·¥ç¨‹å­¦æ˜¯ä¸€ä¸ªå›°éš¾çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒå€¼å¾—è¢«è§£å†³ã€‚å› ä¸ºæœ‰ä¸€ç‚¹å¾ˆæ˜ç¡®ï¼šäººä»¬ä¸ä¼šå¾ˆå¿«åœæ­¢ç¼–å†™ unsafe ä»£ç ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-å…­è¾¹å½¢æ¶æ„"><a class="header" href="#rust-å…­è¾¹å½¢æ¶æ„">Rust å…­è¾¹å½¢æ¶æ„</a></h1>
<h2 id="å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»"><a class="header" href="#å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»">å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»</a></h2>
<p>å…­è¾¹å½¢æ¶æ„ï¼Œæ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚ä¾ç…§è¿™ç§æ¶æ„åˆ›å»ºçš„ç¨‹åºï¼Œèƒ½å¤Ÿåœ¨æ²¡æœ‰ UI
æˆ–æ•°æ®åº“çš„æƒ…å†µä¸‹æ­£å¸¸å·¥ä½œã€‚æ‰€ä»¥å³ä½¿æ²¡æœ‰æ•°æ®åº“ä½ ä¾ç„¶å¯ä»¥è¿›è¡Œå¼€å‘å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œè€Œä¸”æ— éœ€å…¶ä»–ç”¨æˆ·å‚ä¸ã€‚</p>
<h3 id="ç«¯å£ä¸é€‚é…å™¨"><a class="header" href="#ç«¯å£ä¸é€‚é…å™¨">ç«¯å£ä¸é€‚é…å™¨</a></h3>
<p>å…­è¾¹å½¢æ¶æ„ä¹Ÿå«åšç«¯å£ä¸é€‚é…å™¨æ¶æ„ã€‚</p>
<p><img src="https://alistair.cockburn.us/wp-content/uploads/2018/02/Hexagonal-architecture-complex-example.gif" alt="" /></p>
<p>ä»€ä¹ˆæ˜¯ç«¯å£ï¼Ÿ</p>
<p>ç«¯å£æŒ‡çš„æ˜¯å…­è¾¹å½¢çš„è¾¹ï¼Œå±äºåº”ç”¨ç¨‹åºçš„å†…éƒ¨ï¼Œæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å…¥å£å’Œå‡ºå£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œè¡¨ç¤ºè®¾å¤‡å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ç”¨ä¾‹ã€‚åœ¨ Rust é‡Œå°±æ˜¯ç”±ä¸€ä¸ª
Traitï¼Œä»¥åŠä¸€äº› DTO ç»„æˆ</p>
<p>ä»€ä¹ˆæ˜¯é€‚é…å™¨ï¼Ÿ</p>
<p>é€‚é…å™¨å›´ç»•ç€ç«¯å£ç¼–å†™ï¼Œèƒ½å¤Ÿå°†è¾“å…¥è½¬åŒ–ä¸ºç¬¦åˆç«¯å£çš„ç±»å‹ï¼Œå¹¶æŠŠè¾“å…¥è½¬åŒ–ä¸ºç”¨ç”¨ç¨‹åºå†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ã€‚æ¢å¥è¯è¯´å°±æ˜¯ <code>controller</code> æˆ–è€…æ˜¯å‘½ä»¤è¡Œä¸€æ¡å‘½ä»¤å¤„ç†å™¨ã€‚</p>
<p>å½“ä»»ä½•å¤–éƒ¨è®¾å¤‡ (æ¯”å¦‚ï¼šWEBï¼ŒAPPï¼Œç»ˆç«¯ï¼Œæµ‹è¯•...)
æƒ³è¦è®¿é—®è¾“å…¥ç«¯å£æ—¶ï¼Œé¦–å…ˆè¿™ä¸ªè¾“å…¥ä¼šè¢«è¯¥è®¾å¤‡å¯¹åº”çš„è¾“å…¥é€‚é…å™¨ï¼Œè½¬åŒ–ä¸ºç¬¦åˆè¦æ±‚çš„å¯ç”¨çš„æ–¹æ³•è°ƒç”¨ï¼Œæˆ–è€…æ˜¯æ¶ˆæ¯ï¼Œç„¶åå†ä¼ é€’ç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å‘å¤–å‘é€æ•°æ®æ—¶ï¼Œé¦–å…ˆå®ƒä¼šæŠŠæ•°æ®é€šè¿‡è¾“å‡ºç«¯å£ä¼ é€’ç»™è¾“å‡ºé€‚é…å™¨ï¼Œç„¶åå†ä¼ é€’ç»™è¾“å‡ºå¯¹è±¡ (æ¯”å¦‚ï¼šæ•°æ®åº“ï¼Œmockï¼ŒAPIï¼Œé‚®ä»¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—...)</p>
<p>å› æ­¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¤–éƒ¨æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚</p>
<h3 id="åº”ç”¨ç¨‹åºæ ¸å¿ƒ"><a class="header" href="#åº”ç”¨ç¨‹åºæ ¸å¿ƒ">åº”ç”¨ç¨‹åºæ ¸å¿ƒ</a></h3>
<p>ä½¿ç”¨å…­è¾¹å½¢æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸è¢«ç§°ä½œåŸŸï¼ŒåŸŸä¸­æœ‰ä¸‰ä¸ªæ ¸æ¦‚å¿µï¼š</p>
<ul>
<li>å®ä½“ (Entities)ï¼šåªæ˜¯ç®€å•çš„å®šä¹‰äº†å¯¹è±¡ã€‚</li>
<li>äº¤äº’å™¨ (Interactors)ï¼šå®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœ¬æ–‡é‡Œæˆ‘ä»¬ä¼šå°†å…¶ç§°ä¸ºç”¨ä¾‹ Usecaseã€‚</li>
<li>å­˜å‚¨åº“ (Repositories)ï¼šåªå®šä¹‰äº†æ“ä½œå®ä½“çš„æ–¹æ³•ã€‚</li>
</ul>
<h3 id="ä¼˜ç‚¹"><a class="header" href="#ä¼˜ç‚¹">ä¼˜ç‚¹</a></h3>
<p>åœ¨ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„ä¸­ï¼Œåªèƒ½ä»ä¸Šå¾€ä¸‹è°ƒç”¨ã€‚</p>
<p>è€Œç°åœ¨æˆ‘ä»¬æŠŠæ¥å£ä¿ç•™åœ¨åŸŸä¸­ï¼ŒåŸŸä¸å†ä¾èµ–å¤–éƒ¨çš„å¤–éƒ¨å®ç°ã€‚ä¿è¯äº†å¤–éƒ¨è®¾å¤‡æ˜¯å¯æ›¿æ¢çš„ã€‚å½“ä¸šåŠ¡é€»è¾‘éœ€è¦ç”¨åˆ°æ•°æ®å­˜å‚¨æ—¶ï¼Œç›´æ¥è°ƒç”¨æŠ½è±¡æ¥å£å³å¯ã€‚</p>
<h2 id="å°†è¦åšäº›ä»€ä¹ˆ"><a class="header" href="#å°†è¦åšäº›ä»€ä¹ˆ">å°†è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></h2>
<p>åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å°†ä¼šå®ç°ä¸€ä¸ª pokemon æœåŠ¡ã€‚ä¸»è¦åŠŸèƒ½æ˜¯å¢åŠ ã€åˆ é™¤å’ŒæŸ¥è¯¢ã€‚</p>
<p>ä¸ºäº†ä½“ç°å…­è¾¹å½¢æ¶æ„çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬å°†ä¼šå®ç°ä¸¤å¥—ç”¨æˆ·æ¥å£ï¼ŒåŒ…æ‹¬ HTTP API å’Œ CLIã€‚ä¸‰å¥—å­˜å‚¨åº“ï¼ŒåŒ…æ‹¬å†…å­˜ï¼ŒSQLite æ•°æ®åº“å’Œ Airtable
(ä¸€ä¸ªåœ¨çº¿è¡¨æ ¼åº”ç”¨)ã€‚</p>
<p>å…­è¾¹å½¢æ¶æ„çš„æ ¸å¿ƒä¸éœ€è¦ä¾èµ–äºå…·ä½“çš„å­˜å‚¨åº“æˆ–è€…æ˜¯ç”¨æˆ·æ¥å£ï¼Œä¸ºäº†æˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿç¨³å®šè¿è¡Œï¼Œæˆ‘ä»¬ä¹Ÿä¼šéå¸¸æ³¨é‡äºå•å…ƒæµ‹è¯•ã€‚ä¸€æ—¦æˆ‘ä»¬çš„åŸŸç¨³å®šä¸‹æ¥ï¼Œå®ç°ç”¨æˆ·æ¥å£ï¼Œæ›¿æ¢å­˜å‚¨åº“éƒ½ä¼šæ˜¯éå¸¸ç®€å•å¿«é€Ÿçš„ã€‚</p>
<h2 id="é¡¹ç›®ç»“æ„"><a class="header" href="#é¡¹ç›®ç»“æ„">é¡¹ç›®ç»“æ„</a></h2>
<pre><code>src/
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ cli
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ entities.rs
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ main.rs
â””â”€â”€ repositories
    â”œâ”€â”€ mod.rs
    â””â”€â”€ pokemon.rs
</code></pre>
<p>å…­è¾¹å½¢æ¶æ„çš„æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸è¢«ç§°ä½œåŸŸï¼Œå°±æ˜¯ä¸‹é¢çš„ <code>domain</code> æ¨¡å—ï¼Œé‡Œé¢åŒ…æ‹¬å®ä½“çš„å®šä¹‰å’Œç”¨ä¾‹çš„å®ç°ã€‚<code>api</code> å’Œ <code>cli</code>
æ˜¯ä¸¤å¥—ç”¨æˆ·æ¥å£ã€‚<code>repositories</code> ä¸­åˆ™æ˜¯å­˜å‚¨åº“çš„å®šä¹‰ä¸å®ç°</p>
<h2 id="å»¶ç”³é˜…è¯»"><a class="header" href="#å»¶ç”³é˜…è¯»">å»¶ç”³é˜…è¯»</a></h2>
<ul>
<li><a href="https://alistair.cockburn.us/hexagonal-architecture/">å…­è¾¹å½¢æ¶æ„ ( hexagonal-architecture )</a></li>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">å¹²å‡€æ¶æ„ ( the-clean-architecture )</a></li>
<li><a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">æ´‹è‘±æ¶æ„ ( The Onion Architecture )</a></li>
<li><a href="https://herbertograca.com/2017/07/03/the-software-architecture-chronicles/">è½¯ä»¶æ¶æ„ç¼–å¹´å² ( The Software Architecture Chronicles )</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-4/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-09-02---rust-å…­è¾¹å½¢æ¶æ„-4---é‡æ„"><a class="header" href="#2021-09-02---rust-å…­è¾¹å½¢æ¶æ„-4---é‡æ„">2021-09-02 - Rust å…­è¾¹å½¢æ¶æ„ #4 - é‡æ„</a></h1>
<p>è¿™ç¯‡æ–‡ç« æ˜¯ä¸‹é¢ç³»åˆ—çš„ä¸€éƒ¨åˆ†</p>
<ul>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-1/">Hexagonal architecture in Rust #1 - Domain</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-2/">Hexagonal architecture in Rust #2 - In-memory repository</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-3/">Hexagonal architecture in Rust #3 - HTTP API</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-4/">Hexagonal architecture in Rust #4 - Refactoring</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-5/">Hexagonal architecture in Rust #5 - Remaining use-cases</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-6/">Hexagonal architecture in Rust #6 - CLI</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-7/">Hexagonal architecture in Rust #7 - Long-lived repositories</a></li>
</ul>
<p>å—¨ï¼Œåˆæ˜¯æˆ‘ï¼èµ·åˆï¼Œæˆ‘æƒ³å®ç°æˆ‘ä»¬ä»ç„¶éœ€è¦å¤„ç†çš„å‰©ä½™çš„ç”¨ä¾‹ã€‚ä½†è¿™å°†ä¼šæ˜¯ä¸‹ä¸€æ¬¡çš„å†…å®¹ã€‚ä»Šå¤©æˆ‘ä»¬å°†åšä¸€äº›é‡æ„ :)</p>
<h2 id="å¼€å§‹ä¹‹å‰"><a class="header" href="#å¼€å§‹ä¹‹å‰">å¼€å§‹ä¹‹å‰</a></h2>
<p>æˆ‘åšäº†ä¸¤ä¸ªæˆ‘åœ¨ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æ²¡æœ‰çœ‹åˆ°çš„æ›´æ”¹ã€‚åœ¨ <code>domain/entities.rs</code> ä¸­ï¼Œæˆ‘ç”¨ Self æ›¿æ¢äº† u16ï¼š</p>
<pre><code class="language-rs">impl From&lt;PokemonNumber&gt; for u16 {
    fn from(n: PokemonNumber) -&gt; Self {
        n.0
    }
}
</code></pre>
<p>åœ¨ <code>repositories/pokemons.rs</code> ä¸­ï¼Œæˆ‘åœ¨ <code>with_error</code> ä¸Šæ·»åŠ äº†ä¸€ä¸ªæµ‹è¯•æ³¨é‡Šï¼š</p>
<pre><code class="language-rs">impl InMemoryRepository {
    #[cfg(test)]
    pub fn with_error(self) -&gt; Self {
        Self {
            error: true,
            ..self
        }
    }
}
</code></pre>
<p>è®©æˆ‘ä»¬ç°åœ¨è¿›è¡Œé‡æ„ :)</p>
<h2 id="ä½¿ç”¨-result-æ›¿æ¢è‡ªå®šä¹‰æšä¸¾"><a class="header" href="#ä½¿ç”¨-result-æ›¿æ¢è‡ªå®šä¹‰æšä¸¾">ä½¿ç”¨ <code>Result</code> æ›¿æ¢è‡ªå®šä¹‰æšä¸¾</a></h2>
<p>ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰æšä¸¾ä½œä¸ºç”¨ä¾‹å’Œ å­˜å‚¨åº“ çš„è¿”å›å€¼ï¼Œç°åœ¨æŠŠä»–ä»¬é‡æ„ä¸º Resultã€‚</p>
<h3 id="æ›´æ”¹ç”¨ä¾‹çš„è¿”å›å€¼ç±»å‹"><a class="header" href="#æ›´æ”¹ç”¨ä¾‹çš„è¿”å›å€¼ç±»å‹">æ›´æ”¹ç”¨ä¾‹çš„è¿”å›å€¼ç±»å‹</a></h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†ç”¨ä¾‹çš„è¿”å›å€¼æš‚æ—¶è®¾ç½®ä¸º 500 ä»¥æ–¹ä¾¿æµ‹è¯•ã€</p>
<pre><code class="language-rs">pub fn serve(repo: Arc&lt;dyn Repository&gt;, req: &amp;rouille::Request) -&gt; rouille::Response {
    let req = ...
    rouille::Response::from(Status::InternalServerError)
    // match create_pokemon::execute(repo, req) {
    //     create_pokemon::Response::Ok(number) =&gt; rouille::Response::json(&amp;Response { number }),
    //     create_pokemon::Response::BadRequest =&gt; rouille::Response::from(Status::BadRequest),
    //     create_pokemon::Response::Conflict =&gt; rouille::Response::from(Status::Conflict),
    //     create_pokemon::Response::Error =&gt; rouille::Response::from(Status::InternalServerError),
    // }
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å°†æµ‹è¯•çš„è¿”å›å€¼ä¿®æ”¹ä¸º Result ç±»å‹ï¼š</p>
<pre><code class="language-rs">    #[test]
    fn it_should_return_a_bad_request_error_when_request_is_invalid() {
        ...
        match res {
            Err(Error::BadRequest) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }

    #[test]
    fn it_should_return_a_conflict_error_when_pokemon_number_already_exists() {
        ...
        match res {
            Err(Error::Conflict) =&gt; {}
            _ =&gt; unreachable!(),
        }
    }

    #[test]
    fn it_should_return_an_unknown_error_when_an_unexpected_error_happens() {
        ...
        match res {
            Err(Error::Unknown) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }

    #[test]
    fn it_should_return_the_pokemon_number_otherwise() {
        ...
        match res {
            Ok(res_number) =&gt; assert_eq!(res_number, number),
            _ =&gt; unreachable!(),
        };
    }
}
</code></pre>
<p>æ¥ç€å†ä¿®æ”¹ç”¨ä¾‹ï¼ŒæŠŠå®ƒçš„è¿”å›å€¼ä¿®æ”¹ä¸º Resultï¼š</p>
<pre><code class="language-rs">pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;u16, Error&gt; {
    ...
        (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
            Insert::Ok(number) =&gt; Ok(u16::from(number)),
            Insert::Conflict =&gt; Err(Error::Conflict),
            Insert::Error =&gt; Err(Error::Unknown),
        },
        _ =&gt; Err(Error::BadRequest),
    }
}
</code></pre>
<p>æµ‹è¯•ç°åœ¨åº”è¯¥é€šè¿‡äº†ï¼</p>
<pre><code>cargo test
running 4 tests
test it_should_return_a_conflict_error_when_pokemon_number_already_exists ... ok
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
test it_should_return_the_pokemon_number_otherwise ... ok
</code></pre>
<p>æœ€åå†å»ä¿®æ”¹æˆ‘ä»¬çš„ APIï¼š</p>
<pre><code class="language-rs">pub fn serve(repo: Arc&lt;dyn Repository&gt;, req: &amp;rouille::Request) -&gt; rouille::Response {
    let req = ...
    match create_pokemon::execute(repo, req) {
        Ok(number) =&gt; rouille::Response::json(&amp;Response { number }),
        Err(create_pokemon::Error::BadRequest) =&gt; rouille::Response::from(Status::BadRequest),
        Err(create_pokemon::Error::Conflict) =&gt; rouille::Response::from(Status::Conflict),
        Err(create_pokemon::Error::Unknown) =&gt; rouille::Response::from(Status::InternalServerError),
    }
}
</code></pre>
<p>Usecase ä¿®æ”¹å®Œæˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å»å¤„ç† Reposity</p>
<h3 id="æ›´æ”¹-repository-çš„è¿”å›ç±»å‹"><a class="header" href="#æ›´æ”¹-repository-çš„è¿”å›ç±»å‹">æ›´æ”¹ Repository çš„è¿”å›ç±»å‹</a></h3>
<p>Repository æ²¡æœ‰æµ‹è¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»ä¿®æ”¹ç”¨ä¾‹è°ƒç”¨ repo çš„è¿”å›å€¼å¼€å§‹ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::{InsertError, ...};

...
pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;u16, Error&gt; {
    ...
        (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
            Ok(number) =&gt; Ok(u16::from(number)),
            Err(InsertError::Conflict) =&gt; Err(Error::Conflict),
            Err(InsertError::Unknown) =&gt; Err(Error::Unknown),
        },
        _ =&gt; Err(Error::BadRequest),
    }
}
</code></pre>
<p>åœ¨å®å¯æ¢¦ç¼–å·å†²çªçš„æµ‹è¯•æ—¶ï¼Œæ‚¨åº”è¯¥å°† <code>.ok()</code> æ·»åŠ åˆ°å­˜å‚¨åº“ insert æ“ä½œä¹‹åã€‚ç°åœ¨è®©æˆ‘ä»¬åœ¨ <em>repositories/pokemon.rs</em>
ä¸­åˆ é™¤ <code>Insert</code> å¹¶åˆ›å»º <code>InsertError</code>ï¼š</p>
<pre><code class="language-rs">pub enum InsertError {
    Conflict,
    Unknown,
}
</code></pre>
<p>æœ€ååœ¨æ›´æ”¹ <code>Repository</code> Trait å’Œ <code>InMemoryRepository</code> çš„è¿”å›å€¼ç±»å‹å³å¯ï¼š</p>
<pre><code class="language-rs">pub trait Repository: Send + Sync {
    fn insert(&amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;PokemonNumber, InsertError&gt;;
}

impl Repository for InMemoryRepository {
    fn insert(
        &amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;PokemonNumber, InsertError&gt; {
        if self.error {
            return Err(InsertError::Unknown);
        }

        let mut lock = match self.pokemons.lock() {
            Ok(lock) =&gt; lock,
            _ =&gt; return Err(InsertError::Unknown),
        };

        if lock.iter().any(|pokemon| pokemon.number == number) {
            return Err(InsertError::Conflict);
        }

        let number_clone = number.clone();
        lock.push(Pokemon::new(number_clone, name, types));
        Ok(number)
    }
}
</code></pre>
<h2 id="å¡«åŠ ä¸€ä¸ªæ–°çš„ç”¨ä¾‹"><a class="header" href="#å¡«åŠ ä¸€ä¸ªæ–°çš„ç”¨ä¾‹">å¡«åŠ ä¸€ä¸ªæ–°çš„ç”¨ä¾‹</a></h2>
<p>åœ¨å¸¸è§„çš„ HTTP API ä¸­ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œæˆ‘é€šå¸¸ä¼šæŠŠè¿™ä¸ªå¯¹è±¡åœ¨è¿”å›å›å»ã€‚ç‰¹åˆ«æ˜¯å½“è¿”å›çš„å¯¹è±¡ä¸­åŒ…å«ä¸€åˆ‡å‰ç«¯æ²¡æœ‰ä¼ æ¥çš„å­—æ®µã€‚æ¯”å¦‚ <code>create_at</code>
ç­‰ç”±å­˜å‚¨åº“æ·»åŠ çš„å­—æ®µã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘éœ€è¦ä½ åƒæˆ‘ä»¬ä¸€å¼€å§‹é‚£æ ·æš‚æ—¶æ³¨é‡Šæ‰ <code>api/create_pokemon.rs</code>ã€‚ä»¥ä¾¿äºæˆ‘ä»¬ä¸“æ³¨äºæµ‹è¯•ã€‚</p>
<p>åœ¨ <em>domain/create_pokemon.rs</em> ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„æµ‹è¯•ï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_the_pokemon_number_otherwise() {
    let repo = Arc::new(InMemoryRepository::new());
    let req = Request {
        number: 25,
        name: String::from(&quot;Pikachu&quot;),
        types: vec![String::from(&quot;Electric&quot;)],
    };

    let res = execute(repo, req);

    match res {
        Ok(Response {
            number,
            name,
            types,
        }) =&gt; {
            assert_eq!(number, 25);
            assert_eq!(name, String::from(&quot;Pikachu&quot;));
            assert_eq!(types, vec![String::from(&quot;Electric&quot;)]);
        }
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>åŒæ—¶åˆ›å»ºä¸€ä¸ª <code>Response</code> ç»“æ„ä½“</p>
<pre><code class="language-rs">pub struct Response {
    pub number: u16,
    pub name: String,
    pub types: Vec&lt;String&gt;,
}
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹ <code>execute</code> å‡½æ•°ï¼Œåœ¨æ’å…¥æˆåŠŸæ—¶åº”è¯¥è¿”å› <code>Pokemon</code> çš„æ‰€æœ‰å­—æ®µï¼š</p>
<pre><code class="language-rs">use crate::domain::entities::{Pokemon, ...};

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;Response, Error&gt; {
    ...
        (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
            Ok(Pokemon {
                number,
                name,
                types,
            }) =&gt; Ok(Response {
                number: u16::from(number),
                name: String::from(name),
                types: Vec::&lt;String&gt;::from(types),
            }),
            Err(InsertError::Conflict) =&gt; Err(Error::Conflict),
            Err(InsertError::Unknown) =&gt; Err(Error::Unknown),
        },
        _ =&gt; Err(Error::BadRequest),
    }
}
</code></pre>
<p>åœ¨ <code>insert</code> æ‰§è¡ŒæˆåŠŸåï¼Œç›´æ¥è¿”å›ä¸€ä¸ª <code>Pokemon</code> ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">pub trait Repository: Send + Sync {
    fn insert(
        &amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;Pokemon, InsertError&gt;;
}

impl Repository for InMemoryRepository {
    fn insert(
        &amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;Pokemon, InsertError&gt; {
        ...
        let pokemon = Pokemon::new(number, name, types);
        lock.push(pokemon.clone());
        Ok(pokemon)
    }
}
</code></pre>
<p>ä¸ºäº†ä½¿ <code>pokemon.clone()</code> èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸º <code>Pokemon</code> å®ç° <code>Clone</code> Traitï¼š</p>
<pre><code class="language-rs">#[derive(Clone)]
pub struct PokemonName(String);

#[derive(Clone)]
pub struct PokemonTypes(Vec&lt;PokemonType&gt;);

#[derive(Clone)]
enum PokemonType {

#[derive(Clone)]
pub struct Pokemon {
</code></pre>
<p>ç°åœ¨å­˜å‚¨åº“çš„æ’å…¥é€»è¾‘å·²ç»å®Œæˆï¼Œç”¨ä¾‹å¸Œæœ›èƒ½å¤Ÿç›´æ¥æ‹¿åˆ° <code>Pokemon</code> çš„ <code>name</code> å’Œ <code>types</code> å­—æ®µï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸¤ä¸ªå­—ç«¯ä¹Ÿè½¬ä¸ºå…¬å¼€çš„ï¼š</p>
<pre><code class="language-rs">pub struct Pokemon {
    pub number: PokemonNumber,
    pub name: PokemonName,
    pub types: PokemonTypes,
}
</code></pre>
<p>æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦ä¸º <code>Response</code> å®ç°ç±»å‹è½¬æ¢ï¼Œä» <code>PokemonNumber</code> è½¬æ¢ä¸º <code>u16</code>ã€ä» <code>PokemonName</code> è½¬æ¢ä¸º
<code>String</code>ã€ä» <code>PokemonTypes</code> è½¬æ¢ä¸º <code>Vec&lt;String&gt;</code>:</p>
<pre><code class="language-rs">impl From&lt;PokemonName&gt; for String {
    fn from(n: PokemonName) -&gt; Self {
        n.0
    }
}

impl From&lt;PokemonTypes&gt; for Vec&lt;String&gt; {
    fn from(pts: PokemonTypes) -&gt; Self {
        let mut ts = vec![];
        for pt in pts.0.into_iter() {
            ts.push(String::from(pt));
        }
        ts
    }
}

impl From&lt;PokemonType&gt; for String {
    fn from(t: PokemonType) -&gt; Self {
        String::from(match t {
            PokemonType::Electric =&gt; &quot;Electric&quot;,
            PokemonType::Fire =&gt; &quot;Fire&quot;,
        })
    }
}
</code></pre>
<p>ç°åœ¨æµ‹è¯•åº”è¯¥èƒ½å¤Ÿé€šè¿‡äº†ï¼š</p>
<pre><code>cargo test
running 4 tests
test it_should_return_a_conflict_error_when_pokemon_number_already_exists ... ok
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
test it_should_return_the_pokemon_number_otherwise ... ok
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬å»æ›´æ–° api çš„å†…å®¹ï¼š</p>
<pre><code class="language-rs">#[derive(Serialize)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn serve(repo: Arc&lt;dyn Repository&gt;, req: &amp;rouille::Request) -&gt; rouille::Response {
    let req = ...
    match create_pokemon::execute(repo, req) {
        Ok(create_pokemon::Response {
            number,
            name,
            types,
        }) =&gt; rouille::Response::json(&amp;Response {
            number,
            name,
            types,
        }),
        Err(create_pokemon::Error::BadRequest) =&gt; rouille::Response::from(Status::BadRequest),
        Err(create_pokemon::Error::Conflict) =&gt; rouille::Response::from(Status::Conflict),
        Err(create_pokemon::Error::Unknown) =&gt; rouille::Response::from(Status::InternalServerError),
    }
}
</code></pre>
<p><code>cargo run</code> ä¹‹åï¼Œå†æ¬¡å‘ server å‘é€æ•°æ®ï¼š</p>
<pre><code class="language-json">{
  &quot;number&quot;: 17,
  &quot;name&quot;: &quot;Charmander&quot;,
  &quot;types&quot;: [
    &quot;Fire&quot;
  ]
}
</code></pre>
<h2 id="åˆ›å»ºä¸€äº›æµ‹è¯•å€¼"><a class="header" href="#åˆ›å»ºä¸€äº›æµ‹è¯•å€¼">åˆ›å»ºä¸€äº›æµ‹è¯•å€¼</a></h2>
<p>ä½ å–œæ¬¢åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ä½¿ç”¨ <code>PokemonName::try_from(String::from(&quot;Pikachu&quot;)).unwrap()</code>
ä¹‹ç±»çš„ä¸œè¥¿å—ï¼Ÿè®©æˆ‘ä»¬åœ¨ <em>domain/entities.rs</em> ä¸­åˆ›å»ºä¸€äº›å‡½æ•°ï¼š</p>
<h3 id="å®å¯æ¢¦ç¼–å·"><a class="header" href="#å®å¯æ¢¦ç¼–å·">å®å¯æ¢¦ç¼–å·</a></h3>
<pre><code class="language-rs">#[cfg(test)]
impl PokemonNumber {
    pub fn pikachu() -&gt; Self {
        Self(25)
    }

    pub fn charmander() -&gt; Self {
        Self(4)
    }
}
</code></pre>
<h3 id="å®å¯æ¢¦åå­—"><a class="header" href="#å®å¯æ¢¦åå­—">å®å¯æ¢¦åå­—</a></h3>
<pre><code class="language-rs">#[cfg(test)]
impl PokemonName {
    pub fn pikachu() -&gt; Self {
        Self(String::from(&quot;Pikachu&quot;))
    }

    pub fn charmander() -&gt; Self {
        Self(String::from(&quot;Charmander&quot;))
    }

    pub fn bad() -&gt; Self {
        Self(String::from(&quot;&quot;))
    }
}
</code></pre>
<h3 id="å®å¯æ¢¦ç±»å‹"><a class="header" href="#å®å¯æ¢¦ç±»å‹">å®å¯æ¢¦ç±»å‹</a></h3>
<pre><code class="language-rs">#[cfg(test)]
impl PokemonTypes {
    pub fn pikachu() -&gt; Self {
        Self(vec![PokemonType::Electric])
    }

    pub fn charmander() -&gt; Self {
        Self(vec![PokemonType::Fire])
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬åœ¨ç”¨ä¾‹æµ‹è¯•ä¸­ä½¿ç”¨è¿™äº›æµ‹è¯•å€¼ã€‚é¦–å…ˆä¸º <code>Request</code> æ·»åŠ ä¸€ä¸ªæµ‹è¯•ç”¨çš„ <code>new</code> æ–¹æ³•ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´è½»æ¾çš„æ¨¡æ‹Ÿä¸€ä¸ªè¯·æ±‚ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
mod tests {
    ...

    impl Request {
        fn new(number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Self {
            Self {
                number: u16::from(number),
                name: String::from(name),
                types: Vec::&lt;String&gt;::from(types),
            }
        }
    }
}
</code></pre>
<p>æ¥ä¸‹æ¥å°±æ˜¯å„ç§çš„æµ‹è¯•ï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_a_bad_request_error_when_request_is_invalid() {
    ...
    let req = Request::new(
        PokemonNumber::pikachu(),
        PokemonName::bad(),
        PokemonTypes::pikachu(),
    );
    ...
}

#[test]
fn it_should_return_a_conflict_error_when_pokemon_number_already_exists() {
    ...
    repo.insert(
        PokemonNumber::pikachu(),
        PokemonName::pikachu(),
        PokemonTypes::pikachu(),
    )
    .ok();
    let req = Request::new(
        PokemonNumber::pikachu(),
        PokemonName::charmander(),
        PokemonTypes::charmander(),
    );
    ...
}

#[test]
fn it_should_return_an_unknown_error_when_an_unexpected_error_happens() {
    ...
    let req = Request::new(
        PokemonNumber::pikachu(),
        PokemonName::pikachu(),
        PokemonTypes::pikachu(),
    );
    ...
}

#[test]
fn it_should_return_the_pokemon_otherwise() {
    ...
    let req = Request::new(
        PokemonNumber::pikachu(),
        PokemonName::pikachu(),
        PokemonTypes::pikachu(),
    );
    ...
    match res {
        Ok(res) =&gt; {
            assert_eq!(res.number, u16::from(PokemonNumber::pikachu()));
            assert_eq!(res.name, String::from(PokemonName::pikachu()));
            assert_eq!(res.types, Vec::&lt;String&gt;::from(PokemonTypes::pikachu()));
        }
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>æˆ‘ä»¬ç»ˆäºå®Œæˆäº†è¿™ä¸ªæ¼«é•¿çš„é‡æ„ï¼Œå¸Œæœ›ä¸€åˆ‡é¡ºåˆ© :) æˆ‘ä¿è¯ï¼Œä¸‹æ¬¡æˆ‘ä»¬å°†å»å®ç°ä¸€äº›æ–°çš„ç”¨ä¾‹ï¼</p>
<p>ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-4">Github</a> ä¸ŠæŸ¥çœ‹</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-2/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-08-24---rust-å…­è¾¹å½¢æ¶æ„-2---å†…å­˜ä¸­çš„å­˜å‚¨åº“"><a class="header" href="#2021-08-24---rust-å…­è¾¹å½¢æ¶æ„-2---å†…å­˜ä¸­çš„å­˜å‚¨åº“">2021-08-24 - Rust å…­è¾¹å½¢æ¶æ„ #2 - å†…å­˜ä¸­çš„å­˜å‚¨åº“</a></h1>
<p>è¿™ç¯‡æ–‡ç« æ˜¯ä¸‹é¢ç³»åˆ—çš„ä¸€éƒ¨åˆ†</p>
<ul>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-1/">Hexagonal architecture in Rust #1 - Domain</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-2/">Hexagonal architecture in Rust #2 - In-memory repository</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-3/">Hexagonal architecture in Rust #3 - HTTP API</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-4/">Hexagonal architecture in Rust #4 - Refactoring</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-5/">Hexagonal architecture in Rust #5 - Remaining use-cases</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-6/">Hexagonal architecture in Rust #6 - CLI</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-7/">Hexagonal architecture in Rust #7 - Long-lived repositories</a></li>
</ul>
<blockquote>
<p>å…è´£å£°æ˜ï¼šåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å¯¹å­˜å‚¨åº“ä¼šä½¿ç”¨åˆ°ä¸€ä¸ªç®€å•çš„å¯å˜å¼•ç”¨ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬åªæ˜¯åœ¨æµ‹è¯•ä¸­ä½¿ç”¨å®ƒã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä¼šè¿›è¡Œä¸€äº›ä¼˜åŒ– : )</p>
</blockquote>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¼€å§‹æ­å»ºåŸºæœ¬çš„é¡¹ç›®æ¶æ„ã€‚æˆ‘ä»¬å·²ç»æœ‰äº†åŸŸæ¨¡å—ï¼Œé‡Œé¢åŒ…å«ä¸€ä¸ªç”¨ä¾‹å’Œä¸€äº›å®ä½“ï¼š</p>
<pre><code>src
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ create_pokemon.rs
â”‚   â”œâ”€â”€ entities.rs
â”‚   â””â”€â”€ mod.rs
â””â”€â”€ main.rs
</code></pre>
<h2 id="å†…å­˜å­˜å‚¨åº“"><a class="header" href="#å†…å­˜å­˜å‚¨åº“">å†…å­˜å­˜å‚¨åº“</a></h2>
<p>è®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„ <code>create_pokemon</code> ç”¨ä¾‹ã€‚
ç›®å‰ï¼Œå®ƒå¯ä»¥åœ¨æˆåŠŸæ—¶è¿”å›å®å¯æ¢¦çš„æ•°é‡ï¼Œå½“è¯·æ±‚å‚æ•°ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™æ—¶ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚ç°åœ¨æˆ‘ä»¬å¹¶æ²¡æœ‰ä¸€ä¸ªå®é™…å­˜å‚¨å®å¯æ¢¦çš„åœ°æ–¹ã€‚è®©æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ä½ åº”è¯¥çŸ¥é“æˆ‘å–œæ¬¢ä»ä»€ä¹ˆå¼€å§‹ï¼šä¸€ä¸ªæµ‹è¯•
: )ã€‚è¿™ä¸ªæµ‹è¯•å°†æ£€æŸ¥æˆ‘ä»¬ä¸èƒ½æœ‰ä¸¤ä¸ªç›¸åŒç¼–å·çš„å®å¯æ¢¦ã€‚</p>
<pre><code class="language-rs">use crate::repositories::pokemon::InMemoryRepository;

#[test]
fn it_should_return_a_conflict_error_when_pokemon_number_already_exists() {
    let number = PokemonNumber::try_from(25).unwrap();
    let name = PokemonName::try_from(String::from(&quot;Pikachu&quot;)).unwrap();
    let types = PokemonTypes::try_from(vec![String::from(&quot;Electric&quot;)]).unwrap();
    let mut repo = InMemoryRepository::new();
    repo.insert(number, name, types);
    let req = Request {
        number: 25,
        name: String::from(&quot;Charmander&quot;),
        types: vec![String::from(&quot;Fire&quot;)],
    };

    let res = execute(&amp;mut repo, req);

    match res {
        Response::Conflict =&gt; {}
        _ =&gt; unreachable!(),
    }
}
</code></pre>
<p>åœ¨ä¸ªç”¨ä¾‹çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨å­˜å‚¨åº“ä¸­æ’å…¥ä¸€ä¸ªå®å¯æ¢¦ã€‚ç„¶åæˆ‘ä»¬å°è¯•ä½¿ç”¨ç”¨ä¾‹å†æ¬¡æ’å…¥ä¸€ä¸ªå…·æœ‰ç›¸åŒç¼–å·çš„å®å¯æ¢¦ã€‚ç”¨ä¾‹åº”è¯¥è¿”å›ä¸€ä¸ªå†²çªé”™è¯¯ã€‚</p>
<p>åƒä¹‹å‰ä¸€æ ·ï¼Œå®ƒç°åœ¨è¿˜ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œå› ä¸ºè¿™é‡Œçš„å¾ˆå¤šä»£ç éƒ½æ²¡æœ‰å®ç°ã€‚è®©æˆ‘ä»¬é¦–å…ˆå°† <code>Conflict</code> é”™è¯¯æ·»åŠ åˆ° <code>Response</code> æšä¸¾ä¸­ï¼š</p>
<pre><code class="language-rs">enum Response {
    ...
    Conflict,
}
</code></pre>
<p>æ¥ç€ï¼Œåœ¨å®å¯æ¢¦ç±»å‹ä¸­å¢åŠ ä¸€ä¸ªç«å±æ€§</p>
<pre><code class="language-rs">enum PokemonType {
    Electric,
    Fire,
}

impl TryFrom&lt;String&gt; for PokemonType {
    type Error = ();

    fn try_from(t: String) -&gt; Result&lt;Self, Self::Error&gt; {
        match t.as_str() {
            &quot;Electric&quot; =&gt; Ok(Self::Electric),
            &quot;Fire&quot; =&gt; Ok(Self::Fire),
            _ =&gt; Err(()),
        }
    }
}
</code></pre>
<p>æ‚¨å¯èƒ½æƒ³çŸ¥é“å†…å­˜ä¸­çš„å­˜å‚¨åº“æ˜¯ä»€ä¹ˆã€‚å®ƒæ˜¯åœ¨æˆ‘ä»¬ä¸çŸ¥é“å®¢æˆ·å°†è¦ä½¿ç”¨ä»€ä¹ˆä½œä¸ºå­˜å‚¨åº“æ—¶ï¼Œæš‚æ—¶ä½¿ç”¨çš„å­˜å‚¨åº“ã€‚è¿™æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªå®ç°ï¼Œå®ƒä¸»è¦ç”¨äºæµ‹è¯•ã€‚å› ä¸ºå®ƒå¯ä»¥åƒçœŸæ­£çš„å­˜å‚¨åº“ä¸€æ ·å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨å®ƒå»å‘å®¢æˆ·å±•ç¤ºæˆ‘ä»¬çš„è¿›åº¦å¹¶è¦æ±‚ä»–æä¾›åé¦ˆã€‚å¦‚ä½ æ‰€è§ï¼Œå­˜å‚¨åº“
<code>repo</code> è¢«å½“ä½œå‚æ•°ä¼ é€’ç»™ç”¨ä¾‹ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;

fn execute(repo: &amp;mut dyn Repository, req: Request) -&gt; Response {
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œ<code>execute</code> å‡½æ•°å¹¶ä¸ä¼šå¾—åˆ°å…·ä½“çš„å­˜å‚¨åº“å®ç°ï¼Œè€Œæ˜¯ä»»ä½•å®ç°äº† <code>Reposity</code> ç‰¹å¾çš„ç»“æ„ä½“ã€‚è®©æˆ‘ä»¬åœ¨ä¹‹å‰çš„ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­ä¹Ÿè¡¥å……
repo å‚æ•°ï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_a_bad_request_error_when_request_is_invalid() {
    let mut repo = InMemoryRepository::new();
    let req = Request {
    ...
    let res = execute(&amp;mut repo, req);
    ...
}

#[test]
fn it_should_return_the_pokemon_number_otherwise() {
    let mut repo = InMemoryRepository::new();
    let number = 25;
    ...
    let res = execute(&amp;mut repo, req);
    ...
}
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åœ¨æ–°æ¨¡å— <em>repositories/pokemon.rs</em> ä¸­å»å®šä¹‰ <code>InMemoryRepository</code> ç»“æ„ä½“ å’Œ
<code>Repository</code> ç‰¹å¾ï¼š</p>
<pre><code>src
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ create_pokemon.rs
â”‚   â”œâ”€â”€ entities.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ repositories
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ pokemon.rs
â””â”€â”€ main.rs
</code></pre>
<pre><code class="language-rs">pub trait Repository {}

pub struct InMemoryRepository;

impl Repository for InMemoryRepository {}
</code></pre>
<p>ä¸è¦å¿˜äº†å¼•ç”¨æ¨¡å—</p>
<pre><code class="language-rs">// main.rs
mod repositories;

// repositories/mod.rs
pub mod pokemon;
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®ç° <code>InMemoryRepository</code> çš„ <code>new</code> æ–¹æ³•ã€‚åœ¨è¿™é‡Œï¼Œ<code>InMemoryRepository</code>
å†…éƒ¨åªæ˜¯ç®€å•çš„å­˜å‚¨äº†ä¸€ä¸ªå®å¯æ¢¦åˆ—è¡¨</p>
<pre><code class="language-rs">use crate::domain::entities::Pokemon;

pub struct InMemoryRepository {
    pokemons: Vec&lt;Pokemon&gt;,
}

impl InMemoryRepository {
    pub fn new() -&gt; Self {
        let pokemons: Vec&lt;Pokemon&gt; = vec![];
        Self { pokemons }
    }
}
</code></pre>
<p>ç°åœ¨ï¼Œç»ˆäºæ˜¯å®ç° <code>Pokemon</code> å®ä½“çš„æ—¶å€™äº†ï¼š</p>
<pre><code class="language-rs">pub struct Pokemon {
    pub number: PokemonNumber,
    name: PokemonName,
    types: PokemonTypes,
}

impl Pokemon {
    pub fn new(number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Self {
        Self {
            number,
            name,
            types
        }
    }
}
</code></pre>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°† <code>entities.rs</code> è½¬ä¸ºå…¬å¼€çš„ï¼š</p>
<pre><code class="language-rs">// domain/mod.rs
pub mod entities;
</code></pre>
<p>ç°åœ¨å”¯ä¸€æ²¡æœ‰è¢«å®ç°çš„å°±å‰©ä¸‹ <code>insert</code> æ–¹æ³•äº†ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨ä»»ä½•å®ç°äº† <code>Repository</code> ç‰¹å¾çš„å­˜å‚¨åº“ä¸Šéƒ½èƒ½è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦åœ¨ Trait
ä¸Šæ·»åŠ ä¸€ä¸ªå‡½æ•°ç­¾åï¼Œå¹¶ä¸º <code>InMemoryRepository</code> ç»“æ„ä½“å®ç° <code>insert</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">use crate::domain::entities::{Pokemon, PokemonName, PokemonNumber, PokemonTypes};

pub trait Repository {
    fn insert(&amp;self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; PokemonNumber;
}

impl Repository for InMemoryRepository {
    fn insert(&amp;self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; PokemonNumber {
        number
    }
}
</code></pre>
<p>è®©æˆ‘ä»¬å°è¯•è¿è¡Œæµ‹è¯•ï¼š</p>
<pre><code>cargo test
running 3 tests
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_the_pokemon_number_otherwise ... ok
test it_should_return_a_conflict_error_when_pokemon_number_already_exists ... FAILED
</code></pre>
<p>ç¬¬ä¸‰ä¸ªæµ‹è¯•å¤±è´¥äº†ï¼Œæ’å…¥æˆåŠŸæ—¶ï¼Œinsert åº”è¯¥è¿”å›ä¸€ä¸ªå®å¯æ¢¦çš„ç¼–å·ï¼Œå¦‚æœå¯¹åº”çš„ç¼–å·å·²ç»å­˜åœ¨ï¼Œéœ€è¦è¿”å›ä¸€ä¸ªå†²çªçš„é”™è¯¯ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨è¦å¡«åŠ ä¸€ä¸ª <code>Insert</code>
ç»“æ„ä½“è¡¨ç¤ºè¿™ä¸¤ç§ç»“æœï¼ŒåŒæ—¶è¦å°†åŸæœ¬çš„ä¸å¯è¾¹å€Ÿç”¨å˜ä¸ºå¯å˜å€Ÿç”¨ï¼š</p>
<pre><code class="language-rs">pub enum Insert {
    Ok(PokemonNumber),
    Conflict,
}

pub trait Repository {
    fn insert(&amp;mut self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert;
}
</code></pre>
<p>æ¥ä¸‹æ¥å®ç° InMemoryRepository çš„ insert æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">impl Repository for InMemoryRepository {
    fn insert(&amp;mut self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert {
        if self.pokemons.iter().any(|pokemon| pokemon.number == number) {
            return Insert::Conflict;
        }

        let number_clone = number.clone();
        self.pokemons.push(Pokemon::new(number_clone, name, types));
        Insert::Ok(number)
    }
}
</code></pre>
<p>ä¸ºäº†è®© <code>clone</code> å’Œ <code>==</code> é€šè¿‡ç¼–è¯‘ï¼Œæˆ‘ä»¬è¿˜è¦ä¸º <code>PokemonNumber</code> å®ç° <code>PartialEq</code> å’Œ <code>Clone</code> ä¸¤ä¸ªç‰¹å¾ï¼š</p>
<pre><code class="language-rs">use std::cmp::PartialEq;

#[derive(PartialEq, Clone)]
pub struct PokemonNumber(u16);
</code></pre>
<p>æœ€åï¼Œè®© <code>execute</code> å‡½æ•°è°ƒç”¨ insert æ–¹æ³•</p>
<pre><code class="language-rs">fn execute(repo: &amp;mut dyn Repository, req: Request) -&gt; Response {
    match (
        PokemonNumber::try_from(req.number),
        PokemonName::try_from(req.name),
        PokemonTypes::try_from(req.types),
    ) {
        (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
            Insert::Ok(number) =&gt; Response::Ok(u16::from(number)),
            Insert::Conflict =&gt; Response::Conflict,
        },
        _ =&gt; Response::BadRequest,
    }
}
</code></pre>
<p>å†æ¬¡è¿è¡Œæµ‹è¯•</p>
<pre><code>cargo test
running 3 tests
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_the_pokemon_number_otherwise ... ok
test it_should_return_a_conflict_error_when_pokemon_number_already_exists ... ok
</code></pre>
<p>å¤ªæ£’äº†ï¼Œå†²çªæµ‹è¯•ä¹Ÿé€šè¿‡äº†ï¼</p>
<h2 id="ä»¥ä¸ºå·²ç»ç»“æŸäº†å—"><a class="header" href="#ä»¥ä¸ºå·²ç»ç»“æŸäº†å—">ä»¥ä¸ºå·²ç»ç»“æŸäº†å—ï¼Ÿ</a></h2>
<p>æ²¡æœ‰ã€‚åœ¨å­˜å‚¨åº“ä¸­è¿˜æœ‰ä¸€ç§é—®é¢˜ä¼šå‘ç”Ÿã€‚å‡è®¾ç”±äºæŸäº›æ„å¤–ï¼Œå­˜å‚¨åº“æ— æ³•æ­£å¸¸å·¥ä½œã€‚å¦‚æœæ˜¯æ•°æ®åº“ï¼Œé‚£å°±æ˜¯è¿æ¥é”™è¯¯ï¼Œå¦‚æœæ˜¯ APIï¼Œé‚£å°±æ˜¯ç½‘ç»œé”™è¯¯ã€‚æˆ‘ä»¬ä¹Ÿåº”è¯¥å¤„ç†è¿™ç§æƒ…å†µã€‚</p>
<p>ä½ çŸ¥é“æˆ‘ç°åœ¨è¦åšä»€ä¹ˆï¼šå†™ä¸€ä¸ªæµ‹è¯•ï¼</p>
<pre><code class="language-rs">#[test]
fn it_should_return_an_error_when_an_unexpected_error_happens() {
    let mut repo = InMemoryRepository::new().with_error();
    let number = 25;
    let req = Request {
        number,
        name: String::from(&quot;Pikachu&quot;),
        types: vec![String::from(&quot;Electric&quot;)],
    };

    let res = execute(&amp;mut repo, req);

    match res {
        Response::Error =&gt; {}
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>è¿™ä¸ªæµ‹è¯•æœ‰ä¸¤ä¸ªä¸åŒç‚¹ã€‚ç¬¬ä¸€ï¼Œæˆ‘ä»¬æ·»åŠ äº† <code>with_error</code> æ–¹æ³•è¡¨ç¤ºå­˜å‚¨åº“è¿æ¥å¼‚å¸¸ã€‚ç¬¬äºŒï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥ Respnse æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ã€‚</p>
<p>é¦–å…ˆä¸º Response æ·»åŠ ä¸€ä¸ªæ–°çš„ç±»å‹</p>
<pre><code class="language-rs">enum Response {
    ...
    Error,
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬è¦å®ç° <code>with_error</code> æ–¹æ³•ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯åœ¨ <code>InMemoryRepository</code> ä¸­å¢åŠ ä¸€ä¸ª <code>error</code>
å­—æ®µï¼Œè¡¨ç¤ºæ˜¯å¦ä¼šåœ¨è¿æ¥å­˜å‚¨åº“æ—¶è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœ <code>error</code> ä¸º <code>true</code> æˆ‘ä»¬å°±è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå¦åˆ™è¿”å›æ­£å¸¸ç»“æœï¼š</p>
<pre><code class="language-rs">pub enum Insert {
    ...
    Error,
}

pub struct InMemoryRepository {
    error: bool,
    pokemons: Vec&lt;Pokemon&gt;,
}

impl InMemoryRepository {
    pub fn new() -&gt; Self {
        let pokemons: Vec&lt;Pokemon&gt; = vec![];
        Self {
            error: false,
            pokemons,
        }
    }

    pub fn with_error(self) -&gt; Self {
        Self {
            error: true,
            ..self
        }
    }
}

impl Repository for InMemoryRepository {
    fn insert(&amp;mut self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert {
        if self.error {
            return Insert::Error;
        }

        if self.pokemons.iter().any(|pokemon| pokemon.number == number) {
            return Insert::Conflict;
        }

        let number_clone = number.clone();
        self.pokemons.push(Pokemon::new(number_clone, name, types));
        Insert::Ok(number)
    }
}
</code></pre>
<p>åŒæ ·çš„ï¼Œåœ¨ <code>execute</code> ä¸­å¤„ç†è¿™ç§æƒ…å†µ</p>
<pre><code class="language-rs">fn execute(repo: &amp;mut dyn Repository, req: Request) -&gt; Response {
    match (
        PokemonNumber::try_from(req.number),
        PokemonName::try_from(req.name),
        PokemonTypes::try_from(req.types),
    ) {
        (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
            Insert::Ok(number) =&gt; Response::Ok(u16::from(number)),
            Insert::Conflict =&gt; Response::Conflict,
            Insert::Error =&gt; Response::Error,
        },
        _ =&gt; Response::BadRequest,
    }
}
</code></pre>
<p>è®©æˆ‘ä»¬è¿è¡Œæµ‹è¯•</p>
<pre><code>cargo test
running 4 tests
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_a_conflict_error_when_pokemon_number_already_exists ... ok
test it_should_return_an_error_when_an_unexpected_error_happens ... ok
test it_should_return_the_pokemon_number_otherwise ... ok
</code></pre>
<p>\o/</p>
<h2 id="ä¸‹ä¸€æ­¥"><a class="header" href="#ä¸‹ä¸€æ­¥">ä¸‹ä¸€æ­¥</a></h2>
<p>è¿™ç¯‡æ–‡ç« çš„é•¿åº¦å·²ç»è¶³å¤Ÿäº†ï¼Œè®©æˆ‘ä»¬æš‚æ—¶åœåˆ°è¿™é‡Œã€‚ä¸‹ä¸€æ¬¡ï¼Œæˆ‘å°†ä¸ºå‰ç«¯éƒ¨åˆ†å…ˆå®ç° HTTP
APIã€‚ä¹‹åæˆ‘ä¼šå¤„ç†å…¶ä»–çš„ç”¨ä¾‹ã€‚æˆ‘ä»¬ä¹‹åè¿˜ä¼šå®ç°æ›´å¤šçš„å­˜å‚¨åº“å’Œå‰ç«¯æ¥å£ï¼Œè¿™äº›åŠŸèƒ½ä¼šé€šè¿‡æ·»åŠ ä¸åŒçš„å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œå¼€å¯ã€‚</p>
<p>å’Œä»¥å‰ä¸€æ ·ï¼Œæˆ‘ä¼šåœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-2">github</a>
ä¸Šåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰æ›´æ”¹çš„åˆ†æ”¯ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-7/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-10-17---rust-å…­è¾¹å½¢æ¶æ„-7---é•¿æœŸå­˜å‚¨åº“"><a class="header" href="#2021-10-17---rust-å…­è¾¹å½¢æ¶æ„-7---é•¿æœŸå­˜å‚¨åº“">2021-10-17 - Rust å…­è¾¹å½¢æ¶æ„ #7 - é•¿æœŸå­˜å‚¨åº“</a></h1>
<p>è¿™é‡Œæ˜¯æœ¬ç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« äº†ã€‚éå¸¸æ„Ÿè°¢ä½ ï¼Œåœ¨ä¸ƒç¯‡æ–‡ç« ä¹‹åä»ç„¶åœ¨è¿™é‡Œçš„åŒ¿åè¯»è€…ã€‚æˆ‘ä»¬å·²ç»ä»‹ç»äº†å¾ˆå¤šä¸œè¥¿ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªåŸŸï¼Œæˆ‘ä»¬èƒ½å¤Ÿå­˜å‚¨æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ CLI å’Œ
HTTP æœåŠ¡å™¨æ¥æ“ä½œæˆ‘ä»¬çš„ç¨‹åºã€‚é‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿå“¦ï¼Œæˆ‘çœ‹åˆ°å®¢æˆ·äº†ï¼Œæˆ‘ä»¬é—®é—®ä»–å§ã€‚</p>
<ul>
<li>å˜¿ï¼Œæœ€è¿‘å¥½å—ï¼Ÿ</li>
<li>æˆ‘å¾ˆå¥½ï¼Œä½†ä½ çš„è½¯ä»¶ä¸æ˜¯å¾ˆå¥½ã€‚</li>
<li>å“¦... æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ</li>
<li>å½“æˆ‘é‡å¯ç¨‹åºæ—¶ï¼Œæ‰€æœ‰çš„æ•°æ®éƒ½ä¸¢å¤±äº†ã€‚</li>
<li>å•Šï¼Œå¯¹ï¼Œé‚£å¾ˆæ­£å¸¸ã€‚æˆ‘ä»¬ç°åœ¨ä¾ç„¶æ˜¯åœ¨ç›´æ¥æ“ä½œå†…å­˜ã€‚</li>
<li>ä½ èƒ½è®©è¿™äº›æ•°æ®å¾—ä»¥é•¿æœŸä¿å­˜å—ï¼Ÿ</li>
<li>è¿™äº›æ•°æ®ï¼Ÿå½“ç„¶å¯ä»¥ã€‚æ‚¨èƒ½ç»™æˆ‘ä»¬æä¾›ä¿å­˜çš„åœ°æ–¹å—ï¼Ÿ</li>
<li>å—¯ï¼Œæˆ‘ä¸çŸ¥é“ã€‚æˆ‘è¦å»æ‰¾äººé—®é—®ã€‚ä½ èƒ½ä¸èƒ½è®©ç¨‹åºæš‚æ—¶æŠŠæ•°æ®å­˜å‚¨å†ç¡¬ç›˜ä¸Šï¼Ÿ</li>
<li>é©¬ä¸Šå®Œæˆï¼</li>
</ul>
<p>å¥½çš„ï¼Œæˆ‘ä»¬æƒ³è¦æŠŠæ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªåœ°æ–¹ï¼Œå½“ç¨‹åºé‡å¯åä¹Ÿä¸ä¼šè¢«åˆ é™¤ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨æ–‡ä»¶ï¼ŒåŒæ—¶å› ä¸ºæˆ‘ä»¬æƒ³è¦ä½¿ç”¨ä¸€ç§å¯é çš„æ–¹å¼å»æŸ¥è¯¢æ•°æ®ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ SQLã€‚æ–‡ä»¶å’Œ
SQL... æœ‰ä¸œè¥¿åœ¨æˆ‘è„‘æµ·é‡Œå°–å«è€… <strong>SQLite</strong></p>
<p>æœ‰ä¸€ç‚¹å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨å·²ç»å®ç°äº†ä¸€ä¸ªå­˜å‚¨åº“ç³»ç»Ÿï¼Œæˆ‘ä»¬åªéœ€è¦å¡«åŠ ä¸€ä¸ªæ–°çš„å­˜å‚¨åº“ï¼Œä»¥åŠä¸€ä¸ªå‘½ä»¤è¡Œå¼€å…³å»å†³å®šä½¿ç”¨é‚£ç§å­˜å‚¨åº“å³å¯ã€‚å› ä¸ºæœ‰å…­è¾¹å½¢æ¶æ„ï¼Œæˆ‘ä»¬çš„åŸŸå®Œå…¨ä¸ç”¨ä¿®æ”¹
: D</p>
<h2 id="ä½¿ç”¨-sqlite-ä½œä¸ºæœ¬åœ°å­˜å‚¨"><a class="header" href="#ä½¿ç”¨-sqlite-ä½œä¸ºæœ¬åœ°å­˜å‚¨">ä½¿ç”¨ SQLite ä½œä¸ºæœ¬åœ°å­˜å‚¨</a></h2>
<h3 id="åˆ›å»ºæ•°æ®åº“"><a class="header" href="#åˆ›å»ºæ•°æ®åº“">åˆ›å»ºæ•°æ®åº“</a></h3>
<p>é¦–å…ˆæˆ‘ä»¬è¦ä½¿ç”¨ sqlite3 æä¾›çš„å‘½ä»¤è¡Œå·¥å…·åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼š</p>
<pre><code>sqlite3 path/to/the/database.sqlite
</code></pre>
<p>ä½ åº”è¯¥å·²ç»å¾—åˆ°äº† SQLite çš„æç¤ºã€‚ç°åœ¨æˆ‘ä»¬è¦åˆ›å»ºä¸¤å¼ è¡¨ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤å¼ ï¼Ÿå› ä¸ºä¸€ä¸ªå®å¯æ¢¦æœ‰å¾ˆå¤šç§ç±»å‹ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†ä¸€åˆ—ä¸­å­˜å‚¨æ‰€æœ‰çš„ç±»å‹ã€‚</p>
<p>å®é™…ä¸Šï¼Œå®å¯æ¢¦è¡¨ä¸ç±»å‹è¡¨æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼š</p>
<ul>
<li>ä¸€åªå®å¯æ¢¦æœ‰å¤šç§ç±»å‹</li>
<li>ä¸€ä¸ªç±»å‹å¯ä»¥å¯¹åº”å¤šä¸ªå®å¯æ¢¦</li>
</ul>
<p>æ‰€ä»¥å®Œæ•´çš„æ•°æ®åº“åº”è¯¥æ˜¯ä¸‹é¢çš„æ ·å­ï¼Œå®ƒä¸€å…±æœ‰ 3 å¼ è¡¨ï¼š</p>
<pre><code>pokemons           | number          | name     |

types              | id              | name     |

pokemons_to_types  | pokemons.number | types.id |
</code></pre>
<p>ä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ç±»å‹çš„ <code>id</code>ï¼Œæš‚æ—¶æˆ‘ä»¬åªéœ€è¦ä¸¤å¼ è¡¨ï¼š</p>
<pre><code>pokemons | number          | name |

types    | pokemons.number | name |
</code></pre>
<p>è®©æˆ‘ä»¬å›åˆ° SQLite çš„å‘½ä»¤è¡Œä¸­ã€‚é¦–å…ˆæˆ‘ä»¬è¦æ¿€æ´»å¤–é”® (é»˜è®¤æ˜¯å…³é—­çš„)ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šè¿™ä¸ªæ“ä½œåªä¼šåœ¨æœ¬æ¬¡è¿æ¥ä¸­ç”Ÿæ•ˆï¼Œ</p>
</blockquote>
<pre><code class="language-sql">pragma foreign_keys = 1;
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¼€å§‹åˆ›å»ºæ•°æ®è¡¨ï¼š</p>
<pre><code class="language-sql">create table pokemons (
    number integer primary key,
    name text
);

create table types (
    pokemon_number integer,
    name text,
    foreign key (pokemon_number) references pokemons (number) on delete cascade,
    primary key (pokemon_number, name)
);
</code></pre>
<p><code>on delete cascade</code> çš„æ•ˆæœæ˜¯å½“ä¸€ä¸ªå®å¯æ¢¦è¢«åˆ é™¤æ—¶ï¼Œç±»å‹è¡¨ä¸­æ‰€æœ‰ <code>pokemon_number</code> å’Œ <code>number</code>
ç›¸åŒçš„è¡Œä¹Ÿä¼šè¢«åˆ é™¤ã€‚è¿™æ ·æˆ‘ä»¬åœ¨ç¨‹åºä¸­å°±ä¸ç”¨åœ¨å…³å¿ƒäº†ï¼š) ç°åœ¨ä½ å¯ä»¥ä½¿ç”¨ Ctrl-D é€€å‡º SQLite äº†ã€‚</p>
<h2 id="æ·»åŠ é€‰æ‹©å­˜å‚¨åº“çš„å¼€å…³"><a class="header" href="#æ·»åŠ é€‰æ‹©å­˜å‚¨åº“çš„å¼€å…³">æ·»åŠ é€‰æ‹©å­˜å‚¨åº“çš„å¼€å…³</a></h2>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ SQLite ä½œä¸ºæ•°æ®åº“ï¼Œæˆ‘ä»¬è¦å†æ·»åŠ ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°å‘Šè¯‰ç¨‹åºæˆ‘ä»¬æƒ³ä½¿ç”¨ SQLiteã€‚å¤§æ¦‚æ•ˆæœæ˜¯è¿™æ ·</p>
<pre><code>pokedex --sqlite path/to/the/database.sqlite
</code></pre>
<p>å½“ä½ ä½¿ç”¨ cargo run æ—¶éœ€è¦æ”¹ä¸ºè¿™æ ·ï¼š</p>
<pre><code>cargo run -- --sqlite path/to/the/database.sqlite
</code></pre>
<pre><code class="language-rs">fn main() { let repo = Arc::new(InMemoryRepository::new());

    let matches = App::new(crate_name!())
        .version(crate_version!())
        .author(crate_authors!())
        .arg(Arg::with_name(&quot;cli&quot;).long(&quot;cli&quot;).help(&quot;Runs in CLI mode&quot;))
        .arg(Arg::with_name(&quot;sqlite&quot;).long(&quot;sqlite&quot;).value_name(&quot;PATH&quot;))
        .get_matches();

    match matches.occurrences_of(&quot;cli&quot;) {
        0 =&gt; api::serve(&quot;localhost:8000&quot;, repo),
        _ =&gt; cli::run(repo),
    }
}
</code></pre>
<p>ç°åœ¨æ•°æ®åº“å¼€å…³å·²ç»åŠ ä¸Šäº†ï¼Œé€šè¿‡ <code>--help</code> æŸ¥çœ‹ï¼š</p>
<pre><code>OPTIONS: --sqlite &lt;PATH&gt;
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å»åˆå§‹åŒ–ä¸€ä¸ªæš‚æ—¶è¿˜æ²¡æœ‰å®ç°çš„ <code>SqliteRepository</code>ï¼š</p>
<pre><code class="language-rs">use repositories::pokemon::{..., SqliteRepository};

fn main() {
    let matches = ...

    let repo = build_repo(matches.value_of(&quot;sqlite&quot;));

    match matches.occurrences_of(&quot;cli&quot;) {
        0 =&gt; api::serve(&quot;localhost:8000&quot;, repo),
        _ =&gt; cli::run(repo),
    }

}

fn build_repo(sqlite_value: Option&lt;&amp;str&gt;) -&gt; Arc&lt;dyn Repository&gt; {
    if let Some(path) = sqlite_value {
        match SqliteRepository::try_new(path) {
            Ok(repo) =&gt; return Arc::new(repo),
            _ =&gt; panic!(&quot;Error while creating sqlite repo&quot;),
        }
    }

    Arc::new(InMemoryRepository::new())
}
</code></pre>
<p>å½“ <code>--sqlite</code> æ‰“å¼€æ—¶ï¼Œç¨‹åºä¼šå°è¯•åˆå§‹åŒ– SQLite å­˜å‚¨åº“ã€‚å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œç¨‹åºå°±ä¼šå´©æºƒå¹¶æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰å¼€å¯ <code>--sqlite</code>
å°±ä¼šä½¿ç”¨é»˜è®¤çš„å†…å­˜å­˜å‚¨åº“ã€‚</p>
<h2 id="å®ç°-sqlite-å­˜å‚¨åº“"><a class="header" href="#å®ç°-sqlite-å­˜å‚¨åº“">å®ç° SQlite å­˜å‚¨åº“</a></h2>
<p>æˆ‘ä»æ–‡ç« ä¸€å¼€å§‹å°±åœ¨è°ˆè®º SQLiteã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¸€ç§ä» Rust è°ƒç”¨æ•°æ®åº“çš„æ–¹æ³•ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ <code>rusqlite</code> å»å®ç°ã€‚è®©æˆ‘ä»¬åœ¨
<code>Cargo.toml</code> ä¸­å¯¼å…¥å®ƒï¼š</p>
<pre><code class="language-toml">[dependencies]
rusqlite = &quot;0.26.0&quot;
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬è¦å®ç° <code>SQLiteRepository</code>ï¼Œæˆ‘è¦åœ¨ <code>InMemoryRepository</code> æ‰€åœ¨çš„æ–‡åŠ ä¸­åˆ›å»º
<code>SQLiteRepository</code>ã€‚å½“ç„¶ï¼Œè¿™ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å»è¦æŠŠå®ƒæ”¾åœ¨ä¸€ä¸ªæ–°æ–‡ä»¶ä¸­ï¼š</p>
<pre><code class="language-rs">use rusqlite::Connection;

pub struct SqliteRepository { connection: Mutex&lt;Connection&gt;, }
</code></pre>
<p><em>main.rs</em> ä¸­çš„ <code>use</code> ç°åœ¨åº”è¯¥ä¸ä¼šæŠ¥é”™äº†ï¼Œæ¥ç€å®ç° <code>try_new</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">use rusqlite::{..., OpenFlags};

impl SqliteRepository {
    pub fn try_new(path: &amp;str) -&gt; Result&lt;Self, ()&gt; {
        let connection = match Connection::open_with_flags(path, OpenFlags::SQLITE_OPEN_READ_WRITE)
        {
            Ok(connection) =&gt; connection,
            _ =&gt; return Err(()),
        };

        match connection.execute(&quot;pragma foreign_keys = 1&quot;, []) {
            Ok(_) =&gt; Ok(Self {
                connection: Mutex::new(connection),
            }),
            _ =&gt; Err(()),
        }
    }

}
</code></pre>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è°ƒç”¨ <code>rusqlite</code> å»æ–°å»ºä¸€ä¸ªå¯¹æ•°æ®æ–‡ä»¶çš„è¿æ¥ã€‚è€Œä¸”æˆ‘ä»¬é€šè¿‡ <code>OpenFlags</code> å»æ˜ç¡®ç¦æ­¢å½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ <code>rusqulite</code>
å»è‡ªåŠ¨åˆ›å»ºæ•°æ®æ–‡ä»¶ã€‚å¦‚æœè¿æ¥æˆåŠŸï¼Œæˆ‘ä»¬å°±ä¼šæ‰§è¡Œåªå‰æåˆ°çš„å‘½ä»¤ï¼Œç¡®ä¿å¤–é”®å¼€å¯ã€‚æœ€åæˆ‘ä»¬å»è¿”å›è¿™ä¸ªå­˜å‚¨åº“ã€‚</p>
<p>å¦‚æœä½ ç°åœ¨å°è¯•è¿è¡Œç¨‹åºï¼Œè¿˜ä¸èƒ½é€šè¿‡ç¼–è¯‘ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å®ç° <code>Repository</code> Trait å®šä¹‰çš„çš„æ‰€æœ‰æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">impl Repository for SqliteRepository {
    fn insert(
        &amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;Pokemon, InsertError&gt; {
        Err(InsertError::Unknown)
    }

    fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt;{
        Err(FetchAllError::Unknown)
    }

    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt; {
        Err(FetchOneError::Unknown)
    }

    fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt; {
        Err(DeleteError::Unknown)
    }
}
</code></pre>
<p>ç¼–è¯‘é€šè¿‡äº†ï¼Œä½†æ˜¯æˆ‘ä»¬çš„å­˜å‚¨åº“ä¾ç„¶æ²¡ä»€ä¹ˆç”¨ç°åœ¨ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦å®ç°é‚£äº›æ–¹æ³• :)</p>
<h2 id="è¾…åŠ©å‡½æ•°"><a class="header" href="#è¾…åŠ©å‡½æ•°">è¾…åŠ©å‡½æ•°</a></h2>
<p>åœ¨æˆ‘ä»¬å®ç°å­˜å‚¨åº“éœ€è¦çš„å‡½æ•°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå®šä¹‰ä¸¤ä¸ªè¾…åŠ©å‡½æ•°ã€‚æˆ‘ä»¬æƒ³è¦æŸ¥è¯¢ä¸€ä¸ªæˆ–è€…æ˜¯æ‰€æœ‰å®å¯æ¢¦ï¼Œç”¨ SQL è¯­å¥æè¿°å°±æ˜¯ä¸€ä¸ª
<code>select</code>ã€‚æˆ‘ä»¬åˆ›å»ºçš„è¾…åŠ©å‡½æ•°èƒ½å¤ŸæŠŠè¿™ä¸¤ä¸ªæŸ¥è¯¢é€»è¾‘æ•´åˆåˆ°ä¸€èµ·ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªèƒ½å¤Ÿæ‹¿åˆ°æ‰€æœ‰å®å¯æ¢¦ç¼–å·å’Œåå­—çš„å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªå·²ç»æ‹¿åˆ°é”çš„å­˜å‚¨åº“ï¼Œä¹Ÿå¯èƒ½ä¼šéœ€è¦ä¸€ä¸ªå®å¯æ¢¦çš„ç¼–å·ã€‚å¦‚æœå‡½æ•°æ¥æ”¶åˆ°äº†ç¼–å·ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨ SQL
è¯­å¥ä¸Šæ·»åŠ  <code>where</code> å­å¥ã€‚è¿™ä¸ªå‡½æ•°ä¼šè¢«æ·»åŠ åˆ° <code>impl SqliteRepository</code> å—å†…ï¼Œå› ä¸ºå®ƒä¸æ˜¯ <code>Repository Trait</code>
çš„ä¸€éƒ¨åˆ†ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å°†ç›´æ¥è¿”å›åŸå§‹æ•°æ® ( <code>u16</code> å’Œ <code>String</code> )ï¼Œè€Œä¸”è¿™ä¸ªå‡½æ•°åº”è¯¥æ˜¯ç§æœ‰çš„ã€‚</p>
<pre><code class="language-rs">use std::sync::{..., MutexGuard};

fn fetch_pokemon_rows(
    lock: &amp;MutexGuard&lt;'_, Connection&gt;,
    number: Option&lt;u16&gt;,
) -&gt; Result&lt;Vec&lt;(u16, String)&gt;, ()&gt; {
    // code will go here
}
</code></pre>
<p>è®©æˆ‘ä»¬å¼€å§‹å§ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ ¹æ®æ•°å­—æ˜¯å¦å­˜åœ¨æ¥å®šä¹‰æŸ¥è¯¢è¯­å¥å’ŒæŸ¥è¯¢å‚æ•°ï¼š</p>
<pre><code class="language-rs">let (query, params) = match number {
    Some(number) =&gt; (
        &quot;select number, name from pokemons where number = ?&quot;,
        vec![number],
    ),
    _ =&gt; (&quot;select number, name from pokemons&quot;, vec![]),
};
</code></pre>
<p>ç›¸å½“ç®€å•å§ï¼Ÿç°åœ¨æˆ‘ä»¬å¿…é¡»å‡†å¤‡ä¸€ä¸ª <code>statment</code> å¹¶ä¼ é€’æˆ‘ä»¬çš„å‚æ•°ï¼š</p>
<pre><code class="language-rs">use rusqlite::{..., params_from_iter};

...
let mut stmt = match lock.prepare(query) {
    Ok(stmt) =&gt; stmt,
    _ =&gt; return Err(()),
};

let mut rows = match stmt.query(params_from_iter(params)) {
    Ok(rows) =&gt; rows,
    _ =&gt; return Err(()),
};
</code></pre>
<p>æˆ‘ä»¬å·²ç»å¾—åˆ°æŸ¥è¯¢ç»“æœï¼Œç°åœ¨éœ€è¦æŠŠç»“æœè½¬æ¢ä¸ºä¸€ä¸ª <code>(u16, String)</code> ç±»å‹çš„å…ƒç»„ å†æŠŠä»–ä»¬æ±‡é›†åˆ°ä¸€ä¸ªå‘é‡é‡Œè¿”å›</p>
<pre><code class="language-rs">...
let mut pokemon_rows = vec![];

while let Ok(Some(row)) = rows.next() {
    match (row.get::&lt;usize, u16&gt;(0), row.get::&lt;usize, String&gt;(1)) {
        (Ok(number), Ok(name)) =&gt; pokemon_rows.push((number, name)),
        _ =&gt; return Err(()),
    };
}

Ok(pokemon_rows)
</code></pre>
<p>å¯¹ <code>types</code> è¡¨ä¹Ÿä¸€æ ·ï¼Œè¿™ä¸ªè¾…åŠ©å‡½æ•°æ¥æ”¶ä¸€ä¸ªæ•°æ®åº“è¿æ¥å’Œä¸€ä¸ª <code>number</code>ï¼ŒæŸ¥è¯¢æˆåŠŸä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²å‘é‡ï¼Œè¡¨ç¤ºæŸä¸€åªå®å¯æ¢¦çš„ç±»å‹ï¼š</p>
<pre><code class="language-rs">fn fetch_type_rows(lock: &amp;MutexGuard&lt;'_, Connection&gt;, number: u16) -&gt; Result&lt;Vec&lt;String&gt;, ()&gt; {
    // code will go here
}
</code></pre>
<p>å‡†å¤‡æŸ¥è¯¢è¯­å¥ï¼Œå¸¦ç€å‚æ•°è¿›è¡ŒæŸ¥è¯¢ï¼š</p>
<pre><code class="language-rs">let mut stmt = match lock.prepare(&quot;select name from types where pokemon_number = ?&quot;) {
    Ok(stmt) =&gt; stmt,
    _ =&gt; return Err(()),
};

let mut rows = match stmt.query([number]) {
    Ok(rows) =&gt; rows,
    _ =&gt; return Err(()),
};
</code></pre>
<p>ä¾æ¬¡ä»ç»“æœä¸­æå–å‡ºç±»å‹ï¼š</p>
<pre><code class="language-rs">let mut type_rows = vec![];

while let Ok(Some(row)) = rows.next() {
    match row.get::&lt;usize, String&gt;(0) {
        Ok(name) =&gt; type_rows.push(name),
        _ =&gt; return Err(()),
    };
}
Ok(type_rows)
</code></pre>
<p>Aaaandï¼Œé¡ºåˆ©å®Œæˆï¼è¿™ä¸¤ä¸ªåŠŸèƒ½ç°åœ¨éƒ½å®ç°äº†ã€‚ä½¿ç”¨å®ƒä»¬å»å®ç° <code>fetch_one</code> å’Œ <code>fetch_all</code> ä¼šæ›´å®¹æ˜“:)</p>
<h2 id="æŸ¥è¯¢ä¸€åªå®å¯æ¢¦"><a class="header" href="#æŸ¥è¯¢ä¸€åªå®å¯æ¢¦">æŸ¥è¯¢ä¸€åªå®å¯æ¢¦</a></h2>
<p>æˆ‘ä»¬ä¼šä¸€æ­¥ä¸€æ­¥æ¥ï¼Œé¦–å…ˆå¤„ç†ä¸‹é¢çš„æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt; {
    // code will go here
}
</code></pre>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦å…ˆæ‹¿åˆ°é”ï¼Œå¹¶é€šè¿‡è°ƒç”¨ä¹‹å‰çš„è¾…åŠ©å‡½æ•°å»æŸ¥è¯¢å®å¯æ¢¦ï¼š</p>
<pre><code class="language-rs">let lock = match self.connection.lock() {
    Ok(lock) =&gt; lock,
    _ =&gt; return Err(FetchOneError::Unknown),
};

let mut pokemon_rows = match Self::fetch_pokemon_rows(&amp;lock, Some(u16::from(number.clone()))) {
    Ok(pokemon_rows) =&gt; pokemon_rows,
    _ =&gt; return Err(FetchOneError::Unknown),
};
</code></pre>
<p>å½“æŸ¥è¯¢ç»“æœä¸ºç©ºæ—¶ï¼Œæˆ‘ä»¬å°±è¿”å› <code>NotFound</code>ï¼Œå¦åˆ™è¿”å›æŸ¥è¯¢ç»“æœçš„ç¬¬ä¸€ä¸ªï¼š</p>
<pre><code class="language-rs">...
if pokemon_rows.is_empty() {
    return Err(FetchOneError::NotFound);
}

let pokemon_row = pokemon_rows.remove(0);
</code></pre>
<p>ä¸é”™ã€‚ç°åœ¨æˆ‘ä»¬å»æŸ¥è¯¢å®å¯æ¢¦ç±»å‹ï¼š</p>
<pre><code class="language-rs">let type_rows = match Self::fetch_type_rows(&amp;lock, pokemon_row.0) {
    Ok(type_rows) =&gt; type_rows,
    _ =&gt; return Err(FetchOneError::Unknown),
};
</code></pre>
<p>æˆ‘ä»¬å·²ç»æœ‰å®å¯æ¢¦çš„ç¼–å·ã€åç§°å’Œç±»å‹ã€‚æ€»æ˜¯æ—¶å€™æŠŠä»–ä»¬å°è£…ä¸º <code>Response</code> äº†ï¼š</p>
<pre><code class="language-rs">...
match (
    PokemonNumber::try_from(pokemon_row.0),
    PokemonName::try_from(pokemon_row.1),
    PokemonTypes::try_from(type_rows),
) {
    (Ok(number), Ok(name), Ok(types)) =&gt; Ok(Pokemon::new(number, name, types)),
    _ =&gt; Err(FetchOneError::Unknown),
}
</code></pre>
<h2 id="æŸ¥è¯¢æ‰€æœ‰å®å¯æ¢¦"><a class="header" href="#æŸ¥è¯¢æ‰€æœ‰å®å¯æ¢¦">æŸ¥è¯¢æ‰€æœ‰å®å¯æ¢¦</a></h2>
<pre><code class="language-rs">fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt; {
    // code will go here
}
</code></pre>
<p>é¦–å…ˆè·å–é”å¹¶æŸ¥è¯¢æ‰€æœ‰å®å¯æ¢¦ï¼š</p>
<pre><code class="language-rs">let lock = match self.connection.lock() {
    Ok(lock) =&gt; lock,
    _ =&gt; return Err(FetchAllError::Unknown),
};

let pokemon_rows = match Self::fetch_pokemon_rows(&amp;lock, None) {
    Ok(pokemon_rows) =&gt; pokemon_rows,
    _ =&gt; return Err(FetchAllError::Unknown),
};
</code></pre>
<p>ä½ å¯ä»¥æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬æŠŠ <code>number</code> å‚æ•°è®¾ç½®ä¸ºäº† <code>None</code>ï¼Œå¯¹æ¯ä¸ªå®å¯æ¢¦ï¼Œæˆ‘ä»¬ä¼šå•ç‹¬æŸ¥è¯¢å®ƒçš„ç±»å‹ï¼Œæœ€ç»ˆå°è£…ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼š</p>
<pre><code class="language-rs">...
let mut pokemons = vec![];

for pokemon_row in pokemon_rows {
    let type_rows = match Self::fetch_type_rows(&amp;lock, pokemon_row.0) {
        Ok(type_rows) =&gt; type_rows,
        _ =&gt; return Err(FetchAllError::Unknown),
    };

    let pokemon = match (
        PokemonNumber::try_from(pokemon_row.0),
        PokemonName::try_from(pokemon_row.1),
        PokemonTypes::try_from(type_rows),
    ) {
        (Ok(number), Ok(name), Ok(types)) =&gt; Pokemon::new(number, name, types),
        _ =&gt; return Err(FetchAllError::Unknown),
    };

    pokemons.push(pokemon);
}

Ok(pokemons)
</code></pre>
<h2 id="æ’å…¥ä¸€åªå®å¯æ¢¦"><a class="header" href="#æ’å…¥ä¸€åªå®å¯æ¢¦">æ’å…¥ä¸€åªå®å¯æ¢¦</a></h2>
<pre><code class="language-rs">fn insert(
    &amp;self,
    number: PokemonNumber,
    name: PokemonName,
    types: PokemonTypes,
) -&gt; Result&lt;Pokemon, InsertError&gt; {
    // code will go here
}
</code></pre>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä»è¿æ¥ä¸­è·å–é”ï¼š</p>
<pre><code class="language-rs">let mut lock = match self.connection.lock() {
    Ok(lock) =&gt; lock,
    _ =&gt; return Err(InsertError::Unknown),
};
</code></pre>
<p>æ¥ç€æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªäº‹åŠ¡ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬æ²¡æœ‰ç›´æ¥æ‰§è¡Œä¸€æ¡å‘½ä»¤ï¼Ÿå› ä¸ºæˆ‘ä»¬éœ€è¦å‘ <code>pokemons</code> ä¸­æ’å…¥ä¸€åªå®å¯æ¢¦ï¼ŒåŒæ—¶è¦æƒ³ <code>types</code>
ä¸­æ’å…¥å®ƒçš„ç±»å‹ã€‚å¦‚æœè¿™ä¸¤æ¬¡æ’å…¥æœ‰ä¸€ä¸ªå¤±è´¥äº†ï¼Œè¿™æ¬¡æ’å…¥æœ€å¥½èƒ½å›æ»šã€‚ä½¿ç”¨äº‹åŠ¡æ—¶ï¼Œä½ éœ€è¦å…ˆåˆ›å»º <code>SQL</code> è¯­å¥ï¼Œä¹‹åæäº¤ã€‚å¦‚æœæœ‰é”™è¯¯å‘ç”Ÿï¼Œ<code>rusqlite</code>
ä¼šè‡ªåŠ¨å®Œæˆå›æ»šã€‚</p>
<pre><code class="language-rs">let transaction = match lock.transaction() {
    Ok(transaction) =&gt; transaction,
    _ =&gt; return Err(InsertError::Unknown),
};
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬è¦å‘äº‹åŠ¡ä¸­æ·»åŠ ç¬¬ä¸€æ¡å‘½ä»¤ã€‚æˆ‘ä»¬è¦æ’å…¥ä¸€åªå®å¯æ¢¦ã€‚å¦‚æœå·²ç»å­˜åœ¨ï¼Œæˆ‘ä»¬å¸Œæœ›å‡½æ•°æ‰§è¡Œå¤±è´¥å¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ï¼š</p>
<pre><code class="language-rs">use rusqlite::{..., Error::SqliteFailure, params};

...
match transaction.execute(
    &quot;insert into pokemons (number, name) values (?, ?)&quot;,
    params![u16::from(number.clone()), String::from(name.clone())],
) {
    Ok(_) =&gt; {}
    Err(SqliteFailure(_, Some(message))) =&gt; {
        if message == &quot;UNIQUE constraint failed: pokemons.number&quot; {
            return Err(InsertError::Conflict);
        } else {
            return Err(InsertError::Unknown);
        }
    }
    _ =&gt; return Err(InsertError::Unknown),
};
</code></pre>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>rusqlite</code> è¿”å›çš„é”™è¯¯ä¿¡æ¯æ¥æ£€æŸ¥é”™è¯¯æ˜¯å¦æ˜¯ç”±äºå†²çªå¼•èµ·çš„ã€‚ç°åœ¨å®å¯æ¢¦çš„æ’å…¥é€»è¾‘å®Œæˆäº†ã€‚</p>
<p>æ¥ä¸‹æ¥è¦å¤„ç†æ’å…¥ç±»å‹ã€‚æˆ‘ä»¬éœ€è¦ä¸º <code>PokemonTypes</code> å‚æ•°ä¸­çš„æ¯ç§ç±»å‹éƒ½åˆ†åˆ«æ‰§è¡Œä¸€æ¬¡æ’å…¥æ“ä½œï¼š</p>
<pre><code class="language-rs">...
for _type in Vec::&lt;String&gt;::from(types.clone()) {
    if let Err(_) = transaction.execute(
        &quot;insert into types (pokemon_number, name) values (?, ?)&quot;,
        params![u16::from(number.clone()), _type],
    ) {
        return Err(InsertError::Unknown);
    }
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æäº¤è¿™ä¸ªäº‹åŠ¡ï¼Œå¹¶è¿”å›ç»“æœã€‚</p>
<pre><code class="language-rs">...
match transaction.commit() {
    Ok(_) =&gt; Ok(Pokemon::new(number, name, types)),
    _ =&gt; Err(InsertError::Unknown),
}
</code></pre>
<h2 id="åˆ é™¤ä¸€åªå®å¯æ¢¦"><a class="header" href="#åˆ é™¤ä¸€åªå®å¯æ¢¦">åˆ é™¤ä¸€åªå®å¯æ¢¦</a></h2>
<pre><code class="language-rs">fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt; {
    // code will go here
}
</code></pre>
<pre><code class="language-rs">let lock = match self.connection.lock() {
    Ok(lock) =&gt; lock,
    _ =&gt; return Err(DeleteError::Unknown),
};
</code></pre>
<pre><code class="language-rs">match lock.execute(
    &quot;delete from pokemons where number = ?&quot;,
    params![u16::from(number)],
) {
    Ok(0) =&gt; Err(DeleteError::NotFound),
    Ok(_) =&gt; Ok(()),
    _ =&gt; Err(DeleteError::Unknown),
}
</code></pre>
<p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼šç¬¬ä¸€ï¼Œæˆ‘ä»¬ä¸éœ€è¦å†å…³æ³¨åˆ é™¤å®å¯æ¢¦æ—¶è®°å¾—åˆ é™¤ç±»å‹ä¿¡æ¯ï¼Œåœ¨åˆ›å»ºæ•°æ®è¡¨æ—¶æˆ‘ä»¬å·²ç»è®¾ç½®äº† <code>on delete cascade</code> è®© sqlite
å»è‡ªåŠ¨å¤„ç†ã€‚ç¬¬äºŒï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ é™¤æ“ä½œè¿”å›çš„è¡Œæ•°å»åˆ¤æ–­æ˜¯å¦åˆ é™¤æˆåŠŸï¼Œå¦‚æœæ•°é‡æ˜¯ 0ï¼Œå°±è¡¨ç¤ºåˆ é™¤å¤±è´¥ã€‚</p>
<p>ä½ ç°åœ¨åº”è¯¥èƒ½ä½¿ç”¨ä½ çš„ SQLite æ•°æ®åº“ä½œä¸ºå­˜å‚¨åº“äº†ï¼Œè€Œä¸”èƒ½é€šè¿‡ CLI å’Œ HTTP API ä¸¤ç§æ–¹å¼è®¿é—®ã€‚ä½ å¯ä»¥å°è¯•ä» CLI åˆ›å»ºä¸€äº›æ–°çš„å®å¯æ¢¦ï¼Œå¹¶ä»
HTTP API å»è·å–ä»–ä»¬ :)</p>
<h2 id="å°æ’æ›²"><a class="header" href="#å°æ’æ›²">å°æ’æ›²</a></h2>
<p>ğŸ™€ æˆ‘çœ‹åˆ°å®¢æˆ·äº†ï¼Œä»–æ­£æœç€æˆ‘è¿™è¾¹æ¥ã€‚</p>
<ul>
<li>ä½ å¥½ Alexisï¼</li>
<li>ä½ å¥½ å®¢æˆ·ï¼æˆ‘å·²ç»å®ç°äº†ä¸€ä¸ªæŒä¹…åŒ–çš„å­˜å‚¨åº“ï¼Œå®ƒæŠŠæ•°æ®å­˜å‚¨åœ¨è®¡ç®—æœºçš„ç¡¬ç›˜ä¸Šã€‚</li>
<li>å“¦ï¼Œå¤ªå¥½äº†ï¼è™½ç„¶ç°åœ¨æˆ‘çŸ¥é“äº†æˆ‘ä»¬å°†ä½¿ç”¨ä»€ä¹ˆä½œä¸ºå­˜å‚¨åº“ã€‚</li>
<li>ä¸é”™ï¼Œé€Ÿåº¦å¾ˆå¿«ã€‚æ˜¯ PostgreSQL å—ï¼Ÿè¿˜æ˜¯ Mysqlï¼Ÿ</li>
<li>éƒ½ä¸æ˜¯ï¼Œæˆ‘ä»¬çš„å…¬å¸å¸Œæœ›å®ƒæ˜¯æ°´å¹³å¯æ‹“å±•çš„ã€‚</li>
<li>å—¯ï¼Œè¿™è®©æˆ‘æƒ³èµ·äº†ä¸€ä¸ª<a href="https://www.youtube.com/watch?v=b2F-DItXtZs">ææ€–æ•…äº‹</a>ã€‚é‚£å¥½å§ï¼Œä½ ä»¬å…¬å¸æ‰“ç®—ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯ï¼Ÿ</li>
<li>ä»–ä»¬æƒ³ä½¿ç”¨ Airtableï¼Œä¸€ä¸ªç±»ä¼¼äº Excel çš„åœ¨çº¿è¡¨æ ¼ã€‚</li>
<li>å“¦... è®©æˆ‘çœ‹çœ‹æˆ‘èƒ½åšçš„ã€‚</li>
</ul>
<h2 id="ä½¿ç”¨-airtable-å®ç°å¼¹æ€§å­˜å‚¨åº“"><a class="header" href="#ä½¿ç”¨-airtable-å®ç°å¼¹æ€§å­˜å‚¨åº“">ä½¿ç”¨ Airtable å®ç°å¼¹æ€§å­˜å‚¨åº“</a></h2>
<p>å¥½å§ï¼Œç°åœ¨æˆ‘ä»¬å¿…é¡»åˆ›å»ºå¦ä¸€ä¸ªå­˜å‚¨åº“äº†ã€‚ç”Ÿæ´»å°±æ˜¯å¦‚æ­¤ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨å¯ä»¥å» Airtable
ç½‘ç«™çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆä½¿ç”¨çš„ã€‚ä½ å¿…é¡»åˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼Œå¹¶ä¸”æ–°å»ºä¸€ä¸ªå·¥ä½œåŒºã€‚åœ¨è¿™ä¸ªå·¥ä½œåŒºé‡Œï¼Œä½ åº”è¯¥æœ‰ä¸€ä¸ªé»˜è®¤çš„å·¥ä½œè¡¨ã€‚æŠŠä»–é‡å‘½åä¸º
<code>pokemons</code>ã€‚ä½ å¯ä»¥æŠŠè¡¨æ ¼çš„åˆ—æ”¹ä¸ºä¸‹é¢çš„æ ·å­ï¼š</p>
<pre><code>number:
    é€‰æ‹© Number ç±»å‹
    é€‰æ‹© Integer å­ç±»å‹
    å…³é—­å…è®¸è´Ÿæ•°
name:
    é€‰æ‹© Single line text ç±»å‹
types:
    é€‰æ‹© Multiple select ç±»å‹
    å†é€‰é¡¹é‡Œæ·»åŠ  Electric å’Œ Fire
</code></pre>
<p>æˆ‘ä»¬èƒ½ç”¨ä¸€å¼ æ•°æ®è¡¨å»ä¸ºæˆ‘ä»¬çš„æ•°æ®å»ºæ¨¡äº† : )</p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦çŸ¥é“æˆ‘ä»¬çš„ç¨‹åºæ€æ ·å’Œ Airtable è¿›è¡Œäº¤äº’ã€‚è®©æˆ‘ä»¬å»é˜…è¯»ä¸€ä¸‹ API æ–‡æ¡£ã€‚åœ¨é‚£é‡Œä½ åº”è¯¥èƒ½çœ‹åˆ° Airtable
ç°åœ¨æ”¯æŒçš„å®¢æˆ·ç«¯ï¼Œæ’°å†™æœ¬æ–‡æ—¶å¹¶æ²¡æœ‰æä¾› Rust çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å°è¯•ä½¿ç”¨å®ƒä»¬çš„ HTTP APIã€‚æˆ‘ä»¬çš„ç¨‹åºç°åœ¨éœ€è¦ä¸€ä¸ª HTTP å®¢æˆ·ç«¯ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨
<code>ureq</code>:</p>
<pre><code class="language-toml">[dependencies]
ureq = { version = &quot;2.2.0&quot;, features = [&quot;json&quot;] }
</code></pre>
<p>å¼€å¯ <code>json</code> ç‰¹æ€§èƒ½å¤Ÿå¸®æˆ‘ä»¬æŠŠ HTTP å“åº”è½¬åŒ–ä¸º ç»“æ„ä½“ ( æ„Ÿè°¢ <code>serde</code> )ã€‚ä½†æ˜¯å†æˆ‘ä»¬å®ç°å­˜å‚¨åº“ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å†ç¨‹åºå¼€å§‹å‰è®©ç”¨æˆ·èƒ½å¤Ÿé€‰æ‹©ä½¿ç”¨
Airtable ä½œä¸ºå­˜å‚¨åº“ã€‚</p>
<h3 id="æ·»åŠ å¯åŠ¨å¼€å…³"><a class="header" href="#æ·»åŠ å¯åŠ¨å¼€å…³">æ·»åŠ å¯åŠ¨å¼€å…³</a></h3>
<p>é¦–å…ˆè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ APIã€‚è¿™é‡Œæ˜¯æ–‡æ¡£ç»™å‡ºçš„ä¸€ä¸ªè¯·æ±‚ç¤ºä¾‹ï¼š</p>
<pre><code>curl https://api.airtable.com/v0/&lt;WORKSPACE_ID&gt;/pokemons -H &quot;Authorization: Bearer &lt;API_KEY&gt;&quot;
</code></pre>
<p>å¥½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç¨‹åºéœ€è¦ä¸¤ä¸ªå‚æ•° <code>api_key</code> å’Œ <code>workspace_id</code>ï¼š</p>
<pre><code class="language-rs">fn main() {
    let matches = App::new(crate_name!())
        .version(crate_version!())
        .author(crate_authors!())
        .arg(Arg::with_name(&quot;cli&quot;).long(&quot;cli&quot;).help(&quot;Runs in CLI mode&quot;))
        .arg(Arg::with_name(&quot;sqlite&quot;).long(&quot;sqlite&quot;).value_name(&quot;PATH&quot;))
        .arg(
            Arg::with_name(&quot;airtable&quot;)
                .long(&quot;airtable&quot;)
                .value_names(&amp;[&quot;API_KEY&quot;, &quot;WORKSPACE_ID&quot;]),
        )
        .get_matches();
}
</code></pre>
<p>ç°åœ¨ï¼Œè¿è¡Œ <code>pokedex --airtable &lt;API_KEY&gt; &lt;WORKSPACE_ID&gt;</code> å°±èƒ½è®¾ç½® Airtable ä½œä¸ºå­˜å‚¨åº“ï¼Œä½¿ç”¨ cargo
run å¯åŠ¨çš„è¯ï¼Œä½ å¯ä»¥è¾“å…¥ <code>cargo run -- --airtable &lt;API_KEY&gt; &lt;WORKSPACE_ID&gt;</code>ã€‚å¯ä»¥ä½¿ç”¨ <code>--help</code>
æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
<pre><code>OPTIONS:
        --airtable &lt;API_KEY&gt; &lt;WORKSPACE_ID&gt;
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ›´æ–° build_repo å‡½æ•°ï¼Œä½¿å®ƒèƒ½å¤Ÿåˆ›å»ºä¸€ä¸ª AirtableRepositoryï¼š</p>
<pre><code class="language-rs">use clap::{..., Values};
use repositories::pokemon::{AirtableRepository, ...};

fn main() {
    ...
    let repo = build_repo(matches.value_of(&quot;sqlite&quot;), matches.values_of(&quot;airtable&quot;));
    ...
}

fn build_repo(sqlite_value: Option&lt;&amp;str&gt;, airtable_values: Option&lt;Values&gt;) -&gt; Arc&lt;dyn Repository&gt; {
    if let Some(values) = airtable_values {
        if let [api_key, workspace_id] = values.collect::&lt;Vec&lt;&amp;str&gt;&gt;()[..] {
            match AirtableRepository::try_new(api_key, workspace_id) {
                Ok(repo) =&gt; return Arc::new(repo),
                _ =&gt; panic!(&quot;Error while creating airtable repo&quot;),
            }
        }
    }
    ...
}
</code></pre>
<p>æ‰€ä»¥ç°åœ¨å¦‚æœè®¾ç½®äº† <code>--airtable</code> æ ‡å¿—ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Airtable ä½œä¸ºå­˜å‚¨åº“ã€‚å¦‚æœè®¾ç½®äº† <code>--sqlite</code> æ ‡å¿—ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨
SQLiteã€‚å¦åˆ™æˆ‘ä»¬ä½¿ç”¨å†…å­˜å­˜å‚¨åº“ã€‚ç°åœ¨è®©æˆ‘ä»¬å®ç°å­˜å‚¨åº“ï¼›ï¼‰</p>
<h3 id="å®ç°å­˜å‚¨åº“"><a class="header" href="#å®ç°å­˜å‚¨åº“">å®ç°å­˜å‚¨åº“</a></h3>
<blockquote>
<p>æ³¨æ„ï¼šç½‘ç«™çš„ API ç»å¸¸å‘ç”Ÿå˜åŠ¨ï¼Œå¦‚æœä¸‹é¢çš„æµ‹è¯•å¤±è´¥äº†ï¼Œè¯·åˆ°<a href="https://airtable.com/api/meta">å®˜ç½‘</a>æŸ¥çœ‹æœ€æ–°çš„ APIã€‚</p>
</blockquote>
<p>æˆ‘å°†åœ¨ <em>repositories/pokemon.rs</em> ä¸­æ·»åŠ 
<code>AirtableRepository</code>ã€‚åƒä»¥å‰ä¸€æ ·ï¼Œæ‚¨å¯ä»¥å°†å…¶æ”¾åœ¨æ–°çš„æ–‡ä»¶ä¸­ã€‚è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">pub struct AirtableRepository {
    url: String,
    auth_header: String,
}
</code></pre>
<p>æˆ‘ä»¬ä¾ç„¶éœ€è¦å®ç° <code>try_new</code> å‡½æ•°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ <code>workspace_id</code> åˆ›å»º <code>url</code>ï¼Œä½¿ç”¨ <code>api_key</code> åˆ›å»º
<code>auth_header</code>ã€‚æ¥ç€è¿˜è¦å‘å‡ºè¯·æ±‚ä»¥ç¡®ä¿æˆ‘ä»¬å¯ä»¥è¿æ¥åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ï¼š</p>
<pre><code class="language-rs">impl AirtableRepository {
    pub fn try_new(api_key: &amp;str, workspace_id: &amp;str) -&gt; Result&lt;Self, ()&gt; {
        let url = format!(&quot;https://api.airtable.com/v0/{}/pokemons&quot;, workspace_id);
        let auth_header = format!(&quot;Bearer {}&quot;, api_key);

        if let Err(_) = ureq::get(&amp;url).set(&quot;Authorization&quot;, &amp;auth_header).call() {
            return Err(());
        }

        Ok(Self { url, auth_header })
    }
}
</code></pre>
<p>æ¥ç€æˆ‘ä»¬è¦ä¸ºå®ƒå®ç° <code>Repository</code> Traitï¼š</p>
<pre><code class="language-rs">impl Repository for AirtableRepository {
    fn insert(
        &amp;self,
        number: PokemonNumber,
        name: PokemonName,
        types: PokemonTypes,
    ) -&gt; Result&lt;Pokemon, InsertError&gt; {
        Err(InsertError::Unknown)
    }

    fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt; {
        Err(FetchAllError::Unknown)
    }

    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt; {
        Err(FetchOneError::Unknown)
    }

    fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt; {
        Err(DeleteError::Unknown)
    }
}
</code></pre>
<h4 id="è¾…åŠ©å‡½æ•°-1"><a class="header" href="#è¾…åŠ©å‡½æ•°-1">è¾…åŠ©å‡½æ•°</a></h4>
<p>ä½ ç°åœ¨åº”è¯¥å·²ç»ä¹ æƒ¯äº†ï¼Œè¿™æ¬¡æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªè¾…åŠ©å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°èƒ½è®©æˆ‘ä»¬ä» Airtable ä¸­è·å–æŸä¸€è¡Œæˆ–è€…å¤šè¡Œæ•°æ®ã€‚å®ƒçš„å‚æ•° <code>&amp;self</code> å’Œ ä¸€ä¸ªå¯é€‰çš„
<code>number</code>ã€‚å®ƒçš„è¿”å›å€¼å¯èƒ½æ˜¯ä¸ª <code>json</code> æˆ–è€…æ˜¯ä¸ª <code>Error</code>ã€‚å®ƒä¾ç„¶æ˜¯ä¸ªç§æœ‰çš„æ–¹æ³•ï¼Œå† <code>impl AirtableRepository</code>
å—ä¸­å®ç°ã€‚æœ‰äº† <code>serde</code> æˆ‘ä»¬èƒ½å°† <code>json</code> ç›´æ¥è½¬åŒ–ä¸ºç»“æ„ä½“ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å®šä¹‰å¯¹åº”çš„ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">#[derive(Deserialize)]
struct AirtableJson {
    records: Vec&lt;AirtableRecord&gt;,
}

#[derive(Deserialize)]
struct AirtableRecord {
    id: String,
    fields: AirtableFields,
}

#[derive(Deserialize)]
struct AirtableFields {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}
</code></pre>
<p>æ¥ç€æ˜¯è¾…åŠ©å‡½æ•°ï¼š</p>
<pre><code class="language-rs">fn fetch_pokemon_rows(&amp;self, number: Option&lt;u16&gt;) -&gt; Result&lt;AirtableJson, ()&gt; {
    // code will go here
}
</code></pre>
<p>ç¬¬ä¸€æ­¥è¦æ ¹æ®ç”¨æˆ·ä¼ æ¥çš„ <code>number</code> å»åˆ›å»ºè¯·æ±‚é“¾æ¥ï¼š</p>
<pre><code class="language-rs">let url = match number {
    Some(number) =&gt; format!(&quot;{}?filterByFormula=number%3D{}&quot;, self.url, number),
    None =&gt; format!(&quot;{}?sort%5B0%5D%5Bfield%5D=number&quot;, self.url),
};
</code></pre>
<p>è¯·æ±‚å‚æ•°çœ‹èµ·æ¥ç¨å¾®æœ‰ä¸€ç‚¹å¥‡æ€ªã€‚ç¬¬ä¸€ä¸ªæ˜¯ä¾é  <code>number</code> è¿›è¡Œè¿‡æ»¤ï¼Œç¬¬äºŒä¸ªæ˜¯æ ¹æ® <code>number</code> å¯¹æ•°æ®æ’åºã€‚ç°åœ¨æˆ‘ä»¬èƒ½ç”¨ <code>ureq</code> å°è¯•å‘å‡ºè¯·æ±‚äº†ï¼š</p>
<pre><code class="language-rs">let res = match ureq::get(&amp;url)
    .set(&quot;Authorization&quot;, &amp;self.auth_header)
    .call()
{
    Ok(res) =&gt; res,
    _ =&gt; return Err(()),
};
</code></pre>
<p>æˆ‘ä»¬åœ¨è¿”å›å€¼ä¸­æ¥æ”¶åˆ°äº† <code>json</code> ï¼Œæ¥ç€æˆ‘ä»¬æŠŠå®ƒè½¬æ¢ä¸º <code>AirtableJson</code>:</p>
<pre><code class="language-rs">match res.into_json::&lt;AirtableJson&gt;() {
    Ok(json) =&gt; Ok(json),
    _ =&gt; Err(()),
}
</code></pre>
<p>è¾…åŠ©å‡½æ•°å®Œæˆäº† : )</p>
<h4 id="æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦"><a class="header" href="#æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦">æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦</a></h4>
<pre><code class="language-rs">fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt; {
    // code will go here
}
</code></pre>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è®©ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å®ç°çš„å‡½æ•°è·å– <code>json</code> ï¼š</p>
<pre><code class="language-rs">let mut json = match self.fetch_pokemon_rows(Some(u16::from(number.clone()))) {
    Ok(json) =&gt; json,
    _ =&gt; return Err(FetchOneError::Unknown),
};
</code></pre>
<p>ç°åœ¨ï¼Œå¦‚æœ <code>json</code> è®°å½•ä¸ºç©ºï¼Œåˆ™æ„å‘³ç€æˆ‘ä»¬æƒ³è¦çš„å®å¯æ¢¦ä¸å­˜åœ¨ã€‚æ‰€ä»¥æˆ‘ä»¬ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚å¦åˆ™ï¼Œæˆ‘ä»¬å–ç¬¬ä¸€æ¡è®°å½•ï¼š</p>
<pre><code class="language-rs">...
if json.records.is_empty() {
    return Err(FetchOneError::NotFound);
}

let record = json.records.remove(0);
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯æŠŠè¿™æ¡è®°å½•è½¬æ¢ä¸ºå®å¯æ¢¦ï¼š</p>
<pre><code class="language-rs">...
match (
    PokemonNumber::try_from(record.fields.number),
    PokemonName::try_from(record.fields.name),
    PokemonTypes::try_from(record.fields.types),
) {
    (Ok(number), Ok(name), Ok(types)) =&gt; Ok(Pokemon::new(number, name, types)),
    _ =&gt; Err(FetchOneError::Unknown),
}
</code></pre>
<h4 id="è·å–æ‰€æœ‰å®å¯æ¢¦"><a class="header" href="#è·å–æ‰€æœ‰å®å¯æ¢¦">è·å–æ‰€æœ‰å®å¯æ¢¦</a></h4>
<pre><code class="language-rs">fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt; {
    // code will go here
}
</code></pre>
<p>é¦–å…ˆï¼Œä¾ç„¶æ˜¯ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å– <code>json</code> ï¼š</p>
<pre><code class="language-rs">let json = match self.fetch_pokemon_rows(None) {
    Ok(json) =&gt; json,
    _ =&gt; return Err(FetchAllError::Unknown),
};
</code></pre>
<p>è¿™ä¸€æ¬¡ï¼Œæˆ‘æ²¡æœ‰ç»™è¾…åŠ©å‡½æ•°æä¾› <code>number</code> ã€‚ç°åœ¨è®©æˆ‘ä»¬å°†è¿™äº›è®°å½•è½¬æ¢ä¸º <code>Pokemons</code> å¹¶è¿”å›ï¼š</p>
<pre><code class="language-rs">...
let mut pokemons = vec![];

for record in json.records.into_iter() {
    match (
        PokemonNumber::try_from(record.fields.number),
        PokemonName::try_from(record.fields.name),
        PokemonTypes::try_from(record.fields.types),
    ) {
        (Ok(number), Ok(name), Ok(types)) =&gt; {
            pokemons.push(Pokemon::new(number, name, types))
        }
        _ =&gt; return Err(FetchAllError::Unknown),
    }
}

Ok(pokemons)
</code></pre>
<h4 id="æ’å…¥ä¸€åªå®å¯æ¢¦-1"><a class="header" href="#æ’å…¥ä¸€åªå®å¯æ¢¦-1">æ’å…¥ä¸€åªå®å¯æ¢¦</a></h4>
<pre><code class="language-rs">fn insert(
    &amp;self,
    number: PokemonNumber,
    name: PokemonName,
    types: PokemonTypes,
) -&gt; Result&lt;Pokemon, InsertError&gt; {
    // code will go here
}
</code></pre>
<p>Airtable æœ¬èº«å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼š<code>AirtableRecord</code> çš„ä¸»é”®å¹¶ä¸èƒ½ä¿è¯æ•°æ®çš„å”¯ä¸€æ€§ã€‚æˆ–è®¸ä½ å·²ç»æ³¨æ„åˆ°äº† <code>AirtableRecord</code> ä¸­çš„
<code>id</code> å­—æ®µ :) å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½å°è¯•æ’å…¥è®°å½•å¹¶ç­‰å¾…è¿”å›é”™è¯¯ï¼ŒAirtable
åªä¼šè´Ÿè´£åœ¨è¡¨ä¸­æ·»åŠ æ–°è¡Œã€‚ç„¶åæˆ‘ä»¬è¦åšçš„æ˜¯é¦–å…ˆå°è¯•è·å–ç›¸åŒç¼–å·çš„å®å¯æ¢¦ï¼Œå¦‚æœæ­¤è¯·æ±‚çš„ç»“æœä¸ä¸ºç©ºï¼Œåˆ™è¿”å›é”™è¯¯ã€‚</p>
<pre><code class="language-rs">let json = match self.fetch_pokemon_rows(Some(u16::from(number.clone()))) {
    Ok(json) =&gt; json,
    _ =&gt; return Err(InsertError::Unknown),
};

if !json.records.is_empty() {
    return Err(InsertError::Conflict);
}
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å·²ç»åšåˆ°äº†ï¼Œæˆ‘ä»¬èƒ½ä¿è¯æ²¡æœ‰è®°å½•å…±äº«ç›¸åŒçš„ <code>number</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ’å…¥æˆ‘ä»¬çš„å®å¯æ¢¦ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code>json</code> è¯·æ±‚ï¼š</p>
<pre><code class="language-rs">...
let body = ureq::json!({
    &quot;records&quot;: [{
        &quot;fields&quot;: {
            &quot;number&quot;: u16::from(number.clone()),
            &quot;name&quot;: String::from(name.clone()),
            &quot;types&quot;: Vec::&lt;String&gt;::from(types.clone()),
        },
    }],
});
</code></pre>
<p>æœ€åï¼Œæˆ‘ä»¬è¦å¸¦ä¸Š <code>body</code> å‘å‡ºè¯·æ±‚ï¼Œå¹¶åœ¨æˆåŠŸæ—¶è¿”å› <code>Pokemon</code> ï¼š</p>
<pre><code class="language-rs">...
if let Err(_) = ureq::post(&amp;self.url)
    .set(&quot;Authorization&quot;, &amp;self.auth_header)
    .send_json(body)
{
    return Err(InsertError::Unknown);
}

Ok(Pokemon::new(number, name, types))
</code></pre>
<h4 id="åˆ é™¤ä¸€åªå®å¯æ¢¦-1"><a class="header" href="#åˆ é™¤ä¸€åªå®å¯æ¢¦-1">åˆ é™¤ä¸€åªå®å¯æ¢¦</a></h4>
<pre><code class="language-rs">fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt; {
    // code will go here
}
</code></pre>
<p>å’Œæ’å…¥æ—¶ä¸€æ ·ï¼Œæˆ‘ä»¬å¿…é¡»é¦–å…ˆå°è¯•æŸ¥è¯¢ä¸æˆ‘ä»¬ä¼ é€’çš„ <code>number</code> ç›¸åŒçš„è®°å½•ã€‚å½“è®°å½•ä¸ºç©ºæ—¶ï¼Œæˆ‘ä»¬ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬ä¸èƒ½åˆ é™¤ä¸å­˜åœ¨çš„è®°å½• : )
å¦åˆ™ï¼Œæˆ‘ä»¬å°†æ‹¿åˆ°ç¬¬ä¸€æ¡è®°å½•ã€‚</p>
<pre><code class="language-rs">let mut json = match self.fetch_pokemon_rows(Some(u16::from(number.clone()))) {
    Ok(json) =&gt; json,
    _ =&gt; return Err(DeleteError::Unknown),
};

if json.records.is_empty() {
    return Err(DeleteError::NotFound);
}

let record = json.records.remove(0);
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è®°å½•çš„ id å­—æ®µæ¥åˆ é™¤è®°å½•ï¼š</p>
<pre><code class="language-rs">...
match ureq::delete(&amp;format!(&quot;{}/{}&quot;, self.url, record.id))
    .set(&quot;Authorization&quot;, &amp;self.auth_header)
    .call()
{
    Ok(_) =&gt; Ok(()),
    _ =&gt; Err(DeleteError::Unknown),
}
</code></pre>
<h2 id="æ€»ç»“-1"><a class="header" href="#æ€»ç»“-1">æ€»ç»“</a></h2>
<p>ä½ ç°åœ¨åº”è¯¥èƒ½ä½¿ç”¨ å†…å­˜ï¼ŒAirtableï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª SQLite æ•°æ®åº“ä½œä¸ºç¨‹åºçš„å­˜å‚¨åº“ã€‚è€Œä¸”ä½ èƒ½é€šè¿‡ CLI å’Œ HTTP API ä¸¤ç§æ–¹å¼å»æ“ä½œ :D</p>
<p>é‚£æ˜¯æœ¬ç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« ã€‚æ„Ÿè°¢æ‚¨ä¸€ç›´çœ‹åˆ°è¿™é‡Œ :) æˆ‘å¸Œæœ›è¿™äº›æ–‡ç« å¯¹æ‚¨æœ‰ç”¨ã€‚</p>
<p>è¯¥ä»£ç ä¾ç„¶åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-7">github</a> ä¸ŠæŸ¥çœ‹ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-1/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-08-21---rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ"><a class="header" href="#2021-08-21---rust-å…­è¾¹å½¢æ¶æ„-1-åŸŸ">2021-08-21 - Rust å…­è¾¹å½¢æ¶æ„ #1 åŸŸ</a></h1>
<p>ä¸€æ®µæ—¶é—´ä»¥æ¥ï¼Œæˆ‘ä¸€ç›´åœ¨é˜…è¯»å¾ˆå¤šå…³äº<a href="https://alistair.cockburn.us/hexagonal-architecture/">å…­è¾¹å½¢æ¶æ„</a>ã€<a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">å¹²å‡€æ¶æ„</a>ç­‰çš„æ–‡ç« å’Œä¹¦ç±ã€‚æˆ‘ä¹Ÿå·²ç»å¬è¿‡äº†å¾ˆå¤šæ¼”è®²ã€‚åœ¨å­¦ä¹ è¿™äº›ä¸»é¢˜çš„è¿™æ®µæ—¶é—´é‡Œï¼Œæˆ‘ä¸€ç›´åœ¨æƒ³å¦‚ä½•åœ¨
Rust ä¸­å®ç°å®ƒä»¬ï¼Œå› ä¸ºæˆ‘çŸ¥é“ Rust çš„æ‰€æœ‰æƒæ¨¡å‹å¯èƒ½ä¼šè®©å®ƒå®ç°èµ·æ¥ç›¸å¯¹å›°éš¾ä¸€äº›ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« æ˜¯æˆ‘ç”¨æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨æˆ‘æåˆ°çš„æ¨¡å¼æ¥å®ç°è½¯ä»¶çš„ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ã€‚</p>
<h2 id="å…­è¾¹å½¢æ¶æ„"><a class="header" href="#å…­è¾¹å½¢æ¶æ„">å…­è¾¹å½¢æ¶æ„</a></h2>
<p>å…­è¾¹å½¢æ¶æ„ã€<a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">æ´‹è‘±æ¶æ„</a>ã€å¹²å‡€æ¶æ„â€¦â€¦è¿™äº›æ¶æ„å…¶å®éƒ½æ˜¯ä¸€å›äº‹ï¼Œæ‰€ä»¥ä»ç°åœ¨å¼€å§‹æˆ‘ä¼šä¸»è¦ä»‹ç»å…­è¾¹å½¢æ¶æ„ã€‚</p>
<p>å…­è¾¹å½¢æ¶æ„æ˜¯è®©ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†ç‹¬ç«‹äºå®ƒçš„ä¾èµ–é¡¹ã€‚æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸ç§°ä¸º <strong>åŸŸ
(Domain)</strong>ï¼Œå®ƒæ˜¯æ‰€æœ‰ä¸šåŠ¡è§„åˆ™å’Œå®ä½“çš„æ‰€åœ¨ä½ç½®ã€‚ä¾èµ–é¡¹åŸºæœ¬ä¸Šæ˜¯ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ï¼šæ•°æ®åº“ã€æ¡†æ¶ã€åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ç­‰éƒ½åŒ…å«åœ¨å†…ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™ç§æ¶æ„æ˜¯ä¸€ç§å°†ä¸šåŠ¡éƒ¨åˆ†ä¸å®ç°ç»†èŠ‚è§£è€¦çš„æ–¹æ³•ã€‚</p>
<p>è¿™ç§æ¶æ„æœ‰ä»¥ä¸‹ä¸€äº›ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ä½ å¯ä»¥æ›´æ”¹åŸŸè€Œä¸æ›´æ”¹ä¾èµ–é¡¹</li>
<li>ä½ å¯ä»¥åœ¨ä¸æ›´æ”¹åŸŸçš„æƒ…å†µä¸‹æ›´æ”¹ä¾èµ–é¡¹</li>
<li>ä½ å¯ä»¥æ›´å®¹æ˜“æµ‹è¯•é¡¹</li>
<li>ä½ å¯ä»¥åœ¨éœ€è¦æ—¶è€ƒè™‘ä½¿ç”¨å“ªäº›ä¾èµ–ï¼Œè€Œä¸æ˜¯åœ¨ä¸€å¼€å§‹å°±å»å®ç°ä¸šåŠ¡ç»†èŠ‚</li>
</ul>
<h2 id="ä¸€ä¸ªç–¯ç‹‚çš„ä¸šåŠ¡éœ€æ±‚å‡ºç°äº†"><a class="header" href="#ä¸€ä¸ªç–¯ç‹‚çš„ä¸šåŠ¡éœ€æ±‚å‡ºç°äº†">ä¸€ä¸ªç–¯ç‹‚çš„ä¸šåŠ¡éœ€æ±‚å‡ºç°äº†ï¼</a></h2>
<p>ä¸€å¤©æ—©ä¸Šï¼Œæˆ‘ä»¬çš„å®¢æˆ·æ¥æ‰¾æˆ‘ä»¬ï¼š</p>
<ul>
<li>å—¨ï¼Œæˆ‘éœ€è¦ä¸€ä¸ªè½¯ä»¶æ¥ç®¡ç†å®å¯æ¢¦ã€‚</li>
<li>å¥½çš„ï¼Œä½ æƒ³å¯¹è¿™äº›å®å¯æ¢¦åšäº›ä»€ä¹ˆï¼Ÿ</li>
<li>æˆ‘éœ€è¦åˆ›å»ºæ–°çš„å®å¯æ¢¦ï¼Œåˆ é™¤å®ƒä»¬ï¼Œè¿˜æœ‰æœç´¢å®ƒä»¬ã€‚</li>
<li>å¤§ä½“äº†è§£äº†ã€‚æ‚¨å¸Œæœ›å¦‚ä½•è®¿é—®æ‚¨çš„ç³»ç»Ÿï¼Ÿä½¿ç”¨æµè§ˆå™¨è¿˜æ˜¯ä½¿ç”¨ç»ˆç«¯ï¼Ÿ</li>
<li>å‘ƒï¼Œæˆ‘çœŸçš„ä¸çŸ¥é“...</li>
<li>ä½ æƒ³åœ¨å“ªé‡Œå­˜æ”¾å®å¯æ¢¦ï¼Ÿä½ ä»¬æ˜¯å¦æä¾›å¯¹è±¡å­˜å‚¨æœåŠ¡çš„æ•°æ®åº“æˆ–å¸å·ï¼Ÿ</li>
<li>ä»€ä¹ˆæ˜¯æ•°æ®åº“ï¼Ÿ</li>
</ul>
<p>åœ¨è¿™é‡Œï¼Œå¯ä»¥è¯´å®¢æˆ·ä¸çŸ¥é“ä»–æƒ³è¦ä»€ä¹ˆã€‚ä½†äº‹å®ä¸Šï¼Œç›®å‰æˆ‘ä»¬çœŸçš„ä¸éœ€è¦çŸ¥é“è¿™äº›é—®é¢˜çš„ç­”æ¡ˆã€‚é‡è¦çš„æ˜¯ <strong>ç”¨ä¾‹ (Usecase)</strong>ã€‚è®©æˆ‘ä»¬æŠŠå®¢æˆ·çš„éœ€æ±‚é‡å†™ä¸€ä¸‹ï¼š</p>
<ul>
<li>åˆ›å»ºä¸€åªå®å¯æ¢¦</li>
<li>æŸ¥è¯¢æ‰€æœ‰å®å¯æ¢¦</li>
<li>æŸ¥è¯¢ä¸€åªå®å¯æ¢¦</li>
<li>åˆ é™¤ä¸€åªå®å¯æ¢¦</li>
</ul>
<h2 id="æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç”¨ä¾‹"><a class="header" href="#æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç”¨ä¾‹">æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç”¨ä¾‹</a></h2>
<p>æˆ‘ä»¬çš„é¡¹ç›®å°†ç”¨ Rust å®ç°ï¼Œå›æ”¶æ ‡é¢˜ : )ï¼Œè®©æˆ‘ä»¬é¦–å…ˆæ–°å»ºä¸€ä¸ªé¡¹ç›®</p>
<pre><code class="language-shell">cargo new pokedex
</code></pre>
<p>æ¥ç€æˆ‘ä»¬åˆ›å»ºç¬¬ä¸€ä¸ªç”¨ä¾‹ <em>domain/create_pokemon.rs</em>:</p>
<pre><code>src
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ create_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â””â”€â”€ main.rs
</code></pre>
<p>ä¸è¦å¿˜è®°åŠ  <em>mod.rs</em></p>
<pre><code class="language-rs">// main.rs
mod domain;

// domain/mod.rs
mod create_pokemon;
</code></pre>
<p>æˆ‘å–œæ¬¢åšçš„æ˜¯é¦–å…ˆç¼–å†™æµ‹è¯•ï¼Œå°±å¥½åƒä»£ç å·²ç»ç¼–å†™å¥½äº†ä¸€æ ·ã€‚å®ƒèƒ½å¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„ APIã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ‰“å¼€ <em>domain/create_pokemon.rs</em>
å¹¶æ·»åŠ æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn it_should_return_the_pokemon_number_otherwise() {
        let number = 25;
        let req = Request {
            number,
            name: String::from(&quot;Pikachu&quot;),
            types: vec![String::from(&quot;Electric&quot;)],
        };

        let res = execute(req);

        assert_eq!(res, number);
    }
}
</code></pre>
<p>å½“ç„¶ï¼Œç°åœ¨è¿˜ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª <code>Request</code> ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">struct Request {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}
</code></pre>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨ <code>Request</code>
ç»“æ„ä½“ä¸­ä½¿ç”¨èŠ±å“¨çš„ç±»å‹ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›è°ƒç”¨æˆ‘ä»¬ç”¨ä¾‹çš„ä»£ç çŸ¥é“åŸŸä¸­å…·ä½“çš„å®ä½“ã€‚æ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹äºä¾èµ–é¡¹çš„åŸŸã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦å®ç° <code>execute</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">fn execute(req: Request) -&gt; u16 {
    req.number
}
</code></pre>
<p>æœ‰ç”¨ï¼è®©æˆ‘ä»¬æŠŠå®ƒäº¤ç»™æˆ‘ä»¬çš„å®¢æˆ·ï¼æˆ‘ä¸ç¡®å®šä»–æ‹¿åˆ°è¿™ä¸ªç»“æœæ˜¯å¦ä¼šé«˜å…´ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰æ£€æŸ¥è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚å¦‚æœ <code>number</code>
ä¸åœ¨æ­£ç¡®çš„èŒƒå›´å†…æ€ä¹ˆåŠï¼Ÿå¦‚æœç»™å®šçš„ <code>name</code> æ˜¯ç©ºå­—ç¬¦ä¸²æ€ä¹ˆåŠï¼Ÿå¦‚æœå®å¯æ¢¦ä¸–ç•Œä¸­ä¸å­˜åœ¨å…¶ä¸­ä¸€ç§ç±»å‹æ€ä¹ˆåŠï¼Ÿè®©æˆ‘ä»¬ç°åœ¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜ : )</p>
<h2 id="å®ä½“"><a class="header" href="#å®ä½“">å®ä½“</a></h2>
<p>è®©æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªæ–°æµ‹è¯•ç”¨ä¾‹ï¼Œç”¨æ¥ç¡®ä¿ç”¨ä¾‹åœ¨è¯·æ±‚æ ¼å¼é”™è¯¯æ—¶ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_a_bad_request_error_when_request_is_invalid() {
    let req = Request {
        number: 25,
        name: String::from(&quot;&quot;),
        types: vec![String::from(&quot;Electric&quot;)],
    };

    let res = execute(req);

    match res {
        Response::BadRequest =&gt; {}
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>å› ä¸ºæ²¡æœ‰æˆ‘ä»¬å®ç° <code>Response</code>ç»“æ„ä½“ï¼Œæ‰€ä»¥ç°åœ¨è¿˜æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸ºç°åœ¨æˆ‘ä»¬çš„ç”¨ä¾‹ (execute å‡½æ•°) è°ƒç”¨ååªä¼šè¿”å›ä¸€ä¸ªæ•´å½¢
<code>u16</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æŠŠå®ƒçš„è¿”å›å€¼ç±»å‹æ”¹ä¸º <code>Response</code>ï¼š</p>
<pre><code class="language-rs">enum Response {
    Ok(u16),
    BadRequest,
}

fn execute(req: Request) -&gt; Response {
    Response::BadRequest
}
</code></pre>
<p>åŒæ—¶è¿˜åº”è¯¥æ›´æ”¹ä¸Šä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹å»æ£€æŸ¥å½“è¯·æ±‚æ ¼å¼æ­£ç¡®æ—¶ï¼Œç”¨ä¾‹ä¼šè¿”å› <code>Ok</code> ï¼š</p>
<pre><code class="language-rs">match res {
    Response::Ok(res_number) =&gt; assert_eq!(res_number, number),
    _ =&gt; unreachable!(),
};
</code></pre>
<p>ç°åœ¨ï¼Œä»£ç ç¼–è¯‘æˆåŠŸäº†ï¼ä½†æ˜¯æ£€æŸ¥ <code>Ok</code> çš„æµ‹è¯•å¤±è´¥äº†ï¼Œå› ä¸ºç°åœ¨ <code>execute</code> åªä¼šè¿”å› <code>Response::BadRequest</code>ã€‚
æˆ‘ä»¬ç¨åä¼šåœ¨æ¥å¤„ç†å®ƒã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¦å®šä¹‰åœ¨è¯·æ±‚ä¸­è·å¾—å€¼çš„ä¸šåŠ¡è§„åˆ™ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ <code>domain/entities.rs</code> æ¥å­˜å‚¨å®ƒä»¬ã€‚</p>
<h3 id="å®å¯æ¢¦æ•°é‡"><a class="header" href="#å®å¯æ¢¦æ•°é‡">å®å¯æ¢¦æ•°é‡</a></h3>
<p>è¿™ä¸ªæ•°å­—çš„èŒƒå›´å¿…é¡»å¤§äº 0, å°äº 899ï¼š</p>
<pre><code class="language-rs">pub struct PokemonNumber(u16);

impl TryFrom&lt;u16&gt; for PokemonNumber {
    type Error = ();

    fn try_from(n: u16) -&gt; Result&lt;Self, Self::Error&gt; {
        if n &gt; 0 &amp;&amp; n &lt; 899 {
            Ok(Self(n))
        } else {
            Err(())
        }
    }
}

impl From&lt;PokemonNumber&gt; for u16 {
    fn from(n: PokemonNumber) -&gt; u16 {
        n.0
    }
}
</code></pre>
<h3 id="å®å¯æ¢¦åç§°"><a class="header" href="#å®å¯æ¢¦åç§°">å®å¯æ¢¦åç§°</a></h3>
<p>åç§°ä¸èƒ½æ˜¯ç©ºå­—ç¬¦ä¸²</p>
<pre><code class="language-rs">pub struct PokemonName(String);

impl TryFrom&lt;String&gt; for PokemonName {
    type Error = ();

    fn try_from(n: String) -&gt; Result&lt;Self, Self::Error&gt; {
        if n.is_empty() {
            Err(())
        } else {
            Ok(Self(n))
        }
    }
}
</code></pre>
<h3 id="å®å¯æ¢¦å±æ€§"><a class="header" href="#å®å¯æ¢¦å±æ€§">å®å¯æ¢¦å±æ€§</a></h3>
<p>å±æ€§ä¸èƒ½æ˜¯ç©ºåˆ—è¡¨ï¼Œè€Œä¸”æ‰€æœ‰ç±»å‹éƒ½å¿…é¡»æ˜¯å·²ç»å®šä¹‰è¿‡çš„ã€‚ç°åœ¨æˆ‘ä»¬æš‚æ—¶åªå®šä¹‰ä¸€ä¸ªç”µå±æ€§ <code>Electric</code>ã€‚</p>
<pre><code class="language-rs">pub struct PokemonTypes(Vec&lt;PokemonType&gt;);

impl TryFrom&lt;Vec&lt;String&gt;&gt; for PokemonTypes {
    type Error = ();

    fn try_from(ts: Vec&lt;String&gt;) -&gt; Result&lt;Self, Self::Error&gt; {
        if ts.is_empty() {
            Err(())
        } else {
            let mut pts = vec![];
            for t in ts.iter() {
                match PokemonType::try_from(String::from(t)) {
                    Ok(pt) =&gt; pts.push(pt),
                    _ =&gt; return Err(()),
                }
            }
            Ok(Self(pts))
        }
    }
}

enum PokemonType {
    Electric,
}

impl TryFrom&lt;String&gt; for PokemonType {
    type Error = ();

    fn try_from(t: String) -&gt; Result&lt;Self, Self::Error&gt; {
        match t.as_str() {
            &quot;Electric&quot; =&gt; Ok(Self::Electric),
            _ =&gt; Err(()),
        }
    }
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å»æ›´æ–°ä¸€ä¸‹ <code>execute</code> å‡½æ•°</p>
<pre><code class="language-rs">fn execute(req: Request) -&gt; Response {
    match (
        PokemonNumber::try_from(req.number),
        PokemonName::try_from(req.name),
        PokemonTypes::try_from(req.types),
    ) {
        (Ok(number), Ok(_), Ok(_)) =&gt; Response::Ok(u16::from(number)),
        _ =&gt; Response::BadRequest,
    }
}
</code></pre>
<p>å¹²çš„å¥½ï¼Œæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼</p>
<h2 id="ä¸‹ä¸€æ­¥-1"><a class="header" href="#ä¸‹ä¸€æ­¥-1">ä¸‹ä¸€æ­¥</a></h2>
<p>åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å¦‚ä½•å®ç°å¤šä¸ª <strong>å­˜å‚¨åº“ (Reposity)</strong> å»å­˜å‚¨å®å¯æ¢¦ã€‚æ‰€æœ‰çš„å­˜å‚¨åº“éƒ½ä¼šå®ç°åŒä¸€ä¸ª
<strong><code>Trait</code></strong>ï¼Œå› æ­¤è¿™äº›å­˜å‚¨åº“èƒ½å¤Ÿéå¸¸æ–¹ä¾¿çš„è¿›è¡Œæ‹“å±• (pluggable) å’Œæ›´æ¢ (exchangeable)ï¼Œæˆ‘ä»¬è¿˜å°†ä¸ºç”¨ä¾‹ç»™å‡ºå¤šç§å‰ç«¯å®ç°ï¼Œä»¥ä¾¿èƒ½å¤Ÿé€šè¿‡å¤šç§å‰ç«¯æ¥å£å»è®¿é—®æˆ‘ä»¬çš„ç³»ç»Ÿã€‚</p>
<p>ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-1">Github</a> ä¸ŠæŸ¥çœ‹</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-5/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-09-12---rust-å…­è¾¹å½¢æ¶æ„-5---å…¶ä»–ç”¨ä¾‹"><a class="header" href="#2021-09-12---rust-å…­è¾¹å½¢æ¶æ„-5---å…¶ä»–ç”¨ä¾‹">2021-09-12 - Rust å…­è¾¹å½¢æ¶æ„ #5 - å…¶ä»–ç”¨ä¾‹</a></h1>
<p>ä¸Šæ¬¡ï¼Œæˆ‘ä»¬åšäº†ä¸€äº›é‡æ„ã€‚ä¸çŸ¥ä½•æ•…ï¼Œæˆ‘ä»¬çš„å®¢æˆ·å¯¹æˆ‘ä»¬å¾ˆç”Ÿæ°”â€¦â€¦æˆ‘çš„æ„æ€æ˜¯ï¼Œä»–åº”è¯¥é«˜å…´ï¼Œä»£ç ç°åœ¨æ¯”ä»¥å‰æ›´å¹²å‡€äº†ã€‚</p>
<p>åœ¨åƒå®Œä¸€å—è›‹ç³•ä¹‹å (æ˜¾ç„¶ï¼Œè¿™æ˜¯æˆ‘ä»¬åº”å¾—çš„)ï¼Œè®©æˆ‘ä»¬ç»§ç»­å®ç°å‰©ä¸‹çš„ç”¨ä¾‹ã€‚è¿™ç¯‡æ–‡ç« å¯èƒ½ä¼šæœ‰ç‚¹é•¿ï¼Œä½†æ˜¯ï¼Œå˜¿ï¼Œå¦‚æœä½ ä¸æƒ³é˜…è¯»æ•´ä¸ªè¿‡ç¨‹ï¼Œä»£ç åœ¨ github ä¸Š : )
æˆ‘ä»¬å°†å®ç°çš„ç”¨ä¾‹æ˜¯ï¼š</p>
<ul>
<li>è·å–æ‰€æœ‰å®å¯æ¢¦</li>
<li>æŸ¥è¯¢ä¸€åªå®å¯æ¢¦</li>
<li>åˆ é™¤ä¸€åªå®å¯æ¢¦</li>
</ul>
<h2 id="è·å–æ‰€æœ‰å®å¯æ¢¦-1"><a class="header" href="#è·å–æ‰€æœ‰å®å¯æ¢¦-1">è·å–æ‰€æœ‰å®å¯æ¢¦</a></h2>
<p>åƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬å°†ä»æµ‹è¯•å¼€å§‹ã€‚è®©æˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨ä¾‹ æ–‡ä»¶ï¼š<em>domain/fetch_all_pokemons.rs</em>ï¼š</p>
<pre><code class="language-rs">// domain/mod.rs
pub mod fetch_all_pokemons;
</code></pre>
<p>è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªç”¨ä¾‹æœ‰å“ªäº›å¯èƒ½çš„ç»“æœï¼Ÿ</p>
<ol>
<li>æˆåŠŸäº†ï¼Œæˆ‘ä»¬å¾—åˆ°äº†å®å¯æ¢¦</li>
<li>å­˜å‚¨åº“ä¸­å‘ç”Ÿäº†æœªçŸ¥é”™è¯¯ï¼Œæˆ‘ä»¬æ— æ³•å¾—åˆ°æˆ‘ä»¬çš„å®å¯æ¢¦</li>
</ol>
<p>è®©æˆ‘ä»¬å…ˆä»é”™è¯¯æ¡ˆä¾‹å¼€å§‹ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
mod tests {
    use super::*;
    use crate::repositories::pokemon::InMemoryRepository;

    #[test]
    fn it_should_return_an_unknown_error_when_an_unexpected_error_happens() {
        let repo = Arc::new(InMemoryRepository::new().with_error());

        let res = execute(repo);

        match res {
            Err(Error::Unknown) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }
}
</code></pre>
<p>å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»ç„¶æ²¡æœ‰å†™ä¸€è¡Œä»£ç ï¼Œåªå†™äº†æµ‹è¯•ã€‚å½“ç„¶ï¼Œç°åœ¨è¿˜ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚è¿™é‡Œæœ‰ä¸¤ä»¶äº‹å¾ˆæœ‰è¶£ï¼š</p>
<ul>
<li>è¿™é‡Œçš„æµ‹è¯•å’Œåˆ›å»ºå®å¯æ¢¦é‚£é‡Œå‡ ä¹ä¸€æ ·</li>
<li>è¿™é‡Œä¸éœ€è¦ repo ä¹‹å¤–çš„å…¶ä»–å‚æ•°</li>
</ul>
<p>æ¥ä¸‹æ¥è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›å¿…è¦çš„ä»£ç è®©æµ‹è¯•é€šè¿‡ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;
use std::sync::Arc;

pub enum Error {
    Unknown,
}

pub fn execute(repo: Arc&lt;dyn Repository&gt;) -&gt; Result&lt;(), Error&gt; {
    Err(Error::Unknown)
}
</code></pre>
<p>æ¥ç€ç»§ç»­æ·»åŠ ä¸‹ä¸€ä¸ªæµ‹è¯•ï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_all_the_pokemons_ordered_by_increasing_number_otherwise() {
    let repo = Arc::new(InMemoryRepository::new());
    repo.insert(
        PokemonNumber::pikachu(),
        PokemonName::pikachu(),
        PokemonTypes::pikachu(),
    )
    .ok();
    repo.insert(
        PokemonNumber::charmander(),
        PokemonName::charmander(),
        PokemonTypes::charmander(),
    )
    .ok();

    let res = execute(repo);

    match res {
        Ok(res) =&gt; {
            assert_eq!(res[0].number, u16::from(PokemonNumber::charmander()));
            assert_eq!(res[0].name, String::from(PokemonName::charmander()));
            assert_eq!(res[0].types, Vec::&lt;String&gt;::from(PokemonTypes::charmander()));
            assert_eq!(res[1].number, u16::from(PokemonNumber::pikachu()));
            assert_eq!(res[1].name, String::from(PokemonName::pikachu()));
            assert_eq!(res[1].types, Vec::&lt;String&gt;::from(PokemonTypes::pikachu()));
        }
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>åœ¨æµ‹è¯•é‡Œï¼Œæˆ‘æŒ‰ç…§ <code>number</code> é€’å‡çš„é¡ºåºæ’å…¥äº†å®å¯æ¢¦ï¼Œæ‰€ä»¥å­˜å‚¨åº“ä¸­å®å¯æ¢¦çš„æ’åºåº”è¯¥æ˜¯ç¡®å®šçš„ã€‚å½“å­˜å‚¨åº“æ²¡æœ‰è¾“å‡ºé”™è¯¯æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½ä»ç”¨ä¾‹ä¸­å¾—åˆ°ä¸€ä¸ª
<code>Vec&lt;Response&gt;</code>ã€‚ç°åœ¨æˆ‘ä»¬è¦ä¸ºç”¨ä¾‹åŠ å…¥ <code>Response</code>ï¼Œå¹¶ç¼–å†™ä¸€éƒ¨åˆ†ç”¨ä¾‹å‡½æ•°çš„å†…å®¹ï¼š</p>
<pre><code class="language-rs">pub struct Response {
    pub number: u16,
    pub name: String,
    pub types: Vec&lt;String&gt;,
}

pub fn execute(repo: Arc&lt;dyn Repository&gt;) -&gt; Result&lt;Vec&lt;Response&gt;, Error&gt; {
    match repo.fetch_all() {
        Ok(pokemons) =&gt; Ok(pokemons
            .into_iter()
            .map(|p| Response {
                number: u16::from(p.number),
                name: String::from(p.name),
                types: Vec::&lt;String&gt;::from(p.types),
            })
            .collect::&lt;Vec&lt;Response&gt;&gt;()),
        Err(FetchAllError::Unknown) =&gt; Err(Error::Unknown),
    }
}
</code></pre>
<p>ç„¶åå†ä¸ºå­˜å‚¨åº“æ·»åŠ å¹¶å®ç° <code>fetch_all</code> æ–¹æ³•ï¼š</p>
<pre><code class="language-rs">pub enum FetchAllError {
    Unknown,
}

pub trait Repository: Send + Sync {
    fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt;;
}

impl Repository for InMemoryRepository {
    fn fetch_all(&amp;self) -&gt; Result&lt;Vec&lt;Pokemon&gt;, FetchAllError&gt; {
        if self.error {
            return Err(FetchAllError::Unknown);
        }

        let lock = match self.pokemons.lock() {
            Ok(lock) =&gt; lock,
            _ =&gt; return Err(FetchAllError::Unknown),
        };

        let mut pokemons = lock.to_vec();
        pokemons.sort_by(|a, b| a.number.cmp(&amp;b.number));
        Ok(pokemons)
    }
}
</code></pre>
<p>ä¸ºäº†å®ç°å®å¯æ¢¦æŒ‰ç…§ <code>number</code> æ’åºï¼Œ<code>PokemonNumber</code> éœ€è¦å®ç° <code>PartialEq</code>ã€ <code>Eq</code>ã€<code>PartialOrd</code>ã€<code>Ord</code>
è¿™ 4 ä¸ª Trait</p>
<pre><code class="language-rs">#[derive(Clone, PartialEq, Eq, PartialOrd, Ord)]
pub struct PokemonNumber(u16);
</code></pre>
<p>è¿è¡Œ c<code>argo test</code>ï¼š</p>
<pre><code>cargo test
running 6 tests
...
it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
it_should_return_all_the_pokemons_ordered_by_increasing_number_otherwise ... ok
</code></pre>
<p>æˆ‘ä»¬å·²ç»å®Œæˆäº†è¿™ä¸ªç”¨ä¾‹ :) ç°åœ¨è®©æˆ‘ä»¬å¿«é€Ÿå®ç° apiã€‚åœ¨ <em>api/mod.rs</em> ä¸­ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-rs">mod fetch_all_pokemons;

// in the router macro
(GET) (/) =&gt; {
    fetch_all_pokemons::serve(repo.clone())
}
</code></pre>
<p>æ¥ç€å®ç°å…·ä½“çš„ handler api/fetch_all_pokemons.rsï¼š</p>
<pre><code class="language-rs">use crate::api::Status;
use crate::domain::fetch_all_pokemons;
use crate::repositories::pokemon::Repository;
use rouille;
use serde::Serialize;
use std::sync::Arc;

#[derive(Serialize)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn serve(repo: Arc&lt;dyn Repository&gt;) -&gt; rouille::Response {
    match fetch_all_pokemons::execute(repo) {
        Ok(res) =&gt; rouille::Response::json(
            &amp;res.into_iter()
                .map(|p| Response {
                    number: p.number,
                    name: p.name,
                    types: p.types,
                })
                .collect::&lt;Vec&lt;Response&gt;&gt;(),
        ),
        Err(fetch_all_pokemons::Error::Unknown) =&gt; {
            rouille::Response::from(Status::InternalServerError)
        }
    }
}
</code></pre>
<p>ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œ <code>cargo run</code>ï¼Œå¹¶ä½¿ç”¨ä½ æœ€å–œæ¬¢çš„ HTTP å®¢æˆ·ç«¯ (curlã€postmanã€...)ã€‚é€šè¿‡åœ¨ <code>/</code> ä¸Šå‘é€ POST
è¯·æ±‚æ¥åˆ›å»ºä¸€äº›å®å¯æ¢¦ã€‚ç„¶åæ‚¨å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://localhost:8000ã€‚è¿™æ˜¯æˆ‘å¾—åˆ°çš„ï¼š</p>
<pre><code class="language-json">[
  {
    &quot;number&quot;: 4,
    &quot;name&quot;: &quot;Charmander&quot;,
    &quot;types&quot;: [
      &quot;Fire&quot;
    ]
  },
  {
    &quot;number&quot;: 25,
    &quot;name&quot;: &quot;Pikachu&quot;,
    &quot;types&quot;: [
      &quot;Electric&quot;
    ]
  }
]
</code></pre>
<h2 id="æŸ¥è¯¢ä¸€åªå®å¯æ¢¦-1"><a class="header" href="#æŸ¥è¯¢ä¸€åªå®å¯æ¢¦-1">æŸ¥è¯¢ä¸€åªå®å¯æ¢¦</a></h2>
<p>ç¬¬äºŒä¸ªç”¨ä¾‹ï¼ç°åœ¨æˆ‘ä»¬æƒ³é€šè¿‡ç»™ç³»ç»Ÿä¸€ä¸ªå®å¯æ¢¦çš„ç¼–å·æ¥è·å–ä¸€ä¸ªå®å¯æ¢¦ã€‚è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç”¨ä¾‹æ–‡ä»¶ <em>domain/fetch_pokemon.rs</em>ï¼š</p>
<pre><code class="language-rs">// domain/mod.rs
pub mod fetch_pokemon;
</code></pre>
<p>è®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ç”¨ä¾‹è¿è¡Œæ—¶å¯èƒ½é‡åˆ°ä»€ä¹ˆæƒ…å†µã€‚</p>
<ol>
<li>å­˜å‚¨åº“å¯èƒ½ä¼šå¼•å‘æœªçŸ¥é”™è¯¯ã€‚</li>
<li>è¯·æ±‚å‚æ•°å¯èƒ½æ˜¯ä¸åˆæ³•çš„ã€‚</li>
<li>ç”¨æˆ·ç»™å®šçš„ç¼–å·å¯èƒ½å¯¹åº”æ²¡æœ‰å®å¯æ¢¦ã€‚</li>
<li>è·å¾—å®å¯æ¢¦æˆåŠŸäº†</li>
</ol>
<p>è®©æˆ‘ä»¬ä»æœªçŸ¥é”™è¯¯çš„æµ‹è¯•å¼€å§‹ã€‚æ–°å»º <em>domain/fetch_pokemon.rs</em> å¹¶æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-rs">use crate::domain::entities::PokemonNumber;
use std::sync::Arc;

#[cfg(test)]
mod tests {
    use super::*;
    use crate::repositories::pokemon::InMemoryRepository;

    #[test]
    fn it_should_return_an_unknown_error_when_an_unexpected_error_happens() {
        let repo = Arc::new(InMemoryRepository::new().with_error());
        let req = Request::new(PokemonNumber::pikachu());

        let res = execute(repo, req);

        match res {
            Err(Error::Unknown) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }
}
</code></pre>
<p>æ¥ç€ï¼Œä¸ºæµ‹è¯•å®ç°å¿…è¦çš„ç±»å‹å’Œå‡½æ•°ï¼š</p>
<pre><code class="language-rs">pub struct Request {
    pub number: u16,
}

pub enum Error {
    Unknown
}
</code></pre>
<p>ä¸ºäº†è®©æµ‹è¯•æ›´æ¸…æ™°ï¼Œæˆ‘ä»¬è¿˜ä¸º <code>Request</code> å®ç°äº†ä¸€ä¸ª <code>new</code> æ–¹æ³•ï¼Œå½“ç„¶åªåœ¨æµ‹è¯•æ—¶ä½¿ç”¨ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
mod tests {
    ...

    impl Request {
        fn new(number: PokemonNumber) -&gt; Self {
            Self {
                number: u16::from(number),
            }
        }
    }
}
</code></pre>
<p>æœ€åï¼Œå†å®ç°ä¸€ä¸ªåªç”¨æ»¡è¶³è¿™é¡¹æµ‹è¯•çš„ <code>execute</code> å‡½æ•°å³å¯ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;(), Error&gt; {
    Err(Error::Unknown)
}
</code></pre>
<p>è®©æˆ‘ä»¬è¿è¡Œ <code>cargo test fetch_pokemon</code>:</p>
<pre><code>test it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
</code></pre>
<p>å¥½çš„ã€‚æˆ‘ä»¬å¯ä»¥å¼€å§‹ä¸‹ä¸€ä¸ªæµ‹è¯•äº†ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¯·æ±‚æ ¼å¼é”™è¯¯çš„æƒ…å†µï¼š</p>
<pre><code class="language-rs">#[test]
fn it_should_return_a_bad_request_error_when_request_is_invalid() {
    let repo = Arc::new(InMemoryRepository::new());
    let req = Request::new(PokemonNumber::bad());

    let res = execute(repo, req);

    match res {
        Err(Error::BadRequest) =&gt; {}
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨ <code>PokemonNumber</code> ä¸­åˆ›å»º <code>bad</code> å‡½æ•°ã€‚åœ¨ <em>domain/entities.rs</em> ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
impl PokemonNumber {
    ...
    pub fn bad() -&gt; Self {
        Self(0)
    }
}
</code></pre>
<p>æ¥ç€ï¼Œåœ¨ <code>Error</code> ä¸­æ·»åŠ  <code>Badrequest</code> ç±»å‹ä¸ä¹‹å¯¹åº”ï¼š</p>
<pre><code class="language-rs">pub enum Error {
    BadRequest,
    ...
}
</code></pre>
<p>ç°åœ¨å·²ç»èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯æµ‹è¯•å°šä¸”ä¸èƒ½é€šè¿‡ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬çš„ <code>execute</code> å‡½æ•°æš‚æ—¶åªèƒ½è¿”å› <code>Unknown</code> ç±»å‹ï¼š</p>
<pre><code class="language-rs">use std::convert::TryFrom;

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;(), Error&gt; {
    match PokemonNumber::try_from(req.number) {
        Ok(number) =&gt; Err(Error::Unknown),
        _ =&gt; Err(Error::BadRequest),
    }
}
</code></pre>
<p>ç°åœ¨ä¸¤ä¸ªæµ‹è¯•éƒ½é€šè¿‡äº†ï¼æˆ‘ä»¬ç°åœ¨å¯ä»¥è¿›è¡Œç¬¬ä¸‰ä¸ªæµ‹è¯•ï¼šåœ¨å­˜å‚¨åº“ä¸­æ‰¾ä¸åˆ°å®å¯æ¢¦æ—¶ï¼Œåº”è¯¥è¿”å› <code>NotFound</code>:</p>
<pre><code class="language-rs">#[test]
fn it_should_return_a_not_found_error_when_the_repo_does_not_contain_the_pokemon() {
    let repo = Arc::new(InMemoryRepository::new());
    let req = Request::new(PokemonNumber::pikachu());

    let res = execute(repo, req);

    match res {
        Err(Error::NotFound) =&gt; {}
        _ =&gt; unreachable!(),
    };
}
</code></pre>
<p>åŒæ ·ï¼Œåœ¨ <code>Error</code> ä¸­è¡¥å…… <code>NotFound</code> é”™è¯¯ç±»å‹ï¼š</p>
<pre><code class="language-rs">pub enum Error {
    ...
    NotFound,
    ...
}
</code></pre>
<p>åƒä¹‹å‰ä¸€æ ·ï¼Œæµ‹è¯•æ²¡æœ‰é€šè¿‡ã€‚æˆ‘ä»¬éœ€è¦åœ¨ <code>execute</code> å‡½æ•°ä¸­å¤„ç†å¯¹åº”çš„é”™è¯¯ç±»å‹ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::{FetchOneError, ...};

Ok(number) =&gt; match repo.fetch_one(number) {
    Ok(_) =&gt; Ok(()),
    Err(FetchOneError::NotFound) =&gt; Err(Error::NotFound),
    Err(FetchOneError::Unknown) =&gt; Err(Error::Unknown),
}
</code></pre>
<p>æ¥ç€åœ¨ <em>repositories/pokemon.rs</em> ä¸­è¡¥å……å¯¹åº”çš„æ–¹æ³•å’Œé”™è¯¯ç±»å‹ï¼š</p>
<pre><code class="language-rs">pub enum FetchOneError {
    NotFound,
    Unknown,
}

pub trait Repository: Send + Sync {
    ...
    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), FetchOneError&gt;;
}

impl Repository for InMemoryRepository {
    ...
    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), FetchOneError&gt; {
        if self.error {
            return Err(FetchOneError::Unknown);
        }

        Err(FetchOneError::NotFound)
    }
}
</code></pre>
<p>Et voilÃ ï¼Œæµ‹è¯•é€šè¿‡äº†ï¼æœ€åå»å¤„ç†è·å–æˆåŠŸçš„æµ‹è¯•å§ï¼š</p>
<pre><code class="language-rs">#[cfg(test)]
mod tests {
    use crate::domain::entities::{PokemonName, PokemonTypes};

    #[test]
    fn it_should_return_the_pokemon_otherwise() {
        let repo = Arc::new(InMemoryRepository::new());
        repo.insert(
            PokemonNumber::pikachu(),
            PokemonName::pikachu(),
            PokemonTypes::pikachu(),
        )
        .ok();
        let req = Request::new(PokemonNumber::pikachu());

        let res = execute(repo, req);

        match res {
            Ok(res) =&gt; {
                assert_eq!(res.number, u16::from(PokemonNumber::pikachu()));
                assert_eq!(res.name, String::from(PokemonName::pikachu()));
                assert_eq!(res.types, Vec::&lt;String&gt;::from(PokemonTypes::pikachu()));
            }
            _ =&gt; unreachable!(),
        };
    }
}
</code></pre>
<p>é¦–å…ˆåˆ›å»º <code>Response</code> ç±»å‹ï¼Œå¹¶æ”¹å˜ <code>execute</code> çš„è¿”å›å€¼ç±»å‹ï¼š</p>
<pre><code class="language-rs">pub struct Response {
    pub number: u16,
    pub name: String,
    pub types: Vec&lt;String&gt;,
}

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;Response, Error&gt; {
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å»å¤„ç† <code>Ok(_)</code> çš„éƒ¨åˆ†ï¼š</p>
<pre><code class="language-rs">use crate::domain::entities::{Pokemon, ...};

Ok(Pokemon {
    number,
    name,
    types,
}) =&gt; Ok(Response {
    number: u16::from(number),
    name: String::from(name),
    types: Vec::&lt;String&gt;::from(types),
})
</code></pre>
<p>æœ€åä¿®æ”¹å­˜å‚¨åº“çš„ <code>fetch_one</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">pub trait Repository: Send + Sync {
    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt;;
}

impl Repository for InMemoryRepository {
    fn fetch_one(&amp;self, number: PokemonNumber) -&gt; Result&lt;Pokemon, FetchOneError&gt; {
        if self.error {
            return Err(FetchOneError::Unknown);
        }

        let lock = match self.pokemons.lock() {
            Ok(lock) =&gt; lock,
            _ =&gt; return Err(FetchOneError::Unknown),
        };

        match lock.iter().find(|p| p.number == number) {
            Some(pokemon) =&gt; Ok(pokemon.clone()),
            None =&gt; Err(FetchOneError::NotFound),
        }
    }
}
</code></pre>
<p>æ‰€æœ‰çš„æµ‹è¯•éƒ½é€šè¿‡äº†ç°åœ¨ï¼š</p>
<pre><code>test it_should_return_a_not_found_error_when_the_repo_does_not_contain_the_pokemon ... ok
test it_should_return_the_pokemon_otherwise ... ok
test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
</code></pre>
<p>è®©æˆ‘ä»¬ç°åœ¨å‘ API ä¸­å‰åŠ ä¸€ä¸ªæ–°è·¯ç”±ï¼š</p>
<pre><code class="language-rs">mod fetch_pokemon;

// in the router macro
(GET) (/{number: u16}) =&gt; {
    fetch_pokemon::serve(repo.clone(), number)
}
</code></pre>
<p>æ¥ç€å† <em>api/fetch_pokemon.rs</em> åˆ›å»ºå¯¹åº”çš„ <code>serve</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">use crate::api::Status;
use crate::domain::fetch_pokemon;
use crate::repositories::pokemon::Repository;
use rouille;
use serde::Serialize;
use std::sync::Arc;

#[derive(Serialize)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn serve(repo: Arc&lt;dyn Repository&gt;, number: u16) -&gt; rouille::Response {
    let req = fetch_pokemon::Request { number };
    match fetch_pokemon::execute(repo, req) {
        Ok(fetch_pokemon::Response {
            number,
            name,
            types,
        }) =&gt; rouille::Response::json(&amp;Response {
            number,
            name,
            types,
        }),
        Err(fetch_pokemon::Error::BadRequest) =&gt; rouille::Response::from(Status::BadRequest),
        Err(fetch_pokemon::Error::NotFound) =&gt; rouille::Response::from(Status::NotFound),
        Err(fetch_pokemon::Error::Unknown) =&gt; rouille::Response::from(Status::InternalServerError),
    }
}
</code></pre>
<p>ç°åœ¨æ‚¨å¯ä»¥è¿è¡Œåº”ç”¨ç¨‹åºï¼Œæ‰“å¼€æ‚¨çš„ HTTP å®¢æˆ·ç«¯å¹¶å°†ä¸€äº›å®å¯æ¢¦æ·»åŠ åˆ°å­˜å‚¨åº“ä¸­ã€‚ç„¶åï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿé€šè¿‡åœ¨ç½‘å€æœ«å°¾æ·»åŠ å®å¯æ¢¦çš„æ•°é‡æ¥ä¸€ä¸€è·å–å®ƒä»¬ã€‚
ä¾‹å¦‚ï¼Œåœ¨æˆ‘çš„è®¡ç®—æœºä¸Šï¼Œhttp://localhost:8000/25 ä¸Šçš„ GET è¯·æ±‚è¿”å›äº†ï¼š</p>
<pre><code class="language-json">{
  &quot;number&quot;: 25,
  &quot;name&quot;: &quot;Pikachu&quot;,
  &quot;types&quot;: [
    &quot;Electric&quot;
  ]
}
</code></pre>
<h2 id="åˆ é™¤ä¸€åªå®å¯æ¢¦-2"><a class="header" href="#åˆ é™¤ä¸€åªå®å¯æ¢¦-2">åˆ é™¤ä¸€åªå®å¯æ¢¦</a></h2>
<p>æˆ‘ä¿è¯ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šå®Œæˆã€‚åˆ é™¤å®å¯æ¢¦æ˜¯æˆ‘ä»¬çš„æœ€åä¸€ä¸ªç”¨ä¾‹ã€‚è¿™ä¸ªç”¨ä¾‹çš„ç»“æœæœ‰å››ç§å¯èƒ½ï¼š</p>
<ul>
<li>æˆåŠŸ</li>
<li>è¯·æ±‚æ ¼å¼é”™è¯¯</li>
<li>æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„å®å¯æ¢¦</li>
<li>æœªçŸ¥é”™è¯¯</li>
</ul>
<p>æ‚¨åº”è¯¥å·²ç»æ³¨æ„åˆ°ï¼Œå®ƒä»¬ä¸è·å– Pokemon ç”¨ä¾‹ä¸­çš„å®Œå…¨ç›¸åŒã€‚æˆ‘ä¼šè§£é‡Šæ›´å¿«ä¸€äº›ã€‚ç°åœ¨å°±å¼€å§‹äº†ã€‚è®©æˆ‘ä»¬ç›´æ¥ç¼–å†™æ‰€æœ‰æµ‹è¯•ï¼š</p>
<pre><code class="language-rs">// domain/mod.rs
pub mod delete_pokemon;

// domain/delete_pokemon.rs
#[cfg(test)]
mod tests {
    use super::*;
    use crate::domain::entities::{PokemonName, PokemonTypes};
    use crate::repositories::pokemon::InMemoryRepository;

    #[test]
    fn it_should_return_an_unknown_error_when_an_unexpected_error_happens() {
        let repo = Arc::new(InMemoryRepository::new().with_error());
        let req = Request::new(PokemonNumber::pikachu());

        let res = execute(repo, req);

        match res {
            Err(Error::Unknown) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }

    #[test]
    fn it_should_return_a_bad_request_error_when_request_is_invalid() {
        let repo = Arc::new(InMemoryRepository::new());
        let req = Request::new(PokemonNumber::bad());

        let res = execute(repo, req);

        match res {
            Err(Error::BadRequest) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }

    #[test]
    fn it_should_return_a_not_found_error_when_the_repo_does_not_contain_the_pokemon() {
        let repo = Arc::new(InMemoryRepository::new());
        let req = Request::new(PokemonNumber::pikachu());

        let res = execute(repo, req);

        match res {
            Err(Error::NotFound) =&gt; {}
            _ =&gt; unreachable!(),
        };
    }

    #[test]
    fn it_should_return_ok_otherwise() {
        let repo = Arc::new(InMemoryRepository::new());
        repo.insert(
            PokemonNumber::pikachu(),
            PokemonName::pikachu(),
            PokemonTypes::pikachu(),
        )
        .ok();
        let req = Request::new(PokemonNumber::pikachu());

        let res = execute(repo, req);

        match res {
            Ok(()) =&gt; {},
            _ =&gt; unreachable!(),
        };
    }

    impl Request {
        fn new(number: PokemonNumber) -&gt; Self {
            Self {
                number: u16::from(number),
            }
        }
    }
}
</code></pre>
<p>é™¤äº†æˆåŠŸæƒ…å†µä¸‹çš„æµ‹è¯•ï¼Œå…¶ä»–çš„æµ‹è¯•åŸºæœ¬ä¸Šæ˜¯å¯¹ <em>domain/fetch_pokemon.rs</em> çš„å¤åˆ¶ç²˜è´´ã€‚æ¥ä¸‹æ¥æ˜¯ç±»å‹ï¼š</p>
<pre><code class="language-rs">pub struct Request {
    pub number: u16,
}

pub enum Error {
    BadRequest,
    NotFound,
    Unknown,
}
</code></pre>
<p>æˆ‘ä»¬ä¸éœ€è¦å®šä¹‰ <code>Response</code> ç±»å‹ï¼Œå› ä¸ºåœ¨ <code>Ok</code> æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè¿”å›ä»»ä½•å†…å®¹ã€‚è®©æˆ‘ä»¬å®šä¹‰ <code>execute</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">use crate::domain::entities::PokemonNumber;
use crate::repositories::pokemon::{DeleteError, Repository};
use std::convert::TryFrom;
use std::sync::Arc;

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Result&lt;(), Error&gt; {
    match PokemonNumber::try_from(req.number) {
        Ok(number) =&gt; match repo.delete(number) {
            Ok(()) =&gt; Ok(()),
            Err(DeleteError::NotFound) =&gt; Err(Error::NotFound),
            Err(DeleteError::Unknown) =&gt; Err(Error::Unknown),
        },
        _ =&gt; Err(Error::BadRequest),
    }
}
</code></pre>
<p>å¤ªå¥½äº†ï¼ç°åœ¨æˆ‘ä»¬åªå‰©ä¸‹å®ç°å­˜å‚¨åº“äº†ï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šå®Œæˆï¼š</p>
<pre><code class="language-rs">pub enum DeleteError {
    NotFound,
    Unknown,
}

pub trait Repository: Send + Sync {
    fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt;;
}

impl Repository for InMemoryRepository {
    fn delete(&amp;self, number: PokemonNumber) -&gt; Result&lt;(), DeleteError&gt; {
        if self.error {
            return Err(DeleteError::Unknown);
        }

        let mut lock = match self.pokemons.lock() {
            Ok(lock) =&gt; lock,
            _ =&gt; return Err(DeleteError::Unknown),
        };

        let index = match lock.iter().position(|p| p.number == number) {
            Some(index) =&gt; index,
            None =&gt; return Err(DeleteError::NotFound),
        };

        lock.remove(index);
        Ok(())
    }
}
</code></pre>
<p>è¿è¡Œæµ‹è¯•ï¼š</p>
<pre><code>test it_should_return_a_bad_request_error_when_request_is_invalid ... ok
test it_should_return_a_not_found_error_when_the_repo_does_not_contain_the_pokemon ... ok
test it_should_return_an_unknown_error_when_an_unexpected_error_happens ... ok
test it_should_return_ok_otherwise ... ok
We can now add the new route in our API. Let's add the following to api/mod.rs:
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ API ä¸­æ·»åŠ æ–°è·¯ç”±ï¼š</p>
<pre><code class="language-rs">mod delete_pokemon;

// in the router macro
(DELETE) (/{number: u16}) =&gt; {
    delete_pokemon::serve(repo.clone(), number)
}

enum Status {
    Ok,
    ...
}
impl From&lt;Status&gt; for rouille::Response {
    fn from(status: Status) -&gt; Self {
        let status_code = match status {
            Status::Ok =&gt; 200,
            ...
</code></pre>
<p>æˆ‘åœ¨ <code>Status</code> ä¸­è¡¥å……ä¸€ä¸ª OK ç±»å‹ç”¨æ¥è¡¨ç¤ºæ²¡æœ‰ç›¸åº”ä½“çš„ 200 çŠ¶æ€ç ï¼Œç°åœ¨æ·»åŠ å¯¹åº”çš„ <code>serve</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">use crate::api::Status;
use crate::domain::delete_pokemon;
use crate::repositories::pokemon::Repository;
use rouille;
use std::sync::Arc;

pub fn serve(repo: Arc&lt;dyn Repository&gt;, number: u16) -&gt; rouille::Response {
    let req = delete_pokemon::Request { number };
    match delete_pokemon::execute(repo, req) {
        Ok(()) =&gt; rouille::Response::from(Status::Ok),
        Err(delete_pokemon::Error::BadRequest) =&gt; rouille::Response::from(Status::BadRequest),
        Err(delete_pokemon::Error::NotFound) =&gt; rouille::Response::from(Status::NotFound),
        Err(delete_pokemon::Error::Unknown) =&gt; rouille::Response::from(Status::InternalServerError),
    }
}
</code></pre>
<p>é€šè¿‡ä½¿ç”¨ HTTP å®¢æˆ·ç«¯ï¼Œç°åœ¨ä½ åº”è¯¥èƒ½å¤Ÿåˆ é™¤å®å¯æ¢¦äº† :)</p>
<h2 id="æ€»ç»“-2"><a class="header" href="#æ€»ç»“-2">æ€»ç»“</a></h2>
<p>æˆ‘å¸Œæœ›å®ƒä¸ä¼šå¤ªé•¿......ä½†ç°åœ¨æˆ‘ä»¬çš„å®¢æˆ·å¾ˆé«˜å…´ï¼è€¶ï¼ä¸‹ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„ç”¨ä¾‹å®ç°å¦ä¸€ä¸ªå‰ç«¯ã€‚ç°åœ¨æˆ‘ä»¬åªæœ‰ä¸€ä¸ª HTTP APIï¼Œå¦‚æœè¿˜èƒ½æœ‰ä¸€ä¸ª CLI
æ¥ç®¡ç†æˆ‘ä»¬çš„å®å¯æ¢¦å°±å¥½äº† :)</p>
<p>ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-5">Github</a> ä¸ŠæŸ¥çœ‹</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-6/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-10-09---rust-å…­è¾¹å½¢æ¶æ„-6---cli"><a class="header" href="#2021-10-09---rust-å…­è¾¹å½¢æ¶æ„-6---cli">2021-10-09 - Rust å…­è¾¹å½¢æ¶æ„ #6 - CLI</a></h1>
<p>å˜¿ï¼Œå¥½ä¹…ä¸è§ï¼ä¸Šæ¬¡ï¼Œæˆ‘ä»¬å®ç°äº†å‰©ä½™çš„ç”¨ä¾‹ï¼Œå¹¶å°†å®ƒä»¬è¿æ¥åˆ°æˆ‘ä»¬çš„ APIã€‚ç°åœ¨ï¼Œæˆ‘æƒ³æ·»åŠ å¦ä¸€ç§æ–¹å¼æ¥ä½¿ç”¨æˆ‘ä»¬çš„ç¨‹åºã€‚æˆ‘ä»¬å°†ä½¿ç”¨ CLIã€‚CLI æ˜¯
Command Line Interface (å‘½ä»¤è¡Œæ¥å£) çš„æ„æ€ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç¼©å†™è¯ï¼Œæ„æ€æ˜¯ï¼šâ€œè®©æˆ‘ä»¬é€šè¿‡ç»ˆç«¯ä½¿ç”¨è¿™ä¸ªç¨‹åºâ€ã€‚</p>
<h2 id="æ­å»ºè„šæ‰‹æ¶"><a class="header" href="#æ­å»ºè„šæ‰‹æ¶">æ­å»ºè„šæ‰‹æ¶</a></h2>
<p>æ„å»º CLI æ„å‘³ç€æˆ‘ä»¬éœ€è¦åœ¨é¡¹ç›®ä¸­æ·»åŠ æ–°çš„ä¾èµ–å’Œä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ã€‚è®©æˆ‘ä»¬ä»æ·»åŠ ä¾èµ–å¼€å§‹ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•ï¼Œå†è¿è¡Œä¹‹å‰éœ€è¦æç¤ºç”¨æˆ·æ˜¯è¿è¡Œ CLI è¿˜æ˜¯ HTTP
APIã€‚æˆ‘ä»¬å°†ä½¿ç”¨ <code>clap</code> æ·»åŠ å‘½ä»¤è¡Œå¼€å…³è®©ç”¨æˆ·é€‰æ‹©å¯åŠ¨æ–¹å¼ï¼ŒåŒæ—¶è¿˜ä¼šä½¿ç”¨ <code>dialoguer</code> å»åˆ›å»ºæç¤ºä¿¡æ¯ã€‚</p>
<p>æ‰“å¼€ Cargo.tomlï¼Œå¹¶æ·»åŠ ï¼š</p>
<pre><code class="language-toml">[dependencies]
...
clap = &quot;2.33.3&quot;
dialoguer = &quot;0.8.0&quot;
</code></pre>
<p>å½“ä½ å†è¯»è¿™ç¯‡æ–‡ç« æ—¶å¯ä»¥å°†ä¾èµ–æ¢ä¸ºæœ€æ–°çš„ã€‚ç°åœ¨è®©æˆ‘ä»¬æ·»åŠ ä¸€äº›å‘½ä»¤è¡Œå¼€å…³ï¼Œæ‰“å¼€ <em>main.rs</em>:</p>
<pre><code class="language-rs">#[macro_use]
extern crate clap;

use clap::{App, Arg};
And then we can use it:

fn main() {
    let repo = Arc::new(InMemoryRepository::new());

    let matches = App::new(crate_name!())
        .version(crate_version!())
        .author(crate_authors!())
        .arg(Arg::with_name(&quot;cli&quot;).long(&quot;cli&quot;).help(&quot;Runs in CLI mode&quot;))
        .get_matches();

    match matches.occurrences_of(&quot;cli&quot;) {
        0 =&gt; api::serve(&quot;localhost:8000&quot;, repo),
        _ =&gt; unreachable!(),
    }
}
</code></pre>
<p>æ‰€ä»¥ï¼Œé¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†å­˜å‚¨åº“ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¤„ç† CLI çš„ clap åº”ç”¨ç¨‹åºã€‚å¦‚æœåœ¨è¿è¡Œç¨‹åºæ—¶æ·»åŠ  <code>--cli</code> æ ‡å¿—ï¼Œç¨‹åºç°åœ¨å°†
panicã€‚å¦‚æœæ²¡æœ‰æ·»åŠ ï¼Œå°±ä¼šè¿è¡Œ APIã€‚æ­£å¦‚æˆ‘ä¹‹å‰æ‰€è¯´ï¼Œ<code>clap</code> èƒ½è®©æˆ‘ä»¬å¿«é€Ÿåˆ›å»ºä¸€ä¸ª CLIã€‚æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œæ¥å°è¯•ï¼š</p>
<pre><code class="language-rs">cargo run -- --help

pokedex 0.1.0
Alexis Lozano &lt;alexis.pascal.lozano@gmail.com&gt;

USAGE:
    pokedex [FLAGS]

FLAGS:
        --cli        Runs in CLI mode
    -h, --help       Prints help information
    -V, --version    Prints version information
</code></pre>
<p>éå¸¸ä¸é”™æ˜¯å§ :)</p>
<p>ç°åœ¨æˆ‘ä»¬è¦æŠŠ <code>unreachable!()</code> æ›¿æ¢ä¸º <code>cli::run(repo)</code>ã€‚æˆ‘ä»¬ç°åœ¨è¦åˆ›å»ºä¸€ä¸ª <code>cli</code> æ¨¡å—ï¼Œæ‰€æœ‰å’Œ cli
ç›¸å…³çš„ä»£ç éƒ½ä¼šåœ¨è¯¥æ¨¡å—é‡Œã€‚åœ¨ <em>main.rs</em> é‡Œå¼•å…¥æ¨¡å—ï¼š</p>
<pre><code class="language-rs">mod cli;
</code></pre>
<p>æ¥ç€è®©æˆ‘ä»¬åˆ›å»º <em>src/cli</em> æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ª <em>mod.rs</em> æ–‡ä»¶ã€‚åœ¨ <em>cli/mod.rs</em> ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;
use std::sync::Arc;

pub fn run(repo: Arc&lt;dyn Repository&gt;) {}
</code></pre>
<p>ç°åœ¨è¿è¡Œ <code>cargo run -- --cli</code> åº”è¯¥ä¸ä¼š panic äº†ã€‚</p>
<p>æ¥ç€è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¾ªç¯ï¼š</p>
<pre><code class="language-rs">use dialoguer::{theme::ColorfulTheme, Select};

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    loop {
        let choices = [
            &quot;Fetch all Pokemons&quot;,
            &quot;Fetch a Pokemon&quot;,
            &quot;Create a Pokemon&quot;,
            &quot;Delete a Pokemon&quot;,
            &quot;Exit&quot;,
        ];
        let index = match Select::with_theme(&amp;ColorfulTheme::default())
            .with_prompt(&quot;Make your choice&quot;)
            .items(&amp;choices)
            .default(0)
            .interact()
        {
            Ok(index) =&gt; index,
            _ =&gt; continue,
        };

        match index {
            4 =&gt; break,
            _ =&gt; continue,
        };
    }
}
</code></pre>
<p>æˆ‘ä»¬åˆ—å‡ºäº†æ‰€æœ‰ç”¨æˆ·èƒ½å¤Ÿè¿è¡Œçš„å‘½ä»¤ã€‚å¦‚æœç”¨æˆ·é€‰æ‹© <code>Exit</code>ï¼Œç¨‹åºå°±ä¼šé€€å‡ºã€‚å¦åˆ™ï¼Œç¨‹åºæš‚æ—¶ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬é©¬ä¸Šå°±ä¼šå®ç°å…¶ä»–çš„å‘½ä»¤ã€‚</p>
<h2 id="åˆ›å»ºä¸€ä¸ªå®å¯æ¢¦"><a class="header" href="#åˆ›å»ºä¸€ä¸ªå®å¯æ¢¦">åˆ›å»ºä¸€ä¸ªå®å¯æ¢¦</a></h2>
<p>è®©æˆ‘ä»¬ä»åˆ›å»ºå¼€å§‹ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæœ‰æ–¹æ³•å‘å­˜å‚¨åº“ä¸­æ·»åŠ å®å¯æ¢¦ï¼Œåé¢çš„æµ‹è¯•å°±æ›´å®¹æ˜“åšäº†ï¼š</p>
<pre><code class="language-rs">match index {
    2 =&gt; create_pokemon::run(repo.clone()),
    ...
};
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å—ï¼š</p>
<pre><code class="language-rs">mod create_pokemon;
</code></pre>
<p>å¥½äº†ï¼Œåœ¨ <em>cli/create_pokemon.rs</em> ä¸­å¡«åŠ ä¸Šå¯¹åº”çš„å‡½æ•°ç­¾åï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;
use std::sync::Arc;

pub fn run(repo: Arc&lt;dyn Repository&gt;) {}
</code></pre>
<p>ä¸ºäº†åˆ›å»ºä¸€ä¸ªå®å¯æ¢¦ï¼ŒCLI éœ€è¦å‘ç”¨æˆ·è¯¢é—®å®å¯æ¢¦çš„ ç¼–å·ã€åç§°å’Œç±»å‹ã€‚ä¸ºäº†æ–¹ä¾¿è¿™ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”æé«˜æç¤ºä¿¡æ¯çš„å¤ç”¨æ€§ï¼Œæˆ‘ä»¬ä¼šä¸ºè¿™äº›ä¿¡æ¯åˆ†åˆ«å®ç°å„è‡ªçš„æç¤ºå‡½æ•°ï¼š</p>
<pre><code class="language-rs">use crate::cli::{prompt_name, prompt_number, prompt_types};

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    let number = prompt_number();
    let name = prompt_name();
    let types = prompt_types();
}
</code></pre>
<p>æ¥ç€åœ¨ <em>cli/mod.rs</em> ä¸­å®ç°ï¼š</p>
<pre><code class="language-rs">use dialoguer::{..., Input, MultiSelect};

pub fn prompt_number() -&gt; Result&lt;u16, ()&gt; {
    match Input::new().with_prompt(&quot;Pokemon number&quot;).interact_text() {
        Ok(number) =&gt; Ok(number),
        _ =&gt; Err(()),
    }
}

pub fn prompt_name() -&gt; Result&lt;String, ()&gt; {
    match Input::new().with_prompt(&quot;Pokemon name&quot;).interact_text() {
        Ok(name) =&gt; Ok(name),
        _ =&gt; Err(()),
    }
}

pub fn prompt_types() -&gt; Result&lt;Vec&lt;String&gt;, ()&gt; {
    let types = [&quot;Electric&quot;, &quot;Fire&quot;];
    match MultiSelect::new()
        .with_prompt(&quot;Pokemon types&quot;)
        .items(&amp;types)
        .interact()
    {
        Ok(indexes) =&gt; Ok(indexes
            .into_iter()
            .map(|index| String::from(types[index]))
            .collect::&lt;Vec&lt;String&gt;&gt;()),
        _ =&gt; Err(()),
    }
}
</code></pre>
<blockquote>
<p>æç¤ºï¼šå¤šé€‰æ¡†æŒ‰ç©ºæ ¼é€‰ä¸­</p>
</blockquote>
<p>å¦‚ä½ æ‰€è§ï¼Œæ‰€æœ‰çš„æç¤ºéƒ½å¯èƒ½å¤±è´¥ï¼Œè®©æˆ‘ä»¬å›åˆ° <em>cli/create_pokemon.rs</em>ï¼Œæœ‰äº†ç”¨æˆ·çš„è¾“å…¥ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒå°è£…ä¸ºç”¨ä¾‹ä¸­éœ€è¦çš„
<code>Request</code> ç»“æ„ä½“ï¼š</p>
<pre><code class="language-rs">use crate::domain::create_pokemon;

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    ...
    let req = match (number, name, types) {
        (Ok(number), Ok(name), Ok(types)) =&gt; create_pokemon::Request {
            number,
            name,
            types,
        },
        _ =&gt; {
            println!(&quot;An error occurred during the prompt&quot;);
            return;
        }
    };
</code></pre>
<p>å½“å‘ç”Ÿè¾“å…¥é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬ä¼šé€€å›åˆ°ä¸»èœå•ã€‚ç°åœ¨æœ‰äº† <code>Request</code> ç»“æ„ä½“ï¼Œæˆ‘ä»¬å°±èƒ½è°ƒç”¨åˆ›å»ºå®å¯æ¢¦çš„ç”¨ä¾‹äº†ï¼š</p>
<pre><code class="language-rs">pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    ...
    match create_pokemon::execute(repo, req) {
        Ok(res) =&gt; {},
        Err(create_pokemon::Error::BadRequest) =&gt; println!(&quot;The request is invalid&quot;),
        Err(create_pokemon::Error::Conflict) =&gt; println!(&quot;The Pokemon already exists&quot;),
        Err(create_pokemon::Error::Unknown) =&gt; println!(&quot;An unknown error occurred&quot;),
    };
}
</code></pre>
<p>æˆ‘ä»¬å¤„ç†äº†æ‰€æœ‰çš„é”™è¯¯ç±»å‹ï¼Œæ¯ç§é”™è¯¯éƒ½ä¼šåé¦ˆåˆ°ç”¨æˆ·çš„ç»ˆç«¯ä¸Šã€‚å½“ç”¨ä¾‹æ‰§è¡ŒæˆåŠŸæ—¶ï¼Œæˆ‘ä»¬ä¼šè¿”å›ä¸€ä¸ª <code>Response</code>ï¼š</p>
<pre><code class="language-rs">#[derive(Debug)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    ...
    match create_pokemon::execute(repo, req) {
        Ok(res) =&gt; println!(
            &quot;{:?}&quot;,
            Response {
                number: res.number,
                name: res.name,
                types: res.types,
            }
        ),
        ...
    };
}
</code></pre>
<p>å¥½äº†ï¼Œè®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼æ‰“å¼€ç»ˆç«¯ï¼Œä»¥å‘½ä»¤è¡Œæ¨¡å¼è¿è¡Œï¼š</p>
<pre><code class="language-rs">âœ” Make your choice Â· Create a Pokemon
Pokemon number: 25
Pokemon name: Pikachu
Pokemon types: Electric
Response { number: 25, name: &quot;Pikachu&quot;, types: [&quot;Electric&quot;] }
Great! First command implemented, let's do the next one!
</code></pre>
<h2 id="è·å–æ‰€æœ‰å®å¯æ¢¦-2"><a class="header" href="#è·å–æ‰€æœ‰å®å¯æ¢¦-2">è·å–æ‰€æœ‰å®å¯æ¢¦</a></h2>
<p>ç°åœ¨æˆ‘ä»¬å»å®ç°è·å–æ‰€æœ‰å®å¯æ¢¦ï¼é¦–å…ˆæˆ‘ä»¬åœ¨å¯¹åº”çš„ <code>index</code> æ·»åŠ ç›¸åº”çš„å¤„ç†å‡½æ•°ï¼š</p>
<pre><code class="language-rs">match index {
    0 =&gt; fetch_all_pokemons::run(repo.clone()),
    ...
};
</code></pre>
<p>åˆ›å»ºæ¨¡å—</p>
<pre><code class="language-rs">mod fetch_all_pokemons;
</code></pre>
<p>ç°åœ¨å®ç°å…·ä½“çš„åŠŸèƒ½ï¼š</p>
<pre><code class="language-rs">use crate::domain::fetch_all_pokemons;
use crate::repositories::pokemon::Repository;
use std::sync::Arc;

#[derive(Debug)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    match fetch_all_pokemons::execute(repo) {
        Ok(res) =&gt; res.into_iter().for_each(|p| {
            println!(
                &quot;{:?}&quot;,
                Response {
                    number: p.number,
                    name: p.name,
                    types: p.types,
                }
            );
        }),
        Err(fetch_all_pokemons::Error::Unknown) =&gt; println!(&quot;An unknown error occurred&quot;),
    };
}
</code></pre>
<p>æˆ‘å·²ç»è¯¦ç»†çš„è§£é‡Šè¿‡ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œè¿™é‡Œå°±æ²¡å¿…è¦ä¸€æ­¥ä¸€æ­¥è¯´æ˜äº†ã€‚è¿™ä¸ªå‘½ä»¤ä¸éœ€è¦ä»»ä½•å‚èµ›ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ä»»ä½•æç¤ºä¿¡æ¯ï¼Œæˆ‘ä»¬åªéœ€è¦ä»å­˜å‚¨åº“æ‹¿åˆ°ç»“æœï¼Œä¾æ¬¡æ‰“å°å³å¯ã€‚</p>
<h2 id="æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦-1"><a class="header" href="#æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦-1">æŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦</a></h2>
<p>å’Œä¹‹å‰ä¸€æ ·ï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡å—ï¼š</p>
<pre><code class="language-rs">mod fetch_pokemon;

...

match index {
    ...
    1 =&gt; fetch_pokemon::run(repo.clone()),
    ...
};
</code></pre>
<p>åˆ›å»ºå¯¹åº”çš„å¤„ç†å‡½æ•°</p>
<pre><code class="language-rs">use crate::cli::prompt_number;
use crate::domain::fetch_pokemon;
use crate::repositories::pokemon::Repository;
use std::sync::Arc;

#[derive(Debug)]
struct Response {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    let number = prompt_number();

    let req = match number {
        Ok(number) =&gt; fetch_pokemon::Request { number },
        _ =&gt; {
            println!(&quot;An error occurred during the prompt&quot;);
            return;
        }
    };
    match fetch_pokemon::execute(repo, req) {
        Ok(res) =&gt; println!(
            &quot;{:?}&quot;,
            Response {
                number: res.number,
                name: res.name,
                types: res.types,
            }
        ),
        Err(fetch_pokemon::Error::BadRequest) =&gt; println!(&quot;The request is invalid&quot;),
        Err(fetch_pokemon::Error::NotFound) =&gt; println!(&quot;The Pokemon does not exist&quot;),
        Err(fetch_pokemon::Error::Unknown) =&gt; println!(&quot;An unknown error occurred&quot;),
    }
}
</code></pre>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆå‘ç”¨æˆ·è¯¢é—®äº†ç¼–å·ï¼Œå¦‚æœè·å–å¤±è´¥äº†å°±è¾“å‡ºé”™è¯¯ä¿¡æ¯ã€‚æ¥ç€æ„å»º Request ç»“æ„ä½“ï¼Œè°ƒç”¨ç”¨ä¾‹ï¼ŒæˆåŠŸå°±æ‰“å°ç»“æœï¼Œå¦åˆ™æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚</p>
<h1 id="åˆ é™¤ä¸€ä¸ªå®å¯æ¢¦"><a class="header" href="#åˆ é™¤ä¸€ä¸ªå®å¯æ¢¦">åˆ é™¤ä¸€ä¸ªå®å¯æ¢¦</a></h1>
<p>æœ€åä¸€ä¸ªå‘½ä»¤ï¼</p>
<pre><code class="language-rs">mod delete_pokemon;

...

match index {
    ...
    3 =&gt; delete_pokemon::run(repo.clone()),
    ...
};
</code></pre>
<p>åˆ›å»ºæ–°æ¨¡å—ï¼š</p>
<pre><code class="language-rs">use crate::cli::prompt_number;
use crate::domain::delete_pokemon;
use crate::repositories::pokemon::Repository;
use std::sync::Arc;

pub fn run(repo: Arc&lt;dyn Repository&gt;) {
    let number = prompt_number();

    let req = match number {
        Ok(number) =&gt; delete_pokemon::Request { number },
        _ =&gt; {
            println!(&quot;An error occurred during the prompt&quot;);
            return;
        }
    };
    match delete_pokemon::execute(repo, req) {
        Ok(()) =&gt; println!(&quot;The Pokemon has been deleted&quot;),
        Err(delete_pokemon::Error::BadRequest) =&gt; println!(&quot;The request is invalid&quot;),
        Err(delete_pokemon::Error::NotFound) =&gt; println!(&quot;The Pokemon does not exist&quot;),
        Err(delete_pokemon::Error::Unknown) =&gt; println!(&quot;An unknown error occurred&quot;),
    }
}
</code></pre>
<p>å’ŒæŸ¥è¯¢ä¸€ä¸ªå®å¯æ¢¦åŸºæœ¬ä¸€æ ·ï¼Œåªä¸è¿‡ä¸éœ€è¦è¿”å›ä¿¡æ¯ã€‚</p>
<h2 id="æ€»ç»“-3"><a class="header" href="#æ€»ç»“-3">æ€»ç»“</a></h2>
<p>ç°åœ¨æ‚¨æ— éœ€ç›´æ¥å‘é€ HTTP è¯·æ±‚å³å¯åœ¨ç»ˆç«¯ä¸­äº«å—ä½¿ç”¨ç¨‹åº : D
ä½†æ˜¯ä½ çŸ¥é“æˆ‘ä»¬ç¼ºå°‘ä»€ä¹ˆå—ï¼Ÿä¸€ä¸ªçœŸæ­£å­˜å‚¨æˆ‘ä»¬çš„å®å¯æ¢¦çš„åœ°æ–¹ã€‚ç›®å‰ï¼Œå®ƒä»¬åªå­˜åœ¨äºå†…å­˜ä¸­ï¼Œå› æ­¤æ¯æ¬¡æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶å­˜å‚¨åº“éƒ½æ˜¯ç©ºçš„ã€‚ä» CLI åˆ›å»ºæˆ‘ä»¬çš„å®å¯æ¢¦ç„¶åä»
API è·å–å®ƒä»¬ä¼šå¾ˆé…· : ) ä¸‹ä¸€ç¯‡å°†æ˜¯æœ¬ç³»åˆ—çš„æœ€åä¸€ç¯‡æ–‡ç« ï¼šå®ç°ä¸€ä¸ªé•¿æœŸä¿å­˜çš„å­˜å‚¨åº“ã€‚</p>
<p>ä»£ç å¯ä»¥åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-6">Github</a> ä¸ŠæŸ¥çœ‹</p>
<div style="break-before: page; page-break-before: always;"></div><blockquote>
<p>åŸæ–‡é“¾æ¥ï¼šhttps://alexis-lozano.com/hexagonal-architecture-in-rust-3/</p>
<p>ç¿»è¯‘ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>é€‰é¢˜ï¼š<a href="https://github.com/trdthg">trdthg</a></p>
<p>æœ¬æ–‡ç”± <a href="https://Rustt.org">Rustt</a> ç¿»è¯‘ï¼Œ<a href="https://studyrust.org">StudyRust</a> è£èª‰æ¨å‡º</p>
</blockquote>
<h1 id="2021-08-26---rust-å…­è¾¹å½¢æ¶æ„-3---http-api"><a class="header" href="#2021-08-26---rust-å…­è¾¹å½¢æ¶æ„-3---http-api">2021-08-26 - Rust å…­è¾¹å½¢æ¶æ„ #3 - HTTP API</a></h1>
<p>è¿™ç¯‡æ–‡ç« æ˜¯ä¸‹é¢ç³»åˆ—çš„ä¸€éƒ¨åˆ†</p>
<ul>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-1/">Hexagonal architecture in Rust #1 - Domain</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-2/">Hexagonal architecture in Rust #2 - In-memory repository</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-3/">Hexagonal architecture in Rust #3 - HTTP API</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-4/">Hexagonal architecture in Rust #4 - Refactoring</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-5/">Hexagonal architecture in Rust #5 - Remaining use-cases</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-6/">Hexagonal architecture in Rust #6 - CLI</a></li>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-7/">Hexagonal architecture in Rust #7 - Long-lived repositories</a></li>
</ul>
<p>é›†ç»“å§ï¼Œæˆ‘çš„æˆ˜å‹ä»¬ã€‚ä»Šå¤©æˆ‘ä»¬å°†è¦æˆ˜æ–—ï¼è°ï¼Ÿä½ é—®æˆ‘ã€‚å®ƒæ˜¯è¿™ç‰‡åœŸåœ°ä¸Šä¸è¨€è€Œå–»çš„æ¶é­”ï¼šğŸ‘¿å€Ÿç”¨æ£€æŸ¥ï¼</p>
<p>å¥½äº†ï¼Œè®©æˆ‘ä»¬æš‚æ—¶åœæ­¢è¿™ä¸ªæŒ‡ç¯ç‹é£æ ¼çš„å°è±¡ï¼Œå·¥ä½œç­‰å¾…ç€æˆ‘ä»¬ : )</p>
<p>åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬çš„åŸŸå®ä½“ï¼Œå¹¶ä¸”å®ç°äº†ä¸€ä¸ªç”¨ä¾‹å’Œä¸€ä¸ªå­˜å‚¨åº“ã€‚</p>
<pre><code>src
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ create_pokemon.rs
â”‚   â”œâ”€â”€ entities.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ repositories
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ pokemon.rs
â””â”€â”€ main.rs
</code></pre>
<p>æˆ‘ä»¬æœ¬å¯ä»¥æŠŠå®ƒäº¤ç»™æˆ‘ä»¬çš„å®¢æˆ·ï¼Œä½†æ˜¯é™¤äº†è¿è¡Œæµ‹è¯•èƒ½å¤Ÿé€šè¿‡ä¹‹å¤–ï¼Œ<em>main.rs</em> æ–‡ä»¶ä»ç„¶åªè¾“å‡ºä¸€ä¸ª hello
worldã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„é¡¹ç›®è½¬æ¢æˆä¸€ä¸ªè¿”å› JSON çš„ HTTP APIã€‚</p>
<h2 id="http-api"><a class="header" href="#http-api">HTTP API</a></h2>
<p>å¦‚æœä½ æ²¡è®°é”™çš„è¯ï¼Œæˆ‘æ²¡æœ‰åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å¼‚æ­¥ã€‚è¿™æ˜¯ä¸ºäº†ä¸“æ³¨äºè€ƒè™‘æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ¶æ„ã€‚å¦‚æœä½ çœŸçš„æƒ³ä½¿ç”¨å¼‚æ­¥ï¼Œé‚£å°±å»å§ : ) éå¼‚æ­¥çš„ Web
æ¡†æ¶å¹¶ä¸å¤šï¼Œä½†ä»ç„¶æœ‰ä¸€äº›ã€‚æˆ‘å†æœ¬æ–‡ä¸­çš„é€‰æ‹©æ˜¯
<a href="https://github.com/tomaka/rouille">rouille</a>ï¼Œå®ƒèƒ½å¾ˆå¥½åœ°å¤„ç†æˆ‘ä»¬çš„ç”¨ä¾‹ã€‚</p>
<p>æ‰€ä»¥é¦–å…ˆï¼Œæˆ‘ä»¬æ‰“å¼€ <em>Cargo.toml</em> å¹¶å°†å…¶æ·»åŠ åˆ°æˆ‘ä»¬çš„ä¾èµ–é¡¹ä¸­ï¼š</p>
<pre><code class="language-toml">[dependencies]
rouille = &quot;3.2.1&quot;
</code></pre>
<p>ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŒ…å«æˆ‘ä»¬æ‰€æœ‰çš„ API çš„æ–‡ä»¶å¤¹ã€‚è¿™é‡Œé¢åŒ…æ‹¬ <em>mod.rs</em> æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­æ·»åŠ åŸºæœ¬çš„è·¯ç”±é€»è¾‘ã€‚æˆ‘è¿˜å°†æ·»åŠ ä¸€ä¸ªç®€å•çš„
<em>health.rs</em> æ–‡ä»¶æ¥å¤„ç†æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè·¯ç”±ï¼š</p>
<pre><code>src
â””â”€â”€ api
    â”œâ”€â”€ health.rs
    â””â”€â”€ mod.rs
</code></pre>
<p>æˆ‘ä»¬åªä¼šåœ¨ <em>api</em> æ–‡ä»¶å¤¹ä¸­ä½¿ç”¨åˆ° <code>rouille</code>ï¼Œå¦‚æœåœ¨ä»¥åï¼Œæˆ‘ä»¬æƒ³ç”¨ <code>actix</code> ä»£æ›¿ <code>rouille</code>ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹ <em>api</em>
çš„éƒ¨åˆ†å³å¯ (å…¶å®æˆ‘ä»¬è¿˜è¦æŠŠä¸€äº›å‡½æ•°è½¬æ¢ä¸ºå¼‚æ­¥çš„ï¼Œä½†æ˜¯å®ƒä¸ Web æ¡†æ¶çš„é€‰æ‹©å¹¶ä¸ç›¸å…³)</p>
<p>ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºæœ¬å¯ç”¨çš„ APIï¼Œå½“æˆ‘ä»¬åœ¨å‘ <code>/health</code> ä¸Šå‘é€ GET è¯·æ±‚æ—¶ï¼Œå®ƒåº”è¯¥è¿”å›ä¸€äº›æ–‡æœ¬ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è¦åœ¨ <em>main.rs</em> ä¸­å¼•å…¥
<code>rutille</code>, å¹¶ä½¿ç”¨ä¹‹åä¼šåˆ›å»ºçš„ <code>serve</code> å‡½æ•°ï¼š</p>
<pre><code class="language-rs">mod api;
mod domain;
mod repositories;

#[macro_use]
extern crate rouille;

fn main() {
    api::serve(&quot;localhost:8000&quot;);
}
</code></pre>
<p>æ¥ä¸‹æ¥ï¼Œåœ¨ <em>api/mod.rs</em> é‡Œæ·»åŠ  <code>serve</code> å‡½æ•°</p>
<pre><code class="language-rs">mod health;

pub fn serve(url: &amp;str) {
    rouille::start_server(url, move |req| {
        router!(req,
            (GET) (/health) =&gt; {
                health::serve()
            },
            _ =&gt; {
                rouille::Response::from(Status::NotFound)
            }
        )
    });
}
</code></pre>
<p>ç°åœ¨åªéœ€è¦ç¼–è¾‘ <em>api/health.rs</em>ï¼š</p>
<pre><code class="language-rs">use rouille;

pub fn serve() -&gt; rouille::Response {
    rouille::Response::text(&quot;Gotta catch them all!&quot;)
}
</code></pre>
<p>ç°åœ¨æ‚¨åº”è¯¥å¯ä»¥ä½¿ç”¨ <code>cargo run</code> è¿è¡Œç¨‹åºå¹¶ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://localhost:8000/healthã€‚
åœ¨é‚£é‡Œï¼Œä¸€æ¡ç¾ä¸½çš„ä¿¡æ¯åœ¨ç­‰ç€ä½ ï¼š</p>
<pre><code>Gotta catch them all!
</code></pre>
<p>å¤ªæ£’äº†ï¼ä½†æˆ‘ä¹‹å‰è¯´è¿‡æˆ‘ä»¬æƒ³è¦ä¸€ä¸ª JSON APIã€‚è®©æˆ‘ä»¬å°†è¿™ä¸ª API æ¥å£è½¬æ¢ä¸ºè¿”å› JSONã€‚æˆ‘ä»¬å°†ç”¨åˆ° <code>serde</code>ã€‚<code>rouille</code>
æœ¬èº«å·²ç»ä½¿ç”¨äº†ä¸€äº› <code>serde</code> çš„ç‰¹å¾ï¼Œä½ å¯ä»¥é€šè¿‡ <code>cargo tree | grep serde</code> æŸ¥çœ‹ï¼š</p>
<pre><code>â”œâ”€â”€ serde v1.0.129
â”œâ”€â”€ serde_derive v1.0.129 (proc-macro)
â”œâ”€â”€ serde_json v1.0.66
â”‚   â””â”€â”€ serde v1.0.129
</code></pre>
<p>æ¥ç€è®©æˆ‘ä»¬åœ¨ <em>Cargo.toml</em> ä¸­æ·»åŠ ä¸ <code>rouille</code> ä½¿ç”¨çš„ç‰ˆæœ¬ç›¸åŒçš„ <code>serde</code> ä¾èµ–ã€‚</p>
<pre><code class="language-toml">[dependencies]
rouille = &quot;3.2.1&quot;
serde = { version = &quot;1.0.129&quot;, features = [&quot;derive&quot;] }
serde_json = &quot;1.0.66&quot;
</code></pre>
<p>ç°åœ¨æ¥ä¿®æ”¹ <em>api/health.rs</em>:</p>
<pre><code class="language-rs">use rouille;
use serde::Serialize;

#[derive(Serialize)]
struct Response {
    message: String,
}

pub fn serve() -&gt; rouille::Response {
    rouille::Response::json(&amp;Response {
        message: String::from(&quot;Gotta catch them all!&quot;),
    })
}
</code></pre>
<p>åœ¨æ¬¡è®¿é—®ä½ çš„æµè§ˆå™¨ ğŸ‰ :D</p>
<pre><code class="language-json">{
  &quot;message&quot;: &quot;Gotta catch them all!&quot;
}
</code></pre>
<h2 id="è·å–è¯·æ±‚"><a class="header" href="#è·å–è¯·æ±‚">è·å–è¯·æ±‚</a></h2>
<p>æˆ‘ä»¬çš„å®¢æˆ·æƒ³è¦çš„æ˜¯èƒ½å¤Ÿåˆ›é€ ä¸€ä¸ªå®å¯æ¢¦ã€‚é¦–å…ˆï¼Œç”±äºæˆ‘ä»¬çš„ API å°†æ˜¯ RESTfulï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬å°†ä½¿ç”¨çš„ HTTP è¯·æ±‚çš„ç¤ºä¾‹ï¼š</p>
<pre><code>- POST http://localhost:8000
- Headers
    Content-Type: application/json
- Body
    {
        &quot;number&quot;: 4,
        &quot;name&quot;: &quot;Charmander&quot;,
        &quot;types&quot;: [&quot;Fire&quot;]
    }
</code></pre>
<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›åˆ° <em>api/mod.rs</em> æ·»åŠ ä¸€ä¸ªæ–°çš„è·¯ç”±</p>
<pre><code class="language-rs">mod create_pokemon;
mod health;

pub fn serve(url: &amp;str) {
    rouille::start_server(url, move |req| {
        router!(req,
            ...
            (POST) (/) =&gt; {
                create_pokemon::serve(req)
            },
            ...
        )
    });
}
</code></pre>
<p>è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ <em>api/create_pokemon.rs</em> å¹¶å†™å…¥ä¸‹é¢çš„å†…å®¹ï¼š</p>
<pre><code class="language-rs">use rouille;
use serde::Serialize;

#[derive(Serialize)]
struct Response {
    message: String,
}

pub fn serve(_req: &amp;rouille::Request) -&gt; rouille::Response {
    rouille::Response::json(&amp;Response {
        message: String::from(&quot;Pokemon created!&quot;),
    })
}
</code></pre>
<p>ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ REST å®¢æˆ·ç«¯ (postmanã€curlã€...) åœ¨ http://localhost:8000 ä¸Šå‘é€ POST è¯·æ±‚ï¼Œbody
å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿ã€‚ä½ åº”è¯¥ä¼šæ”¶åˆ°ä»¥ä¸‹å†…å®¹ï¼š</p>
<pre><code class="language-json">{
  &quot;message&quot;: &quot;Pokemon created!&quot;
}
</code></pre>
<p>ä½†æ˜¯å½“è¯·æ±‚ä¸Šä¸‹æ–‡ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ—¶ï¼ŒAPI æœ€å¥½èƒ½è¿”å› 400 çŠ¶æ€ç ã€‚è®©æˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ <em>api/create_pokemon.rs</em>ï¼š</p>
<pre><code class="language-rs">use crate::api::Status;
use serde::{Deserialize, Serialize};

#[derive(Deserialize)]
struct Request {
    number: u16,
    name: String,
    types: Vec&lt;String&gt;,
}

pub fn serve(req: &amp;rouille::Request) -&gt; rouille::Response {
    match rouille::input::json_input::&lt;Request&gt;(req) {
        Ok(_) =&gt; {}
        _ =&gt; return rouille::Response::from(Status::BadRequest),
    };
    ...
}
</code></pre>
<p>ç°åœ¨ï¼Œå¦‚æœå‘ API å‘é€ä¸€ä¸ªæ²¡æœ‰ <code>name</code> å€¼çš„è¯·æ±‚ï¼Œæˆ–è€…å¦‚æœ <code>number</code> ä¸ºè´Ÿæ•°ï¼Œç”¨æˆ·å°†ä¼šæ”¶åˆ° 400 çŠ¶æ€ç ã€‚</p>
<h2 id="æ·»åŠ å­˜å‚¨åº“"><a class="header" href="#æ·»åŠ å­˜å‚¨åº“">æ·»åŠ å­˜å‚¨åº“</a></h2>
<p>å¥½çš„ï¼Œä½†æ˜¯å®é™…ä¸Šç°åœ¨å®å¯æ¢¦æ—¢æ²¡æœ‰åˆ›å»ºä¹Ÿæ²¡æœ‰æ·»åŠ åˆ°å­˜å‚¨åº“ä¸­ã€‚è€Œä¸” API ä¹Ÿä¸ä¼šè°ƒç”¨ç”¨ä¾‹ï¼é¦–å…ˆè®©æˆ‘ä»¬åœ¨ <em>main.rs</em>
ä¸­åˆ›å»ºä¸€ä¸ªå†…å­˜å­˜å‚¨åº“ï¼Œå¹¶æŠŠå®ƒä½œä¸ºå‚æ•°ä¼ é€’ç»™ APIï¼š</p>
<pre><code class="language-rs">use repositories::pokemon::InMemoryRepository;

fn main() {
    let repo = InMemoryRepository::new();
    api::serve(&quot;localhost:8000&quot;, &amp;mut repo);
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»ç›¸åº”åœ°ç¼–è¾‘ <em>api/mod.rs</em>ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;

pub fn serve(url: &amp;str, repo: &amp;mut dyn Repository) {
    rouille::start_server(url, move |req| {
        router!(req,
            ...
            (POST) (/) =&gt; {
                create_pokemon::serve(repo, req)
            },
            ...
        )
    });
}
</code></pre>
<p>åˆ«å¿˜äº†ä¿®æ”¹ <em>api/create_pokemon.rs</em>ï¼š</p>
<pre><code class="language-rs">use crate::repositories::pokemon::Repository;

pub fn serve(_repo: &amp;mut dyn Repository, req: &amp;rouille::Request) -&gt; rouille::Response {
</code></pre>
<p>ä½ ç°åœ¨å¯ä»¥è¿è¡Œ <code>cargo run</code> äº†ï¼Œå®ƒåº”è¯¥ ...</p>
<pre><code>error[E0277]: `dyn Repository` cannot be sent between threads safely
= help: the trait `Send` is not implemented for `dyn Repository`
error[E0277]: `dyn Repository` cannot be shared between threads safely
= help: the trait `Sync` is not implemented for `dyn Repository`
error: aborting due to 2 previous errors
</code></pre>
<p>æˆ‘åªä¿ç•™äº†æœ€åŸºç¡€çš„é”™è¯¯æ—¥å¿—ã€‚æœ‰äº›ä¸œè¥¿ä¸èµ·ä½œç”¨ï¼Œè¿™æ˜¯å› ä¸º......å€Ÿç”¨æ£€æŸ¥å™¨ã€‚æˆ‘çš„æ„æ€æ˜¯è¿™å…¶å®æ˜¯æˆ‘çš„é”™ï¼Œä½†æ˜¯å€Ÿç”¨æ£€æŸ¥å™¨åœ¨ç½©ç€æˆ‘ä»¬ : )</p>
<h2 id="æ‰“è´¥å€Ÿç”¨æ£€æŸ¥å™¨"><a class="header" href="#æ‰“è´¥å€Ÿç”¨æ£€æŸ¥å™¨">æ‰“è´¥å€Ÿç”¨æ£€æŸ¥å™¨</a></h2>
<p>åƒå¾€å¸¸ä¸€æ ·ï¼Œç¼–è¯‘å™¨å¾ˆæœ‰å¸®åŠ©ï¼šå®ƒå‘Šè¯‰æˆ‘ä»¬éœ€è¦åœ¨ <code>Repository</code> ä¸Šå®ç° <code>Send</code> å’Œ <code>Sync</code>ã€‚è®©æˆ‘ä»¬ä¿®æ”¹
<code>repositories/pokemon.rs</code> æ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>
<pre><code class="language-rs">pub trait Repository: Send + Sync {
    fn insert(&amp;mut self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert;
}
</code></pre>
<p>Rust å¾ˆå®¹æ˜“ï¼Œå¯¹å§ï¼Ÿæˆ‘ä»¬çš„ä¿®å¤å°†éå¸¸å¿«ï¼Œå› ä¸ºä¸€æ—¦è¿è¡Œ <code>cargo run</code>ï¼š</p>
<pre><code>error[E0621]: explicit lifetime required in the type of `repo`
 --&gt; src/api/mod.rs:7:5
  |
6 | pub fn serve(url: &amp;str, repo: &amp;mut dyn Repository) {
  |                               ------------------- help: add explicit lifetime `'static` to the type of `repo`: `&amp;'static mut (dyn Repository + 'static)`
</code></pre>
<p>ç°åœ¨ï¼Œç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ä»¬å­˜å‚¨åº“ä¸Šéœ€è¦ä¸€ä¸ª
â€œé™æ€ç”Ÿå‘½å‘¨æœŸâ€ã€‚è®©æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œè¿™é‡ŒçœŸæ­£çš„é—®é¢˜æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¸Œæœ›å°†å­˜å‚¨åº“çš„å¼•ç”¨å‘é€åˆ°ä¸ºæ¯ä¸ªè¯·æ±‚ç”Ÿæˆçš„çº¿ç¨‹ä¸­ã€‚ç°åœ¨æˆ‘ä»¬ä½¿ç”¨æˆ‘ä»¬çš„
<code>InMemoryRepository</code>
ç»“æ„ä½“åˆ›å»ºäº†ä¸€ä¸ªå­˜å‚¨åº“ã€‚é—®é¢˜æ˜¯ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ‰§è¡Œåˆ°ä¸»å‡½æ•°ç»“æŸæ—¶ï¼Œè¿™ä¸ªå­˜å‚¨åº“çš„èµ„æºå°†è¢«é‡Šæ”¾ã€‚ä½†ä¹Ÿè®¸æœ‰äº›çº¿ç¨‹ä»ç„¶ä¼šå¼•ç”¨åˆ°å®ƒã€‚æœ€ç»ˆå¯¼è‡´ç¼–è¯‘å™¨é”™è¯¯ã€‚</p>
<p>æˆ‘ä»¬æƒ³è¦çš„æ˜¯ä»¥æŸç§æ–¹å¼å‘Šè¯‰ç¨‹åºï¼Œåªæœ‰åœ¨å¼•ç”¨ä¸å†å­˜åœ¨æ—¶å†é‡Šæ”¾æ‰æˆ‘ä»¬çš„å­˜å‚¨åº“ã€‚è¿™ç§æ–¹å¼ç§°ä¸ºå¼•ç”¨è®¡æ•°å™¨ã€‚æˆ‘ä»¬å¾ˆå¹¸è¿ï¼ŒRust
ä¸ºæ­¤æä¾›äº†ä¸¤ç§ç±»å‹ï¼Œå…¶ä¸­ä¸€ç§æ˜¯ä¸“é—¨ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´å®‰å…¨å…±äº«è€Œåˆ›å»ºçš„ã€‚å®ƒçš„åå­—æ˜¯ <strong><code>Arc</code></strong>ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„ã€‚</p>
<p>å› æ­¤ï¼Œè®©æˆ‘ä»¬åœ¨ <em>main.rs</em> ä¸­ç”¨ <code>Arc</code> åŒ…è£…æˆ‘ä»¬çš„å­˜å‚¨åº“ï¼š</p>
<pre><code class="language-rs">use std::sync::Arc;

fn main() {
    let repo = Arc::new(InMemoryRepository::new());
    api::serve(&quot;localhost:8000&quot;, repo);
}
</code></pre>
<p>ä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç§»é™¤äº†ä¸¤ä¸ªä¸œè¥¿ï¼šä¸€ä¸ª <code>&amp;</code> å’Œä¸€ä¸ª <code>mut</code>ã€‚ <code>Arc</code>
å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå› æ­¤å®ƒçš„å¤§å°åœ¨ç¼–è¯‘æ—¶æ˜¯å·²çŸ¥çš„ã€‚å®ƒæŒ‡å‘ä½äºå †ä¸­çš„å­˜å‚¨åº“ã€‚å› æ­¤æˆ‘ä»¬ä¸éœ€è¦å¼•ç”¨å®ƒã€‚å…¶æ¬¡ï¼ŒArc
æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å†…éƒ¨å¯å˜æ€§ã€‚è¿™ç‚¹æˆ‘ä»¬ç¨åå†è°ˆã€‚</p>
<p>ç°åœ¨è®©æˆ‘ä»¬ä¿®æ”¹ <em>api/mod.rs</em>ï¼š</p>
<pre><code class="language-rs">use std::sync::Arc;

pub fn serve(url: &amp;str, repo: Arc&lt;dyn Repository&gt;) {
    rouille::start_server(url, move |req| {
        router!(req,
            ...
            (POST) (/) =&gt; {
                create_pokemon::serve(repo.clone(), req)
            },
            ...
        )
    });
}
</code></pre>
<p>æœ€åå†æ¥ä¿®æ”¹ <em>api/create_pokemon.rs</em>:</p>
<pre><code class="language-rs">use std::sync::Arc;

pub fn serve(_repo: Arc&lt;dyn Repository&gt;, req: &amp;rouille::Request) -&gt; rouille::Response {
</code></pre>
<p>ç¼–è¯‘æˆåŠŸ \o/</p>
<h2 id="åŸŸä¹Ÿéœ€è¦çˆ±-"><a class="header" href="#åŸŸä¹Ÿéœ€è¦çˆ±-">åŸŸä¹Ÿéœ€è¦çˆ± ğŸ’“</a></h2>
<p>æˆ‘ä»¬å›´ç»•ç€ä¸€ä¸ªåŸŸè®¾è®¡äº†æˆ‘ä»¬çš„ç¨‹åºï¼Œå…¶ä¸­åŒ…å«ä½¿ç”¨ç”¨ä¾‹è·å–æ•°æ®å’Œä¸€ä¸ªå­˜å‚¨åº“ç”¨æ¥ä¿å­˜æ•°æ®ã€‚åƒä¹‹å‰ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»åœ¨ç”¨ä¾‹ä¸­æŠŠå­˜å‚¨åº“æ›¿æ¢ä¸º <code>Arc</code>
çš„å¯å˜å¼•ç”¨ã€‚å¥½åœ¨æˆ‘ç°åœ¨åªå®ç°äº†ä¸€ä¸ªç”¨ä¾‹ : ) è®©æˆ‘ä»¬åœ¨ <em>domain/create_pokemon.rs</em> ä¸­ä¿®æ”¹å‡½æ•°ç­¾åï¼š</p>
<pre><code class="language-rs">use std::sync::Arc;

fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Response {
</code></pre>
<p>ä¸è¦å¿˜è®°æµ‹è¯•ä¸­ä¹Ÿè¦ä¿®æ”¹ï¼</p>
<pre><code class="language-rs">let repo = Arc::new(InMemoryRepository::new());
let res = execute(repo, req);
</code></pre>
<p>åœ¨è¿è¡Œ <code>cargo run</code> ä¹‹åï¼Œæˆ‘ä»¬å¶ç„¶å‘ç°äº†æˆ‘ä¹‹å‰è®¨è®ºè¿‡çš„ä¸€ä¸ªé—®é¢˜ï¼š<code>Arc</code> æ˜¯ä¸å¯å˜çš„ã€‚</p>
<pre><code>25 |         (Ok(number), Ok(name), Ok(types)) =&gt; match repo.insert(number, name, types) {
   |                                                    ^^^^ cannot borrow as mutable
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æ£€æŸ¥ <em>repositories/pokemon.rs</em> ä¸­çš„ <code>Repository</code> Traitï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>insert</code>
æ–¹æ³•å¸Œæœ›å­˜å‚¨åº“æ˜¯å¯å˜çš„ï¼š</p>
<pre><code class="language-rs">pub trait Repository: Send + Sync {
    fn insert(&amp;mut self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert;
}
</code></pre>
<p>æ‰€ä»¥æˆ‘ä»¬å°†åœ¨ <code>Repository</code> Trait å’Œæˆ‘ä»¬çš„å®ç°ä¸­åˆ é™¤è¿™ä¸ª <code>mut</code> : ) è®©æˆ‘ä»¬è¿è¡Œ <code>cargo run</code>ï¼š</p>
<pre><code class="language-rs">36 |     fn insert(&amp;self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert {
   |               ----- help: consider changing this to be a mutable reference: `&amp;mut self`
...
46 |         self.pokemons.push(Pokemon::new(number_clone, name, types));
   |         ^^^^^^^^^^^^^ `self` is a `&amp;` reference, so the data it refers to cannot be borrowed as mutable
</code></pre>
<p>å“å‘€ï¼Œè¿™ä¸ªé”™è¯¯ä¿¡æ¯ä¸æ˜¯å¾ˆæœ‰å¸®åŠ©ã€‚æˆ‘ä»¬åˆšåˆšåˆ é™¤äº† <code>mut</code>ï¼Œç°åœ¨ç¼–è¯‘å™¨å¸Œæœ›æˆ‘ä»¬é‡æ–°æ·»åŠ å®ƒã€‚å®é™…ä¸Šè¿™æ˜¯åˆä¹é€»è¾‘çš„ï¼Œç¼–è¯‘å™¨ä¸çŸ¥é“å­˜å‚¨åº“åœ¨ <code>Arc</code> ä¸­ã€‚</p>
<p>æœ‰è¶£çš„æ˜¯ï¼Œé—®é¢˜ä¸å†åœ¨äº <code>trait</code>ï¼Œè€Œåœ¨äºæˆ‘ä»¬çš„å­˜å‚¨åº“å®ç°ã€‚æˆ‘ä»¬éœ€è¦èƒ½å¤Ÿåœ¨ <code>self</code> ä¸å¯å˜çš„æƒ…å†µä¸‹æ”¹å˜å†…éƒ¨çš„ <code>pokemons</code>ã€‚
è¿™å°±æ˜¯å†…éƒ¨å¯å˜æ€§ã€‚è€Œä¸”ï¼ŒRust å†æ¬¡ä¸ºæ­¤æä¾›äº†ä¸€äº›åŸè¯­ï¼æˆ‘ä»¬å°†é€‰æ‹© <code>Mutex</code> åŸè¯­ï¼Œå› ä¸ºå®ƒæ˜¯ä¸ºäº†åœ¨çº¿ç¨‹ä¹‹é—´å…±äº«æ•°æ®è€Œè®¾è®¡çš„ã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬å°†
<code>pokemons</code> åŒ…è£…åˆ° <code>Mutex</code> ä¸­ï¼š</p>
<pre><code class="language-rs">use std::sync::Mutex;

pub struct InMemoryRepository {
    error: bool,
    pokemons: Mutex&lt;Vec&lt;Pokemon&gt;&gt;,
}

impl InMemoryRepository {
    pub fn new() -&gt; Self {
        let pokemons: Mutex&lt;Vec&lt;Pokemon&gt;&gt; = Mutex::new(vec![]);
        Self {
            error: false,
            pokemons,
        }
    }
}
</code></pre>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¿…é¡»é”å®š <code>Mutex</code> æ‰èƒ½è¯»å–æˆ–å†™å…¥å®å¯æ¢¦ã€‚é”å®š <code>Mutex</code>
æ„å‘³ç€æ‰€æœ‰çº¿ç¨‹å¿…é¡»è½®æµç­‰å¾…è¯»å–æˆ–å†™å…¥å®ƒæ‰€ä¿å­˜çš„æ•°æ®ï¼Œå› æ­¤åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®ã€‚</p>
<pre><code class="language-rs">impl Repository for InMemoryRepository {
    fn insert(&amp;self, number: PokemonNumber, name: PokemonName, types: PokemonTypes) -&gt; Insert {
        if self.error {
            return Insert::Error;
        }

        let mut lock = match self.pokemons.lock() {
            Ok(lock) =&gt; lock,
            _ =&gt; return Insert::Error,
        };

        if lock.iter().any(|pokemon| pokemon.number == number) {
            return Insert::Conflict;
        }

        let number_clone = number.clone();
        lock.push(Pokemon::new(number_clone, name, types));
        Insert::Ok(number)
    }
}
</code></pre>
<p>ç°åœ¨å®ƒç¼–è¯‘é€šè¿‡ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æµ‹è¯•ä¹Ÿä»ç„¶é€šè¿‡ï¼</p>
<h2 id="api--domain--3"><a class="header" href="#api--domain--3">API + domain =&lt; 3</a></h2>
<p>æ˜¯æ—¶å€™å°† API è¿æ¥åˆ° Domain äº†ã€‚è®©æˆ‘ä»¬ä¿®æ”¹ <code>api/create_pokemon.rs</code>ï¼š</p>
<pre><code class="language-rs">use crate::domain::create_pokemon;

pub fn serve(repo: Arc&lt;dyn Repository&gt;, req: &amp;rouille::Request) -&gt; rouille::Response {
    let req = match rouille::input::json_input::&lt;Request&gt;(req) {
        Ok(req) =&gt; create_pokemon::Request {
            number: req.number,
            name: req.name,
            types: req.types,
        },
        _ =&gt; return rouille::Response::from(Status::BadRequest),
    };
    match create_pokemon::execute(repo, req) {
        create_pokemon::Response::Ok(number) =&gt; rouille::Response::json(&amp;Response { number }),
        create_pokemon::Response::BadRequest =&gt; rouille::Response::from(Status::BadRequest),
        create_pokemon::Response::Conflict =&gt; rouille::Response::from(Status::Conflict),
        create_pokemon::Response::Error =&gt; rouille::Response::from(Status::InternalServerError),
    }
}
</code></pre>
<p>è®°å¾—æŠŠåŸŸä¸­éœ€è¦çš„ä»£ç æ”¹ä¸º pubï¼š</p>
<pre><code class="language-rs">// domain/mod.rs
pub mod create_pokemon;

// domain/create_pokemon.rs
pub struct Request {
    pub number: u16,
    pub name: String,
    pub types: Vec&lt;String&gt;,
}

pub enum Response {
    ...
}

pub fn execute(repo: Arc&lt;dyn Repository&gt;, req: Request) -&gt; Response {
    ...
}
</code></pre>
<p>åœ¨æ¬¡è¿è¡Œ <code>cargo run</code> å¹¶å‘ <code>create_pokemon</code> è·¯ç”±å‘é€æœ‰æ•ˆè¯·æ±‚ï¼š</p>
<pre><code class="language-json">{
  &quot;number&quot;: 30
}
</code></pre>
<p>\o/</p>
<h2 id="ä¸‹ä¸€æ­¥-2"><a class="header" href="#ä¸‹ä¸€æ­¥-2">ä¸‹ä¸€æ­¥</a></h2>
<p>è¿™ç¯‡æ–‡ç« æ¯”é¢„æœŸçš„è¦é•¿ï¼Œå¯¹æ­¤æˆ‘æ„Ÿåˆ°æŠ±æ­‰ã€‚å¸Œæœ›å®ƒå¯¹ä½ æœ‰ç”¨ :) åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å®ç°å…¶ä»–çš„ç”¨ä¾‹ (å®¢æˆ·åŒå€¦äº†ç­‰å¾…æˆ‘è§£é‡Šä¸€åˆ‡ï¼Œå®¢æˆ·çœŸç³Ÿç³• :p)
å†ä¹‹åï¼Œæˆ‘å°†å®ç°å…¶ä»–çš„å‰ç«¯å’Œå­˜å‚¨åº“ï¼Œä»¥æ›´å¥½åœ°äº†è§£å…­è¾¹å½¢æ¶æ„çš„å¼ºå¤§åŠŸèƒ½ã€‚</p>
<p>åƒå¾€å¸¸ä¸€æ ·ï¼Œä»£ç å¯ä»¥åœ¨ <a href="https://github.com/alexislozano/pokedex/tree/article-3">github</a>
ä¸ŠæŸ¥çœ‹ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-å…­è¾¹å½¢æ¶æ„-1"><a class="header" href="#rust-å…­è¾¹å½¢æ¶æ„-1">Rust å…­è¾¹å½¢æ¶æ„</a></h1>
<h2 id="å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»-1"><a class="header" href="#å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»-1">å…­è¾¹å½¢æ¶æ„åŸºæœ¬ä»‹ç»</a></h2>
<p>å…­è¾¹å½¢æ¶æ„ï¼Œæ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚ä¾ç…§è¿™ç§æ¶æ„åˆ›å»ºçš„ç¨‹åºï¼Œèƒ½å¤Ÿåœ¨æ²¡æœ‰ UI
æˆ–æ•°æ®åº“çš„æƒ…å†µä¸‹æ­£å¸¸å·¥ä½œã€‚æ‰€ä»¥å³ä½¿æ²¡æœ‰æ•°æ®åº“ä½ ä¾ç„¶å¯ä»¥è¿›è¡Œå¼€å‘å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œè€Œä¸”æ— éœ€å…¶ä»–ç”¨æˆ·å‚ä¸ã€‚</p>
<h3 id="ç«¯å£ä¸é€‚é…å™¨-1"><a class="header" href="#ç«¯å£ä¸é€‚é…å™¨-1">ç«¯å£ä¸é€‚é…å™¨</a></h3>
<p>å…­è¾¹å½¢æ¶æ„ä¹Ÿå«åšç«¯å£ä¸é€‚é…å™¨æ¶æ„ã€‚</p>
<p><img src="https://alistair.cockburn.us/wp-content/uploads/2018/02/Hexagonal-architecture-complex-example.gif" alt="" /></p>
<p>ä»€ä¹ˆæ˜¯ç«¯å£ï¼Ÿ</p>
<p>ç«¯å£æŒ‡çš„æ˜¯å…­è¾¹å½¢çš„è¾¹ï¼Œå±äºåº”ç”¨ç¨‹åºçš„å†…éƒ¨ï¼Œæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å…¥å£å’Œå‡ºå£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œè¡¨ç¤ºè®¾å¤‡å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ç”¨ä¾‹ã€‚åœ¨ Rust é‡Œå°±æ˜¯ç”±ä¸€ä¸ª
Traitï¼Œä»¥åŠä¸€äº› DTO ç»„æˆ</p>
<p>ä»€ä¹ˆæ˜¯é€‚é…å™¨ï¼Ÿ</p>
<p>é€‚é…å™¨å›´ç»•ç€ç«¯å£ç¼–å†™ï¼Œèƒ½å¤Ÿå°†è¾“å…¥è½¬åŒ–ä¸ºç¬¦åˆç«¯å£çš„ç±»å‹ï¼Œå¹¶æŠŠè¾“å…¥è½¬åŒ–ä¸ºç”¨ç”¨ç¨‹åºå†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ã€‚æ¢å¥è¯è¯´å°±æ˜¯ <code>controller</code> æˆ–è€…æ˜¯å‘½ä»¤è¡Œä¸€æ¡å‘½ä»¤å¤„ç†å™¨ã€‚</p>
<p>å½“ä»»ä½•å¤–éƒ¨è®¾å¤‡ (æ¯”å¦‚ï¼šWEBï¼ŒAPPï¼Œç»ˆç«¯ï¼Œæµ‹è¯•...)
æƒ³è¦è®¿é—®è¾“å…¥ç«¯å£æ—¶ï¼Œé¦–å…ˆè¿™ä¸ªè¾“å…¥ä¼šè¢«è¯¥è®¾å¤‡å¯¹åº”çš„è¾“å…¥é€‚é…å™¨ï¼Œè½¬åŒ–ä¸ºç¬¦åˆè¦æ±‚çš„å¯ç”¨çš„æ–¹æ³•è°ƒç”¨ï¼Œæˆ–è€…æ˜¯æ¶ˆæ¯ï¼Œç„¶åå†ä¼ é€’ç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å‘å¤–å‘é€æ•°æ®æ—¶ï¼Œé¦–å…ˆå®ƒä¼šæŠŠæ•°æ®é€šè¿‡è¾“å‡ºç«¯å£ä¼ é€’ç»™è¾“å‡ºé€‚é…å™¨ï¼Œç„¶åå†ä¼ é€’ç»™è¾“å‡ºå¯¹è±¡ (æ¯”å¦‚ï¼šæ•°æ®åº“ï¼Œmockï¼ŒAPIï¼Œé‚®ä»¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—...)</p>
<p>å› æ­¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¤–éƒ¨æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚</p>
<h3 id="åº”ç”¨ç¨‹åºæ ¸å¿ƒ-1"><a class="header" href="#åº”ç”¨ç¨‹åºæ ¸å¿ƒ-1">åº”ç”¨ç¨‹åºæ ¸å¿ƒ</a></h3>
<p>ä½¿ç”¨å…­è¾¹å½¢æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸è¢«ç§°ä½œåŸŸï¼ŒåŸŸä¸­æœ‰ä¸‰ä¸ªæ ¸æ¦‚å¿µï¼š</p>
<ul>
<li>å®ä½“ (Entities)ï¼šåªæ˜¯ç®€å•çš„å®šä¹‰äº†å¯¹è±¡ã€‚</li>
<li>äº¤äº’å™¨ (Interactors)ï¼šå®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœ¬æ–‡é‡Œæˆ‘ä»¬ä¼šå°†å…¶ç§°ä¸ºç”¨ä¾‹ Usecaseã€‚</li>
<li>å­˜å‚¨åº“ (Repositories)ï¼šåªå®šä¹‰äº†æ“ä½œå®ä½“çš„æ–¹æ³•ã€‚</li>
</ul>
<h3 id="ä¼˜ç‚¹-1"><a class="header" href="#ä¼˜ç‚¹-1">ä¼˜ç‚¹</a></h3>
<p>åœ¨ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„ä¸­ï¼Œåªèƒ½ä»ä¸Šå¾€ä¸‹è°ƒç”¨ã€‚</p>
<p>è€Œç°åœ¨æˆ‘ä»¬æŠŠæ¥å£ä¿ç•™åœ¨åŸŸä¸­ï¼ŒåŸŸä¸å†ä¾èµ–å¤–éƒ¨çš„å¤–éƒ¨å®ç°ã€‚ä¿è¯äº†å¤–éƒ¨è®¾å¤‡æ˜¯å¯æ›¿æ¢çš„ã€‚å½“ä¸šåŠ¡é€»è¾‘éœ€è¦ç”¨åˆ°æ•°æ®å­˜å‚¨æ—¶ï¼Œç›´æ¥è°ƒç”¨æŠ½è±¡æ¥å£å³å¯ã€‚</p>
<h2 id="å°†è¦åšäº›ä»€ä¹ˆ-1"><a class="header" href="#å°†è¦åšäº›ä»€ä¹ˆ-1">å°†è¦åšäº›ä»€ä¹ˆï¼Ÿ</a></h2>
<p>åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å°†ä¼šå®ç°ä¸€ä¸ª pokemon æœåŠ¡ã€‚ä¸»è¦åŠŸèƒ½æ˜¯å¢åŠ ã€åˆ é™¤å’ŒæŸ¥è¯¢ã€‚</p>
<p>ä¸ºäº†ä½“ç°å…­è¾¹å½¢æ¶æ„çš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬å°†ä¼šå®ç°ä¸¤å¥—ç”¨æˆ·æ¥å£ï¼ŒåŒ…æ‹¬ HTTP API å’Œ CLIã€‚ä¸‰å¥—å­˜å‚¨åº“ï¼ŒåŒ…æ‹¬å†…å­˜ï¼ŒSQLite æ•°æ®åº“å’Œ Airtable
(ä¸€ä¸ªåœ¨çº¿è¡¨æ ¼åº”ç”¨)ã€‚</p>
<p>å…­è¾¹å½¢æ¶æ„çš„æ ¸å¿ƒä¸éœ€è¦ä¾èµ–äºå…·ä½“çš„å­˜å‚¨åº“æˆ–è€…æ˜¯ç”¨æˆ·æ¥å£ï¼Œä¸ºäº†æˆ‘ä»¬çš„ç¨‹åºèƒ½å¤Ÿç¨³å®šè¿è¡Œï¼Œæˆ‘ä»¬ä¹Ÿä¼šéå¸¸æ³¨é‡äºå•å…ƒæµ‹è¯•ã€‚ä¸€æ—¦æˆ‘ä»¬çš„åŸŸç¨³å®šä¸‹æ¥ï¼Œå®ç°ç”¨æˆ·æ¥å£ï¼Œæ›¿æ¢å­˜å‚¨åº“éƒ½ä¼šæ˜¯éå¸¸ç®€å•å¿«é€Ÿçš„ã€‚</p>
<h2 id="é¡¹ç›®ç»“æ„-1"><a class="header" href="#é¡¹ç›®ç»“æ„-1">é¡¹ç›®ç»“æ„</a></h2>
<pre><code>src/
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ cli
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ entities.rs
â”‚   â”œâ”€â”€ fetch_pokemon.rs
â”‚   â””â”€â”€ mod.rs
â”œâ”€â”€ main.rs
â””â”€â”€ repositories
    â”œâ”€â”€ mod.rs
    â””â”€â”€ pokemon.rs
</code></pre>
<p>å…­è¾¹å½¢æ¶æ„çš„æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸è¢«ç§°ä½œåŸŸï¼Œå°±æ˜¯ä¸‹é¢çš„ <code>domain</code> æ¨¡å—ï¼Œé‡Œé¢åŒ…æ‹¬å®ä½“çš„å®šä¹‰å’Œç”¨ä¾‹çš„å®ç°ã€‚<code>api</code> å’Œ <code>cli</code>
æ˜¯ä¸¤å¥—ç”¨æˆ·æ¥å£ã€‚<code>repositories</code> ä¸­åˆ™æ˜¯å­˜å‚¨åº“çš„å®šä¹‰ä¸å®ç°</p>
<h2 id="å»¶ç”³é˜…è¯»-1"><a class="header" href="#å»¶ç”³é˜…è¯»-1">å»¶ç”³é˜…è¯»</a></h2>
<ul>
<li><a href="https://alistair.cockburn.us/hexagonal-architecture/">å…­è¾¹å½¢æ¶æ„ ( hexagonal-architecture )</a></li>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">å¹²å‡€æ¶æ„ ( the-clean-architecture )</a></li>
<li><a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/">æ´‹è‘±æ¶æ„ ( The Onion Architecture )</a></li>
<li><a href="https://herbertograca.com/2017/07/03/the-software-architecture-chronicles/">è½¯ä»¶æ¶æ„ç¼–å¹´å² ( The Software Architecture Chronicles )</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="java"><a class="header" href="#java">java</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="java-1"><a class="header" href="#java-1">Java</a></h1>
<h2 id="åŸºç¡€çŸ¥è¯†"><a class="header" href="#åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</a></h2>
<h3 id="for-å’Œ-whiletrue-çš„åŒºåˆ«"><a class="header" href="#for-å’Œ-whiletrue-çš„åŒºåˆ«">for(;;) å’Œ while(true) çš„åŒºåˆ«</a></h3>
<p>è™½ç„¶ä¸¤è€…éƒ½èƒ½å®ç°æ­»å¾ªç¯ï¼Œä½†æ˜¯æºç ä¸­éƒ½æ˜¯é€‰æ‹© for(;;) åŸå› ï¼š</p>
<pre><code>ç¼–è¯‘å‰              ç¼–è¯‘å
while (1)           mov eax,1
                    test eax,eax
                    je foo+23h
                    jmp foo+18h

ç¼–è¯‘å‰              ç¼–è¯‘å
for (;;)          jmp foo+23h
</code></pre>
<p>å¯¹æ¯”ä¹‹ä¸‹ï¼Œfor (;;) æŒ‡ä»¤å°‘ï¼Œä¸å ç”¨å¯„å­˜å™¨ï¼Œè€Œä¸”æ²¡æœ‰åˆ¤æ–­è·³è½¬ï¼Œæ¯” while (1) å¥½ã€‚
ä¹Ÿå°±æ˜¯è¯´ä¸¤è€…åœ¨åœ¨å®è§‚ä¸Šå®Œå…¨ä¸€æ ·çš„é€»è¾‘ï¼Œä½†æ˜¯åº•å±‚å®Œå…¨ä¸ä¸€æ ·ï¼Œfor ç›¸å¯¹äºæ¥è¯´æ›´åŠ ç®€æ´æ˜äº†ã€‚</p>
<h3 id="equal-ä¸çš„åŒºåˆ«"><a class="header" href="#equal-ä¸çš„åŒºåˆ«">equal ä¸==çš„åŒºåˆ«</a></h3>
<ol>
<li>åŒºåˆ«</li>
</ol>
<ul>
<li>==æ˜¯è¿ç®—ç¬¦ï¼Œequal æ˜¯æ–¹æ³•ï¼Œ</li>
<li>æ¯”è¾ƒåŸºæœ¬ç±»å‹ï¼šåªèƒ½ç”¨==, ä¸èƒ½ç”¨ equal</li>
<li>æ¯”è¾ƒåŒ…è£…ç±»å‹ï¼š==æ¯”è¾ƒçš„æ˜¯å†…å­˜åœ°å€ï¼Œè€Œ equal æ¯”è¾ƒçš„æ˜¯å€¼</li>
<li>æ¯”è¾ƒå¯¹è±¡ï¼š==å’Œ equal æ¯”è¾ƒçš„éƒ½æ˜¯å†…å­˜åœ°å€ï¼Œå› ä¸º equal æ²¡æœ‰è¢«é‡å†™ï¼Œæ²¡æœ‰è¢«é‡å†™çš„ equal éƒ½æ˜¯ object çš„ equal æ–¹æ³• ::: warning
æ³¨æ„ Stringï¼ˆè¿˜æœ‰ Dateï¼ŒIntegerï¼‰ç±»å‹é‡å†™äº† equals æ–¹æ³•ï¼Œä½¿å…¶æ¯”è¾ƒçš„æ˜¯å­˜å‚¨å¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸ç­‰ï¼Œè€Œä¸æ˜¯å †å†…å­˜åœ°å€ã€‚ :::</li>
</ul>
<h3 id="classthis-å’Œ-this-çš„åŒºåˆ«"><a class="header" href="#classthis-å’Œ-this-çš„åŒºåˆ«">Class.this å’Œ this çš„åŒºåˆ«</a></h3>
<p>å½“ inner classï¼ˆå†…éƒ¨ç±»ï¼‰å¿…é¡ºä½¿ç”¨åˆ° outer classï¼ˆå¤–éƒ¨ç±»ï¼‰çš„ this instanceï¼ˆå®ä¾‹ï¼‰æ—¶ï¼Œæˆ–è€…åŒ¿åå†…éƒ¨ç±»è¦ä½¿ç”¨å¤–éƒ¨ç±»çš„å®ä¾‹ã€‚</p>
<h3 id="å¾…ç»­"><a class="header" href="#å¾…ç»­">å¾…ç»­...</a></h3>
<h2 id="åŒ…è£…ç±»"><a class="header" href="#åŒ…è£…ç±»">åŒ…è£…ç±»</a></h2>
<h3 id="int-vs-integer"><a class="header" href="#int-vs-integer">int VS Integer</a></h3>
<h5 id="åˆå§‹åŒ–"><a class="header" href="#åˆå§‹åŒ–">åˆå§‹åŒ–</a></h5>
<ul>
<li>1 int ç±»çš„å˜é‡åˆå§‹ä¸º 0. Integer çš„å˜é‡åˆ™åˆå§‹åŒ–ä¸º null.</li>
<li>2 Integer å˜é‡å¿…é¡»å®ä¾‹åŒ–åæ‰èƒ½ä½¿ç”¨ï¼Œint å˜é‡ä¸éœ€è¦ .</li>
<li>3 åœ¨ Int æ˜¯å°†å€¼ç›´æ¥å­˜å‚¨ï¼ŒInteger å¯¹è±¡æ˜¯ç”ŸæˆæŒ‡é’ˆæŒ‡å‘æ­¤å¯¹è±¡ã€‚</li>
</ul>
<h5 id="æ¯”è¾ƒ"><a class="header" href="#æ¯”è¾ƒ">æ¯”è¾ƒ</a></h5>
<ol>
<li>Integer ? int <code>&lt;br/&gt;</code> åªè¦ä¸¤ä¸ªå˜é‡çš„å€¼æ˜¯å‘ç­‰çš„ï¼Œåˆ™ç»“æœä¸º trueã€‚
å› ä¸ºåŒ…è£…ç±» Integer å’ŒåŸºæœ¬æ•°æ®ç±»å‹ int æ¯”è¾ƒæ—¶ï¼Œjava ä¼šè‡ªåŠ¨æ‹†åŒ…è£…ä¸º intï¼Œç„¶åè¿›è¡Œæ¯”è¾ƒï¼Œå®é™…ä¸Šå°±å˜ä¸ºä¸¤ä¸ª int å˜é‡çš„æ¯”è¾ƒã€‚</li>
<li>new Integer() ? !new Integer()ï¼Œ<code>&lt;br/&gt;</code> ç»“æœä¸º false ! new
Integer() å½“å˜é‡å€¼åœ¨ -128~127 ä¹‹é—´æ—¶ï¼Œé new ç”Ÿæˆçš„ Integer å˜é‡æŒ‡å‘çš„æ˜¯ java å¸¸é‡æ± ä¸­ cache æ•°ç»„ä¸­å­˜å‚¨çš„æŒ‡å‘äº†å †ä¸­çš„ Integer å¯¹è±¡ï¼Œ
è€Œ new Integer() ç”Ÿæˆçš„å˜é‡æŒ‡å‘å †ä¸­æ–°å»ºçš„å¯¹è±¡ï¼Œä¸¤è€…åœ¨å†…å­˜ä¸­çš„åœ°å€ä¸åŒï¼›</li>
<li>new Interger() ? new Integer() <code>&lt;br/&gt;</code> false</li>
<li>!new Integer() ? !new Integer() <code>&lt;br/&gt;</code> å¦‚æœä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œä¸”åœ¨åŒºé—´ -128 åˆ° 127 ä¹‹é—´åˆ™ true
åªè¦ä¸åŒæˆ–è€…æœ‰å€¼åœ¨åŒºé—´å¤–å°±ä¸ç›¸åŒ</li>
</ol>
<h5 id="åº”ç”¨"><a class="header" href="#åº”ç”¨">åº”ç”¨</a></h5>
<pre><code class="language-java">Integer a = Integer.parseInt(&quot;1&quot;);
Integer b = Integer.parseInt(&quot;1&quot;);
synchronized(i)
</code></pre>
<h2 id="ææ„å‡½æ•°"><a class="header" href="#ææ„å‡½æ•°">&quot;ææ„å‡½æ•°&quot;</a></h2>
<p>java æä¾› finalize() æ–¹æ³•ï¼Œåƒåœ¾å›æ”¶å™¨å‡†å¤‡é‡Šæ”¾å†…å­˜çš„æ—¶å€™ï¼Œä¼šå…ˆè°ƒç”¨ finalize()ã€‚</p>
<ul>
<li>ç‰¹å¾</li>
</ul>
<ol>
<li>å¯¹è±¡ä¸ä¸€å®šä¼šè¢«å›æ”¶ã€‚</li>
<li>åƒåœ¾å›æ”¶ä¸æ˜¯ææ„å‡½æ•°ã€‚</li>
<li>åƒåœ¾å›æ”¶åªä¸å†…å­˜æœ‰å…³ã€‚</li>
<li>åƒåœ¾å›æ”¶å’Œ finalize() éƒ½æ˜¯é ä¸ä½çš„ï¼Œåªè¦ JVM è¿˜æ²¡æœ‰å¿«åˆ°è€—å°½å†…å­˜çš„åœ°æ­¥ï¼Œå®ƒæ˜¯ä¸ä¼šæµªè´¹æ—¶é—´è¿›è¡Œåƒåœ¾å›æ”¶çš„ã€‚</li>
</ol>
<ul>
<li>åº”å¯¹æ–¹æ³•</li>
</ul>
<ol>
<li>ä¸»åŠ¨è°ƒç”¨ System.gc() æ–¹æ³•å¼ºåˆ¶åƒåœ¾å›æ”¶å™¨æ¥é‡Šæ”¾è¿™äº›å¯¹è±¡çš„å†…å­˜ã€‚</li>
<li>Java 1.1 é€šè¿‡æä¾›ä¸€ä¸ª System.runFinalizersOnExit() æ–¹æ³•ï¼Œä¸è±¡ System.gc()
æ–¹æ³•é‚£æ ·ï¼ŒSystem.runFinalizersOnExit() æ–¹æ³•å¹¶ä¸ç«‹å³è¯•å›¾å¯åŠ¨åƒåœ¾å›æ”¶å™¨ã€‚è€Œæ˜¯å½“åº”ç”¨ç¨‹åºæˆ– Applet
é€€å‡ºæ—¶ï¼Œå®ƒè°ƒç”¨æ¯ä¸ªå¯¹è±¡çš„ finalize() æ–¹æ³•ã€‚</li>
<li>ç»§æ‰¿ finalize()</li>
</ol>
<h2 id="æ³›å‹"><a class="header" href="#æ³›å‹">æ³›å‹</a></h2>
<h3 id="t-çš„ä½ç½®"><a class="header" href="#t-çš„ä½ç½®">T çš„ä½ç½®</a></h3>
<ol>
<li>ç¤ºä¾‹</li>
</ol>
<pre><code class="language-java">static &lt;T&gt; void show(Collection&lt;T&gt; C) {
    System.out.println(&quot;ä½¿ç”¨æ³›å‹ -------&gt;&quot; + C);
}
</code></pre>
<ol start="2">
<li>è§£é‡Š</li>
</ol>
<ul>
<li>ç¬¬ä¸€å¤„ï¼šé™æ€æ–¹æ³•ä¸èƒ½ç›´æ¥å¼•ç”¨ç±»å®šä¹‰å¤„çš„æ³›å‹ï¼Œéœ€è¦æå‰å®šä¹‰å¥½æ³›å‹æ‰èƒ½ä½¿ç”¨</li>
<li>ç¬¬äºŒå¤„ï¼šæŒ‡å®š Collection çš„å…ƒç´ ç±»å‹ä¸º T</li>
</ul>
<h3 id="è¾¹ç•Œé€šé…ç¬¦"><a class="header" href="#è¾¹ç•Œé€šé…ç¬¦">è¾¹ç•Œé€šé…ç¬¦</a></h3>
<pre><code class="language-java">&lt;? extends T&gt;å’Œ&lt;? super T&gt;
</code></pre>
<ol>
<li>å¼•ä¾‹</li>
</ol>
<ul>
<li>è¿™ç§æƒ…å†µä¸‹æ˜¯å¯è¡Œçš„</li>
</ul>
<pre><code class="language-java">Plate&lt;Fruit&gt; plate = new Plate&lt;&gt;(apple);
</code></pre>
<ul>
<li>è¿™ç§æƒ…å†µä¸‹ï¼Œè™½ç„¶è‹¹æœå’Œæ°´æœæœ‰ç»§æ‰¿å…³ç³»ï¼Œä½†ç›˜å­é—´æ²¡æœ‰ç»§æ‰¿å…³ç³»ä¼šæŠ¥é”™</li>
</ul>
<pre><code class="language-java">Plate&lt;Fruit&gt; plate = new Plate&lt;Apple&gt;(apple);
</code></pre>
<ol start="2">
<li>ä¸Šä¸‹ç•Œé€šé…ç¬¦</li>
</ol>
<ul>
<li>Apple -&gt; Fruit -&gt; Food</li>
<li><code>&lt;? extends T&gt;</code> å¯ä»¥æ˜¯ä»»ä½• T çš„å­ç±»</li>
</ul>
<pre><code class="language-java">Plate&lt;? extends Food&gt; plate = new Plate&lt;Fruit&gt;(apple);
</code></pre>
<ul>
<li><code>&lt;? super T&gt;</code> å¯ä»¥æ˜¯ä»»ä½• T çš„çˆ¶ç±»</li>
</ul>
<pre><code class="language-java">Plate&lt;? super Apple&gt; plate = new Plate&lt;Food&gt;(fruit);
</code></pre>
<ol start="3">
<li>ä¸Šä¸‹ç•Œé€šé…ç¬¦çš„å‰¯ä½œç”¨</li>
</ol>
<ul>
<li>ä¸Šç•Œ<code>&lt;? extends T&gt;</code>ä¸èƒ½å¾€é‡Œå­˜ï¼Œåªèƒ½å¾€å¤–å–</li>
</ul>
<pre><code class="language-java">Plate&lt;? extends Food&gt; plate = new Plate&lt;Fruit&gt;(apple);
Food a = plate.getItem();
// plate.setItem(food);  å¤±æ•ˆ
</code></pre>
<ul>
<li>ä¸‹ç•Œ&lt;? super T&gt;ä¸å½±å“å¾€é‡Œå­˜ï¼Œä½†å¾€å¤–å–åªèƒ½æ”¾åœ¨ Object å¯¹è±¡é‡Œ</li>
</ul>
<pre><code class="language-java">Plate&lt;? super Apple&gt; plate = new Plate&lt;Food&gt;(fruit);
plate2.setItem(apple);
// Apple b = plate2.getItem(); å¤±æ•ˆ
// å…ƒç´ çš„ç±»å‹ä¿¡æ¯å…¨éƒ¨ä¸¢å¤±ã€‚
</code></pre>
<p>::: tip è¡¥å……</p>
<ul>
<li>?ä¸ T çš„åŒºåˆ«</li>
<li>å¯¹ç¼–è¯‘å™¨æ¥è¯´æ‰€æœ‰çš„ T éƒ½ä»£è¡¨åŒä¸€ç§ç±»å‹ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªæ³›å‹æ–¹æ³•é‡Œï¼Œä¸‰ä¸ª T éƒ½æŒ‡ä»£åŒä¸€ä¸ªç±»å‹ï¼Œè¦ä¹ˆéƒ½æ˜¯ Stringï¼Œè¦ä¹ˆéƒ½æ˜¯ Integerã€‚</li>
<li>ä½†é€šé…ç¬¦<code>&lt;?&gt;æ²¡æœ‰è¿™ç§çº¦æŸï¼ŒPlate&lt;?&gt;</code>å•çº¯çš„å°±è¡¨ç¤ºï¼šç›˜å­é‡Œæ”¾äº†ä¸€ä¸ªä¸œè¥¿ï¼Œæ˜¯ä»€ä¹ˆæˆ‘ä¸çŸ¥é“ã€‚æ‰€ä»¥é¢˜ä¸»é—®é¢˜é‡Œçš„é”™è¯¯å°±åœ¨è¿™é‡Œï¼ŒPlate&lt;ï¼Ÿ
extends Fruit&gt;é‡Œä»€ä¹ˆéƒ½æ”¾ä¸è¿›å»ã€‚ :::</li>
</ul>
<h2 id="æ³¨è§£"><a class="header" href="#æ³¨è§£">æ³¨è§£</a></h2>
<ol>
<li>æ³¨è§£ä¼šå½±å“ç¨‹åºçš„ç¼–è¯‘å’Œè¿è¡Œ</li>
<li>æ³¨è§£æœ¬èº«åªæ˜¯ä¸€ä¸ªæ ‡æ³¨ï¼Œæœ¬èº«ä¸ç”¨åŒ…å«é€»è¾‘å¤„ç†å†…å®¹</li>
</ol>
<h3 id="ä½œç”¨èŒƒå›´"><a class="header" href="#ä½œç”¨èŒƒå›´">ä½œç”¨èŒƒå›´</a></h3>
<ul>
<li>RUNTIMEï¼šç¨‹åºè¿è¡Œæ—¶èµ·ä½œç”¨ï¼Œä¾‹å¦‚ï¼š<code>@WebServlet</code></li>
<li>SOURCEï¼šç¼–è¯‘æ—¶æœŸä½œç”¨ï¼Œä¾‹å¦‚ <code>@Override</code></li>
</ul>
<h3 id="target"><a class="header" href="#target">@Target</a></h3>
<p>æŒ‡å®šæ³¨è§£é’ˆå¯¹çš„ç›®æ ‡</p>
<ul>
<li>ElementType.Type ç±»ã€æ–¹æ³•</li>
<li>ElementType.Field æˆå‘˜å˜é‡</li>
<li>ElementType.METHOD æˆå‘˜æ–¹æ³•</li>
<li>ElementType.PARAMETER æ–¹æ³•å‚æ•°</li>
<li>ElementType.CONSTRUCTOR æ„é€ å™¨</li>
<li>ElementType.PACKAGE åŒ…</li>
<li>ElementType.ANNOTATION_TYPE æ³¨è§£</li>
</ul>
<h3 id="retention"><a class="header" href="#retention">@Retention</a></h3>
<p>æŒ‡å®šæ³¨è§£çš„ä¿ç•™åŸŸ</p>
<ul>
<li>RetentionPolicy.SOURCE æºä»£ç çº§åˆ«ï¼Œç”±ç¼–è¯‘å™¨å¤„ç†ï¼Œå¤„ç†åä¸å†ä¿ç•™</li>
<li>RetentionPolicy.CLASS æ³¨è§£ä¿¡æ¯ä¿ç•™åˆ° class æ–‡ä»¶ä¸­</li>
<li>RetentionPolicy.RUNTION ç”± jvm è¯»å–ï¼Œè¿è¡Œæ—¶ä½¿ç”¨</li>
</ul>
<h3 id="ç¤ºä¾‹"><a class="header" href="#ç¤ºä¾‹">ç¤ºä¾‹</a></h3>
<ol>
<li>æ³¨è§£ç±»</li>
</ol>
<pre><code class="language-java">@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface InitAnno {

}
</code></pre>
<ol start="2">
<li>è¢«æ³¨è§£ç±»</li>
</ol>
<pre><code class="language-java">public class Foo {
    @InitAnno
    public void bar() {
        System.out.println(&quot;è¿›å…¥äº† bar æ–¹æ³•&quot;);
    }
}
</code></pre>
<ol start="3">
<li>Main</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    Class&lt;?&gt; clazz = Class.forName(&quot;Foo&quot;);
    Annotation annotation = clazz.getAnnotation(InitAnno.class);
    if (annotation == null) {
        System.out.println(&quot;ç±»å‰æ²¡æœ‰ InitAnno æ³¨è§£&quot;);
    }
    Method[] methods = clazz.getMethods();
    for (Method method : methods) {
        boolean isInitAnno = method.isAnnotationPresent(InitAnno.class);
        if (isInitAnno) {
            method.invoke(clazz.getConstructor(null).newInstance(null), null);
        }
    }
}
</code></pre>
<h2 id="å¤šçº¿ç¨‹"><a class="header" href="#å¤šçº¿ç¨‹">å¤šçº¿ç¨‹</a></h2>
<h3 id="å®ç°"><a class="header" href="#å®ç°">å®ç°</a></h3>
<ol>
<li>ç»§æ‰¿ Thread ç±»</li>
</ol>
<pre><code class="language-java">MyThread thread = new MyThread();
thread.start();
</code></pre>
<ol start="2">
<li>å®ç° Runnable æ¥å£</li>
</ol>
<pre><code class="language-java">MyRunnable runnable = new MyRunnable();
Thread thread = new Thread(runnable);

Thread thread = new Thread(new MyRunnable() {
    @Override
    public void run() {
        for(int i = 0;i&lt;100;i++) {
            System.out.println(&quot;MyRunnable1&quot;);
        }
    }
});
thread.start();
</code></pre>
<p>::: tip æç¤º Runnable ç›¸æ¯” Thread è€¦åˆä½ï¼Œlambda è¡¨è¾¾å¼æ›´ä½ ::: 3. å®ç° Callable æ¥å£</p>
<pre><code class="language-java">Callable&lt;String&gt; callable = () -&gt; {
    System.out.println(&quot;è¿›å»äº†&quot;);
    return &quot;Hello&quot;;
};
FutureTask&lt;String&gt; featureTask = new FutureTask&lt;&gt;(callable);
Thread thread = new Thread(featureTask);
System.out.println(featureTask.get());
</code></pre>
<blockquote>
<p>æ³¨æ„ï¼Callable ä¸ Thread æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œéœ€è¦é—´æ¥å®ç°</p>
</blockquote>
<pre><code class="language-java">public interface RunnableFuture&lt;V&gt; extends Runnable, Future&lt;V&gt; {
    /**
     * Sets this Future to the result of its computation
     * unless it has been cancelled.
     */
    void run();
}

public class FutureTask&lt;V&gt; implements RunnableFuture&lt;V&gt; {
    private Callable&lt;V&gt; callable;
}
</code></pre>
<pre><code class="language-mermaid">graph LR
A[Callable] --&gt;B(FutureTask) --&gt; C(RunnableFuture) --&gt; D(Runnable) --&gt; E(Thread)
</code></pre>
<h3 id="å¸¸ç”¨æ–¹æ³•"><a class="header" href="#å¸¸ç”¨æ–¹æ³•">å¸¸ç”¨æ–¹æ³•</a></h3>
<pre><code class="language-java">1. ä¼‘çœ 
thread.sleep(3000);
2. åˆå¹¶
thread.join(3000);
3. ç¤¼è®©
yield();
</code></pre>
<h3 id="çº¿ç¨‹åŒæ­¥"><a class="header" href="#çº¿ç¨‹åŒæ­¥">çº¿ç¨‹åŒæ­¥</a></h3>
<p>æ¯ä¸ª java å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…ç½®é”ï¼Œå†…ç½®é”ä¼šä¿æŠ¤ä½¿ç”¨ synchronized å…³é”®å­—ä¿®é¥°çš„æ–¹æ³• è¦è°ƒç”¨è¯¥æ–¹æ³•å¿…é¡»å…ˆè·å–é”ï¼Œå¦åˆ™å°±å¤„äºå µå¡çŠ¶æ€</p>
<ul>
<li>é™æ€å˜é‡</li>
</ul>
<pre><code class="language-java">public class SameRunnable implements Runnable {
    private static int num = 0;
    @Override
    public synchronized void run() {
        ++num;
        Thread.sleep(10);
        System.out.println(&quot;ç¬¬&quot; + Thread.currentThread().getName() + &quot;ä½è®¿å®¢æ˜¯ç¬¬&quot; + num + &quot;ä¸ª&quot;);
    }
}
</code></pre>
<ul>
<li>é™æ€ä»£ç å—ï¼Œé”å®šç±» synchronized å…³é”®å­—ä¹Ÿèƒ½ä¿®é¥°ä»£ç å—ï¼Œä»¥ä¸‹ä¾‹å­ä¹Ÿèƒ½æœ‰ç›¸åŒçš„æ•ˆæœ</li>
</ul>
<pre><code class="language-java">public class Test {
    public static void main(String[] args) {
        for (int i = 0; i &lt; 5; i++) {
            Thread thread = new Thread(new Runnable() {
                public void run() {
                    Test test = new Test();
                    test.print();
                }
            }).start();
        }
    }
    public synchronized void print() {
        synchronized (Test.class) {    // é”å®šç±» (éé™æ€å¯ this), ä¸èƒ½æ˜¯ç±»çš„å®ä¾‹
            System.out.println(&quot;å¼€å§‹&quot;);
            Thread.currentThread().sleep(1000);
            System.out.println(&quot;ç»“æŸ&quot;);
        }
    }
}
</code></pre>
<ul>
<li>é”å®šå®ä¾‹æ–¹æ³• ::: danger æ³¨æ„ synchronized å…³é”®å­—åªæ˜¯ä¿®é¥°å…±äº«çš„èµ„æºï¼Œä¸‹é¢çš„ä¾‹å­ä¸èƒ½å¾—åˆ°æƒ³è¦çš„æ•ˆæœ :::</li>
</ul>
<pre><code class="language-java">public synchronized void print() {
    System.out.println(&quot;å¼€å§‹&quot;);
    Thread.currentThread().sleep(1000);
    System.out.println(&quot;ç»“æŸ&quot;);
}
</code></pre>
<h3 id="çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼"><a class="header" href="#çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼">çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼</a></h3>
<ul>
<li>é”å®šç±»</li>
</ul>
<pre><code class="language-java">public volatile class Runner {
    private static Runner runner;
    // è®°å¾—åŠ å…³é”®å­—ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹è®¿é—®æ—¶è¿˜æ²¡åˆ›å»ºè¿‡å¯¹è±¡
    // 1. ğŸ”’æ•´ä¸ªæ–¹æ³•
    public synchronized static Runner getRunner() {
        if (runner == null) {
            runner = new Runner();
        }
        return runner;
    }
    // åªé”ä»£ç å—ï¼Œä¸å½±å“è¯¥æ–¹æ³•å†…çš„å…¶ä»–ä¸šåŠ¡
    public static Runner getRunner() {
        synchronized(Runner.class) {
            if (runner == null) {
                runner = new Runner();
            }
        }
        return runner;
    }

}
</code></pre>
<p>::: tip å…¶ä»–é”å®šå¯¹è±¡</p>
<ol>
<li>synchronized(runner): n ä¸ªç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä¸èƒ½é”ç©ºå¯¹è±¡</li>
<li>Integer i = Integer.parseInt(&quot;1&quot;); synchronized(i): ä¹Ÿå¯ä»¥</li>
<li>Integer a = Integer.parseInt(&quot;1&quot;); Integer b = Integer.parseInt(&quot;1&quot;);
synchronized(i) å¼€å¯ä¸¤ä¸ªçº¿ç¨‹ï¼Œè‹¥ a,b å€¼ (è¯¦æƒ…è§ Integer åŒ…è£…ç±») ç›¸åŒï¼Œåˆ™çº¿ç¨‹å®‰å…¨ï¼Œå¦åˆ™ä¸å®‰å…¨ :::</li>
</ol>
<h3 id="voletile-å…³é”®å­—"><a class="header" href="#voletile-å…³é”®å­—">voletile å…³é”®å­—</a></h3>
<ol>
<li>å¼•ä¾‹</li>
</ol>
<pre><code class="language-java">public class exam {

    public static void main(String[] args) {
        int num = 0;
        int finalNum = num;
        new Thread(() -&gt; {
            while (finalNum == 0) {
            }
        }).start();
        TimeUnit.SECONDS.sleep(1);
        num = 1;
        System.out.println(num);
    }
}
</code></pre>
<ul>
<li>åœ¨è¯¥ä¾‹å­ä¸­ï¼Œå¾ªç¯ä¸ä¼šåœæ­¢ new Thread ä¸ main åŒæ—¶æ“ä½œ numï¼Œä»–ä»¬åˆ†åˆ«ä»ä¸»å†…å­˜å¤åˆ¶åˆ°å·¥ä½œå†…å­˜ï¼Œå¯¹å„è‡ªçš„å·¥ä½œå†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œ
main çº¿ç¨‹å¯¹ num+1ï¼ŒåŒæ­¥åˆ°ä¸»çº¿ç¨‹ï¼Œä½† new Thread çš„ä»»åŠ¡æœªåœæ­¢ï¼Œæ²¡æœ‰ä¸ä¸»å†…å­˜åŒæ­¥ï¼Œå¾ªç¯ä¸ä¼šç»ˆæ­¢</li>
<li>è‹¥å¾ªç¯ä¸­åŠ ä¸€ä¸ªæ‰§è¡Œè¯­å¥ï¼Œå¾ªç¯ä¼šç»ˆæ­¢ï¼Œå·¥ä½œå†…å­˜ä¼šå³ä½¿ä¸ä¸»å†…å­˜è¿›è¡ŒåŒæ­¥</li>
</ul>
<p>å½“å„ä¸ªçº¿ç¨‹æ“ä½œæ—¶ï¼Œæ•°æ®æ²¡æœ‰è¿›è¡ŒåŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œäº§ç”Ÿé”™è¯¯ voletile å…³é”®å­—ä½¿å¤šä¸ªçº¿ç¨‹ç›´æ¥æ“ä½œä¸»å†…å­˜ï¼Œä¸åœ¨ç»è¿‡å·¥ä½œå†…å­˜</p>
<h3 id="å¾…ç»­-1"><a class="header" href="#å¾…ç»­-1">å¾…ç»­...</a></h3>
<h2 id="juc"><a class="header" href="#juc">JUC</a></h2>
<h3 id="ç‰¹å¾"><a class="header" href="#ç‰¹å¾">ç‰¹å¾</a></h3>
<p>synchronized ä¸ Lock å¯¹æ¯”</p>
<ol>
<li>synchronized è‡ªåŠ¨ä¸Šé”è§£é”ï¼ŒLock æ‰‹åŠ¨ä¸Šé”è§£é”</li>
<li>synchronized æ— æ³•åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼ŒLock å¯ä»¥</li>
<li>synchronized æ‹¿ä¸åˆ°é”ä¼šä¸€ç›´ç­‰å¾…ï¼ŒLock ä¸ä¼š</li>
<li>synchronized æ˜¯å…³é”®å­—ï¼Œjvm å®ç°ï¼ŒLock æ˜¯æ¥å£ï¼Œjdk å®ç°</li>
<li>synchronized æ˜¯éå…¬å¹³é”ï¼ŒLock è‡ªç”±è®¾ç½®</li>
</ol>
<blockquote>
<p>å…¬å¹³é”ï¼šå¤šä¸ªçº¿ç¨‹æ’é˜ŸåŠ é”<code>&lt;br/&gt;</code> éå…¬å¹³é”ï¼šä¸åˆ¤æ–­æ˜¯å¦æœ‰å…¶ä»–ç­‰å¾…çº¿ç¨‹ï¼Œç›´æ¥å ç”¨</p>
</blockquote>
<h3 id="åŸºæœ¬æ“ä½œ"><a class="header" href="#åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ</a></h3>
<pre><code class="language-java">private Lock lock = new ReentrantLock();
lock.lock();
    ...
lock.unlock();
</code></pre>
<h3 id="æ­»é”"><a class="header" href="#æ­»é”">æ­»é”</a></h3>
<pre><code class="language-java">/*
* num = 1 çš„äººæ‹¿åˆ° chopsticks1ï¼Œç­‰å¾… chopsticks2
* num = 2 çš„äººæ‹¿åˆ° chopsticks2ï¼Œç­‰å¾… chopsticks1
* */
@Override
public void run() {
    if (num == 1) {
        synchronized (chopsticks1) {
            Thread.sleep(100);
            synchronized (chopsticks2) {
                System.out.println(&quot;1 åƒå®Œäº†&quot;);
            }
        }
    }
    if (num == 2) {
        synchronized (chopsticks2) {
            synchronized (chopsticks1) {
                System.out.println(&quot;2 åƒå®Œäº†&quot;);
            }
        }
    }
}
</code></pre>
<h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…"><a class="header" href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…">ç”Ÿäº§è€…æ¶ˆè´¹è€…</a></h3>
<pre><code class="language-java">// 1. synchronize
class Container {
    private int num = 5;
    public synchronized void add() {
        while (num != 0) {
            this.wait();
        }
        num += 1;
        TimeUnit.SECONDS.sleep(1);
        System.out.println(Thread.currentThread().getName() + &quot;ç”Ÿäº§äº† 1 ä¸ªï¼Œè¿˜æœ‰&quot; + num + &quot;ä¸ª&quot;);
        this.notify();
    }
    public synchronized void pop(int i) {
        while (num == 0) {
            this.wait();
        }
        num -= 1;
        System.out.println(i + &quot;è´­ä¹°äº† 1 ä¸ªï¼Œè¿˜æœ‰&quot; + num + &quot;ä¸ª&quot;);
        this.notify();
    }
}
// 2. Lock è¦ä»¥ condition.await å’Œ condition.singal ä»£æ›¿ wait å’Œ notify
class Container2 {
    private int num = 5;
    ReentrantLock lock = new ReentrantLock();
    private Condition condition = lock.newCondition();
    public void add() {
        lock.lock();
        while (num != 0) {
            condition.await();
        }
        num += 1;
        TimeUnit.SECONDS.sleep(1);
        System.out.println(Thread.currentThread().getName() + &quot;ç”Ÿäº§äº† 1 ä¸ªï¼Œè¿˜æœ‰&quot; + num + &quot;ä¸ª&quot;);
        condition.signal();
        lock.unlock();
    }
}
</code></pre>
<h3 id="trylock"><a class="header" href="#trylock">tryLock</a></h3>
<pre><code class="language-java">class TimeLock {
    private final ReentrantLock lock = new ReentrantLock();
    public void tryLock() {
        try {
            if (lock.tryLock(3, TimeUnit.SECONDS)) {
                System.out.println(&quot;3 ç§’å†…æ‹¿åˆ°äº†é”&quot;);
                TimeUnit.SECONDS.sleep(5);
            } else {
                System.out.println(&quot;3 ç§’å†…æ²¡æ‹¿åˆ°é”&quot;);
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();  // åªèƒ½ç”±ä¸Šé”è€…å»è§£é”
            }
        }
    }
}
</code></pre>
<h3 id="åŒæ—¶è¯»å†™"><a class="header" href="#åŒæ—¶è¯»å†™">åŒæ—¶è¯»å†™</a></h3>
<ol>
<li>å¯¹ ArrayList è¯»å†™æ“ä½œåŒæ—¶å­˜åœ¨ä¼šæŠ›å‡ºå¼‚å¸¸</li>
</ol>
<pre><code class="language-java">public class ReadAndWrite {
    public static void main(String[] args) {
        List&lt;String&gt; list = new ArrayList&lt;&gt;();
        //List&lt;String&gt; list = new Vector&lt;&gt;();
        // List&lt;String&gt; list = Collections.synchronizedList(new ArrayList&lt;&gt;());
        // List&lt;String&gt; list = new CopyOnWriteArrayList();
        for (int i = 0; i &lt; 10; i++) {
            new Thread(() -&gt; {
                try {
                    TimeUnit.MILLISECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                list.add(&quot;a&quot;);
                System.out.println(Thread.currentThread().getName() + list);
            }, String.valueOf(i)).start();
        }
    }
}
</code></pre>
<ol start="2">
<li>åŸå›  ArrayList ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
</ol>
<pre><code class="language-java">public boolean add(E e) {
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    elementData[size++] = e;
    return true;
}
</code></pre>
<ol start="3">
<li>è§£å†³æ–¹æ³•</li>
</ol>
<ul>
<li>æ›´æ¢ä¸º Vector</li>
</ul>
<pre><code class="language-java">public synchronized boolean add(E e) {
    modCount++;
    ensureCapacityHelper(elementCount + 1);
    elementData[elementCount++] = e;
    return true;
}
</code></pre>
<ul>
<li>
<p>æ›´æ¢ä¸º Collections.synchronizedList()</p>
</li>
<li>
<p>JUC: CopyOnWriteList</p>
</li>
</ul>
<blockquote>
<p>CopyOnWrite å®ç°äº†è¯»å†™åˆ†ç¦»ï¼Œå½“æˆ‘ä»¬å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸æ˜¯ç›´æ¥ç»™å®¹å™¨æ·»åŠ ï¼Œè€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨å¤åˆ¶ä¸€
ä»½ï¼Œå‘æ–°çš„å®¹å™¨ä¸­æ·»åŠ æ•°æ®ï¼Œæ·»åŠ å®Œæˆä¹‹åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨ã€‚</p>
</blockquote>
<pre><code class="language-java">public boolean add(E e) {
    final ReentrantLock lock = this.lock;
    lock.lock();
    try {
        Object[] elements = getArray();
        int len = elements.length;
        Object[] newElements = Arrays.copyOf(elements, len + 1);
        newElements[len] = e;
        setArray(newElements);
        return true;
    } finally {
        lock.unlock();
    }
}
</code></pre>
<h3 id="è®¡æ•°å™¨"><a class="header" href="#è®¡æ•°å™¨">è®¡æ•°å™¨</a></h3>
<ul>
<li>å‡æ³•è®¡æ•°å™¨ countDownLatch å¯ä»¥ç¡®ä¿æŸä¸ªçº¿ç¨‹ä¼˜å…ˆæ‰§è¡Œï¼Œå½“è®¡æ•°å™¨æ¸…é›¶åœ¨å”¤é†’å…¶ä»–çº¿ç¨‹</li>
</ul>
<pre><code class="language-java">public class CountDown {
    public static void main(String[] args) {
        CountDownLatch countDownLatch = new CountDownLatch(80);
        new Thread(() -&gt; {
            for (int i = 0; i &lt; 100; i++) {
                countDownLatch.countDown();
                System.out.println(i);
            }
        }).start();

        countDownLatch.await();   // å¿…é¡»å”¤é†’ï¼Œä¸”è®¡æ•°å™¨è¦æ¸…é›¶

        for (int i = 0; i &lt; 10; i++) {
            System.out.println(&quot;main&quot;);
        }
    }
}
</code></pre>
<p>::: warning æ³¨æ„ new CountDownLatch(80), countDownLatch.countDown(),
countDownLatch.await() å¿…é¡»é…åˆä½¿ç”¨ï¼Œåªè¦è®¡æ•°å™¨æ²¡æœ‰æ¸…é›¶ï¼Œè®¡æ•°å™¨ä¸ä¼šåœæ­¢ï¼Œå…¶ä»–çº¿ç¨‹ä¹Ÿä¸èƒ½å”¤é†’ :::</p>
<ul>
<li>åŠ æ³•è®¡æ•°å™¨ è¯•å›¾å”¤é†’å½“å‰çº¿ç¨‹ï¼Œå½“åŠ åˆ°ä¸€å®šæ•°é‡æˆåŠŸå”¤é†’ï¼Œä¹‹åæ¸…é›¶ï¼Œå†æ¬¡ç´¯åŠ å¾ªç¯</li>
</ul>
<pre><code class="language-java">// æ„é€ å™¨
public CyclicBarrier(int parties, Runnable barrierAction) {
    if (parties &lt;= 0) throw new IllegalArgumentException();
    this.parties = parties;
    this.count = parties;
    this.barrierCommand = barrierAction;
}

// Test
public class CyclicBarrier_ {
    public static void main(String[] args) {
        CyclicBarrier cyclicBarrier = new CyclicBarrier(5, () -&gt; {
            System.out.println(&quot;æ”¾è¡Œ&quot;);
        });
        for (int i = 0; i &lt; 10; i++) {
            final int temp = i;
            new Thread(() -&gt; {
                cyclicBarrier.await();
            }).start();
        }
    }
}
</code></pre>
<ul>
<li>è®¡æ•°çº¿ç¨‹é™æµ é™åˆ¶åŒæ—¶è¿›å…¥çš„çº¿ç¨‹æ•°</li>
</ul>
<ol>
<li>åˆå§‹åŒ–</li>
<li>è·å¾—è®¸å¯</li>
<li>é‡Šæ”¾</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    Semaphore semaphore = new Semaphore(5);   // é™åˆ¶æœ€å¤š 5 äºº
    for (int i = 0; i &lt; 15; i++) {
        new Thread(() -&gt; {
            try {
                semaphore.acquire();
                System.out.println(Thread.currentThread().getName() + &quot;è¿›å»äº†&quot;);
                TimeUnit.SECONDS.sleep(2);
                System.out.println(Thread.currentThread().getName() + &quot;å‡ºå»äº†&quot;);
            } catch (InterruptedException e) {
                e.printStackTrace();
            } finally {
                semaphore.release();
            }
        }).start();
    }
}
</code></pre>
<h3 id="è¯»å†™é”"><a class="header" href="#è¯»å†™é”">è¯»å†™é”</a></h3>
<p>è¯»å†™é”ä¹Ÿæ˜¯ä¸ºäº†å®ç°çº¿ç¨‹åŒæ­¥ï¼Œåªä¸è¿‡ç²’åº¦æ›´ç»†ï¼Œå¯ä»¥ä¸ºè¯»å’Œå†™è®¾ç½®ä¸åŒçš„é”</p>
<pre><code class="language-java">class Cache {
    private Map&lt;Integer, String&gt; map = new HashMap&lt;&gt;();
    private ReadWriteLock readWriteLock = new ReentrantReadWriteLock();

    public void write(Integer id, String value) {
        readWriteLock.writeLock().lock();
        System.out.println(&quot;å¼€å§‹å†™å…¥ ID: &quot; + id);
        map.put(id, value);
        System.out.println(&quot;å†™å…¥å®Œæˆ ID: &quot; + id);
        readWriteLock.writeLock().unlock();
    }

    public String read(Integer id) {
        readWriteLock.readLock().lock();
        System.out.println(&quot;å¼€å§‹è¯»å– ID: &quot; + id);
        String a = map.get(id);
        System.out.println(&quot;è¯»å–å®Œæˆ ID: &quot; + id);
        readWriteLock.readLock().unlock();
        return a;
    }
}
</code></pre>
<p>::: tip è¡¥å…… å†™å…¥é”ä¹Ÿå«ç‹¬å é”ï¼Œåªèƒ½è¢« 1 ä¸ªçº¿ç¨‹å ç”¨ï¼Œè¯»å–é”ä¹Ÿå«å…±äº«é”ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å ç”¨ã€‚ :::</p>
<h3 id="çº¿ç¨‹æ± "><a class="header" href="#çº¿ç¨‹æ± ">çº¿ç¨‹æ± </a></h3>
<ol>
<li>åŸºæœ¬ä½¿ç”¨</li>
</ol>
<p>é¢„å…ˆåˆ›å»ºå¥½ä¸€å®šæ•°é‡çš„çº¿ç¨‹å¯¹è±¡ï¼Œå­˜å…¥ç¼“å†²æ± ä¸­ï¼Œéœ€è¦ç”¨çš„æ—¶å€™ç›´æ¥ä»ç¼“å†²æ± ä¸­å–å‡ºï¼Œç”¨å®Œä¹‹åä¸è¦é”€æ¯ï¼Œè¿˜å›åˆ°ç¼“å†²æ± ä¸­ï¼Œä¸ºäº†æé«˜èµ„æºçš„åˆ©ç”¨ç‡ã€‚ä¼˜åŠ¿ï¼š</p>
<ul>
<li>æé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡</li>
<li>æé«˜å“åº”é€Ÿåº¦</li>
<li>ä¾¿äºç»Ÿä¸€ç®¡ç†çº¿ç¨‹å¯¹è±¡</li>
<li>å¯ä»¥æ§åˆ¶æœ€å¤§çš„å¹¶å‘æ•°</li>
</ul>
<pre><code class="language-java">public class ThreadPool_ {
    public static void main(String[] args) {
        // å•ä¾‹
        //ExecutorService executorService = Executors.newSingleThreadExecutor();
        // æŒ‡å®šçº¿ç¨‹æ•°é‡
        //ExecutorService executorService = Executors.newFixedThreadPool(5);
        // ç¼“å†²çº¿ç¨‹æ± 
        ExecutorService executorService = Executors.newCachedThreadPool();
        for (int i = 0; i &lt; 60; i++) {
            final int temp = i;
            executorService.execute(() -&gt; {
                System.out.println(Thread.currentThread().getName() + &quot; &quot; + temp);
            });
        }
        executorService.shutdown();
    }
}
</code></pre>
<!-- 2. çº¿ç¨‹æ± åˆ†æ -->
<ol start="2">
<li>æ„é€ å‡½æ•°</li>
</ol>
<p>ä¸‰ä¸ªå¸¸ç”¨çº¿ç¨‹æ± éƒ½ return new ThreadPoolExecutor(); ThreadPoolExecutor çš„æ„é€ å‡½æ•°å¦‚ä¸‹</p>
<pre><code class="language-java">public ThreadPoolExecutor(  int corePoolSize,
                            int maximumPoolSize,
                            long keepAliveTime,
                            TimeUnit unit,
                            BlockingQueue&lt;Runnable&gt; workQueue,
                            ThreadFactory threadFactory,
                            RejectedExecutionHandler handler) {
</code></pre>
<ul>
<li>corePoolSize: æ ¸å¿ƒæ± æ•°é‡</li>
<li>maximumPoolSize: çº¿ç¨‹æ± å®¹é‡ä¸Šé™ï¼Œä»»åŠ¡é‡å¢å¤§æ—¶ï¼Œçº¿ç¨‹æ± ä¸»åŠ¨æ‰©å®¹</li>
<li>keepAliveTime: çº¿ç¨‹å¯¹è±¡å­˜æ´»æ—¶é—´</li>
<li>unit: çº¿ç¨‹å¯¹è±¡å­˜æ´»æ—¶é—´å•ä½</li>
<li>workQueue: çº¿ç¨‹é˜Ÿåˆ— (æ–°çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç­‰å€™è·å–çº¿ç¨‹å¯¹è±¡)</li>
<li>threadFactory: çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹å¯¹è±¡</li>
<li>handler: æ‹’ç»ç­–ç•¥</li>
</ul>
<ol start="3">
<li>æ‹’ç»ç­–ç•¥</li>
</ol>
<p>RejectedExecutionHandler æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå‡åœ¨ ThreadPoolExecutor ä¸­å®ç°</p>
<ul>
<li>AbortPolicyz:ç›´æ¥æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<pre><code class="language-java">/**
    * A handler for rejected tasks that throws a
    * {@code RejectedExecutionException}.
    */
public static class AbortPolicy implements RejectedExecutionHandler {
</code></pre>
<ul>
<li>DiscardPolicy: ç›´æ¥æ‹’ç»</li>
</ul>
<pre><code class="language-java">/**
    * A handler for rejected tasks that silently discards the
    * rejected task.
    */
public static class DiscardPolicy implements RejectedExecutionHandler {
</code></pre>
<ul>
<li>DiscardOldestPolicy: å°è¯•ä¸ç­‰å¾…é˜Ÿåˆ—ä¸­æœ€å¼€å§‹çš„ä»»åŠ¡äº‰å¤ºï¼Œä¸æŠ›å‡ºå¼‚å¸¸</li>
</ul>
<pre><code class="language-java">/**
     * A handler for rejected tasks that discards the oldest unhandled
     * request and then retries {@code execute}, unless the executor
     * is shut down, in which case the task is discarded.
     */
    public static class DiscardOldestPolicy implements RejectedExecutionHandler {
</code></pre>
<ul>
<li>CallerRunsPolicy ç”±å‘èµ·è¯·æ±‚çº¿ç¨‹å¤„ç†</li>
</ul>
<pre><code class="language-java">/**
    * A handler for rejected tasks that runs the rejected task
    * directly in the calling thread of the {@code execute} method,
    * unless the executor has been shut down, in which case the task
    * is discarded.
    */
public static class CallerRunsPolicy implements RejectedExecutionHandler {
</code></pre>
<ol start="4">
<li>è‡ªå®šä¹‰çº¿ç¨‹æ± </li>
</ol>
<pre><code class="language-java">executorService = new ThreadPoolExecutor(
        4,
        10,
        2L,
        TimeUnit.SECONDS,
        new ArrayBlockingQueue&lt;&gt;(20),
        Executors.defaultThreadFactory(),
        new ThreadPoolExecutor.AbortPolicy());
</code></pre>
<p>4 ç§ workQueue å µå¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡</p>
<ul>
<li>ArrayBlockingQueue: åŸºäºæ•°ç»„çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œåˆ›å»ºæ—¶å¿…é¡»æŒ‡å®šå¤§å°ã€‚</li>
<li>LinkedBlockingQueue: åŸºäºé“¾è¡¨çš„å…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—ï¼Œåˆ›å»ºæ—¶å¯ä»¥ä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤å€¼æ˜¯ Integer.MAX VALUEã€‚æœ€å¤§å€¼ã€‚</li>
<li>SynchronousQueue: å®ƒä¸ä¼šä¿æŒæäº¤çš„ä»»åŠ¡ï¼Œè€Œæ˜¯ç›´æ¥æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œæ–°æ¥çš„ä»»åŠ¡ã€‚</li>
<li>PriorityBlockingQueue: å…·æœ‰ä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—ã€‚</li>
</ul>
<h3 id="forkjoin"><a class="header" href="#forkjoin">Forkjoin</a></h3>
<ol>
<li>æ¦‚å¿µ</li>
</ol>
<ul>
<li>Forkjoin æ˜¯ JDK 1.7 åå‘å¸ƒçš„å¤šçº¿ç¨‹å¹¶å‘å¤„ç†æ¡†æ¶ï¼ŒåŠŸèƒ½ä¸Šå’Œ JUC ç±»ä¼¼ï¼Œ
JUC æ›´å¤šæ—¶å€™æ˜¯ä½¿ç”¨å•ä¸ªç±»å®Œæˆæ“ä½œï¼ŒForkjoin ä½¿ç”¨å¤šä¸ªç±»åŒæ—¶å®ŒæˆæŸé¡¹å·¥ä½œï¼Œå¤„ç†ä¸Šæ¯” JUC æ›´åŠ ä¸°å¯Œï¼Œ</li>
<li>æœ¬è´¨ä¸Šæ˜¯å¯¹çº¿ç¨‹æ± çš„ä¸€ç§çš„è¡¥å……ï¼Œå¯¹çº¿ç¨‹æ± åŠŸèƒ½çš„ä¸€ç§æ‰©å±•ï¼ŒåŸºäºçº¿ç¨‹æ± ï¼Œ</li>
<li>å®ƒçš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯å°†ä¸€ä¸ªå¤§å‹çš„ä»»åŠ¡æ‹†åˆ†æˆå¾ˆå¤šä¸ªå°ä»»åŠ¡ï¼Œç„¶åç”±å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œæœ€ç»ˆå°†å°ä»»åŠ¡çš„ç»“æœè¿›è¡Œæ±‡æ€»ï¼Œç”Ÿæˆæœ€ç»ˆçš„ç»“æœã€‚</li>
</ul>
<ol start="2">
<li>åŸºæœ¬ä½¿ç”¨ è®¾ç½®ä¸´ç•Œå€¼ï¼Œé€’å½’åˆ†é…ä»»åŠ¡ï¼ŒçŸ¥é“ä»»åŠ¡ä¸èƒ½è¢«å†åˆ†</li>
</ol>
<pre><code class="language-java">public class FolkJoin_ extends RecursiveTask&lt;Long&gt; {

    private Long start;
    private Long end;
    private Long temp = 200_0000L;

    public FolkJoin_(Long start, Long end) {
        this.start = start;
        this.end = end;
    }

    @Override
    protected Long compute() {
        if ((end - start) &lt; temp) {
            Long sum = 0L;
            for (Long i = start; i &lt; end ; i++) {
                sum += i;
            }
            return sum;
        } else {
            Long avg = (start + end) / 2;
            FolkJoin_ tast1 = new FolkJoin_(start, avg);
            FolkJoin_ tast2 = new FolkJoin_(avg, end);
            tast1.fork();
            tast2.fork();
            return tast1.join()+tast2.join();
        }
    }
}
</code></pre>
<p>Main.java</p>
<pre><code class="language-java">Long start = System.currentTimeMillis();
ForkJoinPool folkJoinPool = new ForkJoinPool();
FolkJoin_ task = new FolkJoin_(0L, 10_0000_0000L);
folkJoinPool.execute(task);
System.out.println(task.get() + &quot; &quot; + (System.currentTimeMillis() - start) / 1000.0);
</code></pre>
<h3 id="å¾…ç»­-2"><a class="header" href="#å¾…ç»­-2">å¾…ç»­...</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sprintboot"><a class="header" href="#sprintboot">SprintBoot</a></h1>
<h2 id="ç»Ÿä¸€å‚æ•°æ ¡éªŒ"><a class="header" href="#ç»Ÿä¸€å‚æ•°æ ¡éªŒ">ç»Ÿä¸€å‚æ•°æ ¡éªŒ</a></h2>
<h3 id="å¢åŠ å¯¹æšä¸¾çš„æ ¡éªŒè§„åˆ™"><a class="header" href="#å¢åŠ å¯¹æšä¸¾çš„æ ¡éªŒè§„åˆ™">å¢åŠ å¯¹æšä¸¾çš„æ ¡éªŒè§„åˆ™</a></h3>
<p><a href="https://www.zhangshengrong.com/p/zAaOQQOrXd/">springboot validator æšä¸¾å€¼æ ¡éªŒåŠŸèƒ½å®ç°</a></p>
<h3 id="å…¨å±€å¤„ç†æ ¡éªŒå¤±è´¥"><a class="header" href="#å…¨å±€å¤„ç†æ ¡éªŒå¤±è´¥">å…¨å±€å¤„ç†æ ¡éªŒå¤±è´¥</a></h3>
<p><a href="https://bbs.huaweicloud.com/blogs/188118">å…¨å±€å¤„ç†å“åº”æ•°æ®</a></p>
<h2 id="mybatisplus"><a class="header" href="#mybatisplus">MybatisPlus</a></h2>
<h3 id="1-é…ç½®å¼•å…¥"><a class="header" href="#1-é…ç½®å¼•å…¥">1. é…ç½®å¼•å…¥</a></h3>
<p>1.1 pom.xml</p>
<pre><code class="language-xml">&lt;!--åŸºç¡€ä¾èµ–--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;3.4.2&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;
&lt;!--ç”Ÿæˆå™¨ä¾èµ–--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-plus-generator&lt;/artifactId&gt;
    &lt;version&gt;3.3.2&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;  &lt;!--ç”Ÿæˆå™¨æ¨¡æ¿ Velocity(é»˜è®¤) FreeMarker Beetl--&gt;
    &lt;groupId&gt;org.apache.velocity&lt;/groupId&gt;
    &lt;artifactId&gt;velocity&lt;/artifactId&gt;
    &lt;version&gt;1.7&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>1.2 yml</p>
<pre><code class="language-yml">mybatis-plus:
  # æ‰“å° sql è¯­å¥
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl
  # @EnumValue é…ç½®
  type-enums-package: com.southwind.mybatis_plus.enums
  # @TableLogic
  global-config:
    db-config:
      logic-not-delete-value: 0
      logic-delete-value: 1
</code></pre>
<h3 id="2-æºç "><a class="header" href="#2-æºç ">2. æºç </a></h3>
<p>META-INF/spring.factories</p>
<pre><code class="language-java">@ConfigurationProperties(
    prefix = &quot;spring.datasource&quot;
)
public class DataSourceProperties implements BeanClassLoaderAware, InitializingBean {
    private ClassLoader classLoader;
    private String name;
    private boolean generateUniqueName = true;
    private Class&lt;? extends DataSource&gt; type;
    private String driverClassName;
    private String url;
    ...
// mybatis_plus èˆå¼ƒäº† xml æ–‡æ¡£çš„é…ç½®æ–¹å¼ï¼Œé‡‡ç”¨é…ç½®ç±»è¯»å– yml
</code></pre>
<h3 id="3-æ³¨è§£"><a class="header" href="#3-æ³¨è§£">3. æ³¨è§£</a></h3>
<ul>
<li>
<p>åŸºæœ¬æ³¨è§£</p>
<pre><code class="language-java">@TableName(value = &quot;mybatis_plus_user&quot;) //tablename=value
@TableId(value = &quot;id&quot;, type = IdType.NONE)  // é»˜è®¤é›ªèŠ± id, entity è¦ Longï¼Œæ•°æ®åº“è¦ bigint ç±»å‹æ‰èƒ½å­˜è¿›å»
@TableField(value = &quot;age&quot;, select = false, exist = false) // æ˜¯å¦æŸ¥è¯¢ï¼Œæ˜¯å¦å­˜åœ¨
</code></pre>
</li>
<li>
<p>è‡ªåŠ¨å¡«å……</p>
<pre><code class="language-java">// (create_time, update_time ç­‰),éœ€è¦é…ç½® MetaObjectHandler
@TableField(fill = FieldFill.INSERT_UPDATE)
private Date createTime;

    @Component
    public class MyMetaObjectHandler implements MetaObjectHandler {
        @Override
        public void insertFill(MetaObject metaObject) {
            this.setFieldValByName(&quot;createTime&quot;, new Date(), metaObject);
            this.setFieldValByName(&quot;updateTime&quot;, new Date(), metaObject);
        }
        @Override
        public void updateFill(MetaObject metaObject) {
            this.setFieldValByName(&quot;updateTime&quot;, new Date(), metaObject);
        }
    }
</code></pre>
</li>
<li>
<p>ä¹è§‚é”</p>
<pre><code class="language-java">//  where version = 1..., é…ç½® OptimisticLockerConfigï¼Œå¢åŠ  version å­—æ®µ
@Version  // æ¯æ¬¡ update åï¼Œversion éƒ½ä¼šè‡ªå¢ 1,
private int version;

    @Configuration
    public class MybatisPlusConfig {
        @Bean
        public MybatisPlusInterceptor optimisticLocerInceptor() {
            MybatisPlusInterceptor mybatisPlusInterceptor = new MybatisPlusInterceptor();
            mybatisPlusInterceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
            return mybatisPlusInterceptor;
        }
    }
</code></pre>
</li>
<li>
<p>æšä¸¾æ˜ å°„</p>
<pre><code class="language-java">@EnumValue
private StatusEnum statusEnum;
public enum StatusEnum {
    // 1. å®ä½“ç±»åŠ æ³¨è§£ï¼Œyml éœ€é…ç½®
    WORK(1, &quot;ä¸Šç­&quot;),
    REST(0, &quot;ä¼‘æ¯&quot;);
    StatusEnum(Integer code, String msg) {
        this.code = code;
        this.msg = msg;
    }
    @EnumValue
    private Integer code;  // çŠ¶æ€
    private String msg;    // æè¿°
}
/* mybatis-plus:
*   type-enums-package: com.southwind.mybatis_plus.enums
*/
public enum StatusEnum2 implements IEnum {
    // 2. å®ä½“ç±»å®ç°æ¥å£ï¼Œyml æ— éœ€é…ç½®
    WORK(1, &quot;ä¸Šç­&quot;),
    REST(0, &quot;ä¼‘æ¯&quot;);
    StatusEnum2(Integer code, String msg) {
        this.code = code;
        this.msg = msg;
    }
    // ä¸ç”¨åŠ  @EnumValue æ³¨è§£
    private Integer code;  // çŠ¶æ€
    private String msg;    // æè¿°
    // éœ€è¦é‡å†™æ–¹æ³•
    @Override
    public Serializable getValue() {
        return this.code;
    }
}

// 5. é€»è¾‘åˆ é™¤ where deleted=0
@TableLogic // å¢åŠ  deleted å­—æ®µ
private Integer deleted;
</code></pre>
</li>
</ul>
<h3 id="4-crud"><a class="header" href="#4-crud">4. CRUD</a></h3>
<ul>
<li>
<p>æ¡ä»¶æŸ¥è¯¢</p>
<pre><code class="language-java">mapper.selectList(null);  // æŸ¥è¯¢å…¨éƒ¨
QueryWrapper wrapper = new QueryWrapper();

wrapper.eq(&quot;name&quot;, &quot;å¼ ä¸‰&quot;); // ==
wrapper.lt(&quot;age&quot;, 3); // &lt;
wrapper.gt(&quot;age&quot;, 3); // &gt;
wrapper.ge(&quot;age&quot;, 3); // &gt;=
wrapper.ne(&quot;age&quot;, 3); // &lt;&gt;

Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();
map.put(&quot;name&quot;, &quot;å¼ ä¸‰&quot;);
map.put(&quot;age&quot;, 13);
wrapper.allEq(map);
</code></pre>
</li>
<li>
<p>æ¨¡ç³ŠæŸ¥è¯¢</p>
<pre><code class="language-java">wrapper.like(&quot;name&quot;, &quot;çº¢&quot;); // æ¨¡ç³ŠæŸ¥è¯¢ (name like çº¢)
wrapper.likeLeft(&quot;name&quot;, &quot;çº¢&quot;); // æ¨¡ç³ŠæŸ¥è¯¢ (name like %çº¢) ä»¥çº¢å¼€å¤´
wrapper.likeRight(&quot;name&quot;, &quot;çº¢&quot;); // æ¨¡ç³ŠæŸ¥è¯¢ (name like çº¢%) ä»¥çº¢ç»“å°¾

wrapper.inSql(&quot;age&quot;, &quot;sql è¯­å¥&quot;); // (where age in ResultSet)
wrapper.orderByAsc(&quot;age&quot;); //å‡åº

wrapper.orderByDesc(&quot;age&quot;); //å‡åº
wrapper.having(&quot;age &gt; 8&quot;); // ä¸¤å¥å¯ä»¥å åŠ 
mapper.selectList(wrapper);

mapper.selectMaps(wrapper); // ç»“æœä»¥ Map å½¢å¼è¿”å›
</code></pre>
</li>
<li>
<p>åˆ†é¡µæŸ¥è¯¢ (é…ç½®æ‹¦æˆªå™¨)</p>
<pre><code class="language-java">Page&lt;Mybatis_plus_user&gt; page = new Page&lt;&gt;(1, 3); // æ¯ä¸€é¡µå–ä¸¤æ¡è®°å½•
Page&lt;Mybatis_plus_user&gt; result = mapper.selectPage(page, null);
result.getRecords().forEach(System.out::println);

@Bean
public PaginationInnerInterceptor paginationInnerInterceptor() {
    return new PaginationInnerInterceptor();
}
</code></pre>
</li>
</ul>
<h3 id="5-è‡ªå®šä¹‰-sql"><a class="header" href="#5-è‡ªå®šä¹‰-sql">5. è‡ªå®šä¹‰ SQL</a></h3>
<pre><code>```java
@Select(&quot;Select p.*, u.id userId, u.name userName from mybatis_plus_product p, mybatis_plus_user u where p.id=#{id}&quot;)
List&lt;UserVO&gt; findVOsById(Integer id);
// é€‚ç”¨äº VO ä¸” u.id, u.name æ²¡æœ‰è¢«å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œç”¨ UserName ä»£æ›¿ user ä¸å®ä½“ç±»å¯¹åº”
```
</code></pre>
<h3 id="6-generator"><a class="header" href="#6-generator">6. Generator</a></h3>
<pre><code>```java
public class MybatisPlusGenerator {
    public static void main(String[] args) {
        AutoGenerator autoGenerator = new AutoGenerator();
        // æ•°æ®æº
        autoGenerator.setDataSource(new DataSourceConfig()
                .setDbType(DbType.MYSQL)
                .setUrl(&quot;jdbc:mysql://localhost:3306/library?serverTimezone=GMT&quot;)
                .setUsername(&quot;root&quot;)
                .setPassword(&quot;123&quot;)
                .setDriverName(&quot;com.mysql.cj.jdbc.Driver&quot;)
        );
        // å…¨å±€é…ç½®
        autoGenerator.setGlobalConfig(new GlobalConfig()
                .setOutputDir( &quot;src/main/java&quot;)
                .setOpen(false)
                .setAuthor(&quot;trdthg&quot;)
                .setServiceName(&quot;%sService&quot;)  // è®¾å®š service ç±»åä¸å¸¦ I
        );
        // åŒ…ä¿¡æ¯
        autoGenerator.setPackageInfo(new PackageConfig()
                .setParent(&quot;com.southwind.mybatis_plus&quot;)
                .setModuleName(&quot;generator&quot;)
                .setController(&quot;controller&quot;)
                .setEntity(&quot;entity&quot;)
                .setMapper(&quot;mapper&quot;)
                .setService(&quot;service&quot;)
                .setServiceImpl(&quot;service.impl&quot;)
        );
        // ç­–ç•¥é…ç½®
        autoGenerator.setStrategy(new StrategyConfig()
                .setEntityLombokModel(true)
                .setColumnNaming(NamingStrategy.underline_to_camel) //æ•°æ®åº“ä¸‹åˆ’çº¿è‡ªåŠ¨è½¬ entity é©¼å³°
                .setNaming(NamingStrategy.underline_to_camel)
        );
        autoGenerator.execute();
    }
}

```
</code></pre>
<h2 id="redis"><a class="header" href="#redis">Redis</a></h2>
<ul>
<li>pom.xml</li>
</ul>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;version&gt;2.4.4&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
    &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>yml</li>
</ul>
<pre><code class="language-yml">sprint:
  redis:
    database: 0
    host: localhost
    port: 6379
</code></pre>
<ul>
<li>controller</li>
</ul>
<pre><code class="language-java">@RestController
public class RedisController {

    @Autowired
    private RedisTemplate redisTemplate;

    @PostMapping(&quot;/set&quot;)
    public void set(@RequestBody Student student) {
        redisTemplate.opsForValue().set(&quot;student&quot;, student);
        System.out.println(&quot;è®¾ç½®å®Œæˆ&quot;);
    }

    @GetMapping(&quot;/get/{key}&quot;)
    public Student get(@PathVariable(&quot;key&quot;) String key) {
        return (Student) redisTemplate.opsForValue().get(key);
    }

    @DeleteMapping(&quot;/delete/{key}&quot;)
    public boolean delete(@PathVariable(&quot;key&quot;) String key) {
        return !redisTemplate.delete(key);
    }

    @GetMapping(&quot;/string&quot;)
    public String string() {
        redisTemplate.opsForValue().set(&quot;string&quot;, &quot;hello world&quot;);
        return (String) redisTemplate.opsForValue().get(&quot;string&quot;);
    }

    @GetMapping(&quot;/list&quot;)
    public List&lt;String&gt; list() {
        ListOperations&lt;String, String&gt; listOperations = redisTemplate.opsForList();
        listOperations.leftPush(&quot;list&quot;, &quot;aaa&quot;);
        listOperations.leftPush(&quot;list&quot;, &quot;bbb&quot;);
        listOperations.leftPush(&quot;list&quot;, &quot;ccc&quot;);
        return listOperations.range(&quot;list&quot;, 0, 1);
    }

    @GetMapping(&quot;/set&quot;)
    public Set&lt;String&gt; set() {
        SetOperations&lt;String, String&gt; setOperations = redisTemplate.opsForSet();
        setOperations.add(&quot;set&quot;, &quot;é›†åˆ 1&quot;);
        setOperations.add(&quot;set&quot;, &quot;é›†åˆ 4&quot;);
        return setOperations.members(&quot;set&quot;);
    }

    @GetMapping(&quot;/zset&quot;)
    public Set&lt;String&gt; zset() {
        ZSetOperations&lt;String, String&gt; zSetOperations = redisTemplate.opsForZSet();
        //zSetOperations.add(&quot;zset&quot;, &quot;hello&quot;, 1);
        zSetOperations.add(&quot;zset&quot;, &quot;hello&quot;, 2);
        zSetOperations.add(&quot;zset&quot;, &quot;world&quot;, 1);
        zSetOperations.add(&quot;zset&quot;, &quot;hello&quot;, 3);
        return zSetOperations.range(&quot;zset&quot;, 0, 2);
    }

    @GetMapping(&quot;/hash&quot;)
    public String hash() {
        HashOperations hashOperations = redisTemplate.opsForHash();
        hashOperations.put(&quot;hash&quot;, &quot;id&quot;, &quot;1&quot;);
        hashOperations.put(&quot;hash&quot;, &quot;name&quot;, &quot;å¼ ä¸‰&quot;);
        hashOperations.put(&quot;hash&quot;, &quot;score&quot;, &quot;1.345&quot;);
        return (String) hashOperations.get(&quot;hash&quot;, &quot;name&quot;);
    }

}
</code></pre>
<h2 id="shiro"><a class="header" href="#shiro">Shiro</a></h2>
<h3 id="æ ¸å¿ƒç»„ä»¶"><a class="header" href="#æ ¸å¿ƒç»„ä»¶">æ ¸å¿ƒç»„ä»¶</a></h3>
<ol>
<li>UsernamePasswordToken: å°è£…ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼Œæ ¹æ®ä¿¡æ¯åˆ›å»ºä»¤ç‰Œ token</li>
<li>SecurityManagerï¼šæ ¸å¿ƒéƒ¨åˆ†ï¼Œè´Ÿè´£å®‰å…¨è®¤è¯å’Œæˆæƒ</li>
<li>Subjectï¼šæŠ½è±¡æ¦‚å¿µï¼ŒåŒ…å«äº†ç”¨æˆ·ä¿¡æ¯</li>
<li>Realmï¼šå¼€å‘è€…è‡ªå®šä¹‰æ¨¡å—ï¼Œç™»å½•æˆæƒçš„é€»è¾‘å…·ä½“å®ç°</li>
<li>Authenticationinfoï¼šç”¨æˆ·è§’è‰²ä¿¡æ¯ï¼Œè®¤è¯æ—¶ä½¿ç”¨</li>
<li>Authorizationï¼šè§’è‰²æƒé™ä¿¡æ¯ï¼Œæˆæƒæ—¶ä½¿ç”¨</li>
<li>DefaultWebSecurityManagerï¼šå¼€å‘è€…å°† Realm æ³¨å…¥å…¶ä¸­æ‰èƒ½ç”Ÿæ•ˆ</li>
<li>ShiroFilterFactoryBeanï¼šè¿‡æ»¤å™¨å¯¹è±¡ï¼Œshiro é€šè¿‡åˆ›å»º filter å¯¹è±¡æ‰§è¡Œå¼€å‘è€…å®šä¹‰çš„è¿‡æ»¤è§„åˆ™ ::: tip
ç”¨æˆ·ä¸æƒé™æ²¡æœ‰ç›´æ¥å…³è” ç”¨æˆ· - è§’è‰² - æƒé™ ä¸‰è€…ä¹‹é—´ä¸ºå¤šå¯¹å¤šå…³ç³» :::</li>
</ol>
<h3 id="ä¾èµ–"><a class="header" href="#ä¾èµ–">ä¾èµ–</a></h3>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;
    &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;
    &lt;version&gt;1.7.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h3 id="è¿‡æ»¤å™¨çš„å®ç°"><a class="header" href="#è¿‡æ»¤å™¨çš„å®ç°">è¿‡æ»¤å™¨çš„å®ç°</a></h3>
<pre><code class="language-java">public class ShiroUserRealm extends AuthorizingRealm {

    @Autowired
    ShiroUserService shiroUserService;
    // æˆæƒ
    @Override
    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {
        return null;
    }
    // éªŒè¯
    @Override
    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) throws AuthenticationException {
        UsernamePasswordToken usernamePasswordToken = (UsernamePasswordToken) token;
        ShiroUser shiroUser = shiroUserService.findByUsername(usernamePasswordToken.getUsername());
        if (shiroUser != null) {
            // å¯†ç æ˜¯å¦æ­£ç¡®ä¸ç”¨æ‰‹åŠ¨éªŒè¯ï¼Œä¸¢è¿›å»å°±è¡Œ
            // ä¸æ­£ç¡®ä¼šæŠ›å‡ºå¯†ç é”™è¯¯å¼‚å¸¸
            return new SimpleAuthenticationInfo(shiroUser, shiroUser.getPassword(), getName());
        }
        // ä¼šè‡ªåŠ¨æŠ›å‡ºè´¦æˆ·ä¸å­˜åœ¨çš„å¼‚å¸¸
        return null;
    }
}
</code></pre>
<h3 id="é…ç½®ç±»"><a class="header" href="#é…ç½®ç±»">é…ç½®ç±»</a></h3>
<ol>
<li>Realm Manager Factory ä¸‰å±‚æ³¨å…¥</li>
<li>@Qualifier(&quot;defaultWebSecurityManager&quot;) æŒ‰ç…§åå­—æŸ¥è¯¢ Bean</li>
</ol>
<pre><code class="language-java">@Configuration
public class ShiroConfig {

    @Bean
    public ShiroFilterFactoryBean shiroFilterFactoryBean(@Qualifier(&quot;defaultWebSecurityManager&quot;) DefaultWebSecurityManager defaultWebSecurityManager) {
        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);
        return shiroFilterFactoryBean;
    }

    @Bean
    public DefaultWebSecurityManager defaultWebSecurityManager(@Qualifier(&quot;shiroUserRealm&quot;) ShiroUserRealm shiroUserRealm) {
        DefaultWebSecurityManager defaultWebSecurityManager = new DefaultWebSecurityManager();
        defaultWebSecurityManager.setRealm(shiroUserRealm);
        return defaultWebSecurityManager;
    }

    @Bean
    public ShiroUserRealm shiroUserRealm() {
        return new ShiroUserRealm();
    }

}
</code></pre>
<h3 id="æˆæƒè®¤è¯è§„åˆ™"><a class="header" href="#æˆæƒè®¤è¯è§„åˆ™">æˆæƒè®¤è¯è§„åˆ™</a></h3>
<ol>
<li>è®¤è¯è¿‡æ»¤å™¨
<ul>
<li>anonï¼šæ— éœ€è®¤è¯</li>
<li>authcï¼šå¿…é¡»è®¤è¯</li>
<li>authcBasicï¼šéœ€è¦é€šè¿‡ HttpBasic è®¤è¯</li>
<li>userï¼šä¸ä¸€å®šéœ€è¦è®¤è¯ï¼Œåªéœ€è¦è¢«è®°å½•å°±ä¸éœ€è¦å†æ¬¡è®¤è¯</li>
</ul>
</li>
<li>æˆæƒè¿‡æ»¤å™¨
<ul>
<li>permsï¼šå¿…é¡»æ‹¥æœ‰æŸä¸ªæƒé™</li>
<li>roleï¼šå¿…é¡»æ‹¥æœ‰æŸä¸ªè§’è‰²</li>
<li>portï¼šè¯·æ±‚ç«¯å£å¿…é¡»æ˜¯æŒ‡å®šå€¼</li>
<li>restï¼šè¯·æ±‚å¿…é¡»åŸºäº Restfulï¼ŒGETã€POSTã€PUTã€DELETE</li>
<li>sslï¼šå¿…é¡»æ˜¯å®‰å…¨çš„ URL è¯·æ±‚ï¼Œåè®®æ˜¯ HTTPS</li>
</ul>
</li>
</ol>
<pre><code class="language-java">@Bean
public ShiroFilterFactoryBean shiroFilterFactoryBean(@Qualifier(&quot;defaultWebSecurityManager&quot;) DefaultWebSecurityManager defaultWebSecurityManager) {
    ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
    shiroFilterFactoryBean.setSecurityManager(defaultWebSecurityManager);
    // æƒé™è®¾ç½®
    Map&lt;String, String&gt; map = new Hashtable&lt;&gt;();
    map.put(&quot;/index&quot;, &quot;anon&quot;);
    map.put(&quot;/userspace&quot;, &quot;authc&quot;);
    map.put(&quot;/manage&quot;, &quot;perms[manager]&quot;);
    map.put(&quot;/root&quot;, &quot;roles[vip]&quot;);
    map.put(&quot;/special&quot;, &quot;authc, roles[vip]&quot;);
    shiroFilterFactoryBean.setFilterChainDefinitionMap(map);
    shiroFilterFactoryBean.setLoginUrl(&quot;shiroUser/login&quot;);
    return shiroFilterFactoryBean;
}
</code></pre>
<h2 id="spring-cloud-alibaba"><a class="header" href="#spring-cloud-alibaba">Spring-Cloud-Alibaba</a></h2>
<h3 id="æœåŠ¡æ²»ç†-nacos"><a class="header" href="#æœåŠ¡æ²»ç†-nacos">æœåŠ¡æ²»ç† Nacos</a></h3>
<p><a href="https://nacos.io/zh-cn/docs/quick-start.html">å®˜ç½‘æ•™ç¨‹</a> Nacos ç½‘é¡µä½¿ç”¨
nacos é»˜è®¤éœ€è¦é…ç½® nginx æ‰èƒ½é€šè¿‡ç½‘é¡µè®¿é—®ï¼Œæ‰§è¡Œ<code>sh startup.sh -m standalone</code>å¯ä»¥ç›´æ¥è®¿é—®</p>
<ol>
<li>æœåŠ¡æ³¨å†Œ
<ul>
<li>åœ¨ SpringBoot ä¸‹æ–°å»º<code>Provider</code>å­æ¨¡å—ï¼Œç»§æ‰¿<code>SCAlbaba</code>çˆ¶é¡¹ç›®ï¼Œ</li>
</ul>
<pre><code class="language-xml">&lt;parent&gt;
    &lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;
    &lt;!--&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;--&gt;
    &lt;!--&lt;version&gt;2.4.5&lt;/version&gt;--&gt;
    &lt;!--&lt;relativePath/&gt; &amp;lt;!&amp;ndash; lookup parent from repository &amp;ndash;&amp;gt;--&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;southwind_springcloudalibaba&lt;/artifactId&gt;
    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
&lt;/parent&gt;
</code></pre>
<ul>
<li>åŠ ä¸Š web ä¾èµ–ï¼ŒåŠ ä¸Š nacos-discovery ä¾èµ–</li>
</ul>
<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
    &lt;version&gt;2021.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>é…ç½® yml</li>
</ul>
<pre><code class="language-yml">spring:
cloud:
    nacos:
    discovery:
        server-addr: localhost:8848
application:
    name: provider
server:
port: 8082
</code></pre>
</li>
</ol>
<p>::: tip æç¤º Idea é€šè¿‡ç¼–è¾‘é…ç½®å¯ä»¥å¤šå¼€åº”ç”¨ ::: 2. æœåŠ¡å‘ç° -
åœ¨ SpringBoot ä¸‹æ–°å»º<code>Consumer</code>å­æ¨¡å—ï¼Œç»§æ‰¿<code>SCAlbaba</code>çˆ¶é¡¹ç›®ï¼Œ - ç»§æ‰¿å’Œä¾èµ–åŒä¸Š - yml åªç”¨é…ç«¯å£
<code>yml server: port: 8082</code> - controller ```java @RestController public class
ConsumerController {</p>
<pre><code>        @Autowired
        private DiscoveryClient discoveryClient;

        @GetMapping(&quot;/getInstance&quot;)
        public List&lt;ServiceInstance&gt; getInstance() {
            return this.discoveryClient.getInstances(&quot;provider&quot;);
        }

    }
```
</code></pre>
<h3 id="è´Ÿè½½å‡è¡¡"><a class="header" href="#è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</a></h3>
<ol>
<li>æœåŠ¡è°ƒç”¨ Privider ä¸­æä¾›äº† getPort æ–¹æ³•ï¼Œå¤šä¸ª Provider å®ä¾‹ç”± Consumer è°ƒç”¨ Provider</li>
</ol>
<pre><code class="language-java">@RestController
public class ProviderController {

    @Value(&quot;${server.port}&quot;)   // el è¡¨è¾¾å¼ï¼Œè¯»å– yml æ–‡ä»¶ä¸­çš„å†…å®¹
    private String port;

    @GetMapping(&quot;/getPort&quot;)
    public String getPort() {
        return port;
    }

}
</code></pre>
<p>Consumer</p>
<pre><code class="language-java">@RestController
@Slf4j // æ—¥å¿—æ‰“å°
public class ConsumerController {

    @Autowired
    private DiscoveryClient discoveryClient;
    @Autowired
    private RestTemplate restTemplate;  // éœ€è¦æ‰‹åŠ¨è£…è½½

    @GetMapping(&quot;/port&quot;)
    public String getPort() {
        // 1. è·å–éšæœºä¸€ä¸ª provider å®ä¾‹
        List&lt;ServiceInstance&gt; providers = discoveryClient.getInstances(&quot;provider&quot;);
        int randomIndex = ThreadLocalRandom.current().nextInt(providers.size());
        ServiceInstance provider = providers.get(randomIndex);
        String uri = provider.getUri().toString();  // uriï¼š ip + port
        String url = uri + &quot;/getPort&quot;;
        // 2. æ¥å£è°ƒç”¨
        log.info(&quot;è°ƒç”¨çš„ç«¯å£æ˜¯&quot; + provider.getHost());
        String port = restTemplate.getForObject(url, String.class);
        return &quot;è°ƒç”¨ Consumerï¼Œè°ƒç”¨äº†ç«¯å£ä¸º&quot; + port + &quot;çš„ Provider çš„ getPort&quot;;
    }
}
</code></pre>
<p>::: warning restTemplte æ— æ³•è‡ªåŠ¨æ³¨å…¥ï¼Œéœ€è¦æ‰‹åŠ¨æ³¨å…¥ :::</p>
<pre><code class="language-java">@Configuration
public class ConsumerConfiguration {

    // æ”¾åˆ° Main ä¸‹ä¹Ÿå¯
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
}
</code></pre>
<ol start="2">
<li>
<p>Ribbon è´Ÿè½½å‡è¡¡</p>
<ul>
<li>config é…ç½®</li>
</ul>
<pre><code class="language-java">@Bean
@LoadBalanced
public RestTemplate restTemplate() {
    return new RestTemplate();
}
</code></pre>
<ul>
<li>controller</li>
</ul>
<pre><code class="language-java">// Ribbon è´Ÿè½½å‡è¡¡
@GetMapping(&quot;/getPort2&quot;)
public String getPort2() {
    // é»˜è®¤è½®è¯¢ç®—æ³•
    String port = restTemplate.getForObject(&quot;http://provider/getPort&quot;, String.class);
    return &quot;è°ƒç”¨ Consumerï¼Œè°ƒç”¨äº†ç«¯å£ä¸º&quot; + port + &quot;çš„ Provider çš„ getPort&quot;;
}
</code></pre>
<ul>
<li>è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆå¯è‡ªå®šä¹‰ï¼‰</li>
</ul>
<pre><code class="language-java">@Bean
public IRule myRule(){
	return new RandomRule();
}
</code></pre>
<ol>
<li>RoundRobinRuleï¼š	è½®è¯¢</li>
<li>RandomRuleï¼š	éšæœº</li>
<li>AvaliabilityFilteringRuleï¼š	ä¼šå…ˆè¿‡æ»¤ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœè€Œå¤„äºæ–­è·¯å™¨è·³é—¸çš„çŠ¶æ€çš„æœåŠ¡å’Œå¹¶å‘çš„è¿æ¥æ•°é‡è¶…è¿‡é˜ˆå€¼çš„æœåŠ¡ï¼Œç„¶åå¯¹å‰©ä½™çš„æœåŠ¡åˆ—è¡¨æŒ‰ç…§è½®è¯¢ç­–ç•¥</li>
<li>WeightedResponseTimeRuleï¼š	æ ¹æ®å¹³å‡å“åº”æ—¶é—´è®¡ç®—æ‰€æœ‰æœåŠ¡çš„æƒé‡ï¼Œå“åº”æ—¶é—´è¶Šå¿«æœåŠ¡æƒé‡è¶Šå¤§</li>
<li>RetryRuleï¼š	å…ˆæŒ‰ç…§ RoundRobinRule ç­–ç•¥è·å–æœåŠ¡ï¼Œå¦‚æœè·å–æœåŠ¡å¤±è´¥ä¼šåœ¨æŒ‡å®šæ—¶é—´å†…é‡è¯•</li>
<li>BestAvailableRuleï¼š	ä¼šå…ˆè¿‡æ»¤æ‰ç”±äºå¤šæ¬¡è®¿é—®æ•…éšœäºŒå¤„äºæ–­è·¯å™¨è·³é—¸çŠ¶æ€çš„æœåŠ¡ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡æœ€å°çš„æœåŠ¡</li>
<li>ZoneAvoidanceRuleï¼š	é»˜è®¤è§„åˆ™ï¼Œå¤åˆåˆ¤æ–­ server æ‰€åœ¨çš„åŒºåŸŸçš„æ€§èƒ½å’Œ server çš„å¯ç”¨æ€§é€‰æ‹©æœåŠ¡å™¨</li>
</ol>
</li>
</ol>
<h3 id="å¾…ç»­-3"><a class="header" href="#å¾…ç»­-3">å¾…ç»­...</a></h3>
<h2 id="å¾…ç»­-4"><a class="header" href="#å¾…ç»­-4">å¾…ç»­...</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="spring"><a class="header" href="#spring">Spring</a></h1>
<h2 id="ioc"><a class="header" href="#ioc">IOC</a></h2>
<h3 id="è·å–å®ä¾‹"><a class="header" href="#è·å–å®ä¾‹">è·å–å®ä¾‹</a></h3>
<pre><code class="language-java">ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);
// 1. é€šè¿‡ id è·å–å®ä¾‹
Student student = (Student) applicationContext.getBean(&quot;student&quot;);
// 2. é€šè¿‡è¿è¡Œæ—¶ç±»è·å–å®ä¾‹ (ç¼ºç‚¹ï¼šxml ä¸­ä¸€ç§æ•°æ®ç±»å‹åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹)
//Student student = (Student) applicationContext.getBean(Student.class);
System.out.println(student);
</code></pre>
<h3 id="bean-é…ç½®"><a class="header" href="#bean-é…ç½®">Bean é…ç½®</a></h3>
<ol>
<li>æ— å‚æ„é€ </li>
</ol>
<pre><code class="language-java">&lt;bean id=&quot;student&quot; class=&quot;com.southwind.entity.Student&quot;
    scope=&quot;prototype&quot; parent=&quot;student&quot; autowire=&quot;byType&quot; depends-on=&quot;a2&quot;&gt;
    &lt;property name=&quot;id&quot; value=&quot;1&quot;/&gt;
    &lt;property name=&quot;name&quot; value=&quot;å¼ ä¸‰&quot;/&gt;
    &lt;property name=&quot;age&quot; value=&quot;12&quot;/&gt;
    &lt;property name=&quot;address&quot; ref=&quot;address&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<ul>
<li>scope: é»˜è®¤ä¸º singletonï¼Œå•ä¾‹æ¨¡å¼ï¼Œprototype ä¸ºå·¥å‚æ¨¡å¼</li>
<li>panent å‚æ•°ï¼šä¸åŒå¯¹è±¡åªè¦å±æ€§ç›¸åŒå°±èƒ½ç»§æ‰¿</li>
<li>autowire: byName æ ¹æ® id=(address) å¯»æ‰¾ï¼Œæ ¹æ® class=(Student) å¯»æ‰¾</li>
<li>depend-on: è§„å®š bean åˆ›å»ºé¡ºåº</li>
</ul>
<ol start="2">
<li>æœ‰å‚æ„é€ </li>
</ol>
<pre><code class="language-java">&lt;bean id=&quot;student3&quot; class=&quot;com.southwind.entity.Student&quot;&gt;
    &lt;constructor-arg name=&quot;id&quot; value=&quot;3&quot;/&gt;
    &lt;constructor-arg name=&quot;name&quot; value=&quot;æå››&quot;/&gt;
    &lt;!--å¯ä»¥ç”¨ index ä»£æ›¿ nameï¼Œä½†æ˜¯ä¹Ÿè¦æŒ‰é¡ºåºå†™--&gt;
    &lt;constructor-arg name=&quot;age&quot; value=&quot;14&quot;/&gt;
    &lt;!--&lt;constructor-arg index=&quot;2&quot; value=&quot;14&quot;/&gt;--&gt;
    &lt;constructor-arg name=&quot;address&quot; ref=&quot;address&quot;/&gt;
    &lt;constructor-arg name=&quot;addresses&quot;&gt;
        &lt;list&gt;
            &lt;ref bean=&quot;address&quot;/&gt;
            &lt;ref bean=&quot;address2&quot;/&gt;
        &lt;/list&gt;
    &lt;/constructor-arg&gt;
&lt;/bean&gt;
</code></pre>
<p>::: tip æç¤º spring é€šè¿‡åå°„è°ƒç”¨æ— å‚æ„é€ åˆ›å»ºå¯¹è±¡ï¼Œbean å¿…é¡»æœ‰æ— å‚æ„é€  :::
ClassPathXmlApplicationContext ç±»å®ç°äº† ApplicationContext æ¥å£ï¼Œæœ‰ getBean æ–¹æ³•
ä¸‹é¢æ˜¯ä¸€ä¸ª ClassPathXmlApplicationContext çš„ç®€å•å®ç°</p>
<pre><code class="language-java">public class ClassPathXmlApplicationContext implements ApplicationContext {

    private Map&lt;String, Object&gt; ioc = new HashMap&lt;&gt;();

    public ClassPathXmlApplicationContext(String path) {
        try {
            // xml æ–‡ä»¶è§£æ
            SAXReader saxReader = new SAXReader();
            Document document = saxReader.read(&quot;./src/main/resources/&quot; + path);
            System.out.println(document);
            Element root = document.getRootElement();
            Iterator&lt;?&gt; iterator = root.elementIterator();
            // éå†æ‰€æœ‰èŠ‚ç‚¹
            while (iterator.hasNext()) {
                Element element = (Element) iterator.next();
                String id = element.attributeValue(&quot;id&quot;);
                String className = element.attributeValue(&quot;class&quot;);
                // é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
                Class&lt;?&gt; clazz = Class.forName(className);
                // è·å–æ— å‚æ„é€ å‡½æ•°
                Constructor&lt;?&gt; constructor = clazz.getConstructor();
                Object object = constructor.newInstance();
                Iterator&lt;Element&gt; beanIterator = element.elementIterator();
                while (beanIterator.hasNext()) {
                    Element property = beanIterator.next();
                    String name = property.attributeValue(&quot;name&quot;);
                    String value = property.attributeValue(&quot;value&quot;);
                    String ref = property.attributeValue(&quot;ref&quot;);
                    // è·å– set æ–¹æ³•
                    // 1. æ‹¼æ¥æ–¹æ³•å
                    String methodName = &quot;set&quot; + name.substring(0, 1).toUpperCase() + name.substring(1);
                    // 2. è·å–å½¢å‚ç±»å‹
                    Field field = clazz.getDeclaredField(name);
                    // 3. è·å–å¸¦å‚æ•°çš„æ–¹æ³•
                    Method method = clazz.getDeclaredMethod(methodName, field.getType());
                    // 4. å°†å®å‚ç±»å‹ String è½¬æ¢ä¸ºæ‰€éœ€çš„
                    String fieldName = field.getType().getName();
                    if (fieldName == &quot;long&quot;) {
                        method.invoke(object, Long.parseLong(value));
                    } else if (fieldName == &quot;int&quot;) {
                        method.invoke(object, Integer.parseInt(value));
                    } else {
                        method.invoke(object, value);
                    }
                    if (ref != null) {
                        method.invoke(object, ioc.get(ref));
                        // è¿™é‡Œå¯èƒ½è¦åšä¸ªé€’å½’
                        // æˆ–è€…æ˜¯æŠŠ bean å…¨æ‰¾åˆ°åå†æ ¹æ® ref äº’ç›¸èµ‹å€¼
                        // è¿™é‡Œç®€å•å†™
                    }
                }
                ioc.put(id, object);
                System.out.println(object);
            }
            System.out.println(&quot;XML è§£æå®Œæ¯•&quot;);
        } catch (DocumentException | ClassNotFoundException | NoSuchMethodException | InstantiationException | InvocationTargetException | IllegalArgumentException | IllegalAccessException e) {
            e.printStackTrace();
        } catch (NoSuchFieldException e) {
            e.printStackTrace();
        }

    }

    @Override
    public Object getBean(String id) {
        return ioc.get(id);
    }
}
</code></pre>
<ol start="3">
<li>é™æ€å·¥å‚</li>
</ol>
<ul>
<li>factory</li>
</ul>
<pre><code class="language-java">public class StaticCarFactory {
    private static Map&lt;Long, Car&gt; carMap;
    static {
        carMap = new HashMap&lt;&gt;();
        carMap.put(1L, new Car(1L, &quot;å®é©¬&quot;));
        carMap.put(2L, new Car(2L, &quot;å¥”é©°&quot;));
    }
    public static Car getCar(long id) {
        return carMap.get(id);
    }
}
</code></pre>
<ul>
<li>spring.xml</li>
</ul>
<pre><code class="language-xml">&lt;!--é…ç½®é™æ€å·¥å‚--&gt;
&lt;bean id=&quot;car&quot; class=&quot;com.southwind.factory.StaticCarFactory&quot;               factory-method=&quot;getCar&quot;&gt;
    &lt;constructor-arg value=&quot;2&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<ol start="4">
<li>å®ä¾‹å·¥å‚</li>
</ol>
<ul>
<li>factory</li>
</ul>
<pre><code class="language-java">public class InstanceCarFactory {
    private Map&lt;Long, Car&gt; carMap;
    public InstanceCarFactory() {
        carMap = new HashMap&lt;&gt;();
        carMap.put(1L, new Car(1L, &quot;å®é©¬&quot;));
        carMap.put(2L, new Car(2L, &quot;å¥”é©°&quot;));
    }
    public Car getCar(long id) {
        return carMap.get(id);
    }
}
</code></pre>
<ul>
<li>xml</li>
</ul>
<pre><code class="language-java">&lt;!--é…ç½®å®ä¾‹å·¥å‚--&gt;
&lt;bean id=&quot;carFactory&quot; class=&quot;com.southwind.factory.InstanceCarFactory&quot;/&gt;
&lt;bean id=&quot;car2&quot; factory-bean=&quot;carFactory&quot; factory-method=&quot;getCar&quot;&gt;
    &lt;constructor-arg value=&quot;2&quot;/&gt;
&lt;/bean&gt;
</code></pre>
<h2 id="aop"><a class="header" href="#aop">AOP</a></h2>
<h3 id="æ‰‹åŠ¨åå°„å®ç°"><a class="header" href="#æ‰‹åŠ¨åå°„å®ç°">æ‰‹åŠ¨åå°„å®ç°</a></h3>
<ul>
<li>handler</li>
</ul>
<pre><code class="language-java">public class CalInvocationHandler implements InvocationHandler {
    // æ¥å—å§”æ‰˜å¯¹è±¡
    private Object object = null;

    // è¿”å›ä»£ç†å¯¹è±¡
    public Object bind(Object object) {
        this.object = object;
        // è·å–è¿è¡Œæ—¶ç±»
        Class&lt;?&gt; clazz = object.getClass();
        // è·å–ç±»åŠ è½½å™¨
        ClassLoader classLoader = clazz.getClassLoader();
        // è·å–ç±»çš„æ‰€æœ‰æ¥å£
        Class&lt;?&gt;[] interfaces = clazz.getInterfaces();
        //åˆ›å»ºèƒ½å®ç°å§”æ‰˜å¯¹è±¡æ‰€æœ‰åŠŸèƒ½çš„ä»£ç†å¯¹è±¡
        return Proxy.newProxyInstance(classLoader, interfaces, this);
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println(method.getName() + &quot;çš„å‚æ•°æ˜¯&quot; + Arrays.toString(args));
        Object result = method.invoke(this.object, args);
        System.out.println(method.getName() + &quot;çš„ç»“æœæ˜¯&quot; + result);

        return result;
    }
}
</code></pre>
<ul>
<li>Test</li>
</ul>
<pre><code class="language-java">public class Test {
    public static void main(String[] args) {
        Cal cal = new CalImpl();
        CalInvocationHandler calInvocationHandler = new CalInvocationHandler();
        cal = (Cal) calInvocationHandler.bind(cal);
        cal.add(1, 2);
    }
}
</code></pre>
<h3 id="aspect-å®ç°"><a class="header" href="#aspect-å®ç°">@Aspect å®ç°</a></h3>
<ul>
<li>loggerAspect</li>
</ul>
<pre><code class="language-java">@Aspect  // è®©æ™®é€šå¯¹è±¡æˆä¸ºåˆ‡é¢å¯¹è±¡
@Component  // äº¤ç»™ ioc ç®¡ç† bean  åŒæ—¶å§”æ‰˜å¯¹è±¡ä¹Ÿè¦è¢« ioc ç®¡ç†
public class loggerAspect {

    // æ–¹æ³•åç”¨*ä»£æ›¿  å‚æ•°ç”¨..ä»£æ›¿
    //@Before(&quot;execution(public int com.southwind.utils.impl.CalImpl.add(int, int))&quot;)
    @Before(&quot;execution(int com.southwind.utils.impl.CalImpl.*(..))&quot;)
    public void before(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        String args = Arrays.toString(joinPoint.getArgs());
        System.out.println(methodName + &quot;çš„å‚æ•°æ˜¯&quot; + args);
    }

    @After(&quot;execution(int com.southwind.utils.impl.CalImpl.*(..))&quot;)
    public void after(JoinPoint joinPoint) {
        String methodName = joinPoint.getSignature().getName();
        System.out.println(methodName + &quot;æ‰§è¡Œå®Œæ¯•&quot;);
    }

    @AfterReturning(
            value = &quot;execution(int com.southwind.utils.impl.CalImpl.*(..))&quot;,
            returning = &quot;result&quot;)
    public void afterReturning(JoinPoint joinPoint, Object result) {
        String methodName = joinPoint.getSignature().getName();
        System.out.println(methodName + &quot;çš„ç»“æœæ˜¯&quot; + result);
    }

    @AfterThrowing(
            value = &quot;execution(int com.southwind.utils.impl.CalImpl.*(..))&quot;,
            throwing = &quot;e&quot;)
    public void afterThrowing(JoinPoint joinPoint, Exception e) {
        String methodName = joinPoint.getSignature().getName();
        System.out.println(methodName + &quot;æŠ›å‡ºå¼‚å¸¸&quot; + e);
    }
}
</code></pre>
<ul>
<li>spring.xml</li>
</ul>
<pre><code class="language-xml">&lt;!--è‡ªåŠ¨æ‰«æ base-package ä¸‹çš„å¯¹è±¡ï¼Œå°†æ·»åŠ äº† @component æ³¨è§£çš„å¯¹è±¡åŠ å…¥ ioc å®¹å™¨--&gt;
&lt;context:component-scan base-package=&quot;com.southwind&quot;/&gt;

&lt;!--è‡ªåŠ¨æ‰«æï¼Œä¸ºæ·»åŠ äº† @aspect æ³¨è§£çš„å¯¹è±¡è‡ªåŠ¨ç”Ÿæˆä»£ç†å¯¹è±¡--&gt;
&lt;aop:aspectj-autoproxy/&gt;
</code></pre>
<ul>
<li>Test2</li>
</ul>
<pre><code class="language-java">// åŠ è½½é…ç½®æ–‡ä»¶
ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&quot;spring.xml&quot;);
// è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç†å¯¹è±¡è¢«è‡ªåŠ¨åŠ å…¥ ioc,
// @component(&quot;id&quot;) å¦‚æœä¸åŠ å‚æ•° bean çš„ id ä¸ºå§”æ‰˜å¯¹è±¡é¦–å­—æ¯å°å†™
Cal proxy = (Cal) applicationContext.getBean(&quot;calImpl&quot;);
proxy.add(1, 2);
</code></pre>
<h2 id="spring-mvc"><a class="header" href="#spring-mvc">spring-mvc</a></h2>
<h2 id="mybatis"><a class="header" href="#mybatis">Mybatis</a></h2>
<ul>
<li>pom.xml</li>
</ul>
<pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
    &lt;version&gt;3.5.6&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;8.0.23&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<ul>
<li>config.xml</li>
</ul>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;!DOCTYPE configuration PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot; &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;
&lt;configuration&gt;
&lt;!--    é…ç½® mybits è¿è¡Œç¯å¢ƒ--&gt;
    &lt;environments default=&quot;development&quot;&gt;
        &lt;environment id=&quot;development&quot;&gt;
&lt;!--            JDBC äº‹åŠ¡ç®¡ç†--&gt;
            &lt;transactionManager type=&quot;JDBC&quot;&gt;&lt;/transactionManager&gt;
&lt;!--            POOLED é…ç½®æ•°æ®åº“è¿æ¥æ± --&gt;
            &lt;dataSource type=&quot;POOLED&quot;&gt;
                &lt;property name=&quot;driver&quot; value=&quot;com.mysql.cj.jdbc.Driver&quot;/&gt;
                &lt;property name=&quot;url&quot; value=&quot;jdbc:mysql://localhost:3306/library?useUnicode=true&amp;amp;characterEncoding=UTF-8&quot;/&gt;
                &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;
                &lt;property name=&quot;password&quot; value=&quot;&quot;/&gt;
            &lt;/dataSource&gt;
        &lt;/environment&gt;
    &lt;/environments&gt;
    &lt;!--æ³¨å†Œ xml æ–‡ä»¶--&gt;
    &lt;mappers&gt;
        &lt;mapper resource=&quot;com/southwind/mapper/AccountMapper.xml&quot;&gt;&lt;/mapper&gt;
        &lt;mapper resource=&quot;com/southwind/mapper/StudentMapper.xml&quot;&gt;&lt;/mapper&gt;
        &lt;mapper resource=&quot;com/southwind/mapper/ClassesMapper.xml&quot;&gt;&lt;/mapper&gt;
    &lt;/mappers&gt;
&lt;/configuration&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é›†åˆæ¡†æ¶"><a class="header" href="#é›†åˆæ¡†æ¶">é›†åˆæ¡†æ¶</a></h1>
<h2 id="list"><a class="header" href="#list">List</a></h2>
<h3 id="arrays"><a class="header" href="#arrays">Arrays</a></h3>
<h4 id="arrayscopy"><a class="header" href="#arrayscopy">Arrays.copy()</a></h4>
<ol>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆç”¨æ¥å‚¨å­˜æ•°æ®
<ul>
<li>type(T) == type(U) ? ç›´æ¥åˆ›å»º : é€šè¿‡åå°„æœºåˆ¶åˆ›å»º</li>
</ul>
</li>
<li>è°ƒç”¨ System.arraycopy() æ‹·è´åˆ°æ–°é›†åˆä¸Š</li>
</ol>
<pre><code class="language-java">public static &lt;T,U&gt; T[] copyOf(U[] original, int newLength, Class&lt;? extends T[]&gt; newType) {
    @SuppressWarnings(&quot;unchecked&quot;)
    T[] copy = ((Object)newType == (Object)Object[].class)
        ? (T[]) new Object[newLength]
        : (T[]) Array.newInstance(newType.getComponentType(), newLength);
    System.arraycopy(original, 0, copy, 0,
                        Math.min(original.length, newLength));
    return copy;
}
</code></pre>
<h3 id="collection"><a class="header" href="#collection">Collection</a></h3>
<ol>
<li>è§£é‡Š</li>
</ol>
<pre><code class="language-java">public interface Collection&lt;E&gt; extends Iterable&lt;E&gt; {
</code></pre>
<ul>
<li>ç»§æ‰¿è‡ª Iterableï¼Œå®ç°äº† forEach &amp;&amp; iterator &amp;&amp; spliterator</li>
<li>removeIf æ–¹æ³•ä¼ å…¥ Predicate(å‡½æ•°æ¥å£ï¼Œä¼ å…¥æ¯”è¾ƒçš„æ–¹æ³•), åˆ©ç”¨ Iterator è¿­ä»£</li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">public interface MyCollection&lt;E&gt; extends Iterable&lt;E&gt; {
    int size();
    boolean isEmpty();
    boolean contains(Object o);
    Iterator&lt;E&gt; iterator();
    Object[] toArray();
    &lt;T&gt; T[] toArray(T[] a);
    boolean add(E e);
    boolean remove(Object o);
    boolean containsAll(Collection&lt;?&gt; c);
    boolean addAll(Collection&lt;? extends E&gt; c);
    boolean removeAll(Collection&lt;?&gt; c);
    default boolean removeIf(Predicate&lt;? super E&gt; filter) {
        Objects.requireNonNull(filter);
        boolean removed = false;
        final Iterator&lt;E&gt; each = iterator();
        while (each.hasNext()) {
            if (filter.test(each.next())) {
                each.remove();
                removed = true;
            }
        }
        return removed;
    }
    boolean retainAll(Collection&lt;?&gt; c);
    void clear();
    boolean equals(Object o);
    int hashCode();

    // è‡ªä» 1.8
    //default Spliterator&lt;E&gt; spliterator() {
    //    return Spliterators.spliterator(this, 0);
    //}
    //default Stream&lt;E&gt; stream() {
    //    return StreamSupport.stream(spliterator(), false);
    //}
    //default Stream&lt;E&gt; parallelStream() {
    //    return StreamSupport.stream(spliterator(), true);
    //}

}
</code></pre>
<h3 id="list-1"><a class="header" href="#list-1">List</a></h3>
<ol>
<li>è§£é‡Š</li>
</ol>
<ul>
<li>ç›¸æ¯”äº Collectionï¼Œä¸»è¦å¢åŠ äº†</li>
<li>get</li>
<li>sort</li>
<li>index ç›¸å…³</li>
<li>listIterator</li>
<li>SubList</li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">public interface MyList&lt;E&gt; extends Collection&lt;E&gt; {
    int size();
    boolean isEmpty();
    boolean contains(Object o);
    Iterator&lt;E&gt; iterator();
    Object[] toArray();
    &lt;T&gt; T[] toArray(T[] a);
    boolean add(E e);
    boolean remove(Object o);
    boolean containsAll(Collection&lt;?&gt; c);
    boolean addAll(Collection&lt;? extends E&gt; c);
    boolean addAll(int index, Collection&lt;? extends E&gt; c);
    boolean removeAll(Collection&lt;?&gt; c);
    boolean retainAll(Collection&lt;?&gt; c);
    default void replaceAll(UnaryOperator&lt;E&gt; operator) {
        Objects.requireNonNull(operator);
        final ListIterator&lt;E&gt; li = this.listIterator();
        while (li.hasNext()) {
            li.set(operator.apply(li.next()));
        }
    }
    default void sort(Comparator&lt;? super E&gt; c) {
        Object[] a = this.toArray();
        Arrays.sort(a, (Comparator) c);
        ListIterator&lt;E&gt; i = this.listIterator();
        for (Object e : a) {
            i.next();
            i.set((E) e);
        }
    }
    void clear();
    boolean equals(Object o);
    int hashCode();
    E get(int index);
    E set(int index, E element);
    void add(int index, E element);
    E remove(int index);
    int indexOf(Object o);
    int lastIndexOf(Object o);
    ListIterator&lt;E&gt; listIterator();
    ListIterator&lt;E&gt; listIterator(int index);
    List&lt;E&gt; subList(int fromIndex, int toIndex);
</code></pre>
<h3 id="abstractcollection"><a class="header" href="#abstractcollection">AbstractCollection</a></h3>
<ol>
<li>è§£é‡Š</li>
</ol>
<ul>
<li>æä¾›äº†ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•</li>
</ul>
<pre><code class="language-java">public abstract Iterator&lt;E&gt; iterator();
public abstract int size();
</code></pre>
<ul>
<li>å®ç°äº† toArray() æ–¹æ³•</li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">public abstract class MyAbstractCollection&lt;E&gt; implements Collection&lt;E&gt; {
    protected MyAbstractCollection() {
    }
    public abstract Iterator&lt;E&gt; iterator();
    public abstract int size();
    public boolean isEmpty() {
        return size() == 0;
    }
    public boolean contains(Object o) {
        Iterator&lt;E&gt; it = iterator();
        if (o==null) {
            while (it.hasNext())
                if (it.next()==null)
                    return true;
        } else {
            while (it.hasNext())
                if (o.equals(it.next()))
                    return true;
        }
        return false;
    }
    public Object[] toArray() {
        // Estimate size of array; be prepared to see more or fewer elements
        Object[] r = new Object[size()];
        Iterator&lt;E&gt; it = iterator();
        for (int i = 0; i &lt; r.length; i++) {
            if (! it.hasNext()) // fewer elements than expected
                return Arrays.copyOf(r, i);
            r[i] = it.next();
        }
        return it.hasNext() ? finishToArray(r, it) : r;
    }
    public &lt;T&gt; T[] toArray(T[] a) {
        // Estimate size of array; be prepared to see more or fewer elements
        int size = size();
        T[] r = a.length &gt;= size ? a :
                (T[])java.lang.reflect.Array
                        .newInstance(a.getClass().getComponentType(), size);
        Iterator&lt;E&gt; it = iterator();

        for (int i = 0; i &lt; r.length; i++) {
            if (! it.hasNext()) { // fewer elements than expected
                if (a == r) {
                    r[i] = null; // null-terminate
                } else if (a.length &lt; i) {
                    return Arrays.copyOf(r, i);
                } else {
                    System.arraycopy(r, 0, a, 0, i);
                    if (a.length &gt; i) {
                        a[i] = null;
                    }
                }
                return a;
            }
            r[i] = (T)it.next();
        }
        // more elements than expected
        return it.hasNext() ? finishToArray(r, it) : r;
    }
    private static &lt;T&gt; T[] finishToArray(T[] r, Iterator&lt;?&gt; it) {
        int len = r.length;
        int i = len;
        while (it.hasNext()) {
            if (i == len) {
                len = ArraysSupport.newLength(len,
                        1,             /* minimum growth */
                        (len &gt;&gt; 1) + 1 /* preferred growth */);
                r = Arrays.copyOf(r, len);
            }
            r[i++] = (T)it.next();
        }
        // trim if overallocated
        return (i == len) ? r : Arrays.copyOf(r, i);
    }
    public boolean add(E e) {
        throw new UnsupportedOperationException();
    }
    public boolean remove(Object o) {
        Iterator&lt;E&gt; it = iterator();
        if (o==null) {
            while (it.hasNext()) {
                if (it.next()==null) {
                    it.remove();
                    return true;
                }
            }
        } else {
            while (it.hasNext()) {
                if (o.equals(it.next())) {
                    it.remove();
                    return true;
                }
            }
        }
        return false;
    }
    public boolean containsAll(Collection&lt;?&gt; c) {
        for (Object e : c)
            if (!contains(e))
                return false;
        return true;
    }
    public boolean addAll(Collection&lt;? extends E&gt; c) {
        boolean modified = false;
        for (E e : c)
            if (add(e))
                modified = true;
        return modified;
    }
    public boolean removeAll(Collection&lt;?&gt; c) {
        Objects.requireNonNull(c);
        boolean modified = false;
        Iterator&lt;?&gt; it = iterator();
        while (it.hasNext()) {
            if (c.contains(it.next())) {
                it.remove();
                modified = true;
            }
        }
        return modified;
    }
    public boolean retainAll(Collection&lt;?&gt; c) {
        Objects.requireNonNull(c);
        boolean modified = false;
        Iterator&lt;E&gt; it = iterator();
        while (it.hasNext()) {
            if (!c.contains(it.next())) {
                it.remove();
                modified = true;
            }
        }
        return modified;
    }
    public void clear() {
        Iterator&lt;E&gt; it = iterator();
        while (it.hasNext()) {
            it.next();
            it.remove();
        }
    }
    public String toString() {
        Iterator&lt;E&gt; it = iterator();
        if (! it.hasNext())
            return &quot;[]&quot;;
        StringBuilder sb = new StringBuilder();
        sb.append('[');
        for (;;) {
            E e = it.next();
            sb.append(e == this ? &quot;(this Collection)&quot; : e);
            if (! it.hasNext())
                return sb.append(']').toString();
            sb.append(',').append(' ');
        }
    }

}
</code></pre>
<ol start="2">
<li>è§£é‡Š</li>
</ol>
<ul>
<li>toArray è¯¥æ–¹æ³•æ²¡æœ‰ç›´æ¥è¿”å›ï¼Œç›®çš„æ˜¯ä¸ºäº†åº”å¯¹å¤šçº¿ç¨‹</li>
</ul>
<pre><code class="language-java">public Object[] toArray() {
    // Estimate size of array; be prepared to see more or fewer elements
    Object[] r = new Object[size()];
    Iterator&lt;E&gt; it = iterator();
    for (int i = 0; i &lt; r.length; i++) {
        if (! it.hasNext()) // fewer elements than expected
            return Arrays.copyOf(r, i);
        r[i] = it.next();
    }
    return it.hasNext() ? finishToArray(r, it) : r;
}
</code></pre>
<ul>
<li>ä¸ºä»€ä¹ˆä¸æ˜¯éå†è¿­ä»£å™¨ï¼Ÿå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹æ“ä½œè¯¥é›†åˆï¼Œå…¶ä¸­æŸä¸ªçº¿ç¨‹å‘é›†åˆä¸­æ·»åŠ äº†å…ƒç´ ï¼Œæ­¤æ—¶å¦‚æœåœ¨è¿­ä»£å™¨çš„éå†ä¸­å‘æ•°ç»„ä¸­æ·»åŠ å…ƒç´ ï¼Œåˆ™ä¼šæŠ›å‡ºæ•°ç»„è¶Šç•Œå¼‚å¸¸ã€‚</li>
<li>ä¸ºä»€ä¹ˆè¿”å›ä¸€ä¸ªæ–°æ•°ç»„ï¼Ÿå¦‚æœå¤šçº¿ç¨‹åˆ é™¤äº†å…ƒç´ ï¼Œæ–°æ•°ç»„é•¿åº¦æ›´å°ï¼ŒèŠ‚çº¦ç©ºé—´ å¦‚æœå¤šçº¿ç¨‹æ·»åŠ äº†å…ƒç´ ï¼Œè°ƒç”¨ finishToArray</li>
</ul>
<pre><code class="language-java">private static &lt;T&gt; T[] finishToArray(T[] r, Iterator&lt;?&gt; it) {
    int len = r.length;
    int i = len;
    while (it.hasNext()) {
        if (i == len) {
            len = ArraysSupport.newLength(len,
                    1,             /* minimum growth */
                    (len &gt;&gt; 1) + 1 /* preferred growth */);
            r = Arrays.copyOf(r, len);
        }
        r[i++] = (T)it.next();
    }
    // trim if overallocated
    return (i == len) ? r : Arrays.copyOf(r, i);
}
</code></pre>
<ul>
<li>è¯¥æ–¹æ³•æ¯æ¬¡è¿­ä»£éƒ½ä¼šæ¯”è¾ƒå½“å‰æ•°ç»„é•¿åº¦ä¸è¿­ä»£å™¨é•¿åº¦ï¼Œåˆ©ç”¨ Array.copyOf è¿›è¡Œæ‰©å®¹ æœ€åè¿”å›å‰å†æ¬¡åˆ¤æ–­ï¼Œç¡®ä¿æ•°ç»„å®¹é‡ä¸å®é™…æ•°æ®é•¿åº¦ç›¸åŒ</li>
</ul>
<h3 id="abstractlist"><a class="header" href="#abstractlist">AbstractList</a></h3>
<ol>
<li>æ¦‚è¿°</li>
</ol>
<ul>
<li>extend
<ul>
<li>AbstractList ç»§æ‰¿è‡ª AbstractCollection æŠ½è±¡ç±»ï¼Œå®ç°äº† List æ¥å£ï¼Œ</li>
<li>å®ƒå®ç°äº† List çš„ä¸€äº›ä½ç½®ç›¸å…³æ“ä½œ (æ¯”å¦‚ get,set,add,remove)ï¼Œæ˜¯ç¬¬ä¸€ä¸ªå®ç°éšæœºè®¿é—®æ–¹æ³•çš„é›†åˆç±»ï¼Œä½†ä¸æ”¯æŒæ·»åŠ å’Œæ›¿æ¢ã€‚</li>
<li>AbstractList å†…éƒ¨å·²ç»æä¾›äº† Iterator, ListIterator è¿­ä»£å™¨çš„å®ç°ç±»ï¼Œåˆ†åˆ«ä¸º Itr, ListItr</li>
<li>å®ç°äº† SubList ç±»</li>
</ul>
</li>
<li>super
<ul>
<li>æ˜¯ ArrayList å’Œ AbstractSequentiaList çš„çˆ¶ç±»ã€‚</li>
<li>æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±» <code>public abstract E get(int index);</code></li>
</ul>
</li>
</ul>
<h4 id="modcount-ä¸-fail-fast"><a class="header" href="#modcount-ä¸-fail-fast">modCount ä¸ fail-fast</a></h4>
<ul>
<li>modCount ä½œç”¨æ˜¯è®°å½•é›†åˆç»“æ„è¢«æ”¹å˜çš„æ¬¡æ•° (æ·»åŠ ï¼Œåˆ é™¤ç­‰ç­‰), ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹ï¼Œæˆ–è€…è‡ªå·±å¯¹é›†åˆç»“æ„ä¿®æ”¹ï¼Œå¹¶ä¸åªæ˜¯æ›´æ”¹å…ƒç´ å†…å®¹</li>
<li>fail-fast æœºåˆ¶åœ¨è¿­ä»£å™¨ä¸­å®ç°ï¼Œ
fail-fast æœºåˆ¶å¹¶ä¸ä¿è¯åœ¨ä¸åŒæ­¥çš„ä¿®æ”¹ä¸‹ä¸€å®šä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå®ƒåªæ˜¯å°½æœ€å¤§åŠªåŠ›å»æŠ›å‡ºï¼Œæ‰€ä»¥è¿™ç§æœºåˆ¶ä¸€èˆ¬ä»…ç”¨äºæ£€æµ‹ bugã€‚</li>
</ul>
<h4 id="itr-ç±»"><a class="header" href="#itr-ç±»">Itr ç±»</a></h4>
<ol>
<li>ç‰¹å¾å˜é‡</li>
</ol>
<ul>
<li>cursor: æ˜¯æŒ‡é›†åˆéå†è¿‡ç¨‹ä¸­çš„å³å°†éå†çš„å…ƒç´ çš„ç´¢å¼•</li>
<li>lastRet: å®ƒä¸»è¦ç”¨äºè®°å½•åˆšåˆšéå†è¿‡çš„å…ƒç´ çš„ç´¢å¼•</li>
<li>expectedModCount: ä¸ºé›†åˆä¿®æ”¹æ¬¡æ•° (é»˜è®¤ä¸º 0) <code>int expectedModCount = modCount;</code></li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">private class Itr implements Iterator&lt;E&gt; {
        /**
         * Index of element to be returned by subsequent call to next.
         */
        int cursor = 0;

        /**
         * Index of element returned by most recent call to next or
         * previous.  Reset to -1 if this element is deleted by a call
         * to remove.
         */
        int lastRet = -1;

        /**
         * The modCount value that the iterator believes that the backing
         * List should have.  If this expectation is violated, the iterator
         * has detected concurrent modification.
         */
        int expectedModCount = modCount;

        public boolean hasNext() {
            return cursor != size();
        }

        public E next() {
            checkForComodification();
            try {
                int i = cursor;
                E next = get(i);
                lastRet = i;
                cursor = i + 1;
                return next;
            } catch (IndexOutOfBoundsException e) {
                checkForComodification();
                throw new NoSuchElementException(e);
            }
        }

        public void remove() {
            if (lastRet &lt; 0)
                throw new IllegalStateException();
            checkForComodification();

            try {
                AbstractList.this.remove(lastRet);
                if (lastRet &lt; cursor)
                    cursor--;
                lastRet = -1;
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException e) {
                throw new ConcurrentModificationException();
            }
        }

        final void checkForComodification() {
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
        }
    }
</code></pre>
<ol start="3">
<li>è§£é‡Š</li>
</ol>
<ul>
<li>iterator è¿›è¡Œ next() å’Œ remove() å‰éƒ½éœ€è¦è¿›è¡Œ checkForComodification(), æ£€æŸ¥è¿­ä»£è¿‡ç¨‹ä¸­é›†åˆç»“æ„æ˜¯å¦æ”¾ç”Ÿæ”¹å˜ ?
æŠ›å‡º ConcurrentModificationException() : æ­£å¸¸æ‰§è¡Œ</li>
<li>è¿­ä»£å™¨è‡ªèº«çš„ next, remove ä¸ä¼šå¯¹ modCount è¿›è¡Œä¿®æ”¹ï¼Œé›†åˆè°ƒç”¨ add ç­‰æ–¹æ³•æ—¶ä¼šä¿®æ”¹</li>
</ul>
<h4 id="å¦‚ä½•é¿å…-fail-fast"><a class="header" href="#å¦‚ä½•é¿å…-fail-fast">å¦‚ä½•é¿å… fail-fast</a></h4>
<ol>
<li>è°ƒç”¨ Iterator è‡ªèº«çš„ remove() è€Œä¸æ˜¯é›†åˆçš„
Itr.remove() å¹¶ä¸ä¼šä¿®æ”¹ modCount çš„å€¼ï¼Œå¹¶ä¸”ä¸ä¼šå¯¹åé¢çš„éå†é€ æˆå½±å“ï¼Œå› ä¸ºè¯¥æ–¹æ³• remove ä¸èƒ½æŒ‡å®šå…ƒç´ ï¼Œåªèƒ½ remove å½“å‰éå†è¿‡çš„é‚£ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥è°ƒç”¨è¯¥æ–¹æ³•å¹¶ä¸ä¼šå‘ç”Ÿ fail-fast ç°è±¡ã€‚è¯¥æ–¹æ³•æœ‰å±€é™æ€§ã€‚</li>
<li>ä½¿ç”¨ java å¹¶å‘åŒ… (java.util.concurrent) ä¸­çš„ç±»æ¥ä»£æ›¿ ArrayList å’Œ hashMapã€‚ç¤ºä¾‹</li>
</ol>
<ul>
<li>CopyOnWriterArrayList
CopyOnWriter æ˜¯å†™æ—¶å¤åˆ¶çš„å®¹å™¨ (COW)ï¼Œåœ¨è¯»å†™æ—¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚è¯¥å®¹å™¨åœ¨å¯¹ add å’Œ remove ç­‰æ“ä½œæ—¶ï¼Œå¹¶ä¸æ˜¯åœ¨åŸæ•°ç»„ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œè€Œæ˜¯å°†åŸæ•°ç»„æ‹·è´ä¸€ä»½ï¼Œåœ¨æ–°æ•°ç»„ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå¾…å®Œæˆåï¼Œæ‰å°†æŒ‡å‘æ—§æ•°ç»„çš„å¼•ç”¨æŒ‡å‘æ–°æ•°ç»„ï¼Œæ‰€ä»¥å¯¹äº
CopyOnWriterArrayList åœ¨è¿­ä»£è¿‡ç¨‹å¹¶ä¸ä¼šå‘ç”Ÿ fail-fast ç°è±¡ã€‚ä½†
CopyOnWrite å®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ã€‚</li>
<li>ConcurrentHashMap
ConcurrentHashMap é‡‡ç”¨äº†é”æœºåˆ¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚åœ¨è¿­ä»£æ–¹é¢ï¼ŒConcurrentHashMap ä½¿ç”¨äº†ä¸€ç§ä¸åŒçš„è¿­ä»£æ–¹å¼ã€‚åœ¨è¿™ç§è¿­ä»£æ–¹å¼ä¸­ï¼Œå½“ iterator è¢«åˆ›å»ºåé›†åˆå†å‘ç”Ÿæ”¹å˜å°±ä¸å†æ˜¯æŠ›å‡º ConcurrentModificationExceptionï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨æ”¹å˜æ—¶ new æ–°çš„æ•°æ®ä»è€Œä¸å½±å“åŸæœ‰çš„æ•°æ®
ï¼Œiterator å®Œæˆåå†å°†å¤´æŒ‡é’ˆæ›¿æ¢ä¸ºæ–°çš„æ•°æ®
ï¼Œè¿™æ · iterator çº¿ç¨‹å¯ä»¥ä½¿ç”¨åŸæ¥è€çš„æ•°æ®ï¼Œè€Œå†™çº¿ç¨‹ä¹Ÿå¯ä»¥å¹¶å‘çš„å®Œæˆæ”¹å˜ã€‚å³è¿­ä»£ä¸ä¼šå‘ç”Ÿ fail-fastï¼Œä½†ä¸ä¿è¯è·å–çš„æ˜¯æœ€æ–°çš„æ•°æ®ã€‚</li>
</ul>
<h4 id="listitr-ç±»"><a class="header" href="#listitr-ç±»">ListItr ç±»</a></h4>
<ol>
<li>æ¦‚è¿°</li>
</ol>
<ul>
<li>ListItr ç»§æ‰¿è‡ª Itr å®ç°äº† ListIterator æ¥å£</li>
<li>æ·»åŠ äº† previous(è¿”å›å‰ä¸€ä½), add(å¢åŠ ), set(ä¿®æ”¹) æ–¹æ³•</li>
<li>ä¸ Itr ä¸€æ ·ï¼Œæ¯æ¬¡ä¿®æ”¹å‰éœ€è¦æ£€æŸ¥ modCount æ˜¯å¦ä¸€è‡´ï¼Œä¿®æ”¹åå†æ¬¡åŒæ­¥ modCount</li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">private class ListItr extends Itr implements ListIterator&lt;E&gt; {
        ListItr(int index) {
            cursor = index;
        }

        public boolean hasPrevious() {
            return cursor != 0;
        }

        public E previous() {
            checkForComodification();
            try {
                int i = cursor - 1;
                E previous = get(i);
                lastRet = cursor = i;
                return previous;
            } catch (IndexOutOfBoundsException e) {
                checkForComodification();
                throw new NoSuchElementException(e);
            }
        }

        public int nextIndex() {
            return cursor;
        }

        public int previousIndex() {
            return cursor-1;
        }

        public void set(E e) {
            if (lastRet &lt; 0)
                throw new IllegalStateException();
            checkForComodification();

            try {
                AbstractList.this.set(lastRet, e);
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }

        public void add(E e) {
            checkForComodification();

            try {
                int i = cursor;
                AbstractList.this.add(i, e);
                lastRet = -1;
                cursor = i + 1;
                expectedModCount = modCount;
            } catch (IndexOutOfBoundsException ex) {
                throw new ConcurrentModificationException();
            }
        }
    }
</code></pre>
<h4 id=""><a class="header" href="#"></a></h4>
<h3 id="arraylist"><a class="header" href="#arraylist">ArrayList</a></h3>
<p>:::warning æ³¨æ„ ArrayList ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœéœ€è¦ï¼Œ
å¯ä»¥é€‰æ‹©ä½¿ç”¨ Collections.synchronizedList æ–¹æ³•â€œåŒ…è£…â€åˆ—è¡¨ã€‚æœ€å¥½åœ¨åˆ›å»ºæ—¶æ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥é˜²æ­¢æ„å¤–ä¸åŒæ­¥åœ°è®¿é—®åˆ—è¡¨ - from Josh
Bloch, Neal Gafter :::</p>
<h4 id="æ¦‚è¿°"><a class="header" href="#æ¦‚è¿°">æ¦‚è¿°</a></h4>
<ol>
<li>åˆ›å»º</li>
</ol>
<pre><code class="language-java">public class ArrayList&lt;E&gt;
    extends AbstractList&lt;E&gt;
    implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable
</code></pre>
<ol start="2">
<li>æ„é€ å‡½æ•°ï¼š</li>
</ol>
<ul>
<li>æ— å‚é•¿åº¦é»˜è®¤ä¸º 10</li>
<li>æŒ‡å®šé•¿åº¦</li>
<li>ä»å¦ä¸€ä¸ª Collection æ‹·è´</li>
</ul>
<pre><code class="language-java">public ArrayList(Collection&lt;? extends E&gt; c) {
        Object[] a = c.toArray();
        if ((size = a.length) != 0) {
            if (c.getClass() == ArrayList.class) {
                elementData = a;
            } else {
                elementData = Arrays.copyOf(a, size, Object[].class);
            }
        } else {
            // replace with empty array.
            elementData = EMPTY_ELEMENTDATA;
        }
    }
</code></pre>
<h4 id="å…¶ä»–æ–¹æ³•"><a class="header" href="#å…¶ä»–æ–¹æ³•">å…¶ä»–æ–¹æ³•</a></h4>
<ol>
<li>trimToSize(æœ€å°åŒ–)</li>
</ol>
<ul>
<li>ç”¨æ¥æœ€å°åŒ–å®ä¾‹å­˜å‚¨ï¼Œå°†å®¹å™¨å¤§å°è°ƒæ•´ä¸ºå½“å‰å…ƒç´ æ‰€å ç”¨çš„å®¹é‡å¤§å°ã€‚</li>
</ul>
<pre><code class="language-java">public void trimToSize() {
    modCount++;
    if (size &lt; elementData.length) {
        elementData = (size == 0)
            ? EMPTY_ELEMENTDATA
            : Arrays.copyOf(elementData, size);
    }
}
</code></pre>
<ol start="2">
<li>ensureCapacity(æœ€å¤§åŒ–)</li>
</ol>
<ul>
<li>åˆ©ç”¨ grow(minCapacity) ä¸»åŠ¨æ‰©å®¹ï¼Œå½“éœ€è¦æ‰©å¤§çš„å®¹é‡å¾ˆå¤§æ—¶ï¼Œèƒ½æœ‰æ•ˆæé«˜æ•ˆç‡</li>
</ul>
<pre><code class="language-java">public void ensureCapacity(int minCapacity) {
    if (minCapacity &gt; elementData.length
        &amp;&amp; !(elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA
                &amp;&amp; minCapacity &lt;= DEFAULT_CAPACITY)) {
        modCount++;
        grow(minCapacity);
    }
}
</code></pre>
<ol start="3">
<li>addAll</li>
</ol>
<ul>
<li>modCount++</li>
<li>æ‹·è´æ–°é›†åˆ</li>
<li>åˆ¤æ–­æ˜¯å¦è¶…å‡ºåŸé›†åˆå‰©ä½™å®¹é‡</li>
<li>System.copy()</li>
</ul>
<ol start="4">
<li>shiftTailOverGap</li>
</ol>
<ul>
<li>å°†æŸæ®µå…ƒç´ è¿›è¡Œå¹³ç§»</li>
</ul>
<ol start="5">
<li>batchRemove retainAll , removeAll å‡é€šè¿‡è°ƒç”¨æ­¤æ–¹æ³•å®ç°</li>
<li>ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œè®°å½•åŸæ•°ç»„ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®</li>
<li>ç¬¬äºŒæ¬¡å¾ªç¯</li>
</ol>
<pre><code class="language-java">for (Object e; r &lt; end; r++)
    if (c.contains(e = es[r]) == complement)
        es[w++] = e;
</code></pre>
<ul>
<li>r: è®°å½•éå†åˆ°çš„ index</li>
<li>w: è®°å½•åŸå§‹æ•°ç»„è¢«è¦†ç›–åˆ°çš„ index</li>
<li>è¿™éƒ¨åˆ†çš„æ„æ€æ˜¯ï¼Œw çš„ç›®çš„æ˜¯è®°å½•æ–°çš„å†…å®¹è¦†ç›–æ‰åŸæœ‰çš„å†…å®¹ï¼Œè¦†ç›–çš„åŸåˆ™æ˜¯ï¼Œåˆ¤æ–­ elementData[r] æ˜¯å¦ç¬¦åˆéœ€è¦ï¼Œè‹¥ç¬¦åˆå°±æŠŠä»–ç²˜åˆ° w å¤„</li>
<li>æœ€å finally æ‰§è¡Œ shiftTailOverGapï¼Œç›®çš„æ˜¯æŠŠåé¢çš„ä¹±ä¸ƒå…«ç³Ÿçš„åç¼€</li>
</ul>
<h4 id="æ ¸å¿ƒæ–¹æ³•"><a class="header" href="#æ ¸å¿ƒæ–¹æ³•">æ ¸å¿ƒæ–¹æ³•</a></h4>
<ol>
<li>grow</li>
</ol>
<ul>
<li>ä¸ä¼ å‚ <code>return grow(size + 1);</code></li>
<li>ä¼ å‚</li>
</ul>
<pre><code class="language-java">private Object[] grow(int minCapacity) {
    int oldCapacity = elementData.length;
    if (oldCapacity &gt; 0 || elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        int newCapacity = ArraysSupport.newLength(oldCapacity,
                minCapacity - oldCapacity, /* minimum growth */
                oldCapacity &gt;&gt; 1           /* preferred growth */);
        return elementData = Arrays.copyOf(elementData, newCapacity);
    } else {
        return elementData = new Object[Math.max(DEFAULT_CAPACITY, minCapacity)];
    }
}
</code></pre>
<ul>
<li>è‹¥æ‰©å®¹æ—¶æ²¡æœ‰å…ƒç´ ç›´æ¥é˜”åˆ° max(10, minCapacity)</li>
<li>è‹¥æœ‰å…ƒç´ ï¼Œç”±äºå³ç§»è¿ç®—ç¬¦çš„å­˜åœ¨ï¼Œæ¯æ¬¡æ‰©å®¹å¹¶ä¸ä¸€å®šæ˜¯ minCapacity çš„çš„å¤§å°ï¼Œä¸€èˆ¬ä¸ºåŸå¤§å°çš„ 1.5 å€ï¼Œ
å…·ä½“å¯ä»¥æŸ¥çœ‹ System.newLength å’Œ System.hugeLength</li>
</ul>
<ol start="2">
<li>
<p>clone() å¸¸è§„çš„æµ…æ‹·è´</p>
</li>
<li>
<p>add(), set(), remove()</p>
<ol>
<li>new ArrayList()
<ul>
<li>è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºæ–°çš„ç©ºé›†åˆé›†åˆ</li>
<li>é€šè¿‡ AbstractList åˆ›å»º modCount=0</li>
</ul>
</li>
<li>add():
<ul>
<li>modCount++</li>
<li>if elementData.length &gt;= 0 ? æ‰©å®¹ 50% :æ‰©å®¹é»˜è®¤ 10 æ ¼</li>
<li>elementData[size] = e (size æ˜¯å·²ç»å­˜å…¥çš„æ•°æ®ä¸ªæ•°)</li>
</ul>
</li>
<li>è‹¥é›†åˆæ»¡äº†åˆ™å…ˆè°ƒç”¨ grow() æ‰©å®¹ï¼Œåœ¨èµ‹å€¼</li>
</ol>
</li>
<li>
<p>add(index), remove(index)</p>
</li>
</ol>
<ul>
<li>add(index) åŒç†ï¼Œæ‰©å®¹é‡‡ç”¨ System.arraycopy åœ¨åŸæ•°ç»„ä¸Šæ‰©å®¹</li>
<li>è‹¥ index ä¸æ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™éœ€è¦å…ˆç”¨ System.arraycopy ä» index è®©åæ–¹çš„æ•°æ®å‘åæŒªä¸€ä½ï¼Œç©ºå‡ºæ–°çš„ä½ç½®ç”¨æ¥æ’å…¥</li>
</ul>
<pre><code class="language-java">System.arraycopy(elementData, index,
                         elementData, index + 1,
                         s - index);
</code></pre>
<ul>
<li>remove(index) è°ƒç”¨äº† fastRemove(), é€šè¿‡ System.arraycopy() æœ€å°åŒ–å®¹å™¨ï¼Œåœ¨å°†æŒ‡å®šä½ç½®è®¾ç½®ä¸º null</li>
</ul>
<pre><code class="language-java">private void fastRemove(Object[] es, int i) {
    modCount++;
    final int newSize;
    if ((newSize = size - 1) &gt; i)
        System.arraycopy(es, i + 1, es, i, newSize - i);
    es[size = newSize] = null;
}
</code></pre>
<h3 id="å¾…ç»­-5"><a class="header" href="#å¾…ç»­-5">å¾…ç»­...</a></h3>
<h2 id="set"><a class="header" href="#set">Set</a></h2>
<h3 id="set-1"><a class="header" href="#set-1">Set</a></h3>
<h4 id="æ¦‚è¿°-1"><a class="header" href="#æ¦‚è¿°-1">æ¦‚è¿°</a></h4>
<pre><code class="language-java">public interface Set&lt;E&gt; extends Collection&lt;E&gt; {
</code></pre>
<h3 id="abstractset"><a class="header" href="#abstractset">AbstractSet</a></h3>
<h4 id="æ¦‚è¿°-2"><a class="header" href="#æ¦‚è¿°-2">æ¦‚è¿°</a></h4>
<pre><code class="language-java">public abstract class AbstractSet&lt;E&gt; extends AbstractCollection&lt;E&gt; implements Set&lt;E&gt; {
</code></pre>
<ol>
<li>ç»§æ‰¿è‡ª AbstractCollectionï¼Œå®ç°äº† Set æ¥å£</li>
<li>åªé‡å†™äº† equals(), hashcode(), removeAll() æ–¹æ³•ï¼Œå‡ ä¹æ²¡å˜</li>
</ol>
<h3 id="å¾…ç»­-6"><a class="header" href="#å¾…ç»­-6">å¾…ç»­...</a></h3>
<h2 id="map"><a class="header" href="#map">Map</a></h2>
<h3 id="æ¥å£-map"><a class="header" href="#æ¥å£-map">æ¥å£ Map</a></h3>
<h3 id="map-1"><a class="header" href="#map-1">Map</a></h3>
<h4 id="åŸºç¡€æ–¹æ³•"><a class="header" href="#åŸºç¡€æ–¹æ³•">åŸºç¡€æ–¹æ³•</a></h4>
<pre><code class="language-java">public interface Map&lt;K, V&gt; {
    int size();
    boolean isEmpty();
    boolean containsKey(Object key);
    boolean containsValue(Object value);
    V get(Object key);
    V put(K key, V value);
    V remove(Object key);
    void putAll(Map&lt;? extends K, ? extends V&gt; m);
    void clear();

    Set&lt;K&gt; keySet();
    Collection&lt;V&gt; values();
    Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet();

    static &lt;K, V&gt; Map&lt;K, V&gt; of(K k1, V v1, K k2, V v2) {  // æœ€å¤§æ”¯æŒ 10 å¯¹
        return new ImmutableCollections.MapN&lt;&gt;(k1, v1, k2, v2);
    }
    default boolean remove(Object key, Object value) { // å…è®¸ key ä¸º null
        Object curValue = get(key);
        if (!Objects.equals(curValue, value) ||
            (curValue == null &amp;&amp; !containsKey(key))) {
            return false;
        }
        remove(key);
        return true;
    }
</code></pre>
<h4 id="å†…éƒ¨-entry-æ¥å£"><a class="header" href="#å†…éƒ¨-entry-æ¥å£">å†…éƒ¨ Entry æ¥å£</a></h4>
<pre><code class="language-java">interface Entry&lt;K, V&gt; {
    K getKey();
    V getValue();
    V setValue(V value);
    boolean equals(Object o);
    int hashCode();
    public static &lt;K extends Comparable&lt;? super K&gt;, V&gt; Comparator&lt;Map.Entry&lt;K, V&gt;&gt; comparingByKey() {
        return (Comparator&lt;Map.Entry&lt;K, V&gt;&gt; &amp; Serializable) (c1, c2) -&gt; c1.getKey().compareTo(c2.getKey());
    }
    public static &lt;K, V extends Comparable&lt;? super V&gt;&gt; Comparator&lt;Map.Entry&lt;K, V&gt;&gt; comparingByValue() {}
    public static &lt;K, V&gt; Comparator&lt;Map.Entry&lt;K, V&gt;&gt; comparingByKey(Comparator&lt;? super K&gt; cmp) {
        Objects.requireNonNull(cmp);
        return (Comparator&lt;Map.Entry&lt;K, V&gt;&gt; &amp; Serializable) (c1, c2) -&gt; cmp.compare(c1.getKey(), c2.getKey());
    }
    public static &lt;K, V&gt; Comparator&lt;Map.Entry&lt;K, V&gt;&gt; comparingByValue(Comparator&lt;? super V&gt; cmp) {}
}
</code></pre>
<h4 id="å…¶ä»–æ–¹æ³•-1"><a class="header" href="#å…¶ä»–æ–¹æ³•-1">å…¶ä»–æ–¹æ³•</a></h4>
<ul>
<li>equal hashcode</li>
<li>3 ä¸ª replace 4 ä¸ª ifAbsent 1 ä¸ª merge</li>
</ul>
<pre><code class="language-java">    boolean equals(Object o);
    int hashCode();
    default V getOrDefault(Object key, V defaultValue) {  // æ²¡æœ‰åˆ™è¿”å›
        V v;
        return (((v = get(key)) != null) || containsKey(key))
            ? v
            : defaultValue;
    }
    default void forEach(BiConsumer&lt;? super K, ? super V&gt; action) {
        Objects.requireNonNull(action);
        for (Map.Entry&lt;K, V&gt; entry : entrySet()) {
            K k;
            V v;
            try {
                k = entry.getKey();
                v = entry.getValue();
            } catch (IllegalStateException ise) {
                // this usually means the entry is no longer in the map.
                throw new ConcurrentModificationException(ise);
            }
            action.accept(k, v);
        }
    }
    default boolean replace(K key, V oldValue, V newValue) {
        Object curValue = get(key);
        if (!Objects.equals(curValue, oldValue) ||
            (curValue == null &amp;&amp; !containsKey(key))) {
            return false;
        }
        put(key, newValue);
        return true;
    }
    default V replace(K key, V value) {}
    default void replaceAll(BiFunction&lt;? super K, ? super V, ? extends V&gt; function) {  // function æ‰¹é‡å¤„ç†
        Objects.requireNonNull(function);
        for (Map.Entry&lt;K, V&gt; entry : entrySet()) {
            K k;
            V v;
            try {
                k = entry.getKey();
                v = entry.getValue();
            } catch (IllegalStateException ise) {
                // this usually means the entry is no longer in the map.
                throw new ConcurrentModificationException(ise);
            }

            // ise thrown from function is not a cme.
            v = function.apply(k, v);

            try {
                entry.setValue(v);
            } catch (IllegalStateException ise) {
                // this usually means the entry is no longer in the map.
                throw new ConcurrentModificationException(ise);
            }
        }
    }
    default V putIfAbsent(K key, V value) {  // ä¸å­˜åœ¨ key åˆ™æ·»åŠ 
        V v = get(key);
        if (v == null) {
            v = put(key, value);
        }
        return v;
    }

    // computeIfPresent åŒç†
    // compute ç”¨ key å’Œ value ç”Ÿäº§æ–°çš„ value
    default V computeIfAbsent(K key,
            Function&lt;? super K, ? extends V&gt; mappingFunction) {  // ä¸å­˜åœ¨å°±ç”¨æ–¹æ³•æ–°å»º
        Objects.requireNonNull(mappingFunction);
        V v;
        if ((v = get(key)) == null) {
            V newValue;
            if ((newValue = mappingFunction.apply(key)) != null) {
                put(key, newValue);
                return newValue;
            }
        }

        return v;
    }
    default V merge(K key, V value,
        BiFunction&lt;? super V, ? super V, ? extends V&gt; remappingFunction) {
        Objects.requireNonNull(remappingFunction);
        Objects.requireNonNull(value);
        V oldValue = get(key);
        V newValue = (oldValue == null) ? value :
                remappingFunction.apply(oldValue, value);
        if (newValue == null) {
            remove(key);
        } else {
            put(key, newValue);
        }
        return newValue;
    }
</code></pre>
<h3 id="abstractmap"><a class="header" href="#abstractmap">AbstractMap</a></h3>
<h4 id="æ¦‚è¿°-3"><a class="header" href="#æ¦‚è¿°-3">æ¦‚è¿°</a></h4>
<ol>
<li>å®ç° Map æ¥å£ï¼Œæ²¡æœ‰å®ç° Map.Entry() æ¥å£</li>
<li>æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•</li>
</ol>
<pre><code class="language-java">public abstract Set&lt;Entry&lt;K,V&gt;&gt; entrySet();
</code></pre>
<ol start="3">
<li>é»˜è®¤ä¸æ”¯æŒä¿®æ”¹</li>
</ol>
<h4 id="enttryset"><a class="header" href="#enttryset">enttrySet()</a></h4>
<pre><code class="language-java">public abstract Set&lt;Entry&lt;K,V&gt;&gt; entrySet();
</code></pre>
<ol>
<li>å½“æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªä¸å¯å˜çš„ Map æ—¶ï¼Œåªéœ€è¦ç»§æ‰¿è¿™ä¸ªç±»ï¼Œç„¶åå®ç° entrySet() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ªä¿å­˜æ‰€æœ‰ key-value æ˜ å°„çš„
setã€‚é€šå¸¸è¿™ä¸ª Set ä¸æ”¯æŒ add(), remove() æ–¹æ³•ï¼ŒSet å¯¹åº”çš„è¿­ä»£å™¨ä¹Ÿä¸æ”¯æŒ remove() æ–¹æ³•ã€‚</li>
<li>å¦‚æœæƒ³è¦å®ç°ä¸€ä¸ªå¯å˜çš„ Mapï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸Šè¿°æ“ä½œå¤–ï¼Œé‡å†™ put() æ–¹æ³•ï¼Œå› ä¸º é»˜è®¤ä¸æ”¯æŒ put æ“ä½œï¼š</li>
</ol>
<pre><code class="language-java">public V put(K key, V value) {
    throw new UnsupportedOperationException();
}
</code></pre>
<p>è€Œä¸” entrySet() è¿”å›çš„ Set çš„è¿­ä»£å™¨ï¼Œä¹Ÿå¾—å®ç° remove() æ–¹æ³•ï¼Œå› ä¸º AbstractMap ä¸­çš„ åˆ é™¤ç›¸å…³æ“ä½œéƒ½éœ€è¦è°ƒç”¨è¯¥è¿­ä»£å™¨çš„
remove() æ–¹æ³•ã€‚</p>
<h4 id="åŸºç¡€æ–¹æ³•-1"><a class="header" href="#åŸºç¡€æ–¹æ³•-1">åŸºç¡€æ–¹æ³•</a></h4>
<ol>
<li>put() é»˜è®¤éœ€è¦é‡å†™ï¼Œå¦åˆ™ç›´æ¥æŠ›å¼‚å¸¸</li>
<li>å…¶ä»–æ— ééƒ½æ˜¯ Iterator éå†</li>
</ol>
<h4 id="ä¸‰ä¸ªè§†å›¾"><a class="header" href="#ä¸‰ä¸ªè§†å›¾">ä¸‰ä¸ªè§†å›¾</a></h4>
<ol>
<li>è·å–æ‰€æœ‰é”® <code>public Set&lt;K&gt; keySet() {</code></li>
<li>è·å–æ‰€æœ‰å€¼ <code>public Collection&lt;V&gt; values() {</code></li>
<li>è·å–æ‰€æœ‰é”®å€¼å¯¹ <code>public abstract Set&lt;Entry&lt;K,V&gt;&gt; entrySet();</code></li>
</ol>
<h3 id="sortedmap"><a class="header" href="#sortedmap">SortedMap</a></h3>
<pre><code class="language-java">public interface SortedMap&lt;K,V&gt; extends Map&lt;K,V&gt; {
</code></pre>
<p>å†…ç½®æ–¹æ³•ï¼š</p>
<pre><code class="language-java">Comparator&lt;? super K&gt; comparator();
SortedMap&lt;K,V&gt; subMap(K fromKey, K toKey);
SortedMap&lt;K,V&gt; headMap(K toKey);
SortedMap&lt;K,V&gt; tailMap(K fromKey);
K firstKey();
K lastKey();
Set&lt;K&gt; keySet();
Collection&lt;V&gt; values();
Set&lt;Map.Entry&lt;K, V&gt;&gt; entrySet();
</code></pre>
<h3 id="navigablemap"><a class="header" href="#navigablemap">NavigableMap</a></h3>
<pre><code class="language-java">public interface NavigableMap&lt;K,V&gt; extends SortedMap&lt;K,V&gt; {
</code></pre>
<p>å†…ç½®æ–¹æ³•ï¼š</p>
<pre><code class="language-java">Map.Entry&lt;K,V&gt; lowerEntry(K key);  // æ¯”ç»™å®šçš„ entry å°çš„æœ€å¤§çš„ entry
K lowerKey(K key);
Map.Entry&lt;K,V&gt; floorEntry(K key);
K floorKey(K key); // &lt;=
Map.Entry&lt;K,V&gt; ceilingEntry(K key);
K ceilingKey(K key);
Map.Entry&lt;K,V&gt; higherEntry(K key);
K higherKey(K key);
Map.Entry&lt;K,V&gt; firstEntry();
Map.Entry&lt;K,V&gt; lastEntry();
Map.Entry&lt;K,V&gt; pollFirstEntry();
Map.Entry&lt;K,V&gt; pollLastEntry();
NavigableMap&lt;K,V&gt; descendingMap();  // reverse order view
NavigableSet&lt;K&gt; navigableKeySet();
NavigableSet&lt;K&gt; descendingKeySet();
NavigableMap&lt;K,V&gt; subMap(K fromKey, boolean fromInclusive,
                         K toKey,   boolean toInclusive);
NavigableMap&lt;K,V&gt; headMap(K toKey, boolean inclusive);  // less than toKey
NavigableMap&lt;K,V&gt; tailMap(K fromKey, boolean inclusive);
SortedMap&lt;K,V&gt; subMap(K fromKey, K toKey);
SortedMap&lt;K,V&gt; headMap(K toKey);
SortedMap&lt;K,V&gt; tailMap(K fromKey);
</code></pre>
<h3 id="treemap"><a class="header" href="#treemap">TreeMap</a></h3>
<pre><code class="language-java">public class TreeMap&lt;K,V&gt;
    extends AbstractMap&lt;K,V&gt;
    implements NavigableMap&lt;K,V&gt;, Cloneable, java.io.Serializable
{
</code></pre>
<h4 id="æˆå‘˜å˜é‡"><a class="header" href="#æˆå‘˜å˜é‡">æˆå‘˜å˜é‡</a></h4>
<pre><code class="language-java">    // maintain the order Or keep keys'order natural
    private final Comparator&lt;? super K&gt; comparator;
    private transient Entry&lt;K,V&gt; root;
    private transient int size = 0;
    private transient int modCount = 0;
static final class Entry&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; {
        K key;
        V value;
        Entry&lt;K,V&gt; left;
        Entry&lt;K,V&gt; right;
        Entry&lt;K,V&gt; parent;
        boolean color = BLACK;
</code></pre>
<h4 id="æ„é€ å™¨"><a class="header" href="#æ„é€ å™¨">æ„é€ å™¨</a></h4>
<p>æ˜¯å¦è‡ªå¸¦ Comparator æ˜¯å¦ä»å…¶ä»– Map å¤åˆ¶</p>
<pre><code class="language-java">public TreeMap() {
    comparator = null;
}
public TreeMap(Comparator&lt;? super K&gt; comparator) {
    this.comparator = comparator;
}
public TreeMap(Map&lt;? extends K, ? extends V&gt; m) {
    comparator = null;
    putAll(m);
}
public TreeMap(SortedMap&lt;K, ? extends V&gt; m) {
    comparator = m.comparator();
    try {
        buildFromSorted(m.size(), m.entrySet().iterator(), null, null);
    } catch (java.io.IOException cannotHappen) {
    } catch (ClassNotFoundException cannotHappen) {
    }
}
</code></pre>
<h4 id="put"><a class="header" href="#put">Put</a></h4>
<p>put å°±æ˜¯æ™®é€šçš„äºŒå‰æ ‘æ’å…¥ è‹¥ç”¨æˆ·æŒ‡å®šåˆ¤æ–­æ¡ä»¶ï¼Œå°±æŒ‰ç…§æŒ‡å®šçš„æ¡ä»¶åˆ¤æ–­æ’å…¥åæè¿˜æ˜¯æ’å…¥å³æ å¦åˆ™ä½¿ç”¨é»˜è®¤çš„æ¯”è¾ƒæ–¹æ³•
é‡ç‚¹æ˜¯æ’å…¥åè°ƒç”¨äº† fixAfterInsertion(e);</p>
<pre><code class="language-java">public V put(K key, V value) {
    Entry&lt;K,V&gt; t = root;
    if (t == null) {
        compare(key, key); // type (and possibly null) check
        root = new Entry&lt;&gt;(key, value, null);
        size = 1;
        modCount++;
        return null;
    }
    int cmp;
    Entry&lt;K,V&gt; parent;
    // split comparator and comparable paths
    Comparator&lt;? super K&gt; cpr = comparator;
    if (cpr != null) {
        do {
            parent = t;
            cmp = cpr.compare(key, t.key);
            if (cmp &lt; 0)
                t = t.left;
            else if (cmp &gt; 0)
                t = t.right;
            else
                return t.setValue(value);
        } while (t != null);
    }
    else {
        if (key == null)
            throw new NullPointerException();
        @SuppressWarnings(&quot;unchecked&quot;)
            Comparable&lt;? super K&gt; k = (Comparable&lt;? super K&gt;) key;
        do {
            parent = t;
            cmp = k.compareTo(t.key);
            if (cmp &lt; 0)
                t = t.left;
            else if (cmp &gt; 0)
                t = t.right;
            else
                return t.setValue(value);
        } while (t != null);
    }
    Entry&lt;K,V&gt; e = new Entry&lt;&gt;(key, value, parent);
    if (cmp &lt; 0)
        parent.left = e;
    else
        parent.right = e;
    fixAfterInsertion(e);
    size++;
    modCount++;
    return null;
}
</code></pre>
<h4 id="fixafterinsertione"><a class="header" href="#fixafterinsertione">fixAfterInsertion(e);</a></h4>
<h4 id="-1"><a class="header" href="#-1"></a></h4>
<h3 id="hashmap"><a class="header" href="#hashmap">HashMap</a></h3>
<pre><code class="language-java">public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt;
    implements Map&lt;K,V&gt;, Cloneable, Serializable {
</code></pre>
<h4 id="æˆå‘˜å˜é‡-1"><a class="header" href="#æˆå‘˜å˜é‡-1">æˆå‘˜å˜é‡</a></h4>
<ol>
<li><code>private static final long serialVersionUID = 362498820763181265L;</code>ï¼šåºåˆ—åŒ– ID</li>
<li><code>static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16</code>ï¼šæŒ‡å®šé»˜è®¤åˆå§‹é•¿åº¦</li>
<li><code>static final int MAXIMUM_CAPACITY = 1 &lt;&lt; 30;</code>ï¼šæœ€å¤§é•¿åº¦</li>
<li><code>static final float DEFAULT_LOAD_FACTOR = 0.75f;</code>ï¼šè´Ÿè½½å› å­</li>
<li><code>static final int TREEIFY_THRESHOLD = 8;</code>ï¼šç”±é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„ä¸´ç•Œå€¼ 1ï¼ˆé“¾è¡¨é•¿åº¦&gt;8ï¼‰</li>
<li><code>static final int UNTREEIFY_THRESHOLD = 6;</code>ï¼šç”±çº¢é»‘æ ‘è½¬ä¸ºé“¾è¡¨çš„ä¸´ç•Œå€¼</li>
<li><code>static final int MIN_TREEIFY_CAPACITY = 64;</code>ï¼šï¼šç”±é“¾è¡¨è½¬ä¸ºçº¢é»‘æ ‘çš„ä¸´ç•Œå€¼ 2ï¼ˆcapicity&gt;64ï¼‰</li>
</ol>
<ul>
<li>loadFactor å€¼ä¸º 0.75 åŠ è½½å› å­çš„é€‰æ‹©ä¸ Poisson_distribution æœ‰å…³
é“¾è¡¨ 8 å·ä½æœ‰å€¼çš„æ¦‚ç‡æ˜¯ 0.00000006ï¼ˆç†æƒ³éšæœºæƒ…å†µä¸‹ï¼‰ï¼Œå…·ä½“å¯ä»¥æŸ¥çœ‹æºç æ³¨é‡Š
æ›´å¤šçš„æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·è‡ªå·±å®ç°äº†ä¸å¥½çš„å“ˆå¸Œç®—æ³•æ—¶å¯¼è‡´é“¾è¡¨è¿‡é•¿ï¼Œä»è€Œå¯¼è‡´æŸ¥è¯¢æ•ˆç‡ä½ï¼Œè€Œæ­¤æ—¶è½¬ä¸ºçº¢é»‘æ ‘æ›´å¤šçš„æ˜¯ä¸€ç§ä¿åº•ç­–ç•¥ï¼Œç”¨æ¥ä¿è¯æç«¯æƒ…å†µä¸‹æŸ¥è¯¢çš„æ•ˆç‡ã€‚</li>
<li>åˆšå¼€å§‹ä¸ä½¿ç”¨çº¢é»‘æ ‘çš„åŸå› </li>
</ul>
<p>å•ä¸ª TreeNode éœ€è¦å ç”¨çš„ç©ºé—´å¤§çº¦æ˜¯æ™®é€š Node çš„ä¸¤å€ï¼Œæ‰€ä»¥åªæœ‰å½“åŒ…å«è¶³å¤Ÿå¤šçš„ Nodes æ—¶æ‰ä¼šè½¬æˆ TreeNodesï¼Œ
è€Œå½“æ¡¶ä¸­èŠ‚ç‚¹æ•°å°äº 6 æ—¶åˆä¼šå˜å›æ™®é€šçš„é“¾è¡¨çš„å½¢å¼ï¼Œä»¥ä¾¿èŠ‚çœç©ºé—´ï¼Œ</p>
<ul>
<li>é“¾è¡¨è½¬çº¢é»‘æ ‘é€‰æ‹© 8 çº¢é»‘æ ‘å¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸º log(n) é“¾è¡¨å¹³å‡æŸ¥æ‰¾é•¿åº¦ä¸º n/2</li>
</ul>
<h4 id="æ„é€ å™¨-1"><a class="header" href="#æ„é€ å™¨-1">æ„é€ å™¨</a></h4>
<ol>
<li>HashMap æä¾›äº† 4 ç§æ„é€ å™¨ï¼Œå¯ä»¥è‡ªä¸»é€‰æ‹©åˆå§‹é•¿åº¦å’Œè´Ÿè½½å› å­</li>
<li>è‹¥ä¼ å…¥çš„åˆå§‹é•¿åº¦ä¸æ˜¯äºŒæ¬¡å¹‚ï¼Œjava ä¼šè‡ªåŠ¨å°†ç”¨æˆ·ä¼ å…¥çš„ initialCapacity è½¬æ¢ä¸ºæ¯”å®ƒå¤§çš„äºŒè¿›åˆ¶æ•°ï¼Œç›®çš„æ˜¯æ–¹ä¾¿åœ¨æ±‚ç´¢å¼•æ—¶ä½¿ç”¨ä½è¿ç®—æ›´å¿«å–æ¨¡ :::
tip æ³¨æ„ è™½ç„¶åˆ›å»ºäº†æ–°çš„ tableï¼Œä½†æ˜¯æ²¡æœ‰å°† capicity è¿›è¡Œèµ‹å€¼ä»ç„¶æ˜¯é›¶ï¼Œåªå°† loadFactor å’Œ threshold è¿›è¡Œèµ‹å€¼
è¿™ç‚¹éœ€è¦åœ¨ resize() ä¸­ç”¨åˆ° :::</li>
</ol>
<pre><code class="language-java">public HashMap(int initialCapacity, float loadFactor) {
    if (initialCapacity &lt; 0)
        throw new IllegalArgumentException(&quot;Illegal initial capacity: &quot; + initialCapacity);
    // ä¸èƒ½è¶…è¿‡é»˜è®¤æœ€å¤§é•¿åº¦
    if (initialCapacity &gt; MAXIMUM_CAPACITY)
        initialCapacity = MAXIMUM_CAPACITY;
    // è´Ÿè½½å› å­ä¸èƒ½å°äºé›¶
    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))
        throw new IllegalArgumentException(&quot;Illegal load factor: &quot; + loadFactor);
    this.loadFactor = loadFactor;
    // è¿™é‡Œè™½ç„¶ä¸æ˜¯ç”¨`capicity * loadfactory`ä¸ºæ‰©å®¹ä¸´ç•Œå€¼èµ‹å€¼ï¼Œä½†æ˜¯è¿˜ä¼šåœ¨ put æ–¹æ³•é‡Œé‡æ–°ä¿®æ­£
    this.threshold = tableSizeFor(initialCapacity);
}
public HashMap(int initialCapacity) {
    this(initialCapacity, DEFAULT_LOAD_FACTOR);
}

public HashMap() {
    this.loadFactor = DEFAULT_LOAD_FACTOR; // all other fields defaulted
    // æ­¤æ—¶é˜ˆå€¼å’Œå®¹é‡å€¼å¤§å°éƒ½ä¸º 0
}

public HashMap(Map&lt;? extends K, ? extends V&gt; m) {
    this.loadFactor = DEFAULT_LOAD_FACTOR;
    putMapEntries(m, false);
}
</code></pre>
<h4 id="åˆå§‹é•¿åº¦ä¿®æ­£"><a class="header" href="#åˆå§‹é•¿åº¦ä¿®æ­£">åˆå§‹é•¿åº¦ä¿®æ­£</a></h4>
<p>è¿™é‡Œä½¿ç”¨ 5 æ¬¡å³ç§» + æˆ–è¿ç®— ä¸€ä¸‹æ˜¯ä¸¾ä¾‹ï¼š</p>
<pre><code>0000 0000 0000 1010 0000 0011 1110 1010  n
0000 0000 0000 0101 0000 0001 1111 0101  n &gt;&gt;&gt; 1
---------------------------------------  |
0000 0000 0000 1111 0000 0011 1111 1111  n
0000 0000 0000 0011 1100 0000 1111 1111  n &gt;&gt;&gt; 2
---------------------------------------  |
0000 0000 0000 1111 1100 0011 1111 1111  n
0000 0000 0000 0000 1111 1100 0011 1111  n &gt;&gt;&gt; 4
---------------------------------------  |
0000 0000 0000 1111 1111 1111 1111 1111  n
0000 0000 0000 0000 0000 1111 1111 1111  n &gt;&gt;&gt; 8
å‰©ä¸‹çš„å°±ä¸ç”¨å†™äº†å…¨éƒ¨è¢«è½¬æ¢æˆ 1ï¼Œæœ€ååœ¨åŠ ä¸Š 1 å°±æ˜¯ï¼š
&gt;Returns a power of two size for the given target capacity.
</code></pre>
<pre><code class="language-java">static final int tableSizeFor(int cap) {
    int n = cap - 1;
    n |= n &gt;&gt;&gt; 1;
    n |= n &gt;&gt;&gt; 2;
    n |= n &gt;&gt;&gt; 4;
    n |= n &gt;&gt;&gt; 8;
    n |= n &gt;&gt;&gt; 16;
    return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
}
</code></pre>
<h4 id="é“¾è¡¨è½¬çº¢é»‘æ ‘"><a class="header" href="#é“¾è¡¨è½¬çº¢é»‘æ ‘">é“¾è¡¨è½¬çº¢é»‘æ ‘</a></h4>
<p>è‹¥é“¾è¡¨é•¿åº¦&gt;8ï¼Œå°è¯•è½¬ä¸ºçº¢é»‘æ ‘</p>
<pre><code class="language-java">if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st
    treeifyBin(tab, hash);
</code></pre>
<ul>
<li>è‹¥æ£€æµ‹åˆ° size&lt;64ï¼Œæ‰©å®¹ï¼Œä¸è½¬ä¸ºçº¢é»‘æ ‘</li>
</ul>
<pre><code class="language-java">final void treeifyBin(Node&lt;K,V&gt;[] tab, int hash) {
    int n, index; Node&lt;K,V&gt; e;
    if (tab == null || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)
        resize();
</code></pre>
<p>resize æ‰©å®¹åæ‰€æœ‰å…ƒç´ çš„ç´¢å¼•å€¼ä¼šé‡æ–°åˆ†é…ï¼Œé“¾è¡¨é•¿åº¦ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ›´åŠ æ•£åˆ—</p>
<ul>
<li>è‹¥æ£€æµ‹åˆ° size&gt;=64ï¼Œè½¬ä¸ºçº¢é»‘æ ‘
<ol>
<li>é“¾è¡¨è½¬ä¸º LinkedHashMapï¼ˆèŠ‚ç‚¹è½¬ä¸º TreeNodeï¼ŒåŠ å…¥å‘å‰çš„æŒ‡é’ˆå’Œå·¦å³å­—èŠ‚ç‚¹ï¼‰</li>
</ol>
<pre><code class="language-java">else if ((e = tab[index = (n - 1) &amp; hash]) != null) {
    TreeNode&lt;K,V&gt; hd = null, tl = null;
    do {
        TreeNode&lt;K,V&gt; p = replacementTreeNode(e, null);
        if (tl == null)
            hd = p;
        else {
            p.prev = tl;
            tl.next = p;
        }
        tl = p;
    } while ((e = e.next) != null);
</code></pre>
<ol start="2">
<li>
<p>æŠŠæ ¹èŠ‚ç‚¹æ”¾å…¥æ¡¶ä¸­ï¼Œè¿›è¡Œå¹³è¡¡</p>
</li>
<li>
<p>å¾…ç»­</p>
</li>
</ol>
</li>
</ul>
<h4 id="æ‰©å®¹_resize"><a class="header" href="#æ‰©å®¹_resize">æ‰©å®¹_resize</a></h4>
<ol>
<li>
<p>ç¡®å®šæ–°å®¹é‡çš„å¤§å°ï¼š</p>
<ul>
<li>è‹¥ oldCap &gt; 0(æ­£å¸¸æƒ…å†µä¸‹æ‰©å®¹)
<pre><code class="language-java">//ç¿»å€æˆ–è€…è°ƒä¸º MAXIMUM_CAPACITY(æœ¬èº«å°±è¶…è¿‡æœ€å¤§å€¼æˆ–è€…ç¿»å€åä¼šè¶…è¿‡æœ€å¤§å€¼)
if (oldCap &gt; 0) {
    if (oldCap &gt;= MAXIMUM_CAPACITY) {
        threshold = Integer.MAX_VALUE;
        return oldTab;
    }
    else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp;
                oldCap &gt;= DEFAULT_INITIAL_CAPACITY)
        newThr = oldThr &lt;&lt; 1; // double threshold
}
</code></pre>
</li>
<li>è‹¥ oldThr &gt; 0ï¼ˆåˆå§‹åŒ–ä¸‹éœ€è¦æ‰©å®¹ï¼Œæ‰‹åŠ¨é€‰æ‹©åˆå§‹å®¹é‡ï¼‰
<pre><code class="language-java">// ç¡®å®šåˆå§‹é•¿åº¦
else if (oldThr &gt; 0) // initial capacity was placed in threshold
    newCap = oldThr;
</code></pre>
è¿™é‡Œéœ€è¦è¯´æ˜ï¼Œåœ¨æ„é€ å™¨ä¸­æœ‰å¦‚ä¸‹ä»£ç 
<pre><code class="language-java">this.threshold = tableSizeFor(initialCapacity);
// tableSizeFor è¿”å›çš„å°±æ˜¯ Capicityï¼Œåªä¸è¿‡èµ‹å€¼ç»™äº† threshold(ä¹Ÿå°±æ˜¯ oldThr)ï¼Œåœ¨è¿™é‡Œ newCap æ‰è¢«ç¡®å®š
</code></pre>
</li>
<li>è‹¥ oldCap == oldThr == 0ï¼ˆåˆå§‹åŒ–ä¸‹éœ€è¦æ‰©å®¹ï¼Œæ²¡æœ‰æ‰‹åŠ¨é€‰æ‹©åˆå§‹å®¹é‡ï¼‰æŒ‰ç…§é»˜è®¤å€¼è¿›è¡Œåˆå§‹åŒ–
<pre><code class="language-java">else {               // zero initial threshold signifies using defaults
    newCap = DEFAULT_INITIAL_CAPACITY;
    newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
}
</code></pre>
</li>
</ul>
</li>
<li>
<p>ç¡®å®šæ–°çš„æ‰©å®¹è¾¹ç•Œ</p>
<pre><code class="language-java">if (newThr == 0) {
    float ft = (float)newCap * loadFactor;
    newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ?
                (int)ft : Integer.MAX_VALUE);
}
threshold = newThr;
</code></pre>
</li>
<li>
<p>å¼€è¾Ÿæ–°çš„ç©ºé—´ï¼Œé‡æ–°æ’åˆ—åŸæ¥çš„å…ƒç´ </p>
<ul>
<li>å¼€è¾Ÿ</li>
</ul>
<pre><code class="language-java">Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap];
table = newTab;
</code></pre>
<p>è‹¥åŸæ•°ç»„ä¸ä¸ºç©ºï¼ˆä¸æ˜¯åˆšåˆå§‹åŒ–çš„ï¼‰ï¼Œå¾ªç¯åŸ tab</p>
<ul>
<li>ç”¨ e ä»£æ›¿ oldTab</li>
</ul>
<pre><code class="language-java">if (oldTab != null) {
    for (int j = 0; j &lt; oldCap; ++j) {
        Node&lt;K,V&gt; e;
        if ((e = oldTab[j]) != null) {
</code></pre>
<ul>
<li>è‹¥åŸ tab åœ¨ j å¤„ä¸ä¸ºç©º
<ol>
<li>æ¸…ç©ºåŸ table åœ¨ j å¤„çš„å ç”¨
<pre><code class="language-java">oldTab[j] = null;
</code></pre>
</li>
<li>é‡æ–°è®¡ç®—ç´¢å¼•
<ul>
<li>è‹¥ä¸æ˜¯é“¾è¡¨æˆ–çº¢é»‘æ ‘ï¼Œç›´æ¥ç§»åŠ¨</li>
</ul>
<pre><code class="language-java">if (e.next == null)
    newTab[e.hash &amp; (newCap - 1)] = e;
</code></pre>
<ul>
<li>è‹¥æ˜¯çº¢é»‘æ ‘ï¼Œå¾…ç»­</li>
</ul>
<pre><code class="language-java">else if (e instanceof TreeNode)
    ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap);
</code></pre>
<ul>
<li>è‹¥æ˜¯é“¾è¡¨ è¿™é‡Œ e.hash &amp; oldCap ç›´æ¥ä¸äºŒæ¬¡å¹‚ï¼ˆä¸æ˜¯ n-1ï¼‰åš&amp;è¿ç®—
äºŒæ¬¡å¹‚ä½ä½å…¨ä¸ºé›¶ï¼Œä¸ hash åšä¸è¿ç®—åèƒ½å¤Ÿå¾—åˆ°å¾—åˆ°æ–°ç´¢å¼•çš„æœ€é«˜ä½ä¸ºæ˜¯ 0 è¿˜æ˜¯ 1 (e.hash &amp; oldCap) == 0 =&gt;
ç¡®å®šæ–°ç´¢å¼•æ˜¯åŸç´¢å¼•è¿˜æ˜¯åŸç´¢å¼• +n</li>
</ul>
<pre><code class="language-java">    else { // preserve order
        Node&lt;K,V&gt; loHead = null, loTail = null;
        Node&lt;K,V&gt; hiHead = null, hiTail = null;
        Node&lt;K,V&gt; next;
        do {
            next = e.next;
            // åˆ¤æ–­æ–°ç´¢å¼•æœ€é«˜ä¸º
            if ((e.hash &amp; oldCap) == 0) {
                if (loTail == null)
                    loHead = e;
                else
                    //å¦‚æœå¯èƒ½ä¼šæ‹¼æ¥ä¸€ä¸ªæ–°é“¾è¡¨
                    loTail.next = e;
                loTail = e;
            }
            else {
                if (hiTail == null)
                    hiHead = e;
                else
                    hiTail.next = e;
                hiTail = e;
            }
        } while ((e = next) != null);
        // æ–°é“¾è¡¨çš„å¤´èŠ‚ç‚¹è£…å…¥åˆ°æ–°æ¡¶ä¸­
        if (loTail != null) {
            loTail.next = null;
            newTab[j] = loHead;
        }
        if (hiTail != null) {
            hiTail.next = null;
            newTab[j + oldCap] = hiHead;
        }
    }
}
```java
</code></pre>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<h4 id="æ‰©å®¹åçš„ç´¢å¼•è§„å¾‹"><a class="header" href="#æ‰©å®¹åçš„ç´¢å¼•è§„å¾‹">æ‰©å®¹åçš„ç´¢å¼•è§„å¾‹</a></h4>
<p>å‡å¦‚åŸæ•°ç»„é•¿åº¦ n = 16</p>
<ol>
<li>hash &amp; (n-1)</li>
</ol>
<pre><code>- key1 ä¸ 15
1101 1001 0010 1100 1111 000|0 0101  key1.hashCode()
0000 0000 0000 0000 0000 000|0 1111  n - 1
----------------------------------  &amp;
0000 0000 0000 0000 0000 000|0 0101  5
- key1 ä¸ 31
1101 1001 0010 1100 1111 000|0 0101  key1.hashCode()
0000 0000 0000 0000 0000 000|1 1111  n * 2 - 1
----------------------------------  &amp;
0000 0000 0000 0000 0000 000|0 0101  5
- key2 ä¸ 15
1101 1001 0010 1100 1111 001|1 0101  key2.hashCode()
0000 0000 0000 0000 0000 000|0 1111  n - 1
----------------------------------  &amp;
0000 0000 0000 0000 0000 000|0 0101  5
- key2 ä¸ 31
1101 1001 0010 1100 1111 001|1 0101  key2.hashCode()
0000 0000 0000 0000 0000 000|1 1111  n * 2 - 1
----------------------------------  &amp;
0000 0000 0000 0000 0000 000|1 0101  5 + 16
</code></pre>
<p>ç”±ä¸Šå›¾å¯è§ï¼Œæ–°ç´¢å¼•ä½ç½®åªèƒ½æ˜¯åŸç´¢å¼•æˆ–è€…åŸç´¢å¼• +nï¼Œåˆ°åº•æ˜¯é‚£ç§æƒ…å†µåªç”¨çœ‹æ–°ç´¢å¼•é«˜ä½æ˜¯ 0 è¿˜æ˜¯ 1</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¸ç”¨çœŸçš„é‡æ–°è®¡ç®—æ–°ç´¢å¼•ä½ç½®ï¼Œåªéœ€è¦è®¡ç®—é«˜ä½æ˜¯ 0 è¿˜æ˜¯ 1 å³å¯ç¡®å®šæ–°ç´¢å¼•</li>
</ul>
<ol start="2">
<li>hash &amp; n</li>
</ol>
<ul>
<li>key2 ä¸ 16 1101 1001 0010 1100 1111 001|1 0101 key2.hashCode() 0000 0000 0000
0000 0000 000|0 1111 n ---------------------------------- &amp; 0000 0000 0000
0000 0000 000|0 0101 5</li>
<li>key2 ä¸ 32 1101 1001 0010 1100 1111 001|1 0101 key2.hashCode() 0000 0000 0000
0000 0000 000|1 0000 n ---------------------------------- &amp; 0000 0000 0000
0000 0000 000|1 0000 å¾—åˆ°æœ€é«˜ä½ä¸º 1</li>
</ul>
<h4 id="hash-è®¡ç®—æ–¹æ³•"><a class="header" href="#hash-è®¡ç®—æ–¹æ³•">hash è®¡ç®—æ–¹æ³•</a></h4>
<p>å…ˆè°ƒç”¨ key.hashCode()ï¼Œåœ¨äºè‡ªèº«é«˜ä½å¼‚æˆ–</p>
<pre><code class="language-java">static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);
}
</code></pre>
<p>ç¤ºä¾‹</p>
<pre><code>1101 0111 1010 1111 1000 0110 0001 1011  hash
0000 0000 0000 0000 1101 0111 1010 1111  hash &gt;&gt;&gt; 16
---------------------------------------  ^
1101 0111 1010 1111 0101 0001 1011 0100
</code></pre>
<p>åŸå› ï¼š</p>
<ol>
<li>æ··åˆé«˜ä½ä½ä¿¡æ¯</li>
<li>ç¡®ä¿ hash ä¸ä¼šå‘ 0 æˆ– 1 å•ç‹¬é æ‹¢</li>
</ol>
<h4 id="put-1"><a class="header" href="#put-1">put</a></h4>
<ul>
<li>
<p>put è°ƒç”¨ putVal å®ç°</p>
<pre><code class="language-java">public V put(K key, V value) {
    return putVal(hash(key), key, value, false, true);
}
</code></pre>
</li>
<li>
<p>æ–¹æ³•å‚æ•°</p>
<ol>
<li>boolean onlyIfAbsentï¼šåªæœ‰ä¸å­˜åœ¨æ‰æ·»åŠ ï¼ˆå³ä¸ä¿®æ”¹åŸæ•°æ®ï¼‰</li>
<li>boolean evictï¼šå¦‚æœä¸º false è¡¨ç¤ºä¸ºåˆ›å»ºçŠ¶æ€</li>
</ol>
</li>
<li>
<p>å…·ä½“å®ç°</p>
</li>
</ul>
<ol>
<li>å¦‚æœ table == nullï¼Œresize æ–°å»ºæ•°ç»„</li>
</ol>
<pre><code class="language-java">final V putVal(int hash, K key, V value, boolean onlyIfAbsent,
                   boolean evict) {
    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i;
    if ((tab = table) == null || (n = tab.length) == 0)
        n = (tab = resize()).length;
</code></pre>
<ol start="2">
<li>æ’å…¥/æˆ–è®°å½•è¢«ä¿®æ”¹ value çš„èŠ‚ç‚¹ e
<ul>
<li>è‹¥ç´¢å¼•ä½ç½®ä¸ºç©ºï¼Œç›´æ¥æ’å…¥</li>
</ul>
<pre><code class="language-java">if ((p = tab[i = (n - 1) &amp; hash]) == null)
    tab[i] = newNode(hash, key, value, null);
else {
</code></pre>
<ul>
<li>è‹¥ä¸ä¸ºç©ºï¼Œä¸” key ç›¸åŒï¼Œe å°±æ˜¯å½“å‰èŠ‚ç‚¹</li>
</ul>
<pre><code class="language-java">Node&lt;K,V&gt; e; K k;
if (p.hash == hash &amp;&amp;
    ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))
    e = p;
</code></pre>
<ul>
<li>è‹¥ä¸ä¸ºç©ºï¼Œä½†æ˜¯ä¸ºçº¢é»‘æ ‘ï¼ŒæŒ‰ç…§çº¢é»‘æ ‘æ’å…¥</li>
</ul>
<pre><code class="language-java">else if (p instanceof TreeNode)
    e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value);
</code></pre>
<ul>
<li>è‹¥ä¸ä¸ºç©ºä½†æ˜¯ä¸ºé“¾è¡¨ æ‰¾åˆ°ç›¸åŒèŠ‚ç‚¹å°±è®°å½• e æ²¡æ‰¾åˆ°å°±å°¾æ’æ–°ç»“ç‚¹ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è½¬ä¸ºçº¢é»‘æ ‘</li>
</ul>
<pre><code class="language-java">else {
    for (int binCount = 0; ; ++binCount) {
        if ((e = p.next) == null) {
            p.next = newNode(hash, key, value, null);
            if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st
                treeifyBin(tab, hash);
            break;
        }
        if (e.hash == hash &amp;&amp;
            ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))
            break;
        p = e;
    }
}
</code></pre>
</li>
<li>å¦‚æœä¸Šä¸€æ­¥æ²¡æœ‰æ’å…¥æ–°ç»“ç‚¹è€Œæ˜¯å‡†å¤‡è¦†ç›– valueï¼Œå°±åœ¨è¿™ä¸€æ­¥è¦†ç›–</li>
</ol>
<pre><code class="language-java">    if (e != null) { // existing mapping for key
        V oldValue = e.value;
        if (!onlyIfAbsent || oldValue == null)
            e.value = value;
        afterNodeAccess(e);
        return oldValue;
    }
}
</code></pre>
<ol start="4">
<li>fastfail æ£€éªŒï¼Œæ‰©å®¹æ£€éªŒ</li>
</ol>
<pre><code class="language-java">    ++modCount;
    if (++size &gt; threshold)
        resize();
    afterNodeInsertion(evict); // ç©ºå‡½æ•°ï¼Œä¸çŸ¥é“æœ‰å•¥ç”¨
    return null;
}
</code></pre>
<h4 id="remove"><a class="header" href="#remove">remove</a></h4>
<ol>
<li>åˆ¤æ–­ table æ˜¯å¦ä¸ºç©ºï¼Œtable æ˜¯å¦å­˜æœ‰å…ƒç´ ï¼Œè¦æ‰¾çš„ç´¢å¼•ä½ç½®æ˜¯å¦æœ‰å€¼</li>
</ol>
<pre><code class="language-java">final Node&lt;K,V&gt; removeNode(int hash, Object key, Object value,
                               boolean matchValue, boolean movable) {
        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, index;
        if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;
            (p = tab[index = (n - 1) &amp; hash]) != null) {
</code></pre>
<ol start="2">
<li>æ‰¾åˆ°å¾…åˆ é™¤èŠ‚ç‚¹ node è®°å½•
<ul>
<li>index å¤„å°±æ˜¯æ‰€æ‰¾èŠ‚ç‚¹
<pre><code class="language-java">Node&lt;K,V&gt; node = null, e; K k; V v;
if (p.hash == hash &amp;&amp;
    ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))
    node = p;
</code></pre>
</li>
<li>æ˜¯çº¢é»‘æ ‘ï¼ŒæŒ‰ç…§çº¢é»‘æ ‘çš„æ–¹å¼æŸ¥æ‰¾
<pre><code class="language-java">else if ((e = p.next) != null) {
    if (p instanceof TreeNode)
        node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);
</code></pre>
</li>
<li>æ˜¯é“¾è¡¨ï¼ŒæŒ‰ç…§é“¾è¡¨æ–¹å¼æŸ¥æ‰¾
<pre><code class="language-java">    else {
        do {
            if (e.hash == hash &amp;&amp;
                ((k = e.key) == key ||
                    (key != null &amp;&amp; key.equals(k)))) {
                node = e;
                break;
            }
            p = e;
        } while ((e = e.next) != null);
    }
}
</code></pre>
</li>
</ul>
</li>
<li>åˆ é™¤èŠ‚ç‚¹ï¼Œå¤„ç†åäº‹</li>
</ol>
<pre><code class="language-java">        if (node != null &amp;&amp; (!matchValue || (v = node.value) == value ||
                                (value != null &amp;&amp; value.equals(v)))) {
            if (node instanceof TreeNode)
                ((TreeNode&lt;K,V&gt;)node).removeTreeNode(this, tab, movable);
            else if (node == p)
                tab[index] = node.next;
            else
                p.next = node.next;
            ++modCount;
            --size;
            afterNodeRemoval(node);
            return node;
        }
    }
    return null;
}
</code></pre>
<h4 id="å¾…ç»­-7"><a class="header" href="#å¾…ç»­-7">å¾…ç»­...</a></h4>
<h3 id="å¾…ç»­-8"><a class="header" href="#å¾…ç»­-8">å¾…ç»­...</a></h3>
<h2 id="æ ‡è®°æ¥å£"><a class="header" href="#æ ‡è®°æ¥å£">æ ‡è®°æ¥å£</a></h2>
<h3 id="åºåˆ—åŒ–"><a class="header" href="#åºåˆ—åŒ–">åºåˆ—åŒ–</a></h3>
<h4 id="serializable-æ¥å£"><a class="header" href="#serializable-æ¥å£">Serializable æ¥å£</a></h4>
<ul>
<li>åºåˆ—åŒ–å°±æ˜¯å°†å¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ï¼Œååºåˆ—åŒ–å°±æ˜¯æŠŠæŒä¹…åŒ–çš„å­—èŠ‚æ–‡ä»¶æ•°æ®æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ã€‚</li>
<li>å¯¹äº JVM æ¥è¯´ï¼Œè¦è¿›è¡ŒæŒä¹…åŒ–çš„ç±»å¿…é¡»è¦æœ‰ä¸€ä¸ªæ ‡è®°ï¼Œåªæœ‰æŒæœ‰è¿™ä¸ªæ ‡è®° JVM æ‰å…è®¸ç±»åˆ›å»ºçš„å¯¹è±¡å¯ä»¥é€šè¿‡å…¶ IO ç³»ç»Ÿè½¬æ¢ä¸ºå­—èŠ‚æ•°æ®ï¼Œä»è€Œå®ç°æŒä¹…åŒ–ï¼Œè€Œè¿™ä¸ªæ ‡è®°å°±æ˜¯ Serializable æ¥å£ã€‚</li>
<li>è€Œåœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­åˆ™éœ€è¦ä½¿ç”¨ serialVersionUID æ¥ç¡®å®šç”±é‚£ä¸ªç±»æ¥åŠ è½½è¿™ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ç° Serializable æ¥å£çš„æ—¶å€™ï¼Œä¸€èˆ¬è¿˜ä¼šè¦å»å°½é‡æ˜¾ç¤ºåœ°å®šä¹‰ serialVersionUID</li>
</ul>
<pre><code class="language-java">public class MySerializable {
    public static void main(String[] args) {
        write();
        read();
    }

    public static void write() {
        Student student = new Student(1, &quot;zhangsan&quot;);
        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(&quot;src/resources/student.txt&quot;));
        objectOutputStream.writeObject(student);
    }

    public static void read() {
        ObjectInputStream objectInputStream = null;
        objectInputStream = new ObjectInputStream(new FileInputStream(&quot;src/resources/student.txt&quot;));
        Student student = (Student) objectInputStream.readObject();
    }
}
@Data
@AllArgsConstructor
class Student implements Serializable {
    private int id;
    private String name;
}
</code></pre>
<blockquote>
<p>å¦‚æœæˆ‘ä»¬åœ¨åºåˆ—åŒ–ä¸­æ²¡æœ‰æ˜¾ç¤ºåœ°å£°æ˜ serialVersionUIDï¼Œåˆ™åºåˆ—åŒ–è¿è¡Œæ—¶å°†ä¼šæ ¹æ®è¯¥ç±»çš„å„ä¸ªæ–¹é¢è®¡ç®—è¯¥ç±»é»˜è®¤çš„ serialVersionUID å€¼ã€‚&gt;ä½†æ˜¯ï¼ŒJava å®˜æ–¹å¼ºçƒˆå»ºè®®æ‰€æœ‰è¦åºåˆ—åŒ–çš„ç±»éƒ½æ˜¾ç¤ºåœ°å£°æ˜ serialVersionUID å­—æ®µï¼Œå› ä¸ºå¦‚æœé«˜åº¦ä¾èµ–äº JVM é»˜è®¤ç”Ÿæˆ serialVersionUIDï¼Œå¯&gt;èƒ½ä¼šå¯¼è‡´å…¶ä¸ç¼–è¯‘å™¨çš„å®ç°ç»†èŠ‚è€¦åˆï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´åœ¨ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–çš„ InvalidClassException å¼‚å¸¸ã€‚å› æ­¤ï¼Œä¸ºäº†ä¿è¯è·¨ä¸ï¼Ÿ&gt;åŒ Java ç¼–è¯‘å™¨å®ç°çš„ serialVersionUID å€¼çš„ä¸€è‡´ï¼Œå®ç° Serializable æ¥å£çš„å¿…é¡»æ˜¾ç¤ºåœ°å£°æ˜ serialVersionUID å­—æ®µã€‚<br/></p>
</blockquote>
<blockquote>
<p>æ­¤å¤– serialVersionUID å­—æ®µåœ°å£°æ˜è¦å°½å¯èƒ½ä½¿ç”¨ private å…³é”®å­—ä¿®é¥°ï¼Œè¿™æ˜¯å› ä¸ºè¯¥å­—æ®µçš„å£°æ˜åªé€‚ç”¨äºå£°æ˜çš„ç±»ï¼Œè¯¥å­—æ®µä½œä¸ºæˆå‘˜å˜é‡è¢«å­&gt;ç±»ç»§æ‰¿æ˜¯æ²¡æœ‰ç”¨å¤„çš„ï¼æœ‰ä¸ªç‰¹æ®Šçš„åœ°æ–¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°ç»„ç±»æ˜¯ä¸èƒ½æ˜¾ç¤ºåœ°å£°æ˜ serialVersionUID çš„ï¼Œå› ä¸ºå®ƒä»¬å§‹ç»ˆå…·æœ‰é»˜è®¤è®¡ç®—çš„å€¼ï¼Œä¸è¿‡&gt;æ•°ç»„ç±»ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯æ”¾å¼ƒäº†åŒ¹é… serialVersionUID å€¼çš„è¦æ±‚ã€‚</p>
</blockquote>
<h4 id="transient"><a class="header" href="#transient">transient</a></h4>
<ul>
<li>åœ¨å®ç° Serializable æ¥å£åå¯ä»¥ç”¨è¯¥å…³é”®å­—ä¿®é¥°ï¼Œè®©è¿™ä¸ªå±æ€§ä¸åºåˆ—åŒ–</li>
<li>ä½†æ˜¯ç”¨ static ä¿®é¥°åï¼Œä¸€å®šä¸ä¼šè¢«åºåˆ—åŒ–</li>
<li>è‹¥é€‰æ‹©å®ç° Externalizable æ¥å£ï¼Œåˆ™å±æ€§æ˜¯å¦è¿›è¡Œåºåˆ—åŒ–éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼Œä¸æ˜¯å¦æœ‰ transient å…³é”®å­—æ— å…³</li>
</ul>
<h3 id="randomaccess"><a class="header" href="#randomaccess">RandomAccess</a></h3>
<ol>
<li>æ¦‚è¿° RandomAccess æ˜¯ä¸€ä¸ªç©ºçš„æ¥å£ï¼Œå®ƒç”¨æ¥æ ‡è¯†æŸä¸ªç±»æ˜¯å¦æ”¯æŒ
éšæœºè®¿é—®ï¼ˆéšæœºè®¿é—®ï¼Œç›¸å¯¹æ¯”â€œæŒ‰é¡ºåºè®¿é—®â€ï¼‰ã€‚ä¸€ä¸ªæ”¯æŒéšæœºè®¿é—®çš„ç±»æ˜æ˜¾å¯ä»¥ä½¿ç”¨æ›´åŠ é«˜æ•ˆçš„ç®—æ³•ã€‚</li>
</ol>
<pre><code class="language-java">public interface RandomAccess {
}
</code></pre>
<ul>
<li>List ä¸­æ”¯æŒéšæœºè®¿é—®æœ€ä½³çš„ä¾‹å­å°±æ˜¯ ArrayListï¼Œå®ƒçš„æ•°æ®ç»“æ„ä½¿å¾— get(), set(), add() ç­‰æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1);</li>
<li>åä¾‹å°±æ˜¯ LinkedListï¼Œé“¾è¡¨ç»“æ„ä½¿å¾—å®ƒä¸æ”¯æŒéšæœºè®¿é—®ï¼Œåªèƒ½æŒ‰åºè®¿é—®ï¼Œå› æ­¤åœ¨ä¸€äº›æ“ä½œä¸Šæ€§èƒ½ç•¥é€Šä¸€ç­¹ã€‚</li>
</ul>
<ol start="2">
<li>ä¾‹å­</li>
</ol>
<ul>
<li>é€šå¸¸åœ¨æ“ä½œä¸€ä¸ª List å¯¹è±¡æ—¶ï¼Œé€šå¸¸ä¼šåˆ¤æ–­æ˜¯å¦æ”¯æŒ éšæœºè®¿é—®ï¼Œä¹Ÿå°±æ˜¯* æ˜¯å¦ä¸º RandomAccess çš„å®ä¾‹*ï¼Œä»è€Œä½¿ç”¨ä¸åŒçš„ç®—æ³•ã€‚æ¯”å¦‚éå†ï¼Œå®ç°äº†
RandomAccess çš„é›†åˆä½¿ç”¨ get():</li>
</ul>
<pre><code class="language-java">for (int i=0, n=list.size(); i &amp;lt; n; i++)
          list.get(i);
</code></pre>
<p>æ¯”ç”¨è¿­ä»£å™¨æ›´å¿«ï¼š</p>
<pre><code class="language-java">for (Iterator i=list.iterator(); i.hasNext(); )
    i.next();
</code></pre>
<blockquote>
<p>å®ç°äº† RandomAccess æ¥å£çš„ç±»æœ‰ï¼šArrayList, AttributeList, CopyOnWriteArrayList,
Vector, Stack ç­‰ã€‚</p>
</blockquote>
<h3 id="cloneable"><a class="header" href="#cloneable">Cloneable</a></h3>
<h4 id="æµ…æ‹·è´"><a class="header" href="#æµ…æ‹·è´">æµ…æ‹·è´</a></h4>
<ol>
<li>æ¦‚è¿° å®ç°äº† Cloneable æ¥å£çš„å¯¹è±¡èƒ½è¿›è¡Œå…‹éš†ï¼ŒObject å®ç°äº†å…ˆæ‹·è´</li>
</ol>
<pre><code class="language-java">public interface Cloneable {
}
</code></pre>
<p>clon æ–¹æ³•å† Object ç±»ä¸­å®šä¹‰</p>
<pre><code class="language-java">protected native Object clone() throws CloneNotSupportedException;
</code></pre>
<ol start="2">
<li>å¼•ä¾‹</li>
</ol>
<ul>
<li>è¿™é‡Œå…ˆå®šä¹‰ä¸€ä¸ªå­¦ç”Ÿ</li>
</ul>
<pre><code class="language-java">@Data
@AllArgsConstructor
class Student implements Cloneable{
    String name;
    Address address;

    @Override
    protected Object clone() throws CloneNotSupportedException {
        return super.clone();
    }
}
</code></pre>
<ul>
<li>student2 ç”± student æµ…æ‹·è´å¾—åˆ°</li>
</ul>
<pre><code class="language-java">Student student = new Student(&quot;a&quot;, address1);
Student student2 = (Student) student.clone();
</code></pre>
<ul>
<li>student == student2 =&gt; False</li>
<li>student.address == student2.address =&gt; True ä¸¤äººçš„åœ°å€ä¸åŒï¼Œä½†æ˜¯â€œåœ°å€â€æ‰€æŒ‡å‘çš„åœ°å€ç›¸åŒ</li>
</ul>
<h4 id="æ·±æ‹·è´"><a class="header" href="#æ·±æ‹·è´">æ·±æ‹·è´</a></h4>
<ol>
<li>å®ç° Cloneable æ¥å£å¹¶é‡å†™ Object ç±»ä¸­çš„ clone() æ–¹æ³•ï¼›</li>
</ol>
<ul>
<li>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æƒ³è¦å®ç° address ä¹Ÿä¸ç›¸åŒå¯ä»¥åœ¨é‡å†™ clone() åŠ ä¸Š
<code>stu.addr = (Address)addr.clone();   //æ·±åº¦å¤åˆ¶</code></p>
</li>
<li>
<p>ç¼ºç‚¹ï¼š
å¦‚æœå¼•ç”¨ç±»å‹é‡Œé¢è¿˜åŒ…å«å¾ˆå¤šå¼•ç”¨ç±»å‹ï¼Œæˆ–è€…å†…å±‚å¼•ç”¨ç±»å‹çš„ç±»é‡Œé¢åˆåŒ…å«å¼•ç”¨ç±»å‹ï¼Œä½¿ç”¨ clone æ–¹æ³•å°±ä¼šå¾ˆéº»çƒ¦ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ç”¨åºåˆ—åŒ–çš„æ–¹å¼æ¥å®ç°å¯¹è±¡çš„æ·±å…‹éš†ã€‚</p>
</li>
</ul>
<ol start="2">
<li>å®ç° Serializable æ¥å£ï¼Œé€šè¿‡å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°å…‹éš†ï¼Œå¯ä»¥å®ç°çœŸæ­£çš„æ·±åº¦å…‹éš†ã€‚</li>
</ol>
<ul>
<li>
<p>æ‰‹åŠ¨å†™æ–°çš„ clone æ–¹æ³•</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šéœ€è¦å¯¹è±¡åŠå¯¹è±¡æ‰€æœ‰çš„å¯¹è±¡å±æ€§éƒ½å®ç°åºåˆ—åŒ–</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ul>
<pre><code class="language-java">public class DeepClone {
    public static void main(String[] args) {
        Inner inner = new Inner();
        Outer outer = new Outer(inner);
        Outer outer1 = outer.myClone();
        System.out.println(outer.inner == outer1.inner); // False
    }
}

@AllArgsConstructor
class Outer implements Serializable {
    private static final long serialVersionUID = 369285298572941L;  //æœ€å¥½æ˜¯æ˜¾å¼å£°æ˜ ID
    public Inner inner;
    public Outer myClone() {
        Outer outer = null;
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(baos);
        oos.writeObject(this);
        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());
        ObjectInputStream ois = new ObjectInputStream(bais);
        outer = (Outer) ois.readObject();
        return outer;
    }
}

class Inner implements Serializable {
    private static final long serialVersionUID = 872390113109L; //æœ€å¥½æ˜¯æ˜¾å¼å£°æ˜ ID
}
</code></pre>
<p>::: tip æ³¨æ„
æ³¨æ„ï¼šåŸºäºåºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°çš„å…‹éš†ä¸ä»…ä»…æ˜¯æ·±åº¦å…‹éš†ï¼Œæ›´é‡è¦çš„æ˜¯é€šè¿‡æ³›å‹é™å®šï¼Œå¯ä»¥æ£€æŸ¥å‡ºè¦å…‹éš†çš„å¯¹è±¡æ˜¯å¦æ”¯æŒåºåˆ—åŒ–ï¼Œè¿™é¡¹æ£€æŸ¥æ˜¯ç¼–è¯‘å™¨å®Œæˆçš„ï¼Œä¸æ˜¯åœ¨è¿è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™ç§æ˜¯æ–¹æ¡ˆæ˜æ˜¾ä¼˜äºä½¿ç”¨ Object ç±»çš„ clone æ–¹æ³•å…‹éš†å¯¹è±¡ã€‚è®©é—®é¢˜åœ¨ç¼–è¯‘çš„æ—¶å€™æš´éœ²å‡ºæ¥æ€»æ˜¯ä¼˜äºæŠŠé—®é¢˜ç•™åˆ°è¿è¡Œæ—¶ã€‚
:::</p>
<h3 id="å¾…ç»­-9"><a class="header" href="#å¾…ç»­-9">å¾…ç»­...</a></h3>
<h2 id="å‡½æ•°å¼æ¥å£"><a class="header" href="#å‡½æ•°å¼æ¥å£">å‡½æ•°å¼æ¥å£</a></h2>
<h3 id="æ¦‚è¿°-4"><a class="header" href="#æ¦‚è¿°-4">æ¦‚è¿°</a></h3>
<p><code>@FunctionalInterface</code></p>
<ol>
<li>ç‰¹å¾</li>
</ol>
<ul>
<li>è¯¥æ³¨è§£åªèƒ½æ ‡è®°åœ¨&quot;æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•&quot;çš„æ¥å£ä¸Šã€‚</li>
<li>JDK8 æ¥å£ä¸­çš„é™æ€æ–¹æ³•å’Œé»˜è®¤æ–¹æ³•ï¼Œéƒ½ä¸ç®—æ˜¯æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>æ¥å£é»˜è®¤ç»§æ‰¿ java.lang.Objectï¼Œæ‰€ä»¥å¦‚æœæ¥å£æ˜¾ç¤ºå£°æ˜è¦†ç›–äº† Object ä¸­æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿä¸ç®—æŠ½è±¡æ–¹æ³•ã€‚</li>
<li>è¯¥æ³¨è§£ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸€ä¸ªæ¥å£ç¬¦åˆ&quot;å‡½æ•°å¼æ¥å£&quot;å®šä¹‰ï¼Œé‚£ä¹ˆåŠ ä¸åŠ è¯¥æ³¨è§£éƒ½æ²¡æœ‰å½±å“ã€‚åŠ ä¸Šè¯¥æ³¨è§£èƒ½å¤Ÿæ›´å¥½åœ°è®©ç¼–è¯‘å™¨è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœç¼–å†™çš„ä¸æ˜¯å‡½æ•°å¼æ¥å£ï¼Œä½†æ˜¯åŠ ä¸Šäº† @FunctionInterfaceï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚</li>
</ul>
<ol start="2">
<li>ç¤ºä¾‹</li>
</ol>
<pre><code class="language-java">// æ­£ç¡®çš„å‡½æ•°å¼æ¥å£
@FunctionalInterface
public interface TestInterface {

    // æŠ½è±¡æ–¹æ³•
    public void sub();

    // java.lang.Object ä¸­çš„æ–¹æ³•ä¸æ˜¯æŠ½è±¡æ–¹æ³•
    public boolean equals(Object var1);

    // default ä¸æ˜¯æŠ½è±¡æ–¹æ³•
    public default void defaultMethod(){}

    // static ä¸æ˜¯æŠ½è±¡æ–¹æ³•
    public static void staticMethod(){}
}
</code></pre>
<h3 id="consumer"><a class="header" href="#consumer">Consumer</a></h3>
<h4 id="consumer-1"><a class="header" href="#consumer-1">Consumer</a></h4>
<ol>
<li>å®šä¹‰</li>
</ol>
<ul>
<li>å®ƒä¸æ˜¯ç”Ÿäº§ä¸€ä¸ªæ•°æ®ï¼Œè€Œæ˜¯æ¶ˆè´¹ä¸€ä¸ªæ•°æ®ï¼Œå…¶æ•°æ®ç±»å‹ç”±æ³›å‹å†³å®š</li>
<li>æ³›å‹æŒ‡å®šä»€ä¹ˆç±»å‹ï¼Œå°±å¯ä»¥ä½¿ç”¨ accept æ–¹æ³•æ¶ˆè´¹ä»€ä¹ˆç±»å‹çš„æ•°æ®</li>
<li>è‡³äºå…·ä½“æ€ä¹ˆæ¶ˆè´¹ (ä½¿ç”¨)ï¼Œéœ€è¦è‡ªå®šä¹‰</li>
</ul>
<pre><code class="language-java">@FunctionalInterface
public interface Consumer&lt;T&gt; {

    void accept(T t);

    default Consumer&lt;T&gt; andThen(Consumer&lt;? super T&gt; after) {
        Objects.requireNonNull(after);
        return (T t) -&gt; { accept(t); after.accept(t); };
    }
}
</code></pre>
<h4 id="bicomsumer"><a class="header" href="#bicomsumer">BiComsumer</a></h4>
<p>ä¸ Consumer ç±»ä¼¼</p>
<pre><code class="language-java">@FunctionalInterface
public interface BiConsumer&lt;T, U&gt; {
    void accept(T t, U u);
default BiConsumer&lt;T, U&gt; andThen(BiConsumer&lt;? super T, ? super U&gt; after) {
    Objects.requireNonNull(after);
    return (l, r) -&gt; {
        accept(l, r);
        after.accept(l, r);
    };
}
</code></pre>
<ol start="2">
<li>ç¤ºä¾‹ Iterable æ¥å£ï¼Œç”¨æ³•å’Œ Thread ç±»ä¼¼</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    List&lt;String&gt; list = new ArrayList&lt;&gt;();
    list.add(&quot;1&quot;);
    list.add(&quot;1&quot;);
    Consumer consumer = new Consumer() {
        @Override
        public void accept(Object o) {
            System.out.println(o);
        }
    };
    list.forEach(consumer);
}
</code></pre>
<h3 id="predicate"><a class="header" href="#predicate">Predicate</a></h3>
<ol>
<li>ç‰¹æ€§</li>
</ol>
<ul>
<li>JDK8 æä¾›çš„å‡½æ•°å¼æ¥å£</li>
<li>æä¾›ä¸€ä¸ªæŠ½è±¡æ–¹æ³• testï¼Œæ¥å—ä¸€ä¸ªå‚æ•°ï¼Œæ ¹æ®è¿™ä¸ªå‚æ•°è¿›è¡Œä¸€äº›åˆ¤æ–­ï¼Œè¿”å›åˆ¤æ–­ç»“æœ true / false</li>
<li>æä¾›å‡ ä¸ªé»˜è®¤çš„ default æ–¹æ³•ï¼Œand, or, negate ç”¨äºè¿›è¡Œç»„åˆåˆ¤æ–­</li>
<li>åœ¨æµä¸­è¢«å¹¿æ³›ä½¿ç”¨</li>
</ul>
<ol start="2">
<li>å®šä¹‰</li>
</ol>
<pre><code class="language-java">@FunctionalInterface
public interface MyPredict&lt;T&gt; {
    // jdk 1.8

    boolean test(T t);

    default Predicate&lt;T&gt; and(Predicate&lt;? super T&gt; other) {
        Objects.requireNonNull(other);
        return (t) -&gt; test(t) &amp;&amp; other.test(t);
    }
    default Predicate&lt;T&gt; negate() {
        return (t) -&gt; !test(t);
    }
    default Predicate&lt;T&gt; or(Predicate&lt;? super T&gt; other) {
        Objects.requireNonNull(other);
        return (t) -&gt; test(t) || other.test(t);
    }
    static &lt;T&gt; Predicate&lt;T&gt; isEqual(Object targetRef) {
        return (null == targetRef)
                ? Objects::isNull
                : object -&gt; targetRef.equals(object);
    }
    // jdk 11
    static &lt;T&gt; Predicate&lt;T&gt; not(Predicate&lt;? super T&gt; target) {
        Objects.requireNonNull(target);
        return (Predicate&lt;T&gt;)target.negate();
    }
}
</code></pre>
<ol start="3">
<li>ç¤ºä¾‹</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    Predicate predicate = &quot;Yes&quot;::equals;   // lambda è¡¨è¾¾å¼
    Predicate predicate2 = o -&gt; !&quot;No&quot;.equals(o);
    System.out.println(predicate.test(&quot;Yes&quot;));
    System.out.println(predicate.and(predicate2).test(&quot;Yes&quot;));;
}
</code></pre>
<h3 id="function"><a class="header" href="#function">Function</a></h3>
<h4 id="function-1"><a class="header" href="#function-1">Function</a></h4>
<ol>
<li>ç‰¹æ€§ Function æ¥å£çš„ä¸»è¦ä½œç”¨æ˜¯å°†ä¸€ä¸ªç»™å®šçš„å¯¹è±¡è¿›è¡ŒåŠ å·¥ï¼Œç„¶åè¿”å›åŠ å·¥åçš„å¯¹è±¡ï¼Œè¿™ä¸ªåŠ å·¥å¯ä»¥æ˜¯ä»»ä½•æ“ä½œã€‚</li>
<li>å®šä¹‰</li>
</ol>
<pre><code class="language-java">public interface MyFunction&lt;T, R&gt; {
    R apply(T t);

    default &lt;V&gt; Function&lt;V, R&gt; compose(Function&lt;? super V, ? extends T&gt; before) {
        Objects.requireNonNull(before);
        return (V v) -&gt; apply(before.apply(v));
    }

    default &lt;V&gt; Function&lt;T, V&gt; andThen(Function&lt;? super R, ? extends V&gt; after) {
        Objects.requireNonNull(after);
        return (T t) -&gt; after.apply(apply(t));
    }

    static &lt;T&gt; Function&lt;T, T&gt; identity() {
        return t -&gt; t;
    }

}
</code></pre>
<ol start="3">
<li>ç¤ºä¾‹</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    Function&lt;String, Integer&gt; f1 = (t) -&gt; Integer.valueOf(t) * 10;
    System.out.println(f1.apply(&quot;3&quot;));
    // è¿”å›è‡ªå·±
    System.out.println(Function.identity().apply(&quot;3&quot;));
    // apply åæ‰§è¡Œ
    System.out.println(f1.andThen((r) -&gt; String.valueOf(r) + &quot;.....&quot;).apply(&quot;4&quot;));
    // apply å‰æ‰§è¡Œ
    System.out.println(f1.compose((String r) -&gt; r.substring(1)).apply(&quot;a5&quot;));
}
</code></pre>
<h4 id="bifunction"><a class="header" href="#bifunction">BiFunction</a></h4>
<pre><code class="language-java">@FunctionalInterface
public interface BiFunction&lt;T, U, R&gt; {
    R apply(T t, U u);
    default &lt;V&gt; BiFunction&lt;T, U, V&gt; andThen(Function&lt;? super R, ? extends V&gt; after) {
        Objects.requireNonNull(after);
        return (T t, U u) -&gt; after.apply(apply(t, u));
    }
</code></pre>
<h3 id="unaryoperator"><a class="header" href="#unaryoperator">UnaryOperator</a></h3>
<ol>
<li>å®šä¹‰</li>
</ol>
<pre><code class="language-java">@FunctionalInterface
public interface MyUnaryOperator&lt;T&gt; extends Function&lt;T, T&gt; {
    static &lt;T&gt; UnaryOperator&lt;T&gt; identity() {
        return t -&gt; t;
    }
}
`
</code></pre>
<ol start="2">
<li>ç¤ºä¾‹</li>
</ol>
<pre><code class="language-java">public static void main(String[] args) {
    UnaryOperator&lt;Integer&gt; unaryOperator = x -&gt; x + 1;
    System.out.println(unaryOperator.apply(10)); // 11
    UnaryOperator&lt;String&gt; unaryOperator1 = x -&gt; x + 1;
    System.out.println(unaryOperator1.apply(&quot;aa&quot;)); // aa1
}
</code></pre>
<h3 id="compare"><a class="header" href="#compare">Compare</a></h3>
<h4 id="comparable"><a class="header" href="#comparable">Comparable</a></h4>
<ul>
<li>Comparable æ˜¯æ’åºæ¥å£ã€‚</li>
<li>è‹¥ä¸€ä¸ªç±»å®ç°äº† Comparable æ¥å£ï¼Œå°±æ„å‘³ç€â€œè¯¥ç±»æ”¯æŒæ’åºâ€ã€‚</li>
</ul>
<pre><code class="language-java">public interface Comparable&lt;T&gt; {
        public int compareTo(T o);
}
</code></pre>
<h4 id="comparator"><a class="header" href="#comparator">Comparator</a></h4>
<h5 id="æºç "><a class="header" href="#æºç ">æºç </a></h5>
<pre><code class="language-java">@FunctionalInterface
public interface MyComparator&lt;T&gt; {

    // jdk 1.2
    int compare(T o1, T o2);
    boolean equals(Object obj);

    // jdk 1.8
    //default Comparator&lt;T&gt; reversed() {
    //    return Collections.reverseOrder(this);
    //}

    default Comparator&lt;T&gt; thenComparing(Comparator&lt;? super T&gt; other) {
        Objects.requireNonNull(other);
        return (Comparator&lt;T&gt; &amp; Serializable) (c1, c2) -&gt; {
            int res = compare(c1, c2);
            return (res != 0) ? res : other.compare(c1, c2);
        };
    }
    default &lt;U&gt; Comparator&lt;T&gt; thenComparing(
            Function&lt;? super T, ? extends U&gt; keyExtractor,
            Comparator&lt;? super U&gt; keyComparator)
    {
        return thenComparing(comparing(keyExtractor, keyComparator));
    }
    default &lt;U extends Comparable&lt;? super U&gt;&gt; Comparator&lt;T&gt; thenComparing(
            Function&lt;? super T, ? extends U&gt; keyExtractor)
    {
        return thenComparing(comparing(keyExtractor));
    }

    default Comparator&lt;T&gt; thenComparingInt(ToIntFunction&lt;? super T&gt; keyExtractor) {
        return thenComparing(comparingInt(keyExtractor));
    }
    default Comparator&lt;T&gt; thenComparingLong(ToLongFunction&lt;? super T&gt; keyExtractor) {
        return thenComparing(comparingLong(keyExtractor));
    }
    default Comparator&lt;T&gt; thenComparingDouble(ToDoubleFunction&lt;? super T&gt; keyExtractor) {
        return thenComparing(comparingDouble(keyExtractor));
    }

    public static &lt;T extends Comparable&lt;? super T&gt;&gt; Comparator&lt;T&gt; reverseOrder() {
        return Collections.reverseOrder();
    }
    public static &lt;T extends Comparable&lt;? super T&gt;&gt; Comparator&lt;T&gt; naturalOrder() {
        return (Comparator&lt;T&gt;) Comparators.NaturalOrderComparator.INSTANCE;
    }
    public static &lt;T&gt; Comparator&lt;T&gt; nullsFirst(Comparator&lt;? super T&gt; comparator) {
        return new Comparators.NullComparator&lt;&gt;(true, comparator);
    }
    public static &lt;T&gt; Comparator&lt;T&gt; nullsLast(Comparator&lt;? super T&gt; comparator) {
        return new Comparators.NullComparator&lt;&gt;(false, comparator);
    }
    public static &lt;T, U&gt; Comparator&lt;T&gt; comparing(
            Function&lt;? super T, ? extends U&gt; keyExtractor,
            Comparator&lt;? super U&gt; keyComparator)
    {
        Objects.requireNonNull(keyExtractor);
        Objects.requireNonNull(keyComparator);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; keyComparator.compare(keyExtractor.apply(c1),
                        keyExtractor.apply(c2));
    }
    public static &lt;T, U extends Comparable&lt;? super U&gt;&gt; Comparator&lt;T&gt; comparing(
            Function&lt;? super T, ? extends U&gt; keyExtractor)
    {
        Objects.requireNonNull(keyExtractor);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; keyExtractor.apply(c1).compareTo(keyExtractor.apply(c2));
    }
    public static &lt;T&gt; Comparator&lt;T&gt; comparingInt(ToIntFunction&lt;? super T&gt; keyExtractor) {
        Objects.requireNonNull(keyExtractor);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; Integer.compare(keyExtractor.applyAsInt(c1), keyExtractor.applyAsInt(c2));
    }
    public static &lt;T&gt; Comparator&lt;T&gt; comparingLong(ToLongFunction&lt;? super T&gt; keyExtractor) {
        Objects.requireNonNull(keyExtractor);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; Long.compare(keyExtractor.applyAsLong(c1), keyExtractor.applyAsLong(c2));
    }
    public static&lt;T&gt; Comparator&lt;T&gt; comparingDouble(ToDoubleFunction&lt;? super T&gt; keyExtractor) {
        Objects.requireNonNull(keyExtractor);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; Double.compare(keyExtractor.applyAsDouble(c1), keyExtractor.applyAsDouble(c2));
    }
}
</code></pre>
<h5 id="æ–¹æ³•è§£é‡Š"><a class="header" href="#æ–¹æ³•è§£é‡Š">æ–¹æ³•è§£é‡Š</a></h5>
<ol>
<li>thenComparing</li>
</ol>
<ul>
<li>&amp;æ˜¯ java8 æ–°è¯­æ³•</li>
</ul>
<pre><code class="language-java">// (Comparator&lt;T&gt; &amp; Serializable) == (Comparator&lt;T&gt;) (Serializable)
default Comparator&lt;T&gt; thenComparing(Comparator&lt;? super T&gt; other) {
    Objects.requireNonNull(other);
    return (Comparator&lt;T&gt; &amp; Serializable) (c1, c2) -&gt; {
        int res = compare(c1, c2);
        return (res != 0) ? res : other.compare(c1, c2);
    };
}
</code></pre>
<ul>
<li>ç¤ºä¾‹</li>
</ul>
<pre><code class="language-java">public static void main(String[] args) {
    Comparator comparator = new Comparator() {
        @Override
        public int compare(Object o1, Object o2) {
            return (o1 != o2) ? 1 : 0;
        }
    };
    System.out.println(comparator.compare(&quot;111&quot;, &quot;111&quot;));
    System.out.println(comparator.thenComparing((o1, o2) -&gt; (o1 == o2) ? 1 : 0).compare(&quot;111&quot;, &quot;111&quot;));
}
</code></pre>
<ol start="2">
<li>comparing</li>
</ol>
<ul>
<li>åˆ©ç”¨ Function å…ˆå¤„ç†å†æ¯”è¾ƒ</li>
</ul>
<pre><code class="language-java">public static &lt;T, U&gt; Comparator&lt;T&gt; comparing(   Function&lt;? super T, ? extends U&gt; keyExtractor,
                                                Comparator&lt;? super U&gt; keyComparator) {
        Objects.requireNonNull(keyExtractor);
        Objects.requireNonNull(keyComparator);
        return (Comparator&lt;T&gt; &amp; Serializable)
                (c1, c2) -&gt; keyComparator.compare(keyExtractor.apply(c1),
                        keyExtractor.apply(c2));
    }
</code></pre>
<ol start="3">
<li>reverseOrder</li>
</ol>
<ul>
<li>åˆ©ç”¨ Collections å®ç°</li>
</ul>
<pre><code class="language-java">public static &lt;T extends Comparable&lt;? super T&gt;&gt; Comparator&lt;T&gt; reverseOrder() {
    return Collections.reverseOrder();
}
</code></pre>
<h3 id="å¾…ç»­-10"><a class="header" href="#å¾…ç»­-10">å¾…ç»­...</a></h3>
<h2 id="å…¶ä»–"><a class="header" href="#å…¶ä»–">å…¶ä»–</a></h2>
<h3 id="object"><a class="header" href="#object">Object</a></h3>
<ol>
<li>æ¦‚è¿°</li>
</ol>
<ul>
<li>@HotSpotIntrinsicCandidate</li>
<li>è‡ª JDK 9 å¼•å…¥</li>
<li>ä½œç”¨ï¼š
è¢« @HotSpotIntrinsicCandidate æ ‡æ³¨çš„æ–¹æ³•ï¼Œåœ¨ HotSpot ä¸­éƒ½æœ‰ä¸€å¥—é«˜æ•ˆçš„å®ç°ï¼Œè¯¥é«˜æ•ˆå®ç°åŸºäº CPU æŒ‡ä»¤ï¼Œè¿è¡Œæ—¶ï¼ŒHotSpot ç»´æŠ¤çš„é«˜æ•ˆå®ç°ä¼šæ›¿ä»£ JDK çš„æºç å®ç°ï¼Œä»è€Œè·å¾—æ›´é«˜çš„æ•ˆç‡ã€‚</li>
</ul>
<ol start="2">
<li>æºç </li>
</ol>
<pre><code class="language-java">public class MyObject {
    //@HotSpotIntrinsicCandidate
    public Object() {}
    //@HotSpotIntrinsicCandidate
    public final native Class&lt;?&gt; getClass();
    @HotSpotIntrinsicCandidate
    public native int hashCode();
    public boolean equals(Object obj) {
        return (this == obj);
    }
    @HotSpotIntrinsicCandidate
    protected native Object clone() throws CloneNotSupportedException;
    public String toString() {
        return getClass().getName() + &quot;@&quot; + Integer.toHexString(hashCode());
    }
    @HotSpotIntrinsicCandidate
    public final native void notify();
    @HotSpotIntrinsicCandidate
    public final native void notifyAll();
    public final void wait() throws InterruptedException {
        wait(0L);
    }
    public final native void wait(long timeoutMillis) throws InterruptedException;
    public final void wait(long timeoutMillis, int nanos) throws InterruptedException {
        if (timeoutMillis &lt; 0) {
            throw new IllegalArgumentException(&quot;timeoutMillis value is negative&quot;);
        }
        if (nanos &lt; 0 || nanos &gt; 999999) {
            throw new IllegalArgumentException(
                    &quot;nanosecond timeout value out of range&quot;);
        }
        if (nanos &gt; 0 &amp;&amp; timeoutMillis &lt; Long.MAX_VALUE) {
            timeoutMillis++;
        }
        wait(timeoutMillis);
    }
    @Deprecated(since=&quot;9&quot;)
    protected void finalize() throws Throwable { }
}
</code></pre>
<h2 id="å¾…ç»­-11"><a class="header" href="#å¾…ç»­-11">å¾…ç»­...</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="java-2"><a class="header" href="#java-2">java</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frontend"><a class="header" href="#frontend">frontend</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å®ç°ä¸€ä¸ª-mini-bundle"><a class="header" href="#å®ç°ä¸€ä¸ª-mini-bundle">å®ç°ä¸€ä¸ª mini-bundle</a></h1>
<pre><code class="language-js">const fs = require(&quot;fs&quot;);
const path = require(&quot;path&quot;);
const babylon = require(&quot;babylon&quot;);
const traverse = require(&quot;babel-traverse&quot;).default;
const babel = require(&quot;babel-core&quot;);

let ID = 0;

// æ ¹æ®æ–‡ä»¶åï¼Œæ‹¿åˆ°è¯¥æ–‡ä»¶çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ idï¼Œcode(è½¬æ¢åçš„), requirements
function createAsset(filename) {
  // é€šè¿‡ fs å¼•å…¥å…¥å£æ–‡ä»¶
  const content = fs.readFileSync(filename, &quot;utf8&quot;);

  // è§£æå‡ºè¯­æ³•æ ‘
  const ast = babylon.parse(content, {
    sourceType: &quot;module&quot;,
  });

  // æ‹¿åˆ°æ‰€æœ‰çš„ import ä¾èµ–
  const dependencies = [];

  traverse(ast, {
    ImportDeclaration: (({ node }) =&gt; {
      dependencies.push(node.source.value);
    }),
  });

  const id = ID++;

  const code = babel.transformFromAst(ast, null, {
    // presets å‘Šè¯‰ babel è½¬æ¢çš„æ–¹æ³•
    // env æŒ‡ babel-preset-env æ’ä»¶ï¼Œç¡®ä¿è½¬æ¢çš„ä»£ç èƒ½å¤Ÿåœ¨æ‰€æœ‰æµè§ˆå™¨ä¸Šè¿è¡Œ
    presets: [&quot;env&quot;],
  });

  return {
    id,
    filename,
    dependencies,
    code,
  };
}

// åˆ›å»ºä¸€ä¸ª Arrayï¼Œé‡Œé¢æ˜¯æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯ä¸€ä¸ª Node ç”¨ mapping ä¿å­˜ä¾èµ–ä¹‹é—´çš„å…³ç³»
function createGraph(entry) {
  // é€šè¿‡å…¥å£æ–‡ä»¶å¼€å§‹ï¼Œæ‹¿åˆ°æ‰€æœ‰æ–‡ä»¶
  const mainAsset = createAsset(entry);

  // ä¿å­˜æ‰€æœ‰çš„ä¾èµ–
  const queue = [mainAsset];

  for (const asset of queue) {
    const dirname = path.dirname(asset.filename);

    asset.mapping = {};

    asset.dependencies.forEach((relativePath) =&gt; {
      const absolutePath = path.join(dirname, relativePath);

      const child = createAsset(absolutePath);

      // æ¯ä¸ª Node ç”¨ä¸€ä¸ª map å­˜å‚¨ä»–ä¾èµ–çš„å¯¹è±¡
      asset.mapping[relativePath] = child.id;

      queue.push(child);
    });
  }

  return queue;
}

function bundle(graph) {
  // æ„é€ å‚æ•°ï¼ˆè¶…å¤§çš„ï¼‰
  // å‚æ•°æ•´ä½“æ˜¯ä¸€ä¸ª Objectï¼Œä¸‹é¢æ‹¼æ¥äº† Object é‡Œçš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œå¦‚ä¸‹ï¼š
  // id: [code, mapping]
  // code æœ€å¤–å±‚è¿˜å¥—ä¸Šäº†ä¸€ä¸ª function
  let modules = ``;

  graph.forEach((mod) =&gt; {
    modules += `${mod.id}: [
            function(require, module, exports) {
                ${mod.code.code}
            },
            ${JSON.stringify(mod.mapping)}
        ],`;
  });

  const result = `
        // æœ€å¤–é¢æ˜¯ä¸€å±‚è‡ªè°ƒç”¨å‡½æ•°ï¼Œä¼ å…¥äº†ä¸Šé¢æ„é€ çš„å‚æ•°
        (function(modules) {
            // é€šè¿‡æ–‡ä»¶çš„ idï¼Œ
            function require(id) {
                // é€šè¿‡æ–‡ä»¶è·å¾—æ–‡ä»¶çš„å‡½æ•°å’Œä¾èµ– map
                const [fn, mapping] = modules[id];
                // é€šè¿‡ä¾èµ–çš„ idï¼Œåœ¨ mapping ä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶åï¼Œæ¥ç€ç›´æ¥è°ƒç”¨ require
                function localRequire(relativePath) {
                    return require(mapping[relativePath]);
                }
                // ä¿å­˜ export
                const module = { exports: {} };
                // è°ƒç”¨å‡½æ•°
                fn(localRequire, module, module.exports);
                return module.exports;
            }
            // ä»å…¥å£æ–‡ä»¶å¼€å§‹
            require(0)
        })({${modules}});
    `;

  return result;
}

const graph = createGraph(&quot;./example/entry.js&quot;);
console.log(graph);
const result = bundle(graph);
console.log(result);

fs.writeFileSync(&quot;./app.js&quot;, result.toString());
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="js-è¿›é˜¶"><a class="header" href="#js-è¿›é˜¶">JS è¿›é˜¶</a></h1>
<h2 id="1-objectdefineproperty"><a class="header" href="#1-objectdefineproperty">1. Object.defineProperty</a></h2>
<pre><code class="language-js">Object.defineProperty(obj, prop, description)

obj
  è¦å®šä¹‰å±æ€§çš„å¯¹è±¡ã€‚
prop
  è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„åç§°æˆ– Symbol ã€‚
descriptor
  è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§æè¿°ç¬¦ã€‚
</code></pre>
<p>è¯¥å‡½æ•°èƒ½å¤Ÿç²¾ç¡®çš„å®šä¹‰ä¸€ä¸ªå¯¹è±¡ä¸ŠæŸä¸ªå±æ€§çš„æè¿°ç¬¦ å±æ€§æè¿°ç¬¦åˆ†ä¸ºæ•°æ®æè¿°ç¬¦å’Œå­˜å–æè¿°ç¬¦ï¼Œåˆ¤æ–­æ˜¯ä»€ä¹ˆæè¿°ç¬¦éœ€è¦çœ‹è¿™ä¸ªæè¿°ç¬¦ä¸­æ‹¥æœ‰çš„é”®å€¼ å¦‚æœä¸€ä¸ªæè¿°ç¬¦ä¸å…·æœ‰
valueã€writableã€get å’Œ set ä¸­çš„ä»»æ„ä¸€ä¸ªé”®ï¼Œé‚£ä¹ˆå®ƒå°†è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªæ•°æ®æè¿°ç¬¦ã€‚å¦‚æœä¸€ä¸ªæè¿°ç¬¦åŒæ—¶æ‹¥æœ‰ value æˆ– writable å’Œ
get æˆ– set é”®ï¼Œåˆ™ä¼šäº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ã€‚</p>
<p>ä¸‹é¢æ˜¯æè¿°ç¬¦å¯é€‰çš„é”®å€¼</p>
<ol>
<li><strong>é€šç”¨é”®å€¼</strong></li>
</ol>
<ul>
<li>configurable å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ configurable é”®å€¼ä¸º true æ—¶ï¼Œè¯¥å±æ€§çš„æè¿°ç¬¦æ‰èƒ½å¤Ÿè¢«æ”¹å˜ï¼ŒåŒæ—¶è¯¥å±æ€§ä¹Ÿèƒ½ä»å¯¹åº”çš„å¯¹è±¡ä¸Šè¢«åˆ é™¤ã€‚
é»˜è®¤ä¸º falseã€‚</li>
<li>enumerable å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ enumerable é”®å€¼ä¸º true æ—¶ï¼Œè¯¥å±æ€§æ‰ä¼šå‡ºç°åœ¨å¯¹è±¡çš„æšä¸¾å±æ€§ä¸­ã€‚é»˜è®¤ä¸º falseã€‚</li>
</ul>
<ol start="2">
<li><strong>æ•°æ®æè¿°ç¬¦</strong>è¿˜å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š</li>
</ol>
<ul>
<li>value è¯¥å±æ€§å¯¹åº”çš„å€¼ã€‚å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ JavaScript å€¼ï¼ˆæ•°å€¼ï¼Œå¯¹è±¡ï¼Œå‡½æ•°ç­‰ï¼‰ã€‚é»˜è®¤ä¸º undefinedã€‚</li>
<li>writable å½“ä¸”ä»…å½“è¯¥å±æ€§çš„ writable é”®å€¼ä¸º true æ—¶ï¼Œå±æ€§çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ valueï¼Œæ‰èƒ½è¢«èµ‹å€¼è¿ç®—ç¬¦ (en-US) æ”¹å˜ã€‚
é»˜è®¤ä¸º falseã€‚</li>
</ul>
<ol start="3">
<li><strong>å­˜å–æè¿°ç¬¦</strong>è¿˜å…·æœ‰ä»¥ä¸‹å¯é€‰é”®å€¼ï¼š</li>
</ol>
<ul>
<li>get å±æ€§çš„ getter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ getterï¼Œåˆ™ä¸º undefinedã€‚å½“è®¿é—®è¯¥å±æ€§æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚æ‰§è¡Œæ—¶ä¸ä¼ å…¥ä»»ä½•å‚æ•°ï¼Œä½†æ˜¯ä¼šä¼ å…¥
this å¯¹è±¡ï¼ˆç”±äºç»§æ‰¿å…³ç³»ï¼Œè¿™é‡Œçš„ this å¹¶ä¸ä¸€å®šæ˜¯å®šä¹‰è¯¥å±æ€§çš„å¯¹è±¡ï¼‰ã€‚è¯¥å‡½æ•°çš„è¿”å›å€¼ä¼šè¢«ç”¨ä½œå±æ€§çš„å€¼ã€‚é»˜è®¤ä¸º undefinedã€‚</li>
<li>set å±æ€§çš„ setter å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ setterï¼Œåˆ™ä¸º
undefinedã€‚å½“å±æ€§å€¼è¢«ä¿®æ”¹æ—¶ï¼Œä¼šè°ƒç”¨æ­¤å‡½æ•°ã€‚è¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆä¹Ÿå°±æ˜¯è¢«èµ‹äºˆçš„æ–°å€¼ï¼‰ï¼Œä¼šä¼ å…¥èµ‹å€¼æ—¶çš„ this å¯¹è±¡ã€‚é»˜è®¤ä¸º undefinedã€‚</li>
</ul>
<h2 id="2-new-proxytarget-handler"><a class="header" href="#2-new-proxytarget-handler">2. new Proxy(target, handler)</a></h2>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy">MDN-Proxy</a></p>
<h3 id="21-åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#21-åŸºæœ¬æ¦‚å¿µ">2.1 åŸºæœ¬æ¦‚å¿µ</a></h3>
<p>åˆ›å»ºä»£ç†å¯¹è±¡å®ç°å¯¹å¯¹è±¡æ“ä½œæ—¶çš„æ‹¦æˆªå’Œè‡ªå®šä¹‰</p>
<ul>
<li>handler (en-US) ä¸€ä¸ªé€šå¸¸ä»¥å‡½æ•°ä½œä¸ºå±æ€§çš„å¯¹è±¡ï¼Œå„å±æ€§ä¸­çš„å‡½æ•°åˆ†åˆ«å®šä¹‰äº†åœ¨æ‰§è¡Œå„ç§æ“ä½œæ—¶ä»£ç† p çš„è¡Œä¸ºã€‚</li>
<li>traps handler å¯¹è±¡æ‹¥æœ‰çš„ trapsï¼ˆæ•è·å™¨ï¼‰</li>
<li>target è¦ä½¿ç”¨ Proxy åŒ…è£…çš„ç›®æ ‡å¯¹è±¡ï¼ˆå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬åŸç”Ÿæ•°ç»„ï¼Œå‡½æ•°ï¼Œç”šè‡³å¦ä¸€ä¸ªä»£ç†ï¼‰ã€‚</li>
</ul>
<h3 id="22-æ ‡å‡†çš„-traps"><a class="header" href="#22-æ ‡å‡†çš„-traps">2.2 æ ‡å‡†çš„ traps</a></h3>
<p>ä¸‹é¢åˆ—å‡ºäº†ä¸€äº›å¸¸ç”¨çš„æ•è·å™¨</p>
<ul>
<li>handler.getPrototypeOf() Object.getPrototypeOf æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.setPrototypeOf() Object.setPrototypeOf æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.isExtensible() Object.isExtensible æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.preventExtensions() Object.preventExtensions æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.getOwnPropertyDescriptor() Object.getOwnPropertyDescriptor æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.defineProperty() Object.defineProperty æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.has() in æ“ä½œç¬¦çš„æ•æ‰å™¨ã€‚</li>
<li>handler.get() å±æ€§è¯»å–æ“ä½œçš„æ•æ‰å™¨ã€‚</li>
<li>handler.set() å±æ€§è®¾ç½®æ“ä½œçš„æ•æ‰å™¨ã€‚</li>
<li>handler.deleteProperty() delete æ“ä½œç¬¦çš„æ•æ‰å™¨ã€‚</li>
<li>handler.ownKeys() Object.getOwnPropertyNames æ–¹æ³•å’Œ Object.getOwnPropertySymbols
æ–¹æ³•çš„æ•æ‰å™¨ã€‚</li>
<li>handler.apply() å‡½æ•°è°ƒç”¨æ“ä½œçš„æ•æ‰å™¨ã€‚</li>
<li>handler.construct() new æ“ä½œç¬¦çš„æ•æ‰å™¨ã€‚</li>
</ul>
<h3 id="23-get-set"><a class="header" href="#23-get-set">2.3 get set</a></h3>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ get æ•è·å™¨è¿›è¡Œå˜é‡æ‰“å°çš„ä¾‹å­</p>
<pre><code class="language-js">let target = {
  id: 1,
  name: &quot;å°æ˜&quot;,
};

const handler = {
  get: function (target, property, reveiver) {
    console.log(&quot;target: &quot;, target);
    console.log(&quot;property: &quot;, property);
    console.log(&quot;reveiver: &quot;, reveiver);
    return target[property];
  },
};

let proxyTarget = new Proxy(target, handler);

console.log(proxyTarget.id);

Object.defineProperty(proxyTarget, &quot;id&quot;, {
  get: undefined,
});

console.log(&quot;id&quot;, proxyTarget.id);
console.log(&quot;name:&quot;, proxyTarget.name);

console.log(&quot;target&quot;, target);
console.log(&quot;proxyTarget&quot;, proxyTarget);
</code></pre>
<h3 id="24-ä»£ç†è½¬å‘"><a class="header" href="#24-ä»£ç†è½¬å‘">2.4 ä»£ç†è½¬å‘</a></h3>
<p>ä¸‹é¢å¯¹ proxy çš„ä¿®æ”¹è¢«æ­£ç¡®è½¬å‘åˆ° target ä¸Š</p>
<pre><code class="language-js">let target = {};
let p = new Proxy(target, {});

p.a = 37; // æ“ä½œè½¬å‘åˆ°ç›®æ ‡

console.log(target.a); // 37. æ“ä½œå·²ç»è¢«æ­£ç¡®åœ°è½¬å‘
</code></pre>
<p>set trap å¯ä»¥è¿›è¡Œå€¼ä¿®æ­£åŠé™„åŠ å±æ€§ æ¯”å¦‚</p>
<pre><code class="language-js">let products = new Proxy({
  browsers: [&quot;Internet Explorer&quot;, &quot;Netscape&quot;],
}, {
  get: function (obj, prop) {
    // é™„åŠ ä¸€ä¸ªå±æ€§
    if (prop === &quot;latestBrowser&quot;) {
      return obj.browsers[obj.browsers.length - 1];
    }

    // é»˜è®¤è¡Œä¸ºæ˜¯è¿”å›å±æ€§å€¼
    return obj[prop];
  },
  set: function (obj, prop, value) {
    // é™„åŠ å±æ€§
    if (prop === &quot;latestBrowser&quot;) {
      obj.browsers.push(value);
      return;
    }

    // å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œåˆ™è¿›è¡Œè½¬æ¢
    if (typeof value === &quot;string&quot;) {
      value = [value];
    }

    // é»˜è®¤è¡Œä¸ºæ˜¯ä¿å­˜å±æ€§å€¼
    obj[prop] = value;

    // è¡¨ç¤ºæˆåŠŸ
    return true;
  },
});

console.log(products.browsers); // ['Internet Explorer', 'Netscape']
products.browsers = &quot;Firefox&quot;; // å¦‚æœä¸å°å¿ƒä¼ å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²
console.log(products.browsers); // ['Firefox'] &lt;- ä¹Ÿæ²¡é—®é¢˜ï¼Œå¾—åˆ°çš„ä¾æ—§æ˜¯ä¸€ä¸ªæ•°ç»„

products.latestBrowser = &quot;Chrome&quot;;
console.log(products.browsers); // ['Firefox', 'Chrome']
console.log(products.latestBrowser); // 'Chrome'
</code></pre>
<h3 id="25-å¯¹æ–¹æ³•è°ƒç”¨çš„ä»£ç†"><a class="header" href="#25-å¯¹æ–¹æ³•è°ƒç”¨çš„ä»£ç†">2.5 å¯¹æ–¹æ³•è°ƒç”¨çš„ä»£ç†</a></h3>
<pre><code class="language-js">function sum(a, b) {
  return a + b;
}

const handler2 = {
  apply: function (target, thisArg, argumentsList) {
    console.log(`argumentsList ${argumentsList}`);
    // expected output: &quot;Calculate sum: 1,2&quot;
    console.log(&quot;thisArg&quot;, thisArg);
    return target(argumentsList[0], argumentsList[1]) * 10;
  },
};

const proxy1 = new Proxy(sum, handler2);

console.log(sum(1, 2));
// expected output: 3
console.log(proxy1(1, 2));
// expected output: 30
</code></pre>
<h3 id="26-å¯¹æ„é€ å‡½æ•°çš„ä»£ç†"><a class="header" href="#26-å¯¹æ„é€ å‡½æ•°çš„ä»£ç†">2.6 å¯¹æ„é€ å‡½æ•°çš„ä»£ç†</a></h3>
<p>ä½¿ç”¨æ„é€ å‡½æ•°å£°æ˜ç±»</p>
<pre><code class="language-js">var Person = function (name) {
  this.name = name;
};

let person = new Person(&quot;aa&quot;);
console.log(person);
</code></pre>
<p>ä½¿ç”¨ extend æ–¹æ³•ä»£ç† Boy ç±»çš„æ„é€ æ–¹æ³•</p>
<pre><code class="language-js">function extend(sup, base) {
  var descriptor = Object.getOwnPropertyDescriptor(
    base.prototype,
    &quot;constructor&quot;,
  );
  base.prototype = Object.create(sup.prototype);
  var handler = {
    construct: function (target, args) {
      var obj = Object.create(base.prototype);
      this.apply(target, obj, args);
      return obj;
    },
    apply: function (target, that, args) {
      sup.apply(that, args);
      base.apply(that, args);
    },
  };
  var proxy = new Proxy(base, handler);
  descriptor.value = proxy;
  Object.defineProperty(base.prototype, &quot;constructor&quot;, descriptor);
  return proxy;
}

var Person = function (name) {
  this.name = name;
};

var Boy = extend(Person, function (name, age) {
  this.age = age;
});

Boy.prototype.sex = &quot;M&quot;;

var Peter = new Boy(&quot;Peter&quot;, 13);
console.log(Peter.sex); // &quot;M&quot;
console.log(Peter.name); // &quot;Peter&quot;
console.log(Peter.age); // 13
</code></pre>
<h3 id="27-å®ä¾‹äº¤æ¢ä¸¤ä¸ªå•é€‰æ¡†çš„é€‰æ‹©çŠ¶æ€"><a class="header" href="#27-å®ä¾‹äº¤æ¢ä¸¤ä¸ªå•é€‰æ¡†çš„é€‰æ‹©çŠ¶æ€">2.7 å®ä¾‹ï¼šäº¤æ¢ä¸¤ä¸ªå•é€‰æ¡†çš„é€‰æ‹©çŠ¶æ€</a></h3>
<pre><code class="language-js">let view = new Proxy({
  selected: null,
}, {
  set: function (obj, prop, newval) {
    let oldval = obj[prop];

    if (prop === &quot;selected&quot;) {
      if (oldval) {
        oldval.setAttribute(&quot;aria-selected&quot;, &quot;false&quot;);
      }
      if (newval) {
        newval.setAttribute(&quot;aria-selected&quot;, &quot;true&quot;);
      }
    }

    // é»˜è®¤è¡Œä¸ºæ˜¯å­˜å‚¨è¢«ä¼ å…¥ setter å‡½æ•°çš„å±æ€§å€¼
    obj[prop] = newval;

    // è¡¨ç¤ºæ“ä½œæˆåŠŸ
    return true;
  },
});

let i1 = view.selected = document.getElementById(&quot;item-1&quot;);
console.log(i1.getAttribute(&quot;aria-selected&quot;)); // 'true'

let i2 = view.selected = document.getElementById(&quot;item-2&quot;);
console.log(i1.getAttribute(&quot;aria-selected&quot;)); // 'false'
console.log(i2.getAttribute(&quot;aria-selected&quot;)); // 'true'
</code></pre>
<h3 id="28-å®ä¾‹å¯¹æ•°ç»„æ–¹æ³•çš„æ‹“å±•"><a class="header" href="#28-å®ä¾‹å¯¹æ•°ç»„æ–¹æ³•çš„æ‹“å±•">2.8 å®ä¾‹ï¼šå¯¹æ•°ç»„æ–¹æ³•çš„æ‹“å±•</a></h3>
<ol>
<li>products.number ä¸º array.length èµ·åˆ«å array.number</li>
<li>products.name | products.type é€šè¿‡ array ä¸­ object çš„æŸä¸ªé”®è·å–å…ƒç´ </li>
</ol>
<pre><code class="language-js">let products = new Proxy([
  { name: &quot;Firefox&quot;, type: &quot;browser&quot; },
  { name: &quot;SeaMonkey&quot;, type: &quot;browser&quot; },
  { name: &quot;Thunderbird&quot;, type: &quot;mailer&quot; },
], {
  get: function (obj, prop) {
    // é»˜è®¤è¡Œä¸ºæ˜¯è¿”å›å±æ€§å€¼ï¼Œprop ?é€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°
    if (prop in obj) {
      return obj[prop];
    }

    // è·å– products çš„ number; å®ƒæ˜¯ products.length çš„åˆ«å
    if (prop === &quot;number&quot;) {
      return obj.length;
    }

    let result, types = {};

    for (let product of obj) {
      if (product.name === prop) {
        result = product;
      }
      if (types[product.type]) {
        types[product.type].push(product);
      } else {
        types[product.type] = [product];
      }
    }

    // é€šè¿‡ name è·å– product
    if (result) {
      return result;
    }

    // é€šè¿‡ type è·å– products
    if (prop in types) {
      return types[prop];
    }

    // è·å– product type
    if (prop === &quot;types&quot;) {
      return Object.keys(types);
    }

    return undefined;
  },
});

console.log(products[0]); // { name: 'Firefox', type: 'browser' }
console.log(products[&quot;Firefox&quot;]); // { name: 'Firefox', type: 'browser' }
console.log(products[&quot;Chrome&quot;]); // undefined
console.log(products.browser); // [{ name: 'Firefox', type: 'browser' }, { name: 'SeaMonkey', type: 'browser' }]
console.log(products.types); // ['browser', 'mailer']
console.log(products.number); // 3
</code></pre>
<h2 id="å…¶ä»–-1"><a class="header" href="#å…¶ä»–-1">å…¶ä»–</a></h2>
<h3 id="map-vs-weakmap"><a class="header" href="#map-vs-weakmap">Map vs WeakMap</a></h3>
<pre><code>WeakMap åªèƒ½ç”¨ Object åšé”®ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨ï¼Œ

èƒ½å¤Ÿè§¦å‘åƒåœ¾å›æ”¶æœºåˆ¶
ä¸èƒ½è¢« enumerate
Map ä½¿ç”¨ä»»æ„ç±»å‹ä½œä¸ºé”®

åœ¨ gc æ—¶ä¸èƒ½è‡ªåŠ¨åˆ é™¤å…³è”å†…å­˜
å¯ä»¥è¢«è¿­ä»£
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vue-mastery"><a class="header" href="#vue-mastery">Vue Mastery</a></h1>
<p>Deep Dive With Even You</p>
<h2 id="1-v-dom"><a class="header" href="#1-v-dom">1. V-DOM</a></h2>
<p>å®ç° dom é‡ç‚¹åœ¨äº</p>
<ol>
<li>è·å–æ–°å¢èŠ‚ç‚¹çš„å„ç§å±æ€§ï¼Œä½¿ç”¨ createElement æ‹¼æ¥å‡ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶æŒ‚è½½åˆ° dom æ ‘ä¸­</li>
<li>èƒ½å¤Ÿç”¨æ¯”è¾ƒç®—æ³•æ¯”è¾ƒæ–°çš„ dom å’Œæ—§çš„ dom çš„ä¸åŒï¼Œå¹¶é«˜æ•ˆçš„æ›´æ–°èŠ‚ç‚¹</li>
</ol>
<h3 id="11-h"><a class="header" href="#11-h">1.1 h</a></h3>
<p>è¯¥å‡½æ•°åªæ˜¯å®šä¹‰äº†ä¸€ä¸ªæ ‡ç­¾çš„å±æ€§å¹¶è¿”å›</p>
<pre><code class="language-js">function h(tag, props, children) {
  return {
    tag,
    props,
    children,
  };
}
</code></pre>
<h3 id="12-mount"><a class="header" href="#12-mount">1.2 mount</a></h3>
<p>ç”Ÿæˆ + æŒ‚è½½èŠ‚ç‚¹çš„å°è£… ä½¿ç”¨ node.el ä½œä¸ºæŒ‡é’ˆä¿å­˜äº†èŠ‚ç‚¹çš„ä¿¡æ¯</p>
<pre><code class="language-js">function mount(vnode, container) {
  // åˆ›å»ºæ–°èŠ‚ç‚¹
  // è¿™é‡Œç”¨ node.el ä¿å­˜äº†æ—§çš„ dom æ ‘
  const el = vnode.el = document.createElement(vnode.tag);
  // æ·»åŠ  props å±æ€§
  if (vnode.props) {
    for (const key in vnode.props) {
      const value = vnode.props[key];
      el.setAttribute(key, value);
    }
  }
  // æŒ‚è½½å­èŠ‚ç‚¹
  // string ç±»å‹å°±ç›´æ¥ä¿®æ”¹ textContent
  // Array ç±»å‹å°±ä»¥æ­¤å¯¹ child è°ƒç”¨ mount æŒ‚è½½åˆ°æ–°èŠ‚ç‚¹ä¸Š
  if (vnode.children) {
    if (typeof vnode.children === &quot;string&quot;) {
      el.textContent = vnode.children;
    } else if (vnode.children instanceof Array) {
      console.log(vnode.children);
      vnode.children.forEach((child) =&gt; {
        mount(child, el);
      });
    } else {
      el.textContent = `[ERROR]: ${vnode.children}`;
    }
  }
  container.appendChild(el);
}
</code></pre>
<h3 id="13-patch"><a class="header" href="#13-patch">1.3 patch</a></h3>
<p>æ¯”è¾ƒæ–°èŠ‚ç‚¹å’Œæ—§èŠ‚ç‚¹çš„å·®å¼‚ï¼Œæœ€å°åŒ–ä¿®æ”¹èŠ‚ç‚¹å†…å®¹ é‡ç‚¹åœ¨äºæ–°æ—§èŠ‚ç‚¹çš„ children éƒ½æ˜¯ Array ç±»å‹æ—¶ï¼Œå¦‚ä½•æœ€é«˜æ•ˆçš„å®ç°ä¸¤ç»„ Array çš„åŒæ­¥
æ¯”å¦‚å¤šçš„æ·»åŠ ï¼Œå°‘çš„åˆ é™¤ï¼Œå˜çš„ä¿®æ”¹ï¼Œæ¢ä¸ºä½ç½®çš„æ€ä¹ˆæŠŠä½ç½®æ¢å›æ¥</p>
<pre><code class="language-js">function patch(n1, n2) {
  // 1. æ¯”è¾ƒæ˜¯ä¸æ˜¯åŒä¸€ä¸ªæ ‡ç­¾
  if (n1.tag === n2.tag) {
    const el = n2.el = n1.el;
    // check props æ£€æŸ¥ props å±æ€§ï¼Œå˜äº†çš„å°±ä¿®æ”¹ï¼Œæ²¡æœ‰çš„å°±æ·»åŠ 
    const oldProps = n1.props || {};
    const newProps = n2.props || {};
    for (const key in newProps) {
      const oldValue = oldProps[key];
      const newValue = newProps[key];
      if (oldValue !== newValue) {
        el.setAttribute(key, newValue);
      }
    }
    // æŠŠæ—§èŠ‚ç‚¹å¤šä½™çš„ props åˆ é™¤
    for (const key in oldProps) {
      if (!(key in newProps)) {
        el.removeAttribute(key);
      }
    }

    // children æ£€æŸ¥å­èŠ‚ç‚¹
    const oldChildren = n1.children;
    const newChildren = n2.children;
    // å¦‚æœæ–°èŠ‚ç‚¹æ˜¯ string ç±»å‹ä¸”å’Œæ—§èŠ‚ç‚¹ä¸ä¸€æ ·ï¼Œå°±è¦†ç›–æ‰æ—§èŠ‚ç‚¹
    if (typeof newChildren === &quot;string&quot;) {
      if (typeof oldChildren === &quot;string&quot;) {
        if ((oldChildren !== newChildren)) {
          el.textContent = newChildren;
        }
      } else {
        el.textContent = newChildren;
      }
      // å¦‚æœæ–°èŠ‚ç‚¹æ˜¯ Array ç±»å‹
    } else if (newChildren instanceof Array) {
      // æ—§çš„æ˜¯ string ç±»å‹ï¼Œä¾æ¬¡æ·»åŠ  newChild
      if (typeof oldChildren === &quot;string&quot;) {
        el.innerHTML = &quot;&quot;;
        newChildren.forEach((child) =&gt; {
          mount(child, el);
        });
        // æ—§çš„ä¹Ÿæ˜¯ä¸ª Array
      } else if (oldChildren instanceof Array) {
        const commonLength = Math.min(oldChildren.length, newChildren.length);
        // ä¸€æ¬¡æ¯”è¾ƒæ¯ä¸€å¯¹ childï¼Œä¿®æ”¹æ—§ child çš„å†…å®¹
        for (let i = 0; i &lt; commonLength; i++) {
          patch(oldChildren[i], newChildren[i]);
        }
        // å¦‚æœ newChildren æ•°é‡æ›´å¤šï¼Œå°±æŠŠå¤šå‡ºçš„æ–°èŠ‚ç‚¹æ·»åŠ åˆ°æ–°èŠ‚ç‚¹ä¸Š
        if (newChildren.length &gt; oldChildren.length) {
          newChildren.slice(oldChildren.length).forEach((child) =&gt; {
            mount(child, el);
          });
          // å¦åˆ™ï¼Œåˆ é™¤å¤šä½™çš„æ–°èŠ‚ç‚¹
        } else if (newChildren.length &lt; oldChildren.length) {
          oldChildren.slice(newChildren.length).forEach((child) =&gt; {
            el.removeChild(child.el);
          });
        }
      }
    } else {
    }
  } else {
    // replace
  }
}
</code></pre>
<h3 id="14-å®Œæ•´ä»£ç "><a class="header" href="#14-å®Œæ•´ä»£ç ">1.4 å®Œæ•´ä»£ç </a></h3>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
    &lt;style&gt;
        .red {
            color: red;
        }
        .green {
            color: green;
        }
        .m-4 {
            margin: 10px;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;title&lt;/div&gt;
    &lt;script&gt;
        // @ts-check
        function h(tag, props, children) {
            return {
                tag,
                props,
                children
            }
        }

        function mount(vnode, container) {
            // è¿™é‡Œç”¨ node.el ä¿å­˜äº†æ—§çš„ dom æ ‘
            const el = vnode.el = document.createElement(vnode.tag)
            // props
            if (vnode.props) {
                for (const key in vnode.props) {
                    const value = vnode.props[key]
                    el.setAttribute(key, value)
                }
            }
            if (vnode.children) {
                if (typeof vnode.children === 'string') {
                    el.textContent = vnode.children
                } else if (vnode.children instanceof Array) {
                    console.log(vnode.children)
                    vnode.children.forEach(child =&gt; {
                        mount(child, el)
                    })
                } else {
                    el.textContent = `[ERROR]: ${vnode.children}`
                }
            }
            container.appendChild(el)
        }

        const vdom = h('div', { class: 'red' }, [
            h('span', {class: 'm-4'}, 'hello')
        ])

        function patch(n1, n2) {
            if (n1.tag === n2.tag) {
                const el = n2.el = n1.el
                // check props
                const oldProps = n1.props || {};
                const newProps = n2.props || {};
                for (const key in newProps) {
                    const oldValue = oldProps[key]
                    const newValue = newProps[key]
                    if (oldValue !== newValue) {
                        el.setAttribute(key, newValue)
                    }
                }
                for (const key in oldProps) {
                    if (!(key in newProps)) {
                        el.removeAttribute(key)
                    }
                }

                // childrem
                const oldChildren = n1.children
                const newChildren = n2.children
                if (typeof newChildren === &quot;string&quot;) {
                    if (typeof oldChildren === 'string') {
                        if ((oldChildren !== newChildren)) {
                            el.textContent = newChildren
                        }
                    } else {
                        el.textContent = newChildren
                    }
                } else if (newChildren instanceof Array) {
                    if (typeof oldChildren === 'string') {
                        el.innerHTML = ''
                        newChildren .forEach(child =&gt; {
                            mount(child, el)
                        })
                    } else if (oldChildren instanceof Array) {
                        const commonLength = Math.min(oldChildren.length, newChildren.length)
                        for (let i = 0; i &lt; commonLength; i++) {
                            patch(oldChildren[i], newChildren[i])
                        }
                        if (newChildren.length &gt; oldChildren.length) {
                            newChildren.slice(oldChildren.length).forEach(child =&gt; {
                                mount(child, el)
                            })
                        } else if (newChildren.length &lt; oldChildren.length) {
                            oldChildren.slice(newChildren.length).forEach(child =&gt; {
                                el.removeChild(child.el)
                            })
                        }
                    }
                } else {

                }
            } else {
                // replace


            }
        }

        mount(vdom, document.querySelector(&quot;#app&quot;))

        const vdom2 = h('div', { class: 'green' }, [
            h('span', {class: 'm-4'}, 'msg')
        ])

        patch(vdom, vdom2)

    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="2-ref"><a class="header" href="#2-ref">2. Ref</a></h2>
<p>å®ç° refï¼Œå’Œ watchEffect çš„ç›‘å¬</p>
<h3 id="21-åŸºæœ¬è¿‡ç¨‹"><a class="header" href="#21-åŸºæœ¬è¿‡ç¨‹">2.1 åŸºæœ¬è¿‡ç¨‹</a></h3>
<p>ä¸º Dep ç±»å®ç°äº† setï¼Œgetï¼Œå¯ä»¥åƒ ref ä¸€æ ·é€šè¿‡ dep.value è·å–å’Œä¿®æ”¹å˜é‡ è€Œä¸”èƒ½åœ¨ getï¼Œset å‰ååšä¸€äº›å…¶ä»–å·¥ä½œï¼Œæ¯”å¦‚è¿™é‡Œç”¨åˆ°çš„
set åè°ƒç”¨ notify æ¿€æ´» watchEffect get æ—¶ (é¦–æ¬¡è°ƒç”¨ watchEffect æ—¶)ï¼ŒæŠŠç”¨åˆ°çš„å˜é‡æ·»åŠ åˆ°å„è‡ªçš„ subscriber é‡Œ</p>
<ol>
<li>è¢«ç›‘å¬å˜é‡åŠ è½½ subscriber
é¦–æ¬¡è°ƒç”¨ watchffect æ—¶ï¼Œå…ˆåˆå§‹åŒ– activeEffect ä¸ºä¼ å…¥ watchEffect çš„å‡½æ•°ï¼Œè¢« get è¿‡çš„å˜é‡ä¼šæ‰§è¡Œ dependï¼Œå‘ subscriber ä¸­åŠ å…¥ activeEffect(å³ä¸º warchEffect å‡½æ•°å†…ä¼ é€’çš„ç®­å¤´å‡½æ•°)
æ¥ç€åœ¨å˜é‡è¢« set åå°±èƒ½è°ƒç”¨ notifyï¼Œå”¤é†’ subscriber ä¸­çš„ç®­å¤´å‡½æ•°</li>
<li>è¯¯åŒº å¦‚æœï¼Œåƒä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå‡å¦‚ ok.value çš„å€¼å¼€å§‹ä¸º trueï¼Œé‚£ä¹ˆ ok å’Œ msg éƒ½èƒ½æ­£ç¡®åŠ è½½ subscriber
åŠ å…¥ ok.value å¼€å§‹ä¸º falseï¼Œmsg å°±ä¸èƒ½æ­£ç¡®åŠ è½½ subscriberï¼Œåœ¨ä¹‹åä¿®æ”¹ä¸­ä¹Ÿä¸ä¼šæ­£ç¡®æ¿€æ´» notifyï¼Œå³ä½¿åœ¨ä¹‹å get ä¹Ÿä¸è¡Œï¼Œå› ä¸º depend åªæœ‰åœ¨ effect ä¸ä¸ºç©ºæ‰èƒ½æ·»åŠ  subscriberï¼Œeffect çš„åˆå§‹åŒ–æ˜¯åœ¨ watchEffect() ä¸­è¿›è¡Œçš„ï¼Œwatchffect ç»“æŸå acticeEffect å°±è¢« null äº†</li>
</ol>
<h3 id="22-watcheffect-çš„åˆå§‹åŒ–"><a class="header" href="#22-watcheffect-çš„åˆå§‹åŒ–">2.2 watchEffect çš„åˆå§‹åŒ–</a></h3>
<p>watchEffect å‡½æ•°å®Œæˆçš„å·¥ä½œæ˜¯åˆå§‹åŒ– activeEffect
åœ¨ watchEffect() é¦–æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œæ‰§è¡Œæ¯ä¸ªç›‘å¬å˜é‡çš„ depend()ï¼ŒåŠ å…¥ subscriberï¼Œä¹‹ååœ¨å˜é‡è¢«ä¿®æ”¹æ—¶å°±èƒ½ä½¿ç”¨ notify æ¿€æ´» activeEffect</p>
<pre><code class="language-js">function watchEffect(effect) {
  activeEffect = effect;
  effect();
  activeEffect = null;
}
watchEffect(() =&gt; {
  // console.log(dep.value)

  if (ok.value) {
    console.log(ok.value, msg.value);
  } else {
    console.log(&quot;Error&quot;);
  }
});
</code></pre>
<h3 id="23-dep-ç±»çš„å®ç°"><a class="header" href="#23-dep-ç±»çš„å®ç°">2.3 Dep ç±»çš„å®ç°</a></h3>
<pre><code class="language-js">class Dep {
  constructor(value) {
    this.subscriber = new Set();
    this._value = value;
  }

  get value() {
    this.depend();
    return this._value;
  }

  set value(value) {
    this._value = value;
    this.notify();
  }

  depend() {
    if (activeEffect) {
      this.subscriber.add(activeEffect);
    }
  }

  notify() {
    this.subscriber.forEach((effect) =&gt; {
      effect();
    });
  }
}
</code></pre>
<h3 id="24-å®Œæ•´ä»£ç "><a class="header" href="#24-å®Œæ•´ä»£ç ">2.4 å®Œæ•´ä»£ç </a></h3>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;script&gt;

        let activeEffect
        class Dep {

            constructor(value) {
                this.subscriber = new Set()
                this._value = value
            }

            get value() {
                this.depend()
                return this._value
            }

            set value(value) {
                this._value = value
                this.notify()
            }

            depend() {
                if (activeEffect) {
                    this.subscriber.add(activeEffect)
                }
            }

            notify() {
                this.subscriber.forEach(effect =&gt; {
                    effect()
                })
            }
        }

        function watchEffect(effect) {
            activeEffect = effect
            effect()
            activeEffect = null
        }

        const dep = new Dep({aa: 1});
        const ok = new Dep(true);
        const msg = new Dep('hello');

        watchEffect(() =&gt; {
            // console.log(dep.value)

            if (ok.value) {
                console.log(ok.value, msg.value);
            } else {
                console.log('Error');
            }
        })


        dep.o = {aa: 2}
        msg.value = &quot;Ss&quot;
        ok.value = false
        msg.value = &quot;Ssr&quot;


        &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="25-æ–¹ä¾¿è°ƒè¯•çš„ç‰ˆæœ¬"><a class="header" href="#25-æ–¹ä¾¿è°ƒè¯•çš„ç‰ˆæœ¬">2.5 æ–¹ä¾¿è°ƒè¯•çš„ç‰ˆæœ¬</a></h3>
<pre><code class="language-js">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;


    &lt;script&gt;

        let activeEffect
        class Dep {

            constructor(value) {
                this.subscriber = new Set()
                this._value = value
            }

            get value() {
                console.log('in get value');
                this.depend()
                return this._value
            }

            set value(value) {
                console.log('in set value');
                this._value = value
                this.notify()
            }

            depend() {
                console.log('activateEffect: ', activeEffect);
                if (activeEffect) {
                    this.subscriber.add(activeEffect)
                }
            }

            notify() {
                console.log('subscriber: ', this.subscriber);
                this.subscriber.forEach(effect =&gt; {
                    effect()
                })
            }
        }

        function watchEffect(effect) {
            activeEffect = effect
            effect()
            activeEffect = null
        }

        const dep = new Dep({aa: 1});
        const ok = new Dep(false);
        const msg = new Dep('hello');

        console.log('ok', ok, 'msg', msg);
        console.log('----------- 0 -----------');
        watchEffect(() =&gt; {
            // console.log(dep.value)

            if (ok.value) {
                console.log(ok.value, msg.value);
            } else {
                console.log('Error');
            }
        })
        console.log('ok', ok, 'msg', msg);
        console.log('----------- 1 -----------');
        // dep ä¸åœ¨ watchffect ä¸­
        console.log(dep.value)
        dep.value = {aa: 2}
        console.log(dep.value)
        console.log('----------- 2 -----------');
        // è¿™é‡Œè™½ç„¶ä¿®æ”¹äº† msg çš„å€¼ï¼Œä½†æ˜¯ç”±äº msg ä¹‹å‰æ²¡æœ‰è¢« get è¿‡ï¼Œä»–çš„ subscriber ä¸ºç©ºï¼Œnotify ä¸ä¼šæ¿€æ´» watchEffect è¿è¡Œ
        console.log(msg.value);
        msg.value = &quot;Ss&quot;
        console.log('ok', ok, 'msg', msg);
        console.log('----------- 3 -----------');
        ok.value = true
        console.log('----------- 4 -----------');
        msg.value = &quot;Ssr&quot;
        console.log('ok', ok, 'msg', msg);


        &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="3-reactive"><a class="header" href="#3-reactive">3. Reactive</a></h2>
<p>å¤§ä½“æ€è·¯å’Œ dep ç›¸ä¼¼ï¼Œè¿™é‡Œæä¾›ä¸¤å¥—å®ç°</p>
<ol>
<li>åŸºäº Object.defineProperty (vue2)</li>
</ol>
<pre><code class="language-js">function reactive(raw) {
  // ä»¿ç…§ dep ç±»ï¼Œä¸ºæ¯ä¸ªé”®å€¼è®¾å®š setter å’Œ getter æ–¹æ³•
  // raw ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª Dep å®ä¾‹
  Object.keys(raw).forEach((key) =&gt; {
    let dep = new Dep(key);
    let value = raw[key];
    Object.defineProperty(raw, key, {
      fuck() {
        console.log(&quot;cnm&quot;);
      },
      get() {
        dep.depend();
        return value;
      },
      set(newValue) {
        value = newValue;
        dep.notify();
      },
    });
  });
  return raw;
}
</code></pre>
<ol start="2">
<li>åŸºäº Proxy çš„å®ç° (vue3)</li>
</ol>
<pre><code class="language-js">const targetMap = new WeakMap();

function getDep(target, key) {
  let depsMap = targetMap.get(target);
  if (!depsMap) {
    depsMap = new Map();
    targetMap.set(target, depsMap);
  }
  let dep = depsMap.get(key);
  if (!dep) {
    dep = new Dep();
    depsMap.set(key, dep);
  }
  return dep;
}

// ä½¿ç”¨ Proxy å®ç°çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ£€æµ‹åˆ°æ·»åŠ æ–°å…ƒç´ ï¼Œæ¯”å¦‚ä¸‹é¢çš„ state.msg
const reactiveHandler = {
  get(target, key, receiver) {
    const dep = getDep(target, key);
    dep.depend();
    return Reflect.get(target, key, receiver);
  },
  set(target, key, value, receiver) {
    const dep = getDep(target, key);
    const result = Reflect.set(target, key, value, receiver);
    // å…ˆä¿®æ”¹å€¼åœ¨ notify
    dep.notify();
    return result;
  },
  // è¿˜å¯ä»¥å®ç°æ›´å¤šçš„ traps
  has() {
  },
  onKeys() {
  },
};

function reactive(raw) {
  return new Proxy(raw, reactiveHandler);
}
const state = reactive({
  count: 0,
  fuck: &quot;Fuck!&quot;,
});
</code></pre>
<ol start="3">
<li>å®Œæ•´ä»£ç </li>
</ol>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Document&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;

    &lt;script&gt;
        let activeEffect
        class Dep {

            subscriber = new Set()

            depend() {
                if (activeEffect) {
                    this.subscriber.add(activeEffect)
                }
            }

            notify() {
                this.subscriber.forEach(effect =&gt; {
                    effect()
                })
            }
        }

        function watchEffect(effect) {
            activeEffect = effect
            effect()
            activeEffect = null
        }
        // function reactive(raw) {
        //     // ä»¿ç…§ dep ç±»ï¼Œä¸ºæ¯ä¸ªé”®å€¼è®¾å®š setter å’Œ getter æ–¹æ³•
        //     // raw ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª Dep å®ä¾‹
        //     Object.keys(raw).forEach(key =&gt; {
        //         let dep = new Dep(key)
        //         let value = raw[key]
        //         Object.defineProperty(raw, key, {
        //             fuck() {
        //                 console.log('cnm');
        //             },
        //             get() {
        //                 dep.depend()
        //                 return value
        //             },
        //             set(newValue) {
        //                 value = newValue
        //                 dep.notify()
        //             }
        //         })
        //     })
        //     return raw
        // }

        // targetMap depMap
        // obj1    key1 dep
        //         key2 dep
        // obj2    key1 dep
        //         key2 dep
        const targetMap = new WeakMap();

        function getDep(target, key) {
            let depsMap = targetMap.get(target);
            if (!depsMap) {
                depsMap = new Map();
                targetMap.set(target, depsMap);
            }
            let dep = depsMap.get(key);
            if (!dep) {
                dep = new Dep();
                depsMap.set(key, dep);
            }
            return dep
        }

        // ä½¿ç”¨ Proxy å®ç°çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ£€æµ‹åˆ°æ·»åŠ æ–°å…ƒç´ ï¼Œæ¯”å¦‚ä¸‹é¢çš„ state.msg
        const reactiveHandler = {
            get(target, key, receiver) {
                const dep = getDep(target, key);
                dep.depend()
                return Reflect.get(target, key, receiver)
            },
            set(target, key, value, receiver) {
                const dep = getDep(target, key);
                const result = Reflect.set(target, key, value, receiver);
                // å…ˆä¿®æ”¹å€¼åœ¨ notify
                dep.notify()
                return result
            },
            // è¿˜å¯ä»¥å®ç°æ›´å¤šçš„ traps
            has() {

            },
            onKeys() {

            }
        }

        function reactive(raw) {
            return new Proxy(raw, reactiveHandler)
        }
        const state = reactive({
            count: 0,
            fuck: 'Fuck!'
        })
        console.log('state:', state);

        watchEffect(() =&gt; {
            console.log(state.count, state.msg)
        })

        state.count++

        state.msg = 'i am not exist before '

    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="4-mini-vue"><a class="header" href="#4-mini-vue">4. Mini-Vue</a></h2>
<p>æœ‰äº†ä¸Šé¢çš„ä¸œè¥¿åŸºæœ¬å°±å¤Ÿäº†</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªè®¡æ•°åº”ç”¨</p>
<pre><code class="language-js">const App = {
  data: reactive({
    count: 0,
  }),
  render() {
    return h(&quot;div&quot;, {
      onclick: () =&gt; {
        this.data.count++;
      },
    }, this.data.count);
  },
};

function mountApp(component, container) {
  let isMounted = false;
  let prevVdom;
  watchEffect(() =&gt; {
    if (!isMounted) {
      prevVdom = component.render();
      mount(prevVdom, container);
      isMounted = true;
    } else {
      const newVdom = component.render();
      patch(prevVdom, newVdom);
      prevVdom = newVdom;
    }
  });
}

mountApp(App, document.querySelector(&quot;#app&quot;));
</code></pre>
<h2 id="5-composition-api"><a class="header" href="#5-composition-api">5. Composition API</a></h2>
<p>ä¸€ä¸ªå°å°çš„å°è£…åº”ç”¨</p>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
  &lt;meta charset=&quot;UTF-8&quot;&gt;
  &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
  &lt;title&gt;Document&lt;/title&gt;
  &lt;script src=&quot;https://unpkg.com/vue@next&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;

  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;

  &lt;script&gt;
    const { createApp, ref, watchEffect } = Vue

    function usePost(getId) {
      return useFetch(() =&gt; `https://jsonplaceholder.typicode.com/todos/${getId()}`)
    }

    function useFetch(getUrl) {
      const data = ref(null)
      const error = ref(null)
      const isPending = ref(true)

      watchEffect(() =&gt; {
        isPending.value = true
        data.value = null
        error.value = null
        fetch(getUrl())
          .then(res =&gt; res.json())
          .then(_data =&gt; {
            setTimeout(() =&gt; {
              data.value = _data
              isPending.value = false
            }, 1000)
          })
          .catch(e =&gt; {
            error.value = e
            isPending.value = false
          })
      })
      return { data, error, isPending }
    }

    const Post = {
      template: `
        Posts
        &lt;div v-if='isPending'&gt;Loading...&lt;/div&gt;
        &lt;div v-else-if=&quot;data&quot;&gt;{{ data }}&lt;/div&gt;
        &lt;div v-else-if=&quot;error&quot;&gt;Something is wrong: {{ error.message }}&lt;/div&gt;
      `,
      props: {
        id: 0
      },
      setup(props) {
        console.log('props', props);
        const { data, error, isPending } = usePost(() =&gt; props.id)
        return {
          data,
          error,
          isPending
        }
      }
    }

    const App = {
      components: { Post },
      data() {
        return {
          id: 1
        }
      },
      template: `
        &lt;button @click=&quot;id++&quot;&gt;Change ID&lt;/button&gt;
        &lt;Post :id=&quot;2&quot;/&gt;
      `
    }

    createApp(App).mount(&quot;#app&quot;)

  &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vue"><a class="header" href="#vue">Vue</a></h1>
<h2 id="vue2x"><a class="header" href="#vue2x">Vue2.x</a></h2>
<h3 id="vue-åŸºç¡€"><a class="header" href="#vue-åŸºç¡€">Vue åŸºç¡€</a></h3>
<h4 id="src-å¼•å…¥"><a class="header" href="#src-å¼•å…¥">src å¼•å…¥</a></h4>
<pre><code class="language-javascript">&lt;script src=&quot;https://cdn.jsdelivr.net/npm/vue/dist/vue.js&quot;&gt;&lt;/script&gt;;
</code></pre>
<h4 id="questionhtml-ä¾‹å­"><a class="header" href="#questionhtml-ä¾‹å­">question.html ä¾‹å­</a></h4>
<pre><code class="language-javascript">&lt;!DOCTYPE html&gt;
&lt;html&gt;
	&lt;head&gt;
		&lt;meta charset=&quot;utf-8&quot;&gt;
		&lt;script src=&quot;vue.js&quot; type=&quot;text/javascript&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;
		&lt;script src=&quot;https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js&quot;&gt;&lt;/script&gt;
	&lt;/head&gt;
	&lt;body&gt;
		&lt;div id=&quot;watch-example&quot;&gt;
		  &lt;p&gt;è¾“å…¥æ¡†ï¼š
			&lt;input v-model=&quot;question&quot; placeholder=&quot;sss&quot;&gt;
		  &lt;/p&gt;
		  &lt;p&gt; ç­”æ¡ˆï¼š {{ answer }}&lt;/p&gt;
           &lt;!--// {{}}è¯­æ³•ä¸èƒ½ä½œç”¨åœ¨ HTML attribute ä¸Šï¼Œçš„ä½†æ˜¯å¯ä»¥ç”¨ [attributeName]
             å¯ä»¥åµŒå…¥ JavaScript è¡¨è¾¾å¼--&gt;
		&lt;/div&gt;
		&lt;script&gt;
			var vm = new Vue({
				el: &quot;#watch-example&quot;,  // 1. ç»‘å®šçš„æ ¹èŠ‚ç‚¹
				data: {   // 2. ä¸€ä¸ªç»„ä»¶çš„ data é€‰é¡¹å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°  data: function () {return {count: 0}}
					question: '',
					answer: &quot;ä½ è¿˜æ²¡æœ‰è¾“å…¥ä»»ä½•é—®é¢˜&quot;,
				},
				watch: {  // å¦‚æœ `question` å‘ç”Ÿæ”¹å˜ï¼Œè¿™ä¸ªå‡½æ•°å°±ä¼šè¿è¡Œ
					question: function(newQuestion, oldQuestion) {
						console.log(1);
						this.answer = &quot;ç­‰å¾…æ‚¨è¾“å…¥å®Œæˆ&quot;;   // åªæœ‰å½“å®ä¾‹è¢«åˆ›å»ºæ—¶å°±å·²ç»å­˜åœ¨äº data ä¸­çš„ property æ‰æ˜¯å“åº”å¼çš„
						setTimeout(function(){}, 1000);
						this.getAnswer();
					}
				},
				methods: {
					getAnswer: function() {
						console.log(&quot;æ­£åœ¨æŸ¥è¯¢ç»“æœ&quot;)
						if (this.question.indexOf(&quot;?&quot;) === -1) {
							this.answer = 'é—®é¢˜è¦ä»¥ï¼Ÿç»“å°¾';
						}
						this.answer = &quot;Thinking...&quot;
						var this_ = this;  // axios ä¸ºæ–°çš„ this
						axios.get(&quot;https://yesno.wtf/api&quot;).then(function (response) {
							this_.answer = &quot;æ‰¾åˆ°ç»“æœ&quot;
						}).catch(function(error) {
							this_.answer = &quot;æ²¡æ‰¾åˆ°ç»“æœ&quot;;
						})
					},
				}
			})
		&lt;/script&gt;
	&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h4 id="è®¡ç®—å±æ€§"><a class="header" href="#è®¡ç®—å±æ€§">è®¡ç®—å±æ€§</a></h4>
<pre><code class="language-javascript">computed: {
   fullName:  // é»˜è®¤ä¸º setï¼Œå¯å¢åŠ  get
     (set: )function () {
     return this.firstName + ' ' + this.lastName
   }
 }
</code></pre>
<h4 id="v-bind-for-class"><a class="header" href="#v-bind-for-class">v-bind for class</a></h4>
<ul>
<li>å¯¹è±¡è¯­æ³•
<pre><code class="language-javascript">// 1.
v-bind:class=&quot;{ active: isActive, 'text-danger': hasError }&quot;
data: {
isActive: true,
hasError: false
}
// 2.
&lt;div v-bind:class=&quot;classObject&quot;&gt;&lt;/div&gt;
data: {
classObject: {
    active: true,
    'text-danger': false
}
}
computed: {
classObject: function () {
    return {
    active: this.isActive &amp;&amp; !this.error,
    'text-danger': this.error &amp;&amp; this.error.type === 'fatal'
    }
}
}
</code></pre>
</li>
<li>æ•°ç»„è¯­æ³•</li>
</ul>
<pre><code class="language-javascript">// 1.
&lt;div v-bind:class=&quot;[activeClass, errorClass]&quot;&gt;&lt;/div&gt;
data: {
  activeClass: 'active',
  errorClass: 'text-danger'
}
// 2.
&lt;div v-bind:class=&quot;[isActive ? activeClass : '', errorClass]&quot;&gt;&lt;/div&gt;
// 3.
&lt;div v-bind:class=&quot;[{ active: isActive }, errorClass]&quot;&gt;&lt;/div&gt;
</code></pre>
<pre><code class="language-javascript"></code></pre>
<h2 id="vuepress"><a class="header" href="#vuepress">VuePress</a></h2>
<h3 id="æ³¨æ„"><a class="header" href="#æ³¨æ„">æ³¨æ„</a></h3>
<ol>
<li>éƒ¨åˆ†å­—ç¬¦éœ€è½¬ä¹‰ï¼Œä¾‹å¦‚<code>&lt;&gt;</code></li>
</ol>
<h3 id="home-é…ç½®"><a class="header" href="#home-é…ç½®">Home é…ç½®</a></h3>
<pre><code class="language-yaml">---
home: true
heroImage: logo.png
heroText: Trdthg çš„ä¸ªäººä¸»é¡µ
# tagline: Hero å‰¯æ ‡é¢˜
# actionText: å¿«é€Ÿä¸Šæ‰‹ â†’
# actionLink: /zh/guide/
features:
- title: ç®€æ´è‡³ä¸Š
  details: ä»¥ Markdown ä¸ºä¸­å¿ƒçš„é¡¹ç›®ç»“æ„ï¼Œä»¥æœ€å°‘çš„é…ç½®å¸®åŠ©ä½ ä¸“æ³¨äºå†™ä½œã€‚
- title: Vue é©±åŠ¨
  details: äº«å— Vue + webpack çš„å¼€å‘ä½“éªŒï¼Œåœ¨ Markdown ä¸­ä½¿ç”¨ Vue ç»„ä»¶ï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨ Vue æ¥å¼€å‘è‡ªå®šä¹‰ä¸»é¢˜ã€‚
- title: é«˜æ€§èƒ½
  details: VuePress ä¸ºæ¯ä¸ªé¡µé¢é¢„æ¸²æŸ“ç”Ÿæˆé™æ€çš„ HTMLï¼ŒåŒæ—¶åœ¨é¡µé¢è¢«åŠ è½½çš„æ—¶å€™ï¼Œå°†ä½œä¸º SPA è¿è¡Œã€‚
footer: MIT Licensed | Copyright Â© 2020-present Evan You
---
</code></pre>
<h3 id="è‡ªå®šä¹‰ä¸»é¢˜"><a class="header" href="#è‡ªå®šä¹‰ä¸»é¢˜">è‡ªå®šä¹‰ä¸»é¢˜</a></h3>
<ol>
<li>
<p>æ–°å»º .vuepress -&gt; styles -&gt; palette.styl</p>
</li>
<li>
<p>ç¤ºä¾‹</p>
</li>
</ol>
<pre><code class="language-styl">// $accentColor =blue//é»˜è®¤ä¸»é¢˜é¢œè‰²
// $textColor = #006400//é»˜è®¤å­—ä½“é¢œè‰²
$textColor = #000//é»˜è®¤å­—ä½“é¢œè‰²
$borderColor = #eaecef//é»˜è®¤è¾¹æ¡†é¢œè‰²
$codeBgColor = #282c34//é»˜è®¤èƒŒæ™¯é¢œè‰²

//ç¤ºä¾‹ä¿®æ”¹ç›¸å…³æ ·å¼ f12 æ‰¾åˆ°éœ€è¦ä¿®æ”¹çš„åœ°æ–¹æ‰¾åˆ°å¯¹åº” class ç±»æ‹¿è¿‡æ¥ç›´æ¥ç”¨å°±è¡Œäº†

.sidebar-group.is-sub-group &gt; .sidebar-heading:not(.clickable){
  opacity :1
}

.theme-container {
  background-image: url(https://www.10wallpaper.com/wallpaper/1920x1200/1909/2019_Red_Blue_Abstract_Design_Desktop_1920x1200.jpg);
  background-repeat:no-repeat;
  background-attachment:fixed;
}
.page {
  padding-top: 5rem;
  padding-left: 15rem;
}
.sidebar {
  width: 15rem;
  opacity:0.5;
}
.theme-default-content {
  top: 200px;
  background-color: #FFFAFA;
}
.content__default {
    // background-color: #000;
    top: 200px;
    border-radius: 10px;
}
</code></pre>
<h3 id="nav--sidebar"><a class="header" href="#nav--sidebar">nav &amp;&amp; sidebar</a></h3>
<pre><code class="language-js">sidebar: {
  '/java/': ['java', 'sourceread', 'spring', 'springboot', 'stuffs'],
  '/js/': ['js', 'vue'],
  '/python/': ['python'],
  '/rust/': ['rust', 'lists'],
  '/other/': ['other', 'script', 'datastructure'],
  '/': [''] //ä¸èƒ½æ”¾åœ¨æ•°ç»„ç¬¬ä¸€ä¸ªï¼Œå¦åˆ™ä¼šå¯¼è‡´å³ä¾§æ æ— æ³•ä½¿ç”¨
}, // ä¾§è¾¹æ é…ç½®
nav:[ // å¯¼èˆªæ é…ç½®
  {text: 'Java',  link: '/java/java'},
  {text: 'å‰ç«¯', link: '/js/js' },
  {text: 'Python', link: '/python/python'},
  {text: 'Rust', link: '/rust/rust' },
  {text: 'å…¶ä»–', link: '/other/other'},
  {text: 'Github', link: 'https://github.com/trdthg'}
],
</code></pre>
<h3 id="æ›´æ–°æ—¶é—´"><a class="header" href="#æ›´æ–°æ—¶é—´">æ›´æ–°æ—¶é—´</a></h3>
<pre><code class="language-js">plugins: ['@vuepress/last-updated'],
themeConfig: {
  lastUpdated: 'Last Updated', // string | boolean
}
</code></pre>
<h3 id="å¾…ç»­-12"><a class="header" href="#å¾…ç»­-12">å¾…ç»­...</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æœªæ•´ç†"><a class="header" href="#æœªæ•´ç†">æœªæ•´ç†</a></h1>
<h2 id="æœªæ•´ç†-1"><a class="header" href="#æœªæ•´ç†-1">æœªæ•´ç†</a></h2>
<ul>
<li>å›¾ç‰‡
<ul>
<li>é›ªç¢§å›¾</li>
<li>svg(svgo)</li>
<li>dataURL
<ul>
<li>ç§ç±»</li>
<li>imgï¼šbase64ï¼Œä»¥åŠä¸ºä»€ä¹ˆç”¨ base64(å‡å°‘è¯·æ±‚)</li>
<li>svg ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ 64ï¼Œä»–æ˜¯æ–‡æœ¬æ ¼å¼ï¼Œimg æ˜¯äºŒè¿›åˆ¶</li>
</ul>
</li>
<li>å›¾æ ‡å­—ä½“ (icon-font)</li>
</ul>
</li>
<li>prefetch åŠ è½½ä¼˜å…ˆçº§ä½çš„èµ„æºï¼Œæ¯”å¦‚å…¶ä»–è·¯ç”±èµ„æºï¼Œlink çš„åˆ«çš„é¡µé¢ç­‰ç­‰</li>
<li>preload åŠ åœ¨å½“å‰è·¯ç”±çš„å¿…è¦èµ„æº</li>
<li>å›¾ç‰‡æ‡’åŠ è½½ data-src -&gt; src (å½“è§†å£åˆ°è¾¾åèµ‹å€¼ï¼ŒåŠ è½½å®ç°æ‡’åŠ è½½å›¾ç‰‡)</li>
<li>é˜²æŠ–ï¼ŒèŠ‚æµ</li>
<li>è·¯ç”±æ‡’åŠ è½½</li>
<li>HTTP2, HTTP3/QUICï¼ŒHTTP é•¿è¿æ¥</li>
<li>Vue è™šæ‹Ÿ DOM ä¼˜åŒ–
<ul>
<li>é™æ€èŠ‚ç‚¹</li>
</ul>
</li>
<li>ç¦æ­¢é€‰ä¸­ | ç¦æ­¢å¤åˆ¶ï¼š
<ul>
<li>css: user-selectï¼šnone</li>
<li>
<h2 id="js"><a class="header" href="#js">js:</a></h2>
<ol>
<li>document.body.selectstart = (e) =&gt; {e.preventDefault()}</li>
</ol>
<ul>
<li>
<ol start="2">
<li>document.body.oncopy = (e) =&gt; {e.preventDefault()}</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>å–æ¶ˆè¯·æ±‚ éœ€è¦ä¸€ä¸ª controller å’Œ siginalï¼ŒæŠŠ siginal ä¼ é€’ç»™è¯·æ±‚å¯¹è±¡ï¼Œä½¿ç”¨ controller æ”¹å˜ signal çš„çŠ¶æ€ï¼Œfetch:
AbortController, axios: CancelToken
<a href="https://z.itpub.net/article/detail/38D9DDF9A9CB14B29239BFEFDA2AD193">é¢è¯•å®˜ï¼šå¦‚ä½•ä¸­æ–­å·²å‘å‡ºå»çš„è¯·æ±‚ï¼Ÿ</a></li>
</ul>
<h1 id="ç½‘ç«™"><a class="header" href="#ç½‘ç«™">ç½‘ç«™</a></h1>
<ul>
<li><a href="http://yulilong.cn/">å‰ç«¯çŸ¥è¯†</a></li>
<li><a href="https://q.shanyue.tech/engineering/">å±±æœˆå‰ç«¯é¢è¯•é¢˜</a></li>
<li><a href="https://www.ttalk.im/index.html">Tech Talk</a></li>
<li><a href="https://github.com/qq449245884/xiaozhi">èµ„æº</a></li>
<li><a href="https://www.kancloud.cn/cyyspring/webpack/1986854">å‰ç«¯å·¥ç¨‹åŒ–å­¦ä¹ ç¬”è®°</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="http-ç›¸å…³"><a class="header" href="#http-ç›¸å…³">HTTP ç›¸å…³</a></h1>
<h2 id="å‹ç¼©"><a class="header" href="#å‹ç¼©">å‹ç¼©</a></h2>
<h3 id="åç«¯-gzip"><a class="header" href="#åç«¯-gzip">åç«¯ gzip</a></h3>
<pre><code>ç½‘å€ trdthg.github.io æ£€æµ‹ç»“æœ
æ˜¯å¦å‹ç¼©æ˜¯
å‹ç¼©ç±»å‹ gzip
åŸå§‹æ–‡ä»¶å¤§å° 23146 å­—èŠ‚
å‹ç¼©åæ–‡ä»¶å¤§å° 3454 å­—èŠ‚
å‹ç¼©ç‡ï¼ˆä¼°è®¡å€¼ï¼‰85.08%
</code></pre>
<h4 id="é…ç½®å‹ç¼©"><a class="header" href="#é…ç½®å‹ç¼©">é…ç½®å‹ç¼©</a></h4>
<ol start="2">
<li>åœ¨ nginx é…ç½®å‹ç¼©æ•ˆæœ
<a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html">å®˜æ–¹ doc</a>
<a href="https://www.cnblogs.com/Renyi-Fan/p/11047490.html">åšå®¢</a></li>
</ol>
<pre><code>gzip on;  #æ˜¯å¦å¼€å¯ gzip æ¨¡å— on è¡¨ç¤ºå¼€å¯ off è¡¨ç¤ºå…³é—­
gzip_buffers 4 16k;  #è®¾ç½®å‹ç¼©æ‰€éœ€è¦çš„ç¼“å†²åŒºå¤§å°
gzip_comp_level 6;  #å‹ç¼©çº§åˆ« 1-9ï¼Œæ•°å­—è¶Šå¤§å‹ç¼©çš„è¶Šå¥½ï¼Œä¹Ÿè¶Šå ç”¨ CPU æ—¶é—´
gzip_min_length 100k;  #è®¾ç½®å…è®¸å‹ç¼©çš„æœ€å°å­—èŠ‚
gzip_http_version 1.1;  #è®¾ç½®å‹ç¼© http åè®®çš„ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯ 1.1
gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;  #è®¾ç½®å‹ç¼©çš„æ–‡ä»¶ç±»å‹
gzip_vary on;  #æ˜¯å¦åœ¨ http header ä¸­æ·»åŠ `Vary: Accept-Encoding`ï¼Œè¾…åŠ©é€‰æ‹©ä¸åŒå‹ç¼©ç®—æ³•äº§ç”Ÿçš„å‰¯æœ¬
</code></pre>
<p>æ³¨æ„ä¸€äº›ä¸å¸¸ç”¨çš„èµ„æºï¼Œæ¯”å¦‚å­—ä½“ï¼Œæœ‰éœ€è¦ä¹Ÿåº”è¯¥åŠ å…¥ gzip_type</p>
<pre><code>å­—ä½“ç±»å‹æ‰©å±•å	Content-type
.eot	application/vnd.ms-fontobject
.ttf	font/ttf
.otf	font/opentype
.woff	font/x-woff
.svg	image/svg+xml
</code></pre>
<p><strong>æ€ä¹ˆé€‰æ‹©åˆé€‚çš„å‹ç¼©æ¯”</strong></p>
<pre><code>gzip_comp_level 0: 0ï¼Œ94840, 63 [ms], 29%
gzip_comp_level 1: 2.43ï¼Œ39005, 248 [ms], 100%
gzip_comp_level 2: 2.51ï¼Œ37743, 273 [ms], 100%
gzip_comp_level 3; 2.57ï¼Œ36849, 327 [ms], 100%
gzip_comp_level 4; 2.73ï¼Œ34807, 370 [ms], 100%
gzip_comp_level 5; 2.80ï¼Œ33898, 491 [ms], 100%
gzip_comp_level 6; 2.82ï¼Œ33686, 604 [ms], 100%
gzip_comp_level 7; 2.82ï¼Œ33626, 659 [ms], 100%
gzip_comp_level 8; 2.82ï¼Œ33626, 698 [ms], 100%
gzip_comp_level 9; 2.82ï¼Œ33626, 698 [ms], 100%
- éšç€å‹ç¼©çº§åˆ«çš„å‡é«˜ï¼Œå‹ç¼©æ¯”æœ‰æ‰€æé«˜ï¼Œä½†åˆ°äº†çº§åˆ« 6 åï¼Œå¾ˆéš¾å†æé«˜ï¼›
- éšç€å‹ç¼©çº§åˆ«çš„å‡é«˜ï¼Œå¤„ç†æ—¶é—´æ˜æ˜¾å˜æ…¢ï¼›
- gzip å¾ˆæ¶ˆè€— cpu çš„æ€§èƒ½ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹ cpu è¾¾åˆ° 100%
</code></pre>
<p>æ³¨æ„äº‹é¡¹</p>
<ul>
<li>ä¸æ˜¯å‹ç¼©çº§åˆ«è¶Šé«˜è¶Šå¥½ï¼Œå…¶å® gzip_comp_level 1 çš„å‹ç¼©èƒ½åŠ›å·²ç»å¤Ÿç”¨äº†ï¼Œåé¢çº§åˆ«è¶Šé«˜ï¼Œå‹ç¼©çš„æ¯”ä¾‹å…¶å®å¢é•¿ä¸å¤§ï¼Œåè€Œå¾ˆåƒå¤„ç†æ€§èƒ½ã€‚</li>
<li>å‹ç¼©ä¸€å®šè¦å’Œé™æ€èµ„æºç¼“å­˜ç›¸ç»“åˆï¼Œç¼“å­˜å‹ç¼©åçš„ç‰ˆæœ¬ï¼Œå¦åˆ™æ¯æ¬¡éƒ½å‹ç¼©é«˜è´Ÿè½½ä¸‹æœåŠ¡å™¨è‚¯å®šåƒä¸ä½ã€‚</li>
<li>å›¾ç‰‡/mp3 è¿™æ ·çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸å¿…å‹ç¼©ï¼Œå› ä¸ºå‹ç¼©ç‡æ¯”è¾ƒå°ï¼Œæ¯”å¦‚ 100 åªèƒ½å‹ç¼©åˆ° 80 å­—èŠ‚ï¼Œè€Œä¸”å‹ç¼©ä¹Ÿæ˜¯è€—è´¹ CPU èµ„æºçš„ã€‚</li>
<li>æ¯”è¾ƒå°çš„æ–‡ä»¶ä¸å¿…å‹ç¼©ï¼Œæ„ä¹‰ä¸å­˜åœ¨ã€‚</li>
</ul>
<h4 id="é…ç½®å‹ç¼©ç¼“å­˜"><a class="header" href="#é…ç½®å‹ç¼©ç¼“å­˜">é…ç½®å‹ç¼©ç¼“å­˜</a></h4>
<p>è¿™é‡Œçš„ç¼“å­˜æ§åˆ¶ä¸»è¦æ˜¯é’ˆå¯¹å›¾ç‰‡ï¼Œcss,js ç­‰å˜åŒ–å‘¨æœŸè¾ƒçŸ­çš„é™æ€æ–‡ä»¶; ç¬¬ä¸€æ¬¡è®¿é—® ä»¥å›¾ç‰‡ä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è®¿é—®è¿™å¼ å›¾ç‰‡æ—¶ï¼ŒæœåŠ¡å™¨è¿”å›çš„æ˜¯
200ï¼ŒåŒæ—¶åœ¨å“åº”å¤´è¿”å›äº†ä¸¤ä¸ªé”®ï¼Œ</p>
<ul>
<li>Etag:å³è¯¥æ–‡ä»¶çš„'æŒ‡çº¹'(å”¯ä¸€æ ‡è¯†)</li>
<li>Last-Modified:'æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´'; æ­¤æ—¶æµè§ˆå™¨ï¼Œä»¥åŠå…¶ä»–çš„ç¼“å­˜æœåŠ¡å™¨å°±ä¼šæŠŠè¿™å¼ å›¾ç‰‡ç»™ç¼“å­˜èµ·æ¥;</li>
</ul>
<p>ç¬¬äºŒæ¬¡è®¿é—® å†æ¬¡è¯·æ±‚è¿™å¼ å›¾ç‰‡æ—¶ï¼Œè¯·æ±‚å¤´å¢åŠ äº†ä¸¤ä¸ªé”®å€¼ï¼Œ</p>
<ul>
<li>If-Modified-Since:ä¸Šæ¬¡å‘ç”Ÿæ”¹å˜çš„æ—¶é—´;</li>
<li>If-None-Match:ä¸Šæ¬¡æ–‡ä»¶æœ¬èº«çš„ Etag å€¼ï¼ŒæœåŠ¡å™¨æ ¹æ®è¿™ä¸¤ä¸ªé”®å€¼åˆ¤æ–­å…¶ Etag å’Œ
Last-Modifiedï¼Œå¦‚æœéƒ½æ²¡å‘ç”Ÿæ”¹å˜å°±ä¸è¿”å›è¿™å¼ å›¾ç‰‡ï¼Œåªè¿”å›ä¸€ä¸ª 304 çš„çŠ¶æ€ç ï¼ŒæœåŠ¡å™¨æ¥æ”¶åˆ°è¿™ä¸ª 304
çš„çŠ¶æ€ç å°±ä¼šè‡ªå·±å»ä»ç¼“å­˜é‡Œé¢æ‰¾è¿™ä¸ªè¢«ç¼“å­˜çš„å›¾ç‰‡;</li>
</ul>
<p>å¯ä»¥å‡å°‘æœåŠ¡å™¨çš„å¸¦å®½å‹åŠ›ä»¥åŠæå‡äº†ç½‘ç«™è®¿é—®é€Ÿåº¦;</p>
<pre><code class="language-conf">location ~* ^.+\.(ico|gif|jpg|jpeg|png)$ {
  access_log   off;
  expires      30d;
}

location ~* ^.+\.(css|js|txt|xml|swf|wav)$ {
  access_log   off;
  expires      24h;
}

location ~* ^.+\.(html|htm)$ {
  expires      1h;
}
</code></pre>
<h3 id="terser-å‹ç¼©"><a class="header" href="#terser-å‹ç¼©">terser å‹ç¼©</a></h3>
<ul>
<li>å»é™¤å¤šä½™å­—ç¬¦ï¼šç©ºæ ¼ï¼Œæ¢è¡ŒåŠæ³¨é‡Š
<ul>
<li>å¤šè¡Œä»£ç å‹ç¼©åˆ°ä¸€è¡Œæ—¶è¦æ³¨æ„è¡Œå°¾åˆ†å·</li>
</ul>
</li>
<li>å‹ç¼©å˜é‡åï¼šå˜é‡åï¼Œå‡½æ•°ååŠå±æ€§å
<ul>
<li>ç¼©çŸ­å˜é‡çš„å‘½åä¹Ÿéœ€è¦ AST æ”¯æŒï¼Œä¸è‡³äºåœ¨ä½œç”¨åŸŸä¸­é€ æˆå‘½åå†²çªã€‚</li>
</ul>
</li>
<li>è§£æç¨‹åºé€»è¾‘ï¼šåˆå¹¶å£°æ˜ä»¥åŠå¸ƒå°”å€¼ç®€åŒ–
<pre><code class="language-js">// å‹ç¼©å‰
const a = 3;
const b = 4;

// å‹ç¼©å
const a = 3, b = 4;

// å‹ç¼©å‰
!b &amp;&amp; !c &amp;&amp; !d &amp;&amp; !e;

// å‹ç¼©å
!(b || c || d || e);
</code></pre>
<ul>
<li>è§£æç¨‹åºé€»è¾‘ï¼šç¼–è¯‘é¢„è®¡ç®—</li>
</ul>
<pre><code class="language-js">// å‹ç¼©å‰
const ONE_YEAR = 365 * 24 * 60 * 60;
// å‹ç¼©å
const ONE_YAAR = 31536000;

// å‹ç¼©å‰
function hello() {
  console.log(&quot;hello, world&quot;);
}
hello();
// å‹ç¼©å
console.log(&quot;hello, world&quot;);
</code></pre>
</li>
</ul>
<h4 id="åº“"><a class="header" href="#åº“">åº“</a></h4>
<p>uglifyã€terser ä¸ swc</p>
<h3 id="tree-shaking"><a class="header" href="#tree-shaking">tree shaking</a></h3>
<ul>
<li>ä¾èµ–äº webpack é™æ€åˆ†æï¼Œç»“åˆ AST åˆ é™¤ä¸å¿…è¦çš„èŠ‚ç‚¹</li>
<li>å¯¹å¼•å…¥çš„ json æ–‡ä»¶åšé™æ€åˆ†æ
<ul>
<li>éœ€è¦ä½¿ç”¨ wabpack æ’ä»¶<code>webpack-json-access-optimizer</code></li>
<li>æŠŠ json è½¬æ¢ä¸º arrayï¼Œå¹¶åˆ é™¤ä¸å¿…è¦çš„å†…å®¹
<pre><code class="language-js">// strings.json
[&quot;Hello world!&quot;, &quot;Hello world again!&quot;];

// index.js
const strings = require(&quot;./strings.json&quot;);
console.log(strings[0], strings[1]);
</code></pre>
</li>
</ul>
</li>
<li>å¯¹ cssï¼Œä¸‹é¢ç”¨åˆ°äº† style-loaderï¼Œä¼šæŠŠ css åŠ åˆ° style æ ‡ç­¾é‡Œ
<pre><code class="language-js">{
    test: /\.css$/,
    use: ['style-loader', 'css-loader'],
}
// You just have to add the sideEffects: true property to it.

{
    test: /\.css$/,
    use: ['style-loader', 'css-loader'],
    sideEffects: true
}
</code></pre>
</li>
<li>sideeffect èƒ½ç›´æ¥è·³è¿‡æ•´ä¸ªæ¨¡å—/æ–‡ä»¶
<img src="https://blog.logrocket.com/tree-shaking-json-files-webpack/" alt="Webpack - Tree Shaking" />
<img src="https://blog.logrocket.com/tree-shaking-json-files-webpack/" alt="JSON-CSS" /></li>
</ul>
<h2 id="http-ç¼“å­˜"><a class="header" href="#http-ç¼“å­˜">http ç¼“å­˜</a></h2>
<h3 id="ä»‹ç»"><a class="header" href="#ä»‹ç»">ä»‹ç»</a></h3>
<p>æ›´å°‘çš„è¯·æ±‚ï¼Œæ›´å°‘çš„æµé‡ï¼Œæ›´å°‘çš„å³°å€¼å¸¦å®½ï¼Œä»è€ŒèŠ‚çœä¸€å¤§ç¬”æœåŠ¡å™¨æˆ–è€… CDN çš„è´¹ç”¨ã€‚</p>
<ul>
<li>å‡å°‘è¯·æ±‚æ¬¡æ•°</li>
<li>å‡å°‘å³°å€¼å¸¦å®½ æ§åˆ¶ HTTP ç¼“å­˜åªéœ€è¦ä½¿ç”¨ Cache-control æ§åˆ¶</li>
</ul>
<blockquote>
<p>Expiresï¼šæ˜¯ http1.0 çš„è§„èŒƒï¼Œå®ƒçš„å€¼æ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´çš„ GMT æ ¼å¼çš„æ—¶é—´å­—ç¬¦ä¸²ã€‚æ¯”å¦‚ç½‘é¡µçš„ Expires å€¼æ˜¯ï¼šexpires:Mar,
06 Apr 2020 10:47:02 GMTã€‚é—®é¢˜ï¼šåˆ°æœŸæ—¶é—´æ˜¯ç”±æœåŠ¡ç«¯ç”Ÿæˆçš„ï¼Œå¦‚æœå®¢æˆ·ç«¯æ—¶é—´è·ŸæœåŠ¡å™¨æ—¶é—´ä¸ä¸€è‡´ï¼Œè¿™å°±ä¼šå¯¼è‡´ç¼“å­˜å‘½ä¸­çš„è¯¯å·®ã€‚
<strong>ä¸¤è€…åŒæ—¶å­˜åœ¨çš„è¯ï¼ŒCache-Control ä¼˜å…ˆçº§é«˜äº Expires</strong></p>
</blockquote>
<h3 id="cache-control"><a class="header" href="#cache-control">Cache-Control</a></h3>
<pre><code>1) max-ageï¼šç”¨æ¥è®¾ç½®èµ„æºï¼ˆrepresentationsï¼‰å¯ä»¥è¢«ç¼“å­˜å¤šé•¿æ—¶é—´ï¼Œå•ä½ä¸ºç§’ï¼›
2) s-maxageï¼šå’Œ max-age æ˜¯ä¸€æ ·çš„ï¼Œä¸è¿‡å®ƒåªé’ˆå¯¹ä»£ç†æœåŠ¡å™¨ç¼“å­˜è€Œè¨€ï¼›**s-maxage çš„ä¼˜å…ˆçº§é«˜äº max-age**

3) publicï¼šå¯ä»¥è¢«æ‰€æœ‰çš„ç”¨æˆ·ç¼“å­˜ï¼ŒåŒ…æ‹¬ç”¨æˆ·æµè§ˆå™¨å’Œ CDN ç­‰ä¸­é—´ä»£ç†æœåŠ¡å™¨ã€‚
4) privateï¼šåªèƒ½è¢«ç”¨æˆ·æµè§ˆå™¨ç¼“å­˜ï¼Œè€Œä¸èƒ½è¢«ä»£ç†æœåŠ¡å™¨ç¼“å­˜ï¼›

5) no-cacheï¼šno-cache æ˜¯ä¼šè¢«ç¼“å­˜çš„ï¼Œä½†æ˜¯ä¾ç„¶å¼ºåˆ¶å®¢æˆ·ç«¯ç›´æ¥å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œåªä¸è¿‡æ¯æ¬¡åœ¨å‘å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰æä¾›å“åº”æ•°æ®æ—¶ï¼Œç¼“å­˜éƒ½è¦å‘æœåŠ¡å™¨è¯„ä¼°ç¼“å­˜å“åº”çš„æœ‰æ•ˆæ€§ã€‚å½“æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ï¼Œä¼šåˆ¤æ–­èµ„æºæ˜¯å¦å˜æ›´ï¼Œå˜æ›´åˆ™è¿”å›æ–°å†…å®¹ï¼Œå¦åˆ™è¿”å› 304ã€‚
6) no-storeï¼šç¦æ­¢ä¸€åˆ‡ç¼“å­˜ï¼ˆå“åº”çœŸçš„ä¸è¢«ç¼“å­˜ï¼‰ã€‚

7) max-staleï¼šèƒ½å®¹å¿çš„æœ€å¤§è¿‡æœŸæ—¶é—´ã€‚max-stale æŒ‡ä»¤æ ‡ç¤ºäº†å®¢æˆ·ç«¯æ„¿æ„æ¥æ”¶ä¸€ä¸ªå·²ç»è¿‡æœŸäº†çš„å“åº”ã€‚å¦‚æœæŒ‡å®šäº† max-stale çš„å€¼ï¼Œåˆ™æœ€å¤§å®¹å¿æ—¶é—´ä¸ºå¯¹åº”çš„ç§’æ•°ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œé‚£ä¹ˆè¯´æ˜æµè§ˆå™¨æ„¿æ„æ¥æ”¶ä»»ä½• age çš„å“åº”ï¼ˆage è¡¨ç¤ºå“åº”ç”±æºç«™ç”Ÿæˆæˆ–ç¡®è®¤çš„æ—¶é—´ä¸å½“å‰æ—¶é—´çš„å·®å€¼ï¼‰ã€‚
8) min-freshï¼šèƒ½å¤Ÿå®¹å¿çš„æœ€å°æ–°é²œåº¦ã€‚min-fresh æ ‡ç¤ºäº†å®¢æˆ·ç«¯ä¸æ„¿æ„æ¥å—æ–°é²œåº¦ä¸å¤šäºå½“å‰çš„ age åŠ ä¸Š min-fresh è®¾å®šçš„æ—¶é—´ä¹‹å’Œçš„å“åº”ã€‚
</code></pre>
<h3 id="ä»€ä¹ˆæ˜¯æŒ‡çº¹"><a class="header" href="#ä»€ä¹ˆæ˜¯æŒ‡çº¹">ä»€ä¹ˆæ˜¯æŒ‡çº¹</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202122340765.png" alt="" />
å¦‚å›¾æ‰€ç¤ºï¼ŒæŒ‡çº¹å°±æ˜¯æ–‡ä»¶çš„ hash å€¼</p>
<ul>
<li>main.js å¸¦æœ‰ hash å€¼ï¼Œå±äºå¸¦æŒ‡çº¹çš„æ°¸ä¹…èµ„æº (å¼ºç¼“å­˜)</li>
<li>index.js ä¸å¸¦ hash å€¼ï¼Œè™½ç„¶è®¾ç½®äº† no-chcheï¼Œä½†æ˜¯ä¾ç„¶æ˜¯åå•†ç¼“å­˜</li>
</ul>
<p>åŒºåˆ«ä¸‹é¢ä¸¤ç§ç¼“å­˜å°±æ˜¯ä¾é æŒ‡çº¹ (æ˜¯ä¸æ˜¯æ°¸ä¹…ç¼“å­˜)ï¼Œè€Œ cache-control å€¼æ˜¯å†³å®šå¯¹ç¼“å­˜çš„å¤„ç†ç­–ç•¥ (å­˜ä¸å­˜ï¼Œç”¨ä¸ç”¨)</p>
<h3 id="æ–‡ä»¶æŒ‡çº¹ç”Ÿæˆç­–ç•¥"><a class="header" href="#æ–‡ä»¶æŒ‡çº¹ç”Ÿæˆç­–ç•¥">æ–‡ä»¶æŒ‡çº¹ç”Ÿæˆç­–ç•¥</a></h3>
<h4 id="ç”Ÿæˆç­–ç•¥"><a class="header" href="#ç”Ÿæˆç­–ç•¥">ç”Ÿæˆç­–ç•¥</a></h4>
<ul>
<li>hashï¼šå½“æœ‰æ–‡ä»¶ä¿®æ”¹ï¼Œæ•´ä¸ªé¡¹ç›®æ„å»ºçš„ hash å€¼å°±ä¼šæ›´æ–°ã€‚ <code>filename: '[name]-[hash].bundle.css'</code></li>
<li>chunkhashï¼šå’Œ webpack æ‰“åŒ…çš„ chunk ç›¸å…³ï¼Œä¸åŒçš„ entry ä¼šç”Ÿæˆä¸åŒçš„ hashï¼Œä¸€èˆ¬ç”¨äº js çš„æ‰“åŒ…ã€‚
<code>filename: '[name]-[chunkhash].bundle.css'</code></li>
<li>contenthashï¼šæ ¹æ®æ–‡ä»¶å†…å®¹æ¥å®šä¹‰ hashï¼Œæ–‡ä»¶å†…å®¹ä¸å˜ï¼Œcontenthash ä¸å˜ã€‚ä¾‹å¦‚ css çš„æ‰“åŒ…ï¼Œç”±äº ä¿®æ”¹ js æˆ– html
æ–‡ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰ä¿®æ”¹å¼•å…¥çš„ css æ ·å¼æ—¶ï¼Œæ–‡ä»¶ä¸éœ€è¦ç”Ÿæˆæ–°çš„å“ˆå¸Œå€¼ï¼Œæ‰€ä»¥å¯é€‚ç”¨äº css çš„æ‰“åŒ…ã€‚
<code>filename: '[name]-[contenthash:8].bundle.css'</code></li>
</ul>
<blockquote>
<p>å¯ä»¥åœ¨å“ˆå¸Œæœ«å°¾é…ç½®å“ˆå¸Œå€¼çš„é•¿åº¦
<a href="https://webpack.js.org/configuration/output/#template-strings">filename é…ç½®æ ¼å¼</a></p>
</blockquote>
<h4 id="js-chunkhash"><a class="header" href="#js-chunkhash">js-chunkhash</a></h4>
<pre><code class="language-js">JS æ–‡ä»¶æŒ‡çº¹è®¾ç½®ï¼š
chunkhash;
module.export = {
  entry: {
    index: &quot;./src/index.js&quot;,
    search: &quot;./src/search.js&quot;,
  },
  output: {
    path: path.resolve(__dirname, &quot;dist&quot;),
    filename: &quot;[name][chunkhash:8].js&quot;,
  },
};
</code></pre>
<h3 id="css-contenthash"><a class="header" href="#css-contenthash">css-contenthash</a></h3>
<p>CSS æ–‡ä»¶æŒ‡çº¹ï¼šcontenthash --ï¼ˆmin-css-extract-plugin å¯ä»¥ç”Ÿäº§ css æ–‡ä»¶ï¼‰
1.ç›´æ¥ä½¿ç”¨'style-loader'æ–¹å¼é€šè¿‡ style æ ‡ç­¾å°† CSS æ’å…¥åˆ° head ä¸­å¹¶æ²¡æœ‰ç”Ÿæˆå•ç‹¬çš„ CSS æ–‡ä»¶ï¼Œå› æ­¤ä¹Ÿä¸å­˜åœ¨
ä½¿ç”¨æŒ‡çº¹æ—¶å€™å¯ä»¥æ›´æ–°æ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡'min-css-extract-plugin'æ’ä»¶å°† CSS æå–æˆå•ç‹¬çš„ CSS æ–‡ä»¶ï¼Œå¹¶æ·»åŠ æ–‡ä»¶æŒ‡çº¹ã€‚2.å®‰è£…ä¾èµ–
mini-css-extract-plugin -- 'npm i mini-css-extract-plugin -D'</p>
<pre><code class="language-js">const MiniCssExtractPlugin = require(&quot;mini-css-extract-plugin&quot;);
module.export = {
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          MiniCssExtractPlugin.loader,
          &quot;css-loader&quot;,
        ],
      },
    ],
  },
  plugins: [
    new MiniCssExtractPlugin({
      filename: &quot;[name][contenthash:8].css&quot;,
    }),
  ],
};
</code></pre>
<h4 id="img-hash"><a class="header" href="#img-hash">img-hash</a></h4>
<p>å›¾ç‰‡æ–‡ä»¶æŒ‡çº¹è®¾ç½®ï¼šhash 1.å…¶ä¸­ï¼Œhash å¯¹åº”çš„æ˜¯æ–‡ä»¶å†…å®¹çš„å“ˆå¸Œå€¼ï¼Œé»˜è®¤ä¸º md5 ç”Ÿæˆï¼Œä¸åŒäºå‰é¢æ‰€è¯´çš„ hash å€¼ã€‚</p>
<pre><code class="language-js">module.export = {
  module: {
    rules: [
      {
        test: /\.(png|svg|jpg|jpeg|gif)$/,
        use: [{
          loader: &quot;file-loader&quot;,
          options: {
            name: &quot;img/[name][hash:8].[ext]&quot;,
          },
        }],
      },
    ],
  },
};
</code></pre>
<h4 id="æ³¨æ„äº‹é¡¹"><a class="header" href="#æ³¨æ„äº‹é¡¹">æ³¨æ„äº‹é¡¹</a></h4>
<blockquote>
<p>ä½¿ç”¨äº† md5 æŒ‡çº¹ä¹‹åå‘ç°æ¯æ¬¡æ‰“åŒ…è¿˜æ˜¯ä¼šå‘ç”Ÿå˜åŒ–ï¼Ÿç­”ï¼šè¿™æ˜¯ç”±äº webpack çš„å¤„ç†æœºåˆ¶å¯¼è‡´çš„ï¼Œwebpack
æ¯æ¬¡æ‰“åŒ…ä¼šæŠŠæ¯ä¸ªæ¨¡å—çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æ–‡ä»¶åã€æ–‡ä»¶é¡ºåºã€æ–‡ä»¶ md5 ç­‰ä¿¡æ¯ä½œä¸ºé…ç½®æ‰“å…¥ js
ä¸­ï¼Œä»¥ä¾¿äºå…¶è¿›è¡Œæ¨¡å—ç®¡ç†ï¼Œè€Œè¿™éƒ¨å†…å®¹ï¼Œæ¯æ¬¡æ‰“åŒ…éƒ½æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´æ•´ä¸ª js æ–‡ä»¶åæ¯æ¬¡éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚webpack æä¾›äº†ä¸€ä¸ª manifest
çš„æœºåˆ¶æ¥å‰¥å‡ºè¿™ä¸ªé…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦ä½¿ç”¨ CommonsChunkPlugin æ¥å°†å…¶å‰¥ç¦»ï¼ŒåŒæ—¶ä½¿ç”¨
chunk-manifest-webpack-plugin è¯»å–å…¶ å†…å®¹å¯¼å‡ºå¦å¤–ä¸€ä¸ªæ–‡ä»¶ï¼Œé˜²æ­¢å…¶å†…å®¹å˜åŒ–å¯¼è‡´æ•´ä¸ª js æ–‡ä»¶æŒ‡çº¹å‘ç”Ÿå˜åŒ–</p>
</blockquote>
<h4 id="bundle-splittingå°½é‡å‡å°‘èµ„æºå˜æ›´"><a class="header" href="#bundle-splittingå°½é‡å‡å°‘èµ„æºå˜æ›´">Bundle Splittingï¼šå°½é‡å‡å°‘èµ„æºå˜æ›´</a></h4>
<p>æŠŠå¤§ js æ–‡ä»¶ï¼Œåˆ†æˆå°çš„æ–‡ä»¶ï¼Œå°½é‡å‡å°‘ç¼“å­˜å¤±æ•ˆçš„èŒƒå›´
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202130126302.png" alt="" />
æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¯¹èµ„æºè¿›è¡Œåˆ†å±‚æ¬¡ç¼“å­˜çš„æ‰“åŒ…æ–¹æ¡ˆï¼Œè¿™æ˜¯ä¸€ä¸ªå»ºè®®æ–¹æ¡ˆï¼š</p>
<ul>
<li>webpack-runtime: åº”ç”¨ä¸­çš„ webpack çš„ç‰ˆæœ¬æ¯”è¾ƒç¨³å®šï¼Œåˆ†ç¦»å‡ºæ¥ï¼Œä¿è¯é•¿ä¹…çš„æ°¸ä¹…ç¼“å­˜</li>
<li>react/react-dom: react çš„ç‰ˆæœ¬æ›´æ–°é¢‘æ¬¡ä¹Ÿè¾ƒä½</li>
<li>vendor: å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹æ¨¡å—æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå¦‚ lodashï¼Œ- classnames
åŸºæœ¬ä¸Šæ¯ä¸ªé¡µé¢éƒ½ä¼šå¼•ç”¨åˆ°ï¼Œä½†æ˜¯å®ƒä»¬çš„æ›´æ–°é¢‘ç‡ä¼šæ›´é«˜ä¸€äº›ã€‚å¦å¤–å¯¹ä½é¢‘æ¬¡ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¸è¦æ‰“è¿›æ¥</li>
<li>pageA: A è·¯ç”±é¡µé¢ï¼Œå½“ A é¡µé¢çš„ç»„ä»¶å‘ç”Ÿå˜æ›´åï¼Œå®ƒçš„ç¼“å­˜å°†ä¼šå¤±æ•ˆ</li>
<li>pageB: B è·¯ç”±é¡µé¢</li>
<li>echarts: ä¸å¸¸ç”¨ä¸”è¿‡å¤§çš„ç¬¬ä¸‰æ–¹æ¨¡å—å•ç‹¬æ‰“åŒ…</li>
<li>mathjax: ä¸å¸¸ç”¨ä¸”è¿‡å¤§çš„ç¬¬ä¸‰æ–¹æ¨¡å—å•ç‹¬æ‰“åŒ…</li>
<li>jspdf: ä¸å¸¸ç”¨ä¸”è¿‡å¤§çš„ç¬¬ä¸‰æ–¹æ¨¡å—å•ç‹¬æ‰“åŒ…</li>
</ul>
<p>éšç€ <strong>http2</strong>
çš„å‘å±•ï¼Œç‰¹åˆ«æ˜¯å¤šè·¯å¤ç”¨ï¼Œåˆå§‹é¡µé¢çš„é™æ€èµ„æºä¸å—èµ„æºæ•°é‡çš„å½±å“ã€‚å› æ­¤ä¸ºäº†æ›´å¥½çš„ç¼“å­˜æ•ˆæœä»¥åŠæŒ‰éœ€åŠ è½½ï¼Œä¹Ÿæœ‰å¾ˆå¤šæ–¹æ¡ˆå»ºè®®æŠŠ<strong>æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹æ¨¡å—è¿›è¡Œå•æ¨¡å—æ‰“åŒ…</strong>ã€‚</p>
<h3 id="æ°¸ä¹…ç¼“å­˜--å¼ºåˆ¶ç¼“å­˜-å¸¦æŒ‡çº¹"><a class="header" href="#æ°¸ä¹…ç¼“å­˜--å¼ºåˆ¶ç¼“å­˜-å¸¦æŒ‡çº¹">æ°¸ä¹…ç¼“å­˜ / å¼ºåˆ¶ç¼“å­˜ (å¸¦æŒ‡çº¹)</a></h3>
<pre><code>Cache-Control: public,max-age=31536000,immutable
</code></pre>
<p>max-age è¡¨ç¤ºç¼“å­˜æ—¶é—´ä¸º 1 å¹´ï¼Œç›´æ¥ä»ç¼“å­˜æ•°æ®åº“ (æµè§ˆå™¨çš„æœ¬åœ°ç¼“å­˜) æ‹¿åˆ°æ•°æ®ï¼Œä¸‹å›¾ä¸­çš„ (disk cache) å°±æ˜¯
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202122312621.png" alt="" />
è€Œä¸ºäº†è§£å†³æ›´æ–°çš„é—®é¢˜ï¼Œå°±éœ€è¦åœ¨æ–‡ä»¶å (æˆ–è€…è·¯å¾„) ä¸­æ·»åŠ  hashï¼Œç‰ˆæœ¬å·ç­‰åŠ¨æ€å­—ç¬¦ï¼Œä¹‹åæ›´æ”¹åŠ¨æ€å­—ç¬¦ï¼Œä»è€Œè¾¾åˆ°æ›´æ”¹å¼•ç”¨ URL çš„ç›®çš„ï¼Œè®©ä¹‹å‰çš„å¼ºåˆ¶ç¼“å­˜å¤±æ•ˆ
(å…¶å®å¹¶æœªç«‹å³å¤±æ•ˆï¼Œåªæ˜¯ä¸å†ä½¿ç”¨äº†è€Œå·²)ã€‚åœ¨çº¿æä¾›çš„ç±»åº“ (å¦‚ jquery-3.3.1.min.js, lodash.min.js ç­‰) å‡é‡‡ç”¨è¿™ä¸ªæ¨¡å¼ã€‚</p>
<p><strong>é»˜è®¤çš„å¼ºåˆ¶ç¼“å­˜æ—¶é—´</strong></p>
<p>é¦–å…ˆè¦æ˜ç¡®ä¸¤ä¸ªå“åº”å¤´ä»£è¡¨çš„å«ä¹‰ï¼š</p>
<ul>
<li>Date: æŒ‡æºæœåŠ¡å™¨å“åº”æŠ¥æ–‡ç”Ÿæˆçš„æ—¶é—´ï¼Œå·®ä¸å¤šä¸å‘è¯·æ±‚çš„æ—¶é—´ç­‰ä»·</li>
<li>Last-Modified: æŒ‡é™æ€èµ„æºä¸Šæ¬¡ä¿®æ”¹çš„æ—¶é—´ï¼Œå–å†³äº mtime</li>
</ul>
<p>LM factor ç®—æ³•è®¤ä¸ºå½“è¯·æ±‚æœåŠ¡å™¨æ—¶ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® Cache-Controlï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡çš„ Last-Modified
è¶Šè¿œï¼Œåˆ™ç”Ÿæˆçš„å¼ºåˆ¶ç¼“å­˜æ—¶é—´è¶Šé•¿ã€‚</p>
<pre><code class="language-js">// ç”¨å…¬å¼è¡¨ç¤ºå¦‚ä¸‹ï¼Œå…¶ä¸­ factor ä»‹äº 0 ä¸ 1 ä¹‹é—´ï¼š
MaxAge = (Date - LastModified) * factor;
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202130123289.png" alt="" /></p>
<h3 id="åå•†ç¼“å­˜--å¯¹æ¯”ç¼“å­˜-ä¸å¸¦æŒ‡çº¹"><a class="header" href="#åå•†ç¼“å­˜--å¯¹æ¯”ç¼“å­˜-ä¸å¸¦æŒ‡çº¹">åå•†ç¼“å­˜ / å¯¹æ¯”ç¼“å­˜ (ä¸å¸¦æŒ‡çº¹)</a></h3>
<p>ç¬¬ä¸€æ¬¡è¯·æ±‚ä¼šç¼“å­˜<code>æ•°æ®ï¼ŒEtagï¼ŒLast-Modified</code>ï¼Œä¹‹åè¯·æ±‚éƒ½è¦å‘å‡ºè¯·æ±‚æºå¸¦<code>If-Modified-Since, If-None-Match</code>åˆ¤æ–­ç¼“å­˜çš„æ—¶æ•ˆæ€§ï¼Œå¦‚æœæ˜¯
304ï¼Œå°±è¡¨ç¤ºç¼“å­˜å¯ç”¨ï¼Œæµè§ˆå™¨å°±ç›´æ¥ç”¨ç¼“å­˜æ•°æ®
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202122321204.png" alt="" /></p>
<h3 id="etag-å’Œ-last-modified-çš„åŒºåˆ«"><a class="header" href="#etag-å’Œ-last-modified-çš„åŒºåˆ«">Etag å’Œ Last-Modified çš„åŒºåˆ«</a></h3>
<p>Etag ä¼˜å…ˆçº§æ›´é«˜ï¼ŒæœåŠ¡å‰å…ˆæ¯”è¾ƒ Etagï¼ŒåŒæ—¶å­˜åœ¨æ—¶ä¼šä»¥ ETag ä¸ºå‡†ã€‚</p>
<h4 id="last-modified--if-modified-since"><a class="header" href="#last-modified--if-modified-since">Last-Modified / If-Modified-Since</a></h4>
<ol>
<li>ç²¾ç¡®åˆ°ç§’ï¼š<code>Last-Modify: Thu,31 Dec 2037 23:59:59 GMT</code></li>
<li>ä½¿ç”¨<code>stat ./xxx.txt</code>è·å–æ–‡ä»¶ (å¤¹) ä¿¡æ¯</li>
</ol>
<p>æœåŠ¡å™¨å“åº”è¯·æ±‚æ—¶ï¼Œä¼šå‘Šè¯‰æµè§ˆå™¨ä¸€ä¸ªå‘Šè¯‰æµè§ˆå™¨èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ï¼šLast-Modifiedï¼Œæµè§ˆå™¨ä¹‹åå†è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šå¸¦ä¸Šä¸€ä¸ªå¤´ï¼šIf-Modified-Sinceï¼Œè¿™ä¸ªå€¼å°±æ˜¯æœåŠ¡å™¨ä¸Šä¸€æ¬¡ç»™çš„
Last-Modified çš„æ—¶é—´ï¼ŒæœåŠ¡å™¨ä¼šæ¯”å¯¹èµ„æºå½“å‰æœ€åçš„ä¿®æ”¹æ—¶é—´ï¼Œå¦‚æœå¤§äº
If-Modified-Sinceï¼Œåˆ™è¯´æ˜èµ„æºä¿®æ”¹è¿‡äº†ï¼Œæµè§ˆå™¨ä¸èƒ½å†ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™æµè§ˆå™¨å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼Œå¹¶è¿”å› 304 çŠ¶æ€ç ã€‚</p>
<h4 id="etag--if-none-match"><a class="header" href="#etag--if-none-match">Etag / If-None-Match</a></h4>
<ol>
<li>Etag/If-None-Match æ˜¯â€œå®ä½“æ ‡ç­¾â€ï¼ˆEntity Tagï¼‰çš„ç¼©å†™</li>
<li>ä¼˜å…ˆçº§é«˜äº Last-Modified / If-Modified-Sinceï¼‰</li>
<li>ä¼˜åŠ¿</li>
</ol>
<ul>
<li>è§£å†³å†…å®¹å¹¶ä¸æ”¹å˜ï¼Œä»…ä»…æ”¹æ”¹å˜ä¿®æ”¹æ—¶é—´çš„é—®é¢˜</li>
<li>è§£å†³åªå°±ç²¾ç¡®åˆ°ç§’çš„é—®é¢˜ï¼šæŸäº›æ–‡ä»¶ä¿®æ”¹éå¸¸é¢‘ç¹ï¼Œæ¯”å¦‚åœ¨ç§’ä»¥ä¸‹çš„æ—¶é—´å†…è¿›è¡Œä¿®æ”¹ï¼Œ(æ¯”æ–¹è¯´ 1s å†…ä¿®æ”¹äº† N æ¬¡)ï¼ŒIf-Modified-Since
èƒ½æ£€æŸ¥åˆ°çš„ç²’åº¦æ˜¯ s çº§çš„ï¼Œè¿™ç§ä¿®æ”¹æ— æ³•åˆ¤æ–­ (æˆ–è€…è¯´ UNIX è®°å½• MTIME åªèƒ½ç²¾ç¡®åˆ°ç§’)ï¼›</li>
<li>æŸäº›æœåŠ¡å™¨ä¸èƒ½ç²¾ç¡®çš„å¾—åˆ°æ–‡ä»¶çš„æœ€åä¿®æ”¹æ—¶é—´ã€‚</li>
</ul>
<p>æœåŠ¡å™¨å“åº”è¯·æ±‚æ—¶ï¼Œé€šè¿‡ Etag å¤´éƒ¨å‘Šè¯‰æµè§ˆå™¨å½“å‰èµ„æºåœ¨æœåŠ¡å™¨çš„å”¯ä¸€æ ‡è¯†ï¼ˆç”Ÿæˆè§„åˆ™ç”±æœåŠ¡å™¨å†³å®šï¼‰ï¼Œæµè§ˆå™¨å†æ¬¡è¯·æ±‚æ—¶ï¼Œå°±ä¼šå¸¦ä¸Šä¸€ä¸ªå¤´
If-None-Matchï¼Œè¿™ä¸ªå€¼å°±æ˜¯æœåŠ¡å™¨ä¸Šä¸€æ¬¡ç»™çš„ Etag çš„å€¼ï¼ŒæœåŠ¡å™¨æ¯”å¯¹ä¸€ä¸‹èµ„æºå½“å‰çš„ Etag æ˜¯å¦è·Ÿ If-None-Match
ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™è¯´æ˜èµ„æºä¿®æ”¹è¿‡äº†ï¼Œæµè§ˆå™¨ä¸èƒ½å†ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™æµè§ˆå™¨å¯ä»¥ç»§ç»­ä½¿ç”¨ç¼“å­˜ï¼Œå¹¶è¿”å› 304 çŠ¶æ€ç ã€‚</p>
<p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#etag">nginx é…ç½® etag</a>
ç”±æ–‡ä»¶å†…å®¹çš„ hash æˆ–è€… mtime/size ç”Ÿæˆ</p>
<h3 id="æœ€ä½³ç¼“å­˜ç­–ç•¥"><a class="header" href="#æœ€ä½³ç¼“å­˜ç­–ç•¥">æœ€ä½³ç¼“å­˜ç­–ç•¥</a></h3>
<h4 id="ç¼“å­˜ä½ç½®"><a class="header" href="#ç¼“å­˜ä½ç½®">ç¼“å­˜ä½ç½®</a></h4>
<p>è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼Œä¼šæŒ‰ç…§ä¼˜å…ˆçº§ï¼ˆService Worker - Memory Cache - Disk Cache - Push
Cacheï¼‰ä¾æ¬¡æŸ¥æ‰¾ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­åˆ™ä½¿ç”¨ç¼“å­˜ï¼Œå¦åˆ™å‘èµ·è¯·æ±‚ã€‚</p>
<ol>
<li>service walker</li>
</ol>
<p>æµè§ˆå™¨èƒŒåçš„ç‹¬ç«‹çº¿ç¨‹ï¼ŒService Worker ä¸­æ¶‰åŠåˆ°è¯·æ±‚æ‹¦æˆªï¼Œæ‰€ä»¥å¿…é¡»ä½¿ç”¨ HTTPS åè®®æ¥ä¿éšœå®‰å…¨</p>
<p>å½“ Service Worker æ²¡æœ‰å‘½ä¸­ç¼“å­˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å»è°ƒç”¨ fetch å‡½æ•°è·å–æ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰åœ¨ Service Worker
å‘½ä¸­ç¼“å­˜çš„è¯ï¼Œä¼šæ ¹æ®ç¼“å­˜æŸ¥æ‰¾ä¼˜å…ˆçº§å»æŸ¥æ‰¾æ•°æ®ã€‚ä½†æ˜¯ä¸ç®¡æˆ‘ä»¬æ˜¯ä» Memory Cache ä¸­è¿˜æ˜¯ä»ç½‘ç»œè¯·æ±‚ä¸­è·å–çš„æ•°æ®ï¼Œæµè§ˆå™¨éƒ½ä¼šæ˜¾ç¤ºæˆ‘ä»¬æ˜¯ä» Service
Worker ä¸­è·å–çš„å†…å®¹ã€‚</p>
<ol start="2">
<li>200 from memory cache</li>
</ol>
<p>ä¸»è¦åŒ…å«çš„æ˜¯å½“å‰ä¸­é¡µé¢ä¸­å·²ç»æŠ“å–åˆ°çš„èµ„æºï¼Œä¼šéšç€è¿›ç¨‹çš„é‡Šæ”¾è€Œé‡Šæ”¾ï¼Œä¸€æ—¦æˆ‘ä»¬å…³é—­ Tab é¡µé¢ï¼Œå†…å­˜ä¸­çš„ç¼“å­˜ä¹Ÿå°±è¢«é‡Šæ”¾äº†ã€‚
ä¸€èˆ¬æ¥è¯´ï¼Œç³»ç»Ÿä¸ä¼šç»™å†…å­˜åˆ†é…è¾ƒå¤§çš„å®¹é‡ï¼Œå› æ­¤å†…å­˜ç¼“å­˜ä¸€èˆ¬ç”¨äºå­˜å‚¨è¾ƒå°æ–‡ä»¶ã€‚åŒæ—¶å†…å­˜ç¼“å­˜åœ¨æœ‰æ—¶æ•ˆæ€§è¦æ±‚çš„åœºæ™¯ä¸‹ä¹Ÿå¾ˆæœ‰ç”¨ï¼ˆæ¯”å¦‚æµè§ˆå™¨çš„éšç§æ¨¡å¼ï¼‰ã€‚å½“å‰ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡é«˜çš„è¯ï¼Œæ–‡ä»¶ä¼˜å…ˆå­˜å‚¨è¿›ç¡¬ç›˜</p>
<blockquote>
<p>è¿˜ä¿å­˜ç€ preload/prefetch ç›¸å…³çš„èµ„æºï¼Œpreloader çš„ç›¸å…³æŒ‡ä»¤å·²ç»æ˜¯é¡µé¢ä¼˜åŒ–çš„å¸¸è§æ‰‹æ®µä¹‹ä¸€ï¼Œå®ƒå¯ä»¥ä¸€è¾¹è§£æ js/css
æ–‡ä»¶ï¼Œä¸€è¾¹ç½‘ç»œè¯·æ±‚ä¸‹ä¸€ä¸ªèµ„æºã€‚200 from prefetch cache åœ¨ preload æˆ– prefetch çš„èµ„æºåŠ è½½æ—¶ï¼Œä¸¤è€…ä¹Ÿæ˜¯å‡å­˜å‚¨åœ¨
http cacheï¼Œå½“èµ„æºåŠ è½½å®Œæˆåï¼Œå¦‚æœèµ„æºæ˜¯å¯ä»¥è¢«ç¼“å­˜çš„ï¼Œé‚£ä¹ˆå…¶è¢«å­˜å‚¨åœ¨ http cache
ä¸­ç­‰å¾…åç»­ä½¿ç”¨ï¼›å¦‚æœèµ„æºä¸å¯è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆå…¶åœ¨è¢«ä½¿ç”¨å‰å‡å­˜å‚¨åœ¨ memory cacheã€‚</p>
</blockquote>
<ol start="3">
<li>
<p>200 from disk cache
è¡¨ç¤ºä¸è®¿é—®æœåŠ¡å™¨ï¼Œç›´æ¥ä»ç¡¬ç›˜ä¸­è¯»å–ç¼“å­˜ã€‚ä¸å†…å­˜ç›¸æ¯”ï¼Œç¡¬ç›˜çš„è¯»å–é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œä½†ç¡¬ç›˜ç¼“å­˜æŒç»­çš„æ—¶é—´æ›´é•¿ï¼Œå…³é—­è¿›ç¨‹ä¹‹åï¼Œç¼“å­˜çš„èµ„æºä»ç„¶å­˜åœ¨ã€‚ç”±äºç¡¬ç›˜çš„å®¹é‡è¾ƒå¤§ï¼Œå› æ­¤ä¸€èˆ¬ç”¨äºå­˜å‚¨å¤§æ–‡ä»¶ã€‚
å¯¹äºå¤§æ–‡ä»¶æ¥è¯´ï¼Œå¤§æ¦‚ç‡æ˜¯ä¸å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œåä¹‹ä¼˜å…ˆ</p>
</li>
<li>
<p>Push cache</p>
</li>
</ol>
<p>Push Cacheï¼ˆæ¨é€ç¼“å­˜ï¼‰æ˜¯ HTTP/2
ä¸­çš„å†…å®¹ï¼Œå½“ä»¥ä¸Šä¸‰ç§ç¼“å­˜éƒ½æ²¡æœ‰å‘½ä¸­æ—¶ï¼Œå®ƒæ‰ä¼šè¢«ä½¿ç”¨ã€‚å®ƒåªåœ¨ä¼šè¯ï¼ˆSessionï¼‰ä¸­å­˜åœ¨ï¼Œä¸€æ—¦ä¼šè¯ç»“æŸå°±è¢«é‡Šæ”¾ï¼Œå¹¶ä¸”ç¼“å­˜æ—¶é—´ä¹Ÿå¾ˆçŸ­æš‚ï¼Œåœ¨ Chrome
æµè§ˆå™¨ä¸­åªæœ‰ 5 åˆ†é’Ÿå·¦å³ï¼ŒåŒæ—¶å®ƒä¹Ÿå¹¶éä¸¥æ ¼æ‰§è¡Œ HTTP å¤´ä¸­çš„ç¼“å­˜æŒ‡ä»¤ã€‚</p>
<ul>
<li>å¯ä»¥æ¨é€ no-cache å’Œ no-store çš„èµ„æº</li>
<li>ä¸€æ—¦è¿æ¥è¢«å…³é—­ï¼ŒPush Cache å°±è¢«é‡Šæ”¾</li>
<li>å¤šä¸ªé¡µé¢å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª HTTP/2 çš„è¿æ¥ï¼Œå¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª Push Cacheï¼Œæœ‰çš„æµè§ˆå™¨ä¼šå¯¹ç›¸åŒåŸŸåä½†ä¸åŒçš„ tab æ ‡ç­¾ä½¿ç”¨åŒä¸€ä¸ª HTTP è¿æ¥ã€‚</li>
<li>Push Cache ä¸­çš„ç¼“å­˜åªèƒ½è¢«ä½¿ç”¨ä¸€æ¬¡</li>
<li>æµè§ˆå™¨å¯ä»¥æ‹’ç»æ¥å—å·²ç»å­˜åœ¨çš„èµ„æºæ¨é€</li>
<li>ä½ å¯ä»¥ç»™å…¶ä»–åŸŸåæ¨é€èµ„æº</li>
</ul>
<p>å…¶ä»–</p>
<ol>
<li>CDN Cache</li>
</ol>
<p>ä»¥è…¾è®¯ CDN ä¸ºä¾‹ï¼šX-Cache-Lookup:Hit From MemCache è¡¨ç¤ºå‘½ä¸­ CDN èŠ‚ç‚¹çš„å†…å­˜ï¼›X-Cache-Lookup:Hit
From Disktank è¡¨ç¤ºå‘½ä¸­ CDN èŠ‚ç‚¹çš„ç£ç›˜ï¼›X-Cache-Lookup:Hit From Upstream è¡¨ç¤ºæ²¡æœ‰å‘½ä¸­ CDNã€‚</p>
<ol start="2">
<li>å…¶ä»–çš„ä¸å±•å¼€äº†ï¼Œå…·ä½“å‚è€ƒä¸‹é¢çš„ æ‰€æœ‰ç¼“å­˜æœºåˆ¶çš„è§£è¯»</li>
</ol>
<p>IndexDB(æµè§ˆå™¨æœ¬åœ°å­˜å‚¨)ï¼ŒService Workerï¼ŒLocalStorageï¼ŒSessionStorage</p>
<h4 id="ç”¨æˆ·è¡Œä¸ºå¦‚ä½•è§¦å‘ç¼“å­˜ç­–ç•¥"><a class="header" href="#ç”¨æˆ·è¡Œä¸ºå¦‚ä½•è§¦å‘ç¼“å­˜ç­–ç•¥">ç”¨æˆ·è¡Œä¸ºå¦‚ä½•è§¦å‘ç¼“å­˜ç­–ç•¥</a></h4>
<ol>
<li>
<p>æ‰“å¼€ç½‘é¡µï¼Œåœ°å€æ è¾“å…¥åœ°å€ï¼šæŸ¥æ‰¾ disk cache ä¸­æ˜¯å¦æœ‰åŒ¹é…ã€‚å¦‚æœ‰åˆ™ä½¿ç”¨ï¼›å¦‚æ²¡æœ‰åˆ™å‘é€ç½‘ç»œè¯·æ±‚ã€‚</p>
</li>
<li>
<p>æ™®é€šåˆ·æ–° (F5)ï¼šè·³è¿‡å¼ºç¼“å­˜ï¼Œä½†æ˜¯ä¼šæ£€æŸ¥åå•†ç¼“å­˜ (å› ä¸º TAB å¹¶æ²¡æœ‰å…³é—­ï¼Œå› æ­¤ memory cache æ˜¯å¯ç”¨çš„ï¼Œä¼šè¢«ä¼˜å…ˆä½¿ç”¨
(å¦‚æœåŒ¹é…çš„è¯)ã€‚å…¶æ¬¡æ‰æ˜¯ disk cache)ã€‚</p>
</li>
</ol>
<ul>
<li>å½“ä½ ç‚¹â€œåˆ·æ–°â€æŒ‰é’®çš„æ—¶å€™ï¼Œæµè§ˆå™¨ä¼šåœ¨è¯·æ±‚å¤´é‡ŒåŠ ä¸€ä¸ªâ€œCache-Control: maxage=0â€ã€‚å› ä¸º max-age
æ˜¯â€œç”Ÿå­˜æ—¶é—´â€ï¼Œè€Œæœ¬åœ°ç¼“å­˜é‡Œçš„æ•°æ®è‡³å°‘ä¿å­˜äº†å‡ ç§’é’Ÿï¼Œæ‰€ä»¥æµè§ˆå™¨å°±ä¸ä¼šä½¿ç”¨ç¼“å­˜ï¼Œè€Œæ˜¯å‘æœåŠ¡å™¨å‘è¯·æ±‚ã€‚æœåŠ¡å™¨çœ‹åˆ°
max-age=0ï¼Œä¹Ÿå°±ä¼šç”¨ä¸€ä¸ªæœ€æ–°ç”Ÿæˆçš„æŠ¥æ–‡å›åº”æµè§ˆå™¨ã€‚</li>
</ul>
<ol start="3">
<li>å¼ºåˆ¶åˆ·æ–° (Ctrl + F5)ï¼šæµè§ˆå™¨ä¸ä½¿ç”¨ç¼“å­˜ (è·³è¿‡å¼ºç¼“å­˜å’Œåå•†ç¼“å­˜)ï¼Œç›´æ¥ä»æœåŠ¡å™¨åŠ è½½ï¼Œå› æ­¤å‘é€çš„è¯·æ±‚å¤´éƒ¨å‡å¸¦æœ‰ Cache-control:
no-cache(ä¸ºäº†å…¼å®¹ï¼Œè¿˜å¸¦äº† Pragma: no-cache),æœåŠ¡å™¨ç›´æ¥è¿”å› 200 å’Œæœ€æ–°å†…å®¹ã€‚</li>
</ol>
<ul>
<li>â€œCache-Control: no-cacheâ€ï¼Œå«ä¹‰å’Œâ€œmax-age=0â€åŸºæœ¬ä¸€æ ·ï¼Œå°±çœ‹åå°çš„æœåŠ¡å™¨æ€ä¹ˆç†è§£ï¼Œé€šå¸¸ä¸¤è€…çš„æ•ˆæœæ˜¯ç›¸åŒçš„ã€‚</li>
</ul>
<h4 id="æœ€ä½³ç¼“å­˜ç­–ç•¥-1"><a class="header" href="#æœ€ä½³ç¼“å­˜ç­–ç•¥-1">æœ€ä½³ç¼“å­˜ç­–ç•¥</a></h4>
<p>å®šä¹‰æœ€ä¼˜ç¼“å­˜ç­–ç•¥</p>
<ul>
<li>
<p>æ›´æ–°é¢‘ç¹çš„åº”è¯¥æå–ä¸ºå•æ–‡ä»¶ï¼šæœ‰äº›èµ„æºçš„æ›´æ–°æ¯”å…¶ä»–èµ„æºé¢‘ç¹ã€‚å¦‚æœèµ„æºçš„ç‰¹å®šéƒ¨åˆ†ï¼ˆä¾‹å¦‚ JS å‡½æ•°æˆ–ä¸€ç»„ CSS
æ ·å¼ï¼‰ä¼šç»å¸¸æ›´æ–°ï¼Œåº”è€ƒè™‘å°†å…¶ä»£ç ä½œä¸ºå•ç‹¬çš„æ–‡ä»¶æä¾›ã€‚è¿™æ ·ï¼Œæ¯æ¬¡è·å–æ›´æ–°æ—¶ï¼Œå‰©ä½™å†…å®¹ï¼ˆä¾‹å¦‚ä¸ä¼šé¢‘ç¹æ›´æ–°çš„åº“ä»£ç ï¼‰å¯ä»¥ä»ç¼“å­˜ä¸­è·å–ï¼Œç¡®ä¿ä¸‹è½½çš„å†…å®¹é‡æœ€å°‘ï¼›</p>
</li>
<li>
<p>ç¡®ä¿æœåŠ¡å™¨é…ç½®æˆ–ç§»é™¤ ETagï¼šå› ä¸º Etag è·ŸæœåŠ¡å™¨é…ç½®æœ‰å…³ï¼Œæ¯å°æœåŠ¡å™¨çš„ Etag éƒ½æ˜¯ä¸åŒçš„ï¼›å…¶ä»–</p>
</li>
<li>
<p>ç¡®å®šä¸­ç»§ç¼“å­˜å¯ä»¥ç¼“å­˜å“ªäº›èµ„æºï¼šå¯¹æ‰€æœ‰ç”¨æˆ·çš„å“åº”å®Œå…¨ç›¸åŒçš„èµ„æºå¾ˆé€‚åˆç”± CDN æˆ–å…¶ä»–ä¸­ç»§ç¼“å­˜è¿›è¡Œç¼“å­˜ï¼›</p>
</li>
<li>
<p>ä½¿ç”¨ä¸€è‡´çš„ç½‘å€ï¼šå¦‚æœæ‚¨åœ¨ä¸åŒçš„ç½‘å€ä¸Šæä¾›ç›¸åŒçš„å†…å®¹ï¼Œå°†ä¼šå¤šæ¬¡è·å–å’Œå­˜å‚¨è¯¥å†…å®¹ã€‚æ³¨æ„ï¼šURL åŒºåˆ†å¤§å°å†™ï¼</p>
</li>
<li>
<p>ç¡®å®šæ¯ä¸ªèµ„æºçš„æœ€ä¼˜ç¼“å­˜å‘¨æœŸï¼šä¸åŒçš„èµ„æºå¯èƒ½æœ‰ä¸åŒçš„æ›´æ–°è¦æ±‚ã€‚å®¡æŸ¥å¹¶ç¡®å®šæ¯ä¸ªèµ„æºé€‚åˆçš„ max-ageï¼›</p>
</li>
<li>
<p>ç¡®å®šç½‘ç«™çš„æœ€ä½³ç¼“å­˜å±‚çº§ï¼šå¯¹ HTML æ–‡æ¡£ç»„åˆä½¿ç”¨åŒ…å«å†…å®¹ç‰¹å¾ç çš„èµ„æºç½‘å€ä»¥åŠçŸ­æ—¶é—´æˆ– no-cache çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥æ§åˆ¶å®¢æˆ·ç«¯è·å–æ›´æ–°çš„é€Ÿåº¦ï¼›</p>
</li>
<li>
<p>å–„ç”¨ HTML5 çš„ç¼“å­˜æœºåˆ¶ï¼šåˆç†è®¾è®¡å¯ç”¨ LocalStorageã€SessionStorageã€IndexDBã€SW ç­‰å­˜å‚¨ï¼Œä¼šç»™é¡µé¢æ€§èƒ½å¸¦æ¥æ˜æ˜¾æå‡ï¼›</p>
</li>
<li>
<p>ç”¨å¥½æœ¬åœ°ç¼“å­˜</p>
</li>
</ul>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202130038910.png" alt="" /></p>
<h3 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h3>
<ul>
<li><a href="https://www.jiqizhixin.com/articles/2020-07-24-12">æ‰€æœ‰ç¼“å­˜æœºåˆ¶çš„è§£è¯»</a></li>
<li><a href="https://developer.huawei.com/consumer/cn/forum/topic/0202357360658600848">å‰ç«¯å­¦ä¹ ä¹‹æµè§ˆå™¨ç¼“å­˜æœºåˆ¶</a></li>
<li><a href="https://cloud.tencent.com/developer/news/588770">èµ„æ–™</a></li>
<li><a href="https://shanyue.tech/frontend-engineering/http-cache.html">å±±æœˆ</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching">MDN-caching</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/111190645">ç¼“å­˜ç­–ç•¥ï¼šå¼ºç¼“å­˜&amp;åå•†ç¼“å­˜</a></li>
<li><a href="https://www.kancloud.cn/cyyspring/webpack/1836682">æ–‡ä»¶æŒ‡çº¹</a></li>
</ul>
<h2 id="cookie-å’Œ-session-çš„åŒºåˆ«"><a class="header" href="#cookie-å’Œ-session-çš„åŒºåˆ«">cookie å’Œ session çš„åŒºåˆ«</a></h2>
<p>1.ä½¿ç”¨æ–¹å¼</p>
<p>cookie æœºåˆ¶ï¼šå¦‚æœä¸åœ¨æµè§ˆå™¨ä¸­è®¾ç½®è¿‡æœŸäº‹ä»¶ï¼Œcookie è¢«ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œç”Ÿå‘½å‘¨æœŸéšæµè§ˆå™¨çš„å…³é—­è€Œç»“æŸï¼Œè¿™ç§ cookie ç®€ç§°ä¸ºä¼šè¯
cookieã€‚å¦‚æœåœ¨æµè§ˆå™¨ä¸­è®¾ç½®äº† cookie çš„è¿‡æœŸäº‹ä»¶ï¼Œcookie ä¼šè¢«ä¿å­˜åœ¨ç¡¬ç›˜ä¸­ï¼Œå…³é—­æµè§ˆå™¨åï¼Œcookie
æ•°æ®ä»ç„¶å­˜åœ¨ï¼Œç›´åˆ°è¿‡æœŸäº‹ä»¶ç»“æŸæ‰æ¶ˆå¤±ã€‚cookie æ˜¯æœåŠ¡ç«¯å‘ç»™å®¢æˆ·ç«¯çš„ç‰¹æ®Šä¿¡æ¯ï¼Œcookie æ˜¯ä»¥æ–‡æœ¬çš„æ–¹å¼ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶éƒ½å¸¦ä¸Šå®ƒ</p>
<p>session æœºåˆ¶ï¼šå½“æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚éœ€è¦åˆ›å»º session å¯¹è±¡æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥å®¢æˆ·ç«¯è¯·æ±‚ä¸­æ˜¯å¦åŒ…å« sessionidã€‚å¦‚æœæœ‰
sessionidï¼ŒæœåŠ¡å™¨å°†æ ¹æ®è¯¥ id è¿”å›å¯¹åº” session å¯¹è±¡ã€‚å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚ä¸­æ²¡æœ‰ sessionidï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºæ–°çš„ session å¯¹è±¡ï¼Œå¹¶æŠŠ
sessionid åœ¨æœ¬æ¬¡å“åº”ä¸­è¿”å›ç»™å®¢æˆ·ç«¯ã€‚é€šå¸¸ä½¿ç”¨ cookie æ–¹å¼å­˜å‚¨ sessionid åˆ°å®¢æˆ·ç«¯ï¼Œåœ¨äº¤äº’ä¸­æµè§ˆå™¨æŒ‰ç…§è§„åˆ™å°† sessionid
å‘é€ç»™æœåŠ¡å™¨ã€‚å¦‚æœç”¨æˆ·ç¦ç”¨ cookieï¼Œåˆ™è¦ä½¿ç”¨ URL é‡å†™ï¼Œå¯ä»¥é€šè¿‡ response.encodeURL(url) è¿›è¡Œå®ç°ï¼›API å¯¹
encodeURL çš„ç»“æŸä¸ºï¼Œå½“æµè§ˆå™¨æ”¯æŒ cookie æ—¶ï¼Œurl ä¸åšä»»ä½•å¤„ç†ï¼›å½“æµè§ˆå™¨ä¸æ”¯æŒ cookie çš„æ—¶å€™ï¼Œå°†ä¼šé‡å†™ URL å°†
sessionid æ‹¼æ¥åˆ°è®¿é—®åœ°å€åã€‚</p>
<p>2.ä¿æŒçŠ¶æ€</p>
<p>cookie ä¿å­˜åœ¨æµè§ˆå™¨ç«¯ï¼Œsession ä¿å­˜åœ¨æœåŠ¡å™¨ç«¯</p>
<p>3.å­˜å‚¨çš„å¤§å°</p>
<p>å•ä¸ª cookie ä¿å­˜çš„æ•°æ®ä¸èƒ½è¶…è¿‡ 4kbï¼›session å¤§å°æ²¡æœ‰é™åˆ¶ã€‚</p>
<p>4.å­˜å‚¨å†…å®¹</p>
<p>cookie åªèƒ½ä¿å­˜å­—ç¬¦ä¸²ç±»å‹ï¼Œä»¥æ–‡æœ¬çš„æ–¹å¼ã€‚session é€šè¿‡ç±»ä¼¼ä¸ Hashtable çš„æ•°æ®ç»“æ„æ¥ä¿å­˜ï¼Œèƒ½æ”¯æŒä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼ˆsession
ä¸­å¯å«æœ‰å¤šä¸ªå¯¹è±¡ï¼‰</p>
<p>5.å®‰å…¨æ€§</p>
<p>session çš„å®‰å…¨æ€§å¤§äº cookieã€‚åŸå› å¦‚ä¸‹ï¼š</p>
<p>â‘  sessionid å­˜å‚¨åœ¨ cookie ä¸­ï¼Œè‹¥è¦æ”»ç ´ session é¦–å…ˆè¦æ”»ç ´ cookieï¼› â‘¡ sessionid æ˜¯è¦æœ‰äººç™»å½•ï¼Œæˆ–è€…å¯åŠ¨
session_start æ‰ä¼šæœ‰ï¼Œæ‰€ä»¥æ”»ç ´ cookie ä¹Ÿä¸ä¸€å®šèƒ½å¾—åˆ° sessionidï¼› â‘¢ ç¬¬äºŒæ¬¡å¯åŠ¨ session_start åï¼Œå‰ä¸€æ¬¡çš„
sessionid å°±æ˜¯å¤±æ•ˆäº†ï¼Œsession è¿‡æœŸåï¼Œsessionid ä¹Ÿéšä¹‹å¤±æ•ˆã€‚ â‘£ sessionid æ˜¯åŠ å¯†çš„ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ”»å‡»è€…å¿…é¡»åœ¨çŸ­æ—¶é—´å†…æ”»ç ´åŠ å¯†çš„ sessionidï¼Œè¿™å¾ˆéš¾ã€‚</p>
<p>6.åº”ç”¨åœºæ™¯</p>
<p>cookieï¼šï¼ˆ1ï¼‰åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç™»å½•è¿‡ç½‘ç«™ï¼Œä»¥ä¾¿ä¸‹æ¬¡ç™»å½•æ—¶èƒ½å¤Ÿå®ç°è‡ªåŠ¨ç™»å½•ï¼ˆæˆ–è€…è®°ä½å¯†ç ï¼‰ã€‚ï¼ˆ2ï¼‰ä¿å­˜ä¸Šæ¬¡ç™»å½•çš„äº‹ä»¶ç­‰ä¿¡æ¯ã€‚ï¼ˆ3ï¼‰ä¿å­˜ä¸Šæ¬¡æŸ¥çœ‹çš„é¡µé¢
ï¼ˆ4ï¼‰æµè§ˆè®¡æ•°</p>
<p>sessionï¼š</p>
<p>ï¼ˆ1ï¼‰ç½‘ä¸Šå•†åŸä¸­çš„è´­ç‰©è½¦ï¼ˆ2ï¼‰ä¿å­˜ç”¨æˆ·ç™»å½•ä¿¡æ¯ï¼ˆ3ï¼‰å°†æŸäº›æ•°æ®æ”¾å…¥ session ä¸­ï¼Œä¾›åŒä¸€ç”¨æˆ·çš„ä¸åŒé¡µé¢ä½¿ç”¨ï¼ˆ4ï¼‰é˜²æ­¢ç”¨æˆ·éæ³•ç™»å½•</p>
<h3 id="localstorage-å’Œ-sessionstorage-çš„åŒºåˆ«"><a class="header" href="#localstorage-å’Œ-sessionstorage-çš„åŒºåˆ«">localStorage å’Œ sessionStorage çš„åŒºåˆ«</a></h3>
<p>1.ç”Ÿå‘½å‘¨æœŸ</p>
<p>localStorage çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ°¸ä¹…çš„ï¼Œå…³é—­é¡µé¢æˆ–æµè§ˆå™¨ä¹‹å localStorage ä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šæ¶ˆå¤±ã€‚localStorage
é™¤éä¸»åŠ¨åˆ é™¤æ•°æ®ï¼Œå¦åˆ™æ•°æ®æ°¸è¿œä¸ä¼šæ¶ˆå¤±ã€‚</p>
<p>sessionStorage çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä»…åœ¨å½“å‰ä¼šè¯ä¸‹æœ‰æ•ˆã€‚sessionStorage å¼•å…¥äº†ä¸€ä¸ªâ€œæµè§ˆå™¨çª—å£â€çš„æ¦‚å¿µï¼ŒsessionStorage
æ˜¯åœ¨åŒæºçš„çª—å£ä¸­å§‹ç»ˆå­˜åœ¨çš„æ•°æ®ã€‚åªè¦è¿™ä¸ªæµè§ˆå™¨çª—å£æ²¡æœ‰å…³é—­ï¼Œå³ä½¿åˆ·æ–°é¡µé¢æˆ–è€…è¿›å…¥åŒæºå¦ä¸€ä¸ªé¡µé¢ï¼Œæ•°æ®ä¾ç„¶å­˜åœ¨ã€‚ä½†æ˜¯ sessionStorage
åœ¨å…³é—­äº†æµè§ˆå™¨çª—å£åå°±ä¼šè¢«é”€æ¯ã€‚åŒæ—¶ç‹¬ç«‹çš„æ‰“å¼€åŒä¸€ä¸ªçª—å£åŒä¸€ä¸ªé¡µé¢ï¼ŒsessionStorage ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚</p>
<p>2.å­˜å‚¨å¤§å°</p>
<p>localStorage å’Œ sessionStorage çš„å­˜å‚¨æ•°æ®å¤§å°ä¸€èˆ¬éƒ½æ˜¯ï¼š5MB</p>
<p>3.å­˜å‚¨ä½ç½®</p>
<p>localStorage å’Œ sessionStorage éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯ï¼Œä¸ä¸æœåŠ¡å™¨è¿›è¡Œäº¤äº’é€šä¿¡</p>
<p>4.å­˜å‚¨å†…å®¹ç±»å‹</p>
<p>localStorage å’Œ sessionStorage åªèƒ½å­˜å‚¨å­—ç¬¦ä¸²ç±»å‹ï¼Œå¯¹äºå¤æ‚çš„å¯¹è±¡å¯ä»¥ä½¿ç”¨ ECMAScript æä¾›çš„ JSON å¯¹è±¡çš„
stringify å’Œ parse æ¥å¤„ç†</p>
<p>5.åº”ç”¨åœºæ™¯</p>
<p>localStorageï¼šå¸¸ç”¨äºé•¿æœŸç™»å½•ï¼ˆ+ åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼‰ï¼Œé€‚åˆé•¿æœŸä¿å­˜åœ¨æœ¬åœ°çš„æ•°æ®</p>
<p>sessionStorageï¼šæ•æ„Ÿè´¦å·ä¸€æ¬¡æ€§ç™»å½•</p>
<h3 id="cookie-ä¸­çš„-httponly-çš„å±æ€§å’Œä½œç”¨"><a class="header" href="#cookie-ä¸­çš„-httponly-çš„å±æ€§å’Œä½œç”¨">Cookie ä¸­çš„ httponly çš„å±æ€§å’Œä½œç”¨</a></h3>
<p>1.ä»€ä¹ˆæ˜¯ HttpOnly?</p>
<p>å¦‚æœ cookie ä¸­è®¾ç½®äº† HttpOnly å±æ€§ï¼Œé‚£ä¹ˆï¼Œè¿™æ ·èƒ½æœ‰æ•ˆçš„é˜²æ­¢ XSS æ”»å‡»ï¼Œçªƒå– cookie å†…å®¹ï¼Œè¿™æ ·å°±å¢åŠ äº† cookie
çš„å®‰å…¨æ€§ï¼Œå³ä¾¿æ˜¯è¿™æ ·ï¼Œä¹Ÿä¸è¦å°†é‡è¦ä¿¡æ¯å­˜å…¥ cookieã€‚XSS å…¨ç§° Cross SiteScriptï¼Œè·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ˜¯ Web ç¨‹åºä¸­å¸¸è§çš„æ¼æ´ï¼ŒXSS
å±äºè¢«åŠ¨å¼ä¸”ç”¨äºå®¢æˆ·ç«¯çš„æ”»å‡»æ–¹å¼ï¼Œæ‰€ä»¥å®¹æ˜“è¢«å¿½ç•¥å…¶å±å®³æ€§ã€‚å…¶åŸç†æ˜¯æ”»å‡»è€…å‘æœ‰ XSS æ¼æ´çš„ç½‘ç«™ä¸­è¾“å…¥ (ä¼ å…¥) æ¶æ„çš„ HTML
ä»£ç ï¼Œå½“å…¶å®ƒç”¨æˆ·æµè§ˆè¯¥ç½‘ç«™æ—¶ï¼Œè¿™æ®µ HTML ä»£ç ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚å¦‚ï¼Œç›—å–ç”¨æˆ· Cookieã€ç ´åé¡µé¢ç»“æ„ã€é‡å®šå‘åˆ°å…¶å®ƒç½‘ç«™ç­‰ã€‚</p>
<p>2.HttpOnly çš„è®¾ç½®æ ·ä¾‹</p>
<p>response.setHeader(&quot;Set-Cookie&quot;,
&quot;cookiename=httponlyTest;Path=/;Domain=domainvalue;Max-Age=seconds;HTTPOnly&quot;);
ä¾‹å¦‚ï¼š //è®¾ç½® cookie</p>
<p>response.addHeader(&quot;Set-Cookie&quot;, &quot;uid=112; Path=/; HttpOnly&quot;)</p>
<p>//è®¾ç½®å¤šä¸ª cookie</p>
<p>response.addHeader(&quot;Set-Cookie&quot;, &quot;uid=112; Path=/; HttpOnly&quot;);</p>
<p>response.addHeader(&quot;Set-Cookie&quot;, &quot;timeout=30; Path=/test; HttpOnly&quot;);</p>
<p>//è®¾ç½® https çš„ cookie</p>
<p>response.addHeader(&quot;Set-Cookie&quot;, &quot;uid=112; Path=/; Secure; HttpOnly&quot;);</p>
<p>å…·ä½“å‚æ•°çš„å«ä¹‰å†æ¬¡ä¸åšé˜è¿°ï¼Œè®¾ç½®å®Œæ¯•åé€šè¿‡ js è„šæœ¬æ˜¯è¯»ä¸åˆ°è¯¥ cookie çš„ï¼Œä½†ä½¿ç”¨å¦‚ä¸‹æ–¹å¼å¯ä»¥è¯»å–ã€‚</p>
<p>Cookie cookies[]=request.getCookies();</p>
<h3 id="å‚è€ƒèµ„æ–™-1"><a class="header" href="#å‚è€ƒèµ„æ–™-1">å‚è€ƒ/èµ„æ–™</a></h3>
<ul>
<li><a href="https://github.com/xuexueq/blog/issues/5">æµè§ˆå™¨å­˜å‚¨æ–¹æ¡ˆï¼ˆCookieã€LocalStorageã€SessionStorageï¼‰</a></li>
</ul>
<h2 id="packagejson"><a class="header" href="#packagejson">package.json</a></h2>
<h3 id="dependencies-ä¸-devdependencies-æœ‰ä½•åŒºåˆ«"><a class="header" href="#dependencies-ä¸-devdependencies-æœ‰ä½•åŒºåˆ«">dependencies ä¸ devDependencies æœ‰ä½•åŒºåˆ«</a></h3>
<ul>
<li>å¯¹äºä¸šåŠ¡ä»£ç ï¼Œæ‰“åŒ…æ—¶ä¾é çš„æ˜¯ bundle çš„ä¾èµ–åˆ†æï¼Œä¸ dev æ— å…³</li>
<li>å¯¹äºåº“è€Œè¨€ï¼Œå½“åº“è¢«å¼•å…¥æ—¶ï¼Œdev ä¸­çš„ä¾èµ–ä¸ä¼šè¢«ä¸‹è½½</li>
</ul>
<h3 id="cjsesumd"><a class="header" href="#cjsesumd">cjsã€esã€umd</a></h3>
<ol>
<li>cjs æ˜¯åŠ¨æ€åŠ è½½æ¨¡å—ï¼Œå¯ä»¥ç›´æ¥ require ä¸€ä¸ªå˜é‡</li>
</ol>
<pre><code class="language-js">require(`./${a}`);
</code></pre>
<ol start="2">
<li>esm æ˜¯è¯­è¨€ä¸Šçš„è§„èŒƒï¼Œå› æ­¤åœ¨ Node åŠ æµè§ˆå™¨ä¸­å‡ä¼šæ”¯æŒ</li>
</ol>
<ul>
<li>esm æ˜¯é™æ€å¯¼å…¥ï¼Œå¯ä»¥åœ¨ç¼–è¯‘æœŸè¿›è¡Œ Tree shakingï¼Œå‡å°‘ js ä½“ç§¯</li>
<li>å¦‚æœè¦åŠ¨æ€å¯¼å…¥ï¼Œå¯ä»¥
<pre><code class="language-js">const ms = await import(&quot;https://cdn.skypack.dev/ms@latest&quot;);
ms.default(1000);
</code></pre>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="flutter"><a class="header" href="#flutter">flutter</a></h1>
<h2 id="æ— çº¿è°ƒè¯•"><a class="header" href="#æ— çº¿è°ƒè¯•">æ— çº¿è°ƒè¯•</a></h2>
<blockquote>
<p>è€è¿æ ¹çº¿æ˜¯çœŸçš„ä¸çˆ½ï¼Œusb æ¥å£ä¸ç¨³å®šè€æ˜¯ç«¯å¼€è¿æ¥ğŸ”—ï¼Œè¿™ä¸‹å°±å¥½äº†</p>
</blockquote>
<ol>
<li>æŸ¥çœ‹è¿æ¥è®¾å¤‡</li>
</ol>
<pre><code>Â»Â»Â»Â» adb devices
List of devices attached
LGV358fbccb96	device
</code></pre>
<ol start="2">
<li>è®¾ç½®ç›‘å¬ç«¯å£</li>
</ol>
<pre><code>Â»Â»Â»Â» adb tcpip 1583
restarting in TCP mode port: 1583
</code></pre>
<ol start="3">
<li>å±€åŸŸç½‘å†…è¿æ¥åˆ°æ‰‹æœº</li>
</ol>
<blockquote>
<p>æ‰‹æœº ip ä¸€èˆ¬åœ¨ wifi è®¾ç½®é‡Œå¯ä»¥æŸ¥åˆ°</p>
</blockquote>
<pre><code>Â»Â»Â»Â» adb connect 192.168.31.176:1583
connected to 192.168.31.176:1583
</code></pre>
<h2 id="è·¯ç”±ç³»ç»Ÿ"><a class="header" href="#è·¯ç”±ç³»ç»Ÿ">è·¯ç”±ç³»ç»Ÿ</a></h2>
<h3 id="ä¸¤ä¸ªå…³è”çš„é¡µé¢"><a class="header" href="#ä¸¤ä¸ªå…³è”çš„é¡µé¢">ä¸¤ä¸ªå…³è”çš„é¡µé¢</a></h3>
<pre><code>HOME(FirstRoute) -&gt; SecondRoute HOME(FirstRoute) &lt;- SecondRoute
</code></pre>
<pre><code class="language-dart">class FirstRoute extends StatelessWidget {
  const FirstRoute({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
        appBar: AppBar(title: const Text(&quot;First Route&quot;)),
        body: Center(
          child: ElevatedButton(
            child: const Text(&quot;Open route&quot;),
            onPressed: () {
              Navigator.push(
                context,
                MaterialPageRoute(builder: (context) =&gt; const SecondRoute()),
              );
            },
          ),
        ));
  }
}

class SecondRoute extends StatelessWidget {
  const SecondRoute({Key? key}) : super(key: key);

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text(&quot;Second Route&quot;)),
      body: Center(
          child: ElevatedButton(
        child: const Text(&quot;Go Back!&quot;),
        onPressed: () {
          Navigator.pop(context);
        },
      )),
    );
  }
}
</code></pre>
<h3 id="å®šä¹‰è·¯ç”±"><a class="header" href="#å®šä¹‰è·¯ç”±">å®šä¹‰è·¯ç”±</a></h3>
<ol>
<li>å¸¸è§„çš„æ–¹æ³•</li>
</ol>
<pre><code class="language-dart">// å®šä¹‰è·¯ç”±
initialRoute: '/random-words',
routes: {
    '/': (context) =&gt; const FirstRoute(),
    '/second': (context) =&gt; const SecondRoute(),
    '/random-words': (context) =&gt; const RandomWords(),
},

Navigator.pushNamed(context, '/second');
</code></pre>
<p>::: warn æ³¨æ„ï¼šhome ä¸ initialRoute å†²çª ::: 2. ä½¿ç”¨å¸¸é‡å®šä¹‰åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰è·¯ç”±</p>
<pre><code class="language-dart">class RandomWords extends StatefulWidget {
  const RandomWords({Key? key}) : super(key: key);

    // è¿™é‡Œï¼
  static const routeName = '/random-words';

  @override
  _RandomWordsState createState() =&gt; _RandomWordsState();
}

// ä½¿ç”¨ 1
initialRoute: HomePage.routeName,
routes: {
    FirstRoute.routeName: (context) =&gt; const FirstRoute(),
},

// ä½¿ç”¨ 2
final result = await Navigator.pushNamed(context, SecondRoute.routeName);
</code></pre>
<h3 id="è¿”å›æ•°æ®åˆ°è€é¡µé¢"><a class="header" href="#è¿”å›æ•°æ®åˆ°è€é¡µé¢">è¿”å›æ•°æ®åˆ°è€é¡µé¢</a></h3>
<ul>
<li>pop æ–¹æ³•æœ‰ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¯ä»¥è¿”å›ä¸€äº›ä¸œè¥¿</li>
<li>push æ–¹æ³•æœ‰è¿”å›å€¼ï¼Œå¯ä»¥æ¥æ”¶ pop çš„å€¼ï¼Œä¸è¿‡æ˜¯ Future ç±»å‹ï¼Œéœ€è¦ç”¨ async å’Œ await å¤„ç†</li>
</ul>
<pre><code class="language-dart">// First Route
ElevatedButton(
    child: const Text(&quot;Open new route and choose one&quot;),
    onPressed: () {
        _navigateAndDisplaySelection(context);
    },
),

void _navigateAndDisplaySelection(BuildContext context) async {
    // Navigator.push returns a Future that completes after calling
    // Navigator.pop on the Selection Screen.
    final result = await Navigator.pushNamed(context, '/second');
    ScaffoldMessenger.of(context)
      ..removeCurrentSnackBar()
      ..showSnackBar(SnackBar(content: Text('you choose `$result`')));
}

// Second Route
ElevatedButton(
    child: const Text(&quot;Open route&quot;),
    onPressed: () {
        Navigator.pop(context, &quot;this arg is optional&quot;);
    },
),
</code></pre>
<h3 id="ä¼ é€’æ•°æ®åˆ°æ–°é¡µé¢"><a class="header" href="#ä¼ é€’æ•°æ®åˆ°æ–°é¡µé¢">ä¼ é€’æ•°æ®åˆ°æ–°é¡µé¢</a></h3>
<ol>
<li>é€šè¿‡æ„é€ å‡½æ•°æŒ‡å®šå‚æ•°</li>
</ol>
<p>åªèƒ½åœ¨å®šä¹‰è·¯ç”±æ—¶ï¼š<code>const XXXScreen(args)</code>ä¼ é€’å‚æ•° è¿™ç§æ–¹æ³•åªé€‚ç”¨äºç›´æ¥ navigate åˆ°æ–°é¡µé¢æ—¶ä½¿ç”¨</p>
<pre><code class="language-dart">class TodoDetailScreen extends StatelessWidget {
  const TodoDetailScreen({Key? key, required this.todo}) : super(key: key);

  final Todo todo;
</code></pre>
<ol start="2">
<li>åœ¨ build å‡½æ•°å†…æŒ‡å®šå‚æ•°</li>
</ol>
<p>é€šè¿‡<code>ModalRoute.of</code>å‡½æ•°æ‹¿åˆ°å‚æ•°</p>
<pre><code class="language-dart">class ExtractArguementScreen extends StatelessWidget {
  const ExtractArguementScreen({Key? key}) : super(key: key);

  static const routeName = '/navigator-3-extractArguments';

  @override
  Widget build(BuildContext context) {
    /// `ModalRoute.of`èƒ½è¿”å›å½“å‰è·¯ç”±ä»¥åŠæºå¸¦çš„å‚æ•°
    final args = ModalRoute.of(context)!.settings.arguments as ScreenArguments;

    return Scaffold(
      appBar: AppBar(
        title: Text(args.title),
      ),
      body: Center(child: Text(args.message)),
    );
  }
}
</code></pre>
<ol start="3">
<li>è¿˜æ˜¯åœ¨æ„é€ å‡½æ•°é‡ŒæŒ‡å®šï¼Œä¸è¿‡å®šä¹‰ä¸º<code>ç”Ÿæˆè·¯ç”±</code></li>
</ol>
<pre><code class="language-dart">// å£°æ˜ç»„ä»¶
class PassArguementScreen extends StatelessWidget {
  const PassArguementScreen({Key? key, required this.args}) : super(key: key);

  static const routeName = &quot;/navigator-3-passArguements&quot;;

  // è¿™é‡Œå’Œ 1 ä¸€æ ·
  final ScreenArguments args;

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text(args.title),
      ),
      body: Center(child: Text(args.message)),
    );
  }
}

// å®šä¹‰è·¯ç”±ï¼Œå¯ route å¹¶åˆ—

onGenerateRoute: (settings) {
    if (settings.name == PassArguementScreen.routeName) {
        final args = settings.arguments as ScreenArguments;
        return MaterialPageRoute(builder: (context) {
        return PassArguementScreen(
            args: ScreenArguments(args.title, args.message));
        });
    }
    assert(false, 'Need to implement ${settings.name}');
    return null;
},
</code></pre>
<h3 id="é¡µé¢ä¹‹é—´çš„åŠ¨æ•ˆ"><a class="header" href="#é¡µé¢ä¹‹é—´çš„åŠ¨æ•ˆ">é¡µé¢ä¹‹é—´çš„åŠ¨æ•ˆ</a></h3>
<ol>
<li>Hreo ç»„ä»¶</li>
</ol>
<p>åªéœ€è¦åœ¨ä¸¤ä¸ªé¡µé¢éƒ½æ˜¯ç”¨ Hero ç»„ä»¶åŒ…èµ·æ¥å°±è¡Œäº†</p>
<ul>
<li><code>tag</code>ï¼šä½œä¸º <code>Hero</code> ç»„ä»¶çš„æ ‡è¯†ï¼Œåœ¨è¿™ä¸¤ä¸ªé¡µé¢ä¸­å¿…é¡»ç›¸åŒã€‚</li>
<li><code>child</code>ï¼šåœ¨ä¸¤ä¸ªå±å¹•ç›´æ¥è·¨è¶Šçš„é‚£ä¸ª widgetã€‚</li>
</ul>
<pre><code class="language-dart">child: Hero(
    tag: src,
    child: Image.network(src),
)),
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¸¸ç”¨-css"><a class="header" href="#å¸¸ç”¨-css">å¸¸ç”¨ css</a></h1>
<ul>
<li>ä½¿ç”¨ä¼ªç±»æ‰©å¤§å¯ç‚¹å‡»åŒºåŸŸ</li>
</ul>
<pre><code class="language-css">#btn::before {
  content: &quot;&quot;;
  position: absolute;
  top: -20px;
  right: -20px;
  bottom: -20px;
  left: -20px;
}
</code></pre>
<ul>
<li>sroll-behavior: smooth | å®ç°å¹³æ»‘æ»šåŠ¨</li>
<li>user-select: all | é€‰æ‹©æ‰€æœ‰æ–‡æœ¬</li>
<li>Text Overflow | ...ä»£æ›¿å¤šçš„æ–‡æœ¬</li>
<li>object-fit: cover | ä¿æŒé•¿å®½æ¯”</li>
</ul>
<pre><code class="language-css">img {
  width: 128px;
  height: 128px;
  object-fit: cover;
}
</code></pre>
<ul>
<li>onerror | æ— å›¾ç‰‡ 404</li>
</ul>
<pre><code class="language-css">img.error {
    display: inline-block;
    transform: scale(1);
    content: '';
    color: transparent;
}
img.error::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: #f5f5f5 url('https://cdn-images-1.medium.com/max/1600/1*we8wfyztsdo12e2Cww6oVA.jpeg') no-repeat center / 100% 100%;
}
// ä¸€äº›ä¼˜åŒ–
img.error::after {
    content: attr(alt);
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    line-height: 2;
    background-color: rgba(0, 0, 0, .5);
    color: white;
    font-size: 12px;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
</code></pre>
<p>Image æ— å›¾ç‰‡</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è™šæ‹Ÿ-dom"><a class="header" href="#è™šæ‹Ÿ-dom">è™šæ‹Ÿ DOM</a></h1>
<h2 id="åŸºæœ¬ä»‹ç»"><a class="header" href="#åŸºæœ¬ä»‹ç»">åŸºæœ¬ä»‹ç»</a></h2>
<blockquote>
<p>React çš„ render() æ–¹æ³•ï¼Œä¼šåˆ›å»ºä¸€æ£µç”± React å…ƒç´ ç»„æˆçš„æ ‘ã€‚åœ¨ä¸‹ä¸€æ¬¡ state æˆ– props æ›´æ–°æ—¶ï¼Œç›¸åŒçš„ render()
æ–¹æ³•ä¼šè¿”å›ä¸€æ£µä¸åŒçš„æ ‘ã€‚React éœ€è¦åŸºäºè¿™ä¸¤æ£µæ ‘ä¹‹é—´çš„å·®åˆ«æ¥åˆ¤æ–­å¦‚ä½•é«˜æ•ˆçš„æ›´æ–° UIï¼Œä»¥ä¿è¯å½“å‰ UI ä¸æœ€æ–°çš„æ ‘ä¿æŒåŒæ­¥ã€‚
è¯¥ç®—æ³•ä¸ä¼šå°è¯•åŒ¹é…ä¸åŒç»„ä»¶ç±»å‹çš„å­æ ‘ã€‚å¦‚æœä½ å‘ç°ä½ åœ¨ä¸¤ç§ä¸åŒç±»å‹çš„ç»„ä»¶ä¸­åˆ‡æ¢ï¼Œä½†è¾“å‡ºéå¸¸ç›¸ä¼¼çš„å†…å®¹ï¼Œå»ºè®®æŠŠå®ƒä»¬æ”¹æˆåŒä¸€ç±»å‹ã€‚</p>
</blockquote>
<h2 id="diff-ç®—æ³•"><a class="header" href="#diff-ç®—æ³•">Diff ç®—æ³•</a></h2>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202111251286.png" alt="" /></p>
<h3 id="æ ¹èŠ‚ç‚¹æ˜¯ä¸åŒå…ƒç´ "><a class="header" href="#æ ¹èŠ‚ç‚¹æ˜¯ä¸åŒå…ƒç´ ">æ ¹èŠ‚ç‚¹æ˜¯ä¸åŒå…ƒç´ </a></h3>
<p>React ä¼šæ‹†å¸åŸæœ‰çš„æ ‘å¹¶ä¸”å»ºç«‹èµ·æ–°çš„æ ‘ (è§¦å‘ä¸€ä¸ªå®Œæ•´çš„é‡å»ºæµç¨‹)ã€‚åœ¨æ ¹èŠ‚ç‚¹ä»¥ä¸‹çš„ç»„ä»¶ä¹Ÿä¼šè¢«å¸è½½ï¼Œå®ƒä»¬çš„çŠ¶æ€ä¼šè¢«é”€æ¯ã€‚æ¯”å¦‚ï¼Œå½“æ¯”å¯¹ä»¥ä¸‹æ›´å˜æ—¶ï¼š</p>
<pre><code class="language-jsx">&lt;div&gt;
    &lt;Counter /&gt;
&lt;/div&gt;

&lt;span&gt;
    &lt;Counter /&gt;
&lt;/span&gt;
</code></pre>
<p>React ä¼šé”€æ¯ Counter ç»„ä»¶å¹¶ä¸”é‡æ–°è£…è½½ä¸€ä¸ªæ–°çš„ç»„ä»¶ã€‚</p>
<blockquote>
<p>é”€æ¯çš„è¿‡ç¨‹ï¼šå½“å¸è½½ä¸€æ£µæ ‘æ—¶ï¼Œå¯¹åº”çš„ DOM èŠ‚ç‚¹ä¹Ÿä¼šè¢«é”€æ¯ã€‚ç»„ä»¶å®ä¾‹å°†æ‰§è¡Œ componentWillUnmount() æ–¹æ³•ã€‚å½“å»ºç«‹ä¸€æ£µæ–°çš„æ ‘æ—¶ï¼Œå¯¹åº”çš„
DOM èŠ‚ç‚¹ä¼šè¢«åˆ›å»ºä»¥åŠæ’å…¥åˆ° DOM ä¸­ã€‚ç»„ä»¶å®ä¾‹å°†æ‰§è¡Œ UNSAFE_componentWillMount() æ–¹æ³•ï¼Œç´§æ¥ç€
componentDidMount() æ–¹æ³•ã€‚æ‰€æœ‰ä¸ä¹‹å‰çš„æ ‘ç›¸å…³è”çš„ state ä¹Ÿä¼šè¢«é”€æ¯ã€‚</p>
</blockquote>
<h3 id="å¯¹æ¯”åŒä¸€ç±»å‹å…ƒç´ "><a class="header" href="#å¯¹æ¯”åŒä¸€ç±»å‹å…ƒç´ ">å¯¹æ¯”åŒä¸€ç±»å‹å…ƒç´ </a></h3>
<p>ä¿ç•™åŸæ¥çš„ DOM èŠ‚ç‚¹ï¼Œåªéœ€è¦æ¯”è¾ƒå±æ€§</p>
<pre><code class="language-jsx">&lt;div className=&quot;before&quot; title=&quot;stuff&quot; /&gt;

&lt;div className=&quot;after&quot; title=&quot;stuff&quot; /&gt;
// é€šè¿‡å¯¹æ¯”è¿™ä¸¤ä¸ªå…ƒç´ ï¼ŒReact çŸ¥é“åªéœ€è¦ä¿®æ”¹ DOM å…ƒç´ ä¸Šçš„ className å±æ€§ã€‚
</code></pre>
<p>åœ¨å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’</p>
<h3 id="å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’"><a class="header" href="#å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’">å¯¹å­èŠ‚ç‚¹è¿›è¡Œé€’å½’</a></h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“é€’å½’ DOM èŠ‚ç‚¹çš„å­å…ƒç´ æ—¶ï¼ŒReact ä¼šåŒæ—¶éå†ä¸¤ä¸ªå­å…ƒç´ çš„åˆ—è¡¨ï¼›å½“äº§ç”Ÿå·®å¼‚æ—¶ï¼Œç”Ÿæˆä¸€ä¸ª mutationã€‚</p>
<ul>
<li>åœ¨å­å…ƒç´ åˆ—è¡¨æœ«å°¾æ–°å¢å…ƒç´ æ—¶ï¼Œæ›´æ–°å¼€é”€æ¯”è¾ƒå°ã€‚æ¯”å¦‚ï¼š
<pre><code class="language-jsx">&lt;ul&gt;
    &lt;li&gt;first&lt;/li&gt;
    &lt;li&gt;second&lt;/li&gt;
&lt;/ul&gt;

&lt;ul&gt;
    &lt;li&gt;first&lt;/li&gt;
    &lt;li&gt;second&lt;/li&gt;
    &lt;li&gt;third&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
React ä¼šå…ˆåŒ¹é…ä¸¤ä¸ª <code>&lt;li&gt;first&lt;/li&gt;</code> å¯¹åº”çš„æ ‘ï¼Œç„¶ååŒ¹é…ç¬¬äºŒä¸ªå…ƒç´  <code>&lt;li&gt;second&lt;/li&gt;</code> å¯¹åº”çš„æ ‘ï¼Œæœ€åæ’å…¥ç¬¬ä¸‰ä¸ªå…ƒç´ çš„
<code>&lt;li&gt;third&lt;/li&gt;</code> æ ‘ã€‚</li>
<li>å°†æ–°å¢å…ƒç´ æ’å…¥åˆ°è¡¨å¤´ï¼Œé‚£ä¹ˆæ›´æ–°å¼€é”€ä¼šæ¯”è¾ƒå¤§
<pre><code class="language-jsx">&lt;ul&gt;
    &lt;li&gt;Duke&lt;/li&gt;
    &lt;li&gt;Villanova&lt;/li&gt;
&lt;/ul&gt;

&lt;ul&gt;
    &lt;li&gt;Connecticut&lt;/li&gt;
    &lt;li&gt;Duke&lt;/li&gt;
    &lt;li&gt;Villanova&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
React å¹¶ä¸ä¼šæ„è¯†åˆ°åº”è¯¥ä¿ç•™ <code>&lt;li&gt;Duke&lt;/li&gt;</code> å’Œ
<code>&lt;li&gt;Villanova&lt;/li&gt;</code>ï¼Œè€Œæ˜¯ä¼šé‡å»ºæ¯ä¸€ä¸ªå­å…ƒç´ ã€‚è¿™ç§æƒ…å†µä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚</li>
</ul>
<h3 id="key"><a class="header" href="#key">Key</a></h3>
<ol>
<li>ä½¿ç”¨ Key è¿›è¡Œä¼˜åŒ– ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒReact å¼•å…¥äº† key å±æ€§ã€‚å½“å­å…ƒç´ æ‹¥æœ‰ key æ—¶ï¼ŒReact ä½¿ç”¨ key
æ¥åŒ¹é…åŸæœ‰æ ‘ä¸Šçš„å­å…ƒç´ ä»¥åŠæœ€æ–°æ ‘ä¸Šçš„å­å…ƒç´ ã€‚ä»¥ä¸‹ç¤ºä¾‹åœ¨æ–°å¢ key ä¹‹åï¼Œä½¿å¾—æ ‘çš„è½¬æ¢æ•ˆç‡å¾—ä»¥æé«˜ï¼š</li>
</ol>
<pre><code class="language-jsx">// ç°åœ¨ React çŸ¥é“åªæœ‰å¸¦ç€ '2014' key çš„å…ƒç´ æ˜¯æ–°å…ƒç´ ï¼Œå¸¦ç€ '2015' ä»¥åŠ '2016' key çš„å…ƒç´ ä»…ä»…ç§»åŠ¨äº†ã€‚
&lt;ul&gt;
  &lt;li key=&quot;2015&quot;&gt;Duke&lt;/li&gt;
  &lt;li key=&quot;2016&quot;&gt;Villanova&lt;/li&gt;
&lt;/ul&gt;

&lt;ul&gt;
  &lt;li key=&quot;2014&quot;&gt;Connecticut&lt;/li&gt;
  &lt;li key=&quot;2015&quot;&gt;Duke&lt;/li&gt;
  &lt;li key=&quot;2016&quot;&gt;Villanova&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>å¦ä¸€ä¸ªä¾‹å­</p>
<pre><code class="language-jsx">// è®°çš„å¸¦ä¸Š ID
&lt;div&gt;
  {events.map((event) =&gt; &lt;Event event={event} key={event.id} /&gt;)}
&lt;/div&gt;;
</code></pre>
<ol start="2">
<li>å¦‚ä½•ä½¿ç”¨ Key</li>
</ol>
<pre><code class="language-jsx">&lt;li key={item.id}&gt;{item.name}&lt;/li&gt;;
</code></pre>
<ul>
<li>key ä¸éœ€è¦å…¨å±€å”¯ä¸€ï¼Œä½†åœ¨åˆ—è¡¨ä¸­éœ€è¦ä¿æŒå”¯ä¸€</li>
<li>æ–°å¢ä¸€ä¸ª ID å­—æ®µåˆ°ä½ çš„æ¨¡å‹ä¸­</li>
<li>åˆ©ç”¨ä¸€éƒ¨åˆ†å†…å®¹ä½œä¸ºå“ˆå¸Œå€¼æ¥ç”Ÿæˆä¸€ä¸ª key</li>
<li>å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä¸‹æ ‡ä½œä¸º key :::warn åˆ©ç”¨ä¸‹æ ‡çš„æ³¨æ„äº‹é¡¹</li>
<li>Key åº”è¯¥å…·æœ‰ç¨³å®šï¼Œå¯é¢„æµ‹ï¼Œä»¥åŠåˆ—è¡¨å†…å”¯ä¸€çš„ç‰¹è´¨ã€‚ä¸ç¨³å®šçš„ keyï¼ˆæ¯”å¦‚é€šè¿‡ Math.random() ç”Ÿæˆçš„ï¼‰ä¼šå¯¼è‡´è®¸å¤šç»„ä»¶å®ä¾‹å’Œ DOM
èŠ‚ç‚¹è¢«ä¸å¿…è¦åœ°é‡æ–°åˆ›å»ºï¼Œè¿™å¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™å’Œå­ç»„ä»¶ä¸­çš„çŠ¶æ€ä¸¢å¤±ã€‚</li>
<li>è¿™ä¸ªç­–ç•¥åœ¨å…ƒç´ ä¸è¿›è¡Œé‡æ–°æ’åºæ—¶æ¯”è¾ƒåˆé€‚ï¼Œå¦‚æœæœ‰é¡ºåºä¿®æ”¹ï¼Œdiff å°±ä¼šå˜æ…¢ã€‚</li>
<li>å¦‚æœ key æ˜¯ä¸€ä¸ªä¸‹æ ‡ï¼Œä¿®æ”¹é¡ºåºæ—¶ä¼šä¿®æ”¹å½“å‰çš„ keyï¼Œä¼šå¯¼è‡´éå—æ§ç»„ä»¶çš„ stateï¼ˆæ¯”å¦‚è¾“å…¥æ¡†ï¼‰å¯èƒ½ç›¸äº’ç¯¡æ”¹ï¼Œä¼šå‡ºç°æ— æ³•é¢„æœŸçš„å˜åŠ¨ã€‚ :::</li>
</ul>
<h2 id="ç»„ä»¶æ›´æ–°æ—¶æœº"><a class="header" href="#ç»„ä»¶æ›´æ–°æ—¶æœº">ç»„ä»¶æ›´æ–°æ—¶æœº</a></h2>
<h3 id="ä¸€ä¸ªä¾‹å­"><a class="header" href="#ä¸€ä¸ªä¾‹å­">ä¸€ä¸ªä¾‹å­</a></h3>
<p>App ä¸ºçˆ¶ç»„ä»¶ï¼ŒTile ä¸ºå­ç»„ä»¶</p>
<pre><code class="language-jsx">const App = () =&gt; {
  const [message, setMessage] = React.useState(&quot;&quot;);
  return (
    &lt;&gt;
      &lt;Tile message={message} /&gt;
      &lt;Tile /&gt;
    &lt;/&gt;
  );
};
</code></pre>
<p>æ‰€ä»¥ï¼Œæ¸²æŸ“å‡½æ•°ä¸€å…±è¢«è°ƒç”¨ 3 æ¬¡ï¼ŒçœŸå® dom åªè¢«æ›´æ–° 1 æ¬¡ å½“ message æ›´æ–°åï¼Œä¸¤ä¸ªå­ç»„ä»¶ä¼šè¢«é‡æ–°æ¸²æŸ“ï¼Œå³ä½¿ç¬¬äºŒä¸ª Tail æ²¡æœ‰ prop
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202111209533.png" alt="" />
å…¶ä¸­çº¢è‰²ç‚¹ä»£è¡¨æ¸²æŸ“èŠ‚ç‚¹ã€‚åœ¨ React ä¸­ï¼Œè¿™ä»£è¡¨è°ƒç”¨æ¸²æŸ“å‡½æ•°ã€‚åœ¨çœŸå® DOM ä¸­ï¼Œè¿™ä»£è¡¨é‡æ–°ç»˜åˆ¶ UIã€‚</p>
<ul>
<li>é‡ç»˜ UI çš„æ€§èƒ½ç“¶é¢ˆå·²ç»è¢« React è¿›è¡Œäº†ä¼˜åŒ–ã€‚</li>
<li>ä½†æ˜¯æ‰€æœ‰å·¦ä¾§çš„çº¢è‰²ç‚¹ä»£è¡¨è¿™äº›ç»„ä»¶çš„æ¸²æŸ“å‡½æ•°éƒ½è¢«æ‰§è¡Œäº†ã€‚react éœ€è¦åœ¨ç»„ä»¶ä¸Šä½¿ç”¨ diff ç®—æ³•æ£€æŸ¥ç»„ä»¶çš„å·®å¼‚</li>
</ul>
<h3 id="ä¸€äº›å‡½æ•°"><a class="header" href="#ä¸€äº›å‡½æ•°">ä¸€äº›å‡½æ•°</a></h3>
<ol>
<li>shouldComponentUpdate è¿™ä¸ªå‡½æ•°æ˜¯ React çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ä¹‹ä¸€ï¼Œå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡å‘Šè¯‰ React ä½•æ—¶æ›´æ–°ç±»ç»„ä»¶æ¥ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ã€‚</li>
</ol>
<pre><code class="language-jsx">// å®ƒçš„å‚æ•°æ˜¯ç»„ä»¶è¦è¿›è¡Œæ¸²æŸ“æ—¶ï¼Œä¸‹ä¸€ä¸ª props å’Œä¸‹ä¸€ä¸ª stateï¼š
shouldComponentUpdate(nextProps, nextState) {
  // return true or false
}
</code></pre>
<p>è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼šè¿”å› true ä¼šè®© React è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œè¿”å› false å°±ä¼šé˜»æ­¢ React è°ƒç”¨æ¸²æŸ“å‡½æ•°ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™ä¸æ›´æ–°"><a class="header" href="#ä»€ä¹ˆæ—¶å€™ä¸æ›´æ–°">ä»€ä¹ˆæ—¶å€™ä¸æ›´æ–°</a></h3>
<ul>
<li>props å¹¶æ²¡æœ‰ä½¿ç”¨ setState è¿›è¡Œæ›´æ–°ã€‚
<pre><code class="language-jsx">// æ¯”å¦‚
this.props.user.name = &quot;Felix&quot;;
</code></pre>
</li>
<li>prop çš„å¼•ç”¨å¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</li>
</ul>
<h3 id="å¦‚ä½•å¼ºåˆ¶é‡æ–°æ¸²æŸ“"><a class="header" href="#å¦‚ä½•å¼ºåˆ¶é‡æ–°æ¸²æŸ“">å¦‚ä½•å¼ºåˆ¶é‡æ–°æ¸²æŸ“</a></h3>
<p>ä½¿ç”¨ React Hooks è¿›è¡Œå¼ºåˆ¶æ¸²æŸ“</p>
<pre><code class="language-jsx">const [state, updateState] = React.useState();
const forceUpdate = React.useCallback(() =&gt; updateState({}), []);
</code></pre>
<h2 id="æ”¹å˜ç»“æ„è¿›è¡Œä¼˜åŒ–"><a class="header" href="#æ”¹å˜ç»“æ„è¿›è¡Œä¼˜åŒ–">æ”¹å˜ç»“æ„è¿›è¡Œä¼˜åŒ–</a></h2>
<p>æŠŠ setState æ”¾åˆ°å­ç»„ä»¶å†…éƒ¨</p>
<pre><code class="language-jsx">const InputSelfHandling = () =&gt; {
  const [text, setText] = React.useState(&quot;&quot;);
  return (
    &lt;input
      value={text}
      placeholder=&quot;Write something&quot;
      onChange={(e) =&gt; setText(e.target.value)}
    /&gt;
  );
};
</code></pre>
<h2 id="ä½¿ç”¨-memo-ä¼˜åŒ–"><a class="header" href="#ä½¿ç”¨-memo-ä¼˜åŒ–">ä½¿ç”¨ Memo ä¼˜åŒ–</a></h2>
<h3 id="ä½¿ç”¨-reactmemo"><a class="header" href="#ä½¿ç”¨-reactmemo">ä½¿ç”¨ React.memo()</a></h3>
<p>ä½¿ç”¨æ–¹æ³•éå¸¸ç®€å•</p>
<pre><code class="language-jsx">const Tile = React.memo(() =&gt; {
  let eventUpdates = React.useRef(0);
  return (
    &lt;div className=&quot;black-tile&quot;&gt;
      &lt;Updates updates={eventUpdates.current++} /&gt;
    &lt;/div&gt;
  );
});
</code></pre>
<h3 id="å‘"><a class="header" href="#å‘">å‘</a></h3>
<p>ä¸‹é¢çš„ä¾‹å­ä¸­ React.memo æ— æ•ˆ</p>
<pre><code class="language-jsx">const App = () =&gt; {
  const updates = React.useRef(0);
  const [text, setText] = React.useState(&quot;&quot;);
  //   const data = React.useState(&quot;&quot;);                            // !!! è¿™ä¸ªæ²¡äº‹
  const data = { test: &quot;data&quot; }; // !!! è¿™ä¸ªä¸è¡Œ
  React.useEffect(() =&gt; {
    updates.current++;
  });

  return (
    &lt;div className=&quot;app&quot;&gt;
      &lt;div className=&quot;blue-wrapper&quot;&gt;
        &lt;input
          value={text}
          placeholder=&quot;Write something&quot;
          onChange={(e) =&gt; setText(e.target.value)}
        /&gt;
        &lt;Updates updates={updates.current} /&gt;
        &lt;br /&gt;
        &lt;Tile /&gt;
        &lt;TileMemo data={data} /&gt; // !!! è¿™é‡Œä¼šé‡æ–°æ¸²æŸ“
      &lt;/div&gt;
    &lt;/div&gt;
  );
};

ReactDOM.render(&lt;App /&gt;, document.getElementById(&quot;app&quot;));
</code></pre>
<p>åŸå› ï¼šdata è¿™ä¸ªå˜é‡åœ¨ render å‡½æ•°æ‰§è¡Œåå°±è¢«é‡æ–°å£°æ˜äº†ï¼Œæ‰€ä»¥ä»–ä»¬çš„å¼•ç”¨ä¸åŒï¼Œä½†æ˜¯å€¼æ˜¯ç›¸åŒçš„</p>
<h3 id="è§£å†³æ–¹æ³•"><a class="header" href="#è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</a></h3>
<ol>
<li>ä½¿ç”¨ React.memo çš„ç¬¬äºŒä¸ªå‚æ•°</li>
</ol>
<pre><code class="language-jsx">const TileMemo = React.memo(() =&gt; {
  let updates = React.useRef(0);
  return (
    &lt;div className=&quot;black-tile&quot;&gt;
      &lt;Updates updates={updates.current++} /&gt;
    &lt;/div&gt;
  );
}, (prevProps, nextProps) =&gt; {
  if (prevProps.data.test === nextProps.data.test) {
    return true; // props are equal
  }
  return false; // props are not equal -&gt; update the component
});
</code></pre>
<ol start="2">
<li>ä½¿ç”¨ React.useMemo æŠŠè¿™ç§å˜é‡ç”¨ React.useMemo åŒ…è£¹èµ·æ¥ï¼Œè¿™ä¸ªå˜é‡åœ¨ re-render æ—¶å°±ä¸ä¼šé‡æ–° new</li>
</ol>
<pre><code class="language-jsx">const data = React.useMemo(() =&gt; ({
  test: &quot;data&quot;,
}), []);
</code></pre>
<p>array é‡Œçš„å˜é‡å‘ç”Ÿæ”¹å˜åä¼šé‡æ–°è®¡ç®— data å˜é‡</p>
<h3 id="å…³äºå‡½æ•°"><a class="header" href="#å…³äºå‡½æ•°">å…³äºå‡½æ•°</a></h3>
<p>åœ¨ js é‡Œï¼Œfunction å°±åƒå¯¹è±¡ä¸€æ ·ï¼Œåœ¨ re-render åå¼•ç”¨ä¹Ÿä¼šæ”¹å˜ï¼Œæ‰€ä»¥è¿™æ—¶éœ€è¦ç”¨<code>useCallback</code></p>
<pre><code class="language-js">const App = () =&gt; {
  const updates = React.useRef(0);
  const [text, setText] = React.useState(&quot;&quot;);

  // const onClick = () =&gt; {
  //   console.log('click');
  // };
  const onClick = React.useCallback(() =&gt; {
    console.log(&quot;click&quot;);
  }, []);

  return (
    &lt;div className=&quot;app&quot;&gt;
      &lt;div className=&quot;blue-wrapper&quot;&gt;
        &lt;input
          value={text}
          placeholder=&quot;Write something&quot;
          onChange={(e) =&gt; setText(e.target.value)}
        /&gt;
        &lt;Updates updates={updates.current++} /&gt;
        &lt;Tile /&gt;
        &lt;TileMemo onClick={onClick} /&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  );
};
</code></pre>
<h3 id="ä»€ä¹ˆæ—¶å€™ä¸ä½¿ç”¨"><a class="header" href="#ä»€ä¹ˆæ—¶å€™ä¸ä½¿ç”¨">ä»€ä¹ˆæ—¶å€™ä¸ä½¿ç”¨</a></h3>
<ul>
<li>ç»„ä»¶å¤ªå¤§ï¼Œæ¶ˆè€—å†…å­˜</li>
<li>props å˜æ›´éå¸¸é¢‘ç¹</li>
</ul>
<h2 id="å‚è€ƒ"><a class="header" href="#å‚è€ƒ">å‚è€ƒ</a></h2>
<ul>
<li><a href="https://felixgerschau.com/react-rerender-components/">When does React re-render components?</a></li>
<li><a href="https://www.ttalk.im/2021/12/when-does-react-re-render-components.html">React ä½•æ—¶æ‰ä¼šè¿›è¡Œç»„ä»¶é‡æ¸²æŸ“</a></li>
<li><a href="https://felixgerschau.com/react-performance-react-memo/?utm_source=ttalk.im&amp;utm_medium=website&amp;utm_campaign=Tech%2520Talk">How to use React.memo() to improve performance</a></li>
<li><a href="https://zh-hans.reactjs.org/docs/reconciliation.html">React-é«˜çº§ - åè°ƒ</a>
ç»™å·¥ç¨‹å¸ˆå¸¦æ¥é¢å¤–çš„å¿ƒæ™ºè´Ÿæ‹…ğŸ˜…</li>
<li><a href="https://attardi.org/why-we-memo-all-the-things/">Why We Memo All the Things</a></li>
<li><a href="https://www.ttalk.im/2021/12/why-we-memo-all-the-things.html">ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨æ‰€æœ‰çš„ä¸œè¥¿ä¸Šä½¿ç”¨ Memo</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="frontend-1"><a class="header" href="#frontend-1">frontend</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blog"><a class="header" href="#blog">Blog</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ—¥å¿—"><a class="header" href="#æ—¥å¿—">æ—¥å¿—</a></h1>
<p>::: tip æç¤º this is a tip :::</p>
<h2 id="6-æœˆ"><a class="header" href="#6-æœˆ">6 æœˆ</a></h2>
<h3 id="6-æœˆ-13-æ—¥"><a class="header" href="#6-æœˆ-13-æ—¥">6 æœˆ 13 æ—¥</a></h3>
<p>è®¡åˆ’è¿˜è¡Œå§ï¼Œè™½ç„¶æœŸæœ«æ²¡å¥½å¥½å¤ä¹  çœ‹ java æºç æ˜¯çœŸçš„åŠé€€ï¼ŒHashMap çš„çº¢é»‘æ ‘å®ç°å…ˆæ”¾ä¸€è¾¹å§ï¼Œè¿™è¾¹å‡†å¤‡å…ˆä» TreeMap å…¥æ‰‹ :-ï¼‰
Spring-Cloud-Alibaba çš„ç‰ˆæœ¬é—®é¢˜çœŸçƒ¦äººï¼ŒåŠ äº† @LoadBalancedï¼ŒæœåŠ¡éƒ½åœ¨ nacos æ³¨å†Œäº†ä¹Ÿè¿˜æ˜¯æ‰¾ä¸åˆ°</p>
<h3 id="6-æœˆ-9-æ—¥"><a class="header" href="#6-æœˆ-9-æ—¥">6 æœˆ 9 æ—¥</a></h3>
<p>å»äº†è…¾è®¯ serverless å¤§ä¼šï¼Œå­¦ä¹ äº†ä¸€æ³¢æ–°çŸ¥è¯†ï¼Œåœæ›´äº†å‡ å¤© æŒ‡å®šäº†å­¦ä¹ è®¡åˆ’</p>
<ol>
<li>Rustï¼ˆä¸ªäººå…´è¶£ï¼‰</li>
<li>Javaï¼ˆæ··å£é¥­åƒï¼šåŸºç¡€ + æ¡†æ¶ï¼‰ç›®å‰ç¼“æ­¥æ¨è¿›ä¸­ å¸Œæœ›æ–‡æ¡£è¡¥é½ä¹Ÿèƒ½åŠ å…¥æ¯æ—¥ä»»åŠ¡ä¸­</li>
</ol>
<h3 id="6-æœˆ-2-æ—¥"><a class="header" href="#6-æœˆ-2-æ—¥">6 æœˆ 2 æ—¥</a></h3>
<p>è¿™ä¸¤å¤©è‡ªå·±é€šè¿‡è´­ä¹° VPS æ­å»ºäº†è‡ªå·±çš„ v2rayï¼Œæ­å»ºè¿‡ç¨‹ä¸­æœåŠ¡ç«¯å®‰è£…é…ç½®å¾ˆç®€å•ï¼Œé…ç½®å®Œæˆåå¯ä»¥ç”¨<code>v2ray url</code>è·å– vmess é…ç½®è¿æ¥ï¼Œæ‰‹æœºç«¯è¿æ¥å¾ˆé¡ºåˆ©ï¼Œwindowsï¼Œlinux é…ç½®å¾ˆæœ‰é—®é¢˜ï¼Œlinux ä¸‹ edge æµè§ˆå™¨æ²¡æ³•ç¿»å¢™ï¼Œç›´åˆ°çªç„¶å‘ç°ç«ç‹èƒ½æ­£å¸¸ä½¿ç”¨æ‰çŸ¥é“ edgeï¼ˆchromeï¼‰èµ°çš„æ˜¯ç³»ç»Ÿä»£ç†ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®ç³»ç»Ÿä»£ç†åæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p>
<h2 id="5-æœˆ"><a class="header" href="#5-æœˆ">5 æœˆ</a></h2>
<h3 id="5-æœˆ-31-æ—¥"><a class="header" href="#5-æœˆ-31-æ—¥">5 æœˆ 31 æ—¥</a></h3>
<p>ä¿®å¤äº†å…³è”æŸ¥è¯¢çš„ bug ä¿®å¤äº†æƒé™éªŒè¯çš„ bugï¼Œæƒé™éªŒè¯ä¹Ÿè¦åœ¨ map ä¸­æ·»åŠ  authc è¿›è¡Œç™»å½•éªŒè¯ æŠŠ token æ”¹ä¸ºäº† access_token +
refresh_token å®ç°äº† token çš„è‡ªåŠ¨æ›´æ–° å°† username æ”¹ä¸ºä» token è§£æå¾—åˆ°</p>
<h3 id="5-æœˆ-30-æ—¥"><a class="header" href="#5-æœˆ-30-æ—¥">5 æœˆ 30 æ—¥</a></h3>
<p>ä»Šå¤©å†™äº† Shiro æ¨¡å—ï¼ˆsouthwind_shiroï¼‰ï¼Œä»¥åŠ shiro + redis +
token æ•´åˆç‰ˆï¼Œç°åœ¨å…³äºæƒé™è¿˜æ²¡æœ‰æµ‹è¯•ï¼Œä¸‹ä¸€æ­¥æ˜¯æŠŠæƒé™ä¿¡æ¯ä¹ŸåŠ å…¥åˆ° redis ç¼“å­˜é‡Œï¼Œæ•´ä¸€å¥—å¯ä»¥å¤ç”¨çš„ç™»å½•æ¨¡æ¿</p>
<h3 id="5-æœˆ-27-æ—¥"><a class="header" href="#5-æœˆ-27-æ—¥">5 æœˆ 27 æ—¥</a></h3>
<p>10 å¤©å‰å¼€å¾— hashmap ç»ˆäºç»§ç»­äº†ï¼Œä»Šå¤©åªæŠŠå¢åˆ çœ‹äº†ï¼Œå…³äºçº¢é»‘æ ‘æ–¹é¢çš„å…·ä½“å®ç°æ˜å¤©å†è¯´</p>
<h3 id="5-æœˆ-26-æ—¥"><a class="header" href="#5-æœˆ-26-æ—¥">5 æœˆ 26 æ—¥</a></h3>
<p>èŠ±äº†å‡ å¤©å¤©è£…äº†ä¸ª manjaro ç³»ç»ŸåŒç³»ç»Ÿï¼Œç”¨äº†ä¸¤å¤©æ„Ÿè§‰è¿˜ä¸é”™ï¼Œä»Šå¤©æ—©ä¸Šå‘ç°è€—ç”µé‡ä¸å°½äººæ„ï¼Œåªèƒ½è¯´ä¸€èˆ¬èˆ¬å§ï¼Œæ¯” windows çœ‹ç€å¥½åƒå·®ç‚¹ï¼Œåœ¨ç”¨ç”¨çœ‹å…ˆ;</p>
<h3 id="5-æœˆ-22-æ—¥"><a class="header" href="#5-æœˆ-22-æ—¥">5 æœˆ 22 æ—¥</a></h3>
<p>å¡äº†å‡ å¤©çš„çº¢é»‘æ ‘ç»ˆäºå†™å®Œäº†... å›å»çœ‹ HashMap å§ (â‰§ï¹â‰¦)</p>
<h3 id="5-æœˆ-20-æ—¥"><a class="header" href="#5-æœˆ-20-æ—¥">5 æœˆ 20 æ—¥</a></h3>
<ol>
<li>æ˜¨å¤©çš„ avl æ ‘ï¼Œå› ä¸ºéœ€è¦åœ¨æ·»åŠ èŠ‚ç‚¹åé‡ç½® heightï¼Œå¿…é¡»ä½¿ç”¨é€’å½’</li>
<li>ä»Šå¤©çš„çº¢é»‘æ ‘éå¸¸å¸¦åŠ²ï¼Œåˆ¤æ–­æ—‹è½¬æ¡ä»¶å¤ª xx äº†ï¼Œçº¢é»‘æ ‘æ²¡æœ‰ height äº†ï¼Œwhile å¾ªç¯ä¼šå¥½äº›çš„å¤šï¼Œæˆ‘å´ç”¨é€’å½’ï¼Œä»Šå¤©åªå†™äº† addï¼Œå‰©ä¸‹çš„æ˜å¤©å†è¯´ï¼Œ
å…ˆå†™ä½œä¸šäº†</li>
</ol>
<h3 id="5-æœˆ-18-æ—¥"><a class="header" href="#5-æœˆ-18-æ—¥">5 æœˆ 18 æ—¥</a></h3>
<p>æ˜¨å¤©å¼€äº† HashMap æºç å­¦ä¹  å†³å®šå…ˆå»å­¦ä¹ æ ‘ (äºŒå‰æœç´¢æ ‘ -&gt; AVL æ ‘ -&gt; çº¢é»‘æ ‘)</p>
<h3 id="5-æœˆ-15-æ—¥"><a class="header" href="#5-æœˆ-15-æ—¥">5 æœˆ 15 æ—¥</a></h3>
<p>å¯¹åšå®¢åŠ äº†è‡ªå®šä¹‰å†…å®¹</p>
<ul>
<li>æ·»åŠ èƒŒæ™¯</li>
<li>ç¾åŒ–å¸ƒå±€</li>
<li>åˆ†ç¦» java éƒ¨åˆ†</li>
</ul>
<h3 id="5-æœˆ-14-æ—¥"><a class="header" href="#5-æœˆ-14-æ—¥">5 æœˆ 14 æ—¥</a></h3>
<p>å¼€äº† rust çš„å‘ï¼Œå¼€å‘çœŸçˆ½</p>
<h3 id="5-æœˆ-13-æ—¥"><a class="header" href="#5-æœˆ-13-æ—¥">5 æœˆ 13 æ—¥</a></h3>
<p>å¼€äº†é›†åˆæ¡†æ¶æºç é˜…è¯»çš„å‘</p>
<h3 id="5-æœˆ-12-æ—¥"><a class="header" href="#5-æœˆ-12-æ—¥">5 æœˆ 12 æ—¥</a></h3>
<p>c++ èœé¸Ÿæ•™ç¨‹çœ‹å®Œäº†åæ­£ï¼Œjava ç®€ç›´æ˜¯ C++--, èˆå¼ƒäº†å¤§é‡çš„æ¨¡å—ï¼Œå‡åäº†é¢å‘å¯¹è±¡çš„æ€æƒ³ 8266 micropython æˆåŠŸè¿è¡Œ</p>
<h3 id="5-æœˆ-11-æ—¥"><a class="header" href="#5-æœˆ-11-æ—¥">5 æœˆ 11 æ—¥</a></h3>
<p>å¼€äº† 8266 æ¨¡å—çš„å‘ å¹¶å‘ç¼–ç¨‹ ++</p>
<h3 id="5-æœˆ-10-æ—¥"><a class="header" href="#5-æœˆ-10-æ—¥">5 æœˆ 10 æ—¥</a></h3>
<p>å¼€äº† C++ çš„æ–°å‘ï¼Œçœ‹åˆ°äº†é‡è£ java æŠŠä¹¦çœ‹å®Œäº†ï¼Œæ„Ÿè§‰è®²çš„è´¼æµ…ï¼Œåªè®²äº†æŸäº›ç±»æ€ä¹ˆç”¨è€Œå·²ï¼Œä¸è¿‡ç½‘ç»œç¼–ç¨‹é‚£éƒ¨åˆ†çš„æ„Ÿå¿µå€’æ˜¯æ›´æ¸…æ™°äº† UDP + TCP
å¹¶å‘ç¼–ç¨‹ ++</p>
<h2 id="3-æœˆ"><a class="header" href="#3-æœˆ">3 æœˆ</a></h2>
<h3 id="3-æœˆ-6-æ—¥"><a class="header" href="#3-æœˆ-6-æ—¥">3 æœˆ 6 æ—¥</a></h3>
<h5 id="1-pickle-æ¨¡å—"><a class="header" href="#1-pickle-æ¨¡å—">1. pickle æ¨¡å—</a></h5>
<pre><code class="language-python">#pickle æä¾›äº†ä¸€ä¸ªç®€å•çš„æŒä¹…åŒ–åŠŸèƒ½ã€‚å¯ä»¥å°†å¯¹è±¡ä»¥æ–‡ä»¶çš„å½¢å¼å­˜æ”¾åœ¨ç£ç›˜ä¸Šã€‚
'''pickle æ¨¡å—åªèƒ½åœ¨ python ä¸­ä½¿ç”¨ï¼Œpython ä¸­å‡ ä¹æ‰€æœ‰çš„æ•°æ®ç±»å‹ï¼ˆåˆ—è¡¨ï¼Œå­—å…¸ï¼Œé›†åˆï¼Œç±»ç­‰ï¼‰éƒ½å¯ä»¥ç”¨ pickle æ¥åºåˆ—åŒ–ï¼Œ
pickle åºåˆ—åŒ–åçš„æ•°æ®ï¼Œå¯è¯»æ€§å·®ï¼Œäººä¸€èˆ¬æ— æ³•è¯†åˆ«ã€‚'''

1. pickle.dump(obj, file[, protocol])
  åºåˆ—åŒ–å¯¹è±¡ï¼Œå¹¶å°†ç»“æœæ•°æ®æµå†™å…¥åˆ°æ–‡ä»¶å¯¹è±¡ä¸­ã€‚å‚æ•° protocol æ˜¯åºåˆ—åŒ–æ¨¡å¼ï¼Œé»˜è®¤å€¼ä¸º 0ï¼Œè¡¨ç¤ºä»¥æ–‡æœ¬çš„å½¢å¼åºåˆ—åŒ–ã€‚		protocol çš„å€¼è¿˜å¯ä»¥æ˜¯ 1 æˆ– 2ï¼Œè¡¨ç¤ºä»¥äºŒè¿›åˆ¶çš„å½¢å¼åºåˆ—åŒ–ã€‚
1. pickle.load(file)
  ååºåˆ—åŒ–å¯¹è±¡ã€‚å°†æ–‡ä»¶ä¸­çš„æ•°æ®è§£æä¸ºä¸€ä¸ª Python å¯¹è±¡ã€‚
ã€€ã€€
#å…¶ä¸­è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ load(file) çš„æ—¶å€™ï¼Œè¦è®© python èƒ½å¤Ÿæ‰¾åˆ°ç±»çš„å®šä¹‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š
</code></pre>
<h5 id="2-networksfrom_dict_of_lists"><a class="header" href="#2-networksfrom_dict_of_lists">2. networks.from_dict_of_lists</a></h5>
<pre><code class="language-python"># è¯»å–å­—å…¸å¯¹è±¡ï¼Œå¹¶åˆ¶æˆ graph
dol= {0:[1]} # single edge (0,1)
G=nx.from_dict_of_lists(dol)
</code></pre>
<h2 id="1-æœˆ"><a class="header" href="#1-æœˆ">1 æœˆ</a></h2>
<h3 id="1-æœˆ-14-æ—¥"><a class="header" href="#1-æœˆ-14-æ—¥">1 æœˆ 14 æ—¥</a></h3>
<h4 id="1-java-å¤„ç†-json"><a class="header" href="#1-java-å¤„ç†-json">1. Java å¤„ç† JSON</a></h4>
<pre><code class="language-java">@RequestMapping(value=&quot;/aaa&quot;,  method = RequestMethod.POST)
    @ResponseBody
    public JSONObject aaa(@RequestBody JSONObject user) {
        // ä¸€ã€‚è¯»å– json æ•°æ®
        {
            &quot;num&quot;: 1234567,
            &quot;pwd&quot;: 689753,
            &quot;arr&quot;: [
                {&quot;name&quot;:&quot;å¼ ä¸‰&quot;, &quot;age&quot;:12},
                {&quot;name&quot;:&quot;æå››&quot;, &quot;age&quot;:13},
                {&quot;name&quot;:&quot;ç‹äº”&quot;, &quot;age&quot;:14}
            ]
        }
        // 1.æ™®é€šæ•°æ®
        Integer num = user.get(&quot;num&quot;)
        // 2.åˆ—è¡¨åµŒå¥— json
        ArrayList&lt;Map&gt; mmm = (ArrayList) user.get(&quot;arr&quot;);
        for (Map mm : mmm) {
            System.out.println(mm.get(&quot;name&quot;));
        }

        // äºŒã€‚åˆ›å»º JSONObject å®ä¾‹å¹¶è¿”å›
        //1. æ™®é€šæ•°æ®
        JSONObject user_ = new JSONObject();
        user_.put(&quot;num&quot;, user.get(&quot;num&quot;));
        //2. åˆ—è¡¨
        JSONObject info = new JSONObject();
        info.put(&quot;num&quot;, user.get(&quot;num&quot;));    //åˆ›å»º{}
        JSONArray arr = new JSONArray();
        arr.add(user__);                     // åˆ›å»ºåˆ—è¡¨ arr[],å¹¶æŠŠ info æ·»åŠ åˆ° arr ä¸­ =&gt; [{},{}]
        user_.put(&quot;å¥—å¨ƒ&quot;, arr);              // { key:val, key: [{}, {}]}
        return user_;
    }
</code></pre>
<h4 id="2-arraylist"><a class="header" href="#2-arraylist">2. ArrayList</a></h4>
<ol>
<li>æ·»åŠ ï¼šadd()</li>
<li>å–å€¼ï¼šget( int index )</li>
<li>ä¿®æ”¹ï¼šset( int index, Object obj)</li>
<li>åˆ é™¤ï¼šremove(int index)</li>
<li>è®¡ç®—å¤§å°ï¼šlist.size() æ–¹æ³•</li>
</ol>
<table><thead><tr><th><a href="https://www.runoob.com/java/java-arraylist-addall.html">addAll()</a></th><th>æ·»åŠ é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ åˆ° arraylist ä¸­</th></tr></thead><tbody>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-clear.html">clear()</a></td><td>åˆ é™¤ arraylist ä¸­çš„æ‰€æœ‰å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-clone.html">clone()</a></td><td>å¤åˆ¶ä¸€ä»½ arraylist</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-contains.html">contains()</a></td><td>åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨ arraylist</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-indexof.html">indexOf()</a></td><td>è¿”å› arraylist ä¸­å…ƒç´ çš„ç´¢å¼•å€¼</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-removeall.html">removeAll()</a></td><td>åˆ é™¤å­˜åœ¨äºæŒ‡å®šé›†åˆä¸­çš„ arraylist é‡Œçš„æ‰€æœ‰å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-remove.html">remove()</a></td><td>åˆ é™¤ arraylist é‡Œçš„å•ä¸ªå…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-isempty.html">isEmpty()</a></td><td>åˆ¤æ–­ arraylist æ˜¯å¦ä¸ºç©º</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-sublist.html">subList()</a></td><td>æˆªå–éƒ¨åˆ† arraylist çš„å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-sort.html">sort()</a></td><td>å¯¹ arraylist å…ƒç´ è¿›è¡Œæ’åº</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-toarray.html">toArray()</a></td><td>å°† arraylist è½¬æ¢ä¸ºæ•°ç»„</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-surecapacity.html">ensureCapacity</a>()</td><td>è®¾ç½®æŒ‡å®šå®¹é‡å¤§å°çš„ arraylist</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-lastindexof.html">lastIndexOf()</a></td><td>è¿”å›æŒ‡å®šå…ƒç´ åœ¨ arraylist ä¸­æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-retainall.html">retainAll()</a></td><td>ä¿ç•™ arraylist ä¸­åœ¨æŒ‡å®šé›†åˆä¸­ä¹Ÿå­˜åœ¨çš„é‚£äº›å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-containsall.html">containsAll()</a></td><td>æŸ¥çœ‹ arraylist æ˜¯å¦åŒ…å«æŒ‡å®šé›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-trimtosize.html">trimToSize()</a></td><td>å°† arraylist ä¸­çš„å®¹é‡è°ƒæ•´ä¸ºæ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-removerange.html">removeRange()</a></td><td>åˆ é™¤ arraylist ä¸­æŒ‡å®šç´¢å¼•ä¹‹é—´å­˜åœ¨çš„å…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-replaceall.html">replaceAll()</a></td><td>å°†ç»™å®šçš„æ“ä½œå†…å®¹æ›¿æ¢æ‰æ•°ç»„ä¸­æ¯ä¸€ä¸ªå…ƒç´ </td></tr>
<tr><td><a href="https://www.runoob.com/java/java-arraylist-removeif.html">removeIf()</a></td><td>åˆ é™¤æ‰€æœ‰æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„ arraylist å…ƒç´ </td></tr>
</tbody></table>
<h4 id="3-hashmap"><a class="header" href="#3-hashmap">3. HashMap</a></h4>
<p>åˆ›å»º Map: HashMap&lt;String, String&gt; map = <strong>new</strong> HashMap&lt;String, String&gt;();</p>
<ol>
<li>
<p>æ·»åŠ  : map.put(&quot;key&quot; : &quot;value&quot; )</p>
</li>
<li>
<p>è·å– : map.get(int index)</p>
</li>
<li>
<p>åˆ é™¤ : map.remove(int index)</p>
</li>
<li>
<p>è¿­ä»£æ–¹æ³•</p>
<pre><code class="language-java">// æ–¹æ³• 1    map.keySet() è¿”å›é”®é›†åˆ   ä½¿ç”¨ map.get(key) è·å– value
for (Integer i : Sites.keySet()) {
    System.out.println(&quot;key: &quot; + i + &quot; value: &quot; + Sites.get(i));
}
// æ–¹æ³• 2    map.values() è¿”å›å€¼é›†åˆ
for(String value: Sites.values()) {
    System.out.print(value + &quot;, &quot;);
}
</code></pre>
</li>
</ol>
<table><thead><tr><th><a href="https://www.runoob.com/java/java-hashmap-clear.html">clear()</a></th><th>åˆ é™¤ hashMap ä¸­çš„æ‰€æœ‰é”®/å€¼å¯¹</th></tr></thead><tbody>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-clone.html">clone()</a></td><td>å¤åˆ¶ä¸€ä»½ hashMap</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-isempty.html">isEmpty()</a></td><td>åˆ¤æ–­ hashMap æ˜¯å¦ä¸ºç©º</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-size.html">size()</a></td><td>è®¡ç®— hashMap ä¸­é”®/å€¼å¯¹çš„æ•°é‡</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-put.html">put()</a></td><td>å°†é”®/å€¼å¯¹æ·»åŠ åˆ° hashMap ä¸­</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-putall.html">putAll()</a></td><td>å°†æ‰€æœ‰é”®/å€¼å¯¹æ·»åŠ åˆ° hashMap ä¸­</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-putifabsent.html">putIfAbsent()</a></td><td>å¦‚æœ hashMap ä¸­ä¸å­˜åœ¨æŒ‡å®šçš„é”®ï¼Œåˆ™å°†æŒ‡å®šçš„é”®/å€¼å¯¹æ’å…¥åˆ° hashMap ä¸­ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-remove.html">remove()</a></td><td>åˆ é™¤ hashMap ä¸­æŒ‡å®šé”® key çš„æ˜ å°„å…³ç³»</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-containskey.html">containsKey()</a></td><td>æ£€æŸ¥ hashMap ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„ key å¯¹åº”çš„æ˜ å°„å…³ç³»ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-containsvalue.html">containsValue()</a></td><td>æ£€æŸ¥ hashMap ä¸­æ˜¯å¦å­˜åœ¨æŒ‡å®šçš„ value å¯¹åº”çš„æ˜ å°„å…³ç³»ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-replace.html">replace()</a></td><td>æ›¿æ¢ hashMap ä¸­æ˜¯æŒ‡å®šçš„ key å¯¹åº”çš„ valueã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-replaceall.html">replaceAll()</a></td><td>å°† hashMap ä¸­çš„æ‰€æœ‰æ˜ å°„å…³ç³»æ›¿æ¢æˆç»™å®šçš„å‡½æ•°æ‰€æ‰§è¡Œçš„ç»“æœã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-get.html">get()</a></td><td>è·å–æŒ‡å®š key å¯¹åº”å¯¹ value</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-getordefault.html">getOrDefault()</a></td><td>è·å–æŒ‡å®š key å¯¹åº”å¯¹ valueï¼Œå¦‚æœæ‰¾ä¸åˆ° keyï¼Œåˆ™è¿”å›è®¾ç½®çš„é»˜è®¤å€¼</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-foreach.html">forEach()</a></td><td>å¯¹ hashMap ä¸­çš„æ¯ä¸ªæ˜ å°„æ‰§è¡ŒæŒ‡å®šçš„æ“ä½œã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-entryset.html">entrySet()</a></td><td>è¿”å› hashMap ä¸­æ‰€æœ‰æ˜ å°„é¡¹çš„é›†åˆé›†åˆè§†å›¾ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-keyset.html">keySet</a>()</td><td>è¿”å› hashMap ä¸­æ‰€æœ‰ key ç»„æˆçš„é›†åˆè§†å›¾ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-values.html">values()</a></td><td>è¿”å› hashMap ä¸­å­˜åœ¨çš„æ‰€æœ‰ value å€¼ã€‚</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-merge.html">merge()</a></td><td>æ·»åŠ é”®å€¼å¯¹åˆ° hashMap ä¸­</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-compute.html">compute()</a></td><td>å¯¹ hashMap ä¸­æŒ‡å®š key çš„å€¼è¿›è¡Œé‡æ–°è®¡ç®—</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-computeifabsent.html">computeIfAbsent()</a></td><td>å¯¹ hashMap ä¸­æŒ‡å®š key çš„å€¼è¿›è¡Œé‡æ–°è®¡ç®—ï¼Œå¦‚æœä¸å­˜åœ¨è¿™ä¸ª keyï¼Œåˆ™æ·»åŠ åˆ° hasMap ä¸­</td></tr>
<tr><td><a href="https://www.runoob.com/java/java-hashmap-computeifpresent.html">computeIfPresent()</a></td><td>å¯¹ hashMap ä¸­æŒ‡å®š key çš„å€¼è¿›è¡Œé‡æ–°è®¡ç®—ï¼Œå‰ææ˜¯è¯¥ key å­˜åœ¨äº hashMap ä¸­ã€‚</td></tr>
</tbody></table>
<h3 id="1-æœˆ-15-æ—¥"><a class="header" href="#1-æœˆ-15-æ—¥">1 æœˆ 15 æ—¥</a></h3>
<h4 id="1-ç¥ç»å…«è‚¡å¤ä¹ "><a class="header" href="#1-ç¥ç»å…«è‚¡å¤ä¹ ">1. ç¥ç»å…«è‚¡å¤ä¹ </a></h4>
<pre><code class="language-python"># 1. å¼•å…¥æ•°æ®é›†
fashion_mnist = tf.keras.datasets.fashion_mnist
# (x_train, y_train), (x_test, y_test) = mnist.load_data()
(x_train, y_train), (x_test, y_test) = fashion_mnist.load_data()
x_train, x_test = x_train/255.0, x_test/255.0
# 2. æ­å»ºç¥ç»ç½‘ç»œ
model = tf.keras.Sequential([
    tf.keras.layers.Flatten(),
    tf.keras.layers.Dense(128, activation='relu'),
    # tf.keras.layers.Dense(32, activation='sigmoid',kernel_regularizer=tf.keras.regularizers.l2()),
    tf.keras.layers.Dense(10, activation='softmax'),
])
# 3. é€‰æ‹© ä¼˜åŒ–å™¨ | æŸå¤±å‡½æ•° | ä»¥åŠ metrics
model.compile(  optimizer='adam',
                loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=False),
                metrics=['sparse_categorical_accuracy'])
# PS: metrics å¯é€‰ï¼šy_ = y_train  y = x_train * w + b
        1. 'accuracy'  y_å’Œ y éƒ½æ˜¯æ•°å€¼
        2. 'categorical_accuracy' y_å’Œ y éƒ½æ˜¯ç‹¬çƒ­ç 
        3. 'sparsecategorical_accuracy' y_æ˜¯æ•°å€¼ y æ˜¯ç‹¬çƒ­ç 
# 4. æ‰§è¡Œè®­ç»ƒè¿‡ç¨‹
model.fit(
    x_train, y_train,
    batch_size=48, epochs=5,
    validation_data=(x_test,y_test),  #(1) ä»»é€‰ä¸€ä¸ª é€‰æ‹©æµ‹è¯•é›†
    validation_split=                 #(2) ä»»é€‰ä¸€ä¸ª ä¸é€‰æ‹©æµ‹è¯•é›†ï¼Œä»è®­ç»ƒé›†ä¸­åˆ’åˆ†ä¸€å—ä½œä¸ºæµ‹è¯•é›†
    validation_freq=1   # å¤šå°‘ epoch æµ‹è¯•ä¸€æ¬¡
)
# 5. æ‰“å°ç½‘ç»œç»“æ„å’Œå‚æ•°ç»Ÿè®¡
model.summary()
</code></pre>
<h4 id="2-numpy-æ–¹æ³•"><a class="header" href="#2-numpy-æ–¹æ³•">2. numpy æ–¹æ³•</a></h4>
<pre><code class="language-python">1.   reshape(æ•°æ®ï¼Œå½¢çŠ¶)  =&gt;   x_train = np.reshape(x_train,  (len(x_train), 1, 5))
2.   np.random.shuffle()   # åˆ—è¡¨æ‰“ä¹±é‡æ’ï¼Œå°† x_train å’Œ y_train ç”¨ç›¸åŒçš„éšæœºæ•°é‡æ’
</code></pre>
<h4 id="3-rnn-æœŸæœ›çš„è¾“å…¥å½¢çŠ¶"><a class="header" href="#3-rnn-æœŸæœ›çš„è¾“å…¥å½¢çŠ¶">3. RNN æœŸæœ›çš„è¾“å…¥å½¢çŠ¶</a></h4>
<pre><code class="language-python"># ä»¥å­—æ¯é¢„æµ‹ä¸ºä¾‹    a-&gt;b b-&gt;c c-&gt;d d-&gt;e e-&gt;a
x_train = np.reshape(x_train, (len(x_train), 1, 5))
'''
ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ (é€å…¥æ ·æœ¬æ•° å¾ªç¯æ ¸æ—¶é—´å±•å¼€æ­¥æ•° æ¯ä¸ªæ—¶é—´æ­¥è¾“å…¥ç‰¹å¾æ•°)
è¿™é‡Œæ¯æ¬¡è¾“å…¥ä¸€ä¸ªå­—æ¯ è¿”å›ä¸€ä¸ªé¢„æµ‹å­—æ¯ (è¾“å…¥ä¸€æ¬¡å°±ç»™å‡ºé¢„æµ‹ç»“æœ)  æ‰€ä»¥å¾ªç¯æ ¸æ—¶é—´å±•å¼€æ­¥æ•°ä¸º 1
è¾“å…¥ç‰¹å¾æ˜¯ç‹¬çƒ­ç  [1,0,0,0,0] æœ‰äº”ä¸ªå€¼ï¼Œæ‰€ä»¥æ¯ä¸ªæ—¶é—´æ­¥è¾“å…¥ç‰¹å¾æ•°ä¸º 5
'''
</code></pre>
<h3 id="1-æœˆ-16-æ—¥"><a class="header" href="#1-æœˆ-16-æ—¥">1 æœˆ 16 æ—¥</a></h3>
<h4 id="1-embedding-ç¼–ç "><a class="header" href="#1-embedding-ç¼–ç ">1. Embedding ç¼–ç </a></h4>
<pre><code class="language-python"># åœ¨ sequential ä¸­æ­å»ºç¥ç»ç½‘ç»œæ—¶å…ˆè¿›è¡Œ embedding ç¼–ç 
# 1. å°† x_train å˜æˆ embedding æœŸå¾…çš„å½¢çŠ¶
x_train = np.reshape(x_train, (len(x_train), 1)  # (æ ·æœ¬æ•°ï¼Œæ—¶é—´å±•å¼€æ­¥æ•°)
# 2. æ­å»ºç¥ç»ç½‘ç»œ
model = tf.keras.Sequential([
    Embedding(5,2),   # (éœ€è¦è¡¨ç¤ºçš„ç»“æœæ•°é‡ï¼Œç¼–ç ç»´åº¦ (å‡ ä¸ªæ•°å­—èƒ½è¡¨ç¤ºä¸€ä¸ªç»“æœ))
    SimpleRNN(3),
    Dense(5, activation='softmax')
])
</code></pre>
<h4 id="2-spring-mvc"><a class="header" href="#2-spring-mvc">2. spring MVC</a></h4>
<pre><code class="language-java">    /// 1. æ™®é€šä¼ å‚
	@RequestMapping(value=&quot;/index3&quot;, method = RequestMethod.POST, params={&quot;name&quot;, &quot;id=10&quot;})
    // ï¼ï¼ï¼æ³¨æ„ï¼ï¼ï¼id çš„ç±»å‹å·²ç»è¢«è‡ªåŠ¨å®Œæˆç±»å‹è½¬æ¢
    //0 public String index3(String name, int id) {    æ­£å¸¸
    //(1) å¦‚æœä¸æƒ³ç”¨ name å’Œ id ä½œä¸ºå‚æ•°  éœ€è¦è¿›è¡Œå‚æ•°ç»‘å®š
    //(2)ï¼ˆ1ï¼‰public String index3(String str, int age) {    æŠ¥é”™
    //(2)ï¼ˆ2ï¼‰public String index3(String str, Integer age) {   ä¸æŠ¥é”™ ä½†å€¼å‡ä¸º Null
    public String index3(@RequestParam(&quot;name&quot;) String str,@RequestParam(&quot;id&quot;) int age) {
        System.out.println(&quot;æ‰§è¡Œäº†å¸¦æœ‰å‚æ•°çš„ POST è¯·æ±‚&quot;);
        // return &quot;æ‚¨ä¼ é€’çš„ name æ˜¯&quot; + name + &quot; id æ˜¯&quot; + id;
        return &quot;æ‚¨ä¼ é€’çš„ name æ˜¯&quot; + str + &quot; id æ˜¯&quot; + age;
    }
    /// 2. rest é£æ ¼çš„ä¼ å‚  å¿…é¡»è¿›è¡Œå‚æ•°æ˜ å°„
    @RequestMapping(value=&quot;/rest/{name}/{id}&quot;, method = RequestMethod.POST)
    public String rest(@PathVariable(&quot;name&quot;) String name,@PathVariable(&quot;id&quot;) int id) {
        return &quot;æ‚¨ä¼ é€’çš„ name æ˜¯&quot; + name + &quot; id æ˜¯&quot; + id;
    }

    /// 3. å–å‡º cookie ä¿¡æ¯
    @RequestMapping(&quot;/cookie&quot;)
    public String cookie (@CookieValue(value = &quot;JSESSIONID&quot;) String sessionId) {
        return &quot;SESSIONID: &quot; + sessionId ;
    }
</code></pre>
<h4 id="3-springbootæ°´"><a class="header" href="#3-springbootæ°´">3. SpringBoot(æ°´)</a></h4>
<pre><code class="language-yml">server:
  port: 8081  # é»˜è®¤ç«¯å£
</code></pre>
<h4 id="4-pandas-è¯»å–åˆ—"><a class="header" href="#4-pandas-è¯»å–åˆ—">4. pandas è¯»å–åˆ—</a></h4>
<pre><code class="language-python">data = pd.read_csv('./pandas/test.csv')
# 1. loc å•è¡Œ
# 2. iloc[1:2,3:4] æŒ‰ç´¢å¼• è¡Œå’Œåˆ—
# 3. iloc[[1,2,3], [2,3]] ç¬¬ 1,2,3 è¡Œçš„ç¬¬ 2,3 åˆ—
data_name_and_score = data.iloc[1:2, 1:3].values  # iloc æ–¹æ³• [è¡Œï¼Œåˆ—] éƒ½æ˜¯å‰é—­åå¼€  ç»“æœä»¥äºŒç»´æ•°ç»„è¡¨ç¤º
# 4. å†™å…¥ csv/excel
df.to_csv('a.csv')
df.to_excel('a.xlsx', sheet_name='sheet1')
</code></pre>
<h4 id="5-numpy"><a class="header" href="#5-numpy">5. numpy</a></h4>
<pre><code class="language-python"># 1. np.asarray() å¯ä»¥å°†æ•°æ®è½¬ä¸º numpy æ ¼å¼
# 2. data.flatten() å¯ä»¥å°†æ•°æ®æ‹‰ä¸ºä¸€ç»´
# 3. reshaape(data, (1,-1))   (æ•°æ®ï¼Œå½¢çŠ¶) ä¸å¿…å¤šè¯´
</code></pre>
<h3 id="1-æœˆ-17-æ—¥"><a class="header" href="#1-æœˆ-17-æ—¥">1 æœˆ 17 æ—¥</a></h3>
<h4 id="1-sequential-å‚æ•°"><a class="header" href="#1-sequential-å‚æ•°">1. Sequential å‚æ•°</a></h4>
<pre><code class="language-python"># 1. RNN
SimpleRNN(80, return_sequences=True),  # ä¸¤å±‚éƒ½æ˜¯ RNN æ—¶ï¼Œå‰ä¸€å±‚è¦åŠ ä¸Š return_sequences=True
# 2. Dropout
Dropout(0.2),  # éšå³æ‰”æ‰ä¸€äº›ç¥ç»å…ƒï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œå¯ä»¥å…ˆè®¾ä¸º 0ï¼Œé€æ¸è°ƒå¤§ï¼Œæ‰¾åˆ°æœ€ä¼˜å€¼
</code></pre>
<h4 id="2-cp_callbacks-å‚æ•°"><a class="header" href="#2-cp_callbacks-å‚æ•°">2. cp_callbacks å‚æ•°</a></h4>
<pre><code class="language-python">cp_callback = tf.keras.callbacks.ModelCheckPoint(
    filepath = checkpoint_save_path,
    save_weights_only = True,
    save_best_only = True,
    monitor = 'var_loss', # æŒ‡å®šéœ€è¦ç›‘æµ‹çš„å€¼
)
</code></pre>
<h4 id="3-modelfit-å‚æ•°"><a class="header" href="#3-modelfit-å‚æ•°">3. model.fit å‚æ•°</a></h4>
<pre><code class="language-python"># éƒ½ç”¨æ¥æè¿°éªŒè¯é›†ï¼Œä¸æµ‹è¯•é›†ä¸åŒ
validation_data=(x_test, y_test),
validation_freq=1,
'''
å…¶å®éªŒè¯é›†æ˜¯ä»è®­ç»ƒé›†ä¸­æŠ½å–å‡ºæ¥ç”¨äºè°ƒå‚çš„ï¼Œ
è€Œæµ‹è¯•é›†æ˜¯å’Œè®­ç»ƒé›†æ— äº¤é›†çš„ï¼Œç”¨äºæµ‹è¯•æ‰€é€‰å‚æ•°ç”¨äºè¯¥æ¨¡å‹çš„æ•ˆæœçš„ï¼Œè¿™ä¸ªè¿˜æ˜¯ä¸è¦å¼„é”™äº†ã€‚ã€‚ã€‚
åœ¨ Keras ä¸­ï¼ŒéªŒè¯é›†çš„åˆ’åˆ†åªè¦åœ¨ fit å‡½æ•°é‡Œè®¾ç½® validation_split çš„å€¼å°±å¥½äº†ï¼Œè¿™ä¸ªå¯¹åº”äº†å–è®­ç»ƒé›†ä¸­ç™¾åˆ†ä¹‹å‡ çš„æ•°æ®å‡ºæ¥å½“åšéªŒè¯é›†ã€‚
'''
</code></pre>
<ol>
<li>
<p>è®­ç»ƒé›†ï¼ˆtrain setï¼‰â€”â€” ç”¨äºæ¨¡å‹æ‹Ÿåˆçš„æ•°æ®æ ·æœ¬ã€‚åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­å¯¹è®­ç»ƒè¯¯å·®è¿›è¡Œæ¢¯åº¦ä¸‹é™</p>
<blockquote>
<p>ä½œç”¨ï¼šè®­ç»ƒçš„æƒé‡å‚æ•°ã€‚</p>
</blockquote>
</li>
<li>
<p>éªŒè¯é›†ï¼ˆvalidation setï¼‰â€”â€” æ˜¯æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å•ç‹¬ç•™å‡ºçš„æ ·æœ¬é›†ï¼Œ</p>
<blockquote>
<p>ä½œç”¨ï¼šè°ƒæ•´æ¨¡å‹çš„è¶…å‚æ•°
éªŒè¯é›†å¯ä»¥ç”¨åœ¨è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬åœ¨è®­ç»ƒæ—¶ï¼Œå‡ ä¸ª epoch ç»“æŸåè·‘ä¸€æ¬¡éªŒè¯é›†çœ‹çœ‹æ•ˆæœã€‚(éªŒè¯å¾—å¤ªé¢‘ç¹ä¼šå½±å“è®­ç»ƒé€Ÿåº¦) è¿™æ ·åšçš„ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå¯ä»¥åŠæ—¶å‘ç°æ¨¡å‹æˆ–è€…å‚æ•°çš„é—®é¢˜ï¼Œæ¯”å¦‚æ¨¡å‹åœ¨éªŒè¯é›†ä¸Šå‘æ•£å•¦ã€å‡ºç°å¾ˆå¥‡æ€ªçš„ç»“æœå•¦ (å¦‚æ— ç©·å¤§)ã€mAP ä¸å¢é•¿æˆ–è€…å¢é•¿å¾ˆæ…¢å•¦ç­‰ç­‰æƒ…å†µï¼Œè¿™æ—¶å¯ä»¥åŠæ—¶ç»ˆæ­¢è®­ç»ƒï¼Œé‡æ–°è°ƒå‚æˆ–è€…è°ƒæ•´æ¨¡å‹ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°è®­ç»ƒç»“æŸã€‚å¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯éªŒè¯æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå¦‚æœåœ¨éªŒè¯é›†ä¸Šçš„æ•ˆæœæ¯”è®­ç»ƒé›†ä¸Šå·®å¾ˆå¤šï¼Œå°±è¯¥è€ƒè™‘æ¨¡å‹æ˜¯å¦è¿‡æ‹Ÿåˆäº†ã€‚åŒæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡éªŒè¯é›†å¯¹æ¯”ä¸åŒçš„æ¨¡å‹ã€‚åœ¨ä¸€èˆ¬çš„ç¥ç»ç½‘ç»œä¸­ï¼Œ
æˆ‘ä»¬ç”¨éªŒè¯æ•°æ®é›†å»å¯»æ‰¾æœ€ä¼˜çš„ç½‘ç»œæ·±åº¦ï¼ˆnumber of hidden
layers)ï¼Œæˆ–è€…å†³å®šåå‘ä¼ æ’­ç®—æ³•çš„åœæ­¢ç‚¹æˆ–è€…åœ¨ç¥ç»ç½‘ç»œä¸­é€‰æ‹©éšè—å±‚ç¥ç»å…ƒçš„æ•°é‡ï¼›
ç”±äºéªŒè¯é›†æ˜¯ç”¨æ¥â€è®­ç»ƒâ€è¶…å‚æ•°çš„ï¼Œå°½ç®¡éªŒè¯é›†çš„è¯¯å·®é€šå¸¸ä¼šæ¯”è®­ç»ƒé›†è¯¯å·®å°ï¼Œä¸€èˆ¬æ¥è¯´éªŒè¯é›†æ¯”è¾ƒå°ä¼šä½ä¼°æ³›åŒ–è¯¯å·®ã€‚æ‰€æœ‰è¶…å‚æ•°ä¼˜åŒ–å®Œæˆä¹‹åï¼Œæ³›åŒ–è¯¯å·®å¯èƒ½ä¼šé€šè¿‡æµ‹è¯•é›†æ¥ä¼°è®¡ã€‚
åœ¨æ™®é€šçš„æœºå™¨å­¦ä¹ ä¸­å¸¸ç”¨çš„äº¤å‰éªŒè¯ï¼ˆCross Validation) å°±æ˜¯æŠŠè®­ç»ƒæ•°æ®é›†æœ¬èº«å†ç»†åˆ†æˆä¸åŒçš„éªŒè¯æ•°æ®é›†å»è®­ç»ƒæ¨¡å‹ã€‚</p>
</blockquote>
</li>
<li>
<p>æµ‹è¯•é›† â€”â€” ç”¨æ¥è¯„ä¼°æ¨¡æœ€ç»ˆæ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚ä½†ä¸èƒ½ä½œä¸ºè°ƒå‚ã€é€‰æ‹©ç‰¹å¾ç­‰ç®—æ³•ç›¸å…³çš„é€‰æ‹©çš„ä¾æ®ã€‚</p>
<blockquote>
<p>ä½œç”¨ï¼šåªæ˜¯éªŒè¯</p>
</blockquote>
</li>
</ol>
<h4 id="4-å½’ä¸€åŒ–æ“ä½œ"><a class="header" href="#4-å½’ä¸€åŒ–æ“ä½œ">4. å½’ä¸€åŒ–æ“ä½œ</a></h4>
<pre><code class="language-python">from sklearn.preprocessing import MinMaxScaler
motai = pd.read_csv('./tensorflow/SH600519.csv')
train_set = motai.iloc[:2426-300,2:3].values
test_set = motai.iloc[2426-300:,2:3].values
# !! å½’ä¸€åŒ– !!
sc = MinMaxScaler(feature_range=(0,1))  # å®šä¹‰å½’ä¸€åŒ–ï¼Œé€‰å®šèŒƒå›´åˆ° (0-1) é—´
train_set_scaled = sc.fit_transform(train_set)
# fit æ±‚å¾—è®­ç»ƒé›†å›ºæœ‰å±æ€§ (å¦‚å¹³å‡å€¼ï¼Œæœ€å¤§å€¼ï¼Œæ–¹å·®ç­‰), transform å¯¹è®­ç»ƒé›†è¿›è¡Œå½’ä¸€åŒ–
test_set = sc.transform(test_set)
# åˆ©ç”¨è®­ç»ƒé›†çš„å±æ€§å¯¹æµ‹è¯•é›†è¿›è¡Œå½’ä¸€åŒ–
</code></pre>
<h4 id="5-tensorboard-ä½¿ç”¨"><a class="header" href="#5-tensorboard-ä½¿ç”¨">5. TensorBoard ä½¿ç”¨</a></h4>
<pre><code class="language-python"># 1. è®¾ç½®è·¯å¾„å’Œæ–‡ä»¶å
log_dir=&quot;logs/fit/&quot; + datetime.datetime.now().strftime(&quot;%Y%m%d-%H%M%S&quot;)
# 2. æ·»åŠ  tf.keras.callback.TensorBoard å›è°ƒå¯ç¡®ä¿åˆ›å»ºå’Œå­˜å‚¨æ—¥å¿—
tensorboard_callback = tf.keras.callbacks.TensorBoard(log_dir=log_dir, histogram_freq=1)
# 3. callbacks ä¸­åŠ å…¥
callbacks = [cp_callback,tensorboard_callback]
# 4. æ§åˆ¶å°è¿è¡Œ  (éœ€è¦å°† tensorboard åŠ å…¥ç¯å¢ƒå˜é‡  ä¾‹å¦‚:C:\Users\YMZ\anaconda3\envs\tf2\Scripts  )
tensorboard --logdir logs/fit
</code></pre>
<h3 id="1-æœˆ-18-æ—¥"><a class="header" href="#1-æœˆ-18-æ—¥">1 æœˆ 18 æ—¥</a></h3>
<h4 id="1-å‚»å­é¢„æµ‹è‚¡å¸‚"><a class="header" href="#1-å‚»å­é¢„æµ‹è‚¡å¸‚">1. å‚»å­é¢„æµ‹è‚¡å¸‚</a></h4>
<ol>
<li>è¾“å…¥ : 60 å¤©çš„å¼€ç›˜ä»·</li>
<li>è¾“å‡º : 61 å¤©çš„å¼€ç›˜ä»·</li>
<li>æŠŠé¢„æµ‹çš„ 61 å¤©å½“ä½œè¾“å…¥å€¼ , é‡å¤ä¸Šè¿°å®éªŒ</li>
<li>ç»“æœ : æ›²çº¿è¶‹äºå¹³å¦ï¼Œæ²¡ç”¨</li>
</ol>
<pre><code class="language-python">i = 500
data60_ori = maotai.iloc[:1213,2:3].values
def pre(i, data60_ori):
    i -= 1
    if i &gt; 0:
        data60 = data60_ori
        data60 = sc.transform(data60)
        readyfortest = []
        readyfortest.append(data60[len(data60)-60:len(data60),0])
        readyfortest = np.array(readyfortest)
        readyfortest = np.reshape(readyfortest, (readyfortest.shape[0], 60, 1))
        preprice = model.predict(readyfortest)
        preprice = sc.inverse_transform(preprice)
        data60_ori = np.vstack((data60_ori, preprice))
        pre(i, data60_ori)
    else:
        print('------over------')
        print(data60_ori.shape)
        plt.plot(all_set, c='r', label='Real Price')
        plt.plot(data60_ori, c='b', label='Predict Price')
        plt.plot(test1, c='y', label='Predict Price')
        plt.legend()
        plt.show()
</code></pre>
<h4 id="2-pandas-åˆ é™¤åˆ—"><a class="header" href="#2-pandas-åˆ é™¤åˆ—">2. pandas åˆ é™¤åˆ—</a></h4>
<pre><code class="language-python"># åœ¨æ•°æ®é¢„å¤„ç†ä¸­ï¼Œéœ€è¦åˆ é™¤ dataframe çš„ä¸€åˆ—çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ã€‚
train = train.drop(['A'], axis=1)
# å…¶ä¸­ axis=1 ä»£è¡¨çš„æ˜¯è¦åˆ é™¤ä¸€åˆ—ï¼Œè€Œä¸æ˜¯ä¸€è¡Œã€‚
</code></pre>
<h4 id="3-pandas-è§£ææ—¶é—´"><a class="header" href="#3-pandas-è§£ææ—¶é—´">3. pandas è§£ææ—¶é—´</a></h4>
<pre><code class="language-python">trips = pd.read_csv('./data/trips.csv',encoding='gbk')
# 1. è½¬æ¢æ ¼å¼
trips['è¿›ç«™æ—¶é—´'] = pd.to_datetime(trips['è¿›ç«™æ—¶é—´'],format=&quot;%Y/%m/%d %H:%M&quot;)
# 2. è§£æ
year = trips['æŸä¸€åˆ—'].dt.year  # è·å–ä¸€åˆ—
year = trips['æŸä¸€åˆ—'][int index].year # åªè·å–ä¸€ä¸ª
</code></pre>
<h4 id="4-pandas-ç­›é€‰æ•°æ®"><a class="header" href="#4-pandas-ç­›é€‰æ•°æ®">4. pandas ç­›é€‰æ•°æ®</a></h4>
<pre><code class="language-python"># 1. ==
print( trips.loc[ trips['è¿›ç«™æ—¶é—´'].dt.month.isin([4,5]) ])
# 2. is in []
print( trips.loc[ trips['è¿›ç«™æ—¶é—´'].dt.month.isin([2,3,4]) ])
# 3.  &amp; | !
æ³¨æ„åªæœ‰ä¸€ä¸ª &amp; æˆ– |
# 4. ç­›é€‰ç»“æœè®¡æ•° (ä¸¤ç§éƒ½è¡Œ)
print( trips.loc[ trips['è¿›ç«™æ—¶é—´'].dt.month.isin([2,3,5,6,7]) ].count())
print( trips.loc[ trips['è¿›ç«™æ—¶é—´'].dt.month.isin([2,3,5,6,7]) ]['è¿›ç«™æ—¶é—´'].count())
</code></pre>
<h3 id="1-æœˆ-19-æ—¥"><a class="header" href="#1-æœˆ-19-æ—¥">1 æœˆ 19 æ—¥</a></h3>
<h4 id="1-pandas-è¡Œåˆ—æ“ä½œ"><a class="header" href="#1-pandas-è¡Œåˆ—æ“ä½œ">1. pandas è¡Œåˆ—æ“ä½œ</a></h4>
<pre><code class="language-python"># 1. åˆ¤æ–­æ˜¯æ˜ŸæœŸå‡ 
trips['dayofweek'] = trips['è¿›ç«™æ—¶é—´'].dt.dayofweek
# 2. æ–°å¢è¡Œ/åˆ—
trips['new_col'] = '0'
trips.loc['new_row'] = '0'
# 3. éå†è¡Œ
for index, row in trips.iterrows():
# 4. æ›¿æ¢æŸæ ¼æ•°æ®
trips.iloc[index,10] = row_[1]
</code></pre>
<h4 id="2-pandas-æ—¥æœŸ-å®Œæ•´"><a class="header" href="#2-pandas-æ—¥æœŸ-å®Œæ•´">2. pandas æ—¥æœŸ (å®Œæ•´)</a></h4>
<pre><code class="language-python">pandas æ—¥æœŸæ—¶é—´æ•°æ®çš„åˆ†å‰²æå–æ“ä½œ
import pandas as pd
import numpy as np
import time
s=time.time()
data_2019=pd.read_excel('d:\\data\\abc.xlsx')
data=data_2019[['å¡å·','äº¤æ˜“æ—¶é—´']]
data['æ—¥æœŸ'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.date
data['æ—¶é—´'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.time
data['å¹´'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.year
data['å­£èŠ‚'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.quarter
data['æœˆ'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.month
data['å‘¨']=data_2019['äº¤æ˜“æ—¶é—´'].dt.week
data['æ—¥'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.day
data['å°æ—¶'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.hour
data['åˆ†é’Ÿ'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.minute
data['ç§’'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.second
data['ä¸€å¹´ç¬¬å‡ å¤©'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.dayofyear
data['ä¸€å¹´ç¬¬å‡ å‘¨'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.weekofyear
data['ä¸€å‘¨ç¬¬å‡ å¤©'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.dayofweek
data['ä¸€ä¸ªæœˆå«æœ‰å¤šå°‘å¤©'] = data_2019['äº¤æ˜“æ—¶é—´'].dt.days_in_month
data['æ˜ŸæœŸåç§°'] =data_2019['äº¤æ˜“æ—¶é—´'].dt.weekday_name
print(data)
data.to_excel('d:\\data\\abcsss.xlsx')
</code></pre>
<h4 id="3-series-å¯¹è±¡"><a class="header" href="#3-series-å¯¹è±¡">3. Series å¯¹è±¡</a></h4>
<pre><code class="language-python"># Series å¸¸ç”¨å±æ€§å’Œæ–¹æ³•
è·å–æ•°æ®çš„å€¼ï¼Œä½¿ç”¨ values æ–¹æ³•
è·å–ç´¢å¼•çš„å€¼ï¼Œä½¿ç”¨ index æ–¹æ³•
è·å–æ¯å¯¹ç´¢å¼•çš„å€¼ï¼Œä½¿ç”¨ items æ–¹æ³•
</code></pre>
<h3 id="1-æœˆ-20-æ—¥"><a class="header" href="#1-æœˆ-20-æ—¥">1 æœˆ 20 æ—¥</a></h3>
<h4 id="1-è·å–æŸæœˆå¤©æ•°"><a class="header" href="#1-è·å–æŸæœˆå¤©æ•°">1. è·å–æŸæœˆå¤©æ•°</a></h4>
<pre><code class="language-python">import calendar
res = calendar.monthrange(2020,5)
print(res[1])
</code></pre>
<h4 id="2-çºµå‘æ˜¾ç¤º-x-è½´åæ ‡"><a class="header" href="#2-çºµå‘æ˜¾ç¤º-x-è½´åæ ‡">2. çºµå‘æ˜¾ç¤º x è½´åæ ‡</a></h4>
<pre><code class="language-python">df = pd.DataFrame(pd.read_csv('./sta_flow_by_day.csv'))

plt.xticks(rotation=270)
plt.bar([f'{month}.{day}' for month, day in zip(np.array(df['month']), np.array(df['day']))], np.array(df['flow']))
plt.show()
</code></pre>
<h4 id="3-pandas-ç­›é€‰æ³¨æ„"><a class="header" href="#3-pandas-ç­›é€‰æ³¨æ„">3. pandas ç­›é€‰æ³¨æ„</a></h4>
<pre><code class="language-python"># ä¸åŒæ¡ä»¶ä¸€å®šè¦åŠ æ‹¬å·
df = df.loc[(df['sta'] == 'Sta1') &amp; (df['month']==2)]
</code></pre>
<h3 id="1-æœˆ-21-æ—¥"><a class="header" href="#1-æœˆ-21-æ—¥">1 æœˆ 21 æ—¥</a></h3>
<h4 id="1-åˆ†å‰²çº¿-æ°´"><a class="header" href="#1-åˆ†å‰²çº¿-æ°´">1. åˆ†å‰²çº¿ (æ°´)</a></h4>
<pre><code class="language-python">print('#-&amp;-$-@-%-'*13)
</code></pre>
<h4 id="2-é˜²æ­¢æ— -key"><a class="header" href="#2-é˜²æ­¢æ— -key">2. é˜²æ­¢æ—  key</a></h4>
<blockquote>
<h6 id="try-except-çœŸå¥½ç”¨"><a class="header" href="#try-except-çœŸå¥½ç”¨">try except çœŸå¥½ç”¨</a></h6>
</blockquote>
<pre><code class="language-python">for key in stas.keys():
    month = stas[key]
    for sta in month.keys():
        try:
            big_dict[sta][key] = month[sta]
        except:
            try:
                big_dict_gun[sta][key] = month[sta]
            except:
                big_dict_gun[sta] = {}
</code></pre>
<h4 id="3-onehot-åº”ç”¨"><a class="header" href="#3-onehot-åº”ç”¨">3. onehot åº”ç”¨</a></h4>
<pre><code class="language-python"># 2. æŠŠ route åˆ—è½¬ä¸º onehot ç¼–ç 
enc_route = sklearn.preprocessing.OneHotEncoder(sparse=False) # Key here is sparse=False!
route_onehot = enc_route.fit_transform(np.array(list(df['route'])).reshape(len(df['route']),1))
print(df['route'].shape)
print(route_onehot)

# fit_transform = fit + transform
# ä¹‹åå¯ä»¥ç”¨ enc_route.transform() ç¼–ç æµ‹è¯•é›†
</code></pre>
<h3 id="1-æœˆ-22-æ—¥"><a class="header" href="#1-æœˆ-22-æ—¥">1 æœˆ 22 æ—¥</a></h3>
<h4 id="1-åå½’ä¸€åŒ–-117"><a class="header" href="#1-åå½’ä¸€åŒ–-117">1. åå½’ä¸€åŒ– (1.17)</a></h4>
<pre><code class="language-python">preprice = model.predict(readyfortest)
preprice = sc.inverse_transform(preprice)
</code></pre>
<h4 id="2-pandas-æ’åº"><a class="header" href="#2-pandas-æ’åº">2. pandas æ’åº</a></h4>
<pre><code class="language-python">#é»˜è®¤ä¸ºå‡åº
df_3 = df.sort_values(by=['day','flow'])
</code></pre>
<h3 id="123-æ—¥-127-æ—¥"><a class="header" href="#123-æ—¥-127-æ—¥">1.23 æ—¥~ 1.27 æ—¥</a></h3>
<h4 id="1ç¥ç»ç½‘ç»œç»éªŒæ€»ç»“"><a class="header" href="#1ç¥ç»ç½‘ç»œç»éªŒæ€»ç»“">1.ç¥ç»ç½‘ç»œç»éªŒæ€»ç»“</a></h4>
<pre><code class="language-python"># 1. æ¨¡å‹éšè—å±‚å±‚æ•°è®¾ç½®
1. åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå½“ä¸”ä»…å½“æ•°æ®éçº¿æ€§åˆ†ç¦»æ—¶æ‰éœ€è¦éšè—å±‚ï¼
2. å¯¹äºä¸€èˆ¬ç®€å•çš„æ•°æ®é›†ï¼Œä¸€ä¸¤å±‚éšè—å±‚é€šå¸¸å°±è¶³å¤Ÿäº†ã€‚ä½†å¯¹äºæ¶‰åŠæ—¶é—´åºåˆ—æˆ–è®¡ç®—æœºè§†è§‰çš„å¤æ‚æ•°æ®é›†ï¼Œåˆ™éœ€è¦é¢å¤–å¢åŠ å±‚æ•°ã€‚å•å±‚ç¥ç»ç½‘ç»œåªèƒ½ç”¨äºè¡¨ç¤ºçº¿æ€§åˆ†ç¦»å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯éå¸¸ç®€å•çš„é—®é¢˜ï¼Œæ¯”å¦‚åˆ†ç±»é—®é¢˜ä¸­çš„ä¸¤ä¸ªç±»å¯ä»¥ç”¨ä¸€æ¡ç›´çº¿æ•´é½åœ°åˆ†å¼€ã€‚
3. ä¸€èˆ¬è§„å¾‹
æ²¡æœ‰éšè—å±‚ï¼šä»…èƒ½å¤Ÿè¡¨ç¤ºçº¿æ€§å¯åˆ†å‡½æ•°æˆ–å†³ç­–
éšè—å±‚æ•°=1ï¼šå¯ä»¥æ‹Ÿåˆä»»ä½•â€œåŒ…å«ä»ä¸€ä¸ªæœ‰é™ç©ºé—´åˆ°å¦ä¸€ä¸ªæœ‰é™ç©ºé—´çš„è¿ç»­æ˜ å°„â€çš„å‡½æ•°
éšè—å±‚æ•°=2ï¼šæ­é…é€‚å½“çš„æ¿€æ´»å‡½æ•°å¯ä»¥è¡¨ç¤ºä»»æ„ç²¾åº¦çš„ä»»æ„å†³ç­–è¾¹ç•Œï¼Œå¹¶ä¸”å¯ä»¥æ‹Ÿåˆä»»ä½•ç²¾åº¦çš„ä»»ä½•å¹³æ»‘æ˜ å°„
éšè—å±‚æ•°&gt;2ï¼šå¤šå‡ºæ¥çš„éšè—å±‚å¯ä»¥å­¦ä¹ å¤æ‚çš„æè¿°ï¼ˆæŸç§è‡ªåŠ¨ç‰¹å¾å·¥ç¨‹ï¼‰
# 2. æ¨¡å‹éšè—å±‚ç¥ç»å…ƒä¸ªæ•°è®¾ç½®
1ã€éšè—å•å…ƒçš„æ•°é‡ä¸åº”è¯¥è¶…è¿‡è¾“å…¥å±‚ä¸­å•å…ƒçš„ä¸¤å€
2ã€éšè—å•å…ƒçš„å¤§å°åº”è¯¥ä»‹äºè¾“å…¥å•å…ƒå’Œè¾“å‡ºå•å…ƒä¹‹é—´
3ã€ç¥ç»å…ƒçš„æ•°é‡åº”æ•è·è¾“å…¥æ•°æ®é›†æ–¹å·®çš„ 70~90%
# 3. æ³¨æ„è¾“å…¥è®­ç»ƒé›†çš„å½¢çŠ¶
# 4. æ³¨æ„è¾“å…¥å±‚ç‰¹å¾çš„è¾“å…¥é¡ºåº
ä¸è¾“å‡ºå±‚å…³è”æ€§å¼ºçš„æ”¾å‰é¢
æœ‰äº›å…³è”æ€§å¼±çš„ç‰¹å¾åŠ å…¥ä¼šä¸¥é‡æ‰°ä¹±å‡†ç¡®æ€§ æ¯”å¦‚ day
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ–‡æ¡£é¡µ"><a class="header" href="#æ–‡æ¡£é¡µ">æ–‡æ¡£é¡µ</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="magic"><a class="header" href="#magic">magic</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="risc-v"><a class="header" href="#risc-v">RISC-V</a></h1>
<h2 id="risc-v-ç‰¹ç‚¹"><a class="header" href="#risc-v-ç‰¹ç‚¹">RISC-V ç‰¹ç‚¹</a></h2>
<ol>
<li>å¢é‡ ISA(æŒ‡ä»¤é›†æ¶æ„)</li>
</ol>
<ul>
<li>æ ¸å¿ƒæ˜¯åä¸º RV32I çš„æ ¸å¿ƒ ISAï¼Œå®ƒæ˜¯å›ºå®šçš„æ°¸è¿œä¸ä¼šæ”¹å˜</li>
<li>å¯ä»¥å¢åŠ æ‹“å±•ï¼Œä¾‹å¦‚ RV32IMDF å°†ä¹˜æ³• (RV32M),å•ç²¾åº¦æµ®ç‚¹ (RV32D) å’ŒåŒç²¾åº¦æµ®ç‚¹ (RV32D) çš„æ‹“å±•æ·»åŠ åˆ°äº†åŸºç¡€æŒ‡ä»¤é›†ä¸­ã€‚</li>
<li>RISC-V ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®æ‹“å±•ç”Ÿæˆå½“å‰ç¡¬ä»¶ç¯å¢ƒä¸‹çš„æœ€ä½³ä»£ç </li>
</ul>
<h2 id="isa"><a class="header" href="#isa">ISA</a></h2>
<h3 id="isa-è®¾è®¡"><a class="header" href="#isa-è®¾è®¡">ISA è®¾è®¡</a></h3>
<ul>
<li>æˆæœ¬</li>
<li>ç®€æ´æ€§
<ul>
<li>ISA çš„ç®€æ´æ€§ï¼Œä»è€Œç¼©å°å®ç° ISA çš„å¤„ç†å™¨çš„å°ºå¯¸</li>
</ul>
</li>
<li>æ€§èƒ½</li>
<li>æ¶æ„å’Œå…·ä½“å®ç°çš„åˆ†ç¦»</li>
<li>æå‡ç©ºé—´</li>
<li>ç¨‹åºå¤§å°</li>
<li>æ˜“äºç¼–ç¨‹/ç¼–è¯‘/é“¾æ¥</li>
</ul>
<h3 id="rv32i-æŒ‡ä»¤æ ¼å¼"><a class="header" href="#rv32i-æŒ‡ä»¤æ ¼å¼">RV32I æŒ‡ä»¤æ ¼å¼</a></h3>
<p>å…­ç§åŸºæœ¬æŒ‡ä»¤æ ¼å¼åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>ç”¨äº <code>å¯„å­˜å™¨-å¯„å­˜å™¨</code> æ“ä½œçš„ R ç±»å‹æŒ‡ä»¤</li>
<li>ç”¨äºçŸ­ç«‹å³æ•°å’Œè®¿å­˜ load æ“ä½œçš„ I å‹æŒ‡ä»¤</li>
<li>ç”¨äºè®¿å­˜ store æ“ä½œçš„ S å‹æŒ‡ä»¤</li>
<li>ç”¨äºæ¡ä»¶è·³è½¬æ“ä½œçš„ B ç±»å‹æŒ‡ä»¤</li>
<li>ç”¨äºé•¿ç«‹å³æ•°çš„ U å‹æŒ‡ä»¤</li>
<li>ç”¨äºæ— æ¡ä»¶è·³è½¬çš„ J å‹æŒ‡ä»¤</li>
</ul>
<p>ä¼˜åŠ¿ï¼š</p>
<ul>
<li>æŒ‡ä»¤åªæœ‰å…­ç§æ ¼å¼ï¼Œå¹¶ä¸”æ‰€æœ‰çš„æŒ‡ä»¤éƒ½æ˜¯ 32 ä½é•¿ï¼Œè¿™ç®€åŒ–äº†æŒ‡ä»¤è§£ç </li>
<li>ç¬¬äºŒï¼ŒRISC-V æŒ‡ä»¤æä¾›ä¸‰ä¸ªå¯„å­˜å™¨æ“ä½œæ•°ï¼Œè€Œä¸æ˜¯åƒ x86-32 ä¸€æ ·ï¼Œè®©æºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°å…±äº«ä¸€ä¸ªå­—æ®µã€‚(èŠ‚çº¦äº† 1 æ¡ moveï¼ˆæ¬è¿ï¼‰æŒ‡ä»¤)</li>
</ul>
<h3 id="å¯„å­˜å™¨"><a class="header" href="#å¯„å­˜å™¨">å¯„å­˜å™¨</a></h3>
<ul>
<li>RV32I æœ‰ 31 å¯„å­˜å™¨åŠ ä¸Šä¸€ä¸ªå€¼æ’ä¸º 0 çš„ x0 å¯„å­˜å™¨ã€‚</li>
<li>ARM-32 åªæœ‰ 16 ä¸ªå¯„å­˜å™¨</li>
<li>x86-32 ç”šè‡³åªæœ‰ 8 ä¸ªå¯„å­˜å™¨ã€‚</li>
</ul>
<ol>
<li>
<p>ä¸ºå¸¸é‡ 0 å•ç‹¬åˆ†é…ä¸€ä¸ªå¯„å­˜å™¨æ˜¯ RISC-V ISA èƒ½å¦‚æ­¤ç®€å•çš„ä¸€ä¸ªå¾ˆ
å¤§çš„å› ç´ ã€‚è€Œ ARM-32 å’Œ x86-32 æŒ‡ä»¤é›†ä¸­æ²¡æœ‰é›¶å¯„å­˜å™¨ã€‚</p>
</li>
<li>
<p>ç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰æ˜¯ ARM-32 çš„ 16 ä¸ªå¯„å­˜å™¨ä¹‹ä¸€ï¼Œè¿™æ„å‘³ç€ä»»ä½•æ”¹å˜å¯„å­˜å™¨çš„æŒ‡ä»¤
éƒ½æœ‰å¯èƒ½å¯¼è‡´åˆ†æ”¯è·³è½¬ã€‚PC ä½œä¸ºä¸€ä¸ªå¯„å­˜å™¨ä½¿ç¡¬ä»¶åˆ†æ”¯é¢„æµ‹å˜å¾—å¤æ‚ï¼Œå› ä¸ºåœ¨å…¸å‹çš„ ISA
ä¸­ï¼Œä»… 10%-20% çš„æŒ‡ä»¤ä¸ºåˆ†æ”¯æŒ‡ä»¤ï¼Œè€Œåœ¨ ARM-32 ä¸­ï¼Œä»»ä½•æŒ‡ä»¤éƒ½æœ‰å¯èƒ½æ˜¯åˆ†æ”¯æŒ‡ä»¤ã€‚è€Œ
åˆ†æ”¯é¢„æµ‹çš„å‡†ç¡®æ€§å¯¹äºè‰¯å¥½çš„æµæ°´çº¿æ€§èƒ½è‡³å…³é‡è¦ã€‚å¦å¤–å°† PC ä½œä¸ºä¸€ä¸ªå¯„å­˜å™¨ä¹Ÿæ„å‘³ç€
å¯ç”¨çš„é€šç”¨å¯„å­˜å™¨å°‘äº†ä¸€ä¸ªã€‚</p>
</li>
</ol>
<table><thead><tr><th>å¯„å­˜å™¨</th><th>åŠŸèƒ½</th></tr></thead><tbody>
<tr><td>x0 / szero</td><td>ç¡¬è¿çº¿åˆ° 0 (Hardwired zero)</td></tr>
<tr><td>x1 / ra</td><td>è¿”å›åœ°å€ (Return address)</td></tr>
<tr><td>x2 / sp</td><td>æ ˆæŒ‡é’ˆ (Stack pointer)</td></tr>
<tr><td>x3 / gp</td><td>å…¨å±€æŒ‡é’ˆ (Global pointer)</td></tr>
<tr><td>x4 / tp</td><td>çº¿ç¨‹æŒ‡é’ˆ (Thread pointer)</td></tr>
<tr><td>x5 / t0</td><td>ä¸´æ—¶ (Temporary)</td></tr>
<tr><td>x6 / t1</td><td>ä¸´æ—¶</td></tr>
<tr><td>x7 / t2</td><td>ä¸´æ—¶</td></tr>
<tr><td>x8 / s0 / fp</td><td>ä¿å­˜å¯„å­˜å™¨ (saved register) / frame pointer</td></tr>
<tr><td>x9 / s1</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x10 / a0</td><td>å‡½æ•°å‚æ•° (Function argument), è¿”å›åœ°å€</td></tr>
<tr><td>x11 / a1</td><td>å‡½æ•°å‚æ•°ï¼Œè¿”å›åœ°å€</td></tr>
<tr><td>x12 / a2</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x13 / a3</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x14 / a4</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x15 / a5</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x16 / a6</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x17 / a7</td><td>å‡½æ•°å‚æ•°</td></tr>
<tr><td>x18 / s2</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x19 / s3</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x20 / s4</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x21 / s5</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x22 / s6</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x23 / s7</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x24 / s8</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x25 / s9</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x26 / s10</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x27 / s11</td><td>ä¿å­˜å¯„å­˜å™¨</td></tr>
<tr><td>x28 / t3</td><td>ä¸´æ—¶</td></tr>
<tr><td>x29 / t4</td><td>ä¸´æ—¶</td></tr>
<tr><td>x30 / t5</td><td>ä¸´æ—¶</td></tr>
<tr><td>x31 / t6</td><td>ä¸´æ—¶</td></tr>
<tr><td></td><td></td></tr>
<tr><td>PS</td><td>ç¨‹åºè®¡æ•°å™¨</td></tr>
</tbody></table>
<p>ä¿å­˜å¯„å­˜å™¨å’Œä¸´æ—¶å¯„å­˜å™¨ä¸ºä»€ä¹ˆä¸æ˜¯è¿ç»­ç¼–å·çš„ï¼Ÿ</p>
<p>ä¸ºäº†æ”¯æŒ RV32Eâ€”â€”ä¸€ä¸ªåªæœ‰ 16 ä¸ªå¯„å­˜å™¨çš„åµŒå…¥å¼ç‰ˆæœ¬çš„ RISC-Vï¼ˆå‚è§ç¬¬ 11 ç« ï¼‰ï¼Œåªä½¿ç”¨å¯„å­˜å™¨ x0 åˆ° x15â€”â€”ä¸€éƒ¨åˆ†ä¿å­˜å¯„å­˜å™¨å’Œä¸€éƒ¨åˆ†ä¸´æ—¶å¯„å­˜å™¨éƒ½åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚å…¶å®ƒçš„ä¿å­˜å¯„å­˜å™¨å’Œä¸´æ—¶å¯„å­˜å™¨åœ¨å‰©ä½™ 16 ä¸ªå¯„å­˜å™¨å†…ã€‚RV32E è¾ƒå°ï¼Œä½†ç”±äºå’Œ RV32I ä¸åŒ¹é…ï¼Œç›®å‰è¿˜æ²¡æœ‰ç¼–è¯‘å™¨æ”¯æŒã€‚</p>
<h2 id="è®¡ç®—æœºä¸­çš„æŒ‡ä»¤è¡¨ç¤º"><a class="header" href="#è®¡ç®—æœºä¸­çš„æŒ‡ä»¤è¡¨ç¤º">è®¡ç®—æœºä¸­çš„æŒ‡ä»¤è¡¨ç¤º</a></h2>
<h3 id="æŒ‡ä»¤"><a class="header" href="#æŒ‡ä»¤">æŒ‡ä»¤</a></h3>
<p><img src="docs/magic/./riscv/instructions_size.jpg" alt="size" />
<img src="docs/magic/./riscv/instructions_usage.jpg" alt="usage" />
<img src="docs/magic/./riscv/instructions_format.jpg" alt="format" />
<img src="docs/magic/./riscv/instructions_binary2asm.jpg" alt="binary2asm" /></p>
<h3 id="è®¡ç®—æŒ‡ä»¤"><a class="header" href="#è®¡ç®—æŒ‡ä»¤">è®¡ç®—æŒ‡ä»¤</a></h3>
<ul>
<li>ç®€å•è®¡ç®—ï¼šadd, sub</li>
<li>é€»è¾‘æŒ‡ä»¤ï¼šand, or, xor</li>
<li>ç§»ä½æŒ‡ä»¤ï¼šsll, srl, sra</li>
<li>å°äºæ—¶ç½®ä½ï¼šslt, altu (unsigned), ç«‹å³æ•°ç‰ˆ (sltiï¼Œsltiu)</li>
</ul>
<h3 id="å†³ç­–æŒ‡ä»¤"><a class="header" href="#å†³ç­–æŒ‡ä»¤">å†³ç­–æŒ‡ä»¤</a></h3>
<h4 id="åˆ¤æ–­-if-then-else"><a class="header" href="#åˆ¤æ–­-if-then-else">åˆ¤æ–­ (if-then-else)</a></h4>
<pre><code class="language-c">// f,   g,   h,   i,   j
// x19, x20, x21, x22, x23

if (i == g)
    f = g + h;
else
    f = g - h;
</code></pre>
<p>é™¤äº† Else æ ‡ç­¾ä¹‹å¤–ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ª Exit çš„æ ‡ç­¾ï¼Œç”¨äº If æ‰§è¡Œå®Œè·³è¿‡ Elseã€‚</p>
<pre><code class="language-assembly">    bne x22, x23, Else  // if
    add x19, x20, x21
    beq x0, x0, Exit    // æ— æ¡ä»¶åˆ†æ”¯çš„ä¸€ç§å®ç°æ–¹æ³•
Else: sub x19, x20. x21 // else
Exit:
</code></pre>
<h4 id="å¾ªç¯-for--while"><a class="header" href="#å¾ªç¯-for--while">å¾ªç¯ (for / while)</a></h4>
<pre><code class="language-c">// i: x22, k: x24, save: x25
while (save[i] == k)
    i += 1;
</code></pre>
<ul>
<li>å°† <code>save[i]</code> åŠ è½½åˆ°ä¸´æ—¶å¯„å­˜å™¨é‡Œã€‚
<ul>
<li>åŠ è½½ <code>save[i]</code> å‰è¿˜éœ€è¦å¾—åˆ°å®ƒçš„åœ°å€ï¼Œå°† i åŠ åˆ° save çš„åŸºå€ä¸Šã€‚</li>
<li>ç”±äºå­—èŠ‚å¯»å€é—®é¢˜ï¼Œi è¿˜éœ€è¦ä¹˜ 8ã€‚è¿™ä¸ªå¯ä»¥é€šè¿‡å·¦ç§»å®ç°</li>
<li>æ·»åŠ  Loop æ ‡ç­¾</li>
</ul>
</li>
</ul>
<pre><code class="language-asm">      slid x10, x22, 3  ; i * 8, å¹¶å­˜åˆ° x10 é‡Œ
      add x10, x10, x25 ; åœ¨åŠ ä¸Š save åŸºå€
      ld x9, 0(x10)     ; å°† x10 å­˜å‚¨åˆ°ä¸´æ—¶å¯„å­˜å™¨
Loop: bne x9, x24, Exit ; æ¯”è¾ƒ
      addi x22, x22, 1  ; i = i + ï¼‘
      beq x0, x0, Loop  ; ç»§ç»­å¾ªç¯
Exitï¼š
</code></pre>
<h4 id="case--switch"><a class="header" href="#case--switch">case / switch</a></h4>
<p>å®ç°æ–¹æ³•ï¼š</p>
<ol>
<li>è½¬æ¢ä¸ºä¸€ç³»åˆ— if-then-else</li>
<li>æ›´é«˜æ•ˆçš„æ–¹æ³•ï¼šä½¿ç”¨åˆ†æ”¯åœ°å€è¡¨æˆ–åˆ†æ”¯è¡¨ã€‚</li>
</ol>
<h3 id="è¿‡ç¨‹æŒ‡ä»¤-å‡½æ•°"><a class="header" href="#è¿‡ç¨‹æŒ‡ä»¤-å‡½æ•°">è¿‡ç¨‹æŒ‡ä»¤ (å‡½æ•°)</a></h3>
<h4 id="è¿‡ç¨‹è°ƒç”¨æ—¶çš„å¯„å­˜å™¨çš„åˆ†é…"><a class="header" href="#è¿‡ç¨‹è°ƒç”¨æ—¶çš„å¯„å­˜å™¨çš„åˆ†é…">è¿‡ç¨‹è°ƒç”¨æ—¶çš„å¯„å­˜å™¨çš„åˆ†é…</a></h4>
<ul>
<li><code>x0</code> ç¡¬è¿çº¿ä¸º 0</li>
<li><code>x10 - x17</code>: å‚æ•°å¯„å­˜å™¨ï¼Œç”¨äºä¼ é€’å‚æ•°æˆ–è€…è¿”å›å€¼</li>
<li><code>x1</code>: ä¸€ä¸ªè¿”å›åœ°å€å¯„å­˜å™¨</li>
</ul>
<h4 id="è·³è½¬æŒ‡ä»¤"><a class="header" href="#è·³è½¬æŒ‡ä»¤">è·³è½¬æŒ‡ä»¤</a></h4>
<ul>
<li><code>jal</code>: è·³è½¬ - é“¾æ¥æŒ‡ä»¤</li>
</ul>
<pre><code class="language-asm">jal x1, ProcedureAddress
</code></pre>
<p>è·³è½¬åˆ° ProcedureAddress å¹¶æŠŠä¸‹ä¸€æ¡æŒ‡ä»¤çš„è¿”å›å€¼ä¿å­˜åˆ°ç›®æ ‡å¯„å­˜å™¨ <strong><code>rd</code></strong>.</p>
<blockquote>
<p>åœ¨å­˜å‚¨ç¨‹åºä¸­ï¼Œæ€»éœ€è¦ä¸€ä¸ªå¯„å­˜å™¨å­˜å‚¨å½“å‰æŒ‡ä»¤çš„åœ°å€ï¼Œè¿™ä¸ªå¯„å­˜å™¨è¢«ç§°ä¸º &quot;ç¨‹åºè®¡æ•°å™¨&quot;, ç¼©å†™ä¸º &quot;PC&quot;.æ‰€ä»¥ <code>jal</code> æŒ‡ä»¤å®é™…ä¸Šæ˜¯å°† <code>PC + 4</code> å†™å…¥åˆ° x1 ä¸­</p>
</blockquote>
<ul>
<li><code>jalr</code> é—´æ¥è·³è½¬ï¼Œå¯ä»¥ç”¨äºå¤„ç† case è¯­å¥ã€‚</li>
</ul>
<pre><code class="language-asm">jalr x0, 0(x1)
</code></pre>
<p>ç”±äº x0 ç¡¬è¿çº¿åˆ° 0ï¼Œæ‰€ä»¥å…¶æ•ˆæœæ˜¯ä¸¢å¼ƒè¿”å›åœ°å€</p>
<p>å½“ç”¨æˆ· <code>jal x1 X</code> <code>jalr x0, 0(x1)</code></p>
<h4 id="ä½¿ç”¨æ›´å¤šå¯„å­˜å™¨"><a class="header" href="#ä½¿ç”¨æ›´å¤šå¯„å­˜å™¨">ä½¿ç”¨æ›´å¤šå¯„å­˜å™¨</a></h4>
<p>å‡è®¾ä¸€ä¸ªè¿‡ç¨‹éœ€è¦æ¯” 8 ä¸ªæ›´å¤šçš„å¯„å­˜å™¨ï¼Œéœ€è¦å°†å¯„å­˜å™¨æ¢å‡ºåˆ°å­˜å‚¨å™¨ã€‚</p>
<p>æ¢å‡ºå¯„å­˜å™¨çš„ç†æƒ³ç»“æ„æ˜¯æ ˆï¼Œæ ˆä¸­éœ€è¦ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªè¿‡ç¨‹åº”è¯¥æ”¾ç½®å¯„å­˜å™¨çš„ä½ç½®ï¼ˆæˆ–è€…æ—§å¯„å­˜å™¨å€¼çš„å­˜æ”¾ä½ç½®ï¼‰ã€‚åœ¨ RISC-V ä¸­ï¼Œæ ˆæŒ‡é’ˆæ˜¯ <code>x2</code> ä¹Ÿç§° <code>sp</code>ã€‚</p>
<pre><code class="language-c">// g: x10, h: x11, i: x12, j: x13
// f: x20
// ä¸´æ—¶å¯„å­˜å™¨ï¼šx5, x6
long long int leaf_example(long long int g, long long int h, long long int i, long long int k) {
    long long int f;
    f = (g + h) - (i + j);
    return f;
}
</code></pre>
<p>æ±‡ç¼–ï¼š</p>
<pre><code class="language-asm">leaf_example:
    ; å‹æ ˆ (sd ä»å¯„å­˜å™¨å–åŒå­—åˆ°å­˜å‚¨å™¨)
    addi sp, sp, -24
    sd x5, 16(sp)        ; tmp1
    sd x6, 8(sp)         ; tmp2
    sd x20, 0(sp)        ; f

    ; è®¡ç®—
    add x5, x10, x11     ; x5 = g + h
    add x6, x12, x13     ; x6 = i + j
    sub x20, x5, x6      ; f = x5 - x6

    ; æŠŠè¿”å›å€¼å¤åˆ¶åˆ°ä¸€ä¸ªå‚æ•°å¯„å­˜å™¨
    addi x10, x20, 0     ; f -&gt; x10

    ; å¼¹æ ˆ (ld ä»å­˜å‚¨å™¨å–åŒå­—åˆ°å¯„å­˜å™¨)
    ld x20, 0(sp)
    ld x6, 8(sp)
    ld x5, 16(sp)
    addi sp, sp, 24

    ; è¿”å›
    jalr x0, 0(x1)
</code></pre>
<p>ä¸Šé¢ä½¿ç”¨äº† x5 å’Œ x6 ä½œä¸ºä¸´æ—¶å¯„å­˜å™¨ï¼Œå¹¶å‡è®¾å®ƒçš„æ—§å€¼å¿…é¡»è¢«ä¿å­˜å’Œæ¢å¤ã€‚ä¸ºäº†é¿å…ä¿å­˜å’Œæ¢å¤ä¸€ä¸ªå…¶å€¼ä»æ²¡è¢«ç”¨è¿‡çš„å¯„å­˜å™¨ (é€šå¸¸ç§°ä¸ºä¸´æ—¶å¯„å­˜å™¨), RISC-V æŠŠå¯„å­˜å™¨åˆ†ä¸ºç±»ä¸¤ç»„ï¼š</p>
<ul>
<li>x5 ~ x7, x28 ~ x31: ä¸´æ—¶å¯„å­˜å™¨ï¼Œåœ¨è¿‡ç¨‹è°ƒç”¨æ—¶ï¼Œä¸ä¼šè¢«è°ƒç”¨è€…ä¿å­˜ã€‚</li>
<li>x8 ~ x9, x18 ~ x27: ä¿å­˜å¯„å­˜å™¨ (saved register), åœ¨è¿‡ç¨‹è°ƒç”¨ä¸­ï¼Œå¿…é¡»è¢«ä¿å­˜ã€‚</li>
</ul>
<p>è¿™ä¸€çº¦å®šï¼Œå‡å°‘äº†å¯„å­˜å™¨æ¢å‡ºï¼Œx5, x6 ä¸ç”¨ä¿å­˜ï¼Œå‡å°‘äº†ä¸¤æ¬¡å­˜å‚¨å’Œè½½å…¥ï¼Œx20 å¿…é¡»ä¿å­˜å’Œæ¢å¤ã€‚</p>
<h4 id="åµŒå¥—è¿‡ç¨‹"><a class="header" href="#åµŒå¥—è¿‡ç¨‹">åµŒå¥—è¿‡ç¨‹</a></h4>
<p>ä¸è°ƒç”¨å…¶ä»–è¿‡ç¨‹çš„è¿‡ç¨‹ç§°ä¸º leaf è¿›ç¨‹</p>
<p>å¦‚ä½•è§£å†³åµŒå¥—ï¼Ÿ</p>
<p>å°†å…¶ä»–æ‰€æœ‰å¿…é¡»ä¿å­˜çš„å¯„å­˜å™¨å‹æ ˆã€‚è°ƒç”¨è€…å°†æ‰€æœ‰å‚æ•°å¯„å­˜å™¨ (x10 ~ x17) æˆ–ä¸´æ—¶å¯„å­˜å™¨ (x5~x7 å’Œ x28 ~ x31) å‹æ ˆï¼Œè¢«è°ƒç”¨è€…å°†è¿”å›åœ°å€å¯„å­˜å™¨ x1 å’Œè¢«è°ƒç”¨è€…ä½¿ç”¨çš„ä¿å­˜å¯„å­˜å™¨ (x8~x9 å’Œ x18 ~ x27) å‹æ ˆã€‚</p>
<pre><code class="language-c">long long int fact(long long int n) {
    if (n &lt; 1)
        return 1;
    else
        return n * fact(n - 1);
}
</code></pre>
<p>æ±‡ç¼–ï¼š</p>
<pre><code class="language-asm">fact:
    ; å‹æ ˆ
    addi sp, sp, -16   ; å‚æ•° n å’Œè¿”å›åœ°å€ x1
    sd x1, 8(sp)       ; æŠŠè¿”å›åœ°å€ x1 å­˜åˆ° 8[sp] ä¸­
    sd x10, 0(sp)      ; æŠŠ x10 [[å‚æ•° n]] å­˜åˆ° 0[sp] ä¸­

    ; åˆ¤æ–­
    addi x5, x10, -1   ; x5 = n - 1
    bge x5, x0, L1     ; if (n - 1 &gt;= 0) goto L1;

    ; true
    addi x10, x0, 1    ; x10 = 1

    addi sp, sp, 16    ; å¼¹æ ˆ
    jalr x0, 0(x1)     ; è·³å›å» x1
L1:
    ; false
    addi x10, x10, -1  ; [[x10 = n - 1]]
    jal x1, fact       ; fact // è¿™é‡Œå‘ç”Ÿé€’å½’

    addi x6, x10, 0    ; æŠŠè®¡ç®—ç»“æœå­˜åˆ° x6

    ld x10, 0(sp)
    ld x1, 8(sp)
    addi sp, sp, 16    ; å¼¹æ ˆ

    mul x10, x10, x6   ; return n * fact(n - 1)
    jalr x0, 0(x1)
</code></pre>
<p>é€šè¿‡æŠŠè¿”å›åœ°å€ (PC + 4) å­˜åˆ°æ ˆä¸Šå®ç°äº†è¿”å›ã€‚</p>
<h4 id="å°¾é€’å½’"><a class="header" href="#å°¾é€’å½’">å°¾é€’å½’</a></h4>
<pre><code class="language-c">long long int sum(long long int n, long long int acc) {
    if (n &gt; 0)
        return sum(n - 1, acc + n);
    else
        return acc;
}
</code></pre>
<p>è¿™ç§æ±‚å’Œçš„é€’å½’å¯ä»¥ç”¨è¿­ä»£é«˜æ•ˆå®ç°</p>
<pre><code class="language-asm">    ; å‡è®¾ x10 = n, x11 = acc, ç»“æœæ”¾å…¥ x12
sum:
    ble x10, x0, sum_exit
    add x11, x11, x10
    addi x10, x10, -1
    jal x0, sum
sum_exit:
    addi x12, x11, 0
    jalr x0, 0(x1)
</code></pre>
<h3 id="å­—ç¬¦å¤„ç†æŒ‡ä»¤"><a class="header" href="#å­—ç¬¦å¤„ç†æŒ‡ä»¤">å­—ç¬¦å¤„ç†æŒ‡ä»¤</a></h3>
<p>RISC-V ä¸­ä¸€ç³»åˆ—æŒ‡ä»¤å¯ä»¥ä»åŒå­—ä¸­æå–ä¸€ä¸ªå­—èŠ‚</p>
<ul>
<li><code>lbu</code> (åŠ è½½æ— ç¬¦å·å­—èŠ‚): ä»å†…å­˜ä¸­åŠ è½½ä¸€ä¸ªå­—èŠ‚ï¼Œæ”¾åˆ°å¯„å­˜å™¨çš„æœ€å³è¾¹å…«ä½</li>
<li><code>sb</code> (å­˜å‚¨å­—èŠ‚): ä»å­˜å‚¨å™¨æœ€å³è¾¹å…«ä½å–ä¸€ä¸ªå­—èŠ‚å¹¶å†™å…¥å†…å­˜</li>
</ul>
<pre><code class="language-asm">lbu x12 0(x10) // read from x10
sb x12 0(x11)  // write to x11
</code></pre>
<p>å­—ç¬¦ä¸²çš„è®¾è®¡ï¼š</p>
<ol>
<li>å­—ç¬¦ä¸²ç¬¬ä¸€ä½ä¿ç•™ï¼Œè¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦</li>
<li>é™„åŠ é•¿åº¦çš„å˜é‡ï¼ˆå¦‚ç»“æ„ä½“ï¼‰</li>
<li>å­—ç¬¦ä¸²çš„ç»“å°¾ç”¨ä¸€ä¸ªå­—ç¬¦æ ‡è®°ç»“å°¾</li>
</ol>
<p><code>strcpy</code> çš„æ±‡ç¼–å®ç°</p>
<pre><code class="language-c">void strcpy(char x[], char y[]) {
    size_t i;
    i = 0;
    while ((x[i] = y[i]) != '\0') { // copy &amp; test byte
        i += 1;
    }
}
</code></pre>
<p>å‡è®¾ x: x10, y: x11, i: x19</p>
<pre><code class="language-asm">strcpy:
    addi sp, sp, -8   ; å‹æ ˆ
    sd x19, 0(sp)     ; ä¿å­˜ i
    add x19, 0, 0;    ; i = 0 + 0
L1:
    add x5, x19, x11  ; è®¡ç®— æ•°ç»„åŸºå€ + åç§»é‡ (i)
    lbu x6, 0(x5)     ; åŠ è½½å¯¹åº”å­—èŠ‚ï¼Œæ³¨æ„ï¼šè¿™é‡Œä¸ç”¨ *8ï¼Œå› ä¸ºæ˜¯å­—èŠ‚æ•°ç»„

    bep x6, x0, L2
    addi x19, x19, 1  ; if (== '\0')
    jal x0, L1
L2:
    ld x19, 0(sp)     ; else
    addi sp, sp, 8    ; å¼¹æ ˆ
    jalr x0, 0(x1)    ; è¿”å›
</code></pre>
<h3 id="å¤§ç«‹å³æ•°"><a class="header" href="#å¤§ç«‹å³æ•°">å¤§ç«‹å³æ•°</a></h3>
<p>å‡å¦‚å¸¸é‡è¶…è¿‡äº† 12 ä½æ€ä¹ˆåŠï¼Ÿ</p>
<p>RISC-V æä¾›äº† lui (load upper immediate) æŒ‡ä»¤ (å–é«˜ä½ç«‹å³æ•°)ï¼Œèƒ½å¤Ÿå°† 20 ä½å¸¸é‡åŠ è½½åˆ°å¯„å­˜å™¨çš„ç¬¬ 31 åˆ° 12 ä½ã€‚</p>
<p>å°†ä»¥ä¸‹ 64 ä½å¸¸é‡åŠ è½½åˆ°å¯„å­˜å™¨ x19ï¼š</p>
<pre><code class="language-asm">; 00000000 00000000 00000000 00000000 00000000 00111101 00000101 00000000


; åŠ è½½å‰ 20 ä½
lui x19, 976                   ; 976: 00000000 00111101

; æ­¤æ—¶ x19
; 00000000 00000000 00000000 00000000 00000000 00111101 00000000 00000000

; åŠ è½½å 12 ä½
addi x19, x19, 1280                             ; 1280: 00000101 00000000
</code></pre>
<h3 id="swap-å’Œ-æ’åº"><a class="header" href="#swap-å’Œ-æ’åº">swap å’Œ æ’åº</a></h3>
<h4 id="swap"><a class="header" href="#swap">swap</a></h4>
<pre><code class="language-c">void swap(long long int v[], size_t k) {
    long long int temp;
    temp = v[k];
    v[k] = v[k + 1];
    v[k + 1] = temp;
}
</code></pre>
<p>æ‰‹åŠ¨æŠŠ C ç¿»è¯‘ä¸º ASM æ—¶ï¼Œæˆ‘ä»¬éµå¾ªä¸€ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>ä¸ºç¨‹åºä¸­çš„å˜é‡åˆ†é…å¯„å­˜å™¨</li>
<li>ä¸ºè¿‡ç¨‹ç”Ÿæˆæ±‡ç¼–ä»£ç </li>
<li>ä¿å­˜è¿‡ç¨‹è°ƒç”¨é—´çš„å¯„å­˜å™¨</li>
</ol>
<p>ä¸‹é¢æ˜¯è¯¦ç»†è¿‡ç¨‹ï¼š</p>
<p>å¯„å­˜å™¨çš„åˆ†é…ã€‚RISC-V å‚æ•°ä¼ é€’é»˜è®¤ä½¿ç”¨ x10 å’Œ x17 å¯„å­˜å™¨ï¼Œç”±äº swap åªæœ‰ä¸¤ä¸ªå‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ x10 å’Œ x17 ä¿å­˜ã€‚</p>
<p>è¿˜å‰©ä¸€ä¸ªå˜é‡ tempï¼Œæˆ‘ä»¬ç”¨ x5 ä¿å­˜å®ƒã€‚</p>
<p>å‰©ä¸‹çš„ C è¿‡ç¨‹ä»£ç ï¼š</p>
<pre><code class="language-c">temp     = v[k];
v[k]     = v[k + 1];
v[k + 1] = tmep;
</code></pre>
<p>å¯¹åº”çš„ ASM:</p>
<pre><code class="language-asm">; ä½¿ç”¨æ•°ç»„åŸºå€ + 8 * i è®¡ç®—åœ°å€
alli x6, x11, 3     ; reg x6 = k * 8
add  x6, x10, x6    ; reg x6 = x6 + (k * 8)

; åŠ è½½æ•°ç»„æ•°æ®åˆ°å¯„å­˜å™¨
ld x5, 0(x6)        ; reg x5 (temp) = v[k]
ld x7, 8(x6)        ; reg x7        = v[k + 1]

; æŠŠå¯„å­˜å™¨æ•°æ®å­˜å…¥æ•°ç»„
sd x7, 0(x6)        ; v[k]     = reg x7
sd x5, 8(x6)        ; v[k + 1] = reg x5 (temp)
</code></pre>
<p>RISC-V æ˜¯å­—èŠ‚å¯»å€ï¼ŒåŒå­—ä¹‹é—´ç›¸å·®äº† 8 ä¸ªå­—èŠ‚ã€‚</p>
<h4 id="sort"><a class="header" href="#sort">sort</a></h4>
<pre><code class="language-c">void sort(long long int v[], size_t int n) {
    size_t i, j;
    for (int i = 0; i &lt; n; i += 1) {
        for (j = i - 1; j &gt;= 0 &amp;&amp; v[j] &gt; v[j + 1]; j -= 1) {
            swap(v, j);
        }
    }
}
</code></pre>
<ol>
<li>
<p>å¯„å­˜å™¨çš„åˆ†é…ï¼š</p>
<p>v å’Œ n ä¸¤ä¸ªå‚æ•°ä¿å­˜åœ¨ x10 å’Œ x11 ä¸­ï¼Œæˆ‘ä»¬å°† i å’Œ j ä¸¤ä¸ªä¸´æ—¶å¯„å­˜å™¨åˆ†é…åœ¨ x19 å’Œ x20 (éƒ½æ˜¯ä¿å­˜å¯„å­˜å™¨).</p>
</li>
<li>
<p>ç¿»è¯‘è¿‡ç¨‹ä½“ä»£ç ï¼š</p>
<p>è¿‡ç¨‹ä½“ç”±ä¸¤å±‚ for å¾ªç¯å’Œä¸€ä¸ª swap è°ƒç”¨ç»„æˆï¼Œæˆ‘ä»¬ä»å¤–åˆ°å†…å±•å¼€ä»£ç ã€‚</p>
</li>
</ol>
<h5 id="ç¬¬ä¸€å±‚-for-å¾ªç¯"><a class="header" href="#ç¬¬ä¸€å±‚-for-å¾ªç¯">ç¬¬ä¸€å±‚ for å¾ªç¯</a></h5>
<p><code>for (int i = 0; i &lt; n; i += 1) {</code>:</p>
<p>for å¾ªç¯åˆ†ä¸‰æ­¥ï¼Œå¯¹ i åšåˆå§‹åŒ–ï¼Œåˆ¤æ–­ <code>i &lt; n</code> å’Œ <code>i += 1</code>, åˆ†åˆ«å¯¹åº”ä¸‹é¢çš„æ±‡ç¼–æŒ‡ä»¤ï¼š</p>
<pre><code class="language-asm">; åˆå§‹åŒ–
li x19, 0         ; li æ˜¯æ±‡ç¼–å™¨æä¾›çš„ä¼ªæŒ‡ä»¤, ç›®çš„æ˜¯ç®€åŒ–æ±‡ç¼–çš„ç¼–å†™

; i += 1
addi x19, x19, 1

; åˆ¤æ–­ i &lt; n
for1tst:
    beg x19, x11, exit1 ; å¦‚æœ i &gt;= 0, åˆ™é€€å‡º
    j for1tst
exit1:
</code></pre>
<p>ç»è¿‡æ’åºåï¼š</p>
<pre><code class="language-asm">li x19, 0
for1tst:
    bge x19, x11, exit1 ; å¦‚æœ i &gt;= 0, åˆ™é€€å‡º
    ...
    ; i å¾ªç¯çš„ body
    ...
    addi x19, x19, 1  ; i += 1
    j for1tst         ; ç»§ç»­å¾ªç¯
exit1:
</code></pre>
<h5 id="ç¬¬äºŒå±‚å¾ªç¯"><a class="header" href="#ç¬¬äºŒå±‚å¾ªç¯">ç¬¬äºŒå±‚å¾ªç¯</a></h5>
<p><code>for (j = i - 1; j &gt;= 0 &amp;&amp; v[j] &gt; v[j + 1]; j -= 1) {</code></p>
<pre><code class="language-asm">; åˆå§‹åŒ–
addi x20, x19, -1

; j -= 1
addi x20, x20, -1

; åˆ¤æ–­æ¡ä»¶,ä»»æ„ä¸€ä¸ªä¸ºå‡éƒ½è¦æ¨å‡ºå¾ªç¯
for2tst:
    ; åˆ¤æ–­ j &gt;= 0
    ble x20, 0, exit2

    ; åˆ¤æ–­ v[j]&gt; v[j + 1]
    ; å…ˆè®¡ç®—åœ°å€
    slii x5, x20, 8    ; reg x5 = j * 8
    add x5, x10, x5    ; reg x5 = v = j * 8
    ld x6, 0(x5)       ; åŠ è½½ v[j]
    ld x7, 8(x5)       ; åŠ è½½ v[j + 1]
    bge x6, x7, exit2  ; æ¯”è¾ƒ
    ...
    (ç¬¬äºŒä¸ªå¾ªç¯çš„å†…å®¹)
    ...
    addi x20, x20, -1  ; j -= 1
    j for2tst          ; é‡å¤å¾ªç¯
exit2:
</code></pre>
<h5 id="è°ƒç”¨-swap"><a class="header" href="#è°ƒç”¨-swap">è°ƒç”¨ swap</a></h5>
<p>è°ƒç”¨ swap å¾ˆå®¹æ˜“ï¼š <code>j x1 swap</code></p>
<p>swap éœ€è¦ x10 (v) å’Œ x11 (k) ä¸­çš„å€¼ï¼Œå…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯ï¼šå°† swap çš„å‚æ•°æå‰å¤åˆ¶åˆ°å…¶ä»–å¯„å­˜å™¨ä¸­ï¼Œä½¿å¾— x10 å’Œ x11 åœ¨è°ƒç”¨ swap æ—¶å¯ç”¨ã€‚</p>
<pre><code class="language-asm">mv x21, x10 ; æŠŠ x10 å¤åˆ¶åˆ° x21
mv x22, x11 ; æŠŠ x11 å¤åˆ¶åˆ° x20
</code></pre>
<p>ç„¶åå°†è¿™ä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ swap:</p>
<pre><code class="language-asm">mv x10, x21 ; æŠŠ x10 ä» x21 æ¢å¤å›å»
mv x11, x20 ; ?
</code></pre>
<p>ä¿ç•™ sort ä¸­çš„å¯„å­˜å™¨</p>
<pre><code class="language-asm">sort:
    addi sp, sp, -40
    sd x1, 32(sp)       ; è¿”å›åœ°å€
    sd x22, 24(sp)      ; æŠŠ x22 ä¿å­˜åˆ°æ ˆ
    sd x21, 16(sp)      ; åŒä¸Š
    sd x20, 8(sp)       ; åŒä¸Š
    sd x19, 0(sp)       ; åŒä¸Š
</code></pre>
<h5 id="å®Œæ•´è¿‡ç¨‹"><a class="header" href="#å®Œæ•´è¿‡ç¨‹">å®Œæ•´è¿‡ç¨‹</a></h5>
<pre><code class="language-c">void sort(long long int v[], size_t int n) {
    size_t i, j;
    for (int i = 0; i &lt; n; i += 1) {
        for (j = i - 1; j &gt;= 0 &amp;&amp; v[j] &gt; v[j + 1]; j -= 1) {
            swap(v, j);
        }
    }
}
</code></pre>
<ul>
<li>v å’Œ n ä¸¤ä¸ªå‚æ•°ä¿å­˜åœ¨ x10 å’Œ x11 ä¸­ï¼Œ</li>
<li>i å’Œ j ä¸¤ä¸ªä¸´æ—¶å¯„å­˜å™¨åˆ†é…åœ¨ x19 å’Œ x20 (éƒ½æ˜¯ä¿å­˜å¯„å­˜å™¨).</li>
</ul>
<pre><code class="language-asm">
sort:
    addi sp, sp, -40
    sd x1, 32(sp)       ; è¿”å›åœ°å€
    sd x22, 24(sp)      ; æŠŠ x22 ä¿å­˜åˆ°æ ˆ
    sd x21, 16(sp)      ; åŒä¸Š
    sd x20, 8(sp)       ; åŒä¸Š
    sd x19, 0(sp)       ; åŒä¸Š

    ; ä¸º swap ä¿å­˜å‚æ•°
    mv x21, x10 ; æŠŠ x10 (v) å¤åˆ¶åˆ° x21
    mv x22, x11 ; æŠŠ x11 (k) å¤åˆ¶åˆ° x22

    ; åˆå§‹åŒ– i = 0
    li x19, 0
for1tst:
    bge x19, x22, exit1 ; å¦‚æœ i &gt;= 0, åˆ™é€€å‡º
    ; åˆå§‹åŒ– j = i - 1
    addi x20, x19, -1   ; j = i - 1
for2tst:
    ; åˆ¤æ–­ j &gt;= 0
    ble x20, 0, exit2

    ; åˆ¤æ–­ v[j]&gt; v[j + 1]
    ; å…ˆè®¡ç®—åœ°å€
    slii x5, x20, 8    ; reg x5 = j * 8
    add x5, x10, x5    ; reg x5 = v = j * 8
    ld x6, 0(x5)       ; åŠ è½½ v[j]
    ld x7, 8(x5)       ; åŠ è½½ v[j + 1]
    bge x6, x7, exit2  ; å¦‚æœ v[j] &gt; v[j + 1], åˆ™é€€å‡º

    ; æ¢å¤å¯„å­˜å™¨, å¹¶è°ƒç”¨ swap
    mv x10, x21
    mv x11, x20
    jal x1, swap

    addi x20, x20, -1  ; j -= 1
    j for2tst          ; é‡å¤å¾ªç¯
exit2:
    addi x19, x19, 1  ; i += 1
    j for1tst         ; ç»§ç»­å¾ªç¯
exit1:
    ld x19, 0(sp)
    ld x20, 8(sp)
    ld x21, 16(sp)
    ld x22, 24(sp)
    ld x1, 32(sp)
    addi sp, sp, 40
    jalr x0, 0(x1)
</code></pre>
<pre><code class="language-asm">swap:
    ; ä½¿ç”¨æ•°ç»„åŸºå€ + 8 * i è®¡ç®—åœ°å€
    alli x6, x11, 3     ; reg x6 = k * 8
    add  x6, x10, x6    ; reg x6 = x6 + (k * 8)

    ; åŠ è½½æ•°ç»„æ•°æ®åˆ°å¯„å­˜å™¨
    ld x5, 0(x6)        ; reg x5 (temp) = v[k]
    ld x7, 8(x6)        ; reg x7        = v[k + 1]

    ; æŠŠå¯„å­˜å™¨æ•°æ®å­˜å…¥æ•°ç»„
    sd x7, 0(x6)        ; v[k]     = reg x7
    sd x5, 8(x6)        ; v[k + 1] = reg x5 (temp)
</code></pre>
<h3 id="æ•°ç»„å’ŒæŒ‡é’ˆ"><a class="header" href="#æ•°ç»„å’ŒæŒ‡é’ˆ">æ•°ç»„å’ŒæŒ‡é’ˆ</a></h3>
<pre><code class="language-c">clear1(long long int array[], size_t int size) {
    size_t i;
    for (i = 0; i &lt; size; i += 1) {
        array[i] = 0;
    }
}
clear2(long long int *array, size_t int size) {
    long long int *p
    for (p = &amp;array[0]; p &lt; &amp;array[size]; p = p + 1) {
        *p = 0;
    }
}
</code></pre>
<p>å‡è®¾ array: x10, size: x11, i: x5</p>
<pre><code class="language-asm">    li x5, 0            ; i = 0
loop1:
    slii x6, x5, 3      ; i * 8
    add x7, x10, x6
    sd 0, 0(x7)         ; array[i] = 0
    addi x5, x5, 1
    ble x5, x11, loop1  ; if i &lt; size; goto loop1
</code></pre>
<p>æŒ‡é’ˆå®ç°</p>
<pre><code class="language-asm">    mv x5, x10          ; p(x5) = x10
loop2:
    sd x0, 0(x5)        ; åŠ è½½ *p
    addi x5, x5, 8      ; p = p + 8
    slli x6, x11, 3     ; x6 = size + 8
    add x7, x10, x6     ; x7 = &amp;array[size]
    bltu x5, x7, loop2
</code></pre>
<p>è¿™æ®µä»£ç å¯ä»¥ä¼˜åŒ–ï¼Œå°†è®¡ç®— <code>&amp;array[size]</code> ç§»åŠ¨åˆ°å¤–éƒ¨ï¼š</p>
<pre><code class="language-asm">    mv x5, x10          ; p(x5) = x10
    slli x6, x11, 3     ; x6 = size + 8
    add x7, x10, x6     ; x7 = &amp;array[size]
loop2:
    sd x0, 0(x5)        ; åŠ è½½ *p
    addi x5, x5, 8      ; p = p + 8
    bltu x5, x7, loop2
</code></pre>
<p>å‡å°‘äº†ä¸¤æ¡æŒ‡ä»¤ï¼Œè¿™ç§ä¼˜åŒ–å¯¹åº”åˆ†åˆ«äºä¸¤ç§ç¼–è¯‘å™¨ä¼˜åŒ–ï¼š</p>
<ul>
<li>&quot;å¼ºåº¦å‰Šå¼±&quot;: ä½¿ç”¨ç§»ä½ä»£æ›¿ä¹˜æ³•</li>
<li>å¾ªç¯å˜é‡æ¶ˆé™¤ï¼šæ¶ˆé™¤å¾ªç¯å†…çš„æ•°ç»„åœ°å€è®¡ç®—</li>
</ul>
<h2 id="å¹¶å‘"><a class="header" href="#å¹¶å‘">å¹¶å‘</a></h2>
<p>è¿™é‡Œä»‹ç»ä¸Šé” (lock) å’Œè§£é” (unlock) çš„åŒæ­¥å®ç°</p>
<p>åœ¨å¤šå¤„ç†å™¨ä¸­å®ç°åŒæ­¥æ‰€éœ€çš„å…³é”®æ˜¯ä¸€ç»„ç¡¬ä»¶åŸè¯­ï¼Œå®ƒä»¬èƒ½å¤Ÿæä¾›ä»¥åŸå­æ–¹å¼è¯»å–å’Œä¿®æ”¹å†…å­˜å•å…ƒçš„èƒ½åŠ›ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å†…å­˜å•å…ƒçš„è¯»å–å’Œå†™äººä¹‹é—´ä¸èƒ½æ’äººå…¶ä»–ä»»ä½•æ“ä½œã€‚</p>
<blockquote>
<p>å¦‚æœæ²¡æœ‰è¿™æ ·çš„èƒ½åŠ›ï¼Œæ„å»ºåŸºæœ¬åŒæ­¥åŸè¯­çš„æˆæœ¬å°†ä¼šå¾ˆé«˜å¹¶ä¼šéšç€å¤„ç†å™¨æ•°é‡çš„å¢åŠ è€Œæ€¥å‰§å¢åŠ ã€‚</p>
</blockquote>
<p>æœ‰è®¸å¤šåŸºæœ¬ç¡¬ä»¶åŸè¯­çš„å®ç°æ–¹æ¡ˆï¼Œæ‰€æœ‰è¿™äº›éƒ½æä¾›äº†åŸå­è¯»å’ŒåŸå­å†™çš„èƒ½åŠ›ä»¥åŠä¸€äº›åˆ¤æ–­è¯»å†™æ˜¯å¦æ˜¯åŸå­æ“ä½œçš„åŠ›æ³•ã€‚</p>
<blockquote>
<p>é€šå¸¸ï¼Œä½“ç³»ç»“æ„è®¾è®¡äººå‘˜ä¸å¸Œæœ›ç”¨æˆ·ä½¿ç”¨åŸºæœ¬çš„ç¡¬ä»¶åŸè¯­è€Œæ˜¯æœŸæœ›ç³»ç»Ÿç¨‹åºå‘˜ä½¿ç”¨åŸè¯­æ¥æ„å»ºåŒæ­¥åº“ï¼Œè¿™ä¸ªè¿‡ç¨‹é€šå¸¸å¤æ‚ä¸”æ£˜æ‰‹ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬ä» <strong>åŸå­äº¤æ¢</strong> (atomic exchange æˆ– atomic swap) åŸè¯­å¼€å§‹å±•ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒæ¥æ„å»º åŸºæœ¬åŒæ­¥åŸè¯­ã€‚å®ƒæ˜¯æ„å»ºåŒæ­¥æœºåˆ¶çš„ä¸€ç§å…¸å‹æ“ä½œï¼Œå®ƒå°†å¯„å­˜å™¨ä¸­çš„å€¼ä¸å­˜å‚¨å™¨ä¸­çš„å€¼è¿›è¡Œäº¤æ¢ã€‚</p>
<p>ä¸ºäº†äº†è§£å¦‚ä½•ä½¿ç”¨å®ƒæ¥æ„å»ºåŸºæœ¨åŒæ­¥åŸè¯­ï¼Œå‡è®¾è¦æ„å»ºä¸€ä¸ªç®€å•çš„é”å˜é‡ï¼Œå…¶ä¸­ç”¨ 0 è¡¨ç¤ºé”å¯ç”¨ï¼Œç”¨ 1 ç”¨äºè¡¨ç¤ºé”å·²è¢«å ç”¨ã€‚</p>
<p>å¤„ç†å™¨å°è¯•é€šè¿‡å°†å¯„å­˜å™¨ä¸­çš„ 1 ä¸è¯¥é”å˜é‡å¯¹åº”çš„å†…å­˜åœ°å€çš„å€¼è¿›è¡Œäº¤æ¢æ¥è®¾ç½®åŠ é”ã€‚å¦‚æœæŸä¸ªå…¶ä»–å¤„ç†å™¨å·²å£°æ˜è®¿é—´è¯¥é”å˜é‡åˆ™äº¤æ¢æŒ‡ä»¤çš„è¿”å›å€¼ä¸º 1 è¡¨æ˜è¯¥é”å·²è¢«å…¶ä»–å¤„ç†å™¨å ç”¨ï¼Œå¦åˆ™ä¸º 0 è¡¨ç¤ºåŠ é”æˆåŠŸã€‚åœ¨åä¸€ç§æƒ…å†µä¸‹ï¼Œé”å˜é‡çš„å€¼å˜ä¸º 1 ä»¥é˜²æ­¢å…¶ä»–å¤„ç†å™¨ä¹ŸåŠ é”æˆåŠŸ</p>
<p>ç°åœ¨è€ƒè™‘ä¸¤ä¸ªå¤„ç†å™¨å°è¯•åŒæ—¶è¿›è¡Œäº¤æ¢æ“ä½œï¼šè¿™ç§ç«äº‰ä¼šè¢«é˜»æ­¢ã€‚å› ä¸ºå…¶ä¸­ä¸€ä¸ªå¤„ç†å™¨å°†é¦–å…ˆæ‰§è¡Œäº¤æ¢å¹¶è¿”å›ã€‚è€Œç¬¬äºŒä¸ªå¤„ç†å™¨åœ¨è¿›è¡Œäº¤æ¢æ—¶å°†è¿”å› 1ã€‚ä½¿ç”¨äº¤æ¢åŸè¯­å®ç°åŒæ­¥çš„å…³é”®æ˜¯æ“ä½œçš„åŸå­æ€§ï¼šäº¤æ¢æ˜¯ä¸å¯åˆ†å‰²çš„ï¼ç¡¬ä»¶å°†å¯¹ä¸¤ä¸ªåŒæ—¶å‘ç”Ÿçš„äº¤æ¢è¿›è¡Œæ’åºï¼Œå°è¯•ä»¥è¿™ç§æ–¹å¼è®¾ç½®åŒæ­¥å˜é‡çš„ä¸¤ä¸ªå¤„ç†å™¨éƒ½ä¸å¯èƒ½è®¤ä¸ºå®ƒä»¬åŒæ—¶è®¾ç½®äº†å˜é‡ã€‚</p>
<p>å®ç°å•ä¸ªçš„åŸå­å­˜å‚¨æ“ä½œä¸ºå¤„ç†å™¨çš„è®¾è®¡å¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜ï¼Œå› ä¸ºå®ƒè¦æ±‚åœ¨å•æ¡ä¸å¯ä¸­æ–­çš„æŒ‡ä»¤ä¸­å®Œæˆå­˜å‚¨å™¨çš„è¯»å’Œå†™æ“ä½œ</p>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨æŒ‡ä»¤å¯¹å…¶ä¸­ç¬¬äºŒæ¡æŒ‡ä»¤è¿”å›ä¸€ä¸ªå€¼ï¼Œè¯¥å€¼è¡¨ç¤ºè¯¥æŒ‡ä»¤å¯¹æ˜¯å¦è¢«åŸå­æ‰§è¡Œã€‚å¦‚æœä»»ä½•å¤„ç†å™¨æ‰§è¡Œçš„æ‰€æœ‰å…¶ä»–æ“ä½œéƒ½å‘ç”Ÿåœ¨è¯¥å¯¹æŒ‡ä»¤ä¹‹å‰æˆ–ä¹‹åï¼Œåˆ™è¯¥æŒ‡ä»¤å¯¹å®é™…ä¸Šæ˜¯åŸå­çš„ã€‚å› æ­¤ï¼Œå½“æŒ‡ä»¤å¯¹å®é™…ä¸Šæ˜¯åŸå­æ“ä½œæ—¶æ²¡æœ‰å…¶ä»–å¤„ç†å™¨å¯ä»¥åœ¨æŒ‡ä»¤å¯¹ä¹‹é—´æ”¹å˜å€¼ã€‚</p>
<p>åœ¨ RISC-V ä¸­ï¼Œè¿™å¯¹æŒ‡ä»¤æŒ‡çš„æ˜¯ä¸€ä¸ªç§°ä¸º <strong>ä¿ç•™åŠ è½½ (load-reserved) åŒå­— (1 rd)</strong> çš„ç‰¹æ®ŠåŠ è½½æŒ‡ä»¤ï¼Œå’Œä¸€ä¸ªç§°ä¸º <strong>æ¡ä»¶å­˜å‚¨ (store-conditional) åŒå­— (sc.d)</strong> çš„ç‰¹æ®Šå­˜å‚¨æŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤æŒ‰åºä½¿ç”¨ï¼š</p>
<ul>
<li>å¦‚æœä¿ç•™åŠ è½½æŒ‡ä»¤æŒ‡å®šçš„å†…å­˜ä½ç½®çš„å†…å®¹åœ¨æ¡ä»¶å­˜å‚¨æŒ‡ä»¤æ‰§è¡Œåˆ°åŒä¸€åœ°å€ä¹‹å‰å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™æ¡ä»¶å­˜å‚¨æŒ‡ä»¤å¤±è´¥ä¸”ä¸ä¼šå°†å€¼å†™äººå†…å­˜ã€‚</li>
<li>æ¡ä»¶å­˜å‚¨æŒ‡ä»¤å®šä¹‰ä¸ºå°†ï¼ˆå¯èƒ½æ˜¯ä¸åŒçš„ï¼‰å¯„å­˜å™¨çš„å€¼å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœæˆåŠŸåˆ™å°†å¦ä¸€ä¸ªå¯„å­˜å™¨çš„å€¼æ›´æ”¹ä¸º 0 ,å¦‚æœå¤±è´¥åˆ™æ›´æ”¹ä¸ºéé›¶å€¼ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œsc.d æŒ‡å®šäº†ä¸‰ä¸ªå¯„å­˜å™¨ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”¨äºä¿å­˜åœ°å€</li>
<li>ä¸€ä¸ªç”¨äºæŒ‡ç¤ºåŸå­æ“ä½œçš„å¤±è´¥æˆ–æˆåŠŸ</li>
<li>è¿˜æœ‰ä¸€ä¸ªç”¨äºå¦‚æœæˆåŠŸåˆ™å°†å€¼å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚</li>
</ul>
<p>ç”±äºä¿ç•™åŠ è½½æŒ‡ä»¤è¿”å›åˆå§‹ä½ï¼Œå¹¶ä¸”æ¡ä»¶å­˜å‚¨æŒ‡ä»¤ä»…åœ¨æˆåŠŸæ—¶è¿”å› 0ï¼Œå› æ­¤ä»¥ä¸‹åºåˆ—åœ¨å¯„å­˜å™¨ x20 ä¸­æŒ‡å®šçš„å†…å­˜ä½ç½®ä¸Šå®ç°åŸå­äº¤æ¢</p>
<pre><code class="language-asm">again:
    lr.d x10, (x20)         ; ä¿ç•™åŠ è½½ load-reserved
    sc.d x11, x23, (x20)    ; æ¡ä»¶å­˜å‚¨ store-conditional
    bne  x11, x0, again     ; å¤±è´¥åˆ™é‡è¯•
    addi x23, x10, 0        ; ä¿å­˜åŠ è½½åˆ°çš„å€¼åˆ° x23
</code></pre>
<p>è¯¦ç»†é˜è¿°ï¼šè™½ç„¶åŒæ­¥æ˜¯ä¸ºå¤šå¤„ç†å™¨è€Œæå‡ºçš„ï¼Œä½†åŸå­äº¤æ¢å¯¹äºå•ä¸ªå¤„ç†å™¨æ“ä½œç³»ç»Ÿä¸­å¤„ç†å¤šä¸ªè¿›ç¨‹ä¹Ÿå¾ˆæœ‰ç”¨ã€‚ä¸ºäº†ç¡®ä¿å•ä¸ªå¤„ç†å™¨ä¸­çš„æ‰§è¡Œä¸å—ä»»ä½•å¹²æ‰°ï¼Œå¦‚æœå¤„ç†å™¨åœ¨<strong>ä¸¤ä¸ªæŒ‡ä»¤å¯¹ä¹‹é—´è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢</strong>ï¼Œåˆ™æ¡ä»¶å­˜å‚¨ä¹Ÿä¼šå¤±è´¥</p>
<p>è¯¦ç»†é˜è¿°ï¼šä¿ç•™åŠ è½½/æ¡ä»¶å­˜å‚¨æœºåˆ¶çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥ç”¨äºæ„å»ºå…¶ä»–åŒæ­¥åŸè¯­ï¼Œä¾‹å¦‚åŸå­çš„æ¯”è¾ƒå’Œäº¤æ¢ (atomic compare and swap) æˆ–åŸå­çš„å–ååŠ  (atomic fetch-and-increment), è¿™åœ¨ä¸€äº›å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ä¸­ä½¿ç”¨ã€‚è¿™äº›åŒæ­¥åŸè¯­çš„å®ç°éœ€è¦åœ¨ <code>lr.d</code> å’Œ <code>sc.d</code> ä¹‹é—´æ’å…¥æ›´å¤šæŒ‡ä»¤ï¼Œä½†ä¸ä¼šå¤ªå¤š</p>
<p>ç”±äºæ¡ä»¶å­˜å‚¨ä¼šåœ¨å¦ä¸€ä¸ª store å°è¯•åŠ è½½ä¿ç•™åœ°å€æˆ–å¼‚å¸¸ä¹‹åå¤±è´¥ï¼Œå› æ­¤å¿…é¡»æ³¨æ„é€‰æ‹©åœ¨ä¸¤ä¸ªæŒ‡ä»¤ä¹‹é—´æ’å…¥å“ªäº›æŒ‡ä»¤ã€‚ç‰¹åˆ«æ˜¯ï¼Œåªæœ‰ä¿ç•™åŠ è½½/æ¡ä»¶å­˜å‚¨å—ä¸­çš„æ•´ç‚¹ç®—æœ¯ã€å‰å‘åˆ†æ”¯å’Œåå‘åˆ†æ”¯è¢«å…è®¸æ‰§è¡Œä¸”ä¸ä¼šå‡ºç°é—®é¢˜ï¼›å¦åˆ™ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ­»é”æƒ…å†µ - ç”±äºé‡å¤çš„é¡µé”™è¯¯ï¼Œå¤„ç†å™¨æ°¸è¿œæ— æ³•å®Œæˆ <code>sc.d</code>ã€‚æ­¤å¤–ï¼Œä¿ç•™åŠ è½½å’Œæ¡ä»¶å­˜å‚¨ä¹‹é—´çš„æŒ‡ä»¤æ•°åº”è¯¥å¾ˆå°‘ï¼Œä»¥å°†ç”±äºä¸ç›¸å…³äº‹ä»¶æˆ–ç«äº‰å¤„ç†å™¨å¯¼è‡´æ¡ä»¶å­˜å‚¨é¢‘ç¹å¤±è´¥çš„å¯èƒ½æ€§é™è‡³æœ€ä½ã€‚</p>
<p>è¯¦ç»†é˜è¿°ï¼šè™½ç„¶ä¸Šé¢çš„ä»£ç å®ç°äº†åŸå­äº¤æ¢ï¼Œä½†ä¸‹é¢çš„ä»£ç å¯ä»¥æ›´æœ‰æ•ˆåœ°è·å–å¯„å­˜å™¨ x20 å¯¹åº”å­˜å‚¨ä¸­çš„é”å˜é‡ï¼Œå…¶ä¸­å€¼ 0 è¡¨ç¤ºé”å˜é‡æ˜¯ç©ºé—²çš„ï¼Œå€¼ 1 è¡¨ç¤ºé”å˜é‡è¢«å ç”¨ï¼š</p>
<pre><code class="language-asm">    addi x12, x0, 1         ; x12 è®¾ä¸º 1
again:
    lr.d x10, (x20)         ; è¯»å–é”çŠ¶æ€
    bne x10, x0, again      ; å¦‚æœæ˜¯ 0
    sc.d x11, x12, (x20)    ; æŠŠ 1 å­˜åˆ° x20, æŠŠ x20 è¿”å›åˆ° x11
    bne x11, 0, again       ; å¦‚æœ x11 ä¸º 1, è¯´æ˜å·²ç»è¢«ä¸Šé”, again
    sd x0, 0(x20)           ; ä½¿ç”¨æ™®é€šçš„å­˜å‚¨æŒ‡ä»¤å°±èƒ½é‡Šæ”¾é”
</code></pre>
<h2 id="å‘é‡-or-simd"><a class="header" href="#å‘é‡-or-simd">å‘é‡ or SIMDï¼Ÿ</a></h2>
<p>æ•°ç»„æ˜¯ä¸€ä¸ªå¸¸è§çš„ä¾‹å­ã€‚è™½ç„¶å®ƒæ˜¯ç§‘å­¦åº”ç”¨çš„åŸºç¡€ï¼Œä½†å®ƒä¹Ÿè¢«å¤šåª’ä½“ç¨‹åºä½¿
ç”¨ã€‚å‰è€…ä½¿ç”¨å•ç²¾åº¦å’ŒåŒç²¾åº¦æµ®ç‚¹æ•°æ®ï¼Œåè€…é€šå¸¸ä½¿ç”¨ 8 ä½å’Œ 16 ä½æ•´æ•°æ•°æ®ã€‚</p>
<h3 id="simd"><a class="header" href="#simd">SIMD</a></h3>
<p>æœ€è‘—åçš„æ•°æ®çº§å¹¶è¡Œæ¶æ„æ˜¯å•æŒ‡ä»¤å¤šæ•°æ® (SIMDï¼ŒSingle Instruction Multiple Data)ã€‚
SIMD</p>
<ul>
<li>å®ƒå°† 64 ä½å¯„å­˜å™¨çš„æ•°æ®åˆ†æˆè®¸å¤šä¸ª 8 ä½ã€16 ä½æˆ– 32 ä½çš„éƒ¨åˆ†ï¼Œ
ç„¶åå¹¶è¡Œåœ°è®¡ç®—å®ƒä»¬ã€‚</li>
<li>æ“ä½œç æä¾›äº†æ•°æ®å®½åº¦å’Œæ“ä½œç±»å‹ã€‚</li>
<li>æ•°æ®ä¼ è¾“åªç”¨å•ä¸ªï¼ˆå®½ï¼‰SIMD å¯„å­˜å™¨çš„ load å’Œ store è¿›è¡Œã€‚</li>
</ul>
<h3 id="å‘é‡"><a class="header" href="#å‘é‡">å‘é‡</a></h3>
<ul>
<li>è®¡ç®—æœºä»å†…å­˜ä¸­ä¸­æ”¶é›†æ•°æ®å¹¶å°†å®ƒä»¬æ”¾å…¥é•¿çš„ï¼Œé¡ºåºçš„å‘é‡å¯„å­˜å™¨ä¸­ã€‚åœ¨è¿™äº›å‘
é‡å¯„å­˜å™¨ä¸Šï¼Œæµæ°´çº¿æ‰§è¡Œå•å…ƒå¯ä»¥é«˜æ•ˆåœ°æ‰§è¡Œè¿ç®—ã€‚</li>
<li>å‘é‡æ¶æ„å°†ç»“æœä»å‘é‡å¯„å­˜å™¨ä¸­å–å‡ºï¼Œå¹¶å°†å…¶å¹¶åˆ†æ•£åœ°å­˜å›ä¸»å­˜ã€‚</li>
<li>å‘é‡å¯„å­˜å™¨çš„å¤§å°ç”±å®ç°å†³å®šï¼Œè€Œä¸æ˜¯åƒ SIMD ä¸­é‚£æ ·åµŒå…¥æ“ä½œç ä¸­ã€‚</li>
</ul>
<h3 id="å¯¹æ¯”"><a class="header" href="#å¯¹æ¯”">å¯¹æ¯”</a></h3>
<p><strong>å°†å‘é‡çš„é•¿åº¦å’Œæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå¯ä»¥è¿›è¡Œçš„æœ€å¤§æ“ä½œæ•°åˆ†ç¦»ï¼Œæ˜¯å‘é‡ä½“ç³»ç»“æ„çš„å…³é”®æ‰€åœ¨</strong>ï¼š</p>
<ul>
<li>å‘é‡å¾®æ¶æ„å¯ä»¥çµæ´»åœ°è®¾è®¡æ•°æ®å¹¶è¡Œç¡¬ä»¶è€Œä¸ä¼šå½±å“åˆ°ç¨‹åºå‘˜ï¼Œç¨‹åºå‘˜å¯ä»¥ä¸ç”¨é‡å†™ä»£ç å°±äº«å—åˆ°é•¿å‘é‡å¸¦æ¥çš„å¥½å¤„ã€‚</li>
<li>å‘é‡æ¶æ„æ¯” SIMD æ¶æ„æ‹¥æœ‰æ›´å°‘çš„æŒ‡ä»¤æ•°é‡ã€‚</li>
<li>ä¸ SIMD ä¸åŒï¼Œå‘é‡æ¶æ„æœ‰ç€å®Œå–„çš„ç¼–è¯‘å™¨æŠ€æœ¯ã€‚</li>
</ul>
<blockquote>
<p>å‘é‡æ¶æ„ä¸å¦‚ SIMD æ¶æ„å—æ¬¢è¿çš„ä¸€ä¸ªåŸå› æ˜¯ï¼šå¤§å®¶æ‹…å¿ƒå¢åŠ å¤§å‹å‘é‡å¯„å­˜å™¨ä¼šå»¶é•¿ä¸­æ–­æ—¶ä¿å­˜å’Œæ¢å¤ç¨‹åºï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰çš„æ—¶é—´ã€‚åŠ¨æ€å¯„å­˜å™¨ç±»å‹å¯¹æ­¤å¾ˆæœ‰å¸®åŠ©ã€‚ç¨‹åºå‘˜å¿…é¡»å‘Šè¯‰å¤„ç†å™¨æ­£åœ¨ä½¿ç”¨å“ªäº›å‘é‡å¯„å­˜å™¨ï¼Œè¿™æ„å‘³ç€å¤„ç†å™¨éœ€è¦åœ¨ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸­ä»…ä¿å­˜å’Œæ¢å¤é‚£äº›å¯„å­˜å™¨ã€‚RV32V çº¦å®šåœ¨ä¸ä½¿ç”¨å‘é‡æŒ‡ä»¤çš„æ—¶å€™ç¦ç”¨æ‰€æœ‰å‘é‡å¯„å­˜å™¨ï¼Œè¿™æ„å‘³ç€å¤„ç†å™¨æ—¢å¯ä»¥å…·æœ‰å‘é‡å¯„å­˜å™¨çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œåˆä»…ä¼šåœ¨å‘é‡æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿä¸­æ–­æ—¶æ‰ä¼šå¸¦æ¥é¢å¤–çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚æ—©æœŸçš„å‘é‡æ¶æ„åœ¨å‘ç”Ÿä¸­æ–­æ—¶ï¼Œä¸å¾—ä¸å¿å—ä¿å­˜å’Œæ¢å¤å…¨éƒ¨å‘é‡å¯„å­˜å™¨çš„æœ€å¤§çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚</p>
</blockquote>
<h2 id="é«˜çº§ä¸“é¢˜"><a class="header" href="#é«˜çº§ä¸“é¢˜">é«˜çº§ä¸“é¢˜</a></h2>
<h3 id="cjava-ä¸-jit"><a class="header" href="#cjava-ä¸-jit">Cï¼ŒJava ä¸ Jit</a></h3>
<p>ä¸ºäº†ä¿æŒå¯ç§»æ¤æ€§å¹¶æé«˜æ‰§è¡Œé€Ÿåº¦ï¼ŒJava å‘å±•çš„ä¸‹ä¸€é˜¶æ®µç›®æ ‡ æ˜¯è®¾è®¡åœ¨ç¨‹åºè¿è¡Œæ—¶ç¿»è¯‘çš„ç¼–è¯‘å™¨ã€‚</p>
<p>è¿™æ ·çš„ <strong>å³æ—¶ç¼–è¯‘å™¨ï¼ˆJIT)</strong> é€šå¸¸ä¼šå¯¹æ­£åœ¨è¿è¡Œçš„ç¨‹åºè¿›è¡Œå‰–è§†ï¼Œä»¥æ‰¾åˆ° &quot;çƒ­ç‚¹&quot; æ–¹æ³•æ‰€åœ¨çš„ä½ç½®ï¼Œç„¶åå°†å®ƒä»¬ç¿»è¯‘æˆï¼ˆè¿è¡Œè™šæ‹Ÿæœºçš„ï¼‰å®¿ä¸»æœºå¯¹åº”çš„æŒ‡ä»¤ã€‚ç¼–è¯‘è¿‡çš„éƒ¨åˆ†å°†åœ¨ä¸‹æ¬¡è¿è¡Œç¨‹åºæ—¶ä¿å­˜ï¼Œä»¥ä¾¿æ¯æ¬¡è¿è¡Œæ—¶é€Ÿåº¦æ›´å¿«ã€‚è¿™ç§è§£é‡Šå’Œç¼–è¯‘çš„å¹³è¡¡éšç€æ—¶é—´çš„æ¨ç§»è€Œå‘å±•ï¼Œå› æ­¤ç»å¸¸è¿è¡Œçš„ Java ç¨‹åºå‡ ä¹æ²¡æœ‰è§£é‡Šçš„å¼€é”€ã€‚</p>
<p>éšç€è®¡ç®—æœºçš„é€Ÿåº¦å˜å¾—è¶Šæ¥è¶Šå¿«ï¼Œç¼–è¯‘å™¨ä¹Ÿå˜å¾—æ›´ä¸ºå¼ºå¤§ï¼Œå¹¶ä¸”éšç€ç ”ç©¶äººå‘˜å‘æ˜å‡ºæ›´ å¥½çš„åŠ¨æ€ç¼–è¯‘ Java çš„æ–¹æ³•ï¼ŒJava ä¸ C æˆ– C+ï¼‹ä¹‹é—´çš„æ€§èƒ½å·®è·æ­£åœ¨ç¼©å°ã€‚</p>
<h3 id="å…¶ä»–-ips"><a class="header" href="#å…¶ä»–-ips">å…¶ä»– IPS</a></h3>
<h3 id="æ€»ç»“-4"><a class="header" href="#æ€»ç»“-4">æ€»ç»“</a></h3>
<ol>
<li><strong>ç®€å•æºäºè§„æ•´</strong>ã€‚è§„æ•´æ€§ä½¿ RISC-V æŒ‡ä»¤ç³»ç»Ÿå…·æœ‰å¾ˆå¤šç‰¹ç‚¹ï¼šæ‰€æœ‰æŒ‡ä»¤éƒ½ä¿æŒå•ä¸€é•¿åº¦ã€ç®—æœ¯æŒ‡ä»¤ä¸­æ€»æ˜¯ä½¿ç”¨å¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°ã€æ‰€æœ‰æŒ‡ä»¤æ ¼å¼ä¸­å¯„å­˜å™¨å­—æ®µéƒ½ä¿æŒåœ¨ç›¸åŒä½ç½®ã€‚</li>
<li><strong>æ›´å°‘åˆ™æ›´å†³</strong>ã€‚å¯¹é€Ÿåº¦çš„è¦æ±‚å¯¼è‡´ RISC-V æœ‰ 32 ä¸ªå¯„å­˜å™¨è€Œä¸æ˜¯æ›´å¤šã€‚</li>
<li><strong>ä¼˜ç§€çš„è®¾è®¡éœ€è¦é€‚å½“çš„æŠ˜ä¸­</strong>ã€‚ä¸€ä¸ª RISC-V çš„ä¾‹å­æ˜¯ï¼Œåœ¨æŒ‡ä»¤ä¸­æä¾›æ›´å¤§çš„åœ°å€å’Œå¸¸ æ•°ï¼ä¸ä¿æŒæ‰€æœ‰çš„æŒ‡ä»¤å…·æœ‰ç›¸åŒçš„é•¿åº¦ä¹‹é—´çš„æŠ˜ä¸­ã€‚</li>
</ol>
<p>æ¯ç§ç±»å‹çš„ RISC-v æŒ‡ä»¤éƒ½ä¸ç¼–ç¨‹è¯­è¨€ä¸­å‡ºç°çš„ç»“æ„ç›¸å…³ï¼š</p>
<ul>
<li>ç®—æœ¯æŒ‡ä»¤å¯¹åº”äºèµ‹å€¼è¯­å¥ä¸­çš„æ“ä½œ</li>
<li>ä¼ è¾“æŒ‡ä»¤æœ€æœ‰å¯èƒ½å‘ç”Ÿåœ¨å¤„ç†æ•°ç»„æˆ–ç»“æ„ä½“ç­‰æ•°æ®ç»“æ„æ—¶ã€‚</li>
<li>æ¡ä»¶åˆ†æ”¯ç”¨äº if è¯­å¥å’Œå¾ªç¯ä¸­ã€‚</li>
<li>æ— æ¡ä»¶åˆ†æ”¯ç”¨äºè¿‡ç¨‹è°ƒç”¨å’Œè¿”å›ï¼Œä»¥åŠ case/switch è¯­å¥</li>
</ul>
<p>è¿™äº›æŒ‡ä»¤å‡ºç°é¢‘ç‡ä¸ç›¸ç­‰ï¼Œå°‘æ•°å¸¸ç”¨æŒ‡ä»¤åœ¨å¤§å¤šæ•°æŒ‡ä»¤ä¸­å ä¸»å¯¼åœ°ä½ã€‚ä¸‹å›¾å±•ç¤ºäº† SPEC CPU 2006 çš„æ¯ç±»æŒ‡ä»¤çš„å‡ºç°é¢‘ç‡ã€‚æŒ‡ä»¤çš„ä¸åŒå‡ºç°é¢‘ç‡åœ¨æ•°æ®è·¯å¾„ã€æ§åˆ¶å’Œæµæ°´çº¿ä¸­èµ·ç€é‡è¦ä½œç”¨</p>
<table><thead><tr><th>æŒ‡ä»¤ç±»åˆ«</th><th>RISC-V å®ä¾‹</th><th>å¯¹åº”çš„é«˜çº§è¯­è¨€</th><th>æ•´æ•°é¢‘ç‡</th><th>æµ®ç‚¹é¢‘ç‡</th></tr></thead><tbody>
<tr><td>ç®—æœ¯</td><td>add, sub, addi</td><td>èµ‹å€¼è¯­å¥ä¸­çš„æ“ä½œ</td><td>6%</td><td>48%</td></tr>
<tr><td>æ•°æ®ä¼ è¾“</td><td>ld, sd, lw, sw, lh, sh, lb, sb, lui</td><td>å¯¹å­˜å‚¨å™¨ä¸­æ•°æ®ç»“æ„çš„å¼•ç”¨</td><td>35%</td><td>36%</td></tr>
<tr><td>é€»è¾‘</td><td>and, or, xor, sll, srl, sra</td><td>èµ‹å€¼è¯­å¥ä¸­çš„æ“ä½œ</td><td>12%</td><td>14%</td></tr>
<tr><td>åˆ†æ”¯</td><td>beq, bne, blt, bge, bltu, bgeu</td><td>if è¯­å¥ï¼›å¾ªç¯</td><td>34%</td><td>8%</td></tr>
<tr><td>è·³è½¬</td><td>jal, jalr</td><td>è¿‡ç¨‹è°ƒç”¨&amp;è¿”å›ï¼›switch è¯­å¥</td><td>2%</td><td>0%</td></tr>
</tbody></table>
<h2 id="ç¿»è¯‘å¹¶å¯åŠ¨ç¨‹åº"><a class="header" href="#ç¿»è¯‘å¹¶å¯åŠ¨ç¨‹åº">ç¿»è¯‘å¹¶å¯åŠ¨ç¨‹åº</a></h2>
<h3 id="ç¼–è¯‘å™¨"><a class="header" href="#ç¼–è¯‘å™¨">ç¼–è¯‘å™¨</a></h3>
<p>å‡½æ•°è°ƒç”¨è¿‡ç¨‹</p>
<p>å‡½æ•°è°ƒç”¨è¿‡ç¨‹é€šå¸¸åˆ†ä¸º 6 ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>å°†å‚æ•°å­˜å‚¨åˆ°å‡½æ•°èƒ½å¤Ÿè®¿é—®åˆ°çš„ä½ç½®ï¼›</li>
<li>è·³è½¬åˆ°å‡½æ•°å¼€å§‹ä½ç½® (ä½¿ç”¨ RV32I çš„ jal æŒ‡ä»¤)ï¼›</li>
<li>è·å–å‡½æ•°éœ€è¦çš„å±€éƒ¨å­˜å‚¨èµ„æºï¼ŒæŒ‰éœ€ä¿å­˜å¯„å­˜å™¨ï¼›</li>
<li>æ‰§è¡Œå‡½æ•°ä¸­çš„æŒ‡ä»¤ï¼›</li>
<li>å°†è¿”å›å€¼å­˜å‚¨åˆ°è°ƒç”¨è€…èƒ½å¤Ÿè®¿é—®åˆ°çš„ä½ç½®ï¼Œæ¢å¤å¯„å­˜å™¨ï¼Œé‡Šæ”¾å±€éƒ¨å­˜å‚¨èµ„æºï¼›</li>
<li>è¿”å›è°ƒç”¨å‡½æ•°çš„ä½ç½® (ä½¿ç”¨ ret æŒ‡ä»¤);</li>
</ol>
<h3 id="æ±‡ç¼–å™¨"><a class="header" href="#æ±‡ç¼–å™¨">æ±‡ç¼–å™¨</a></h3>
<p>ret å®é™…ä¸Šæ˜¯ä¸€ä¸ªä¼ªæŒ‡ä»¤ï¼Œæ±‡ç¼–å™¨ä¼šç”¨ jalr x0, x1, 0 æ¥æ›¿æ¢å®ƒã€‚å¤§å¤šæ•°çš„ RISC-V ä¼ªæŒ‡ä»¤ä¾èµ–äº x0ã€‚å› æ­¤ï¼ŒæŠŠä¸€ä¸ªå¯„å­˜å™¨ç¡¬ç¼–ç ä¸º 0 ä¾¿äºå°†è®¸å¤šå¸¸ç”¨æŒ‡ä»¤â€”â€”å¦‚è·³è½¬ (jumpï¼‰ã€è¿”å› (return)ã€ç­‰äº 0 æ—¶è½¬ç§» (branch on equal to zero)â€”â€”ä½œä¸ºä¼ªæŒ‡ä»¤ï¼Œè¿›è€Œç®€åŒ– RISC-V æŒ‡ä»¤é›†ã€‚</p>
<p><img src="docs/magic/./riscv/instructions_fakes.png" alt="fakes" />
<img src="docs/magic/./riscv/instructions_fakes2.png" alt="fakes2" /></p>
<p>hello.c</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
int main() {
    printf(&quot;hello, %s\n&quot;, &quot;world&quot;);
    return 0;
}
</code></pre>
<p>hello.s</p>
<pre><code class="language-asm">    ; Directive: enter text section         æŒ‡ç¤ºç¬¦: è¿›å…¥ä»£ç æ®µ
    .text
    ; Directive: align code to 2^2 bytes    æŒ‡ç¤ºç¬¦: æŒ‰ 2^2 å­—èŠ‚å¯¹é½ä»£ç 
    .align 2
    ; Directive: declare global symbol main æŒ‡ç¤ºç¬¦: å£°æ˜å…¨å±€ç¬¦å· main
    .globl main
; label for start of main                   main çš„å¼€å§‹æ ‡è®°
main:
    ; allocate stack frame                  åˆ†é…æ ˆå¸§
    addi sp, sp, -16
    ; save return address                   å­˜å‚¨è¿”å›åœ°å€
    sw ra, 12(sp)
    ; compute address of string1            è®¡ç®— string1 çš„åœ°å€
    lui a0, %hi(string1)
    ;   string1
    addi a0, a0, %lo(string1)
    ; compute address of string2            è®¡ç®— string2 çš„åœ°å€
    lui a1, %hi(string2)
    ;   string2
    addi a1, a1, %lo(string2)
    ; call function printf                  è°ƒç”¨ printf å‡½æ•°
    call printf

    ; restore return address                æ¢å¤è¿”å›åœ°å€
    lw ra, 12(sp)
    ; deallocate stack frame                é‡Šæ”¾æ ˆå¸§
    addi sp, sp, 16
    ; load return value 0                   è¯»å–è¿”å›å€¼
    li a0, 0
    ; return                                è¿”å›
    ret

    ; Directive: enter read-only data section   æŒ‡ç¤ºç¬¦: è¿›å…¥åªè¯»æ•°æ®æ®µ
    .section .rodata
    ; Directive: align data section to 4 bytes  æŒ‡ç¤ºç¬¦: æŒ‰ 4 å­—èŠ‚å¯¹é½æ•°æ®
    .balign 4
; label for first string                        ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²æ ‡è®°
string1:
    ; Directive: null-terminated string         æŒ‡ç¤ºç¬¦: ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²
    .string &quot;Hello, %s\n&quot;
; label for second string                       ç¬¬äºŒä¸ªå­—ç¬¦ä¸²æ ‡è®°
string2:
    ; Directive: null-terminated string         æŒ‡ç¤ºç¬¦: ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²
    .string &quot;world&quot;
</code></pre>
<p>hello.o</p>
<pre><code class="language-asm">00000000 &lt;main&gt; :
 0: ff010113 addi   sp, sp, -16
 4: 00112623 sw     ra, 12(sp)
 8: 00000537 lui    a0, 0x0
 c: 00050513 mv     a0, a0
10: 000005b7 lui    a1, 0x0
14: 00058593 mv     a1, a1
18: 00000097 auipc  ra, 0x0
1c: 000080e7 jalr   ra
20: 00c12083 lw     ra, 12(sp)
24: 01010113 addi   sp, sp, 16
28: 00000513 li     a0, 0
2c: 00008067 ret
</code></pre>
<p>ä½ç½® 8 åˆ° 1c çš„è¿™å‡ æ¡æŒ‡ä»¤çš„åœ°å€ä¸º 0, å°†è¢«é“¾æ¥å™¨å¡«å……ã€‚</p>
<h2 id="ç‰¹æƒæ¶æ„"><a class="header" href="#ç‰¹æƒæ¶æ„">ç‰¹æƒæ¶æ„</a></h2>
<h3 id="ç®€ä»‹"><a class="header" href="#ç®€ä»‹">ç®€ä»‹</a></h3>
<p>ä¸ºä»€ä¹ˆéœ€è¦ç‰¹æƒæœºæ¶æ„ï¼Ÿ</p>
<ol>
<li>
<p>ç®¡ç†ï¼Œä¿æŠ¤å…±äº«èµ„æº</p>
<ul>
<li>å…±äº«èµ„æºï¼šä¾‹å¦‚å†…å­˜ï¼ŒIO è®¾å¤‡ï¼ˆéŸ³å“ï¼Œå£°å¡è¾“å‡ºï¼‰ï¼Œå¤„ç†å™¨æ ¸å¿ƒ</li>
</ul>
</li>
<li>
<p>å¯¹ä¸Šå±‚ç”¨æˆ·å±è”½ä¸‹å±‚å®ç°ç»†èŠ‚</p>
</li>
</ol>
<p>å¦‚ä½•ç®¡ç†ï¼Œä¿æŠ¤ï¼š</p>
<ul>
<li>å†…å­˜ï¼šä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€</li>
<li>IO è®¾å¤‡ï¼šä¹Ÿä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€</li>
<li>è®¿é—®æƒé™ï¼š</li>
</ul>
<p>ç‰¹æƒç­‰çº§ï¼š</p>
<ul>
<li>Mï¼šæœºå™¨ï¼ˆMachineï¼‰</li>
<li>Uï¼šç”¨æˆ·ï¼ˆç¨‹åºæ‰§è¡Œï¼‰ï¼ˆUserï¼‰</li>
<li>Sï¼šç›‘ç®¡ï¼ˆSupervisorï¼‰</li>
<li>Uï¼šè™šæ‹Ÿ</li>
</ul>
<p>ä¸åŒçš„èŠ¯ç‰‡æœ‰ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼Œæœ‰ä¸åŒçš„ä»·æ ¼ï¼Œå®ç°äº†ä¸åŒçš„ç‰¹æƒæœºåˆ«</p>
<p>ä¸¤ç§æƒé™æ¨¡å¼</p>
<ul>
<li>è¿è¡Œæœ€å¯ä¿¡çš„ä»£ç çš„æœºå™¨æ¨¡å¼ï¼ˆmachine modeï¼‰M-mode</li>
<li>ä»¥åŠä¸º Linuxï¼ŒFreeBSD å’Œ Windows ç­‰æ“ä½œç³»ç»Ÿæä¾›æ”¯æŒçš„ç›‘ç®¡è€…æ¨¡å¼ï¼ˆsupervisor modeï¼‰ã€‚</li>
</ul>
<blockquote>
<p>å¤„ç†å™¨é€šå¸¸å¤§éƒ¨åˆ†æ—¶é—´éƒ½è¿è¡Œåœ¨æƒé™æœ€ä½çš„æ¨¡å¼ä¸‹ï¼Œå¤„ç†ä¸­æ–­å’Œå¼‚å¸¸æ—¶ä¼šå°†æ§åˆ¶æƒç§»äº¤åˆ°æ›´é«˜æƒé™çš„æ¨¡å¼ã€‚</p>
</blockquote>
<h3 id="ç‰¹æƒçº§çš„ç»„åˆ"><a class="header" href="#ç‰¹æƒçº§çš„ç»„åˆ">ç‰¹æƒçº§çš„ç»„åˆ</a></h3>
<h4 id="m-mode"><a class="header" href="#m-mode">M-mode</a></h4>
<p>æœºå™¨æ¨¡å¼ï¼ˆç¼©å†™ä¸º M æ¨¡å¼ï¼ŒM-modeï¼‰æ˜¯ RISC-V ä¸­ hartï¼ˆhardware threadï¼Œç¡¬ä»¶çº¿
ç¨‹ï¼‰å¯ä»¥æ‰§è¡Œçš„æœ€é«˜æƒé™æ¨¡å¼ã€‚</p>
<ul>
<li>
<p>åœ¨ M æ¨¡å¼ä¸‹è¿è¡Œçš„ hart å¯¹å†…å­˜ï¼ŒI/O å’Œä¸€äº›å¯¹äºå¯åŠ¨å’Œé…ç½®ç³»ç»Ÿæ¥è¯´å¿…è¦çš„åº•å±‚åŠŸèƒ½æœ‰ç€å®Œå…¨çš„ä½¿ç”¨æƒã€‚</p>
</li>
<li>
<p>æ˜¯æ‰€æœ‰æ ‡å‡† RISC-V å¤„ç†å™¨éƒ½å¿…é¡»å®ç°çš„æƒé™æ¨¡å¼ã€‚å®é™…ä¸Šç®€å•çš„ RISC-V å¾®æ§åˆ¶å™¨ä»…æ”¯æŒ M æ¨¡å¼ã€‚</p>
</li>
<li>
<p>å¯ä»¥åœ¨æ²¡æœ‰å¤–éƒ¨è¾“å…¥çš„æƒ…å†µä¸‹è‡ªå·±è¿è¡Œï¼Œæ²¡æœ‰ä»€ä¹ˆå¤–éƒ¨ç½‘ç»œæ¥å…¥ï¼ˆå³ç¨‹åºåœ¨çƒ§å†™ä¹‹åä¹Ÿä¸ä¼šæ›´æ–°ï¼Œä¸Šé¢çš„ä»£ç ç»å¯¹å®‰å…¨ï¼‰ï¼Œè¿™æ—¶å°±ä¸éœ€è¦åŒºåˆ†ç‰¹æƒå°å’Œç”¨æˆ·æ€ï¼Œä»£ç è¿è¡Œåœ¨æœ€é«˜æƒé™ä¸‹ï¼Œåº”ç”¨å±‚ä»£ç å¯¹ CPU æœ‰å®Œå…¨çš„æ§åˆ¶æƒï¼Œæˆæœ¬æœ€ä½ã€‚</p>
</li>
<li>
<p>M æ€ä¹Ÿå¯ä»¥è¿è¡Œä¾‹å¦‚ FreeRTOS ä¹‹ç±»çš„æ“ä½œç³»ç»Ÿå®ç°åˆ†æ—¶å¤šä»»åŠ¡è°ƒåº¦ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰å®ç°å†…å­˜ä¿æŠ¤ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¼šè¢«åº”ç”¨ç¨‹åºæå®</p>
</li>
</ul>
<h4 id="m--u"><a class="header" href="#m--u">M + U</a></h4>
<ul>
<li>å¢åŠ äº†å†…å­˜ä¿æŠ¤ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¿è¡Œåœ¨å—ä¿æŠ¤çš„å†…å­˜æ®µé‡Œã€‚è¿è¡Œåœ¨ U æ€çš„åº”ç”¨ç¨‹åºæ— æ³•ä¿®æ”¹è¿è¡Œåœ¨ M æ€çš„æ“ä½œç³»ç»Ÿã€‚</li>
<li>å¯ä»¥æ¥å…¥ç½‘ç»œï¼Œç”šè‡³èƒ½è‡ªå·±å‡çº§</li>
<li>åº”ç”¨ç¨‹åºå‡ºé”™ä¸ä¼šå½±å“æ“ä½œç³»ç»Ÿï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å¯¹å‡ºé”™åšä¸€äº›å¤„ç†ï¼ˆå–„åå·¥ä½œï¼‰</li>
</ul>
<h4 id="m--s--u"><a class="header" href="#m--s--u">M + S + U</a></h4>
<ul>
<li>å¼•å…¥äº†é¡µè¡¨ï¼Œä»è€Œå¯ä»¥å®ç°è™šæ‹Ÿå†…å­˜ç­‰é«˜çº§åŠŸèƒ½ï¼Œå®ç°äº†å®‰å…¨ä¸Šçš„ä¿éšœã€‚</li>
</ul>
<h4 id="å¯¹æ¯”--å…¶ä»–"><a class="header" href="#å¯¹æ¯”--å…¶ä»–">å¯¹æ¯” &amp; å…¶ä»–</a></h4>
<p>ç‰¹æƒçº§ä¸ºä»€ä¹ˆä¸åœ¨æ“ä½œç³»ç»Ÿå±‚å®ç°ï¼Ÿ</p>
<ul>
<li>ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡å¤ªå¸¸ç”¨ï¼Œä¸‹æ”¾åˆ°äº†ç¡¬ä»¶</li>
<li>è½¯ä»¶æ— æ³•æ¨¡æ‹Ÿï¼ˆå¯¹å†…å­˜çš„è®¿é—®ï¼‰</li>
</ul>
<p>æ›´é«˜çº§åˆ«çš„ç‰¹æƒçº§æ›´å¼ºå¤§</p>
<ul>
<li>å¯ä»¥æ‰§è¡Œæ›´å¤šæŒ‡ä»¤</li>
<li>å¯ä»¥æ“ä½œæ›´å¤š CSRï¼ˆControl/State Registerï¼‰</li>
</ul>
<blockquote>
<p>ä¸åŒçš„ CSR åœ¨ä¸åŒçš„ç‰¹æƒçº§å¯èƒ½ä¼šæœ‰ä¸åŒçš„å‰¯æœ¬ï¼Œä¾‹å¦‚ mtvec å’Œ stvecï¼Œä¸€ä¸ªæ˜¯ M æ€ï¼Œä¸€ä¸ªæ˜¯ S æ€</p>
</blockquote>
<h4 id="å„ç‰¹æƒæ€çš„æŒ‡ä»¤"><a class="header" href="#å„ç‰¹æƒæ€çš„æŒ‡ä»¤">å„ç‰¹æƒæ€çš„æŒ‡ä»¤</a></h4>
<ol>
<li>
<p>å„ç‰¹æƒçº§éƒ½æœ‰çš„æŒ‡ä»¤</p>
<ul>
<li>
<p>ECALL</p>
<ul>
<li>å®ç°ç‰¹æƒçº§åˆ«çš„åˆ‡æ¢ï¼Œé€šå¸¸æ˜¯åœ¨ U æ€ï¼ˆç”¨æˆ·æ€ï¼‰è°ƒç”¨æ¥é™·å…¥ S æ€ï¼Œåœ¨ S æ€è°ƒç”¨é™·å…¥ M æ€ã€‚
<blockquote>
<p>ä¸è¿‡ä¸ºäº†å®ç°è¿™ç§é™·å…¥å…³ç³»ï¼Œè¿˜éœ€è¦é¢å¤–çš„é…ç½®ï¼Œè§ä¸‹æ–‡</p>
</blockquote>
</li>
<li>ECALL æ˜¯å•å‘çš„ï¼Œéœ€è¦ç”¨ SRET è¿”å›</li>
</ul>
</li>
<li>
<p>EBREAK</p>
<ul>
<li>äº§ç”Ÿæ–­ç‚¹å¼‚å¸¸ï¼Œå¯¹äºç¨‹åºè°ƒè¯•æœ‰å¸®åŠ©</li>
</ul>
</li>
<li>
<p>FENCE.L</p>
<ul>
<li>äº§ç”Ÿä¸€ä¸ªå†…å­˜è¯»å†™å±éšœ</li>
</ul>
</li>
<li>
<p>SRET</p>
<ul>
<li>ä» S æ€è¿”å› U æ€ï¼ˆåªæœ‰åœ¨æ”¯æŒåœ¨ S æ€çš„ CPU ä¸Šæ‰å¯ä»¥ï¼‰</li>
</ul>
<blockquote>
<p>è¿˜æœ‰ä¸€ä¸ª URET æŒ‡ä»¤</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>S æ€å¼•å…¥çš„æŒ‡ä»¤</p>
<ul>
<li>SFENCE.VMA
<ul>
<li>åˆ·é¡µè¡¨</li>
</ul>
</li>
</ul>
</li>
<li>
<p>M æ€å¼•å…¥çš„æŒ‡ä»¤</p>
<ul>
<li>WFI
<ul>
<li>è®©å½“å‰å¤„ç†å™¨è¿›å…¥ä¼‘çœ çŠ¶æ€</li>
</ul>
</li>
</ul>
</li>
</ol>
<h4 id="å„ç‰¹æƒæ€çš„-csr"><a class="header" href="#å„ç‰¹æƒæ€çš„-csr">å„ç‰¹æƒæ€çš„ CSR</a></h4>
<ul>
<li>CSR å¯„å­˜å™¨æœ‰ä¸€å¥—ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œè®¿é—® CSR éœ€è¦ä½¿ç”¨ä¸“æœ‰æŒ‡ä»¤</li>
<li>æ¯ä¸€ä¸ªå¤„ç†å™¨æ ¸å¿ƒéƒ½æœ‰è‡ªå·±çš„ä¸€å¥—ç‹¬ç«‹çš„ 4K CSRï¼Œå‡åˆ†ç»™äº† 4 å„ç‰¹æƒæ€ï¼Œå¯¹äºæ¯ä¸€ä¸ªç‰¹æƒæ€ï¼Œæœ€å¤šæœ‰ 1024 ä¸ª CSR å¯„å­˜å™¨å¯ä»¥ä½¿ç”¨ã€‚</li>
<li>è®¿é—®æ²¡æœ‰æƒé™çš„ï¼Œä¸å­˜åœ¨çš„ï¼Œå†™åªè¯»çš„ CSR éƒ½ä¼š Trapã€‚</li>
</ul>
<p>RISC-V åªåˆ†é…äº† 4K çš„åœ°å€ç©ºé—´ç»™ CSRï¼Œè¿™ 4K ç©ºé—´çš„ç¬¬ <code>[9:8]</code> ä¸¤ä¸ª bit è¡¨ç¤ºäº† CSR è¾“å…¥é‚£ä¸ªç‰¹æƒçº§</p>
<h3 id="å†…å­˜åœ°å€ç¿»è¯‘è™šæ‹Ÿå†…å­˜"><a class="header" href="#å†…å­˜åœ°å€ç¿»è¯‘è™šæ‹Ÿå†…å­˜">å†…å­˜åœ°å€ç¿»è¯‘ï¼šè™šæ‹Ÿå†…å­˜</a></h3>
<ul>
<li>åœ¨ RISC-V ä¸‹ï¼Œé¡µè¡¨æœ€å°ä¸º 4K</li>
<li>æœ‰å¤šç§åœ°å€æ˜ å°„æ–¹å¼ï¼ˆå¦‚ Sv32, Sv39, Sv48, å®ƒä»¬çš„è™šæ‹Ÿåœ°å€çš„ä½å®½ä¸åŒï¼Œæœ€å¤§å¯»å€èŒƒå›´ä¹Ÿä¸åŒï¼‰</li>
<li>å·¨é¡µï¼</li>
</ul>
<h4 id="é¡µè¡¨é¡¹ç»“æ„"><a class="header" href="#é¡µè¡¨é¡¹ç»“æ„">é¡µè¡¨é¡¹ç»“æ„</a></h4>
<p>ä¸€ä¸ª RV32 Sv32 é¡µè¡¨é¡¹</p>
<pre><code class="language-txt">|32    20|19    10|9   8|7|6|5|4|3|2|1|0|
| PPN[1] | PPN[0] | RSW |D|A|G|U|X|W|R|V|
</code></pre>
<p>ä¸€ä¸ª RV32 Sv39 é¡µè¡¨é¡¹</p>
<pre><code class="language-txt">|63      54|53    28|27    19|18    10|9   8|7|6|5|4|3|2|1|0|
| Reserved | PPN[2] | PPN[1] | PPN[0] | RSW |D|A|G|U|X|W|R|V|
</code></pre>
<ul>
<li>
<p>V: å…¶ä»–ä½æ˜¯å¦æœ‰æ•ˆï¼ˆV=1 æœ‰æ•ˆï¼‰ï¼Œå¦‚æœ V = 0ï¼Œåˆ™ä¾¿åˆ©åˆ°è¯¥é¡µè¡¨çš„ä¼šç›´æ¥äº§ç”Ÿé”™è¯¯</p>
</li>
<li>
<p>R | W | Xï¼šå¯è¯»å¯å†™å¯æ‰§è¡Œã€‚å¦‚æœéƒ½æ˜¯ 0ï¼Œåˆ™è¿™ä¸ªé¡µè¡¨é¡¹æ˜¯æŒ‡å‘ä¸‹ä¸€çº§é¡µè¡¨çš„æŒ‡é’ˆï¼Œå¦åˆ™å®ƒæ˜¯é¡µè¡¨æ ‘çš„ä¸€ä¸ªé¡µèŠ‚ç‚¹</p>
</li>
<li>
<p>Uï¼šæ˜¯å¦ä¸ºç”¨æˆ·ç•Œé¢ã€‚å¦‚æœ U = 0ï¼Œåˆ™ U æ¨¡å¼ä¸èƒ½è®¿é—®ï¼Œä½† S å¯ä»¥ï¼Œå¦‚æœ U = 1ï¼Œåˆ™ U æ¨¡å¼å¯ä»¥è®¿é—®ï¼Œä½† S ä¸å¯ä»¥ã€‚å¯¹äºäº‘æœåŠ¡ï¼Œç”¨æˆ·æ•°æ®å®‰å…¨ä¹Ÿå¾ˆé‡è¦ï¼Œç”¨æˆ·çš„ç§æœ‰æ•°æ®ä¹Ÿä¸æ˜¯æ“ä½œç³»ç»Ÿå¯ä»¥éšä¾¿è®¿é—®çš„ã€‚</p>
</li>
<li>
<p>Gï¼šè¿™ä¸ªæ˜ å°„æ˜¯å¦å¯¹æ‰€æœ‰è™šæ‹Ÿå†…å­˜éƒ½æœ‰æ•ˆï¼Œç¡¬ä»¶æ ¹æ®å®ƒæé«˜åœ°å€è½¬æ¢æ€§èƒ½</p>
</li>
<li>
<p>Aï¼šæ˜¯å¦è¢«è®¿é—®è¿‡ï¼ˆä»ä¸Šæ¬¡æ¸…é™¤å¼€å§‹ï¼‰</p>
</li>
<li>
<p>Dï¼šæ˜¯å¦è¢«å†™å…¥è¿‡ï¼ˆä»ä¸Šæ¬¡æ¸…é™¤å¼€å§‹ï¼‰</p>
</li>
</ul>
<blockquote>
<p>A å’Œ D å¯ä»¥ç”¨æ¥åˆ¤æ–­ç¼ºé¡µï¼Œmmap æ–‡ä»¶æ˜ å°„åˆ°åœ°å€ï¼Œåˆ¤æ–­æ˜¯å¦è¦åŠ è½½ï¼Œæ˜¯å¦è¦åˆ·æ–°</p>
</blockquote>
<ul>
<li>RSWï¼šç•™ç»™æ“ä½œç³»ç»Ÿä½¿ç”¨ï¼Œä¼šè¢«ç¡¬ä»¶å¿½ç•¥</li>
<li>PPN:åŒ…å«ç‰©ç†é¡µå·ï¼Œæ˜¯ç‰©ç†åœ°å€çš„ä¸€éƒ¨åˆ†ã€‚
<ul>
<li>è‹¥è¿™ä¸ªé¡µè¡¨æ˜¯ä¸€ä¸ªé¡µèŠ‚ç‚¹ï¼Œåˆ™ PPN æ˜¯è½¬æ¢åç‰©ç†åœ°å€çš„ä¸€éƒ¨åˆ†</li>
<li>å¦åˆ™ï¼Œæ˜¯ä¸‹ä¸€ä¸ªé¡µè¡¨çš„åœ°å€</li>
</ul>
</li>
</ul>
<h4 id="å†…å­˜å±éšœ"><a class="header" href="#å†…å­˜å±éšœ">å†…å­˜å±éšœ</a></h4>
<p>S æ€å”¯ä¸€å¼•å…¥çš„æŒ‡ä»¤ï¼šSFENCE.VMA</p>
<p>åªä¼šåˆ·æ–°å½“å‰å¤„ç†å™¨çš„å¿«è¡¨ï¼ˆé¡µè¡¨ç¼“å­˜ï¼‰ï¼Œå¦‚æœæ˜¯å¤šæ ¸ç¯å¢ƒï¼Œè¿˜éœ€è¦æ ¸é—´é€šä¿¡åŒæ­¥åˆ·æ–°å…¶ä»–æ ¸å¿ƒçš„é¡µè¡¨ç¼“å­˜</p>
<h4 id="å†…å­˜ä¿æŠ¤"><a class="header" href="#å†…å­˜ä¿æŠ¤">å†…å­˜ä¿æŠ¤</a></h4>
<p>æœ‰ä¸¤ç§æœºåˆ¶</p>
<ul>
<li>å¦‚æœå¤„ç†å™¨æ”¯æŒï¼Œå¹¶ä¸”å¼€å¯äº†å†…å­˜åœ°å€è½¬æ¢ï¼ˆä¹Ÿå°±åˆ©ç”¨äº†é¡µè¡¨ï¼‰ï¼Œå°±å¯ä»¥é€šè¿‡é¡µè¡¨é‡Œçš„æƒé™ä½æ§åˆ¶æ¯ä¸ªå†…å­˜é¡µçš„è®¿é—®</li>
<li>å¦‚æœä¸æ”¯æŒ S æ€ï¼Œå¯ä»¥é€šè¿‡ PMPï¼ˆç‰©ç†å†…å­˜ä¿æŠ¤å•å…ƒï¼‰ã€‚ç²’åº¦å¤§ï¼Œä¿æŠ¤åŒºåŸŸå°</li>
<li>è™šæ‹Ÿå†…å­˜ä¼˜å…ˆäº PMP</li>
</ul>
<h3 id="ä¸­æ–­ä¸å¼‚å¸¸"><a class="header" href="#ä¸­æ–­ä¸å¼‚å¸¸">ä¸­æ–­ä¸å¼‚å¸¸</a></h3>
<p>æœºå™¨æ¨¡å¼æœ€é‡è¦çš„ç‰¹æ€§æ˜¯æ‹¦æˆªå’Œå¤„ç†å¼‚å¸¸ï¼ˆä¸å¯»å¸¸çš„è¿è¡Œæ—¶äº‹ä»¶ï¼‰çš„èƒ½åŠ›ã€‚</p>
<p>RISC-V å°†å¼‚å¸¸åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>
<p>ï¼ˆåŒæ­¥ï¼‰å¼‚å¸¸</p>
<ul>
<li>åŒæ­¥äº‹ä»¶</li>
<li>å‘ç”ŸåŸå› æ˜ç¡®ï¼Œç”±å…·ä½“çš„æŸä¸€æ¡æŒ‡ä»¤å¯¼è‡´ã€‚è¿™ç±»å¼‚å¸¸åœ¨æŒ‡ä»¤æ‰§è¡ŒæœŸé—´äº§ç”Ÿï¼Œå¦‚è®¿é—®äº†æ— æ•ˆçš„å­˜å‚¨å™¨åœ°å€æˆ–æ‰§è¡Œäº†å…·æœ‰æ— æ•ˆæ“ä½œç çš„æŒ‡ä»¤æ—¶ã€‚</li>
</ul>
</li>
<li>
<p>ä¸­æ–­ã€‚</p>
<ul>
<li>å¼‚æ­¥äº‹ä»¶ã€‚å®ƒæ˜¯ä¸æŒ‡ä»¤æµå¼‚æ­¥çš„å¤–éƒ¨äº‹ä»¶ï¼Œæ¯”å¦‚é¼ æ ‡çš„å•å‡»ã€‚</li>
<li>æœ‰ä¸‰ç§æ ‡å‡†çš„ä¸­æ–­æºï¼šè½¯ä»¶ã€æ—¶é’Ÿå’Œå¤–éƒ¨æ¥æºã€‚è½¯ä»¶ä¸­æ–­é€šè¿‡å‘å†…å­˜æ˜ å°„å¯„å­˜å™¨ä¸­å­˜æ•°æ¥è§¦å‘</li>
</ul>
</li>
<li>
<p>ä¸­æ–­å’Œå¼‚å¸¸çš„å¤„ç†æµç¨‹å‡ ä¹æ˜¯ä¸€æ ·çš„</p>
</li>
</ul>
<h3 id="å’Œäº‹ä»¶å¤„ç†æœ‰å…³çš„-csr"><a class="header" href="#å’Œäº‹ä»¶å¤„ç†æœ‰å…³çš„-csr">å’Œäº‹ä»¶å¤„ç†æœ‰å…³çš„ CSR</a></h3>
<p>ï¼ˆè¯´äº‹ä»¶æ˜¯å› ä¸ºå®ƒä»¬å¼‚å¸¸å’Œä¸­æ–­éƒ½èƒ½å¤„ç†ï¼‰</p>
<ul>
<li>
<p>stvec, mtved(Trap-Vector Base-Address Register)</p>
<ul>
<li>
<p>è®¾ç½®äº‹ä»¶å¤„ç†å‡½æ•°çš„åœ°å€ï¼Œäº‹ä»¶å‘ç”Ÿåä¼šè·³è½¬åˆ°è¿™é‡Œå¹¶æ‰§è¡Œå¯¹åº”çš„å¤„ç†å‡½æ•°</p>
</li>
<li>
<p>è·³è½¬ç­–ç•¥æœ‰ä¸¤ç§</p>
<ul>
<li>æ— è®ºå‘ç”Ÿä»€ä¹ˆæ—¶é—´ï¼Œéƒ½è·³åˆ°åŒä¸€ä¸ªå›ºå®šçš„ä½ç½®æ‰§è¡Œå¤„ç†å‡½æ•°</li>
</ul>
<blockquote>
<p>ç„¶åå†åˆ†å‘ï¼Œè™½ç„¶æ€§èƒ½ä½ï¼Œä½†æ˜¯ä»£ç çµæ´»</p>
</blockquote>
<ul>
<li>é€šè¿‡å‘é‡è¡¨ï¼Œæ ¹æ®äº‹ä»¶ç¼–å·è·³åˆ°ä¸åŒçš„åœ°å€ã€‚</li>
</ul>
<blockquote>
<p>é€šå¸¸ç¬¬äºŒç§çš„è·³è½¬æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯é€»è¾‘æ­»æ¿</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>medelegï¼Œmidelegï¼ˆTrap Delegation Register)</p>
<ul>
<li>å†³å®šå‘ç”Ÿäº‹ä»¶æ—¶è·³åˆ°é‚£ä¸ªç‰¹æƒçº§</li>
</ul>
</li>
<li>
<p>scauseï¼Œmcauseï¼ˆCause Registerï¼‰</p>
<ul>
<li>å­˜å‚¨æ—¶é—´å‘ç”ŸåŸå› çš„ IDï¼Œæœ€é«˜ä½æ˜¯ 1 è¡¨ç¤ºä¸­æ–­ï¼Œæœ€é«˜ä½ 0 è¡¨ç¤ºå¼‚å¸¸ã€‚</li>
</ul>
</li>
<li>
<p>stvalï¼Œmtvalï¼ˆTrap Value Registerï¼‰</p>
<ul>
<li>å­˜å‚¨å’Œäº‹ä»¶ç›¸å…³çš„å¤–éƒ¨ä¿¡æ¯ï¼Œä¾‹å¦‚éæ³•åœ°å€ï¼Œéæ³•æ“ä½œæ•°ï¼Œ</li>
</ul>
</li>
<li>
<p>sepcï¼Œsstatusï¼ˆException Program Registerï¼‰</p>
<ul>
<li>è®°å½•ä»é«˜ç‰¹æƒçº§åˆ«è¿”å›ä½ç‰¹æƒçº§æ—¶ï¼Œè¦è¿”å›åˆ°çš„åœ°å€</li>
</ul>
</li>
<li>
<p>mstatusï¼Œsstatusï¼ˆStatus Registerï¼‰</p>
<ul>
<li>è®°å½•ä¸€äº›å¸¸ç”¨çš„æ ‡å¿—ä½</li>
</ul>
</li>
</ul>
<h3 id="trap-çš„ä»£ç†æœºåˆ¶"><a class="header" href="#trap-çš„ä»£ç†æœºåˆ¶">Trap çš„ä»£ç†æœºåˆ¶</a></h3>
<p>é€šå¸¸äº‹ä»¶å‘ç”Ÿå°±ä¼šç›´æ¥è·³è½¬åˆ° M æ€ï¼Œä½†æ˜¯æ²¡å¿…è¦ã€‚</p>
<p>ä¸€èˆ¬æ˜¯ <code>U -&gt; S -&gt; M</code></p>
<p>ç›´æ¥è°ƒç”¨ ECALL ä¼šæ— æ¡ä»¶è·³è½¬åˆ° M æ€ï¼Œé€šè¿‡è®¾ç½® medeleg å’Œ mideleg èƒ½å¤Ÿå®ç°åœ¨ U æ€æ‰§è¡Œ ECALL è·³è½¬åˆ° S æ€ï¼Œåœ¨ S æ€æ‰§è¡Œ ECALL ä¼šè·³è½¬åˆ° M æ€ã€‚</p>
<h3 id="å¼‚å¸¸"><a class="header" href="#å¼‚å¸¸">å¼‚å¸¸</a></h3>
<p>RISC-V ä¸­å®ç°ç²¾ç¡®ä¾‹å¤–ï¼šä¿è¯å¼‚å¸¸ä¹‹å‰çš„æ‰€æœ‰æŒ‡ä»¤éƒ½å®Œæ•´åœ°æ‰§è¡Œäº†ï¼Œè€Œåç»­çš„æŒ‡ä»¤éƒ½æ²¡æœ‰å¼€å§‹æ‰§è¡Œï¼ˆæˆ–ç­‰åŒäºæ²¡æœ‰æ‰§è¡Œï¼‰ã€‚</p>
<p>åœ¨ M æ¨¡å¼è¿è¡ŒæœŸé—´å¯èƒ½å‘ç”Ÿçš„åŒæ­¥ä¾‹å¤–æœ‰äº”ç§ï¼š</p>
<ul>
<li>è®¿é—®é”™è¯¯å¼‚å¸¸ï¼šå½“ç‰©ç†å†…å­˜çš„åœ°å€ä¸æ”¯æŒè®¿é—®ç±»å‹æ—¶å‘ç”Ÿï¼ˆä¾‹å¦‚å°è¯•å†™å…¥ ROMï¼‰ã€‚</li>
<li>æ–­ç‚¹å¼‚å¸¸ï¼šåœ¨æ‰§è¡Œ <code>ebreak</code> æŒ‡ä»¤ï¼Œæˆ–è€…åœ°å€æˆ–æ•°æ®ä¸è°ƒè¯•è§¦å‘å™¨åŒ¹é…æ—¶å‘ç”Ÿã€‚</li>
<li>ç¯å¢ƒè°ƒç”¨å¼‚å¸¸ï¼šåœ¨æ‰§è¡Œ <code>ecall</code> æŒ‡ä»¤æ—¶å‘ç”Ÿã€‚</li>
<li>éæ³•æŒ‡ä»¤å¼‚å¸¸ï¼šåœ¨è¯‘ç é˜¶æ®µå‘ç°æ— æ•ˆæ“ä½œç æ—¶å‘ç”Ÿã€‚</li>
<li>éå¯¹é½åœ°å€å¼‚å¸¸ï¼šåœ¨æœ‰æ•ˆåœ°å€ä¸èƒ½è¢«è®¿é—®å¤§å°æ•´é™¤æ—¶å‘ç”Ÿï¼Œä¾‹å¦‚åœ°å€ä¸º 0x12 çš„ <code>amoadd.w</code>.</li>
</ul>
<p>ä¸åŒçš„å¼‚å¸¸å¯¹åº”ä¸åŒçš„æ“ä½œç </p>
<h3 id="æœºå™¨æ¨¡å¼ä¸‹çš„å¼‚å¸¸å¤„ç†"><a class="header" href="#æœºå™¨æ¨¡å¼ä¸‹çš„å¼‚å¸¸å¤„ç†">æœºå™¨æ¨¡å¼ä¸‹çš„å¼‚å¸¸å¤„ç†</a></h3>
<p>å…«ä¸ªæ§åˆ¶çŠ¶æ€å¯„å­˜å™¨ï¼ˆCSRï¼‰æ˜¯æœºå™¨æ¨¡å¼ä¸‹å¼‚å¸¸å¤„ç†çš„å¿…è¦éƒ¨åˆ†ï¼š</p>
<ul>
<li>mtvecï¼ˆMachine Trap Vectorï¼‰å®ƒä¿å­˜å‘ç”Ÿå¼‚å¸¸æ—¶å¤„ç†å™¨éœ€è¦è·³è½¬åˆ°çš„åœ°å€ã€‚</li>
<li>mepcï¼ˆMachine Exception PCï¼‰å®ƒæŒ‡å‘å‘ç”Ÿå¼‚å¸¸çš„æŒ‡ä»¤ã€‚</li>
<li>mcauseï¼ˆMachine Exception Causeï¼‰å®ƒæŒ‡ç¤ºå‘ç”Ÿå¼‚å¸¸çš„ç§ç±»ã€‚</li>
<li>mieï¼ˆMachine Interrupt Enableï¼‰å®ƒæŒ‡å‡ºå¤„ç†å™¨ç›®å‰èƒ½å¤„ç†å’Œå¿…é¡»å¿½ç•¥çš„ä¸­æ–­ã€‚</li>
<li>mipï¼ˆMachine Interrupt Pendingï¼‰å®ƒåˆ—å‡ºç›®å‰æ­£å‡†å¤‡å¤„ç†çš„ä¸­æ–­ã€‚</li>
<li>mtvalï¼ˆMachine Trap Valueï¼‰å®ƒä¿å­˜äº†é™·å…¥ï¼ˆtrapï¼‰çš„é™„åŠ ä¿¡æ¯ï¼šåœ°å€ä¾‹å¤–ä¸­å‡ºé”™
çš„åœ°å€ã€å‘ç”Ÿéæ³•æŒ‡ä»¤ä¾‹å¤–çš„æŒ‡ä»¤æœ¬èº«ï¼Œå¯¹äºå…¶ä»–å¼‚å¸¸ï¼Œå®ƒçš„å€¼ä¸º 0ã€‚</li>
<li>mscratchï¼ˆMachine Scratchï¼‰å®ƒæš‚æ—¶å­˜æ”¾ä¸€ä¸ªå­—å¤§å°çš„æ•°æ®ã€‚</li>
<li>mstatusï¼ˆMachine Statusï¼‰å®ƒä¿å­˜å…¨å±€ä¸­æ–­ä½¿èƒ½ï¼Œä»¥åŠè®¸å¤šå…¶ä»–çš„çŠ¶æ€</li>
</ul>
<h2 id="é¡µè¡¨"><a class="header" href="#é¡µè¡¨">é¡µè¡¨</a></h2>
<ul>
<li>åŠ¨æ€çš„ç”³è¯·å†…å­˜</li>
<li>è™šæ‹Ÿå†…å­˜ç©ºæ´</li>
<li>è™šæ‹Ÿå†…å­˜åœ°å€ï¼ˆVAï¼‰ï¼Œç‰©ç†åœ°å€ï¼ˆPAï¼‰</li>
</ul>
<pre><code class="language-txt">| VA | PA | Size |
|    |    |      |
</code></pre>
<p>é¡µè¡¨æ²¡æœ‰å­˜åœ¨ PCB ä¸­ï¼Œä½äºä¸€å—å•ç‹¬çš„å†…å­˜ä¸­ã€‚PCK æ˜¯ä¸€ä¸ªç›¸å¯¹ç´§å‡‘çš„ç»“æ„ï¼Œé‡Œé¢å­˜å‚¨äº†è¿›ç¨‹çš„çŠ¶æ€ï¼Œé‡Œé¢å­˜å‚¨äº†é¡µè¡¨çš„æŒ‡é’ˆã€‚å½“ CPU åˆ‡æ¢è¿›ç¨‹æ—¶ï¼Œè¿˜éœ€è¦åŒæ—¶åˆ‡æ¢é¡µè¡¨ã€‚</p>
<p>å¦‚ä½•ä¼˜åŒ– VA åˆ° PA çš„è½¬æ¢ï¼š</p>
<ul>
<li>è®©ç¡¬ä»¶è‡ªåŠ¨å®ŒæˆæŸ¥è¡¨å’Œè½¬æ¢</li>
<li>ä¼˜åŒ–åˆ—è¡¨çš„å­˜å‚¨æ•°æ®ç»“æ„ï¼ŒåŠ å¿«æŸ¥æ‰¾ã€‚</li>
</ul>
<p>ä¸¤ç§æ–¹æ¡ˆé€‰æ‹©å“ªä¸ªå‘¢ï¼Ÿå½“ç„¶æ˜¯ä¸¤è€…éƒ½è¦ \dogeã€‚</p>
<h3 id="ç¡¬ä»¶æŸ¥è¡¨"><a class="header" href="#ç¡¬ä»¶æŸ¥è¡¨">ç¡¬ä»¶æŸ¥è¡¨</a></h3>
<p>å¼•å…¥äº†ä¸€ä¸ª MMU çš„ç¡¬ä»¶ç”µè·¯æ¥å®ç°ã€‚ä¸ºäº†è®© MMU ä¹Ÿèƒ½æŸ¥çš„æ›´å¿«ï¼Œä¹Ÿéœ€è¦ç»™ MMU æä¾›ä¸€ç§æ›´åŠ ä¼˜åŒ–çš„æ•°æ®ç»“æ„ã€‚</p>
<p>TLB æ˜¯ MLU çš„ä¸€ä¸ªå­ç”µè·¯ï¼ŒåŒ…å«äº†é¡µè¡¨ç¼“å­˜ï¼ŒTLB å¯ä»¥å®ç°çš„å¾ˆå¤æ‚ï¼Œä¾‹å¦‚ç”¨ç¡¬ä»¶ç”µè·¯å®ç°çš„ å“ˆå¸Œè¡¨ï¼ŒLRU ç®—æ³•ç­‰ã€‚</p>
<p>å½“åˆ‡æ¢è¿›ç¨‹æ—¶ï¼ŒTLB ä¹Ÿéœ€è¦è¢«æ¸…ç©ºå—ï¼Ÿ</p>
<p>TLB å¦‚æœè¶³å¤Ÿå¤æ‚çš„è¯ï¼Œå®ƒé‡Œé¢å¯ä»¥è®¾ç½®è¿›ç¨‹çš„æ ‡å¿—ä½ï¼Œä¸åŒçš„åŒºå—å­˜å‚¨ä¸åŒè¿›ç¨‹çš„é¡µè¡¨ç¼“å­˜</p>
<h3 id="ä¼˜åŒ–å­˜å‚¨æ•°æ®ç»“æ„"><a class="header" href="#ä¼˜åŒ–å­˜å‚¨æ•°æ®ç»“æ„">ä¼˜åŒ–å­˜å‚¨æ•°æ®ç»“æ„</a></h3>
<p>å†…å­˜åœ°å€è½¬æ¢çš„æœ€å°å•ä½æ˜¯ä»€ä¹ˆï¼Œæˆ–è€…è¯´ Size ä¸€åˆ—æœ€å°æ˜¯å¤šå°‘ã€‚
å‡å¦‚ä»¥ 1 å­—èŠ‚ä¸ºå•ä½è¿›è¡Œæ˜ å°„ï¼Œé‚£ä¹ˆæ˜ å°„ä»¥å­—èŠ‚å°±éœ€è¦å­˜å‚¨ VA, PA, Size ä¸€å…± <code>3 * 4 = 12</code> å­—èŠ‚ï¼Œå±äºæ˜¯æœ¬æœ«å€’ç½®äº†ã€‚</p>
<p>ä»è€Œå‡ºç°äº†é¡µçš„æ¦‚å¿µã€‚é€šå¸¸æ¯ä¸ªé¡µçš„å¤§å°ä¸º 4KBï¼Œè¶…è¿‡ 4KB çš„è¢«ç§°ä¸ºå·¨é¡µã€‚æœ€å°çš„æ˜ å°„å•å…ƒå°±æ˜¯é¡µã€‚</p>
<p>æˆ‘ä»¬æŠŠä¸Šé¢ VA åˆ° PA çš„æ˜ å°„å«åšé¡µè¡¨ï¼Œé¡µè¡¨é‡Œçš„æ¯ä¸€è¡Œæ˜ å°„å…³ç³»è¢«ç§°ä¸ºé¡µè¡¨é¡¹ã€‚</p>
<h4 id="æš´åŠ›å­˜å‚¨"><a class="header" href="#æš´åŠ›å­˜å‚¨">æš´åŠ›å­˜å‚¨</a></h4>
<p>æŒ‰ç…§ VA ä»å°åˆ°å¤§æ’åºï¼Œæ£€ç´¢æ—¶äºŒåˆ†æŸ¥æ‰¾ï¼Œå¤æ‚åº¦ O(logN)</p>
<h4 id="é¡µè¡¨å­˜å‚¨"><a class="header" href="#é¡µè¡¨å­˜å‚¨">é¡µè¡¨å­˜å‚¨</a></h4>
<p>é™åˆ¶ Size åªèƒ½æ˜¯ 4KBï¼Œä¸€æ¬¡æ€§æŠŠæ•´ä¸ªè™šæ‹Ÿç©ºé—´å»ºç«‹å¥½æ˜ å°„å…³ç³»</p>
<ul>
<li>Size åˆ—å¯ä»¥å»é™¤</li>
<li>æ’åºè‡ªç„¶æ˜¯æ’å¥½çš„</li>
<li>å¤æ‚åº¦ä¸º O(1)ï¼Œç›´æ¥é™¤ 4096</li>
<li>æ˜ å°„è¡¨çš„ VA åˆ—ä¹Ÿä¸éœ€è¦äº†ï¼Œä»–å¯ä»¥ç”¨æ•°ç»„ä¸‹æ ‡è¡¨ç¤º</li>
</ul>
<p>ä»¥ 32 ä½æœºå™¨ä¸ºä¾‹ï¼Œ4GB çš„ VAï¼Œä¸€å…±åŒ…å«äº† 1M ä¸ª 4KB é¡µã€‚ç­‰äºè¦ç”³è¯·ä¸€ä¸ªé•¿åº¦ä¸º <code>1M = 1024 * 1024</code> çš„å¤§æ•°ç»„ï¼Œæ¯ä¸ªæ•°ç»„å…ƒç´ æ˜¯ PAï¼Œå  32bitï¼Œæ‰€ä»¥æ•´ä¸ªé¡µè¡¨å  <code>1M * 4B = 4MB</code></p>
<p>ç¼ºç‚¹</p>
<ul>
<li>ä¸Šé¢çš„æ˜¯ Sv32ï¼Œå¯¹äº Sv39ï¼Œæ¯ä¸ªè¿›ç¨‹å°±è¦åˆ†é… 512MB å†…å­˜ï¼Œ10 ä¸ªè¿›ç¨‹å°±æ˜¯ 5GB</li>
<li>é¡µè¡¨åˆ©ç”¨ç‡ä½ï¼Ÿ</li>
</ul>
<h4 id="å¤šçº§é¡µè¡¨"><a class="header" href="#å¤šçº§é¡µè¡¨">å¤šçº§é¡µè¡¨</a></h4>
<p>ä¸æ˜¯å¤šæœ‰çš„è¿›ç¨‹éƒ½ä¼šä½¿ç”¨å®Œæ•´çš„å†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´é‡Œæœ‰å¾ˆå¤šçš„ç©ºæ´ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠè¿›ç¨‹ç”¨åˆ°çš„ VA åšæ˜ å°„ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨çš„çš„ç›®çš„æ˜¯ä¼˜åŒ–å¦‚ä½•å­˜å‚¨ä¸€ä¸ªéå¸¸ç¨€ç–çš„æ•°ç»„ã€‚</p>
<p>åœ°å€æ˜¯ä¸€ä¸ªæ•°ï¼Œ<strong>è¶Šé«˜ä½è¡¨ç¤ºçš„èŒƒå›´å°±è¶Šå¤§</strong>ï¼Œè¿™æ˜¯ä¸€ç§ç¼–ç çš„æ€è·¯ã€‚</p>
<p>å…·ä½“åˆ°é¡µè¡¨ä¸Šï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠ 32 å„æ¯”ç‰¹ä½åˆ’åˆ†ä¸º <code>10 + 10 + 12</code> ä¸‰æ®µï¼Œå®ç°å¤šçº§é¡µè¡¨ã€‚å‰åä½æŒ‡å‘ä¸€çº§é¡µè¡¨ï¼Œä¸­é—´ 10 ä½æŒ‡å‘äºŒçº§é¡µè¡¨ï¼Œæœ€å 10 ä½æŒ‡å‘ç‰©ç†åœ°å€ã€‚</p>
<p>å¼‚åŒï¼š</p>
<ul>
<li>éœ€è¦æŸ¥ä¸¤æ¬¡è¡¨ï¼Œä½†æ˜¯ä»æ—¶é—´å¤æ‚åº¦ä¸Šæ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¸æ•°çº§åˆ«çš„æ“ä½œï¼Œä»ç„¶æ˜¯ O(1)</li>
<li>ç”±äºæ„é€ çš„æ˜¯æ ‘å½¢ç»“æ„ï¼Œåˆšå¼€å§‹åªéœ€è¦å­˜å‚¨æ ‘æ ¹ï¼ŒæŸäº›äºŒçº§é¡µè¡¨çš„ VA ä»æ¥æ²¡æœ‰è¢«ä½¿ç”¨è¿‡ï¼Œæ‰€ä»¥è¿™ä¸€éƒ¨åˆ†å¯¹åº”çš„çš„äºŒçº§é¡µè¡¨å°±ä¸ç”¨å­˜å‚¨ã€‚éœ€è¦æ—¶éšä¾¿æ‰¾åˆ°ä¸€å— 4KB çš„ç©ºé—´å°±è¡Œï¼Œå…·æœ‰é«˜æ•ˆçš„æ’å…¥å’Œåˆ é™¤ã€‚</li>
</ul>
<h4 id="risc-v-ä¸­çš„å®ç°"><a class="header" href="#risc-v-ä¸­çš„å®ç°">RISC-V ä¸­çš„å®ç°</a></h4>
<p>Sv32ï¼ŒSv39ï¼ŒSv48 å„ç§é¡µè¡¨éƒ½æœ‰ä¸åŒçš„åˆ’åˆ†</p>
<p>RISC-V 32 å®é™…ä¸Šæœ‰ 34 ä½ 12 + 10 + 12ã€‚èŠ¯ç‰‡å¼•ç”¨åˆ° 16 GB çš„å†…å­˜ï¼Œä½†æ˜¯è¿›ç¨‹ä¾ç„¶åªèƒ½è®¿é—® 4GB çš„ç©ºé—´ã€‚</p>
<p>ä¸€çº§ã€äºŒçº§é¡µè¡¨æœ¬èº«çš„åœ°ä½éƒ½ä¸º 0ï¼Œè¿™äº›ä½è¢«æ‹¿æ¥åšå…¶ä»–äº‹äº†ï¼Œæä¾›äº†æ›´ä¸°å¯Œçš„åŠŸèƒ½ï¼Œä¸åªæ˜¯åœ°å€æ˜ å°„ï¼Œå…·ä½“è§ <a href="docs/magic/riscv.html#%E9%A1%B5%E8%A1%A8%E9%A1%B9%E7%BB%93%E6%9E%84">é¡µè¡¨é¡¹ç»“æ„</a>ã€‚</p>
<h4 id="å¦‚ä½•åœ¨å¤šè¿›ç¨‹é—´åˆ‡æ¢é¡µè¡¨"><a class="header" href="#å¦‚ä½•åœ¨å¤šè¿›ç¨‹é—´åˆ‡æ¢é¡µè¡¨">å¦‚ä½•åœ¨å¤šè¿›ç¨‹é—´åˆ‡æ¢é¡µè¡¨ï¼Ÿ</a></h4>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ï¼Œæ¯ä¸ªé¡µè¡¨éƒ½æ˜¯ä¸€æ£µæ ‘ï¼Œéƒ½æœ‰ä¸€ä¸ªæ ‘æ ¹ï¼Œè¿™ä¸ªæ ‘æ ¹ä¹Ÿæ˜¯ä¸€ä¸ªå¤§å°ä¸º 4KB çš„å†…å­˜åŒºåŸŸï¼Œåªè¦æˆ‘ä»¬èƒ½å¤ŸçŸ¥é“è¿™ä¸ªåŒºåŸŸï¼ˆæ ‘æ ¹ï¼‰çš„é¦–åœ°å€ï¼Œå°±ç›¸å½“äºçŸ¥é“äº†æ•´ä¸ªé¡µè¡¨</p>
<p>æ‰€ä»¥åœ¨ RISC-V é‡Œï¼ŒS æ€å¼•å…¥äº†ä¸€ä¸ªå«åš satp çš„å¯„å­˜å™¨ï¼Œapt æ˜¯ <code>Address.Translation and Protection</code>ï¼Œå³åœ°å€ç¿»è¯‘å’Œä¿æŠ¤ã€‚è¿™ä¸ªåœ°æ–¹å­˜å‚¨çš„å°±æ˜¯å½“å‰è¿›ç¨‹çš„æ ¹é¡µè¡¨çš„é¡µå·ï¼Œåˆ‡æ¢æ—¶å°±ä¿®æ”¹å®ƒçš„å€¼ã€‚</p>
<h4 id="copy-on-write-çš„å®ç°"><a class="header" href="#copy-on-write-çš„å®ç°">Copy On Write çš„å®ç°</a></h4>
<p>å½“è¿›è¡Œ fork æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæŠŠçˆ¶è¿›ç¨‹çš„é¡µè¡¨é¡¹éƒ½è®¾ç½®ä¸ºåªè¯»ï¼Œå¹¶æŠŠçˆ¶è¿›ç¨‹çš„é¡µè¡¨é¡¹å¤åˆ¶ä¸€ä»½ç»™å­è¿›ç¨‹ï¼ˆè¿™é‡ŒæŒ‡çš„åº”è¯¥æ˜¯ä¸€çº§é¡µè¡¨ï¼‰ã€‚æ‰€ä»¥å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…¶å®å…±äº«ç›¸åŒçš„ç‰©ç†å†…å­˜ï¼ˆä¸¤ä¸ªè¿›ç¨‹å„è‡ªçš„ VA æ˜ å°„åˆ°åŒä¸€ä¸ª PAï¼‰ã€‚</p>
<p>åªè¦çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½åªè¿›è¡Œè¯»æ“ä½œï¼Œé‚£ä¹ˆå°±æ— äº‹å‘ç”Ÿã€‚å‡å¦‚è¿›è¡Œå†™æ“ä½œï¼Œå› ä¸ºç°åœ¨çˆ¶å­è¿›ç¨‹éƒ½æ˜¯åªè¯»çš„ï¼Œä¼šè§¦å‘ä¸€ä¸ªå¼‚å¸¸ï¼Œä» U æ€é™·å…¥ S æ€ã€‚æ­¤æ—¶æœ‰æ“ä½œç³»ç»Ÿæ¥ç®¡æ‰§è¡Œæƒï¼Œæ ¹æ®å¼‚å¸¸çš„åŸå› å‘ç°æ˜¯è¦ä¿®æ”¹å…±äº«çš„å†…å­˜ï¼Œäºæ˜¯æ“ä½œç³»ç»Ÿå°±ï¼š</p>
<ul>
<li>ä¸ºå­è¿›ç¨‹é‡æ–°åˆ†é…ä¸€ä¸ªé¡µé¢</li>
<li>ç„¶åæŠŠå­è¿›ç¨‹çš„é¡µè¡¨é¡¹æŒ‡å‘æ–°çš„é¡µé¢</li>
<li>å¹¶æŠŠè¿™å—å†…å­˜åœ¨çˆ¶å­è¿›ç¨‹ä¸­éƒ½æ”¹ä¸ºå¯è¯»å¯å†™</li>
<li>æœ€åè¿”å›ç”¨æˆ·æ€ã€‚</li>
</ul>
<blockquote>
<p>å›é¡¾ä¸­æ–­å’Œå¼‚å¸¸ï¼Œè¿™é‡Œçš„å°±æ˜¯å¼‚å¸¸ï¼Œtrap å¤„ç†ç»“æŸåä¼šé‡æ–°è·³åˆ°å¯¼è‡´å¼‚å¸¸çš„æŒ‡ä»¤ï¼ˆå³é‡è¯•ï¼‰ï¼Œç¨‹åºå°±åƒä»€ä¹ˆéƒ½æ²¡å‘ç”Ÿä¸€æ ·ã€‚</p>
</blockquote>
<p>é€šè¿‡è¿™ç§æ–¹å¼æˆ‘ä»¬å°±å®ç°äº† COWï¼Œä»¥ 4KB ä¸ºå•ä½ï¼Œç”¨å¤šå°‘å†…å­˜å°±å¤åˆ¶å¤šå°‘å†…å­˜ã€‚</p>
<h4 id="mmap-çš„å®ç°"><a class="header" href="#mmap-çš„å®ç°">Mmap çš„å®ç°</a></h4>
<p>ä¹Ÿæ˜¯é€šè¿‡è®¾ç½®é¡µè¡¨æƒé™ï¼Œç„¶åå¼•å‘å¼‚å¸¸ï¼Œæ“ä½œç³»ç»Ÿåšä¸€ç•ªæ“ä½œã€‚</p>
<p>å½“ç”¨æˆ·è¦æŠŠç¡¬ç›˜ä¸Šçš„æŸä¸ªæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜çš„æŸä¸ªåœ°å€ç©ºé—´é‡Œæ—¶ï¼Œå°±å¯ä»¥å…ˆåœ¨é¡µè¡¨é¡¹é‡ŒæŠŠè¿™ä¸€æ®µ VA å¯¹åº”çš„å†…å­˜æ˜ å°„åˆ°ä¸€å—ç‰©ç†å†…å­˜ä¸Šï¼Œç„¶åæŠŠç¡¬ç›˜æ–‡ä»¶é‡Œçš„æ•°æ®åŠ è½½åˆ°å¯¹åº”çš„ç‰©ç†å†…å­˜å¯¹åº”çš„åŒºåŸŸé‡Œã€‚</p>
<p>å¦‚æœæ˜ å°„çš„æ–‡ä»¶å¾ˆå°ï¼Œé‚£å°±å¯ä»¥æŠŠæ–‡ä»¶ä¸€æ¬¡æ€§è¯»åˆ°å†…å­˜ã€‚</p>
<p>å¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆåœ¨ VA é‡ŒæŠŠæ–‡ä»¶çš„å†…å­˜ç©ºé—´éƒ½åˆ†é…å¥½é¡µè¡¨ï¼Œä½†æ˜¯ä¸æŒ‡å‘å…·ä½“çš„ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶è®¾ç½®è¯»å†™æƒé™ã€‚</p>
<ul>
<li>å½“ç¨‹åºè¯»å†…å­˜æ—¶ï¼ŒåŒæ ·ä¼šè§¦å‘é™·å…¥ï¼Œç„¶åæ“ä½œç³»ç»Ÿä¼šæ ¹æ®è¯»å†™çš„åœ°å€å°†ç£ç›˜æ–‡ä»¶å¯¹åº”çš„åŒºå—åŠ è½½åˆ°å†…å­˜é‡Œï¼Œç„¶åå†ä¿®æ”¹é¡µè¡¨ã€‚</li>
<li>å½“å†™å†…å­˜æ—¶ï¼Œå¯¹åº”çš„é¡µè¡¨é¡¹çš„ D æ ‡å¿—ä½è¢«è®¾ä¸º 1ï¼Œæ“ä½œç³»ç»Ÿä¼šæœ‰ä¸€ä¸ªåå°çº¿ç¨‹å®šæœŸæ£€æŸ¥å“ªäº›é¡µè¡¨æ˜¯è„çš„ï¼Œå¹¶æŠŠè„é¡µåˆ·å›åˆ°å†…å­˜ã€‚</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="haskell-è¯­è¨€"><a class="header" href="#haskell-è¯­è¨€">Haskell è¯­è¨€</a></h1>
<p>â­ï¸<a href="http://learnyouahaskell.com/chapters">Learn You a Haskell for Great Good!</a></p>
<h2 id="0-ç‰¹æ€§"><a class="header" href="#0-ç‰¹æ€§">0. ç‰¹æ€§</a></h2>
<ol>
<li>
<blockquote>
<p>We usually use ' to either denote a strict  version of a function (one that isn't lazy) or a slightly modified  version of a function or a variable. Because ' is a valid character in functions, we can make a function like this.</p>
</blockquote>
<p><code>â€˜</code> åœ¨ haskell ä¸­æ˜¯å£°æ˜çš„åˆæ³•å­—ç¬¦ï¼Œä¸€èˆ¬ä¸­åŠ  <code>â€™</code> çš„å‡½æ•°ä»£è¡¨ä¸€ä¸ªå‡½æ•°çš„ä¿®æ”¹ç‰ˆæœ¬æˆ–è€…ä¸¥æ ¼ç‰ˆæœ¬</p>
</li>
</ol>
<h2 id="1-å¼€å§‹"><a class="header" href="#1-å¼€å§‹">1. å¼€å§‹</a></h2>
<p><strong>Starting Out</strong></p>
<h3 id="11-åŸºæœ¬å‡½æ•°"><a class="header" href="#11-åŸºæœ¬å‡½æ•°">1.1 åŸºæœ¬å‡½æ•°</a></h3>
<ul>
<li>æœ€å°å€¼ï¼š<code>min 1 3</code></li>
<li>æœ€å¤§å€¼ï¼š<code>max 1 3</code></li>
<li>åŠ ä¸€ï¼š<code>succ 1</code></li>
</ul>
<h3 id="12-åˆ—è¡¨"><a class="header" href="#12-åˆ—è¡¨">1.2 åˆ—è¡¨</a></h3>
<ul>
<li>
<p>åˆå¹¶ï¼š <code>[1,2,3,4] ++ [9,10,11,12] </code></p>
</li>
<li>
<p>æ ¹æ®ç´¢å¼•å–å€¼ï¼š <code>&quot;Steve Buscemi&quot; !! 6</code></p>
</li>
<li>
<p>å¼€å¤´æ’å…¥ï¼š <code>'A':&quot; SMALL CAT&quot; </code></p>
<blockquote>
<p>[1,2,3] is actually just syntactic sugar for 1:2:3:[].</p>
</blockquote>
</li>
<li>
<p>å–è¡¨å¤´ï¼š<code>head [1, 2, 3, 4, 5]</code></p>
</li>
<li>
<p>å–è¡¨å°¾ï¼š<code>tail [1, 2, 3, 4, 5] </code></p>
</li>
<li>
<p>å–æœ€åä¸€ä¸ªå…ƒç´ ï¼š<code>last [1, 2, 3, 4, 5]</code></p>
</li>
<li>
<p>å–é™¤äº†æœ€åä¸€ä¸ªå…ƒç´ ï¼š <code>init [1, 2, 3, 4, 5]</code></p>
</li>
<li>
<p>é•¿åº¦ï¼š <code>length [5,4,3,2,1] </code></p>
</li>
<li>
<p>æ˜¯å¦ä¸ºç©ºï¼š <code>null [1,2,3] </code></p>
</li>
<li>
<p>åè½¬åˆ—è¡¨ï¼š <code>reverse [5,4,3,2,1] </code></p>
</li>
<li>
<p>å–å‰ n ä¸ªï¼š <code>take 3 [5,4,3,2,1] </code></p>
</li>
<li>
<p>ä»ç¬¬ n ä¸ªå¼€å§‹å‘åå–ï¼š <code>drop 3 [8,4,2,1,5,6] </code></p>
</li>
<li>
<p>æœ€å¤§å…ƒç´ ï¼š <code>maximum [1,9,2,3,4] </code></p>
</li>
<li>
<p>æœ€å°å…ƒç´ ï¼š <code>minimum [8,4,2,1,5,6]</code></p>
</li>
<li>
<p>åŠ ï¼š <code>sum [5,2,1,6,3,2,5,7] </code></p>
</li>
<li>
<p>ä¹˜ï¼š <code>product [6,2,1,2] </code></p>
</li>
<li>
<p>æ˜¯å¦åœ¨åˆ—è¡¨ä¸­ï¼š <code>4 </code>elem <code>[3,4,5,6]</code></p>
</li>
</ul>
<h3 id="13-ç”Ÿæˆå¼"><a class="header" href="#13-ç”Ÿæˆå¼">1.3 ç”Ÿæˆå¼</a></h3>
<ul>
<li>å¾ªç¯è¿½åŠ ï¼ˆappendï¼‰ï¼š <code>cycle [1,2,3]</code></li>
<li>å¾ªç¯ç”Ÿæˆï¼ˆextendï¼‰ï¼š <code>repeat 5</code></li>
<li>ç”Ÿæˆå¼ï¼š <code>boomBangs xs = [ if x &lt; 10 then &quot;BOOM!&quot; else &quot;BANG!&quot; | x &lt;- xs, odd x]</code></li>
</ul>
<h3 id="14-å…ƒç»„"><a class="header" href="#14-å…ƒç»„">1.4 å…ƒç»„</a></h3>
<p>ç±»å‹éšæ„ï¼Œ</p>
<ul>
<li>fstï¼š <code>fst (&quot;Wow&quot;, False) </code></li>
<li>sndï¼š <code>snd (&quot;Wow&quot;, False)</code></li>
</ul>
<h3 id="15-é‡è¦"><a class="header" href="#15-é‡è¦">1.5 é‡è¦</a></h3>
<ul>
<li>zip
<pre><code class="language-haskell">zip [5,3,2,6,2,7,2,5,4,6,6] [&quot;im&quot;,&quot;a&quot;,&quot;turtle&quot;]
    [(5,&quot;im&quot;),(3,&quot;a&quot;),(2,&quot;turtle&quot;)]
zip [1..] [&quot;apple&quot;, &quot;orange&quot;, &quot;cherry&quot;, &quot;mango&quot;]
    [(1,&quot;apple&quot;),(2,&quot;orange&quot;),(3,&quot;cherry&quot;),(4,&quot;mango&quot;)]
</code></pre>
</li>
</ul>
<h2 id="2-ç±»å‹ç³»ç»Ÿ"><a class="header" href="#2-ç±»å‹ç³»ç»Ÿ">2. ç±»å‹ç³»ç»Ÿ</a></h2>
<p><strong>Types and Typeclasses</strong></p>
<h3 id="21-æŸ¥çœ‹ç±»å‹"><a class="header" href="#21-æŸ¥çœ‹ç±»å‹">2.1 æŸ¥çœ‹ç±»å‹</a></h3>
<p>ghci æŸ¥çœ‹</p>
<pre><code class="language-haskell">ï¼št (1, &quot;qqq&quot;)
</code></pre>
<h3 id="22-typeclasses-101"><a class="header" href="#22-typeclasses-101">2.2 Typeclasses 101</a></h3>
<p>æ‰€æœ‰çš„ <code>== + - * / </code> éƒ½æ˜¯ function</p>
<pre><code class="language-haskell">ghci&gt; :t (==)
(==) :: (Eq a) =&gt; a -&gt; a -&gt; Bool
</code></pre>
<blockquote>
<p>Everything before the =&gt; symbol is called a <em>class constraint</em>. We can read the previous type declaration like this: the equality  function takes any two values that are of the same type and returns a Bool. The type of those two values must be a member of the Eq class (this was the class constraint).</p>
</blockquote>
<ul>
<li><code>=&gt;</code> ä¹‹å‰çš„è¢«å«åšç±»å‹çº¦æŸ</li>
</ul>
<p><strong>Type variables</strong></p>
<pre><code class="language-haskell">ghci&gt; :t head
head :: [a] -&gt; a
</code></pre>
<p>a å°±æ˜¯ç±»å‹å˜é‡ï¼Œä½†æ˜¯ç”±äº a ä¸æ˜¯æŸä¸€ä¸ªç‰¹å®šçš„ç±»å‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§° head å¤šæ€å‡½æ•°</p>
<blockquote>
<p>Functions that have type variables are called <strong>polymorphic functions</strong>.</p>
</blockquote>
<p><strong>Typeclasses</strong> å°±æ˜¯ç±»å‹çº¦æŸ</p>
<p>ä¸‹é¢ä¸¾å‡ºäº†ä¸€ç³»åˆ—å¸¸ç”¨çš„ Typeclasses</p>
<h4 id="221-eq"><a class="header" href="#221-eq">2.2.1 Eq</a></h4>
<blockquote>
<p>The Eq typeclass provides an interface for  testing for equality. Any type where it makes sense to test for equality between two values of that type should be a member of the Eq class. All standard Haskell types except for IO (the type for dealing with input and output) and functions are a part of the Eq typeclass.</p>
</blockquote>
<p>Eq æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒçš„æ¥å£ï¼Œä»»ä½•èƒ½å¤Ÿæ¯”è¾ƒè¯¥ç±»å‹çš„ä¸¤ä¸ªå€¼ä¹‹é—´ç›¸ç­‰æ€§çš„éƒ½åº”è¯¥æ˜¯ Eq ç±»çš„æˆå‘˜</p>
<h4 id="222-ord"><a class="header" href="#222-ord">2.2.2 Ord</a></h4>
<blockquote>
<p>All the types we covered so far except for functions are part of Ord. Ord covers all the standard comparing functions such as &gt;, &lt;, &gt;= and &lt;=. The compare function takes two Ord members of the same type and returns an ordering. Ordering is a type that can be GT, LT or EQ, meaning <em>greater than</em>, <em>lesser than</em> and <em>equal</em>, respectively.</p>
</blockquote>
<p>Ord åŒ…å«äº†æ‰€æœ‰æ ‡å‡†çš„æ¯”è¾ƒå‡½æ•°ï¼Œä¾‹å¦‚ &gt; &lt; &gt;= &lt;=, æ¯”è¾ƒå‡½æ•°æ¥å—ä¸¤ä¸ªç±»å‹ç›¸åŒçš„ Ord æˆå‘˜ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ’åºï¼Œæ’åºæ˜¯ GTï¼ŒLTï¼ŒEQï¼Œåˆ†åˆ«è¡¨ç¤ºå¤§äºï¼Œå°äºï¼Œç­‰äº</p>
<pre><code class="language-haskell">ghci&gt; &quot;Abrakadabra&quot; &lt; &quot;Zebra&quot;
True
ghci&gt; &quot;Abrakadabra&quot; `compare` &quot;Zebra&quot;
LT
ghci&gt; 5 &gt;= 2
True
ghci&gt; 5 `compare` 3
GT
</code></pre>
<h4 id="223-show"><a class="header" href="#223-show">2.2.3 Show</a></h4>
<blockquote>
<p>Members of Show can be presented as strings. All types covered so far except for functions are a part of Show. The most used function that deals with the Show typeclass is show. It takes a value whose type is a member of Show and presents it to us as a string.</p>
</blockquote>
<p>Show çš„æˆå‘˜å¯ä»¥è¢«æ‰“å°ä¸ºå­—ç¬¦ä¸²ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œé™¤äº†å‡½æ•°ä¹‹å¤–çš„æ‰€æœ‰ç±»å‹éƒ½æ˜¯ Show çš„ä¸€éƒ¨åˆ†ã€‚</p>
<p>show å‡½æ•°æ¥å—ä¸€ä¸ªç±»å‹ä¸º Show æˆå‘˜çš„å€¼ï¼Œå¹¶å°†å…¶ä½œä¸ºå­—ç¬¦ä¸²å‘ˆç°</p>
<pre><code class="language-haskell">ghci&gt; :t read
read :: (Read a) =&gt; String -&gt; a
</code></pre>
<h4 id="224-read"><a class="header" href="#224-read">2.2.4 Read</a></h4>
<blockquote>
<p>Read is sort of the opposite typeclass of Show. The read function takes a string and returns a type which is a member of Read.</p>
</blockquote>
<p>read å‡½æ•°æ¥å—ä¸€ä¸ª Stringï¼Œå¹¶è¿”å›ä¸€ä¸ª Read çš„æˆå‘˜çš„ç±»å‹</p>
<p><strong>é—®é¢˜</strong></p>
<pre><code class="language-haskell">ghci&gt; read &quot;4&quot;
    &lt;interactive&gt;:1:0:
        Ambiguous type variable `a' in the constraint:
        	`Read a' arising from a use of `read' at &lt;interactive&gt;:1:0-7
        Probable fix: add a type signature that fixes these type variable(s)
</code></pre>
<p><strong>æŒ‡å®š return ç±»å‹</strong></p>
<pre><code class="language-haskell">ghci&gt; read &quot;5&quot; :: Int
5
ghci&gt; read &quot;5&quot; :: Float
5.0
ghci&gt; (read &quot;5&quot; :: Float) * 4
20.0
ghci&gt; read &quot;[1,2,3,4]&quot; :: [Int]
[1,2,3,4]
ghci&gt; read &quot;(3, 'a')&quot; :: (Int, Char)
(3, 'a')
</code></pre>
<h4 id="225-enum"><a class="header" href="#225-enum">2.2.5 Enum</a></h4>
<blockquote>
<p>Enum members are sequentially ordered types â€” they can be enumerated. The main advantage of the Enum typeclass is that we can use its types in list ranges. They also have  defined successors and predecesors, which you can get with the succ and pred functions. Types in this class: (), Bool, Char, Ordering, Int, Integer, Float and Double.</p>
</blockquote>
<p>æšä¸¾ç±»å‹æ˜¯æŒ‰ç…§é¡ºåºæ’åºçš„ç±»å‹ï¼Œä»–ä»¬å¯ä»¥è¢«æšä¸¾ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆ—è¡¨ä¸­ä½¿ç”¨å®ƒçš„æ‰€æœ‰ç±»å‹ã€‚</p>
<p>ä»–ä»¬è¿˜è¢«å®šä¹‰äº†å‰é©±å’Œåç»§ï¼Œå› æ­¤å¯ä»¥å¯¹å®ƒçš„ç±»å‹ä½¿ç”¨ <code>succ</code> å’Œ <code>pred</code> å‡½æ•°</p>
<pre><code class="language-haskell">ghci&gt; ['a'..'e']
&quot;abcde&quot;
ghci&gt; [LT .. GT]
[LT,EQ,GT]
ghci&gt; [3 .. 5]
[3,4,5]
ghci&gt; succ 'B'
'C'
</code></pre>
<h4 id="226-bounded"><a class="header" href="#226-bounded">2.2.6 Bounded</a></h4>
<blockquote>
<p>Bounded members have an upper and a lower bound.</p>
</blockquote>
<p>Bounded ç±»å‹æœ‰ä¸Šç•Œå’Œä¸‹ç•Œ</p>
<pre><code class="language-haskell">ghci&gt; minBound :: Int
-2147483648
ghci&gt; maxBound :: Char
'\1114111'
ghci&gt; maxBound :: Bool
True
ghci&gt; minBound :: Bool
False
</code></pre>
<blockquote>
<p>minBound and maxBound are interesting because they have a type of (Bounded a) =&gt; a. In a sense they are polymorphic constants.</p>
</blockquote>
<p>ä»–ä»¬æ˜¯å¤šæ€æ€§å¸¸é‡ï¼Œè§ä¸‹æ–‡</p>
<p>å¦‚æœå…ƒç»„çš„å…ƒç´ ä¹Ÿåœ¨å…ƒç»„ä¸­ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç»„ä¹Ÿæ˜¯ Bounded çš„æˆå‘˜ã€‚</p>
<pre><code class="language-haskell">ghci&gt; maxBound :: (Bool, Int, Char)
(True,2147483647,'\1114111')
</code></pre>
<h4 id="227-num"><a class="header" href="#227-num">2.2.7 Num</a></h4>
<p>Num ä¹Ÿæ˜¯ä¸€ä¸ªå¤šæ€æ€§å¸¸é‡ï¼Œä»–èƒ½è¡¨ç°çš„å‘ä»»ä½• Num ç±»çš„æˆå‘˜ï¼ˆåŒ…æ‹¬ Int, Integer, Float, Doubleï¼‰</p>
<pre><code class="language-haskell">ghci&gt; :t 20
20 :: (Num t) =&gt; t

ghci&gt; 20 :: Int
20
ghci&gt; 20 :: Integer
20
ghci&gt; 20 :: Float
20.0
ghci&gt; 20 :: Double
20.0
</code></pre>
<p><code>(5 :: Int) * (6 :: Integer)</code> will errorï¼Œ while <code>5 * (6 :: Integer)</code>  will work just fine</p>
<h4 id="229-integral--floating"><a class="header" href="#229-integral--floating">2.2.9 Integral &amp; Floating</a></h4>
<ul>
<li><code>Integral </code>contains <code> Int</code> and <code>Integer</code></li>
<li><code>Floating</code> contains <code>Float</code> and <code>Double</code>.</li>
</ul>
<p><code>fromIntegral</code>å¯ä»¥å¸®æˆ‘ä»¬å®ç°ç±»å‹è½¬æ¢</p>
<pre><code class="language-haskell">-- It has a type declaration of
fromIntegral :: (Num b, Integral a) =&gt; a -&gt; b
-- so, you can use it as
fromIntegral (length [1,2,3,4]) + 3.2
</code></pre>
<h2 id="3-å‡½æ•°è¯­æ³•"><a class="header" href="#3-å‡½æ•°è¯­æ³•">3. å‡½æ•°è¯­æ³•</a></h2>
<p><strong>Syntax in Functions</strong></p>
<h3 id="31-match-è¡¨è¾¾å¼"><a class="header" href="#31-match-è¡¨è¾¾å¼">3.1 Match è¡¨è¾¾å¼</a></h3>
<p><strong>Pattern marching</strong></p>
<ol>
<li>
<p>åœ¨ ghci ä¸­å£°æ˜ç±»å‹éœ€è¦ä½¿ç”¨å¤šè¡Œå—ä¸­</p>
<pre><code class="language-haskell">:{
lucky :: Int -&gt; String
lucky a = show(a)
:}

:type lucky
lucky :: Int -&gt; String
</code></pre>
</li>
<li>
<p>åŒ¹é…åˆ—è¡¨é•¿åº¦</p>
<pre><code class="language-haskell">tell :: (Show a) =&gt; [a] -&gt; String
tell [] = &quot;The list is empty&quot;
tell (x:[]) = &quot;The list has one element: &quot; ++ show x
tell (x:y:[]) = &quot;The list has two elements: &quot; ++ show x ++ &quot; and &quot; ++ show y
tell (x:y:_) = &quot;This list is long. The first two elements are: &quot; ++ show x ++ &quot; and &quot; ++ show y
</code></pre>
</li>
<li>
<p>ä¸€ä¸ª length å‡½æ•°çš„å®ç°</p>
<pre><code class="language-haskell">length' :: (Num b) =&gt; [a] -&gt; b
length' [] = 0
length' (_:xs) = 1 + length' xs
</code></pre>
</li>
</ol>
<h3 id="32-guard"><a class="header" href="#32-guard">3.2 Guard</a></h3>
<ol>
<li>
<p>æ ‡å‡†</p>
<pre><code class="language-haskell">bmiTell :: (RealFloat a) =&gt; a -&gt; String
bmiTell bmi
   | bmi &lt;= 18.5 = &quot;You're underweight, you emo, you!&quot;
   | bmi &lt;= 25.0 = &quot;You're supposedly normal. Pffft, I bet you're ugly!&quot;
   | bmi &lt;= 30.0 = &quot;You're fat! Lose some weight, fatty!&quot;
   | otherwise   = &quot;You're a whale, congratulations!&quot;

myCompare :: (Ord a) =&gt; a -&gt; a -&gt; Ordering
a `myCompare` b
    | a &gt; b     = GT
    | a == b    = EQ
    | otherwise = LT
</code></pre>
</li>
<li>
<p>inline ç‰ˆï¼ˆå¯è¯»æ€§å·®ï¼‰</p>
<pre><code class="language-haskell">max' :: (Ord a) =&gt; a -&gt; a -&gt; a
max' a b | a &gt; b = a | otherwise = b
</code></pre>
</li>
</ol>
<h3 id="33-where"><a class="header" href="#33-where">3.3 where</a></h3>
<ol>
<li>
<p>ä½œç”¨åœ¨ guard ä¸Š</p>
<pre><code class="language-haskell">    bmiTell :: (RealFloat a) =&gt; a -&gt; a -&gt; String
    bmiTell weight height
        | bmi &lt;= skinny = &quot;You're underweight, you emo, you!&quot;
        | bmi &lt;= normal = &quot;You're supposedly normal. Pffft, I bet you're ugly!&quot;
        | bmi &lt;= fat    = &quot;You're fat! Lose some weight, fatty!&quot;
        | otherwise     = &quot;You're a whale, congratulations!&quot;
        where bmi = weight / height ^ 2
              skinny = 18.5
              normal = 25.0
              fat = 30.0
</code></pre>
<blockquote>
<p><em>where</em> bindings aren't shared across function bodies of different  patterns. If you want several patterns of one function to access some  shared name, you have to define it globally.</p>
</blockquote>
<p>where çš„ç»‘å®šä¸èƒ½åœ¨å‡½æ•°ä½“é‡Œå…±äº«ï¼Œé™¤éä»¥å…¨å±€æ–¹å¼å®šä¹‰</p>
</li>
<li>
<p>ä½œç”¨åœ¨ pattern match ä¸Š</p>
<pre><code class="language-haskell">    initials :: String -&gt; String -&gt; String
    initials firstname lastname = [f] ++ &quot;. &quot; ++ [l] ++ &quot;.&quot;
        where (f:_) = firstname
              (l:_) = lastname
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ where å®šä¹‰ function</p>
<pre><code class="language-haskell">    calcBmis :: (RealFloat a) =&gt; [(a, a)] -&gt; [a]
    calcBmis xs = [bmi w h | (w, h) &lt;- xs]
        where bmi weight height = weight / height ^ 2
</code></pre>
</li>
</ol>
<h3 id="34-let-it-be"><a class="header" href="#34-let-it-be">3.4 Let it be</a></h3>
<p>** <code>let &lt;bindings&gt; in &lt;expression&gt; </code>**</p>
<pre><code class="language-haskell">    cylinder :: (RealFloat a) =&gt; a -&gt; a -&gt; a
    cylinder r h =
        let sideArea = 2 * pi * r * h
            topArea = pi * r ^2
        in  sideArea + 2 * topArea
</code></pre>
<blockquote>
<p>The difference is that <em>let</em> bindings are expressions themselves. <em>where</em> bindings are just syntactic constructs.</p>
</blockquote>
<p>Let æŠŠç»‘å®šæ”¾åœ¨å‰é¢ï¼Œwhere æŠŠç»‘å®šæ”¾åœ¨åé¢ï¼Œä½†æ˜¯ Let æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ŒWhere åªæ˜¯ä¸ªè¯­æ³•ç»“æ„</p>
<h3 id="35-case-expression"><a class="header" href="#35-case-expression">3.5 Case Expression</a></h3>
<ul>
<li>
<p>ç¤ºä¾‹ 1</p>
<pre><code class="language-haskell">describeList :: [a] -&gt; String
describeList xs = &quot;The list is &quot; ++ case xs of [] -&gt; &quot;empty.&quot;
                                               [x] -&gt; &quot;a singleton list.&quot;
                                               xs -&gt; &quot;a longer list.&quot;
</code></pre>
</li>
<li>
<p>ç¤ºä¾‹ 2</p>
<pre><code class="language-haskell">describeList :: [a] -&gt; String
describeList xs = &quot;The list is &quot; ++ what xs
    where what [] = &quot;empty.&quot;
          what [x] = &quot;a singleton list.&quot;
          what xs = &quot;a longer list.&quot;
</code></pre>
</li>
</ul>
<h2 id="4-é€’å½’"><a class="header" href="#4-é€’å½’">4. é€’å½’</a></h2>
<p><strong>Recursion</strong></p>
<pre><code>### 4.1 maxium
</code></pre>
<pre><code class="language-haskell">-- ç¬¬ä¸€ç§
maximum' :: (Ord a) =&gt; [a] -&gt; a
maximum' [] = error &quot;maximum of empty list&quot;
maximum' [x] = x
maximum' (x:xs)
    | x &gt; maxTail = x
    | otherwise = maxTail
    where maxTail = maximum' xs
-- ç¬¬äºŒç§
maximum' :: (Ord a) =&gt; [a] -&gt; a
maximum' [] = error &quot;maximum of empty list&quot;
maximum' [x] = x
maximum' (x:xs) = max x (maximum' xs)
</code></pre>
<h3 id="42-replicate"><a class="header" href="#42-replicate">4.2 replicate</a></h3>
<pre><code class="language-haskell">replicate' :: (Num i, Ord i) =&gt; i -&gt; a -&gt; [a]
replicate' n x
    | n &lt;= 0    = []
    | otherwise = x:replicate' (n-1) x
</code></pre>
<h3 id="43-take"><a class="header" href="#43-take">4.3 take</a></h3>
<pre><code class="language-haskell">take' :: (Num i, Ord i) =&gt; i -&gt; [a] -&gt; [a]
take' n _
    | n &lt;= 0   = []
take' _ []     = []
take' n (x:xs) = x : take' (n-1) xs
</code></pre>
<h3 id="44-zip"><a class="header" href="#44-zip">4.4 zip</a></h3>
<pre><code class="language-haskell">elem' :: (Eq a) =&gt; a -&gt; [a] -&gt; Bool
elem' a [] = False
elem' a (x:xs)
    | a == x    = True
    | otherwise = a `elem'` xs
</code></pre>
<h3 id="45-quick-sort"><a class="header" href="#45-quick-sort">4.5 quick sort</a></h3>
<pre><code class="language-haskell">quicksort :: (Ord a) =&gt; [a] -&gt; [a]
quicksort [] = []
quicksort (x:xs) =
    let smallerSorted = quicksort [a | a &lt;- xs, a &lt;= x]
        biggerSorted = quicksort [a | a &lt;- xs, a &gt; x]
    in  smallerSorted ++ [x] ++ biggerSorted
quicksort (x:xs) = quicksort [a | a &lt;- xs, a &lt;= x] ++ [x] ++ quicksort [a | a &lt;- xs, a &gt; x]
</code></pre>
<h2 id="5-é«˜é˜¶å‡½æ•°"><a class="header" href="#5-é«˜é˜¶å‡½æ•°">5. é«˜é˜¶å‡½æ•°</a></h2>
<p><em>Higher order functions</em></p>
<p>èƒ½å¤Ÿä»¥å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªå‡½æ•°çš„å‡½æ•°éƒ½æ˜¯é«˜é˜¶å‡½æ•°ï¼Œå‘Šè¯«å‡½æ•°å°±æ˜¯ Haskell çš„ä½“éªŒ</p>
<h3 id="51-curried-functions"><a class="header" href="#51-curried-functions">5.1 Curried functions</a></h3>
<pre><code class="language-haskell">ghci&gt; max 4 5
5
-- max æœ¬èº«å¯ä»¥è¿™æ ·å†™
ghci&gt; (max 4) 5
5
</code></pre>
<p>è®©æˆ‘ä»¬çœ‹çœ‹ max çš„ç±»å‹</p>
<pre><code class="language-haskell">max :: (Ord a) =&gt; a -&gt; a -&gt; a.
-- ä¹Ÿèƒ½å†™ä½œ
max :: (Ord a) =&gt; a -&gt; (a -&gt; a).
</code></pre>
<p>æ‰€ä»¥ max è¿™ä¸ªå‡½æ•°èƒ½å¤Ÿè¿”å›ä¸€ä¸ªå‡½æ•°</p>
<p>åŒæ—¶</p>
<h3 id="52-ä¸€äº›é«˜é˜¶å‡½æ•°"><a class="header" href="#52-ä¸€äº›é«˜é˜¶å‡½æ•°">5.2 ä¸€äº›é«˜é˜¶å‡½æ•°</a></h3>
<pre><code class="language-haskell">applyTwice :: (a -&gt; a) -&gt; a -&gt; a
applyTwice f x = f (f x)

ghci&gt; applyTwice (+3) 10
16
</code></pre>
<pre><code class="language-haskell">zipWith' :: (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
zipWith' _ [] _ = []
zipWith' _ _ [] = []
zipWith' f (x:xs) (y:ys) = f x y : zipWith' f xs ys

zipWith' (++) [&quot;aaa&quot;, &quot;bbb&quot;] [&quot;ccc&quot;, &quot;ddd&quot;]
[&quot;aaaccc&quot;,&quot;bbbddd&quot;]
</code></pre>
<p><strong>flip</strong></p>
<pre><code class="language-haskell">flip' :: (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
flip' f y x = f x y
</code></pre>
<h3 id="53-map"><a class="header" href="#53-map">5.3 Map</a></h3>
<blockquote>
<p><code>map (+3) [1,5,3,1,6] </code>is the same as writing <code>[x+3 | x &lt;- [1,5,3,1,6]].</code></p>
</blockquote>
<pre><code class="language-haskell">    map :: (a -&gt; b) -&gt; [a] -&gt; [b]
    map _ [] = []
    map f (x:xs) = f x : map f xs
</code></pre>
<h3 id="54-filter"><a class="header" href="#54-filter">5.4 Filter</a></h3>
<pre><code class="language-haskell">    filter :: (a -&gt; Bool) -&gt; [a] -&gt; [a]
    filter _ [] = []
    filter p (x:xs)
        | p x       = x : filter p xs
        | otherwise = filter p xs
</code></pre>
<h3 id="55-takewhile"><a class="header" href="#55-takewhile">5.5 takeWhile</a></h3>
<p>take ç›´åˆ°é™åˆ¶æ¡ä»¶åˆ°</p>
<pre><code class="language-haskell">sum (takeWhile (&lt;10000) (filter odd (map (^2) [1..])))

sum (takeWhile (&lt;10000) [n^2 | n &lt;- [1..], odd (n^2)])
</code></pre>
<h3 id="56-chain"><a class="header" href="#56-chain">5.6 Chain</a></h3>
<p>ç”Ÿæˆ Collatz sequences</p>
<pre><code class="language-haskell">chain :: (Integral a) =&gt; a -&gt; [a]
chain 1 = [1]
chain n
    | even n =  n:chain (n `div` 2)
    | odd n  =  n:chain (n*3 + 1)

-- å°ç»ƒä¹ 
numLongChains :: Int
numLongChains = length (filter isLong (map chain [1..100]))
    where isLong xs = length xs &gt; 15
</code></pre>
<h3 id="57-map--0"><a class="header" href="#57-map--0">5.7 map (*) [0..]</a></h3>
<blockquote>
<p>If we map <code>*</code> over the list <code> [0..]</code>, we get back a list of functions that only take one parameter, so <code>(Num a) =&gt; [a -&gt; a]</code>. <code>map (*) [0..]</code> produces a list like the one we'd get by writing <code>[(0*),(1*),(2*),(3*),(4*),(5*)...</code></p>
</blockquote>
<p>å®ä¾‹ä»£ç </p>
<pre><code class="language-haskell">ghci&gt; let listOfFuns = map (*) [0..]
ghci&gt; (listOfFuns !! 4) 5
20
</code></pre>
<h3 id="58-lambdas"><a class="header" href="#58-lambdas">5.8 Lambdas</a></h3>
<p>è¯­æ³•ï¼šä¸€èˆ¬ä»¥å°æ‹¬å·é˜”èµ·æ¥ï¼Œä»¥ <code>\</code> å¼€å¤´</p>
<pre><code class="language-haskell">numLongChains :: Int
numLongChains = length (filter (\xs -&gt; length xs &gt; 15) (map chain [1..100]))
</code></pre>
<p>ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ç”¨å‘</p>
<pre><code class="language-haskell">flip' :: (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
flip' f = \x y -&gt; f y x
</code></pre>
<h3 id="59-fold"><a class="header" href="#59-fold">5.9 Fold</a></h3>
<p>æˆ‘ä»¬ç”¨ <em>fold</em> å†æ¬¡å®ç° <code>sum</code> å‡½æ•°</p>
<pre><code class="language-haskell">sum' :: (Num a) =&gt; [a] -&gt; a
sum' xs = foldl (\acc x -&gt; acc + x) 0 xs
ghci&gt; sum' [3,5,2,1]
11
</code></pre>
<ol>
<li><strong>foldl</strong> æ¥å— 2 ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å‡½æ•°å’Œä¸€ä¸ªåˆå§‹å€¼ (æˆ–è€…è¯´ç´¯åŠ å™¨), acc å¼€å§‹ä¸º 0ï¼Œä¹‹åä¾æ¬¡åŠ  3, 5, 2, 1</li>
</ol>
<p>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç´¯åŠ å™¨ï¼Œç¬¬äºŒä¸ªæ˜¯å½“å‰çš„å€¼</p>
<pre><code class="language-haskell">-- å†æ¬¡å®ç° elem
elem' :: (Eq a) =&gt; a -&gt; [a] -&gt; Bool
elem' x xs = foldl (\acc el -&gt; if el == x then True else acc) False xs
</code></pre>
<ol start="2">
<li>
<p><strong>foldr</strong> ä¸ foldl ç›¸ä¼¼ï¼Œä¸è¿‡æ˜¯ä»å³ä¾§å¼€å§‹éå†å…ƒç´ ï¼Œå…¶ä¸­ï¼Œfoldr çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½“å‰å…ƒç´ ï¼Œç¬¬äºŒä¸ªå…ƒç´ æ˜¯ acc ç´¯åŠ å™¨</p>
</li>
<li>
<p><strong>ä¸¤ç§ map çš„å®ç°</strong></p>
<pre><code class="language-haskell">-- foldr
map' :: (a -&gt; b) -&gt; [a] -&gt; [b]
map' f xs = foldr (\x acc -&gt; f x : acc) [] xs
-- foldl
map' f xs = foldl (\acc x -&gt; acc ++ [f x]) [] xs
</code></pre>
<p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼Œ<code>foldr</code> å®ç°çš„æ›´å¥½ï¼Œå› ä¸º <code>:</code> çš„å¼€é”€æ¯” <code>++</code> å°çš„å¤š</p>
</li>
<li>
<p>è¦æ³¨æ„çš„æ˜¯ foldr å¯ä»¥ä½œç”¨åœ¨æ— çº¿åˆ—è¡¨ä¸Šï¼Œfoldl ä¸èƒ½</p>
</li>
<li>
<p><strong>foldl1</strong> å’Œ <strong>foldr1</strong> ä½¿ç”¨ç¬¬ä¸€ä¸ªæˆ–è€…æœ€åä¸€ä¸ªä½œä¸ºåˆå€¼ï¼Œä¸éœ€è¦é‚£ä¸ªå‚æ•°äº†</p>
<pre><code class="language-haskell">-- è¿™é‡Œæ˜¯ä¸€å †ä¾‹å­
maximum' :: (Ord a) =&gt; [a] -&gt; a
maximum' = foldr1 (\x acc -&gt; if x &gt; acc then x else acc)

reverse' :: [a] -&gt; [a]
reverse' = foldl (\acc x -&gt; x : acc) []

product' :: (Num a) =&gt; [a] -&gt; a
product' = foldr1 (*)

filter' :: (a -&gt; Bool) -&gt; [a] -&gt; [a]
filter' p = foldr (\x acc -&gt; if p x then x : acc else acc) []

head' :: [a] -&gt; a
head' = foldr1 (\x _ -&gt; x)

last' :: [a] -&gt; a
last' = foldl1 (\_ x -&gt; x)
</code></pre>
</li>
<li>
<p><strong>scanl</strong> å’Œ <strong>scanr</strong> å’Œ fold ç±»ä¼¼ï¼Œä¸è¿‡ä¼šæŠŠä¸­é—´çš„çŠ¶æ€ä¿ç•™ï¼Œå¹¶è¿”å›ä¸€ä¸ªåˆ—è¡¨</p>
<pre><code class="language-haskell">ghci&gt; scanl (+) 0 [3,5,2,1]
[0,3,8,10,11]
ghci&gt; scanr (+) 0 [3,5,2,1]
[11,8,3,1,0]
ghci&gt; scanl1 (\acc x -&gt; if x &gt; acc then x else acc) [3,4,5,3,7,9,2,1]
[3,4,5,5,7,9,9,9]
ghci&gt; scanl (flip (:)) [] [3,2,1]
[[],[3],[2,3],[1,2,3]]
</code></pre>
</li>
</ol>
<h3 id="510--è¿ç®—ç¬¦"><a class="header" href="#510--è¿ç®—ç¬¦">5.10 $ è¿ç®—ç¬¦</a></h3>
<blockquote>
<p>Whereas normal function application (putting a space between two things) has a really high precedence, the $ function has the lowest precedence. Function application with a space is left-associative (so f a b c is the same as ((f a) b) c)), function application with $ is right-associative.</p>
</blockquote>
<p>ç©ºæ ¼å…·æœ‰è¾ƒé«˜çš„ä¼˜å…ˆçº§ï¼Œä½†æ˜¯ <code>$</code> å…·æœ‰æœ€ä½çš„ä¼˜å…ˆçº§</p>
<p>ä½¿ç”¨ç©ºæ ¼åˆ†å‰²çš„æ˜¯å·¦å…³è”çš„ï¼Œè€Œä½¿ç”¨ <code>$</code> åˆ†å‰²çš„æ˜¯å³å…³è”çš„</p>
<p>æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</p>
<ol>
<li>
<p>å°‘äº›æ‹¬å·</p>
<p><code>sum (map sqrt [1..130])</code> å¯ä»¥ç”¨ <code>sum $ map sqrt [1..130]</code> ä»£æ›¿ï¼Œ<code>sqrt 3 + 4 + 9</code>æ˜¯ 13+ æ ¹å· 3ï¼Œä½†æ˜¯ <code>sqrt $ 3 + 4 + 9</code> å°±æ­£å¸¸</p>
<p>[]:</p>
<blockquote>
<p>How about sum (filter (&gt; 10) (map (*2) [2..10]))? Well, because $ is right-associative, f (g (z x)) is equal to f $ g $ z x. And so, we can rewrite sum (filter (&gt; 10) (map (*2) [2..10])) as sum $ filter (&gt; 10) $ map (*2) [2..10].</p>
</blockquote>
</li>
<li>
<p>å¢åŠ ç‰¹æ€§</p>
</li>
</ol>
<p>åŠ äº† <code>$</code> æ„å‘³ç€å¯ä»¥è¢«å½“ä½œå‡½æ•°æ¥å¯¹å¾…ï¼Œæ‰€ä»¥ä¸‹é¢çš„å†™æ³•æ˜¯å¯è¡Œçš„</p>
<pre><code class="language-haskell">ghci&gt; map ($ 3) [(4+), (10*), (^2), sqrt]
[7.0,30.0,9.0,1.7320508075688772]
</code></pre>
<h3 id="511-å‡½æ•°ç»„åˆ"><a class="header" href="#511-å‡½æ•°ç»„åˆ">5.11 å‡½æ•°ç»„åˆ</a></h3>
<p><code>.</code> æ˜¯ä¸€ä¸ªè¿ç®—ç¬¦ï¼Œä»–çš„å®šä¹‰å¦‚ä¸‹</p>
<pre><code class="language-haskell">(.) :: (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
f . g = \x -&gt; f (g x)
</code></pre>
<p>æœ‰äº†è¿™ä¸ªåï¼Œä¸€äº›åµŒå¥—çš„å‡½æ•°å°±èƒ½ç®€å†™ï¼Œä¾‹å¦‚</p>
<pre><code class="language-haskell">-- before
ghci&gt; map (\x -&gt; negate (abs x)) [5,-3,-6,7,-3,2,-19,24]
[-5,-3,-6,-7,-3,-2,-19,-24]
-- now
ghci&gt; map (negate . abs) [5,-3,-6,7,-3,2,-19,24]
[-5,-3,-6,-7,-3,-2,-19,-24]
</code></pre>
<h2 id="6-æ¨¡å—"><a class="header" href="#6-æ¨¡å—">6. æ¨¡å—</a></h2>
<p><strong>Modules</strong></p>
<h3 id="61-å¯¼å…¥æ¨¡å—"><a class="header" href="#61-å¯¼å…¥æ¨¡å—">6.1 å¯¼å…¥æ¨¡å—</a></h3>
<ol>
<li>å¯¼å…¥</li>
</ol>
<pre><code class="language-haskell">-- 1. å¯¼å…¥ä¸€ä¸ªæ¨¡å—
ghci&gt; import Data.List
-- 2. å¯¼å…¥å¤šä¸ªæ¨¡å—
ghci&gt; :m + Data.List Data.Map Data.Set
-- 3. å¯¼å…¥æŸäº›å‡½æ•°
ghci&gt; import Data.List (nub, sort)
-- 4. ä¸å¯¼å…¥æŸäº›æŒ‡å®šçš„å‡½æ•°
ghci&gt; import Data.List hiding (nub)
</code></pre>
<ol start="2">
<li>As</li>
</ol>
<pre><code class="language-haskell">-- é¿å…é‡åï¼Œ ä½†æ˜¯ä½¿ç”¨æ—¶å¿…é¡»æŒ‡å®š Data.Map.filter
import qualified Data.Map
-- æ¢åï¼Œ å¯ä»¥ç”¨ M.filter
import qualified Data.Map as M
</code></pre>
<h3 id="62-datalist"><a class="header" href="#62-datalist">6.2 Data.List</a></h3>
<ol>
<li>
<p>intersperse</p>
<p>å‘ List ä¸­å¡«å……å…ƒç´ *, ç±»ä¼¼ä¸ python ä¸­çš„ join</p>
<pre><code class="language-haskell">ghci&gt; intersperse '.' &quot;MONKEY&quot;
&quot;M.O.N.K.E.Y&quot;
ghci&gt; intersperse 0 [1,2,3,4,5,6]
[1,0,2,0,3,0,4,0,5,0,6]
</code></pre>
</li>
<li>
<p>intercalate</p>
<p>join åè¿›è¡Œ concatï¼Œå¡«å……ååˆå¹¶è¿”å›ï¼Œ</p>
<pre><code class="language-haskell">ghci&gt; intersperse '.' &quot;MONKEY&quot;
&quot;M.O.N.K.E.Y&quot;
ghci&gt; intersperse 0 [1,2,3,4,5,6]
[1,0,2,0,3,0,4,0,5,0,6]
</code></pre>
</li>
<li>
<p>transpose</p>
<p>çŸ©é˜µè½¬ç½®</p>
<pre><code class="language-haskell">ghci&gt; transpose [[1,2,3],[4,5,6],[7,8,9]]
[[1,4,7],[2,5,8],[3,6,9]]
ghci&gt; transpose [&quot;hey&quot;,&quot;there&quot;,&quot;guys&quot;]
[&quot;htg&quot;,&quot;ehu&quot;,&quot;yey&quot;,&quot;rs&quot;,&quot;e&quot;]
</code></pre>
</li>
<li>
<p>foldl' foldl1'</p>
<p>èƒ½å¤Ÿç«‹å³è¿ç®—ï¼Œé˜²æ­¢å †æ ˆæº¢å‡º</p>
<blockquote>
<p>foldl' and foldl1' are stricter versions of their respective lazy incarnations. When using lazy folds on really big lists, you might often get a stack overflow  error. The culprit for that is that due to the lazy nature of the folds, the accumulator value isn't actually updated as the folding happens.  What actually happens is that the accumulator kind of makes a promise  that it will compute its value when asked to actually produce the result (also called a thunk). That happens for every intermediate accumulator  and all those thunks overflow your stack. The strict folds aren't lazy  buggers and actually compute the intermediate values as they go along  instead of filling up your stack with thunks. So if you ever get stack  overflow errors when doing lazy folds, try switching to their strict  versions.</p>
</blockquote>
</li>
<li>
<p>concat</p>
<p>å’Œå¹¶æ‰€æœ‰å…ƒç´ å¹¶è¿”å›</p>
<pre><code class="language-haskell">ghci&gt; concat [&quot;foo&quot;,&quot;bar&quot;,&quot;car&quot;]
&quot;foobarcar&quot;
ghci&gt; concat [[3,4,5],[2,3,4],[2,1,1]]
[3,4,5,2,3,4,2,1,1]
</code></pre>
<p><strong>concatMap == concat map</strong></p>
</li>
<li>
<p>and &amp; or</p>
<p>éœ€è¦é…åˆ map ä½¿ç”¨</p>
<blockquote>
<p>and takes a list of boolean values and returns True only if all the values in the list are True.</p>
</blockquote>
<p>å…¨ä¸ºçœŸè¿”å› True</p>
<pre><code class="language-haskell">ghci&gt; and $ map (&gt;4) [5,6,7,8]
True
ghci&gt; and $ map (==4) [4,4,4,3,4]
False
</code></pre>
<blockquote>
<p>or is like and, only it returns True if any of the boolean values in a list is True.</p>
</blockquote>
<p>æœ‰çœŸå°±è¿”å› True</p>
<pre><code class="language-haskell">ghci&gt; or $ map (==4) [2,3,4,5,6,1]
True
ghci&gt; or $ map (&gt;4) [1,2,3]
False
</code></pre>
</li>
<li>
<p>all &amp; any</p>
<p>and å’Œ or çš„æ›¿ä»£å“</p>
<pre><code class="language-haskell">ghci&gt; any (==4) [2,3,5,6,1,4]
True
ghci&gt; all (&gt;4) [6,9,10]
True
ghci&gt; all (`elem` ['A'..'Z']) &quot;HEYGUYSwhatsup&quot;
False
ghci&gt; any (`elem` ['A'..'Z']) &quot;HEYGUYSwhatsup&quot;
True
</code></pre>
</li>
<li>
<p>iterate</p>
<p>æ ¹æ®æ¯æ¬¡çš„ç»“æœç”Ÿæˆä¸‹ä¸€æ¬¡çš„å€¼</p>
<pre><code class="language-haskell">Prelude&gt; take 10 (iterate (+10) 0)
[0,10,20,30,40,50,60,70,80,90]
Prelude&gt; take 5 $ iterate (++ &quot;haha&quot;) &quot;haha&quot;
[&quot;haha&quot;,&quot;hahahaha&quot;,&quot;hahahahahaha&quot;,&quot;hahahahahahahaha&quot;,&quot;hahahahahahahahahaha&quot;]
</code></pre>
</li>
<li>
<p>splitAt</p>
<p>åˆ†å‰²ç”Ÿæˆåˆ—è¡¨</p>
<pre><code class="language-haskell">ghci&gt; splitAt 3 &quot;heyman&quot;
(&quot;hey&quot;,&quot;man&quot;)
ghci&gt; splitAt 100 &quot;heyman&quot;
(&quot;heyman&quot;,&quot;&quot;)
ghci&gt; splitAt (-3) &quot;heyman&quot;
(&quot;&quot;,&quot;heyman&quot;)
ghci&gt; let (a,b) = splitAt 3 &quot;foobar&quot; in b ++ a
&quot;barfoo&quot;
</code></pre>
</li>
<li>
<p>takeWhile &amp; dropWhile</p>
<p>æ ¹æ®æ¡ä»¶ take æˆ– drop</p>
<pre><code class="language-haskell">ghci&gt; takeWhile (&gt;3) [6,5,4,3,2,1,2,3,4,5,4,3,2,1]
[6,5,4]
ghci&gt; takeWhile (/=' ') &quot;This is a sentence&quot;
&quot;This&quot;

ghci&gt; dropWhile (/=' ') &quot;This is a sentence&quot;
&quot; is a sentence&quot;
ghci&gt; dropWhile (&lt;3) [1,2,2,2,3,4,5,4,3,2,1]
[3,4,5,4,3,2,1]
</code></pre>
</li>
<li>
<p>break &amp; span</p>
<p>å°±æ˜¯æŠŠ takeWhile çš„ååŠéƒ¨åˆ†ä¹Ÿè¿”å›äº†</p>
<pre><code class="language-haskell">ghci&gt; break (==4) [1,2,3,4,5,6,7]
([1,2,3],[4,5,6,7])
ghci&gt; span (/=4) [1,2,3,4,5,6,7]
([1,2,3],[4,5,6,7])
</code></pre>
</li>
<li>
<p>sort</p>
<p>æ’åºå‘—</p>
<pre><code class="language-haskell">ghci&gt; sort [8,5,3,2,1,6,4,2]
[1,2,2,3,4,5,6,8]
ghci&gt; sort &quot;This will be sorted soon&quot;
&quot;    Tbdeehiillnooorssstw&quot;
</code></pre>
</li>
<li>
<p>group</p>
<p>åˆ†ç»„ä½†ä¸æ’åº</p>
<pre><code class="language-haskell">ghci&gt; group [1,1,1,1,2,2,2,2,3,3,2,2,2,5,6,7]
[[1,1,1,1],[2,2,2,2],[3,3],[2,2,2],[5],[6],[7]]
</code></pre>
</li>
<li>
<p>inits &amp; tails</p>
<p>ç”Ÿæˆä¸€ä¸ªå‰ç¼€å’Œ</p>
<pre><code class="language-haskell">ghci&gt; inits &quot;w00t&quot;
[&quot;&quot;,&quot;w&quot;,&quot;w0&quot;,&quot;w00&quot;,&quot;w00t&quot;]
ghci&gt; tails &quot;w00t&quot;
[&quot;w00t&quot;,&quot;00t&quot;,&quot;0t&quot;,&quot;t&quot;,&quot;&quot;]
ghci&gt; let w = &quot;w00t&quot; in zip (inits w) (tails w)
[(&quot;&quot;,&quot;w00t&quot;),(&quot;w&quot;,&quot;00t&quot;),(&quot;w0&quot;,&quot;0t&quot;),(&quot;w00&quot;,&quot;t&quot;),(&quot;w00t&quot;,&quot;&quot;)]
</code></pre>
</li>
<li>
<p>isInfixOf &amp; isPrefixOf &amp; isSuffixOf</p>
<p>æ˜¯å¦æ˜¯ sublistï¼Œæ˜¯å¦åœ¨å¼€å¤´ï¼Œæ˜¯å¦åœ¨ç»“å°¾</p>
<pre><code class="language-haskell">ghci&gt; &quot;cat&quot; `isInfixOf` &quot;im a cat burglar&quot;
True
ghci&gt; &quot;Cat&quot; `isInfixOf` &quot;im a cat burglar&quot;
False
ghci&gt; &quot;cats&quot; `isInfixOf` &quot;im a cat burglar&quot;
False

ghci&gt; &quot;hey&quot; `isPrefixOf` &quot;hey there!&quot;
True
ghci&gt; &quot;hey&quot; `isPrefixOf` &quot;oh hey there!&quot;
False
ghci&gt; &quot;there!&quot; `isSuffixOf` &quot;oh hey there!&quot;
True
ghci&gt; &quot;there!&quot; `isSuffixOf` &quot;oh hey there&quot;
False
</code></pre>
</li>
<li>
<p>elem &amp; notElem &amp; partition</p>
</li>
</ol>
<pre><code>åˆ¤æ–­æ˜¯å¦æ˜¯ï¼Œåˆ†ä¸ºä¸¤ç»„

```haskell
ghci&gt; partition (`elem` ['A'..'Z']) &quot;BOBsidneyMORGANeddy&quot;
(&quot;BOBMORGAN&quot;,&quot;sidneyeddy&quot;)
</code></pre>
<pre><code>
17. find &amp; findIndex &amp; findIndices

</code></pre>
<p>find è¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆçš„å…ƒç´ </p>
<pre><code class="language-haskell">ghci&gt; find (&gt;4) [1,2,3,4,5,6]
Just 5
ghci&gt; find (&gt;9) [1,2,3,4,5,6]
Nothing
ghci&gt; :t find
find :: (a -&gt; Bool) -&gt; [a] -&gt; Maybe a

ghci&gt; findIndex (==4) [5,3,2,1,6,4]
Just 5
ghci&gt; findIndex (==7) [5,3,2,1,6,4]
Nothing
ghci&gt; findIndices (`elem` ['A'..'Z']) &quot;Where Are The Caps?&quot;
[0,6,10,14]
</code></pre>
<pre><code>
18. elemIndex  &amp; elemIndIces

    è¿”å›å…ƒç´ çš„ index

    ```haskell
    ghci&gt; :t elemIndex
    elemIndex :: (Eq a) =&gt; a -&gt; [a] -&gt; Maybe Int
    ghci&gt; 4 `elemIndex` [1,2,3,4,5,6]
    Just 3
    ghci&gt; 10 `elemIndex` [1,2,3,4,5,6]
    Nothing

    ghci&gt; ' ' `elemIndices` &quot;Where are the spaces?&quot;
    [5,9,13]
    ```
19. more zip

    ä¸€ç›´æä¾›åˆ° 7

    ```haskell
    ghci&gt; zipWith3 (\x y z -&gt; x + y + z) [1,2,3] [4,5,2,2] [2,2,3]
    [7,9,8]
    ghci&gt; zip4 [2,3,3] [2,2,2] [5,5,3] [2,2,2]
    [(2,2,5,2),(3,2,5,2),(3,2,3,2)]
    ```
20. line &amp; word

    line åˆ‡å‡ºæ²¡ä¸€è¡Œï¼Œword åˆ‡å‡ºæ¯ä¸ªå•è¯

    ```haskell
    ghci&gt; lines &quot;first line\nsecond line\nthird line&quot;
    [&quot;first line&quot;,&quot;second line&quot;,&quot;third line&quot;]
    ghci&gt; unlines [&quot;first line&quot;, &quot;second line&quot;, &quot;third line&quot;]
    &quot;first line\nsecond line\nthird line\n&quot;
    ghci&gt; words &quot;hey these are the words in this sentence&quot;
    [&quot;hey&quot;,&quot;these&quot;,&quot;are&quot;,&quot;the&quot;,&quot;words&quot;,&quot;in&quot;,&quot;this&quot;,&quot;sentence&quot;]
    ghci&gt; words &quot;hey these           are    the words in this\nsentence&quot;
    [&quot;hey&quot;,&quot;these&quot;,&quot;are&quot;,&quot;the&quot;,&quot;words&quot;,&quot;in&quot;,&quot;this&quot;,&quot;sentence&quot;]
    ghci&gt; unwords [&quot;hey&quot;,&quot;there&quot;,&quot;mate&quot;]
    &quot;hey there mate&quot;
    ```
21. nub

    å…ƒç´ å»é‡

    ```haskell
    ghci&gt; nub [1,2,3,4,3,2,1,2,3,4,3,2,1]
    [1,2,3,4]
    ghci&gt; nub &quot;Lots of words and stuff&quot;
    &quot;Lots fwrdanu&quot;
    ```
22. delete

    åˆ æ‰åœ°ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ 

    ```haskell
    -- delete takes an element and a list and deletes the first occurence of that element in the list.

    ghci&gt; delete 'h' &quot;hey there ghang!&quot;
    &quot;ey there ghang!&quot;
    ghci&gt; delete 'h' . delete 'h' $ &quot;hey there ghang!&quot;
    &quot;ey tere ghang!&quot;
    ghci&gt; delete 'h' . delete 'h' . delete 'h' $ &quot;hey there ghang!&quot;
    &quot;ey tere gang!&quot;
    ```
23. \\\\

</code></pre>
<p>åˆ æ‰æ›´å¤š</p>
<pre><code class="language-haskell">-- \\ is the list difference function. It acts like a set difference, basically. For every element in the right-hand list, it removes a matching element in the left one.

ghci&gt; [1..10] \\ [2,5,9]
[1,3,4,6,7,8,10]
ghci&gt; &quot;Im a big baby&quot; \\ &quot;big&quot;
&quot;Im a  baby&quot;
</code></pre>
<pre><code>
24. union

    æ±‚å¹¶é›†

    ```haskell
    ghci&gt; &quot;hey man&quot; `union` &quot;man what's up&quot;
    &quot;hey manwt'sup&quot;
    ghci&gt; [1..7] `union` [5..10]
    [1,2,3,4,5,6,7,8,9,10]
    ```
25. intersect

    æ±‚äº¤é›†

    ```haskell
    ghci&gt; [1..7] `intersect` [5..10]
    [5,6,7]
    ```
26. insert

    æ’å…¥å‘—

    ```haskell
    ghci&gt; insert 4 [3,5,1,2,8,2]
    [3,4,5,1,2,8,2]
    ghci&gt; insert 4 [1,3,4,4,1]
    [1,3,4,4,4,1]
    ```
27. deleteBy, unionBy, intersectBy and groupBy

    ä»¥ä¸€ä¸ªæ•°å¼€å§‹ï¼Œ ä»¥æ­¤æ¯”è¾ƒä»–åé¢çš„æ•°ï¼ŒçŸ¥é“ä¸åŒ¹é…ï¼Œ ç»„æˆæ•°ç»„

    æ¥ç€ä»¥ç¬¬ä¸€ä¸ªä¸åŒ¹é…çš„æ•°å¼€å§‹ï¼Œé‡å¤æ¯”è¾ƒ

    ```haskell
    ghci&gt; let values = [-4.3, -2.4, -1.2, 0.4, 2.3, 5.9, 10.5, 29.1, 5.3, -2.4, -14.5, 2.9, 2.3]
    ghci&gt; groupBy (\x y -&gt; (x &gt; 0) == (y &gt; 0)) values
    -- ä¹Ÿå¯ä»¥å†™æˆ \x y -&gt; (x &gt; 0) &amp;&amp; (y &gt; 0) || (x &lt;= 0) &amp;&amp; (y &lt;= 0)
    [[-4.3,-2.4,-1.2],[0.4,2.3,5.9,10.5,29.1,5.3],[-2.4,-14.5],[2.9,2.3]]
    ghci&gt; groupBy (\x y -&gt; (x&gt;0) == (y&lt;0)) values
    -- ç¬¬ä¸€ä¸ªæ•°å’Œåé¢çš„ç¬¦å·éƒ½ä¸åŒ
    [[-4.3],[-2.4],[-1.2,0.4,2.3,5.9,10.5,29.1,5.3],[-2.4],[-14.5,2.9,2.3]]
    ```
28. on

    è¿˜æœ‰æ›´å¥½çš„æ–¹æ³•å†™ä¸Šé¢çš„ lambada è¡¨è¾¾å¼

    on éœ€è¦ä» Data.Function å¯¼å…¥

    on æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªä¼šå¯¹å‚æ•°åšçš„è¿ç®—ï¼Œ ç¬¬ä¸€ä¸ªæ˜¯å‡½æ•°ä¼šæ¯”è¾ƒä¸¤ä¸ªè¿ç®—åç»“æœ

    ```haskell
    on :: (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
    f `on` g = \x y -&gt; f (g x) (g y)
    ```

### 6.3 Data.Char

Data.Char æä¾›äº†ä¸€ç³»åˆ—å¤„ç†å­—ç¬¦çš„å‡½æ•°ï¼Œé…åˆ map å’Œ filter ä½¿ç”¨ä¹Ÿå¯ä»¥ç”¨æ¥å¤„ç†å­—ç¬¦ä¸²

**1. åˆ¤æ–­ç±»**

1. isControl checks whether a character is a control character.
2. isSpace checks whether a character is a white-space characters. That includes spaces, tab characters, newlines, etc.
3. isLower checks whether a character is lower-cased.
4. isUpper checks whether a character is upper-cased.
5. isAlpha checks whether a character is a letter.
6. isAlphaNum checks whether a character is a letter or a number.
7. isPrint checks whether a character is printable. Control characters, for instance, are not printable.
8. isDigit checks whether a character is a digit.
9. isOctDigit checks whether a character is an octal digit.
10. isHexDigit checks whether a character is a hex digit.
11. isLetter checks whether a character is a letter.
12. isMark checks for Unicode mark characters. Those are characters that combine with preceding letters to form latters with accents. Use this if you are French.
13. isNumber checks whether a character is numeric.
14. isPunctuation checks whether a character is punctuation.
15. isSymbol checks whether a character is a fancy mathematical or currency symbol.
16. isSeparator checks for Unicode spaces and separators.
17. isAscii checks whether a character falls into the first 128 characters of the Unicode character set.
18. isLatin1 checks whether a character falls into the first 256 characters of Unicode.
19. isAsciiUpper checks whether a character is ASCII and upper-case.
20. isAsciiLower checks whether a character is ASCII and lower-case.

**2. è½¬æ¢ç±»**

1. toUpper converts a character to upper-case. Spaces, numbers, and the like remain unchanged.
2. toLower converts a character to lower-case.
3. toTitle converts a character to title-case. For most characters, title-case is the same as upper-case.
4. digitToInt converts a character to an Int. To succeed, the character must be in the ranges '0'..'9', 'a'..'f' or 'A'..'F'.
5. intToDigit is the inverse function of digitToInt. It takes an Int in the range of 0..15 and converts it to a lower-case character.
6. ord and chr convert characters to their corresponding numbers and vice versa:

   ```haskell
   ghci&gt; ord 'a'
   97
   ghci&gt; chr 97
   'a'
   ghci&gt; map ord &quot;abcdefgh&quot;
   [97,98,99,100,101,102,103,104]
</code></pre>
<ol start="7">
<li>
<p>encode</p>
<pre><code class="language-haskell">-- ä¸€ç§ç¼–ç æ–¹å¼
encode :: Int -&gt; String -&gt; String
encode shift msg =
	let ords = map ord msg
		shifted = map (+ shift) ords
	in  map chr shifted
-- å¦ä¸€ç§å®ç°
map (chr . (+ shift) . ord) msg.
-- å®ä¾‹ä»£ç 
ghci&gt; encode 3 &quot;Heeeeey&quot;
&quot;Khhhhh|&quot;
ghci&gt; encode 4 &quot;Heeeeey&quot;
&quot;Liiiii}&quot;
ghci&gt; encode 1 &quot;abcd&quot;
&quot;bcde&quot;
ghci&gt; encode 5 &quot;Marry Christmas! Ho ho ho!&quot;
&quot;Rfww~%Hmwnxyrfx&amp;%Mt%mt%mt&amp;&quot;
</code></pre>
</li>
</ol>
<h3 id="64-datamap"><a class="header" href="#64-datamap">6.4 Data.Map</a></h3>
<p>ä¸‹é¢ç»™å‡ºäº†å‡ ç§å†™ map çš„æ–¹æ³•</p>
<pre><code class="language-haskell">-- ç¬¬ä¸€ç§ filter å®ç°
findKey :: (Eq k) =&gt; k -&gt; [(k, v)] -&gt; v
findKey key xs = (snd . head . filter (\ (k, v) -&gt; key == k)) xs

-- ç¬¬äºŒç§ Maybe éç©ºæ ¡éªŒ
findKey :: (Eq k) =&gt; k -&gt; [(k, v)] -&gt; Maybe v
findKey _ [] = Nothing
findKey key ((k, v):xs) = if k == key
                                                        then Just v
                                                        else findKey key xs

-- ç¬¬ä¸‰ç§ ä½¿ç”¨ foldr è€Œéé€’å½’ï¼Œå› ä¸ºæ¯”é€’å½’çš„å¯è¯»æ€§æ›´å¥½
-- Note: It's usually better to use folds for this standard list recursion pattern instead of explicitly writing the recursion because they're easier to read and identify. Everyone knows it's a fold when they see the foldr call, but it takes some more thinking to read explicit recursion.
findKey :: (Eq k) =&gt; k -&gt; [(k,v)] -&gt; Maybe v
findKey key xs = foldr (\(k,v) acc -&gt; if key == k then Just v else acc) Nothing xs

main :: IO ()
main = do
        let phoneBook =
                [(&quot;aaa&quot;,&quot;111&quot;)
                ,(&quot;bbb&quot;,&quot;222&quot;)
                ,(&quot;ccc&quot;,&quot;333&quot;)
                ]
        print $ findKey &quot;bbb&quot; phoneBook
</code></pre>
<p>ä¸‹é¢æ˜¯ä¸€å †å‡½æ•°</p>
<ol>
<li>
<p>fromList</p>
<p>åˆ›å»ºä¸€ä¸ª Map</p>
<pre><code class="language-haskell">ghci&gt; Map.fromList [(&quot;betty&quot;,&quot;555-2938&quot;),(&quot;bonnie&quot;,&quot;452-2928&quot;),(&quot;lucille&quot;,&quot;205-2928&quot;)]
fromList [(&quot;betty&quot;,&quot;555-2938&quot;),(&quot;bonnie&quot;,&quot;452-2928&quot;),(&quot;lucille&quot;,&quot;205-2928&quot;)]
ghci&gt; Map.fromList [(1,2),(3,4),(3,2),(5,5)]
fromList [(1,2),(3,2),(5,5)]
</code></pre>
<p>è‡ªå·±å®ç°</p>
<pre><code class="language-haskell">-- We can implement our own fromList by using the empty map, insert and a fold. Watch:

fromList' :: (Ord k) =&gt; [(k,v)] -&gt; Map.Map k v
fromList' = foldr (\(k,v) acc -&gt; Map.insert k v acc) Map.empty
</code></pre>
</li>
<li>
<p>empty</p>
<p>è¿”å›ä¸€ä¸ªç©º Map</p>
<pre><code class="language-haskell">ghci&gt; Map.emptyÂ 
fromList [] Â 
</code></pre>
</li>
<li>
<p>insert</p>
<p>æ’å…¥ä¸€å¯¹ kï¼Œv</p>
<pre><code class="language-haskell">ghci&gt; Map.empty
fromList []
ghci&gt; Map.insert 3 100 Map.empty
fromList [(3,100)]
ghci&gt; Map.insert 5 600 (Map.insert 4 200 ( Map.insert 3 100  Map.empty))
fromList [(3,100),(4,200),(5,600)]
ghci&gt; Map.insert 5 600 . Map.insert 4 200 . Map.insert 3 100 $ Map.empty
fromList [(3,100),(4,200),(5,600)]
</code></pre>
</li>
<li>
<p>null</p>
<p>æ£€æŸ¥æ˜¯å¦ä¸ºç©º</p>
<pre><code class="language-haskell">ghci&gt; Map.null Map.empty
True
ghci&gt; Map.null $ Map.fromList [(2,3),(5,5)]
False
</code></pre>
</li>
<li>
<p>size</p>
<p>è¿”å› map çš„å¤§å°</p>
<pre><code class="language-haskell">ghci&gt; Map.size Map.empty
0
ghci&gt; Map.size $ Map.fromList [(2,4),(3,3),(4,2),(5,4),(6,4)]
5
</code></pre>
</li>
<li>
<p>singleton</p>
<p>é‡å»ºåªæœ‰ä¸€å¯¹ kv çš„ Map</p>
<pre><code class="language-haskell">ghci&gt; Map.singleton 3 9
fromList [(3,9)]
ghci&gt; Map.insert 5 9 $ Map.singleton 3 9
fromList [(3,9),(5,9)]
</code></pre>
</li>
<li>
<p>lookup</p>
<p>å°±æ˜¯ get</p>
<pre><code class="language-haskell">Prelude Map&gt; Map.lookup 4 a
Just 200
</code></pre>
</li>
<li>
<p>member</p>
<p>å°±æ˜¯ in</p>
<pre><code class="language-haskell">ghci&gt; Map.member 3 $ Map.fromList [(3,6),(4,3),(6,9)]
True
ghci&gt; Map.member 3 $ Map.fromList [(2,5),(4,5)]
False
</code></pre>
</li>
<li>
<p>map and filter</p>
<p>åªä½œç”¨äº v</p>
<pre><code class="language-haskell">ghci&gt; Map.map (*100) $ Map.fromList [(1,1),(2,4),(3,9)]
fromList [(1,100),(2,400),(3,900)]
ghci&gt; Map.filter isUpper $ Map.fromList [(1,'a'),(2,'A'),(3,'b'),(4,'B')]
fromList [(2,'A'),(4,'B')]
</code></pre>
</li>
<li>
<p>toList</p>
<p>å¦‚å…¶å</p>
<pre><code class="language-haskell">ghci&gt; Map.toList . Map.insert 9 2 $ Map.singleton 4 3
[(4,3),(9,2)]
</code></pre>
</li>
<li>
<p>keys and elems</p>
<p>è¿”å› keys å’Œ values</p>
</li>
<li>
<p>fromListWith</p>
<p>ç±»ä¼¼ä¸ fromListï¼Œ ä¸è¿‡æœ‰ä¸€ä¸ªå‡½æ•°å†³å®šé‡å¤çš„ key åº”è¯¥æ€ä¹ˆåŠ</p>
<pre><code class="language-haskell">-- æœ‰é‡å¤çš„é”®
phoneBook =
    [(&quot;betty&quot;,&quot;555-2938&quot;)
    ,(&quot;betty&quot;,&quot;342-2492&quot;)
    ,(&quot;bonnie&quot;,&quot;452-2928&quot;)
    ,(&quot;patsy&quot;,&quot;493-2928&quot;)
    ,(&quot;patsy&quot;,&quot;943-2929&quot;)
    ,(&quot;patsy&quot;,&quot;827-9162&quot;)
    ,(&quot;lucille&quot;,&quot;205-2928&quot;)
    ,(&quot;wendy&quot;,&quot;939-8282&quot;)
    ,(&quot;penny&quot;,&quot;853-2492&quot;)
    ,(&quot;penny&quot;,&quot;555-2111&quot;)
]
-- é‡å¤çš„é”®çš„å€¼ä¼šè¢«åŠ ä¸€èµ·
phoneBookToMap :: (Ord k) =&gt; [(k, String)] -&gt; Map.Map k String
phoneBookToMap xs = Map.fromListWith (\number1 number2 -&gt; number1 ++ &quot;, &quot; ++ number2) xs

-- æŸ¥çœ‹
ghci&gt; Map.lookup &quot;patsy&quot; $ phoneBookToMap phoneBook
&quot;827-9162, 943-2929, 493-2928&quot;
ghci&gt; Map.lookup &quot;wendy&quot; $ phoneBookToMap phoneBook
&quot;939-8282&quot;
ghci&gt; Map.lookup &quot;betty&quot; $ phoneBookToMap phoneBook
&quot;342-2492, 555-2938&quot;
</code></pre>
<p>ä¸‹é¢æ˜¯å¦å¤–ä¸¤ä¸ªä¾‹å­</p>
<pre><code class="language-haskell">ghci&gt; Map.fromListWith max [(2,3),(2,5),(2,100),(3,29),(3,22),(3,11),(4,22),(4,15)]
fromList [(2,100),(3,29),(4,22)]
ghci&gt; Map.fromListWith (+) [(2,3),(2,5),(2,100),(3,29),(3,22),(3,11),(4,22),(4,15)]
fromList [(2,108),(3,62),(4,37)]
</code></pre>
</li>
<li>
<p>insertWith</p>
<p>å·®ä¸å¤šï¼Œ æ¡ä»¶æ’å…¥</p>
<pre><code class="language-haskell">ghci&gt; Map.insertWith (+) 3 100 $ Map.fromList [(3,4),(5,103),(6,339)]
fromList [(3,104),(5,103),(6,339)]
</code></pre>
</li>
</ol>
<h3 id="65-dataset"><a class="header" href="#65-dataset">6.5 Data.Set</a></h3>
<ol>
<li>
<p>fromList</p>
<p>å»é‡</p>
<pre><code class="language-haskell">text1 = &quot;I just had an anime dream. Anime... Reality... Are they so different?&quot;
text2 = &quot;The old man left his garbage can out and now his trash is all over my lawn!&quot;
ghci&gt; let set1 = Set.fromList text1
ghci&gt; let set2 = Set.fromList text2
ghci&gt; set1
fromList &quot; .?AIRadefhijlmnorstuy&quot;
ghci&gt; set2
fromList &quot; !Tabcdefghilmnorstuvwy&quot;
</code></pre>
</li>
<li>
<p>intersection</p>
<p>æ±‚äº¤é›†</p>
<pre><code class="language-haskell">ghci&gt; Set.intersection set1 set2
fromList &quot; adefhilmnorstuy&quot;
</code></pre>
</li>
<li>
<p>difference</p>
<p>æ±‚ç¬¬ä¸€ä¸ªé›†åˆæœ‰ç¬¬äºŒä¸ªæ²¡æœ‰</p>
<pre><code class="language-haskell">ghci&gt; Set.difference set1 set2
fromList &quot;.?AIRj&quot;
ghci&gt; Set.difference set2 set1
fromList &quot;!Tbcgvw&quot;
</code></pre>
</li>
<li>
<p>union</p>
<pre><code class="language-haskell">ghci&gt; Set.union set1 set2
fromList &quot; !.?AIRTabcdefghijlmnorstuvwy&quot;
</code></pre>
</li>
<li>
<p>å…¶ä»–</p>
<p>null, size, member, empty, singleton, insert and delete å°±å’Œä½ æƒ³çš„ä¸€æ ·</p>
</li>
</ol>
<h2 id="7-è‡ªå®šä¹‰ç±»å‹"><a class="header" href="#7-è‡ªå®šä¹‰ç±»å‹">7. è‡ªå®šä¹‰ç±»å‹</a></h2>
<p>ä½¿ç”¨ data å…³é”®å­—å®šä¹‰</p>
<p>ç­‰å·å·¦è¾¹çš„æ˜¯ <strong>type name</strong>ï¼Œç­‰å¥½å³è¾¹çš„æ˜¯ <strong>value constructors</strong></p>
<pre><code class="language-haskell">data Bool = False | True
</code></pre>
<p>Int ç±»å‹å¯èƒ½æœ‰ä¸‹é¢çš„å®šä¹‰</p>
<pre><code class="language-haskell">-- çœŸå®ä¸æ˜¯è¿™æ ·çš„ï¼Œåªæ˜¯ä¸ºäº†è¯´æ˜é—®é¢˜
data Int = -2147483648 | -2147483647 | ... | -1 | 0 | 1 | 2 | ... | 2147483647
</code></pre>
<h3 id="71-åŸºæœ¬ç±»å‹å®šä¹‰"><a class="header" href="#71-åŸºæœ¬ç±»å‹å®šä¹‰">7.1 åŸºæœ¬ç±»å‹å®šä¹‰</a></h3>
<p>ä¸‹é¢è®©æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªå½¢çŠ¶çš„å®šä¹‰</p>
<p>ä¸€ä¸ªåœ†çš„å®šä¹‰å¯èƒ½éœ€è¦ä¸‰ä¸ªå‚æ•°ï¼Œå‰ä¸¤ä¸ªæ˜¯åœ†çš„åæ ‡ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯åŠå¾„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³ <code>(43.1, 55.0, 10.4)</code>è¿™æ ·å®šä¹‰ä¸€ä¸ªåœ†ï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªå‚æ•°ä¹Ÿèƒ½è¡¨ç¤ºä¸€ä¸ª 3D vector æˆ–è€…æ˜¯åˆ«çš„ä»€ä¹ˆä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ€å¥½å®šä¹‰ä¸€ä¸ªå«åš Shape çš„æ–°ç±»å‹</p>
<pre><code class="language-haskell">data Shape = Circle Float Float Float | Rectangle Float Float Float Float

ghci&gt; :t Circle
Circle :: Float -&gt; Float -&gt; Float -&gt; Shape
ghci&gt; :t Rectangle
Rectangle :: Float -&gt; Float -&gt; Float -&gt; Float -&gt; Shape
</code></pre>
<p><strong>new ä¸€ä¸ªå®ä¾‹</strong></p>
<pre><code class="language-haskell">ghci&gt; Circle 10 20 5
Circle 10.0 20.0 5.0
ghci&gt; Rectangle 50 230 60 90
Rectangle 50.0 230.0 60.0 90.0
</code></pre>
<p>type name å’Œ value constructor é¦–å­—æ¯éœ€è¦å¤§å†™</p>
<p>ä¸‹é¢å®šä¹‰äº†ä¸€ä¸ªå®Œæ•´çš„ Shape æ¨¡å—</p>
<pre><code class="language-haskell">-- Shape(..) ä¼šå°†æ‰€æœ‰çš„æ„é€ å™¨æš´éœ²ç»™å¤–éƒ¨
-- ç­‰åŒäº Shape (Rectangle, Circle)
module Shapes
( Point(..)
, Shape(..)
, surface
, nudge
, baseCircle
, baseRect
) where

-- deriving (Show) è‡ªåŠ¨å®ç° Show
data Point = Point Float Float deriving (Show)
data Shape = Circle Point Float | Rectangle Point Point deriving (Show)
surface :: Shape -&gt; Float
surface (Circle _ r) = pi * r ^ 2
surface (Rectangle (Point x1 y1) (Point x2 y2)) = (abs $ x2 - x1) * (abs $ y2 - y1)

nudge :: Shape -&gt; Float -&gt; Float -&gt; Shape
nudge (Circle (Point x y) r) a b = Circle (Point (x+a) (y+b)) r
nudge (Rectangle (Point x1 y1) (Point x2 y2)) a b = Rectangle (Point (x1+a) (y1+b)) (Point (x2+a) (y2+b))

baseCircle :: Float -&gt; Shape
baseCircle r = Circle (Point 0 0) r

baseRect :: Float -&gt; Float -&gt; Shape
baseRect width height = Rectangle (Point 0 0) (Point width height)
</code></pre>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸æš´éœ² Shapeï¼Œè®©ç”¨æˆ·åªèƒ½é€šè¿‡ baseCircleï¼ŒbaseRect æ„é€ ï¼Œè®©æˆ‘ä»¬çš„æ¥å£æ›´åŠ æŠ½è±¡</p>
<h3 id="72-record-syntax-å®šä¹‰ç±»å‹"><a class="header" href="#72-record-syntax-å®šä¹‰ç±»å‹">7.2 record syntax å®šä¹‰ç±»å‹</a></h3>
<p>ç¬¬ä¸€ç§æ–¹å¼</p>
<pre><code class="language-haskell">data Person = Person String String Int Float String String deriving (Show)
firstName :: Person -&gt; String
firstName (Person firstname _ _ _ _ _) = firstname

lastName :: Person -&gt; String
lastName (Person _ lastname _ _ _ _) = lastname

age :: Person -&gt; Int
age (Person _ _ age _ _ _) = age

height :: Person -&gt; Float
height (Person _ _ _ height _ _) = height

phoneNumber :: Person -&gt; String
phoneNumber (Person _ _ _ _ number _) = number

flavor :: Person -&gt; String
flavor (Person _ _ _ _ _ flavor) = flavor
</code></pre>
<p>ä½¿ç”¨ record syntax å®šä¹‰ Person</p>
<pre><code class="language-haskell">data Person = Person { firstName :: String
                     , lastName :: String
                     , age :: Int
                     , height :: Float
                     , phoneNumber :: String
                     , flavor :: String
                     } deriving (Show)
</code></pre>
<p>haskell ä¼šè‡ªåŠ¨ç”Ÿæˆä¸Šé¢çš„å‡½æ•°</p>
<pre><code class="language-haskell">ghci&gt; :t flavor
flavor :: Person -&gt; String
ghci&gt; :t firstName
firstName :: Person -&gt; String
</code></pre>
<p><strong>new ä¸€ä¸ªå®ä¾‹</strong></p>
<pre><code class="language-haskell">ghci&gt; Car {company=&quot;Ford&quot;, model=&quot;Mustang&quot;, year=1967}
Car {company = &quot;Ford&quot;, model = &quot;Mustang&quot;, year = 1967}
</code></pre>
<h3 id="73-ç±»å‹å‚æ•°"><a class="header" href="#73-ç±»å‹å‚æ•°">7.3 ç±»å‹å‚æ•°</a></h3>
<h4 id="731-maybe"><a class="header" href="#731-maybe">7.3.1 Maybe</a></h4>
<pre><code class="language-haskell">data Maybe a = Nothing | Just a
</code></pre>
<p><strong>ç±»å‹æ„é€ å™¨</strong></p>
<p>a æ˜¯ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œå› ä¸ºè¿™ä¸ªç±»å‹ aï¼Œæ‰€ä»¥æˆ‘ä»¬ç§° Maybe æ˜¯ä¸€ä¸ª type constructorï¼ˆç±»å‹æ„é€ å™¨ï¼‰ï¼ˆæ³¨æ„ï¼šå’Œä¹‹å‰çš„ value constructor ä¸ä¸€æ ·ï¼‰ï¼Œæ‰€ä»¥ Maybe ä¸æ˜¯ä¸€ä¸ªç±»å‹</p>
<p>æˆ‘ä»¬èƒ½å¤Ÿä¼ å…¥ Char æˆ–è€… Intï¼Œå°±èƒ½çš„åˆ°ä¸€ä¸ª Maybe Char æˆ–è€… Maybe Int ç±»å‹</p>
<h4 id="732-car"><a class="header" href="#732-car">7.3.2 Car</a></h4>
<p>ä¸‹é¢ä¸¾äº†ä¸€ä¸ª Car çš„ä¾‹å­ï¼Œä»–å°±å¯èƒ½æ˜¯ (Car String String Int) ç±»å‹</p>
<pre><code class="language-haskell">    data Car a b c = Car { company :: a
                         , model :: b
                         , year :: c
                         } deriving (Show)
</code></pre>
<p>ä½†æ˜¯ç”¨è¿™ç§å½¢å¼å£°æ˜å¹¶æ²¡æœ‰å¤ªå¤šå¥½å¤„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦ä¸€ç§çŠ¶æ€ <code>Car String String Int</code> å°±å¤Ÿäº†</p>
<p>æ‰€ä»¥æˆ‘ä»¬ä¼šç”¨ä¸‹é¢çš„æ–¹å¼</p>
<pre><code class="language-haskell">data Car = Car { company :: String
               , model :: String
               , year :: Int
               } deriving (Show)
tellCar :: Car -&gt; String
tellCar (Car {company = c, model = m, year = y}) = &quot;This &quot; ++ c ++ &quot; &quot; ++ m ++ &quot; was made in &quot; ++ show y
</code></pre>
<p>æˆ‘ä»¬ä¹‹å‰ä¹Ÿè§è¿‡ä¸€ä¸ªä½¿ç”¨ç±»å‹å‚æ•°çš„ä¾‹å­ï¼Œå°±æ˜¯ Mapï¼Œkï¼Œv åˆ†åˆ«æ˜¯ key å’Œ value çš„ç±»å‹</p>
<pre><code class="language-haskell">data (Ord k) =&gt; Map k v = ...
</code></pre>
<h4 id="733-vector"><a class="header" href="#733-vector">7.3.3 Vector</a></h4>
<pre><code class="language-haskell">data Vector2 a = Vector2 [a] [a] [a] deriving (Show)
vplus :: (Char t) =&gt; Vector2 t -&gt; Vector2 t -&gt; Vector2 t
(Vector2 a1 a2 a3) `vplus` (Vector2 b1 b2 b3) = Vector2 a1++b1 a2++b2 a3++b3
</code></pre>
<h3 id="74-æ´¾ç”Ÿå®ä¾‹"><a class="header" href="#74-æ´¾ç”Ÿå®ä¾‹">7.4 æ´¾ç”Ÿå®ä¾‹</a></h3>
<p><strong>Derived instances</strong></p>
<h4 id="741-derive"><a class="header" href="#741-derive">7.4.1 derive</a></h4>
<p>Typeclasses æ›´åƒæ˜¯æ¥å£ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>derive</code> å…³é”®å­—å¯ä»¥è‡ªåŠ¨æ´¾ç”Ÿå‡ºè¡Œä¸º</p>
<pre><code class="language-haskell">    data Person = Person { firstName :: String
                         , lastName :: String
                         , age :: Int
                         } deriving (Eq, Show, Read)
</code></pre>
<p>è¯¥ç±»å‹æ´¾ç”Ÿè‡ª Eqï¼Œæ‰€ä»¥å®ç°äº† <code>==</code> å’Œ <code>/=</code>, è¿˜èƒ½å¤Ÿåº”ç”¨åœ¨ä»»ä½•åœ¨ç±»å‹ç­¾åä¸Šå…·æœ‰ <code>Eq a</code> çš„å‡½æ•°</p>
<pre><code class="language-haskell">ghci&gt; let mikeD = Person {firstName = &quot;Michael&quot;, lastName = &quot;Diamond&quot;, age = 43}
ghci&gt; let adRock = Person {firstName = &quot;Adam&quot;, lastName = &quot;Horovitz&quot;, age = 41}
ghci&gt; let mca = Person {firstName = &quot;Adam&quot;, lastName = &quot;Yauch&quot;, age = 44}
ghci&gt; mca == adRock
False
ghci&gt; mikeD == Person {firstName = &quot;Michael&quot;, lastName = &quot;Diamond&quot;, age = 43}
True
</code></pre>
<p>Read å’Œ Show èƒ½å®ç°ç±»å‹å’Œå­—ç¬¦ä¸²é—´çš„ç›¸äº’è½¬åŒ–ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ Read æ—¶ï¼Œéœ€è¦æŒ‡å®šç»“æœçš„ç±»å‹</p>
<pre><code class="language-haskell">ghci&gt; read &quot;Person {firstName =\&quot;Michael\&quot;, lastName =\&quot;Diamond\&quot;, age = 43}&quot; :: Person
Person {firstName = &quot;Michael&quot;, lastName = &quot;Diamond&quot;, age = 43}
</code></pre>
<p>å¶ä»¬ä¹Ÿèƒ½å¤Ÿè¯»å–å‚æ•°åŒ–ç±»å‹ï¼ˆparameterized typesï¼‰ï¼Œä½†æ˜¯å¿…é¡»å¡«ä¸Šç±»å‹</p>
<pre><code class="language-haskell">-- So we can't do
read &quot;Just 't'&quot; :: Maybe a
-- but we can do
read &quot;Just 't'&quot; :: Maybe Char
</code></pre>
<h4 id="742-å®ç°ä¸€äº›-typeclasses"><a class="header" href="#742-å®ç°ä¸€äº›-typeclasses">7.4.2 å®ç°ä¸€äº› Typeclasses</a></h4>
<ol>
<li>
<p>Ord çš„æ¯”è¾ƒè§„åˆ™ï¼Œåœ¨å‰é¢çš„æ¯”è¾ƒå°ï¼Œä¸ Char æ¯”è¾ƒæ— å…³</p>
<pre><code class="language-haskell">data Day = Monday | Tuesday | Wednesday | Thursday | Friday | Saturday | Sunday deriving (Eq, Ord, Show, Read, Bounded, Enum)

ghci&gt; Saturday &gt; Friday
True
</code></pre>
</li>
</ol>
<h4 id="743-ç±»å‹åŒä¹‰è¯"><a class="header" href="#743-ç±»å‹åŒä¹‰è¯">7.4.3 ç±»å‹åŒä¹‰è¯</a></h4>
<p><strong>Type synonyms</strong></p>
<p>å°±æ˜¯æ¢ä¸ªåè€Œå·²</p>
<pre><code class="language-haskell">-- ä¸‹é¢æ˜¯ String çš„å®šä¹‰
type String = [Char]

type IntMap v = Map Int v
type IntMap = Map Int
</code></pre>
<p>éœ€è¦åˆ†æ¸…ç±»å‹æ„é€ å™¨å’Œå€¼æ„é€ å™¨ï¼ˆtype constructors and value constructorsï¼‰çš„åŒºåˆ«</p>
<h4 id="744-either"><a class="header" href="#744-either">7.4.4 Either</a></h4>
<p>ä¸‹é¢æˆ‘ä»¬åœ¨ä»‹ç»ä¸€ç§ç±»å‹ Either</p>
<pre><code class="language-haskell">-- å®šä¹‰
data Either a b = Left a | Right b deriving (Eq, Ord, Read, Show)
</code></pre>
<blockquote>
<p>So far, we've seen that Maybe a was mostly used to represent the results of computations that could have either failed or not. But somtimes, Maybe a isn't good enough because Nothing doesn't really convey much information other than that something has  failed. That's cool for functions that can fail in only one way or if  we're just not interested in how and why they failed. A Data.Map lookup fails only if the key we were looking for wasn't in the map, so  we know exactly what happened. However, when we're interested in how  some function failed or why, we usually use the result type of Either a b, where a is some sort of type that can tell us something about the possible failure and b is the type of a successful computation. Hence, errors use the Left value constructor while results use Right.</p>
</blockquote>
<p>Maybe ä¸èƒ½æ»¡è¶³æ‰€æœ‰çš„éœ€è¦ï¼ŒEither é€šå¸¸ç”¨äºé”™è¯¯å¤„ç†ï¼Œå·¦å€¼ä¸€èˆ¬è¡¨ç¤ºé”™è¯¯åŸå› ï¼Œå³å€¼ä¸€èˆ¬æ˜¯æ­£ç¡®çš„ç»“æœ</p>
<p>ä¸‹é¢ç»™é™¤äº†ä¸€ä¸ªä¾‹å­</p>
<pre><code class="language-haskell">import qualified Data.Map as Map

-- declear LockerMap
data LockerState = Taken | Free deriving (Show, Eq)
type Code = String
type LockerMap = Map.Map Int (LockerState, Code)

-- give a LoockerLookUp function
lockerLookUp :: Int -&gt; LockerMap -&gt; Either String Code
lockerLookUp lockerNum map = case Map.lookup lockerNum map of
        Nothing  -&gt; Left $ &quot;Locker Number&quot; ++ show lockerNum ++ &quot;doesn't exist&quot;
        Just (lockerState, code) -&gt; if lockerState == Taken
                                 then Left $ &quot;Locker Number&quot; ++ show lockerNum ++ &quot;is already taken!&quot;
                                 else Right code

main = do
    let lockers = Map.fromList[(1, (Taken, &quot;aaa&quot;)),(2, (Free, &quot;bbb&quot;)),(3, (Taken, &quot;ccc&quot;))]
    print $ lockerLookUp 1 lockers
    print $ lockerLookUp 2 lockers
    print $ lockerLookUp 3 lockers
    print $ lockerLookUp 4 lockers

</code></pre>
<h4 id="745-é€’å½’"><a class="header" href="#745-é€’å½’">7.4.5 é€’å½’</a></h4>
<p>ä¸‹é¢çš„ä¾‹å­å®ç°äº†ä¸€ä¸ª List å’Œä¸€ä¸ª Tree</p>
<pre><code class="language-haskell">infixr 5 :-:
data List a = Empty | a :-: (List a) deriving (Show, Read, Ord, Eq)
-- æˆ–è€…æ˜¯ record syntex
-- data Lsit = Empty | Cons {listHead :: a, listTail :: List a} deriving (Show, Read, Eq, Ord)

-- infixr 5 ++
-- (++) :: [a] -&gt; [a] -&gt; [a]
-- [] ++ ys = ys
-- (x:xs) ++ ys = x:(xs ++ ys)
infixr 5 .++
(.++) :: List a -&gt; List a -&gt; List a
Empty .++ ys = ys
(x :-: xs) .++ ys = x :-: (xs .++ ys)

data Tree a = EmptyTree | Node a (Tree a) (Tree a) deriving (Show, Read, Eq, Ord)

singleton :: a -&gt; Tree a
singleton x = Node x EmptyTree EmptyTree

treeInsert :: (Ord a) =&gt; a -&gt; Tree a -&gt; Tree a
treeInsert x EmptyTree = singleton x
treeInsert x (Node a left right)
    | x == a = Node x left right
    | x  &lt; a = Node a (treeInsert x left) right
    | x  &gt; a = Node a left (treeInsert x right)

treeElem :: (Ord) a =&gt; a -&gt; Tree a -&gt; Bool
treeElem x EmptyTree = False
treeElem x (Node a left right)
    | x == a = True
    | x &lt; a = treeElem x left
    | x &gt; a = treeElem x right


main = do
    putStrLn &quot;start...&quot;
    let a = 3 :-: 4 :-: 5 :-: Empty
    print a
    let b = 6 :-: 7 :-: Empty
    print(a .++ b)
    let nums = [8, 6, 4, 1, 3, 5]
    let numsTree = foldr treeInsert EmptyTree nums
    print numsTree
    print $ treeElem 4 numsTree
    putStrLn &quot;end...&quot;

</code></pre>
<h4 id="746-typeclasses-102"><a class="header" href="#746-typeclasses-102">7.4.6 Typeclasses 102</a></h4>
<blockquote>
<p>A quick recap on typeclasses: typeclasses are like interfaces. A  typeclass defines some behavior (like comparing for equality, comparing  for ordering, enumeration) and then types that can behave in that way  are made instances of that typeclass. The behavior of typeclasses is  achieved by defining functions or just type declarations that we then  implement. So when we say that a type is an instance of a typeclass, we  mean that we can use the functions that the typeclass defines with that  type.</p>
</blockquote>
<p>å¯¹ typeclasses çš„ç®€è¦å›é¡¾ï¼štypeclasses å°±åƒæ¥å£ã€‚ä¸€ä¸ª typeclasses å®šä¹‰äº†ä¸€äº›è¡Œä¸ºï¼ˆæ¯”å¦‚æ¯”è¾ƒï¼Œæ’åºï¼‰ï¼Œå¯ä»¥å®ç°è¿™äº›è¡Œä¸ºçš„ç±»å‹å°±æ˜¯è¿™äº› typeclass çš„å®ä¾‹ï¼Œé€šè¿‡å®šä¹‰å‡½æ•°æˆ–è€…å£°æ˜å»å®ç°è¿™äº›è¡Œä¸ºï¼Œå› æ­¤ï¼Œå½“æˆ‘ä»¬è¯´ç±»å‹æ˜¯ç±»å‹çš„ä¸€ä¸ªç±»å‹çš„å®ä¾‹æ—¶ï¼Œæˆ‘ä»¬çš„æ„æ€æ˜¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ TypeClass å®šä¹‰è¯¥ç±»å‹çš„å‡½æ•°ã€‚</p>
<pre><code class="language-haskell">-- ä½¿ç”¨ :info Num å¯ä»¥æŸ¥çœ‹ typeclass å®šä¹‰
Prelude&gt; :info Num
type Num :: * -&gt; Constraint
class Num a where
  (+) :: a -&gt; a -&gt; a
  (-) :: a -&gt; a -&gt; a
  (*) :: a -&gt; a -&gt; a
  negate :: a -&gt; a
  abs :: a -&gt; a
  signum :: a -&gt; a
  fromInteger :: Integer -&gt; a
  {-# MINIMAL (+), (*), abs, signum, fromInteger, (negate | (-)) #-}
        -- Defined in â€˜GHC.Numâ€™
instance Num Word -- Defined in â€˜GHC.Numâ€™
instance Num Integer -- Defined in â€˜GHC.Numâ€™
instance Num Int -- Defined in â€˜GHC.Numâ€™
instance Num Float -- Defined in â€˜GHC.Floatâ€™
instance Num Double -- Defined in â€˜GHC.Floatâ€™

</code></pre>
<p><strong>1. å®šä¹‰ typeclasses</strong></p>
<p>ä¸‹é¢æ˜¯ Eq åœ¨æ ‡å‡†åº“çš„å®šä¹‰</p>
<pre><code class="language-haskell">class Eq a where
    (==) :: a -&gt; a -&gt; Bool
    (/=) :: a -&gt; a -&gt; Bool
    x == y = not (x /= y)
    x /= y = not (x == y)
</code></pre>
<p>class å®šä¹‰äº†ä¸€ä¸ª typeclassï¼ŒEq æ˜¯åå­—ï¼Œa æ˜¯å®ä¾‹ï¼Œa åªè¦æ˜¯ä¸€ä¸ªå°å†™çš„å•è¯å°±è¡Œ</p>
<p>æ¥ç€æˆ‘ä»¬å®šä¹‰äº†ä¸€äº›å‡½æ•°ï¼Œåœ¨ class é‡Œå®ç°å‡½æ•°ä¸æ˜¯å¼ºåˆ¶çš„ï¼Œåªéœ€è¦ä¸€ä¸ªå®šä¹‰å°±å¤Ÿäº†</p>
<blockquote>
<p>Some people might understand this better if we wrote class Eq equatable where and then specified the type declarations like <code>(==) :: equatable -&gt; equatable -&gt; Bool</code>.</p>
<p>è¿™ç§å†™æ³•å¯èƒ½æ›´å¥½ç†è§£ï¼š<code>(==) :: equatable -&gt; equatable -&gt; Bool</code></p>
</blockquote>
<blockquote>
<p>If we have say class Eq a where and then define a type declaration within that class like (==) :: a -&gt; -a -&gt; Bool, then when we examine the type of that function later on, it will have the type of <code>(Eq a) =&gt; a -&gt; a -&gt; Bool</code>.</p>
<p>å½“æˆ‘ä»¬åœ¨ class ä¸­å®šä¹‰è¿™ä¸ªå‡½æ•°åï¼Œåœ¨æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„ç±»å‹æ—¶ï¼Œå°±ä¼šæ˜¾ç¤ºå‡º typeclasses</p>
</blockquote>
<p><strong>2. å®ç° typeclass</strong></p>
<p>ä¸‹é¢æˆ‘ä»¬å®ç°ä¸€ä¸ª <code>TrafficLight</code></p>
<pre><code class="language-haskell">data TrafficLight = Red | Yellow | Green
-- å®ç°æ¯”è¾ƒ
instance Eq TrafficLight where
    Red == Red = True
    Green == Green = True
    Yellow == Yellow = True
    _ == _ = False
-- æ‰‹åŠ¨å®ç°å­—ç¬¦ä¸²è½¬æ¢
instance Show TrafficLight where
    show Red = &quot;Red light&quot;
    show Yellow = &quot;Yellow light&quot;
    show Green = &quot;Green light&quot;
main = do
    putStrLn &quot;start...&quot;
    print $ Red == Red
    print $ show [Red, Yellow, Green]
</code></pre>
<p><strong>3. subtypeclasses</strong></p>
<p>ä¸‹é¢æ˜¯ Num åœ¨æ ‡å‡†åº“ä¸­çš„å®šä¹‰ï¼ˆç¬¬ä¸€è¡Œï¼‰</p>
<pre><code class="language-haskell">class (Eq a) =&gt; Num a where
</code></pre>
<p>åœ¨å®ç° Num å‰ï¼Œå¿…é¡»ä¿è¯ a å®ç°äº† Eq</p>
<p><strong>å¯¹äºå¤šæ€ç±»å‹</strong></p>
<pre><code class="language-haskell">instance Eq (Maybe m) where
    Just x == Just y = x == y
    Nothing == Nothing = True
    _ == _ = False

</code></pre>
<p>ä¸Šé¢çš„ä¾‹å­å¥½åƒè§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½ç¡®å®š m çš„ç±»å‹å®ç°äº† Eqï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥ä¿®æ”¹ä¸Šé¢çš„å£°æ˜ï¼š</p>
<pre><code class="language-haskell">instance (Eq m) =&gt; Eq (Maybe m) where
	Just x == Just y = x == y
	Nothing == Nothing = True
	_ == _ = False
</code></pre>
<p>è¿™æ¬¡æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªç±»å‹é™å®šï¼Œæˆ‘ä»¬é™å®šäº†æ‰€æœ‰ Maybe m ç±»å‹éƒ½æ˜¯ Eqï¼Œé™¤é m ä¹Ÿæ˜¯ Eq</p>
<p>ğŸ</p>
<blockquote>
<p>Take into account that the type you're trying to make an instance of will replace the parameter in the <em>class</em> declaration. The a from class Eq a where will be replaced with a real type when you make an instance, so try  mentally putting your type into the function type declarations as well. (==) :: Maybe -&gt; Maybe -&gt; Bool doesn't make much sense but (==) :: (Eq m) =&gt; Maybe m -&gt; Maybe m -&gt; Bool does. But this is just something to think about, because == will always have a type of (==) :: (Eq a) =&gt; a -&gt; a -&gt; Bool, no matter what instances we make.</p>
<p>ä¸€å®šè¦ æ³¨æ„ 'a' åœ¨å®ç°æ—¶éœ€è¦è¢«æ›¿æ¢ä¸º concrete type</p>
</blockquote>
<p><strong>4. å®ç°ä¸€ä¸ªç©å…·</strong></p>
<p>åœ¨ js ä¸­ï¼Œä»»ä½•éç©ºç±»å‹éƒ½è¢«å½“æˆæ˜¯ true</p>
<pre><code class="language-js">if (0) alert(&quot;YEAH!&quot;) else alert(&quot;NO!&quot;)
if (&quot;&quot;) alert (&quot;YEAH!&quot;) else alert(&quot;NO!&quot;)
if (false) alert(&quot;YEAH&quot;) else alert(&quot;NO!)
//etc. and all of these will throw an alert of NO!. If you do
if (&quot;WHAT&quot;) alert (&quot;YEAH&quot;) else alert(&quot;NO!&quot;)
// it will alert a &quot;YEAH!&quot;
</code></pre>
<p><em>A yesno typeclass</em></p>
<pre><code class="language-haskell">class YesNo a where
    yesno :: a -&gt; Bool

instance YesNo Int where
    yesno 0 = False
    yesno _ = True

instance YesNo [a] where
    yesno [] = False
    yesno _ = True

-- Bool ä¹Ÿä¸è¦å¿˜äº†
instance YesNo Bool where
    yesno = id

-- å› ä¸ºæˆ‘ä»¬å¹¶ä¸å…³å¿ƒ Maybe åŒ…å«ä»€ä¹ˆç±»å‹ï¼Œåªè¦ä»–æœ‰ä¸œè¥¿å°±è¡Œäº†ï¼Œæ‰€ä»¥æ²¡æœ‰åŠ ç±»å‹é™å®š
instance YesNo (Maybe a) where
    yesno (Just _) = True
    yesno Nothing = False

-- ä»¿ç…§ç€å†™ä¸€ä¸ª if
yesnoIf :: (YesNo a) =&gt; a -&gt; b -&gt; b -&gt; b
yesnoIf a onyes onno = if yesno a then onyes else onno

main :: IO ()
main = do
    putStrLn &quot;start...&quot;
    print $ length []
    print $ yesno [0]
    print $ yesno Nothing
    print $ yesno True
    putStrLn $ yesnoIf (Just 1) &quot;yes !&quot; &quot;No -_-&quot;

</code></pre>
<h4 id="747-functor-å’Œ-kinds"><a class="header" href="#747-functor-å’Œ-kinds">7.4.7 Functor å’Œ Kinds</a></h4>
<p><strong>1. ä»€ä¹ˆæ˜¯ Kind</strong></p>
<blockquote>
<p>We used :k on a type to get its kind, just like we can use :t on a value to get its type. Like we said, types are the labels of  values and kinds are the labels of types and there are parallels between the two.</p>
</blockquote>
<p>æˆ‘ä»¬èƒ½ç”¨ <code>:t</code> æŸ¥çœ‹ä¸€ä¸ªå€¼ (value) çš„ç±»å‹ (type)</p>
<pre><code class="language-haskell">-- '=&gt;'æ˜¯ç±»å‹é™å®š !!!
Prelude&gt; :t 1
1 :: Num p =&gt; p

Prelude&gt; :t [1, 2]
[1, 2] :: Num a =&gt; [a]

Prelude&gt; :t Just 1
Just 1 :: Num a =&gt; Maybe a
</code></pre>
<p>ä¹Ÿèƒ½ç”¨ <code>:k</code> æŸ¥çœ‹ä¸€ä¸ªç±»å‹ (type) çš„ Kind</p>
<pre><code class="language-haskell">Prelude&gt; :k Int
Int :: *

Prelude&gt; :k Num
Num :: * -&gt; Constraint

Prelude&gt; :k Maybe
Maybe :: * -&gt; *

Prelude&gt; :k Either
Either :: * -&gt; * -&gt; *

Prelude&gt; :k Functor
Functor :: (* -&gt; *) -&gt; Constraint
</code></pre>
<p><strong>'*' æ˜¯ä»€ä¹ˆ</strong></p>
<blockquote>
<p>A * means that the type is a concrete type. A concrete type is a type that doesn't take any type parameters and  values can only have types that are concrete types. If I had to read * out loud (I haven't had to do that so far), I'd say <em>star</em> or just <em>type</em>.</p>
</blockquote>
<p><code>*</code> å°±æ˜¯ä¸€ä¸ªå›ºå®šçš„ç±»å‹ï¼Œä¸èƒ½æºå¸¦ Type parameter</p>
<p><code>* -&gt; *</code> å°±æ˜¯æ¥å—ä¸€ä¸ª type parameterï¼Œè¿”å›ä¸€ä¸ªç±»å‹ï¼Œæ¯”å¦‚ Maybe å’Œ Maybe Int</p>
<p><code>* -&gt; * -&gt; *</code> åŒç†</p>
<p>æ‰€ä»¥ Functor çš„ç±»å‹å°±å¥½ç†è§£äº†</p>
<pre><code class="language-haskell">class Functor f where
    fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
<p><strong>2. ä»€ä¹ˆæ˜¯ Functor</strong></p>
<p>çœ‹ä¸€çœ¼ fmap çš„å®šä¹‰ï¼Œå®ç°äº† Functor çš„ç±»å‹ï¼Œfmap èƒ½å¤ŸæŠŠè¿™äº›ç±»å‹<em>é‡Œé¢</em>çš„ä¸œè¥¿è½¬æ¢åˆ°å¦ä¸€ç§ä¸œè¥¿ï¼Œå°±æ˜¯è¯´ fmap åªä½œç”¨äº box é‡Œé¢çš„ä¸œè¥¿</p>
<pre><code class="language-haskell">class Functor f where
    fmap :: (a -&gt; b) -&gt; f a -&gt; f b
</code></pre>
<p>è¿™ä¸ªæ˜¯ map çš„å®šä¹‰</p>
<pre><code class="language-haskell">map :: (a -&gt; b) -&gt; [a] -&gt; [b]
</code></pre>
<p>map å°±æ˜¯ç‰¹æ®ŠåŒ–çš„ fmap ,åªèƒ½ç”¨äº [],ä¸èƒ½ç”¨äº Maybe, Ehther ç­‰ç±»å‹</p>
<blockquote>
<p>anything like a box that can hold something can impl Functor, lsuch as Maybe, [], Tree = Empty | Tree a left rght, Either</p>
</blockquote>
<p>æ‰€æœ‰èƒ½å¤Ÿæ‰¿è½½å…¶ä»–ç±»å‹çš„ä¸œè¥¿éƒ½èƒ½å®ç° Functorï¼Œæ¯”å¦‚ Maybe, [], Tree, Either</p>
<p>ä¸‹é¢æ˜¯å…³äº Either çš„ Functor å®ç°</p>
<pre><code class="language-haskell">instance Functor (Either a) where
    fmap f (Right x) = Right (f x)
    fmap f (Left x) = Left x
-- (b -&gt; c) -&gt; Either a b -&gt; Ether a c
-- å’Œä¸‹é¢çš„ä¸€æ ·
-- (b -&gt; c) -&gt; (Either a) b -&gt; (Either a) c
</code></pre>
<blockquote>
<p>-- in this case, we only mapped the right value constructor,
-- well, if we look at the define of Either:
-- data Either a b = Left a | Right b
-- we can't make sure f can handle both type a and type b
-- Another example is Map.Map, where fmap just map a function v -&gt; v' over a Map k v, and return Map k v'</p>
</blockquote>
<p>åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬åª map äº† Either çš„å³å€¼ï¼Œå› ä¸ºä¸èƒ½ä¿è¯ Either a b çš„ç±»å‹ç›¸åŒï¼ŒMap.Map ä¹Ÿæ˜¯ï¼Œåªæœ‰ value æ”¹å˜</p>
<p><strong>3. å®ç°ä¸€ä¸ª Tofu</strong></p>
<pre><code class="language-haskell">class Tofu t where
    tofu :: j a -&gt; t a j

data Frank a b = Frank {frankField :: b a} deriving (Show)

instance Tofu Frank where
    tofu x = Frank x

data Barry t k p = Barry { yabba :: p, dabba :: t k }

instance Functor (Barry a b) where
    fmap f (Barry { yabba = x, dabba = y }) = Barry {yabba = f x, dabba = y }

main :: IO ()
main = do
    let a = Frank { frankField = Just 'c' }
    print a
    let b = tofu (Just 'a') :: Frank Char Maybe
    print b
    let c = tofu [&quot;Hello&quot;] :: Frank [Char] []
    print c
    putStrLn &quot;start...&quot;
</code></pre>
<h2 id="8-io"><a class="header" href="#8-io">8. IO</a></h2>
<h3 id="81-cmd-å‚æ•°"><a class="header" href="#81-cmd-å‚æ•°">8.1 cmd å‚æ•°</a></h3>
<pre><code class="language-haskell">import System.Environment
import Data.List

main = do
    -- è·å–å‚æ•°
    args &lt;- getArgs
    -- è·å–åå­—
    progName &lt;- getProgName
    putStrLn progName
    mapM_ putStrLn args

</code></pre>
<h3 id="82-è¾“å…¥"><a class="header" href="#82-è¾“å…¥">8.2 è¾“å…¥</a></h3>
<ol>
<li>
<p>è·å–è¾“å…¥</p>
<pre><code class="language-haskell">main = do
    putStrLn &quot;start...&quot;
    -- è·å–è¾“å…¥æ•°æ®
    line &lt;- getLine
    -- åˆ¤æ–­ä¸ä¸ºç©ºå°±åè½¬
    if null line
        then return ()
        else do
            putStrLn $ reverseWords line
            main
reverseWords :: String -&gt; String
reverseWords = unwords . map reverse . words
</code></pre>
</li>
<li>
<p>æ–‡ä»¶äº¤äº’</p>
</li>
</ol>
<ul>
<li>openFile (fileName, openMode): æ‰“å¼€æ–‡ä»¶è¿”å› handle å¯¹è±¡</li>
<li>hGetContents (handle)ï¼šè¯»å–æ–‡ä»¶å†…å®¹</li>
<li>with è¯­æ³•</li>
<li>appendFile(fileName, content)ï¼šè¿½åŠ å†…å®¹</li>
<li>readBuffer: è®¾ç½®ç¼“å†²åŒº</li>
</ul>
<pre><code class="language-haskell">import System.IO

main = do
    handle &lt;- openFile &quot;haiku.txt&quot; ReadMode
    -- Lazy, don't read and stored in memory an once
    contents &lt;- hGetContents handle
    putStrLn contents
    hClose handle

    withFile &quot;haiku.txt&quot; ReadMode (\handle -&gt; do
    contents &lt;- hGetContents handle
    putStrLn contents)

    -- withOpen's define
    -- openFle :: FilePath -&gt; IOMode -&gt; (Handle -&gt; IO a) -&gt; IO a
    -- openFile path mode f = do
    --     handle &lt;- openFile path mode
    --     result &lt;- f handle
    --     hClose f
    --     return result

    -- More function
    -- hGetLine hPutStr hPutStrLn hGetChar
    contents &lt;- readFile &quot;todo.txt&quot;
    putStrLn contents

    todo &lt;- getLine
    appendFile &quot;todo.txt&quot; $ todo ++ &quot;\n&quot;

    -- set buffering manualy
    -- BufferMode = NoBuffering | LineBuffering | BlockBuffering (Maybe Int)
    withFile &quot;todo.txt&quot; ReadMode (\handle -&gt; do
        hSetBuffering handle $ BlockBuffering (Just 2)
        contents &lt;- hGetContents handle
        putStrLn contents)
    -- read file in big chunks can help to minimize disk access or when our file is actually a slow network resource
</code></pre>
<h3 id="83-å¾ªç¯"><a class="header" href="#83-å¾ªç¯">8.3. å¾ªç¯</a></h3>
<ol>
<li>forever(loop)</li>
</ol>
<pre><code class="language-haskell">import Control.Monad
import Data.Char

main = forever $ do
    putStr &quot;Give a input: &quot;
    l &lt;- getLine
    putStrLn $ map toUpper l
</code></pre>
<ol start="2">
<li>when(while)</li>
</ol>
<pre><code class="language-haskell">import Control.Monad

main = do
  return ()
  -- aaa &lt;- return &quot;aaavvv&quot;
  -- putStrLn aaa

  c &lt;- getChar
  when (c /= ' ') $ do
    putChar c
    main
</code></pre>
<h3 id="84-map-io-action"><a class="header" href="#84-map-io-action">8.4 map IO action</a></h3>
<p>mapM &amp; mapM_ &amp; sequence</p>
<pre><code class="language-haskell">main = do
  -- 1.1 sequence can run erery IO action in it, and return their result as a list
  -- rs &lt;- sequence [getLine, getLine, getLine]
  -- print rs

  -- 1.2
  -- map print [1, 2, 3]
  -- [print 1, print 2, print 3]
  res &lt;- sequence $ map print [1, 2, 3]
  -- `print 1` just return a `()`
  -- so res is [(), (), ()]
  print res

  -- 2.1 mapM can be used to map a function that return IO action
  mapm &lt;- mapM print [1, 2, 3]
  print mapm
  -- 2.2 mapM_ just abundon the results
  mapm_ &lt;- mapM_ print [1, 2, 3]
  print mapm_
</code></pre>
<h3 id="86-todo-list"><a class="header" href="#86-todo-list">8.6 todo list</a></h3>
<pre><code class="language-haskell">import Data.List
import System.Directory
import System.Environment
import System.IO

dispatch :: [(String, [String] -&gt; IO ())]
dispatch =
  [ (&quot;add&quot;, add),
    (&quot;view&quot;, view),
    (&quot;remove&quot;, remove)
  ]

main = do
  (command : args) &lt;- getArgs
  let (Just action) = lookup command dispatch
  action args

add :: [String] -&gt; IO ()
add [fileName, todoItem] = appendFile fileName (todoItem ++ &quot;\n&quot;)
add _ = putStrLn &quot;Plz input [filename, todoItem]&quot;

view :: [String] -&gt; IO ()
view [fileName] = do
  contents &lt;- readFile fileName
  let todoTasks = lines contents
      numberedTasks = zipWith (\n line -&gt; show n ++ &quot; - &quot; ++ line) [0 ..] todoTasks
  putStr $ unlines numberedTasks
view _ = putStrLn &quot;Plz input [filename]&quot;

remove :: [String] -&gt; IO ()
remove [fileName, numberString] = do
  handle &lt;- openFile fileName ReadMode
  (tempName, tempHandle) &lt;- openTempFile &quot;.&quot; &quot;temp&quot;
  contents &lt;- hGetContents handle
  let number = read numberString
      todoTasks = lines contents
      newTodoItems = delete (todoTasks !! number) todoTasks
  hPutStr tempHandle $ unlines newTodoItems
  hClose handle
  hClose tempHandle
  removeFile fileName
  renameFile tempName fileName
remove _ = putStrLn &quot;Plz input [filename, numberString]&quot;
</code></pre>
<h3 id="87-error-handle"><a class="header" href="#87-error-handle">8.7 Error Handle</a></h3>
<ol>
<li>try &amp; catch</li>
</ol>
<pre><code class="language-haskell">import Control.Exception
import System.Environment
import System.IO
import System.IO.Error

main = toTry `catch` handler

toTry :: IO ()
toTry = do
  (fileName : _) &lt;- getArgs
  contents &lt;- readFile fileName
  putStrLn $ &quot;The file has &quot; ++ show (length (lines contents)) ++ &quot; lines!&quot;

handler :: IOError -&gt; IO ()
handler e = putStrLn &quot;Whoops, had some trouble!&quot;

-- main = do
--   toTry `catch` handler1
--   thenTryThis `catch` handler2
--   launchRockets
</code></pre>
<ol start="2">
<li>error kind</li>
</ol>
<pre><code class="language-haskell">
import System.Environment
import System.IO
import System.IO.Error
import Control.Exception

main = toTry `catch` handler

toTry :: IO ()
toTry = do (fileName:_) &lt;- getArgs
           contents &lt;- readFile fileName
           putStrLn $ &quot;The file has &quot; ++ show (length (lines contents)) ++ &quot; lines!&quot;

handler :: IOError -&gt; IO ()
handler e
    | isDoesNotExistError e = putStrLn &quot;The file doesn't exist!&quot;
    | otherwise = ioError e

-- isAlreadyExistsError
-- isDoesNotExistError
-- isAlreadyInUseError
-- isFullError
-- isEOFError
-- isIllegalOperation
-- isPermissionError
-- isUserError
</code></pre>
<h2 id="9-solve-some-problems"><a class="header" href="#9-solve-some-problems">9. Solve Some Problems</a></h2>
<h3 id="91-è®¡ç®—åç¼€è¡¨è¾¾å¼"><a class="header" href="#91-è®¡ç®—åç¼€è¡¨è¾¾å¼">9.1 è®¡ç®—åç¼€è¡¨è¾¾å¼</a></h3>
<pre><code class="language-haskell">import Data.List

solveRPN :: (Num a, Read a) =&gt; String -&gt; a
solveRPN = head . foldl foldingFunction [] . words
    where
        foldingFunction (x:y:ys) &quot;*&quot; = (x * y):ys
        foldingFunction (x:y:ys) &quot;+&quot; = (x + y):ys
        foldingFunction (x:y:ys) &quot;-&quot; = (x - y):ys
        foldingFunction xs numString = read numString:xs

solveRPN2 :: (Num a, Read a, Floating a) =&gt; String -&gt; a
solveRPN2 = head . foldl foldingFunction [] . words
    where
        foldingFunction (x:y:ys) &quot;*&quot; = (x * y):ys
        foldingFunction (x:y:ys) &quot;+&quot; = (x + y):ys
        foldingFunction (x:y:ys) &quot;-&quot; = (x - y):ys
        foldingFunction (x:y:ys) &quot;/&quot; = (y / x):ys
        foldingFunction (x:y:ys) &quot;^&quot; = (y ** x):ys
        foldingFunction (x:xs) &quot;ln&quot; = log x:xs
        foldingFunction xs &quot;sum&quot; = [sum xs]
        foldingFunction xs numString = read numString:xs


main :: IO ()
main = do
    putStrLn &quot;start...&quot;
    print $ solveRPN &quot;90 34 12 33 55 66 + * - + -&quot;
    putStrLn &quot;end...&quot;
</code></pre>
<h3 id="92-è®¡ç®—æœ€çŸ­è·¯"><a class="header" href="#92-è®¡ç®—æœ€çŸ­è·¯">9.2 è®¡ç®—æœ€çŸ­è·¯</a></h3>
<pre><code class="language-haskell">-- newtype Road = Road Int Node
-- newtype Node = Node Road Road | EndNode Road

-- newtype Road = Road Int Node
-- newtype Node = Node Road (Maybe Road)

data Section = Section
  { getA :: Int,
    getB :: Int,
    getC :: Int
  }
  deriving (Show)

type RoadSystem = [Section]

headthrowToLondon :: RoadSystem
headthrowToLondon = [Section 50 10 30, Section 5 90 20, Section 40 2 25, Section 10 8 0]

data Label = A | B | C deriving (Show)

type Path = [(Label, Int)]

roadStep :: (Path, Path) -&gt; Section -&gt; (Path, Path)
roadStep (pathA, pathB) (Section a b c) =
  let priceA = sum $ map snd pathA
      priceB = sum $ map snd pathB
      forwardPriceToA = priceA + a
      crossPriceToA = priceB + b + c
      forwardPriceToB = priceB + b
      crossPriceToB = priceA + a + c
      newPathToA =
        if forwardPriceToA &lt;= crossPriceToA
          then (A, a) : pathA
          else (C, c) : (B, b) : pathB
      newPathToB =
        if forwardPriceToB &lt;= crossPriceToB
          then (B, b) : pathB
          else (C, c) : (A, a) : pathA
   in (newPathToA, newPathToB)

optimalPath :: RoadSystem -&gt; Path
optimalPath roadSystem =
  let (bestAPath, bestBPath) = foldl roadStep ([], []) roadSystem
   in if sum (map snd bestAPath) &lt;= sum (map snd bestBPath)
        then reverse bestAPath
        else reverse bestBPath

main :: IO ()
main = do
  print $ roadStep ([], []) (head headthrowToLondon)
  print $ optimalPath headthrowToLondon


  contents &lt;- getContents
  let threes = groupOf 3 (map read $ lines contents)
      roadSystem = map (\[a,b,c] -&gt; Section a b c) threes
      path = optimalPath roadSystem
      pathString = concat $ map (show . fst) path
      pathPrice = sum $ map snd path
  putStrLn $ &quot;The best path to take is: &quot; ++ pathString
  putStrLn $ &quot;The price is: &quot; ++ show pathPrice


groupOf :: Int -&gt; [a] -&gt; [[a]]
groupOf 0 _ = undefined
groupOf _ [] = []
groupOf n xs = take n xs : groupOf n (drop n xs)
</code></pre>
<h2 id="10-functors-applicative-functors-and-monoids"><a class="header" href="#10-functors-applicative-functors-and-monoids">10. Functors, Applicative Functors and Monoids</a></h2>
<p>æåº¦å»ºè®®å‚è€ƒä¸‹é¢çš„æ–‡ç« ï¼Œå›¾æ–‡è§£é‡Šååˆ†ç›´è§‚
<a href="https://adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html">Functors, Applicatives, And Monads In Pictures</a></p>
<h3 id="101-functor"><a class="header" href="#101-functor">10.1 Functor</a></h3>
<pre><code class="language-haskell">fmap (+3) (Just 2)
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022316684.png" alt="" /></p>
<h3 id="102-applicatives"><a class="header" href="#102-applicatives">10.2 Applicatives</a></h3>
<pre><code class="language-haskell">Just (+3) &lt;*&gt; Just 2 == Just 5

&gt; [(*2), (+3)] &lt;*&gt; [1, 2, 3]
[2, 4, 6, 4, 5, 6]
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022317350.png" alt="" /></p>
<h3 id="103-monads"><a class="header" href="#103-monads">10.3 Monads</a></h3>
<p>åˆ¤æ–­ä¸€ä¸ªæ•°çš„å¥‡å¶</p>
<pre><code class="language-haskell">half x = if even x
           then Just (x `div` 2)
           else Nothing
</code></pre>
<p>åŠ å…¥ x ç°åœ¨æ˜¯ä¸€ä¸ª wrapped çš„æ¯”å¦‚è¯´ Maybeï¼Œè¿™é‡Œå¼•å…¥ä¸€ä¸ªæ–°çš„æ“ä½œç¬¦ <code>&gt;&gt;=</code></p>
<pre><code class="language-haskell">&gt; Just 3 &gt;&gt;= half
Nothing
&gt; Just 4 &gt;&gt;= half
Just 2
&gt; Nothing &gt;&gt;= half
Nothing
</code></pre>
<p>ä¹‹æ‰€ä»¥èƒ½åƒä¸Šé¢ä¸€æ ·æ“ä½œæ˜¯å› ä¸ºï¼ŒMaybe æ˜¯ä¸ª Monad</p>
<pre><code class="language-haskell">instance Monad Maybe where
    Nothing &gt;&gt;= func = Nothing
    Just val &gt;&gt;= func  = func val
</code></pre>
<p>Just
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022324827.png" alt="" />
Nothing
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022324432.png" alt="" /></p>
<h3 id="104-æ€»ç»“"><a class="header" href="#104-æ€»ç»“">10.4 æ€»ç»“</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022325497.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="bash"><a class="header" href="#bash">Bash</a></h1>
<h2 id="set-æŒ‡ä»¤"><a class="header" href="#set-æŒ‡ä»¤">set æŒ‡ä»¤</a></h2>
<pre><code class="language-sh"># å†™æ³•ä¸€
set -euxo pipefail

# å†™æ³•äºŒ
set -eux
set -o pipefail
</code></pre>
<p>å¦ä¸€ç§åŠæ³•æ˜¯åœ¨æ‰§è¡Œ Bash è„šæœ¬çš„æ—¶å€™ï¼Œä»å‘½ä»¤è¡Œä¼ å…¥è¿™äº›å‚æ•°ã€‚</p>
<pre><code class="language-sh">bash -euxo pipefail script.sh
</code></pre>
<ul>
<li><code>-e</code></li>
</ul>
<p>ç­‰ä»·äºï¼š<code>-o errexit</code></p>
<p>å®ƒä½¿å¾—è„šæœ¬åªè¦å‘ç”Ÿé”™è¯¯ï¼Œå°±ç»ˆæ­¢æ‰§è¡Œã€‚</p>
<p><code>set +e</code> å¯ä»¥å…³é—­ <code>-e</code> é€‰é¡¹ï¼Œä¹‹åä½ å¯ä»¥ä½¿ç”¨ <code>set -e</code> é‡æ–°æ‰“å¼€</p>
<p>è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ <code>command || true</code>ï¼Œä½¿å¾—è¯¥å‘½ä»¤å³ä½¿æ‰§è¡Œå¤±è´¥ï¼Œè„šæœ¬ä¹Ÿä¸ä¼šç»ˆæ­¢æ‰§è¡Œã€‚</p>
<ul>
<li><code>-u</code></li>
</ul>
<p>ç­‰ä»·äºï¼š<code>set -o nounset</code></p>
<p>é‡åˆ°ä¸å­˜åœ¨çš„å˜é‡å°±ä¼šæŠ¥é”™ï¼Œå¹¶åœæ­¢æ‰§è¡Œã€‚</p>
<pre><code class="language-sh">$ bash script.sh
bash: script.sh:è¡Œ4: a: æœªç»‘å®šçš„å˜é‡
</code></pre>
<ul>
<li><code>-x</code></li>
</ul>
<p>ç­‰ä»·äºï¼š<code>set -o xtrace</code></p>
<p>æ‰“å°å½“å‰æ‰§è¡Œçš„å‘½ä»¤</p>
<pre><code class="language-sh">$ bash -c &quot;set -x; echo a; echo b; echo 3&quot;
- echo a
a
- echo b
b
- echo 3
3
</code></pre>
<ul>
<li><code>set -o pipefail</code></li>
</ul>
<p><code>set -e</code> ä¸é€‚ç”¨äºç®¡é“å‘½ä»¤ã€‚åªè¦æœ€åä¸€ä¸ªå­å‘½ä»¤ä¸å¤±è´¥ï¼Œç®¡é“å‘½ä»¤æ€»æ˜¯ä¼šæ‰§è¡ŒæˆåŠŸï¼Œå› æ­¤å®ƒåé¢å‘½ä»¤ä¾ç„¶ä¼šæ‰§è¡Œï¼Œset -e å°±å¤±æ•ˆäº†ã€‚</p>
<p>ä¾‹å¦‚ï¼š<code>foo | echo a</code></p>
<p><code>set -o pipefail</code> ç”¨æ¥è§£å†³è¿™ç§æƒ…å†µï¼Œåªè¦ä¸€ä¸ªå­å‘½ä»¤å¤±è´¥ï¼Œæ•´ä¸ªç®¡é“å‘½ä»¤å°±å¤±è´¥ï¼Œè„šæœ¬å°±ä¼šç»ˆæ­¢æ‰§è¡Œã€‚</p>
<ul>
<li>ä¸åŠ å‚æ•°</li>
</ul>
<p>å¦‚æœå‘½ä»¤è¡Œä¸‹ä¸å¸¦ä»»ä½•å‚æ•°ï¼Œç›´æ¥è¿è¡Œ setï¼Œä¼šæ˜¾ç¤ºæ‰€æœ‰çš„ç¯å¢ƒå˜é‡å’Œ Shell å‡½æ•°ã€‚</p>
<h2 id="é”™è¯¯å¤„ç†"><a class="header" href="#é”™è¯¯å¤„ç†">é”™è¯¯å¤„ç†</a></h2>
<p>å¦‚æœè„šæœ¬é‡Œé¢æœ‰è¿è¡Œå¤±è´¥çš„å‘½ä»¤ï¼ˆè¿”å›å€¼é 0ï¼‰ï¼Œæ‰§è¡Œæ—¶ä¼šæŠ¥é”™ã€‚ä½†æ˜¯ï¼ŒBash ä¼šå¿½ç•¥è¿™ä¸ªé”™è¯¯ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚</p>
<p>å¦‚æœæŸä¸ªå‘½ä»¤å¤±è´¥ï¼Œéœ€è¦è„šæœ¬åœæ­¢æ‰§è¡Œï¼Œä¸€èˆ¬é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚</p>
<pre><code class="language-sh">command || exit 1
</code></pre>
<p>ä¸Šé¢çš„å†™æ³•è¡¨ç¤ºåªè¦ command æœ‰éé›¶è¿”å›å€¼ï¼Œè„šæœ¬å°±ä¼šåœæ­¢æ‰§è¡Œã€‚</p>
<p>å¦‚æœåœæ­¢æ‰§è¡Œä¹‹å‰éœ€è¦å®Œæˆå¤šä¸ªæ“ä½œï¼Œå°±è¦é‡‡ç”¨ä¸‹é¢ä¸‰ç§å†™æ³•ã€‚</p>
<pre><code class="language-sh"># å†™æ³•ä¸€
command || { echo &quot;command failed&quot;; exit 1; }

# å†™æ³•äºŒ
if ! command; then echo &quot;command failed&quot;; exit 1; fi

# å†™æ³•ä¸‰
command
if [ &quot;$?&quot; -ne 0 ]; then echo &quot;command failed&quot;; exit 1; fi
</code></pre>
<p>å¦å¤–ï¼Œé™¤äº†åœæ­¢æ‰§è¡Œï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µã€‚å¦‚æœä¸¤ä¸ªå‘½ä»¤æœ‰ç»§æ‰¿å…³ç³»ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªå‘½ä»¤æˆåŠŸäº†ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œç¬¬äºŒä¸ªå‘½ä»¤ï¼Œé‚£ä¹ˆå°±è¦é‡‡ç”¨ä¸‹é¢çš„å†™æ³•ã€‚</p>
<pre><code class="language-sh">command1 &amp;&amp; command2
</code></pre>
<h2 id="å˜é‡"><a class="header" href="#å˜é‡">å˜é‡</a></h2>
<h3 id="å®šä¹‰"><a class="header" href="#å®šä¹‰">å®šä¹‰</a></h3>
<pre><code class="language-sh"># æ™®é€šå˜é‡
myUrl=&quot;abcd&quot;

# åªè¯»å˜é‡
readonly myUrl=&quot;abcd&quot;
</code></pre>
<p>æ³¨æ„äº‹é¡¹</p>
<ul>
<li>
<p>å˜é‡å®šä¹‰çš„ç­‰å·ä¸¤è¾¹<strong>ä¸èƒ½æœ‰ç©ºæ ¼</strong></p>
</li>
<li>
<p>ä½¿ç”¨å˜é‡æ—¶ å˜é‡åå¤–é¢çš„èŠ±æ‹¬å·æ˜¯å¯é€‰çš„</p>
<pre><code class="language-sh">for skill in Ada Coffee Action Java; do
  echo &quot;I am good at ${skill}Script&quot;
done
</code></pre>
</li>
<li>
<p>ä½¿ç”¨ <code>unset</code> åˆ é™¤å˜é‡</p>
</li>
</ul>
<h3 id="å­—ç¬¦ä¸²-1"><a class="header" href="#å­—ç¬¦ä¸²-1">å­—ç¬¦ä¸²</a></h3>
<ul>
<li>è·å–é•¿åº¦</li>
</ul>
<pre><code class="language-sh">echo &quot;length: ${#myUrl}&quot;
</code></pre>
<ul>
<li>è·å–åˆ‡ç‰‡</li>
</ul>
<pre><code class="language-sh">echo &quot;length: ${myUrl:1:4}&quot;
</code></pre>
<ul>
<li>ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•</li>
</ul>
<pre><code class="language-sh">string=&quot;runoob is a great site&quot;
echo `expr index &quot;$string&quot; r`  # è¾“å‡º 1
echo `expr index &quot;$string&quot; u`  # è¾“å‡º 2
echo `expr index &quot;$string&quot; un`  # è¾“å‡º 2
</code></pre>
<h3 id="æ•°ç»„-1"><a class="header" href="#æ•°ç»„-1">æ•°ç»„</a></h3>
<pre><code class="language-sh">array=(value0 garabe value2 value3)
array[1]=value1

echo ${array[1]}
echo ${array[@]} # è¯»å–æ‰€æœ‰

# è¯»å–é•¿åº¦
length=${#array_name[@]}
# æˆ–è€…
length=${#array_name[*]}
</code></pre>
<p>bash é‡Œçš„æ•°ç»„å’Œå­—å…¸è¾ƒä¸ºç±»ä¼¼ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆæ¯ä¸ªå…ƒç´ å¯¹åº”çš„é”®å°±æ˜¯ç´¢å¼•</p>
<pre><code class="language-sh">dict=()
# declare dict
# declare -A dict
dict[&quot;a&quot;]=1
echo ${dict[&quot;a&quot;]}
# 1
</code></pre>
<h2 id="å‚æ•°"><a class="header" href="#å‚æ•°">å‚æ•°</a></h2>
<h3 id="-ç›¸å…³"><a class="header" href="#-ç›¸å…³"><code>$</code> ç›¸å…³</a></h3>
<ol>
<li>
<p>å‚æ•°ç›¸å…³</p>
<ul>
<li>
<p><strong><code>$#</code></strong>:ä¼ é€’åˆ°è„šæœ¬çš„å‚æ•°ä¸ªæ•°</p>
<p>ä¸‹é¢ä¸¤ä¸ªå¸¸ç”¨æ¥éå†æ‰€æœ‰å‚æ•°</p>
</li>
<li>
<p><strong><code>$@</code></strong>: ä¸ <strong><code>$*</code></strong> ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨æ—¶åŠ å¼•å·ï¼Œå¹¶åœ¨å¼•å·ä¸­è¿”å›æ¯ä¸ªå‚æ•°ã€‚</p>
<p>å¦‚ <code>$@</code> ç”¨ <code>ã€Œ&quot;ã€</code> æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥ <code>&quot;$1&quot; &quot;$2&quot; â€¦ &quot;$n&quot;</code> çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚</p>
<pre><code class="language-sh">for i in &quot;$*&quot;; do
    echo $i
done
# 1 2 3

for i in &quot;$@&quot;; do
    echo $i
done

# 1
# 2
# 3
</code></pre>
</li>
<li>
<p><code>$_</code>: æ‹¼æ¥æ‰€æœ‰å‚æ•°å¹¶è¿”å›ã€‚</p>
<p>å¦‚ <code>$_</code> ç”¨ <code>ã€Œ&quot;ã€</code> æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥ <code>&quot;$1 $2 â€¦ $n&quot;</code> çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚</p>
</li>
</ul>
</li>
<li>
<p>è¿›ç¨‹ ID ç›¸å…³</p>
<ul>
<li><code>$$</code>: è„šæœ¬è¿è¡Œçš„å½“å‰è¿›ç¨‹ ID å·</li>
<li><code>$!</code>: åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„ ID å·</li>
<li><code>$-</code>: æ˜¾ç¤º Shell ä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸ set å‘½ä»¤åŠŸèƒ½ç›¸åŒã€‚</li>
<li><code>$?</code>: æ˜¾ç¤ºæœ€åå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚0 è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œå…¶ä»–ä»»ä½•å€¼è¡¨æ˜æœ‰é”™è¯¯ã€‚</li>
</ul>
</li>
</ol>
<h2 id="è¿ç®—ç¬¦"><a class="header" href="#è¿ç®—ç¬¦">è¿ç®—ç¬¦</a></h2>
<p>åŸç”Ÿ bash ä¸æ”¯æŒæ•°å­¦è¿ç®—ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…¶ä»–å‘½ä»¤å®ç°ï¼Œä¾‹å¦‚ awk å’Œ expr</p>
<pre><code class="language-sh">val=`expr 2 + 2`
echo &quot;ä¸¤æ•°ä¹‹å’Œä¸º : $val&quot;
</code></pre>
<h3 id="ç®—æ•°è¿ç®—ç¬¦"><a class="header" href="#ç®—æ•°è¿ç®—ç¬¦">ç®—æ•°è¿ç®—ç¬¦</a></h3>
<p><code>+ - * / % = == !=</code></p>
<p><strong>æ³¨æ„ :</strong></p>
<ul>
<li>
<p>è¡¨è¾¾å¼å’Œè¿ç®—ç¬¦ä¹‹é—´å¿…é¡»æœ‰ç©ºæ ¼</p>
</li>
<li>
<p>è¡¨è¾¾å¼å¿…é¡»è¦è¢« `` åŒ…å«</p>
</li>
<li>
<p>æ³¨æ„è¦è½¬ä¹‰ <code>*</code> å·</p>
<pre><code class="language-sh">val=`expr $a \* $b`
echo &quot;a * b : $val&quot;
</code></pre>
<blockquote>
<p>åœ¨ MAC ä¸­ shell çš„ expr è¯­æ³•æ˜¯ï¼š$((è¡¨è¾¾å¼))ï¼Œæ­¤å¤„è¡¨è¾¾å¼ä¸­çš„ &quot;*&quot; ä¸éœ€è¦è½¬ä¹‰ç¬¦å· &quot;&quot; ã€‚</p>
</blockquote>
</li>
<li>
<p>åˆ¤æ–­çš„ä¸­æ‹¬å·ä¸¤ä¾§å¿…é¡»æœ‰ç©ºæ ¼</p>
<pre><code class="language-sh">if [ $a == $b ]
then
  echo &quot;a ç­‰äº b&quot;
fi
if [ $a != $b ]
then
  echo &quot;a ä¸ç­‰äº b&quot;
fi
</code></pre>
</li>
</ul>
<h3 id="å…³ç³»è¿ç®—ç¬¦"><a class="header" href="#å…³ç³»è¿ç®—ç¬¦">å…³ç³»è¿ç®—ç¬¦</a></h3>
<p>å…³ç³»è¿ç®—ç¬¦åªæ”¯æŒæ•°å­—ï¼Œä¸æ”¯æŒå­—ç¬¦ä¸²ï¼Œé™¤éå­—ç¬¦ä¸²çš„å€¼æ˜¯æ•°å­—ã€‚</p>
<p><code>-eq -ne -gt -lt -ge -le</code></p>
<h3 id="å¸ƒå°”è¿ç®—ç¬¦"><a class="header" href="#å¸ƒå°”è¿ç®—ç¬¦">å¸ƒå°”è¿ç®—ç¬¦</a></h3>
<p><code>! (é)  -o (æˆ–)  -a (ä¸)</code></p>
<h3 id="é€»è¾‘è¿ç®—ç¬¦"><a class="header" href="#é€»è¾‘è¿ç®—ç¬¦">é€»è¾‘è¿ç®—ç¬¦</a></h3>
<p><code>&amp;&amp; ||</code></p>
<h3 id="å­—ç¬¦ä¸²è¿ç®—ç¬¦"><a class="header" href="#å­—ç¬¦ä¸²è¿ç®—ç¬¦">å­—ç¬¦ä¸²è¿ç®—ç¬¦</a></h3>
<ul>
<li>
<p><code>==</code>: ç›¸ç­‰</p>
</li>
<li>
<p><code>!=</code>: ä¸ç›¸ç­‰</p>
</li>
<li>
<p><code>$</code>: å­—ç¬¦ä¸²æ˜¯å¦ä¸ä¸ºç©º</p>
<pre><code class="language-sh">if [ $a ]
</code></pre>
</li>
<li>
<p><code>-z</code>: é•¿åº¦æ˜¯å¦ä¸º 0</p>
<pre><code class="language-sh">if [ -z $a ]
</code></pre>
</li>
<li>
<p><code>-n</code>: é•¿åº¦æ˜¯å¦ä¸ä¸º 0</p>
</li>
</ul>
<h3 id="æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦"><a class="header" href="#æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦">æ–‡ä»¶æµ‹è¯•è¿ç®—ç¬¦</a></h3>
<p>å¸¸ç”¨</p>
<ul>
<li>
<p><code>-e</code>: æ£€æµ‹æ–‡ä»¶ï¼ˆåŒ…æ‹¬ç›®å½•ï¼‰æ˜¯å¦å­˜åœ¨</p>
</li>
<li>
<p><code>-s</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦ä¸ºç©ºï¼ˆæ–‡ä»¶å¤§å°æ˜¯å¦å¤§äº 0ï¼‰</p>
</li>
<li>
<p><code>-f</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯æ™®é€šæ–‡ä»¶ï¼ˆæ—¢ä¸æ˜¯ç›®å½•ï¼Œä¹Ÿä¸æ˜¯è®¾å¤‡æ–‡ä»¶ï¼‰</p>
</li>
<li>
<p><code>-d</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯ç›®å½•</p>
</li>
<li>
<p><code>-r</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯è¯»</p>
</li>
<li>
<p><code>-w</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯å†™</p>
</li>
<li>
<p><code>-x</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦å¯æ‰§è¡Œ</p>
</li>
</ul>
<p>å…¶ä»–</p>
<ul>
<li><code>-b</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å—è®¾å¤‡æ–‡ä»¶</li>
<li><code>-c</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯å­—ç¬¦è®¾å¤‡æ–‡ä»¶</li>
<li><code>-g</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SGID ä½</li>
<li><code>-k</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº†ç²˜ç€ä½ (Sticky Bit)</li>
<li><code>-p</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦æ˜¯æœ‰åç®¡é“</li>
<li><code>-u</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦è®¾ç½®äº† SUID ä½</li>
<li><code>-S</code>: åˆ¤æ–­æŸæ–‡ä»¶æ˜¯å¦ socketã€‚</li>
<li><code>-L</code>: æ£€æµ‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨å¹¶ä¸”æ˜¯ä¸€ä¸ªç¬¦å·é“¾æ¥ã€‚</li>
</ul>
<h2 id="æµç¨‹æ§åˆ¶"><a class="header" href="#æµç¨‹æ§åˆ¶">æµç¨‹æ§åˆ¶</a></h2>
<h3 id="if"><a class="header" href="#if">if</a></h3>
<p>if è¯­å¥è¯­æ³•æ ¼å¼ï¼š</p>
<pre><code class="language-sh">if [ &quot;$a&quot; -gt &quot;$b&quot; ]; then
    command1
elif (( a &gt; b )); then
    command2
else
    commandN
fi
</code></pre>
<ul>
<li>if else çš„ <code>[...]</code> åˆ¤æ–­è¯­å¥ä¸­å¤§äºä½¿ç”¨ <code>-gt</code>ï¼Œå°äºä½¿ç”¨ <code>-lt</code>ã€‚</li>
<li>å¦‚æœä½¿ç”¨ <code>((...))</code> ä½œä¸ºåˆ¤æ–­è¯­å¥ï¼Œå¤§äºå’Œå°äºå¯ä»¥ç›´æ¥ä½¿ç”¨ <code>&gt;</code> å’Œ <code>&lt;</code>ã€‚</li>
<li>ä¹Ÿå¯ä»¥ä½¿ç”¨ test</li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½ä¸èƒ½ä¸ºç©º</p>
</blockquote>
<p>å†™æˆä¸€è¡Œï¼ˆé€‚ç”¨äºç»ˆç«¯å‘½ä»¤æç¤ºç¬¦ï¼‰ï¼š</p>
<pre><code class="language-sh">if [ $(ps -ef | grep -c &quot;ssh&quot;) -gt 1 ]; then echo &quot;true&quot;; fi
</code></pre>
<h3 id="for-å¾ªç¯"><a class="header" href="#for-å¾ªç¯">for å¾ªç¯</a></h3>
<pre><code class="language-sh">for var in item1 item2 ... itemN
do
    command1
    command2
    ...
    commandN
done
</code></pre>
<p>å†™æˆä¸€è¡Œï¼š</p>
<pre><code class="language-sh">for var in item1 item2 ... itemN; do command1; command2â€¦ done;
</code></pre>
<p>æ”¯æŒ break å’Œ continue è¯­å¥</p>
<pre><code class="language-sh">while : # æ— é™å¾ªç¯
do
    echo -n &quot;è¾“å…¥ 1 åˆ° 5 ä¹‹é—´çš„æ•°å­—:&quot;
    read aNum # è·å–ç”¨æˆ·è¾“å…¥
    case $aNum in
        # å¯ä»¥åŒ¹é…å¤šä¸ªæ¨¡å¼
        1|2|3|4|5) echo &quot;ä½ è¾“å…¥çš„æ•°å­—ä¸º $aNum!&quot;
        ;;
        *) echo &quot;ä½ è¾“å…¥çš„æ•°å­—ä¸æ˜¯ 1 åˆ° 5 ä¹‹é—´çš„! æ¸¸æˆç»“æŸ&quot;
            break
        ;;
    esac
done
</code></pre>
<p>ç¤ºä¾‹</p>
<pre><code class="language-sh">for loop in 1 2 3 4 5
do
    echo &quot;The value is: $loop&quot;
done

for str in This is a string
do
    echo $str
done
</code></pre>
<h3 id="while"><a class="header" href="#while">while</a></h3>
<pre><code class="language-sh">int=1
while(( $int&lt;=5 ))
do
    echo $int
    let &quot;int++&quot;
done
</code></pre>
<blockquote>
<p>let å‘½ä»¤ï¼Œå®ƒç”¨äºæ‰§è¡Œä¸€ä¸ªæˆ–å¤šä¸ªè¡¨è¾¾å¼ï¼Œå˜é‡è®¡ç®—ä¸­ä¸éœ€è¦åŠ ä¸Š $ æ¥è¡¨ç¤ºå˜é‡</p>
</blockquote>
<h3 id="æ— é™å¾ªç¯"><a class="header" href="#æ— é™å¾ªç¯">æ— é™å¾ªç¯</a></h3>
<p>æ— é™å¾ªç¯è¯­æ³•æ ¼å¼ï¼š</p>
<pre><code class="language-sh">while :
do
    command
done
</code></pre>
<p>æˆ–è€…</p>
<pre><code class="language-sh">while true
do
    command
done
</code></pre>
<p>æˆ–è€…</p>
<pre><code class="language-sh">for (( ; ; ))
</code></pre>
<h3 id="until-å¾ªç¯"><a class="header" href="#until-å¾ªç¯">until å¾ªç¯</a></h3>
<p>until å¾ªç¯æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤ç›´è‡³æ¡ä»¶ä¸º true æ—¶åœæ­¢ã€‚</p>
<p>ä¸ while å¾ªç¯åœ¨å¤„ç†æ–¹å¼ä¸Šåˆšå¥½ç›¸åã€‚</p>
<p>until è¯­æ³•æ ¼å¼ï¼š</p>
<pre><code class="language-sh">until condition
do
  command
done
</code></pre>
<p>è¾“å‡º 0-9</p>
<pre><code class="language-sh">a=0

until [ ! $a -lt 10 ]
do
   echo $a
   a=`expr $a + 1`
done
</code></pre>
<h3 id="case-è¯­å¥"><a class="header" href="#case-è¯­å¥">case è¯­å¥</a></h3>
<ul>
<li><code>;;</code>: è¡¨ç¤º break</li>
<li><code>*</code>: å¦‚æœæ²¡æœ‰åŒ¹é…å°±ä¼šèµ° <code>*</code></li>
</ul>
<pre><code class="language-sh">aNum=1
case $aNum in
    1|2)  echo 'ä½ é€‰æ‹©äº† 1'
    ;;
    2)  echo 'ä½ é€‰æ‹©äº† 2'
    ;;
    3)  echo 'ä½ é€‰æ‹©äº† 3'
    ;;
    4)  echo 'ä½ é€‰æ‹©äº† 4'
    ;;
    *)  echo 'ä½ æ²¡æœ‰è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—'
    ;;
esac
</code></pre>
<h2 id="å‡½æ•°"><a class="header" href="#å‡½æ•°">å‡½æ•°</a></h2>
<p>bash çš„å‡½æ•°ç±»ä¼¼äºè¿›ç¨‹</p>
<p>å‚æ•°ä¼ é€’ç›´æ¥è·Ÿåœ¨å‡½æ•°åä¹‹åï¼Œå‚æ•°è·å–ä½¿ç”¨ <code>$</code> è·å–</p>
<pre><code class="language-sh">funWithParam(){
    echo &quot;ç¬¬ä¸€ä¸ªå‚æ•°ä¸º $1 !&quot;
    echo &quot;ç¬¬äºŒä¸ªå‚æ•°ä¸º $2 !&quot;
    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º $10 !&quot;
    echo &quot;ç¬¬åä¸ªå‚æ•°ä¸º ${10} !&quot;
    echo &quot;ç¬¬åä¸€ä¸ªå‚æ•°ä¸º ${11} !&quot;
    echo &quot;å‚æ•°æ€»æ•°æœ‰ $# ä¸ª!&quot;
    echo &quot;ä½œä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¾“å‡ºæ‰€æœ‰å‚æ•° $* !&quot;
}
funWithParam 1 2 3 4 5 6 7 8 9 34 73
</code></pre>
<ul>
<li>
<p>è¿”å›å€¼å¯é€‰ returnï¼Œå¦‚æœä¸åŠ  returnï¼Œä¼šä»¥æœ€åä¸€æ¡å‘½ä»¤çš„è¿”å›å€¼ä½œä¸ºè¿”å›å€¼ã€‚</p>
</li>
<li>
<p>å‘½ä»¤çš„è¿”å›å€¼ä»…ä»…è¡¨ç¤ºæ˜¯å¦å‡ºé”™ï¼Œè¿”å›å€¼ä¸º 0 å°±æ˜¯æˆåŠŸï¼Œå…¶ä»–å€¼ä¸ºå‡ºé”™</p>
<blockquote>
<p>è¦æ³¨æ„çš„æ˜¯ï¼Œå’Œ C è¯­è¨€ä¸åŒï¼Œshell è¯­è¨€ä¸­ 0 ä»£è¡¨ trueï¼Œ0 ä»¥å¤–çš„å€¼ä»£è¡¨ falseã€‚</p>
</blockquote>
</li>
<li>
<p>å¿…é¡»ä½¿ç”¨ <code>$?</code> æ‹¿åˆ°çœŸæ­£çš„è¿”å›å€¼</p>
</li>
</ul>
<pre><code class="language-sh">function demoFun2(){
 echo &quot;è¿™æ˜¯æˆ‘çš„ç¬¬äºŒä¸ª shell å‡½æ•°!&quot;
 expr 1 + 1
}

demoFun2
echo $?
</code></pre>
<h2 id="é‡å®šå‘"><a class="header" href="#é‡å®šå‘">é‡å®šå‘</a></h2>
<ul>
<li>
<p>å°† stdout é‡å®šå‘åˆ° fileï¼š<code>command &gt; file</code></p>
</li>
<li>
<p>å°† stdin é‡å®šå‘åˆ° fileï¼š<code>command &lt; file</code></p>
</li>
<li>
<p>stderr é‡å®šå‘åˆ° fileï¼š <code>command 2&gt;file</code></p>
<blockquote>
<p>æ³¨æ„ï¼šè¿™é‡Œçš„ 2 å’Œ &gt; ä¹‹é—´ä¸å¯ä»¥æœ‰ç©ºæ ¼ï¼Œ2&gt; æ˜¯ä¸€ä½“çš„æ—¶å€™æ‰è¡¨ç¤ºé”™è¯¯è¾“å‡ºã€‚</p>
</blockquote>
</li>
<li>
<p>stderr <strong>è¿½åŠ </strong>åˆ° file æ–‡ä»¶æœ«å°¾ï¼š<code>command 2&gt;&gt;file</code></p>
</li>
<li>
<p>å°† stdout å’Œ stderr åˆå¹¶åé‡å®šå‘åˆ° file: <code>command &gt; file 2&gt;&amp;1</code> æˆ– <code>command &gt;&gt; file 2&gt;&amp;1</code></p>
</li>
<li>
<p>å¯¹ stdin å’Œ stdout éƒ½é‡å®šå‘ï¼š<code>command &lt; file1 &gt;file2</code></p>
<p>command å‘½ä»¤å°† stdin é‡å®šå‘åˆ° file1ï¼Œå°† stdout é‡å®šå‘åˆ° file2ã€‚</p>
</li>
</ul>
<p>æ‰§è¡ŒæŸä¸ªå‘½ä»¤ï¼Œä½†ä¸åœ¨å±å¹•ä¸Šæ˜¾ç¤ºè¾“å‡ºç»“æœï¼Œé‚£ä¹ˆå¯ä»¥å°†è¾“å‡ºé‡å®šå‘åˆ° <em>/dev/null</em>ï¼š</p>
<pre><code class="language-sh">command &gt; /dev/null
</code></pre>
<p>/dev/null æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå†™å…¥åˆ°å®ƒçš„å†…å®¹éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚å¦‚æœå°è¯•ä»è¯¥æ–‡ä»¶è¯»å–å†…å®¹ï¼Œé‚£ä¹ˆä»€ä¹ˆä¹Ÿè¯»ä¸åˆ°ã€‚</p>
<p>å°†å‘½ä»¤çš„è¾“å‡ºé‡å®šå‘åˆ°å®ƒï¼Œä¼šèµ·åˆ°&quot;ç¦æ­¢è¾“å‡º&quot;çš„æ•ˆæœã€‚å¦‚æœå¸Œæœ›å±è”½ stdout å’Œ stderrï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</p>
<pre><code class="language-sh">command &gt; /dev/null 2&gt;&amp;1
</code></pre>
<h2 id="import"><a class="header" href="#import">import</a></h2>
<p>Shell ä¹Ÿå¯ä»¥åŒ…å«å¤–éƒ¨è„šæœ¬</p>
<pre><code class="language-sh">#ä½¿ç”¨ . å·æ¥å¼•ç”¨test1.sh æ–‡ä»¶
. ./test1.sh

# æˆ–è€…ä½¿ç”¨ä»¥ä¸‹åŒ…å«æ–‡ä»¶ä»£ç 
# source ./test1.sh
</code></pre>
<h2 id="å…¶ä»–-2"><a class="header" href="#å…¶ä»–-2">å…¶ä»–</a></h2>
<h3 id="echo"><a class="header" href="#echo">echo</a></h3>
<ul>
<li>
<p>æ‰§è¡Œå‘½ä»¤ï¼ˆåå¼•å·ï¼‰</p>
<pre><code class="language-sh">echo `date`
</code></pre>
</li>
<li>
<p>ç»“æœé‡å®šå‘</p>
<pre><code class="language-sh">echo &quot;It is a test&quot; &gt; myfile
</code></pre>
</li>
<li>
<p>åŸæ ·è¾“å‡ºå­—ç¬¦ä¸²ï¼Œä¸è¿›è¡Œè½¬ä¹‰æˆ–å–å˜é‡ (ç”¨å•å¼•å·)</p>
<pre><code class="language-sh">echo '$name\&quot;'
</code></pre>
</li>
<li>
<p><code>-e</code> å¼€å¯è½¬ä¹‰</p>
<pre><code class="language-sh">echo -e &quot;OK! \n&quot; # -e å¼€å¯è½¬ä¹‰ \n æ¢è¡Œ

echo -e &quot;OK! \c&quot; # -e å¼€å¯è½¬ä¹‰ \c ä¸æ¢è¡Œ
</code></pre>
</li>
</ul>
<h3 id="test"><a class="header" href="#test">test</a></h3>
<pre><code class="language-sh">if [ $a == $b ]

if test $a == $b
</code></pre>
<h3 id="æ³¨é‡Š"><a class="header" href="#æ³¨é‡Š">æ³¨é‡Š</a></h3>
<p><code>SomeThing</code> å¯ä»¥æ˜¯ä»»ä½•ä¸œè¥¿</p>
<pre><code class="language-sh">:&lt;&lt;SomeThing
æ³¨é‡Šå†…å®¹...
æ³¨é‡Šå†…å®¹...
æ³¨é‡Šå†…å®¹...
SomeThing
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åŸå­æ“ä½œä¸å†…å­˜é¡ºåº"><a class="header" href="#åŸå­æ“ä½œä¸å†…å­˜é¡ºåº">åŸå­æ“ä½œä¸å†…å­˜é¡ºåº</a></h1>
<p>åŸå­æ“ä½œèƒ½å¤Ÿç”¨æ¥å®ç°æ— ğŸ”“å¹¶å‘</p>
<h2 id="ç¨‹åºè¿è¡Œé—®é¢˜"><a class="header" href="#ç¨‹åºè¿è¡Œé—®é¢˜">ç¨‹åºè¿è¡Œé—®é¢˜</a></h2>
<p>ä¸‹é¢åˆ—ä¸¾äº†å½±å“ä»£ç æ‰§è¡Œé¡ºåºçš„è¯¸å¤šåŸå› </p>
<h3 id="1-ç¼–è¯‘å™¨é‡æ’"><a class="header" href="#1-ç¼–è¯‘å™¨é‡æ’">1. ç¼–è¯‘å™¨é‡æ’</a></h3>
<p>ç¼–è¯‘å™¨ä¼šå°½å¯èƒ½ä¼˜åŒ–ä»£ç ï¼Œåœ¨å•çº¿ç¨‹ä¸‹ä¸€èˆ¬ä¸ä¼šå‡ºç°é—®é¢˜</p>
<pre><code class="language-js">x = 1;
y = 3;
x = 2;
</code></pre>
<p>ä¸Šé¢çš„ä»£ç å¯èƒ½è¢«ä¼˜åŒ–ä¸ºä¸‹é¢çš„æ ·å­</p>
<pre><code class="language-py">x = 2;
y = 3;
</code></pre>
<p>ä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹å¯èƒ½ä¼šæœ‰é—®é¢˜</p>
<h3 id="2æŒ‡ä»¤é‡æ’"><a class="header" href="#2æŒ‡ä»¤é‡æ’">2.æŒ‡ä»¤é‡æ’</a></h3>
<p>ç±»ä¼¼äºä¸Šé¢çš„ï¼Œä¸‹é¢çš„ä»£ç ä¸­ y = 200 å¯èƒ½ä¼šå…ˆäº x = 100 æ‰§è¡Œï¼Œæ‰“å°å‡ºçš„ x å¯èƒ½æ˜¯ 0 æˆ– 100 ä¾‹ 1:</p>
<pre><code class="language-cpp">    int x = 0;     // global variable
    int y = 0;     // global variable

    Thread-1:           Thread-2:
    x = 100;            while (y != 200) {};
    y = 200;            std::cout &lt;&lt; x;
</code></pre>
<p>ä¾‹ 2:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>åˆå§‹çŠ¶æ€: x = 0, y = 1
çº¿ç¨‹ 1        çº¿ç¨‹ 2
y = 3;      if x == 1 {
x = 1;          y *= 2;
            }
<span class="boring">}
</span></code></pre></pre>
<p>è¿™æ®µç¨‹åºå®é™…ä¸Šæœ‰ä¸¤ç§å¯èƒ½çš„ç»“æœï¼š</p>
<ul>
<li>y = 3ï¼šçº¿ç¨‹ 2 åœ¨çº¿ç¨‹ 1 å®Œæˆä¹‹å‰æ£€æŸ¥äº† x çš„å€¼</li>
<li>y = 6ï¼šçº¿ç¨‹ 2 åœ¨çº¿ç¨‹ 1 å®Œæˆä¹‹åæ£€æŸ¥äº† x çš„å€¼</li>
<li>y = 2ï¼šçº¿ç¨‹ 2 çœ‹åˆ°äº† x = 1ï¼Œä½†æ˜¯æ²¡çœ‹åˆ° y = 3ï¼Œæ¥ä¸‹æ¥ç”¨è®¡ç®—ç»“æœè¦†ç›–äº† y = 3</li>
</ul>
<h3 id="3-cpu-cache"><a class="header" href="#3-cpu-cache">3. CPU Cache</a></h3>
<p>ç”±äºä¸€æ¬¡å¤åˆ¶æ“ä½œæ¶‰åŠåˆ° move(å†…å­˜ -&gt; å¯„å­˜å™¨) add mov(å¯„å­˜å™¨ -&gt; å†…å­˜) ä¸‰æ¡æ±‡ç¼–æŒ‡ä»¤ï¼Œåœ¨ add
æ“ä½œå®Œæˆåï¼Œæ•°æ®è¿˜æ²¡æœ‰è¢«æ‹·è´åˆ°å†…å­˜æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½è¯»å–åˆ°æ­¤æ—¶è¿˜æ²¡æœ‰è¢«ä¿®æ”¹çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ï¼Œç»“æœæŸä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹çš„ç»“æœè¢«å¦ä¸€ä¸ªçº¿ç¨‹è¦†ç›–</p>
<h2 id="æœ¯è¯­"><a class="header" href="#æœ¯è¯­">æœ¯è¯­</a></h2>
<p>ä¸‹åˆ—æœ¯è¯­å®šä¹‰äº†å¤šçº¿ç¨‹å’Œå•çº¿ç¨‹ä¸­å„ä¸ªå˜é‡æ“ä½œä¹‹é—´çš„å…³ç³» è¿™äº›å…³ç³»åªæ˜¯æˆ‘ä»¬æœŸæœ›çš„ï¼Œæƒ³è¦ç¡®ä¿ä¸‹é¢çš„å…³ç³»åœ¨æ´»åŠ¨ä¸­æ˜¯æ­£å¸¸çš„ï¼Œå°±éœ€è¦å†…å­˜é¡ºåºäº†</p>
<h3 id="1-happens-before"><a class="header" href="#1-happens-before"><strong>1. happens-before</strong></a></h3>
<p>å…ˆäºï¼Œæˆ–è€…è¯´ B èƒ½çœ‹åˆ° A æ“ä½œçš„ç»“æœï¼ŒAB åˆ†åˆ«åœ¨ä¸¤ä¸ªçº¿ç¨‹é‡Œ</p>
<h3 id="2-sequenced-before"><a class="header" href="#2-sequenced-before">2. sequenced-before</a></h3>
<p>åŒä¸Š A,B åœ¨ä¸€ä¸ªçº¿ç¨‹å†…</p>
<h3 id="3-synchronized-with"><a class="header" href="#3-synchronized-with"><strong>3. synchronized-with</strong></a></h3>
<p>x æ˜¯æ”¯æŒåŸå­æ“ä½œçš„å˜é‡ A å†™å…¥ (store)xï¼ŒB è¯»å– (load)xï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªçº¿ç¨‹å†…ï¼Œåˆ™ A((store) å°±æ˜¯
synchornized-with B(load) çš„</p>
<h3 id="4-inter-thread"><a class="header" href="#4-inter-thread">4. inter-thread</a></h3>
<p>è·¨çº¿ç¨‹ ç¬¬ä¸‰ç‚¹è¯´åˆ° Aï¼šstore synchornized-with B: load é‚£ä¹ˆ A happens-before B å¤šçº¿ç¨‹ä¸­å†™å…¥å…ˆäºè¯»å–</p>
<h2 id="å†…å­˜é¡ºåº"><a class="header" href="#å†…å­˜é¡ºåº">å†…å­˜é¡ºåº</a></h2>
<h3 id="1-relaxed"><a class="header" href="#1-relaxed">1. Relaxed</a></h3>
<p>åªä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ»¡è¶³ Happens-beforeï¼Œè¿™æ˜¯æœ€å®½æ¾çš„è§„åˆ™ï¼Œä»–å¯¹ç¼–è¯‘å™¨å’Œ CPU ä¸åšä»»ä½•é™åˆ¶ï¼Œå¯ä»¥ä¹±éœ€ï¼Œå› æ­¤ä¸‹é¢çš„ä¾‹å­ä¸ä¿è¯ä¼šæˆåŠŸ</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[test]
fn to_relaxed() {
    let x: &amp;'static _ = Box::leak(Box::new(AtomicUsize::new(0)));
    let y: &amp;'static _ = Box::leak(Box::new(AtomicUsize::new(0)));
    let t1 = thread::spawn(move || {
        // è¯»å– x å­˜åˆ° y é‡Œ
        let r1 = y.load(Ordering::Relaxed);
        x.store(r1, Ordering::Relaxed);
        r1
    });
    let t2 = thread::spawn(move || {
        // è¯»å– y å­˜åˆ° x é‡Œ
        let r2 = x.load(Ordering::Relaxed); // ä¸‹é¢ä¸¤è¡Œå¯èƒ½ä¼šè¢«é‡æ’
        y.store(42, Ordering::Relaxed);
        r2
    });

    let r1 = t1.join().unwrap();
    let r2 = t2.join().unwrap();
    // å¯èƒ½å‡ºç° r1 == r2 == 42
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="2-acquire-release"><a class="header" href="#2-acquire-release">2. Acquire-Release</a></h3>
<p><strong>Release é‡Šæ”¾</strong> ï¼Œè®¾å®šå†…å­˜å±éšœ (Memory barrier)ï¼Œä¿è¯å®ƒä¹‹å‰çš„æ“ä½œæ°¸è¿œåœ¨å®ƒä¹‹å‰ï¼Œä½†æ˜¯å®ƒåé¢çš„æ“ä½œå¯èƒ½è¢«é‡æ’åˆ°å®ƒå‰é¢
<strong>Acquire è·å–</strong> , è®¾å®šå†…å­˜å±éšœï¼Œä¿è¯åœ¨å®ƒä¹‹åçš„è®¿é—®æ°¸è¿œåœ¨å®ƒä¹‹åï¼Œä½†æ˜¯å®ƒä¹‹å‰çš„æ“ä½œå´æœ‰å¯èƒ½è¢«é‡æ’åˆ°å®ƒåé¢ï¼Œå¾€å¾€å’Œ
<code>Release</code>åœ¨ä¸åŒçº¿ç¨‹ä¸­è”åˆä½¿ç”¨ <strong>AcqRel</strong>: Acquire å’Œ Release çš„ç»“åˆï¼ŒåŒæ—¶æ‹¥æœ‰å®ƒä»¬ä¿©æä¾›çš„ä¿è¯ã€‚æ¯”å¦‚ä½ è¦å¯¹ä¸€ä¸ª
atomic è‡ªå¢ 1ï¼ŒåŒæ—¶å¸Œæœ›è¯¥æ“ä½œä¹‹å‰å’Œä¹‹åçš„è¯»å–æˆ–å†™å…¥æ“ä½œä¸ä¼šè¢«é‡æ–°æ’åº</p>
<p>è¿™ä¸¤ä¸ªæ“ä½œé€šå¸¸æˆå¯¹ä½¿ç”¨ï¼Œå¯¹ store ä½¿ç”¨ Releaseï¼Œå¯¹ load ä½¿ç”¨ Acquire å…ˆåé¡ºåºå…·ä½“çœ‹ä¸‹é¢çš„ä»£ç </p>
<pre><pre class="playground"><code class="language-rust">fn write_x_then_y() {
    X.store(true, Ordering::Relaxed);
    Y.store(true, Ordering::Release);
}

fn read_y_then_x() {
    while !Y.load(Ordering::Acquire) {}
    if X.load(Ordering::Relaxed) {
        Z.fetch_add(1, Ordering::SeqCst);
    }
}

fn main() {
    let t1 = thread::spawn(move || {
        write_x_then_y();
    });

    let t2 = thread::spawn(move || {
        read_y_then_x();
    });

    t1.join().unwrap();
    t2.join().unwrap();

    assert_ne!(Z.load(Ordering::SeqCst), 0);
}
</code></pre></pre>
<h3 id="3-sequence"><a class="header" href="#3-sequence">3. Sequence</a></h3>
<p>é¡ºåºä¸€è‡´æ€§ï¼Œå¼ºåˆ¶æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°ä¸€è‡´çš„åŸå­æ“ä½œï¼Œå®Œå…¨çš„åˆ†ç•Œç‚¹ï¼ŒSeqCst å°±åƒæ˜¯ AcqRel
çš„åŠ å¼ºç‰ˆï¼Œå®ƒä¸ç®¡åŸå­æ“ä½œæ˜¯å±äºè¯»å–è¿˜æ˜¯å†™å…¥çš„æ“ä½œï¼Œåªè¦æŸä¸ªçº¿ç¨‹æœ‰ç”¨åˆ° SeqCst çš„åŸå­æ“ä½œï¼Œçº¿ç¨‹ä¸­è¯¥ SeqCst æ“ä½œå‰çš„æ•°æ®æ“ä½œç»å¯¹ä¸ä¼šè¢«é‡æ–°æ’åœ¨è¯¥
SeqCst æ“ä½œä¹‹åï¼Œä¸”è¯¥ SeqCst æ“ä½œåçš„æ•°æ®æ“ä½œä¹Ÿç»å¯¹ä¸ä¼šè¢«é‡æ–°æ’åœ¨ SeqCst æ“ä½œå‰ã€‚ä¸‹é¢çš„ä¾‹å­ï¼Œåªæœ‰ä½¿ç”¨ SeqCst
orderingï¼Œæ‰èƒ½ä¿è¯ Z æœ€åçš„å€¼ä¸ä¸º 0</p>
<pre><pre class="playground"><code class="language-rust">fn write_x() {
    X.store(true, Ordering::SeqCst);    // 1
}

fn write_y() {
    Y.store(true, Ordering::SeqCst);    // 2
}

fn read_x_then_y() {
    while !X.load(Ordering::SeqCst) {}
    if Y.load(Ordering::SeqCst) {       // 3
        Z.fetch_add(1, Ordering::SeqCst);
    }
}

fn read_y_then_x() {
    while !Y.load(Ordering::SeqCst) {}
    if X.load(Ordering::SeqCst) {       // 4
        Z.fetch_add(1, Ordering::SeqCst);
    }
}

fn main() {
        let t1 = thread::spawn(move || {
        write_x();
    });

    let t2 = thread::spawn(move || {
        write_y();
    });

    let t3 = thread::spawn(move || {
        read_x_then_y();
    });

    let t4 = thread::spawn(move || {
        read_y_then_x();
    });

    t1.join().unwrap();
    t2.join().unwrap();
    t3.join().unwrap();
    t4.join().unwrap();

    assert_ne!(Z.load(Ordering::SeqCst), 0);
}
</code></pre></pre>
<h3 id="4-fence"><a class="header" href="#4-fence">4. Fence</a></h3>
<p>fence æ˜¯æ”¯æŒ synchornized-with çš„å¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å’Œ Acquire-Release å¯¹æ¯”ä¸€ä¸‹</p>
<p>ä¾‹ 1ï¼š</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn producer() -&gt; JoinHandle&lt;()&gt; {
    thread::spawn(move || {
        unsafe {
            DATA = 100;                                 // A
        }
        READY.store(true, Ordering::Release);           // B: å†…å­˜å±éšœ â†‘
    })
}

fn consumer() -&gt; JoinHandle&lt;()&gt; {
    thread::spawn(move || {
        while !READY.load(Ordering::Acquire) {}         // C: å†…å­˜å±éšœ â†“

        assert_eq!(100, unsafe { DATA });               // D
    })
}
<span class="boring">}
</span></code></pre></pre>
<p>ä¾‹ 2ï¼š</p>
<pre><pre class="playground"><code class="language-rust">fn write_x_then_y() {
    X.store(true, Ordering::Relaxed); // 1
    fence(Ordering::Release);         // 2
    Y.store(true, Ordering::Relaxed); // 3
}

fn read_y_then_x() {
    while !Y.load(Ordering::Relaxed) {}  // 4
    fence(Ordering::Acquire);            // 5
    if X.load(Ordering::Relaxed) {       // 6
        Z.fetch_add(1, Ordering::SeqCst);
    }
}

fn main() {
    let t1 = thread::spawn(move || {
        write_x_then_y();
    });

    let t2 = thread::spawn(move || {
        read_y_then_x();
    });

    t1.join().unwrap();
    t2.join().unwrap();

    assert_ne!(Z.load(Ordering::SeqCst), 0);
}
</code></pre></pre>
<p><a href="https://doc.rust-lang.org/std/sync/atomic/fn.fence.html">fence çš„å®˜æ–¹æ–‡æ¡£</a> An atomic
fence. Depending on the specified order, a fence prevents the compiler and CPU
from reordering certain types of memory operations around it. That creates
synchronizes-with relationships between it and atomic operations or fences in
other threads.</p>
<p>A fence â€˜Aâ€™ which has (at least) Release ordering semantics, synchronizes with a
fence â€˜Bâ€™ with (at least) Acquire semantics, if and only if there exist
operations X and Y, both operating on some atomic object â€˜Mâ€™ such that A is
sequenced before X, Y is synchronized before B and Y observes the change to M.
This provides a happens-before dependence between A and B.</p>
<pre><code>    Thread 1                                          Thread 2

fence(Release);      A --------------
x.store(3, Relaxed); X ---------    |
                               |    |
                               |    |
                               -------------&gt; Y  if x.load(Relaxed) == 3 {
                                    |-------&gt; B      fence(Acquire);
                                                     ...
                                                 }
</code></pre>
<h2 id="å…¶ä»–-3"><a class="header" href="#å…¶ä»–-3">å…¶ä»–</a></h2>
<h3 id="1-tips"><a class="header" href="#1-tips">1. Tips</a></h3>
<ul>
<li>ä¸çŸ¥é“æ€ä¹ˆé€‰æ‹©æ—¶ï¼Œä¼˜å…ˆä½¿ç”¨ SeqCstï¼Œè™½ç„¶ä¼šç¨å¾®å‡æ…¢é€Ÿåº¦ï¼Œä½†æ˜¯æ…¢ä¸€ç‚¹ä¹Ÿæ¯”å‡ºç°é”™è¯¯å¥½</li>
<li>å¤šçº¿ç¨‹åªè®¡æ•° fetch_add è€Œä¸ä½¿ç”¨è¯¥å€¼è§¦å‘å…¶ä»–é€»è¾‘åˆ†æ”¯çš„ç®€å•ä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥ä½¿ç”¨ Relaxed å‚è€ƒ
<a href="https://stackoverflow.com/questions/30407121/which-stdsyncatomicordering-to-use">Which std::sync::atomic::Ordering to use?</a></li>
<li>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¦ä½¿ç”¨ Atomic éœ€è¦é…åˆ Arc</li>
</ul>
<h3 id="2-atomic-èƒ½æ›¿ä»£é”å—"><a class="header" href="#2-atomic-èƒ½æ›¿ä»£é”å—">2. Atomic èƒ½æ›¿ä»£é”å—ï¼Ÿ</a></h3>
<p>é‚£ä¹ˆåŸå­ç±»å‹æ—¢ç„¶è¿™ä¹ˆå…¨èƒ½ï¼Œå®ƒå¯ä»¥æ›¿ä»£é”å—ï¼Ÿç­”æ¡ˆæ˜¯ä¸è¡Œï¼š</p>
<ul>
<li>å¯¹äºå¤æ‚çš„åœºæ™¯ä¸‹ï¼Œé”çš„ä½¿ç”¨ç®€å•ç²—æš´ï¼Œä¸å®¹æ˜“æœ‰å‘</li>
<li>std::sync::atomic åŒ…ä¸­ä»…æä¾›äº†æ•°å€¼ç±»å‹çš„åŸå­æ“ä½œï¼šAtomicBool, AtomicIsize, AtomicUsize,
AtomicI8, AtomicU16 ç­‰ï¼Œè€Œé”å¯ä»¥åº”ç”¨äºå„ç§ç±»å‹</li>
<li>åœ¨æœ‰äº›æƒ…å†µä¸‹ï¼Œå¿…é¡»ä½¿ç”¨é”æ¥é…åˆï¼Œä¾‹å¦‚ä¸Šä¸€ç« èŠ‚ä¸­ä½¿ç”¨ Mutex é…åˆ Condvar</li>
</ul>
<h3 id="3-atomic-çš„åº”ç”¨åœºæ™¯"><a class="header" href="#3-atomic-çš„åº”ç”¨åœºæ™¯">3. Atomic çš„åº”ç”¨åœºæ™¯</a></h3>
<p>äº‹å®ä¸Šï¼ŒAtomic è™½ç„¶å¯¹äºç”¨æˆ·ä¸å¤ªå¸¸ç”¨ï¼Œä½†æ˜¯å¯¹äºé«˜æ€§èƒ½åº“çš„å¼€å‘è€…ã€æ ‡å‡†åº“å¼€å‘è€…éƒ½éå¸¸å¸¸ç”¨ï¼Œå®ƒæ˜¯å¹¶å‘åŸè¯­çš„åŸºçŸ³ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›åœºæ™¯é€‚ç”¨ï¼š</p>
<ul>
<li>æ— é” (lock free) æ•°æ®ç»“æ„</li>
<li>å…¨å±€å˜é‡ï¼Œä¾‹å¦‚å…¨å±€è‡ªå¢ IDï¼Œåœ¨åç»­ç« èŠ‚ä¼šä»‹ç»</li>
<li>è·¨çº¿ç¨‹è®¡æ•°å™¨ï¼Œä¾‹å¦‚å¯ä»¥ç”¨äºç»Ÿè®¡æŒ‡æ ‡</li>
</ul>
<h2 id="å¼•ç”¨-1"><a class="header" href="#å¼•ç”¨-1">å¼•ç”¨</a></h2>
<ul>
<li><a href="https://www.jianshu.com/p/511cde6b62a6">Rust å¹¶å‘ç¼–ç¨‹ - Memory Ordering (siddontang
)</a></li>
<li><a href="https://www.zhihu.com/question/24301047">çŸ¥ä¹</a></li>
<li><a href="http://senlinzhan.github.io/2017/12/04/cpp-memory-order/">ç†è§£ C++ çš„ Memory Order (Senlin's Blog)</a></li>
<li><a href="https://skyao.io/learning-rust/std/sync/atomic-type.html">Rust å­¦ä¹ ç¬”è®°</a></li>
<li><a href="https://course.rs/advance/concurrency-with-threads/sync2.html">rust è¯­è¨€åœ£ç»</a></li>
<li><a href="https://learnku.com/docs/nomicon/2018/83-atomic-operation/4742">Rust é«˜çº§ç¼–ç¨‹</a></li>
</ul>
<h2 id="èµ„æ–™-1"><a class="header" href="#èµ„æ–™-1">èµ„æ–™</a></h2>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/343688629">C è¯­è¨€ä¸¨æ·±å…¥ç†è§£ volatile å…³é”®å­—</a></li>
<li><a href="https://www.jianshu.com/p/765e3abbe89a">Java volatile ä¸‰å¤§ç‰¹æ€§è¯¦è§£</a></li>
<li><a href="https://juejin.cn/post/6844904177856937991">Java CAS å®ç°åŸç†</a></li>
<li><a href="https://monkeysayhi.github.io/2017/12/28/%E4%B8%80%E6%96%87%E8%A7%A3%E5%86%B3%E5%86%85%E5%AD%98%E5%B1%8F%E9%9A%9C/">ä¸€æ–‡è§£å†³å†…å­˜å±éšœ</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="io-å¤šè·¯å¤ç”¨"><a class="header" href="#io-å¤šè·¯å¤ç”¨">IO å¤šè·¯å¤ç”¨</a></h1>
<h2 id="rust-ä½¿ç”¨-epoll"><a class="header" href="#rust-ä½¿ç”¨-epoll">Rust ä½¿ç”¨ Epoll</a></h2>
<pre><code class="language-rs">use std::{
    collections::HashMap,
    io::{self, Read, Write},
    net::{TcpListener, TcpStream},
    os::unix::prelude::{AsRawFd, RawFd},
};

#[allow(unused_macros)]
macro_rules! syscall {
    ($fn: ident ( $($arg: expr),* $(,)* ) ) =&gt; {{
        let res = unsafe { libc::$fn($($arg, )*) };
        if res == -1 {
            Err(std::io::Error::last_os_error())
        } else {
            Ok(res)
        }
    }};
}

const HTTP_RESP: &amp;[u8] = b&quot;HTTP/1.1 200 OK
content-type: text/html
content-length: 5

Hello&quot;;

const READ_FLAGS: i32 = libc::EPOLLONESHOT | libc::EPOLLIN;
const WRITE_FLAGS: i32 = libc::EPOLLONESHOT | libc::EPOLLOUT;

#[derive(Debug)]
pub struct RequestContext {
    pub stream: TcpStream,
    pub content_length: usize,
    pub buf: Vec&lt;u8&gt;,
}

impl RequestContext {
    fn new(stream: TcpStream) -&gt; Self {
        Self {
            stream,
            buf: Vec::new(),
            content_length: 0,
        }
    }

    fn read_cb(&amp;mut self, key: u64, epoll_fd: RawFd) -&gt; io::Result&lt;()&gt; {
        let mut buf = [0u8; 4096];
        // è¿™é‡Œ stream åº”è¯¥ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨è¢«é€šçŸ¥åæ‰è°ƒç”¨çš„
        match self.stream.read(&amp;mut buf) {
            Ok(_) =&gt; {
                if let Ok(data) = std::str::from_utf8(&amp;buf) {
                    // å¦‚æœè¿™æ®µæ•°æ®æ˜¯å¼€å§‹ï¼Œå°±èƒ½è®¾ç½® Content-length.
                    // å¦‚æœæ˜¯ data çš„ä¸€éƒ¨åˆ†ï¼Œé‚£å°±ä»€ä¹ˆä¹Ÿä¸åšï¼Œå®‰å¿ƒè¯»å–å°±å®Œäº‹äº†
                    self.parse_and_set_content_length(data);
                }
            }
            Err(e) if e.kind() == io::ErrorKind::WouldBlock =&gt; {}
            Err(e) =&gt; {
                return Err(e);
            }
        }

        // æŠŠä¸´æ—¶ç¼“å†²åŒºçš„å†…å®¹è¿½åŠ åˆ°ç»“æ„ä½“ä¸Šä¸‹æ–‡é‡Œ
        self.buf.extend_from_slice(&amp;buf);

        // åˆ¤æ–­ä»¥ä¸‹è¯»æ²¡è¯»å®Œï¼Œå¦‚æœæ²¡æœ‰è¯»å®Œï¼Œå°±é‡æ–°æ³¨å†Œä¸ºè¯»ï¼Œä¸‹æ¬¡æ¥ç€è¯»ã€‚å¦åˆ™æ³¨å†Œä¸ºå†™ï¼Œç»™å®¢æˆ·ç«¯å›å¤
        if self.buf.len() &gt;= self.content_length {
            println!(&quot;got all data: {} bytes&quot;, self.buf.len());
            modify_interest(epoll_fd, self.stream.as_raw_fd(), listener_write_event(key))?;
        } else {
            println!(&quot;read not end: {} bytes&quot;, self.buf.len());
            modify_interest(epoll_fd, self.stream.as_raw_fd(), listener_read_event(key))?;
        }
        Ok(())
    }

    fn parse_and_set_content_length(&amp;mut self, data: &amp;str) {
        println!(&quot;{}&quot;, data);
        if data.contains(&quot;HTTP&quot;) {
            if let Some(content_length) = data
                .lines()
                .find(|x| x.to_lowercase().starts_with(&quot;content-length: &quot;))
            {
                if let Some(len) = content_length
                    .to_lowercase()
                    .strip_prefix(&quot;content-length: &quot;)
                {
                    self.content_length = len.parse::&lt;usize&gt;().expect(&quot;content-length is valid&quot;);
                    println!(&quot;set content length: {} bytes&quot;, self.content_length);
                }
            } else {
                println!(&quot;æ²¡è¯»åˆ° Content-Length&quot;);
            }
        }
        println!(&quot;ä¸æ˜¯ HTTP&quot;);
    }

    fn write_cb(&amp;mut self, key: u64, epoll_fd: RawFd) -&gt; io::Result&lt;()&gt; {
        match self.stream.write(HTTP_RESP) {
            Ok(_) =&gt; println!(&quot;answered from request {}&quot;, key),
            Err(e) =&gt; eprintln!(&quot;could not answer to request {}, {}&quot;, key, e),
        }
        self.stream.shutdown(std::net::Shutdown::Both)?;
        let fd = self.stream.as_raw_fd();
        remove_interest(epoll_fd, fd)?;
        unsafe { close(fd) };
        Ok(())
    }
}

fn main() -&gt; io::Result&lt;()&gt; {
    let mut listener = TcpListener::bind(&quot;127.0.0.1:8080&quot;).expect(&quot;ç»‘å®šç«¯å£å¤±è´¥&quot;);
    // è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼
    // å½“æˆ‘ä»¬ accept æ—¶ï¼Œå¦‚æœ socket æ²¡æœ‰å‡†å¤‡å¥½ï¼Œä¼šé˜»å¡ã€‚
    // è€Œç°åœ¨ä¼šç›´æ¥è¿”å›ä¸€ä¸ª io::ErrorKind::WouldBlock
    listener
        .set_nonblocking(true)
        .expect(&quot;set non-block failed&quot;);
    let listener_fd = listener.as_raw_fd();

    // åˆ›å»ºä¸€ä¸ª epollï¼Œå¹¶è¿”å›å®ƒçš„ fd
    // æœ‰äº†è¿™ä¸ª fdï¼Œæˆ‘ä»¬å°±èƒ½å¯¹äº‹ä»¶è¿›è¡Œæ“ä½œï¼ŒåŒ…æ‹¬è¯»å–ã€æ·»åŠ ã€ä¿®æ”¹ã€ç§»é™¤ã€‚
    let epoll_fd = epoll_create().expect(&quot;åˆ›å»º epoll å¤±è´¥&quot;);

    // å‘ epoll ä¸­æ³¨å†Œ listenerï¼Œå¹¶è®¾ç½®æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶æ˜¯è¯»
    let mut key = 100;
    add_interst(epoll_fd, listener_fd, listener_read_event(key))?;

    // ç°åœ¨æˆ‘ä»¬æœ‰äº† epollï¼Œä¹Ÿæ³¨å†Œäº†äº‹ä»¶ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯äº‹ä»¶å¾ªç¯
    let mut events: Vec&lt;libc::epoll_event&gt; = Vec::with_capacity(1024);
    let mut request_contexts: HashMap&lt;u64, RequestContext&gt; = HashMap::new();
    loop {
        events.clear();
        // epoll_wait å‘ç”Ÿé˜»å¡çš„æ¡ä»¶ï¼š
        // - æœ‰äº‹ä»¶å‘ç”Ÿ
        // - ä¿¡å·æŠŠå®ƒæ‰“æ–­
        // - è¶…æ—¶äº†
        //      - æˆ‘ä»¬å¯ä»¥æŠŠè¶…æ—¶äº‹ä»¶è®¾ç½®ä¸º -1ï¼Œè¿™æ · epoll_wait ä¼šä¸€åªé˜»å¡ï¼Œç›´åˆ°å‰ä¸¤ç§æƒ…å†µå‘ç”Ÿ
        // å½“ epoll_wait è¿”å›æ—¶ï¼Œå®ƒä¼šè¿”å›äº‹ä»¶çš„æ•°é‡
        let res = match syscall!(epoll_wait(
            epoll_fd,
            events.as_mut_ptr() as *mut libc::epoll_event,
            1024,
            1000 as libc::c_int, // è¶…æ—¶æ—¶é—´ï¼Œæ¯«ç§’ä¸ºå•ä½
        )) {
            Ok(v) =&gt; v,
            Err(e) =&gt; panic!(&quot;åœ¨ç­‰å¾… epoll æ—¶å‘ç”Ÿé”™è¯¯ï¼š{}&quot;, e),
        };

        // è®¾ç½® events çš„å®¹é‡
        unsafe { events.set_len(res as usize) };

        // å¤„ç†è¯·æ±‚
        for event in events.iter() {
            // å› ä¸ºæ²¡æœ‰ fdï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ key å»åˆ¤æ–­ï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯é‚£ä¸ª fd çš„ã€‚
            match event.u64 {
                // å¦‚æœæ˜¯ 100ï¼Œå°±è¯´æ˜æˆ‘ä»¬çš„ server æ¥æ”¶åˆ°äº†æ–°çš„è¿æ¥ã€‚
                100 =&gt; {
                    match listener.accept() {
                        Ok((stream, addr)) =&gt; {
                            // å°†å®¢æˆ·ç«¯è®¾ç½®ä¸ºéé˜»å¡çš„ï¼Œç»™ä»–ä¸€ä¸ª keyï¼Œå¹¶æ·»åŠ åˆ°åˆ° epoll ä¸­
                            stream
                                .set_nonblocking(true)
                                .expect(&quot;è¿™é‡Œåœ¨æ­¤è®¾ç½®äº† non-blocking&quot;);
                            println!(&quot;new client: {}&quot;, addr);
                            key += 1;
                            add_interst(epoll_fd, stream.as_raw_fd(), listener_read_event(key))
                                .expect(&quot;å‘ç”Ÿä»€ä¹ˆæ˜¯äº†ï¼Œå®¢æˆ·ç«¯è£‚å¼€äº†ï¼Ÿ&quot;);
                            // è¿™é‡Œ
                            request_contexts.insert(key, RequestContext::new(stream));
                        }
                        Err(e) =&gt; eprintln!(&quot;couldn't accept: {}&quot;, e),
                    }
                    // å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ ONESHORT äº‹ä»¶ç›‘å¬å™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»é‡æ–°æ³¨å†Œ server
                    modify_interest(epoll_fd, listener_fd.as_raw_fd(), listener_read_event(100))
                        .expect(&quot;é‡ç½® server å¤±è´¥&quot;);
                }
                // å¦‚æœä¸æ˜¯ key ä¸æ˜¯ 100ï¼Œé‚£å°±æ˜¯å…¶ä»–çš„å®¢æˆ·ç«¯è¿æ¥ã€‚
                key =&gt; {
                    // ç”¨ hashmap å»åŒ¹é…æ˜¯é‚£ä¸ªè¿æ¥
                    if let Some(context) = request_contexts.get_mut(&amp;key) {
                        let events = event.events;
                        match events {
                            // å¦‚æœå¯è¯»ï¼Œå°±å»è¯»ï¼Œå¦‚æœæ²¡è¯»å®Œï¼Œå°±é‡æ–°æ³¨å†Œè¯»ï¼Œè¯»å®Œäº†å°†å…´è¶£ç‚¹æ”¹ä¸ºå†™
                            v if v as i32 &amp; libc::EPOLLIN == libc::EPOLLIN =&gt; {
                                // è¯»å–æ•°æ®
                                context.read_cb(key, epoll_fd)?;
                            }
                            // è¿”å›æ•°æ®ï¼Œclose(fd), shutdown(stream), remove_interest(epoll_fd, fd)
                            v if v as i32 &amp; libc::EPOLLOUT == libc::EPOLLOUT =&gt; {
                                context.write_cb(key, epoll_fd)?;
                                // åŒæ—¶ç§»å‡º hashmap
                                request_contexts.remove(&amp;key);
                            }
                            v =&gt; println!(&quot;unexpected events: {}&quot;, v),
                        }
                    }
                }
            }
        }
    }
    println!(&quot;Hello, world!&quot;);
    Ok(())
}

/// å‘ epoll ä¸­ä¼ å…¥ä¸€ä¸ªæ„Ÿå…´è¶£çš„è¿æ¥
///
/// epoll_fd: epoll çš„ fd
/// fdï¼šå°†è¦è¢« epoll ç®¡ç†çš„ fd
/// eventï¼šè¢«é€šçŸ¥äº‹ä»¶ç±»å‹ã€‚
///
/// å½“ fd ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ¯”å¦‚è¯»æˆ–è€…æ˜¯å†™ï¼Œè¿™ä¸ªäº‹ä»¶å‘ç”Ÿå epoll å°±ä¼šé€šçŸ¥æˆ‘ä»¬ï¼Œå¹¶å°† fd ä» epoll ä¸­åˆ é™¤
/// å› æ­¤å¦‚æœæˆ‘ä»¬éœ€è¦ç»§ç»­è¯»å–ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°æ³¨å†Œè¿™ä¸ª fd
fn add_interst(epoll_fd: RawFd, fd: RawFd, mut event: libc::epoll_event) -&gt; io::Result&lt;()&gt; {
    syscall!(epoll_ctl(epoll_fd, libc::EPOLL_CTL_ADD, fd, &amp;mut event))?;
    Ok(())
}
fn modify_interest(epoll_fd: RawFd, fd: RawFd, mut event: libc::epoll_event) -&gt; io::Result&lt;()&gt; {
    // æ”¹ç”¨ EPOLL_CTL_MOD æ ‡å¿—ï¼Œå› ä¸ºä¹‹å‰å·²ç»è¢«æ·»åŠ è¿‡
    syscall!(epoll_ctl(epoll_fd, libc::EPOLL_CTL_MOD, fd, &amp;mut event))?;
    Ok(())
}
fn close(fd: RawFd) {
    let _ = syscall!(close(fd));
}
fn remove_interest(epoll_fd: RawFd, fd: RawFd) -&gt; io::Result&lt;()&gt; {
    // æ”¹ç”¨ EPOLL_CTL_MOD æ ‡å¿—ï¼Œå› ä¸ºä¹‹å‰å·²ç»è¢«æ·»åŠ è¿‡
    syscall!(epoll_ctl(
        epoll_fd,
        libc::EPOLL_CTL_DEL,
        fd,
        std::ptr::null_mut()
    ))?;
    Ok(())
}

/// ç”Ÿæˆä¸€ä¸ªäº‹ä»¶ç±»å‹
///
/// key æ˜¯æˆ‘ä»¬ä¸ºè¯¥äº‹ä»¶è®¾ç½®çš„ id
///
/// å¯¹äº listenerï¼Œæˆ‘ä»¬åªå¯¹è¯»äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå› æ­¤è¿™é‡Œåªæœ‰ READ_FLAG
fn listener_read_event(key: u64) -&gt; libc::epoll_event {
    libc::epoll_event {
        events: READ_FLAGS as u32,
        u64: key,
    }
}

fn listener_write_event(key: u64) -&gt; libc::epoll_event {
    libc::epoll_event {
        events: WRITE_FLAGS as u32,
        u64: key,
    }
}

fn epoll_create() -&gt; io::Result&lt;RawFd&gt; {
    let fd = syscall!(epoll_create1(0))?;
    if let Ok(flags) = syscall!(fcntl(fd, libc::F_GETFD)) {
        let _ = syscall!(fcntl(fd, libc::F_SETFD, flags | libc::FD_CLOEXEC));
    }
    Ok(fd)
}

#[cfg(test)]
mod test {
    #[test]
    fn test() {
        let a = [232, 183, 159];
        let s = std::str::from_utf8(&amp;a[..]).unwrap();
        dbg!(s);
    }
}
</code></pre>
<h2 id="å…¶ä»–-4"><a class="header" href="#å…¶ä»–-4">å…¶ä»–</a></h2>
<h3 id="errnoh"><a class="header" href="#errnoh">errno.h</a></h3>
<h4 id="å®šä¹‰-1"><a class="header" href="#å®šä¹‰-1">å®šä¹‰</a></h4>
<p>è¯¥å¤´æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª int ç±»å‹çš„å·¦å€¼ï¼Œerrnoï¼ŒåŒ…å«äº†ä»»ä½•å‡½æ•°ä½¿ç”¨ errno åŠŸèƒ½æ—¶ä¼šäº§ç”Ÿçš„é”™è¯¯ç </p>
<ul>
<li>EINTRï¼šè¡¨ç¤ºè¢«ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨</li>
</ul>
<h4 id="ä¿®æ”¹-errno-çš„å€¼"><a class="header" href="#ä¿®æ”¹-errno-çš„å€¼">ä¿®æ”¹ errno çš„å€¼</a></h4>
<p>errno çš„é»˜è®¤å€¼ä¸º 0, å½“	è°ƒç”¨ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œå¯èƒ½ä¼šæ¥å—åˆ°æŸä¸ªä¿¡å·å¯¼è‡´è°ƒç”¨é€€å‡ºï¼Œå¹¶è¿”å›ä¸€ä¸ªé”™è¯¯ç ï¼Œå¹¶ä¿®æ”¹ errno çš„å€¼ï¼Œå¯ä»¥é€šè¿‡ errno åˆ¤æ–­ç³»ç»Ÿè°ƒç”¨æ˜¯å¦å¤±è´¥ï¼Œ</p>
<h4 id="é”™è¯¯ç å¯¹ä¸åŒå‡½æ•°æœ‰ä¸åŒæ„ä¹‰"><a class="header" href="#é”™è¯¯ç å¯¹ä¸åŒå‡½æ•°æœ‰ä¸åŒæ„ä¹‰">é”™è¯¯ç å¯¹ä¸åŒå‡½æ•°æœ‰ä¸åŒæ„ä¹‰</a></h4>
<ul>
<li>
<p>write: ç”±äºä¿¡å·ä¸­æ–­ï¼Œæ²¡å†™æˆåŠŸä»»ä½•æ•°æ®ã€‚</p>
<blockquote>
<p>The call was interrupted by a signal before any data was written.</p>
</blockquote>
</li>
<li>
<p>read: ç”±äºä¿¡å·ä¸­æ–­ï¼Œæ²¡è¯»åˆ°ä»»ä½•æ•°æ®ã€‚</p>
<blockquote>
<p>The call was interrupted by a signal before any data was read.</p>
</blockquote>
</li>
<li>
<p>sem_wait: å‡½æ•°è°ƒç”¨è¢«ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ–­</p>
<blockquote>
<p>The call was interrupted by a signal handler.</p>
</blockquote>
</li>
<li>
<p>recv: ç”±äºä¿¡å·ä¸­æ–­è¿”å›ï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®å¯ç”¨ã€‚</p>
<blockquote>
<p>function was interrupted by a signal that was caught, before any data was
available.</p>
</blockquote>
</li>
</ul>
<h4 id="å¦‚ä½•åº”å¯¹"><a class="header" href="#å¦‚ä½•åº”å¯¹">å¦‚ä½•åº”å¯¹</a></h4>
<p>å½“ç¢°åˆ° EINTR é”™è¯¯çš„æ—¶å€™ï¼Œå¯ä»¥é‡‡å–æœ‰ä¸€äº›å¯ä»¥é‡å¯çš„ç³»ç»Ÿè°ƒç”¨è¦è¿›è¡Œé‡å¯ï¼Œè€Œå¯¹äºæœ‰ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ˜¯ä¸èƒ½å¤Ÿé‡å¯çš„ã€‚ä¾‹å¦‚ï¼šacceptã€readã€writeã€selectã€å’Œ open ä¹‹ç±»çš„å‡½æ•°æ¥è¯´ï¼Œæ˜¯å¯ä»¥è¿›è¡Œé‡å¯çš„ã€‚ä¸è¿‡å¯¹äºå¥—æ¥å­—ç¼–ç¨‹ä¸­çš„ connect å‡½æ•°æˆ‘ä»¬æ˜¯ä¸èƒ½é‡å¯çš„ï¼Œè‹¥ connect å‡½æ•°è¿”å›ä¸€ä¸ª EINTR é”™è¯¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½å†æ¬¡è°ƒç”¨å®ƒï¼Œå¦åˆ™å°†ç«‹å³è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚é’ˆå¯¹ connect ä¸èƒ½é‡å¯çš„å¤„ç†æ–¹æ³•æ˜¯ï¼Œå¿…é¡»è°ƒç”¨ select æ¥ç­‰å¾…è¿æ¥å®Œæˆã€‚</p>
<p>ç³»ç»Ÿä¸­æ–­ä¸ä¸€å®šè¢«å½“ä½œé”™è¯¯</p>
<ul>
<li>
<p>å¦‚æœé”™è¯¯ç ä¸º EINTR åˆ™ <strong>é‡æ–°è°ƒç”¨ç³»ç»Ÿè°ƒç”¨</strong> ,ä¾‹å¦‚ Postgresql ä¸­æœ‰ä¸€æ®µä»£ç ï¼š</p>
<pre><code class="language-c">retry1:
if (send(port-&gt;sock, &amp;SSLok, 1, 0) != 1)
{
    if (errno == EINTR)
        goto retry1; /* if interrupted, just retry */
}
</code></pre>
</li>
<li>
<p><strong>é‡æ–°å®šä¹‰ç³»ç»Ÿè°ƒç”¨</strong>,å¿½ç•¥é”™è¯¯ç ä¸º EINTR çš„æƒ…å†µã€‚ä¾‹å¦‚ï¼ŒCherokee ä¸­çš„ä¸€æ®µä»£ç ï¼š</p>
<pre><code class="language-c">int cherokee_stat (const char *restrict path, struct stat *buf)
{
  int re;
  do {
     re = stat (path, buf);
  } while ((re == -1) &amp;&amp; (errno == EINTR));
  return re;
}
</code></pre>
</li>
</ul>
<h4 id="å¦‚ä½•ä¿è¯çº¿è¿›ç¨‹å®‰å…¨"><a class="header" href="#å¦‚ä½•ä¿è¯çº¿è¿›ç¨‹å®‰å…¨">å¦‚ä½•ä¿è¯çº¿/è¿›ç¨‹å®‰å…¨</a></h4>
<blockquote>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä¿è¯ errno çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯ä¸ºäº†å¦¥å–„æœŸé—´ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å†™ makefile çš„æ—¶ å€™æŠŠ _LIBC_REENTRANT å®å®šä¹‰ï¼Œæ¯”
å¦‚æˆ‘ä»¬åœ¨æ£€æŸ¥ &lt;bits/errno.h&gt; æ–‡ä»¶ä¸­å‘ç°å¦‚ä¸‹çš„å®šä¹‰ï¼š</p>
</blockquote>
<pre><code class="language-c"># ifndef __ASSEMBLER__
/* Function to get address of global `errno' variable. */
extern int *__errno_location (void) __THROW __attribute__ ((__const__));


# if !defined _LIBC || defined _LIBC_REENTRANT
/* When using threads, errno is a per-thread value. */
# define errno (*__errno_location ())
# endif
# endif /* !__ASSEMBLER__ */
#endif /* _ERRNO_H */
</code></pre>
<blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ²¡æœ‰å®šä¹‰ __LIBC æˆ–è€…å®šä¹‰ _LIBC_REENTRANT çš„æ—¶å€™ï¼Œerrno æ˜¯å¤šçº¿ç¨‹ / è¿›ç¨‹å®‰å…¨çš„ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œ
<strong>ASSEMBLER</strong>, _LIBC å’Œ _LIBC_REENTRANT éƒ½ä¸ä¼šè¢«ç¼–è¯‘å™¨å®šä¹‰ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬å®šä¹‰ _LIBC_REENTRANT
ä¸€æ¬¡åˆä½•å¦¨é‚£ï¼Ÿä¸ºäº†æ£€æµ‹ä¸€ä¸‹ä½ ç¼–è¯‘å™¨æ˜¯å¦å®šä¹‰ä¸Šè¿°å˜é‡ï¼Œä¸å¦¨ä½¿ç”¨ä¸‹é¢ä¸€ä¸ªç®€å•ç¨‹åºã€‚</p>
</blockquote>
<p>å¸Œæœ›è¯»è€…åœ¨è¿›è¡Œç§»æ¤çš„æ—¶å€™ï¼Œè¯»ä¸€ä¸‹ç›¸å…³çš„ unix ç‰ˆæœ¬çš„ &lt;bits/errno.h&gt; æ–‡ ä»¶ï¼Œæ¥ç¡®å®šåº”è¯¥å®šä¹‰ä»€ä¹ˆå®ã€‚ä¸åŒçš„ unix
ç‰ˆæœ¬å¯èƒ½å­˜åœ¨ç€ä¸€äº›å°çš„å·®åˆ«ï¼</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;

int main(void)
{
   #ifndef __ASSEMBLER__
   printf( &quot;Undefine __ASSEMBLER__\n&quot; );
   #else
   printf( &quot;define __ASSEMBLER__\n&quot; );
   #endif

   #ifndef __LIBC
   printf( &quot;Undefine __LIBC\n&quot; );
   #else
   printf( &quot;define __LIBC\n&quot; );
   #endif

   #ifndef _LIBC_REENTRANT
   printf( &quot;Undefine _LIBC_REENTRANT\n&quot; );
   #else
   printf( &quot;define _LIBC_REENTRANT\n&quot; );
   #endif

   return 0;
}
</code></pre>
<p>å‚è€ƒï¼šhttps://blog.csdn.net/hnlyyk/article/details/51444617</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="cicd"><a class="header" href="#cicd">CI/CD</a></h1>
<p>ğŸ¤¤è¿™ä¸œè¥¿ç®€ç›´å¤ªæ£’äº†ï¼</p>
<h2 id="è‡ªåŠ¨éƒ¨ç½²-github-page"><a class="header" href="#è‡ªåŠ¨éƒ¨ç½²-github-page">è‡ªåŠ¨éƒ¨ç½² Github Page</a></h2>
<ul>
<li>è¿™é‡Œä½¿ç”¨ source åˆ†æ”¯ä½œä¸ºå†™æ–‡æ¡£çš„åˆ†æ”¯</li>
<li>push åè‡ªåŠ¨ build (è¿™é‡Œä½¿ç”¨<code>borales/actions-yarn@v2.3.0</code>ï¼Œå¦‚æœä½¿ç”¨ npmï¼Œéœ€è¦<code>set-node</code>)</li>
<li>å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶å‘å¸ƒåˆ° master åˆ†æ”¯ä¸Š (ä½¿ç”¨<code>peaceiris/actions-github-pages@v3.1.12</code>)</li>
</ul>
<pre><code class="language-yml">name: Github Page

on:
  push:
    branches:
     - source

jobs:
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    # å¼€å§‹ job
    steps:
      # from [actions/checkout](https://github.com/actions/checkout#checkout-v2)
      # This action checks-out your repository under $GITHUB_WORKSPACE, so your workflow can access it.
      # å±äºæ˜¯å¿…è¦é€‰é¡¹äº†ï¼Œèƒ½å¤Ÿæ‹¿åˆ°å½“å‰åˆ†æ”¯ï¼Œå¯¹åº”è¿™é‡Œå°±æ˜¯ source åˆ†æ”¯
      - uses: actions/checkout@v2

      # ä½¿ç”¨ yarn

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        uses: borales/actions-yarn@v2.3.0
        with:
          cmd: install # will run `yarn install` command

      - name: Build
        uses: borales/actions-yarn@v2.3.0
        with:
          cmd: build # will run `yarn build` command

      # æŠŠ disk æ–‡ä»¶å‘å¸ƒåˆ°å¦ä¸€ä¸ª branch
      - name: Deploy with &lt;GitHub Pages v3&gt;
        uses: peaceiris/actions-github-pages@v3.1.12
        with:
          # å‘å¸ƒåˆ°å½“å‰ä»“åº“
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # çš„ main åˆ†æ”¯
          publish_branch: main
          # è¦å‘å¸ƒçš„æ–‡ä»¶å¤¹
          publish_dir: ./docs/.vuepress/dist
</code></pre>
<h2 id="è‡ªåŠ¨-release"><a class="header" href="#è‡ªåŠ¨-release">è‡ªåŠ¨ Release</a></h2>
<ul>
<li>å®ä¾‹ä½¿ç”¨ dev ä½œä¸ºå¼€å‘åˆ†æ”¯</li>
<li>å½“ push æœ‰æ ‡ç­¾æ—¶ï¼ŒæŠŠ release çš„æ–‡ä»¶è‡ªåŠ¨å‘å¸ƒ (<code>softprops/action-gh-release@v1</code>)</li>
<li>åŒæ—¶æŠŠåˆ†æ”¯åŒæ­¥åˆ° <code>master</code> ä¸Š (<code>tretuna/sync-branches@1.4.0</code>)</li>
</ul>
<pre><code class="language-yml">name: Release

on:
  push:
    branches: [ dev ]
    tags:
      - &quot;v*&quot;

env:
  CARGO_TERM_COLOR: always

jobs:
  release:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Build
      run: cargo build --verbose

    - name: Run tests
      run: cargo test --verbose

    - name: Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./target/debug/yarm

    - name: Opening pull request
      uses: tretuna/sync-branches@1.4.0
      with:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        FROM_BRANCH: &quot;dev&quot;
        TO_BRANCH: &quot;master&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ–‡ä»¶ç³»ç»Ÿ"><a class="header" href="#æ–‡ä»¶ç³»ç»Ÿ">æ–‡ä»¶ç³»ç»Ÿ</a></h1>
<h2 id="1-inode"><a class="header" href="#1-inode">1. inode</a></h2>
<h3 id="11-ä»€ä¹ˆæ˜¯-inode"><a class="header" href="#11-ä»€ä¹ˆæ˜¯-inode">1.1 ä»€ä¹ˆæ˜¯ inode</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021258963.png" alt="" />
æ–‡ä»¶å­˜å‚¨åœ¨ç¡¬ç›˜ä¸Šï¼Œç¡¬ç›˜çš„æœ€å°å­˜å‚¨å•å…ƒæ˜¯æ‰‡åŒºï¼Œç¡¬ç›˜ä¼šæŒ‰ç…§å¤šä¸ªæ‰‡åŒºæŒ‰å—è¯»å–æ‰‡åŒºï¼Œä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®å°±è¢«å­˜å‚¨åœ¨å¤šä¸ªå—ä¸­ï¼Œ
åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æœ‰ä¸€ä¸ªåœ°æ–¹å­˜å‚¨æ–‡ä»¶çš„å…ƒä¿¡æ¯ã€‚è¿™ç§å­˜å‚¨æ–‡ä»¶å…ƒä¿¡æ¯çš„åŒºåŸŸå°±å«åš inodeï¼ˆç´¢å¼•èŠ‚ç‚¹ï¼‰ã€‚</p>
<h3 id="12-inode-çš„å†…å®¹"><a class="header" href="#12-inode-çš„å†…å®¹">1.2 inode çš„å†…å®¹</a></h3>
<p>æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„ inode æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>stat xxx</code> å»æŸ¥çœ‹ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ–‡ä»¶å¤§å°</li>
<li>æ–‡ä»¶çš„æ‹¥æœ‰è€…</li>
<li>æ–‡ä»¶çš„ Group ID</li>
<li>æ–‡ä»¶çš„è¯»å†™æ‰§è¡Œæƒé™</li>
<li>æ–‡ä»¶çš„æ—¶é—´æˆ³ï¼Œctimeï¼šåˆ›å»ºæ—¶é—´ï¼Œmtimeï¼šä¿®æ”¹æ—¶é—´ï¼Œatimeï¼šæ‰“å¼€æ—¶é—´</li>
<li>é“¾æ¥æ•°ï¼šæ¯”å¦‚åˆ›å»ºè½¯é“¾æ¥ï¼Œå†æ¬¡æŸ¥çœ‹å°±ä¼šå¤š 1</li>
<li>æ•°æ®å—çš„ä½ç½®</li>
</ul>
<p>ä¸è¿‡å•å•æ²¡æœ‰æ–‡ä»¶åå°±ç¦»è°±</p>
<pre><code class="language-sh">[trthg@trthg--manjaro ioclub]$ stat package.json
  File: package.json
  Size: 1006            Blocks: 8          IO Block: 4096   regular file
Device: 0,39    Inode: 4528790     Links: 1
Access: (0644/-rw-r--r--)  Uid: ( 1000/   trthg)   Gid: ( 1001/   trthg)
Access: 2021-11-01 22:00:54.464935992 +0800
Modify: 2021-11-01 22:00:54.464935992 +0800
Change: 2021-11-01 22:00:54.464935992 +0800
 Birth: 2021-11-01 22:00:54.464935992 +0800
</code></pre>
<h3 id="13-inode-çš„å¤§å°"><a class="header" href="#13-inode-çš„å¤§å°">1.3 inode çš„å¤§å°</a></h3>
<ol>
<li>inode ä¸ æ•°æ®å—æœ¬èº«ä¼šå‚¨å­˜åœ¨ä¸åŒçš„åŒºåŸŸï¼Œç¡¬ç›˜æ ¼å¼åŒ–æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠç¡¬ç›˜åˆ†ä¸ºä¸¤ä¸ªåŒºï¼Œæ•°æ®åŒºå’Œ inode åŒº</li>
<li>inode èŠ‚ç‚¹çš„å¤§å°ä¸€èˆ¬åœ¨æ ¼å¼åŒ–æ—¶å°±ç»™å®šï¼Œä¸€èˆ¬æ˜¯ 128 æˆ– 256 å­—èŠ‚</li>
<li>ä¸€èˆ¬æ¯ 1-2kb å°±ä¼šè®¾ç½®ä¸€ä¸ª inodeï¼Œå‡å®šåœ¨ä¸€å— 1GB çš„ç¡¬ç›˜ä¸­ï¼Œæ¯ä¸ª inode èŠ‚ç‚¹çš„å¤§å°ä¸º 128 å­—èŠ‚ï¼Œæ¯ 1KB å°±è®¾ç½®ä¸€ä¸ª inodeï¼Œé‚£ä¹ˆ inode
table çš„å¤§å°å°±ä¼šè¾¾åˆ° 128MBï¼Œå æ•´å—ç¡¬ç›˜çš„ 12.8%ã€‚</li>
</ol>
<p>æŸ¥çœ‹æ¯ä¸ªç¡¬ç›˜åˆ†åŒºçš„ inode æ€»æ•°ï¼Œå’Œå·²ç»ä½¿ç”¨çš„æ•°é‡</p>
<pre><code class="language-sh">[trthg@trthg--manjaro ioclub]$ df -i
Filesystem     Inodes IUsed IFree IUse% Mounted on
dev              1.9M   585  1.9M    1% /dev
run              1.9M  1.1K  1.9M    1% /run
/dev/nvme0n1p2      0     0     0     - /
tmpfs            1.9M   175  1.9M    1% /dev/shm
/dev/nvme0n1p2      0     0     0     - /home
/dev/nvme0n1p2      0     0     0     - /var/cache
/dev/nvme0n1p2      0     0     0     - /var/log
tmpfs            400K  3.8K  397K    1% /tmp
/dev/nvme0n1p1      0     0     0     - /boot/efi
tmpfs            386K   303  386K    1% /run/user/1000
</code></pre>
<p>æŸ¥çœ‹ inode å¤§å°</p>
<p>æ²¡æ‰¾åˆ°</p>
<h3 id="14-inode-å·ç "><a class="header" href="#14-inode-å·ç ">1.4 inode å·ç </a></h3>
<p>æ¯ä¸ª inode éƒ½æœ‰ä¸€ä¸ª id ç›¸å½“ä¸ï¼Œæ“ä½œç³»ç»Ÿç”¨è¿™ä¸ª id æ¥è¯†åˆ«æ–‡ä»¶</p>
<pre><code class="language-sh">[trthg@trthg--manjaro ioclub]$ ls -i package.json
4528790 package.json
</code></pre>
<h3 id="15-ç›®å½•æ–‡ä»¶"><a class="header" href="#15-ç›®å½•æ–‡ä»¶">1.5 ç›®å½•æ–‡ä»¶</a></h3>
<p>ç›®å½•æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œç›®å½•æ–‡ä»¶æœ¬èº«ç»“æ„ç®€å•ï¼Œå®ƒå­˜å‚¨çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­å­˜å‚¨ç›®å½•é¡¹</p>
<p>ç›®å½•é¡¹å­˜å‚¨çš„ï¼š</p>
<ul>
<li>æ–‡ä»¶å</li>
<li>æ–‡ä»¶çš„ inode å·</li>
</ul>
<p>å¯ä»¥ç”¨ <code>ls -i dir</code> æŸ¥çœ‹è¯¥ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶åå’Œ inode</p>
<p>ç›®å½•æ–‡ä»¶çš„è¯»æƒé™ï¼ˆrï¼‰å’Œå†™æƒé™ï¼ˆwï¼‰ï¼Œéƒ½æ˜¯é’ˆå¯¹ç›®å½•æ–‡ä»¶æœ¬èº«ã€‚ç”±äºç›®å½•æ–‡ä»¶å†…åªæœ‰æ–‡ä»¶åå’Œ inode å·ç ï¼Œè¯»å– inode èŠ‚ç‚¹å†…çš„ä¿¡æ¯éœ€è¦ç›®å½•æ–‡ä»¶çš„æ‰§è¡Œæƒé™ï¼ˆxï¼‰ï¼Œ
æ‰€ä»¥å¦‚æœåªæœ‰è¯»æƒé™ï¼Œåªèƒ½è·å–æ–‡ä»¶åï¼Œæ— æ³•è·å–å…¶ä»–ä¿¡æ¯ï¼Œå› ä¸ºå…¶ä»–ä¿¡æ¯éƒ½å‚¨å­˜åœ¨ inode èŠ‚ç‚¹ä¸­ï¼Œè€Œ</p>
<h3 id="16-ç¡¬é“¾æ¥"><a class="header" href="#16-ç¡¬é“¾æ¥">1.6 ç¡¬é“¾æ¥</a></h3>
<p>æœ‰äº†ä¸Šé¢çš„çŸ¥è¯†å°±èƒ½ç†è§£äº†ï¼Œç¡¬é“¾æ¥å°±æ˜¯æŒ‡å¤šä¸ªæ–‡ä»¶åå¯ä»¥æŒ‡å‘åŒä¸€ä¸ª inode å·ï¼Œ <code>.</code> å’Œ <code>..</code> å°±æ˜¯ç¡¬é“¾æ¥ï¼ŒåŠ äº†ä¸€ä¸ªç¡¬é“¾æ¥ï¼ŒåŸæ–‡ä»¶çš„ LINK æ•°å°±ä¼š
+1</p>
<h3 id="17-è½¯é“¾æ¥"><a class="header" href="#17-è½¯é“¾æ¥">1.7 è½¯é“¾æ¥</a></h3>
<p>è½¯é“¾æ¥æŒ‡çš„æ˜¯ä¸€ä¸ªæ–‡ä»¶çš„å†…å®¹å­˜å‚¨çš„æ˜¯å¦ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼Œè®¿é—® A å°±ä¼šè‡ªåŠ¨å¯¼å‘ B</p>
<p><code>ln -s</code></p>
<h3 id="18-å…¶ä»–"><a class="header" href="#18-å…¶ä»–">1.8 å…¶ä»–</a></h3>
<p><strong>å…«ã€inode çš„ç‰¹æ®Šä½œç”¨</strong></p>
<p>ç”±äº inode å·ç ä¸æ–‡ä»¶ååˆ†ç¦»ï¼Œè¿™ç§æœºåˆ¶å¯¼è‡´äº†ä¸€äº› Unix/Linux ç³»ç»Ÿç‰¹æœ‰çš„ç°è±¡ã€‚</p>
<ol>
<li>
<p>æœ‰æ—¶ï¼Œæ–‡ä»¶ååŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œæ— æ³•æ­£å¸¸åˆ é™¤ã€‚è¿™æ—¶ï¼Œç›´æ¥åˆ é™¤ inode èŠ‚ç‚¹ï¼Œå°±èƒ½èµ·åˆ°åˆ é™¤æ–‡ä»¶çš„ä½œç”¨ã€‚</p>
</li>
<li>
<p>ç§»åŠ¨æ–‡ä»¶æˆ–é‡å‘½åæ–‡ä»¶ï¼Œåªæ˜¯æ”¹å˜æ–‡ä»¶åï¼Œä¸å½±å“ inode å·ç ã€‚</p>
</li>
<li>
<p>æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ä»¥åï¼Œç³»ç»Ÿå°±ä»¥ inode å·ç æ¥è¯†åˆ«è¿™ä¸ªæ–‡ä»¶ï¼Œä¸å†è€ƒè™‘æ–‡ä»¶åã€‚å› æ­¤ï¼Œé€šå¸¸æ¥è¯´ï¼Œç³»ç»Ÿæ— æ³•ä» inode å·ç å¾—çŸ¥æ–‡ä»¶åã€‚</p>
</li>
</ol>
<p>ç¬¬ 3 ç‚¹ä½¿å¾—è½¯ä»¶æ›´æ–°å˜å¾—ç®€å•ï¼Œå¯ä»¥åœ¨ä¸å…³é—­è½¯ä»¶çš„æƒ…å†µä¸‹è¿›è¡Œæ›´æ–°ï¼Œä¸éœ€è¦é‡å¯ã€‚å› ä¸ºç³»ç»Ÿé€šè¿‡ inode å·ç ï¼Œè¯†åˆ«è¿è¡Œä¸­çš„æ–‡ä»¶ï¼Œä¸é€šè¿‡æ–‡ä»¶åã€‚æ›´æ–°çš„æ—¶å€™ï¼Œæ–°ç‰ˆæ–‡ä»¶ä»¥åŒæ ·çš„æ–‡ä»¶åï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ inodeï¼Œä¸ä¼šå½±å“åˆ°è¿è¡Œä¸­çš„æ–‡ä»¶ã€‚ç­‰åˆ°ä¸‹ä¸€æ¬¡è¿è¡Œè¿™ä¸ªè½¯ä»¶çš„æ—¶å€™ï¼Œæ–‡ä»¶åå°±è‡ªåŠ¨æŒ‡å‘æ–°ç‰ˆæ–‡ä»¶ï¼Œæ—§ç‰ˆæ–‡ä»¶çš„ inode åˆ™è¢«å›æ”¶ã€‚</p>
<h2 id="2-æ–‡ä»¶æè¿°ç¬¦"><a class="header" href="#2-æ–‡ä»¶æè¿°ç¬¦">2. æ–‡ä»¶æè¿°ç¬¦</a></h2>
<blockquote>
<p>Advanced Programming in the UNIXÂ® Environment: Second Edition By W. Richard
Stevens, Stephen A. Rago</p>
<p><a href="https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.458.2318&amp;rep=rep1&amp;type=pdf">ä¹¦é‡Œæœ‰æ›´è¯¦ç»†çš„è§£é‡Š</a></p>
</blockquote>
<h3 id="21-ä¸-inode-çš„åŒºåˆ«"><a class="header" href="#21-ä¸-inode-çš„åŒºåˆ«">2.1 ä¸ inode çš„åŒºåˆ«</a></h3>
<p>inode æœ¬èº«åªæ˜¯å¯¹åº”æ²¡ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†æ˜¯ä¸€ä¸ªæ–‡ä»¶èƒ½è¢«å¤šä¸ªäººæ‰“å¼€ï¼Œå› æ­¤éœ€è¦æœ‰ fd å»è®°å½•æ–‡ä»¶çš„æ‰“å¼€çŠ¶æ€</p>
<p>å†…æ ¸ç»´æŠ¤ä¸€ä¸ªå†…æ ¸çº§æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå­˜å‚¨äº†ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ–‡ä»¶åç§»é‡</li>
<li>æ–‡ä»¶çš„æ‰“å¼€çŠ¶æ€</li>
<li>inode æŒ‡é’ˆ</li>
</ul>
<p>è¿™äº›æ˜¯å…¨éƒ¨</p>
<pre><code>1. å½“å‰æ–‡ä»¶åç§»é‡ï¼ˆè°ƒç”¨ read() å’Œ write() æ—¶æ›´æ–°ï¼Œæˆ–ä½¿ç”¨ lseek() ç›´æ¥ä¿®æ”¹ï¼‰
2. æ‰“å¼€æ–‡ä»¶æ—¶æ‰€ä½¿ç”¨çš„çŠ¶æ€æ ‡è¯†ï¼ˆå³ï¼Œopen() çš„ flags å‚æ•°ï¼‰
3. æ–‡ä»¶è®¿é—®æ¨¡å¼ï¼ˆå¦‚è°ƒç”¨ open() æ—¶æ‰€è®¾ç½®çš„åªè¯»æ¨¡å¼ã€åªå†™æ¨¡å¼æˆ–è¯»å†™æ¨¡å¼ï¼‰
4. ä¸ä¿¡å·é©±åŠ¨ç›¸å…³çš„è®¾ç½®
5. å¯¹è¯¥æ–‡ä»¶ i-node å¯¹è±¡çš„å¼•ç”¨
6. æ–‡ä»¶ç±»å‹ï¼ˆä¾‹å¦‚ï¼šå¸¸è§„æ–‡ä»¶ã€å¥—æ¥å­—æˆ– FIFOï¼‰å’Œè®¿é—®æƒé™
7. ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥æ–‡ä»¶æ‰€æŒæœ‰çš„é”åˆ—è¡¨
8. æ–‡ä»¶çš„å„ç§å±æ€§ï¼ŒåŒ…æ‹¬æ–‡ä»¶å¤§å°ä»¥åŠä¸ä¸åŒç±»å‹æ“ä½œç›¸å…³çš„æ—¶é—´æˆ³
</code></pre>
<p>åªè¦æœ‰è¿›ç¨‹æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå†…æ ¸å°±ä¼šäº§ç”Ÿè¿™ä¸ªå»è®°å½•æ–‡ä»¶æ‰“å¼€çŠ¶æ€ï¼Œæ¥ç€å‘è¿›ç¨‹è¿”å›è¿™ä¸ªè®°å½•çš„ç´¢å¼•ä½ç½®ï¼Œå°±æ˜¯ fd</p>
<p>è¿›ç¨‹æœ¬èº«ç»´æŠ¤ä¸€ä¸ªè¿›ç¨‹çº§çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå­˜å‚¨äº†ï¼š</p>
<ul>
<li>æ–‡ä»¶æè¿°ç¬¦</li>
<li>æ–‡ä»¶æŒ‡é’ˆ</li>
</ul>
<p>æŸ¥çœ‹è¿›ç¨‹å ç”¨çš„ fd æ•°ç›®</p>
<pre><code class="language-bash">// 226889 æ˜¯è¿›ç¨‹çš„ PIDï¼Œ å¯ä»¥é€šè¿‡ lsof -iï¼š6379 æŸ¥çœ‹
ls /proc/226889/fd | wc -w                                                      î‚² âœ”
9
</code></pre>
<h3 id="22-ä¸åŒçº§åˆ«çš„è¡¨çš„å¯¹åº”å…³ç³»"><a class="header" href="#22-ä¸åŒçº§åˆ«çš„è¡¨çš„å¯¹åº”å…³ç³»">2.2 ä¸åŒçº§åˆ«çš„è¡¨çš„å¯¹åº”å…³ç³»</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021301758.png" alt="" /></p>
<ol>
<li>åœ¨è¿›ç¨‹ A ä¸­ï¼Œæ–‡ä»¶æè¿°ç¬¦ 1 å’Œ 30 éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼ˆæ ‡å· 23ï¼‰ã€‚è¿™å¯èƒ½æ˜¯é€šè¿‡è°ƒç”¨ dup()ã€dup2()ã€fcntl() æˆ–è€…å¯¹åŒä¸€ä¸ªæ–‡ä»¶å¤šæ¬¡è°ƒç”¨äº† open() å‡½æ•°è€Œå½¢æˆçš„ã€‚</li>
<li>è¿›ç¨‹ A çš„æ–‡ä»¶æè¿°ç¬¦ 2 å’Œè¿›ç¨‹ B çš„æ–‡ä»¶æè¿°ç¬¦ 2 éƒ½æŒ‡å‘äº†åŒä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼ˆæ ‡å· 73ï¼‰ã€‚è¿™ç§æƒ…å½¢å¯èƒ½æ˜¯åœ¨è°ƒç”¨ fork() åå‡ºç°çš„ï¼ˆå³ï¼Œè¿›ç¨‹ Aã€B æ˜¯çˆ¶å­è¿›ç¨‹å…³ç³»ï¼‰ï¼Œæˆ–è€…å½“æŸè¿›ç¨‹é€šè¿‡ UNIX åŸŸå¥—æ¥å­—å°†ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¼ é€’ç»™å¦ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œä¹Ÿä¼šå‘ç”Ÿã€‚å†è€…æ˜¯ä¸åŒçš„è¿›ç¨‹ç‹¬è‡ªå»è°ƒç”¨ open å‡½æ•°æ‰“å¼€äº†åŒä¸€ä¸ªæ–‡ä»¶ï¼Œæ­¤æ—¶è¿›ç¨‹å†…éƒ¨çš„æè¿°ç¬¦æ­£å¥½åˆ†é…åˆ°ä¸å…¶ä»–è¿›ç¨‹æ‰“å¼€è¯¥æ–‡ä»¶çš„æè¿°ç¬¦ä¸€æ ·ã€‚</li>
<li>æ­¤å¤–ï¼Œè¿›ç¨‹ A çš„æè¿°ç¬¦ 0 å’Œè¿›ç¨‹ B çš„æè¿°ç¬¦ 3 åˆ†åˆ«æŒ‡å‘ä¸åŒçš„æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼Œä½†è¿™äº›å¥æŸ„å‡æŒ‡å‘ i-node è¡¨çš„ç›¸åŒæ¡ç›®ï¼ˆ1976ï¼‰ï¼Œæ¢è¨€ä¹‹ï¼ŒæŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µæ˜¯å› ä¸ºæ¯ä¸ªè¿›ç¨‹å„è‡ªå¯¹åŒä¸€ä¸ªæ–‡ä»¶å‘èµ·äº† open() è°ƒç”¨ã€‚åŒä¸€ä¸ªè¿›ç¨‹ä¸¤æ¬¡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿä¼šå‘ç”Ÿç±»ä¼¼æƒ…å†µã€‚</li>
</ol>
<p>ä¸åŒæ–‡ä»¶æè¿°ç¬¦å­˜å‚¨çš„å†…å®¹</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021301124.png" alt="" /></p>
<h3 id="23-fd-çš„é™åˆ¶"><a class="header" href="#23-fd-çš„é™åˆ¶">2.3 fd çš„é™åˆ¶</a></h3>
<ol>
<li>
<p>ç³»ç»Ÿçº§é™åˆ¶</p>
<p>æ–‡ä»¶æè¿°ç¬¦æ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªé‡è¦èµ„æºï¼Œ<strong>è™½ç„¶è¯´ç³»ç»Ÿå†…å­˜æœ‰å¤šå°‘å°±å¯ä»¥æ‰“å¼€å¤šå°‘çš„æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œä½†æ˜¯åœ¨å®é™…å®ç°è¿‡ç¨‹ä¸­å†…æ ¸æ˜¯ä¼šåšç›¸åº”çš„å¤„ç†çš„ï¼Œä¸€èˆ¬æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°ä¼šæ˜¯ç³»ç»Ÿå†…å­˜çš„ 10%ï¼ˆä»¥ KB æ¥è®¡ç®—ï¼‰</p>
<p>æŸ¥çœ‹æ–¹å¼ï¼š<code>sysctl -a | grep fs.file-max</code></p>
</li>
<li>
<p>ç”¨æˆ·çº§é™åˆ¶</p>
<p>ä¸æ­¤åŒæ—¶ï¼Œå†…æ ¸ä¸ºäº†ä¸è®©æŸä¸€ä¸ªè¿›ç¨‹æ¶ˆè€—æ‰æ‰€æœ‰çš„æ–‡ä»¶èµ„æºï¼Œå…¶ä¹Ÿä¼šå¯¹å•ä¸ªè¿›ç¨‹æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°åšé»˜è®¤å€¼å¤„ç†ï¼Œé»˜è®¤å€¼ä¸€èˆ¬æ˜¯ 1024ï¼Œä½¿ç”¨ <code>ulimit -n</code>
å‘½ä»¤å¯ä»¥æŸ¥çœ‹ã€‚</p>
</li>
</ol>
<p>ä¸€èˆ¬å¯ä»¥é€šè¿‡ä¿®æ”¹é™åˆ¶ä¼˜åŒ–ç³»ç»Ÿ</p>
<h2 id="3-ä½¿ç”¨-fd"><a class="header" href="#3-ä½¿ç”¨-fd">3. ä½¿ç”¨ fd</a></h2>
<h3 id="31-open--read"><a class="header" href="#31-open--read">3.1 open / read</a></h3>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;fcntl.h&gt;

int main (void){
    int fd;
    int numbytes;
    char path[] = &quot;file&quot;;
    char buf[256];

    /*
     * O_CREAT:å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º
     * O_RDONLY:ä»¥åªè¯»æ¨¡å¼æ‰“å¼€æ–‡ä»¶
     */
    fd = open(path, O_CREAT | O_RDONLY, 0644);
    if(fd &lt; 0){
        perror(&quot;open()&quot;);
        exit(EXIT_FAILURE);
    }

    memset(buf, 0x00, 256);
    while((numbytes = read(fd, buf, 255)) &gt; 0){
        printf(&quot;%d bytes read: %s&quot;, numbytes, buf);
        memset(buf, 0x00, 256);
    }
    close (fd);
    exit(EXIT_SUCCESS);
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¤§æ•°æ®"><a class="header" href="#å¤§æ•°æ®">å¤§æ•°æ®</a></h1>
<h2 id="ä½¿ç”¨-vm-æ­å»º-hadoop-é›†ç¾¤"><a class="header" href="#ä½¿ç”¨-vm-æ­å»º-hadoop-é›†ç¾¤">ä½¿ç”¨ VM æ­å»º hadoop é›†ç¾¤</a></h2>
<h3 id="1-å‡†å¤‡"><a class="header" href="#1-å‡†å¤‡">1. å‡†å¤‡</a></h3>
<ul>
<li>centos7.5 é•œåƒ</li>
<li>JDK8</li>
<li>Hadoop</li>
<li><a href="https://www.cnblogs.com/aeolian/p/8882790.html">å‚è€ƒé“¾æ¥</a></li>
</ul>
<h3 id="2-å®‰è£…-hadoop101-è™šæ‹Ÿæœº"><a class="header" href="#2-å®‰è£…-hadoop101-è™šæ‹Ÿæœº">2. å®‰è£… hadoop101 è™šæ‹Ÿæœº</a></h3>
<ul>
<li>è½¯ä»¶é€‰æ‹©ï¼šæœ€å°å®‰è£…æ˜¯çº¯å‘½ä»¤è¡Œ</li>
<li>å®‰è£…ä½ç½®ï¼šé€‰æ‹©æ‰‹åŠ¨å’Œä»¥è‡ªç”±é…ç½®ç›˜ç¬¦é…ç½®åŠå¤§å°ï¼Œè®¾å¤‡ç±»å‹ (LVM ç›¸æ¯”äºæ ‡å‡†åˆ†åŒºèƒ½è‡ªç”±æ‰©ç¼©å®¹)</li>
<li>KDUMP å¯ä»¥æš‚æ—¶ä¸è¦</li>
<li>è®¾ç½®ç”¨æˆ·åå¯†ç ï¼šç¤ºä¾‹ username: hadoop101 password: 000000</li>
</ul>
<h3 id="3-é…ç½®æœ¬æœºç½‘ç»œç¯å¢ƒ"><a class="header" href="#3-é…ç½®æœ¬æœºç½‘ç»œç¯å¢ƒ">3. é…ç½®æœ¬æœºç½‘ç»œç¯å¢ƒ</a></h3>
<ol>
<li>å…³é—­é˜²ç«å¢™</li>
<li>VM é…ç½® VMnet8 ç¼–è¾‘ -&gt; è™šæ‹Ÿç½‘ç»œç¼–è¾‘å™¨</li>
<li>Windows é…ç½® VMnet8</li>
</ol>
<h3 id="4-é…ç½®è™šæ‹Ÿæœºç½‘ç»œç¯å¢ƒ"><a class="header" href="#4-é…ç½®è™šæ‹Ÿæœºç½‘ç»œç¯å¢ƒ">4. é…ç½®è™šæ‹Ÿæœºç½‘ç»œç¯å¢ƒ</a></h3>
<ol>
<li>å…³é—­è™šæ‹Ÿæœºé˜²ç«å¢™ï¼š<code>systemctl disable firewalld.service</code></li>
<li>å…³é—­ NetworkManage:</li>
</ol>
<ul>
<li><code>systemctl stop NetworkManager</code></li>
<li><code>systemctl disable NetworkManager</code></li>
</ul>
<ol start="3">
<li>!!! ä¿®æ”¹ç½‘å¡é…ç½®ï¼š</li>
</ol>
<ul>
<li><code>vim /etc/sysconfig/network-scripts/ifcfg-ens33</code></li>
</ul>
<pre><code>BOOTPROTO=static  #å¯ç”¨é™æ€ IP åœ°å€ ,é»˜è®¤ä¸º dhcp
IPADDR=192.168.182.3  #è®¾ç½® IP åœ°å€ (è¿™å°è™šæ‹Ÿæœºæƒ³è¦çš„ ip)
NETMASK=255.255.225.0  #è®¾ç½®å­ç½‘æ©ç 
GATEWAY=192.168.182.2  #è®¾ç½®ç½‘å…³ (å’Œå¤–éƒ¨çš„ç½‘å…³ç›¸åŒ)
</code></pre>
<ol start="4">
<li>é‡å¯ç½‘å¡ï¼š<code>service  network restart</code> å¯ä»¥é€šè¿‡ <code>ping 8.8.8.8</code>æ£€æµ‹æ˜¯å¦é€š</li>
</ol>
<h3 id="5-å…‹éš†å‰"><a class="header" href="#5-å…‹éš†å‰">5. å…‹éš†å‰</a></h3>
<ol>
<li>å®‰è£…è¾…åŠ©åŒ…ç®¡ç†å™¨ï¼š<code>yum install -y epel-release</code></li>
<li>æœªçŸ¥ï¼š<code>kill -9 3030</code></li>
<li>å¸è½½ç³»ç»Ÿè‡ªå¸¦ JDK:</li>
</ol>
<ul>
<li>æŸ¥çœ‹ï¼š<code>rpm -qa | grep java</code></li>
<li>å¸è½½ï¼š<code>sudo yum remove packagename</code></li>
</ul>
<ol start="4">
<li>ä¿®æ”¹è™šæ‹Ÿæœº host</li>
</ol>
<ul>
<li>ä¿®æ”¹ hostname å¦‚ä¸‹ï¼š<code>nano /etc/hostname</code></li>
</ul>
<pre><code>hadoop101
</code></pre>
<ul>
<li>ä¿®æ”¹ hosts å¦‚ä¸‹ï¼š<code>nano /etc/hosts</code></li>
</ul>
<pre><code>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

192.168.93.21 hadoop101
192.168.93.22 hadoop102
192.168.93.23 hadoop103
</code></pre>
<h3 id="6-å…‹éš†-å®Œæ•´å…‹éš†-å"><a class="header" href="#6-å…‹éš†-å®Œæ•´å…‹éš†-å">6. å…‹éš† (å®Œæ•´å…‹éš†) å</a></h3>
<ol>
<li>é€šè¿‡ vmware è¿›è¡Œ clone å‡º n å°ç›¸åŒçš„è™šæ‹Ÿæœº</li>
</ol>
<ul>
<li>ä¿®æ”¹æ¯å°å…‹éš†å‡ºçš„ç½‘å¡ IPADDR: <code>vim /etc/sysconfig/network-scripts/ifcfg-ens33</code></li>
<li>ä¿®æ”¹ hostname: <code>nano /etc/hostname</code></li>
</ul>
<h3 id="7-å®‰è£…åŠé…ç½®ç¯å¢ƒå˜é‡"><a class="header" href="#7-å®‰è£…åŠé…ç½®ç¯å¢ƒå˜é‡">7. å®‰è£…åŠé…ç½®ç¯å¢ƒå˜é‡</a></h3>
<ol>
<li>å®‰è£…è½¯ä»¶ ä¸ºäº†æ–¹ä¾¿ç»Ÿä¸€ç®¡ç†</li>
</ol>
<ul>
<li>å‹ç¼©åŒ…ç›®å½•ï¼š<code>/opt/software</code></li>
<li>è§£å‹ç›®å½•ï¼š<code>/opt/module</code> è§£å‹ï¼š</li>
<li>ç»™æƒé™ï¼š<code>chmod 777 /opt/software</code></li>
<li>è§£å‹ (-C æŒ‡å®šè§£å‹ç›®å½•): <code>tar -zxvf jdk-8u212-linux-x64.tar.gz -C /opt/module/</code></li>
</ul>
<ol start="2">
<li>ä¿®æ”¹ç¯å¢ƒå˜é‡ ä¸ºäº†æ°¸ä¹…ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼šä¿®æ”¹æ–‡ä»¶ <code>sudo nano /etc/profile.d/users.sh</code>å¦‚ä¸‹</li>
</ol>
<pre><code class="language-shell">#JAVA
export JAVA_HOME=/opt/module/jdk1.8.0_212
export PATH=$PATH:$JAVA_HOME/bin
#HADOOP
export HADOOP_HOME=/opt/module/hadoop-3.1.3
export PATH=$PATH:$HADOOP_HOME/bin
export PATH=$PATH:$HADOOP_HOME/sbin
</code></pre>
<ol start="3">
<li>é‡ç½® <code>source /etc/profile</code> ::: warning ä½¿ç”¨ <code>export PATH=$PATH:xxxxx</code>ä¼šåœ¨ç»ˆç«¯å…³é—­åå¤±æ•ˆ
:::</li>
</ol>
<h3 id="8-é…ç½®é›†ç¾¤åˆ†å‘è„šæœ¬å’Œå…å¯†ç™»å½•"><a class="header" href="#8-é…ç½®é›†ç¾¤åˆ†å‘è„šæœ¬å’Œå…å¯†ç™»å½•">8. é…ç½®é›†ç¾¤åˆ†å‘è„šæœ¬å’Œå…å¯†ç™»å½•</a></h3>
<ol>
<li>scp æœåŠ¡å™¨é—´æ‹·è´</li>
</ol>
<pre><code class="language-shell"># å°†å½“å‰æœåŠ¡å™¨çš„/opt/module/jdk1.8.0_212 ç›®å½•æ‹·è´åˆ° hadoop102 æœåŠ¡å™¨çš„/opt/module ç›®å½•ä¸‹
# å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œhadoop102 æœåŠ¡å™¨ä¸‹çš„/opt/module ç›®å½•å¿…é¡»å­˜åœ¨
# -r æŒ‡é€’å½’å¤åˆ¶æ•´ä¸ªç›®å½•
# root æ˜¯æŒ‡ hadoop102 çš„ç”¨æˆ·
scp -r /opt/module/jdk1.8.0_212 root@hadoop102:/opt/module
</code></pre>
<ol start="2">
<li>rsync è¿œç¨‹åŒæ­¥å·¥å…·</li>
</ol>
<pre><code class="language-shell"># å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½éœ€è¦å®‰è£…
yum -y install rsync

# -a è¡¨ç¤ºå½’æ¡£æ‹·è´
# -v è¡¨ç¤ºæ˜¾ç¤ºæ‹·è´è¿‡ç¨‹
rsync -av /opt/module/hadoop-3.1.3/ root@hadoop102:/opt/module/hadoop-3.1.3/
# è®©ä¸¤ä¸ªæ–‡ä»¶å¤¹åŒæ­¥
</code></pre>
<ol start="3">
<li>åˆ†å‘è„šæœ¬ (èµ·å:xsync)</li>
</ol>
<pre><code class="language-shell">#!/bin/bash
#1. åˆ¤æ–­å‚æ•°ä¸ªæ•°
if [ $# -lt 1 ]
then
 echo Not Enough Arguement!
 exit;
fi
#2. éå†é›†ç¾¤æ‰€æœ‰æœºå™¨
for host in hadoop101 hadoop102 hadoop103
    do
    echo ==================== $host ====================
    #3. éå†æ‰€æœ‰ç›®å½•ï¼ŒæŒ¨ä¸ªå‘é€

    for file in $@
    do
        #4. åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -e $file ]
        then
            #5. è·å–çˆ¶ç›®å½•
            pdir=$(cd -P $(dirname $file); pwd)
            #6. è·å–å½“å‰æ–‡ä»¶çš„åç§°
            fname=$(basename $file)
            ssh $host &quot;mkdir -p $pdir&quot;
            rsync -av $pdir/$fname $host:$pdir
        else
            echo $file does not exists!
        fi
    done
done
</code></pre>
<p>::: danger</p>
<blockquote>
<p>ç©ºæ ¼å¿…é¡»åŠ ï¼š<code>if [ -e $file ]</code> ç­‰å·ä¸¤è¾¹çš„ç©ºæ ¼å¿…ä¸èƒ½åŠ ï¼š<code>pdir=$(cd -P $(dirname $file); pwd)</code>
$@è¿”å›æ‰€æœ‰å‘½ä»¤è¡Œå‚æ•°ï¼Œæ‰€ä»¥å¯ä»¥ä¸€æ¬¡åŒæ­¥å¤šä¸ªæ–‡ä»¶ (å¤¹)</p>
</blockquote>
<p>:::</p>
<ol start="4">
<li>åç»­å¤„ç† æ–‡ä»¶åˆ›å»ºåœ¨/bin/ä¸‹ï¼š<code>/bin/xsync</code>æ–¹ä¾¿ç›´æ¥è°ƒç”¨</li>
</ol>
<pre><code class="language-shell"># ç»™è¿è¡Œæƒé™
chmod +x xsync
# æµ‹è¯•åŒæ­¥ç¯å¢ƒå˜é‡
xsync /etc/profile.d/
</code></pre>
<ol start="5">
<li>å…å¯†ç™»å½•</li>
</ol>
<pre><code class="language-shell">cd /root/.ssh
# ç”Ÿæˆç§é’¥å…¬é’¥
ssh-keygen -t rsa
# åˆ†å‘å¯†é’¥
ssh-copy-id hadoop101
ssh-copy-id hadoop102
ssh-copy-id hadoop103
</code></pre>
<h3 id="9"><a class="header" href="#9">9</a></h3>
<h2 id="hdfs"><a class="header" href="#hdfs">HDFS</a></h2>
<p>æ—¥å¿—å‹ï¼Œåªå…è®¸è¿½åŠ </p>
<h2 id="hbase"><a class="header" href="#hbase">HBase</a></h2>
<p>åŸºäº HDFSï¼Œä¸ä¼šå°†æ—§æ•°æ®åˆ é™¤</p>
<h3 id="æ•°æ®æ¨¡å‹"><a class="header" href="#æ•°æ®æ¨¡å‹">æ•°æ®æ¨¡å‹</a></h3>
<p>HBase æ˜¯ä¸€ä¸ªç¨€ç–çš„ (ä¸åŒæ—¶é—´æ²¡æœ‰æ•°æ®)ï¼Œå¤šç»´åº¦ (4 ä¸ªç»´åº¦åœ¨èƒ½é™å®šåˆ°ä¸€ä¸ªå•å…ƒæ ¼) çš„ï¼Œæ’åºçš„æ˜ å°„è¡¨
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241641728.png" alt="" /></p>
<h4 id="æ¦‚å¿µè§†å›¾"><a class="header" href="#æ¦‚å¿µè§†å›¾">æ¦‚å¿µè§†å›¾</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241634039.png" alt="" />
ä¸åŒæ—¶é—´å¯èƒ½æ²¡æœ‰æ•°æ®ï¼Œä½“ç°äº† HBase æ˜¯ç¨€ç–è¡¨</p>
<h4 id="ç‰©ç†è§†å›¾"><a class="header" href="#ç‰©ç†è§†å›¾">ç‰©ç†è§†å›¾</a></h4>
<p>åˆ—æ ‡è¯†å¹¶æ²¡æœ‰åŒºåˆ†
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241635344.png" alt="" /></p>
<h4 id="æŒ‰è¡ŒæŒ‰åˆ—çš„åŒºåˆ†"><a class="header" href="#æŒ‰è¡ŒæŒ‰åˆ—çš„åŒºåˆ†">æŒ‰è¡ŒæŒ‰åˆ—çš„åŒºåˆ†</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241637049.png" alt="" /></p>
<p>æŒ‰è¡Œï¼š</p>
<ul>
<li>ä¸ä¾¿äºè¯»å–æŸä¸€åˆ—æ•°æ®ï¼Œå¿…é¡»æ‰«ææ‰€æœ‰è¡Œï¼Œå¹¶æŠŠæ¯è¡Œçš„æŸä¸ªå­—æ®µå–å‡ºæ¥</li>
</ul>
<p>æŒ‰åˆ—ï¼š</p>
<ul>
<li>å‹ç¼©æ€§èƒ½å¥½ï¼ŒæŒ‰åˆ—å­˜ï¼Œæ•°æ®ç±»å‹ç›¸åŒï¼Œèƒ½å¤Ÿæ›´å¥½çš„å‹ç¼©</li>
</ul>
<h3 id="å®ç°åŸç†"><a class="header" href="#å®ç°åŸç†">å®ç°åŸç†</a></h3>
<h4 id="æœåŠ¡å™¨åˆ’åˆ†"><a class="header" href="#æœåŠ¡å™¨åˆ’åˆ†">æœåŠ¡å™¨åˆ’åˆ†</a></h4>
<ul>
<li>master æœåŠ¡å™¨è´Ÿè´£ç®¡ç†å†™è¯·æ±‚ï¼Œè´Ÿè½½å‡è¡¡ç­‰</li>
<li>å®¢æˆ·ç«¯å¹¶ä¸ä¾èµ– master æœåŠ¡å»æ‰¾åˆ°æ•°æ®ä½ç½®</li>
<li>ç”¨æˆ·ç›´æ¥è®¿é—®çš„æ˜¯ region æœåŠ¡å™¨
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241654144.png" alt="" /></li>
</ul>
<h4 id="ç‰©ç†å­˜å‚¨"><a class="header" href="#ç‰©ç†å­˜å‚¨">ç‰©ç†å­˜å‚¨</a></h4>
<ul>
<li>ä¸åŒçš„ region ä¸è®¸å­˜å‚¨åœ¨åŒä¸€ä¸ªæœåŠ¡å™¨ä¸Šï¼Œä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥å­˜å‚¨å¤šä¸ª region(1-2G, 10-1000 ä¸ª)</li>
<li>region å¤ªå¤§äº†å°±ä¼šå‚ç›´åˆ†è£‚ (æ“ä½œæŒ‡é’ˆï¼Œé€Ÿåº¦è¾ƒå¿«)ï¼Œåˆ†è£‚æ—¶ç”¨æˆ·è¯»å–çš„ä¾ç„¶æ˜¯ä¹‹å‰çš„
regionï¼Œå½“æœåŠ¡å™¨ç»è¿‡åˆå¹¶ï¼Œå†™å…¥æ–°çš„æ–‡ä»¶ä¹‹åï¼Œæ–°æ¥çš„ç”¨æˆ·å½©ç»˜è®¿é—®æ–°çš„ region
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241657033.png" alt="" /></li>
</ul>
<h4 id="ç´¢å¼•ç»“æ„"><a class="header" href="#ç´¢å¼•ç»“æ„">ç´¢å¼•ç»“æ„</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241701862.png" alt="" />
å„ä¸ªå±‚æ¬¡çš„ä½œç”¨
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241702112.png" alt="" />
3 å±‚ç»“æ„å®Œå…¨è¶³å¤Ÿä½¿ç”¨ï¼Œå¯¹äºç»å¸¸è®¿é—®çš„å¯ä»¥å¢åŠ ç¼“å­˜</p>
<ul>
<li>å¦‚ä½•è§£å†³ç¼“å­˜å¤±æ•ˆï¼Œç¼“å­˜å¤±æ•ˆçš„è¯æ•°æ®å°±æ‰¾ä¸åˆ°äº†</li>
</ul>
<h3 id="è¿è¡Œæ¶æ„"><a class="header" href="#è¿è¡Œæ¶æ„">è¿è¡Œæ¶æ„</a></h3>
<h4 id="æ¶æ„å›¾"><a class="header" href="#æ¶æ„å›¾">æ¶æ„å›¾</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241709216.png" alt="" />
master:</p>
<ul>
<li>å¯¹æ•°æ®è¡¨è¿›è¡Œå¢åˆ æ”¹æŸ¥</li>
<li>è´Ÿè½½å‡è¡¡ï¼ŒæŠŠè´Ÿè½½å¤§çš„æœåŠ¡å™¨ä¸Šçš„ region è¡¨æ‹¿åˆ°å…¶ä»–è´Ÿè½½å°çš„æœåŠ¡å™¨ä¸Š</li>
<li>ç®¡ç† region çš„åˆ†è£‚åˆå¹¶æ“ä½œä¹‹åçš„å‘å¸ƒ</li>
<li>é‡æ–°åˆ†é…æ•…éšœæœåŠ¡å™¨ä¸Šçš„ region</li>
</ul>
<h4 id="region-å†™å…¥-hdfs"><a class="header" href="#region-å†™å…¥-hdfs">region å†™å…¥ HDFS</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241715580.png" alt="" />
å¯¹äºå•ä¸ª region æœåŠ¡å™¨ï¼Œä¸Šé¢å­˜å‚¨äº†å¤šä¸ª region å—ï¼Œæ¯ä¸ªåˆ—æ—è¢«åˆ’åˆ†ä¸ºä¸€ä¸ª store</p>
<p>é”ä¸ resion å—å…±ç”¨ä¸€ä¸ª Hlog æ–‡ä»¶</p>
<p>region å°†æ•°æ®å†™å…¥ HDFS ä¼šçº¿å†™å…¥ memStore ä¸­ (ç¼“å­˜)ï¼Œç¼“å­˜æ»¡äº†ä¹‹åï¼Œåˆ·å…¥ StoreFile ä¸­ï¼ŒStoreFile å°±æ˜¯ HFile,
HDFS ä¸­çš„æ•°æ®æ ¼å¼</p>
<h4 id="ç”¨æˆ·å†™å…¥-region"><a class="header" href="#ç”¨æˆ·å†™å…¥-region">ç”¨æˆ·å†™å…¥ Region</a></h4>
<p>ç”¨æˆ·å†™å…¥è¯·æ±‚è¢«åˆ†é…ç»™ region</p>
<ul>
<li>å†™å…¥ç¼“å­˜</li>
<li>å†™å…¥æ—¥å¿— (Hlog), å¿…é¡»å†™å…¥ç£ç›˜æ‰ç®—æˆåŠŸ</li>
<li>ç³»ç»Ÿå°†ç¼“å­˜å‘¨æœŸæ€§åˆ·å…¥ç£ç›˜ï¼Œå¹¶åœ¨ Hlog å†™å…¥æ ‡è®°</li>
<li>æ¯æ¬¡åˆ·å†™éƒ½ä¼šç”Ÿæˆä¸€ä¸ª StoreFile</li>
<li>å¤šä¸ª StoreFile ä¼šåˆå¹¶ä¸ºå¤§æ–‡ä»¶ï¼Œå¤ªå¤§å°±ä¼šå¼•å‘ StoreFile çš„åˆ†è£‚ï¼Œregion å°±åˆ†è£‚äº†</li>
</ul>
<p>zookeeper ç›‘å¬ Region æœåŠ¡å™¨ï¼Œå¦‚æœ Region æœåŠ¡å™¨å‘ç”Ÿæ•…éšœï¼Œå°±ä¼šé€šçŸ¥ Master æœåŠ¡æ­¦å™¨ï¼ŒMaster æœåŠ¡å™¨å°† Region
æœåŠ¡å™¨ä¸Šçš„ Hlog æ–‡ä»¶æ‹‰å–è¿‡æ¥ï¼Œå¹¶æ ¹æ®æ—¥å¿—æ–‡ä»¶å°†æ‰€æœ‰ Region åˆ†é…åˆ°å…¶ä»–å¯ç”¨çš„ Region æœåŠ¡å™¨</p>
<h3 id="ä¼˜åŒ–å­˜å‚¨"><a class="header" href="#ä¼˜åŒ–å­˜å‚¨">ä¼˜åŒ–å­˜å‚¨</a></h3>
<ul>
<li>
<p>æ—¶é—´é è¿‘çš„æ•°æ®å­˜åœ¨ä¸€èµ·ï¼š</p>
<p>ç”¨<code>Long.Max_VALUE - timestamp</code>ä½œä¸ºè¡Œé”®ï¼Œæœ€æ–°çš„æ•°æ®èƒ½å¤Ÿå¿«é€Ÿå‘½ä¸­</p>
</li>
<li>
<p>æå‡è¯»å†™æ€§èƒ½</p>
<p>è®¾ç½®<code>HColumnDescriptor.setlnMemory = true</code>, å°† Region æœåŠ¡å™¨çš„ Region æ”¾å…¥ç¼“å­˜ä¸­</p>
</li>
<li>
<p>åˆ é™¤æ—§ç‰ˆæœ¬æ•°æ® è®¾ç½®<code>HColumnDescriptr.setMaxVersionsMaxVersions = true</code>ï¼Œåªä¼šä¿ç•™æœ€æ–°ç‰ˆæœ¬</p>
</li>
<li>
<p>è¿‡æœŸè‡ªåŠ¨æ¸…é™¤ è®¾ç½®<code>setTimeToLive(2 * 24 * 60 * 60)</code>è¶…è¿‡ä¸¤å¤©å°±è‡ªåŠ¨æ¸…é™¤</p>
</li>
</ul>
<h3 id="äºŒçº§ç´¢å¼•"><a class="header" href="#äºŒçº§ç´¢å¼•">äºŒçº§ç´¢å¼•</a></h3>
<p>Hindex: ä¾èµ–è§¦å‘å™¨åœ¨æ’å…¥æ•°æ®ååŒæ—¶æ’å…¥ç´¢å¼•è¡¨ HBase + Redis: å°†ç´¢å¼•æš‚æ—¶å­˜å…¥ redisï¼Œä¹‹ååœ¨åˆ·å…¥ HBase Solr +
HBase: é«˜æ€§èƒ½å…¨æ–‡ç´¢å¼•ï¼Œç”± Solr æ„å»ºç´¢å¼•å¾—åˆ°æ•°æ®çš„ RowKey</p>
<h2 id="nosql"><a class="header" href="#nosql">NoSQL</a></h2>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203311248917.png" alt="" /></p>
<h3 id="é”®å€¼æ•°æ®åº“"><a class="header" href="#é”®å€¼æ•°æ®åº“">é”®å€¼æ•°æ®åº“</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203311253870.png" alt="" /></p>
<h3 id="åˆ—æ—æ•°æ®åº“"><a class="header" href="#åˆ—æ—æ•°æ®åº“">åˆ—æ—æ•°æ®åº“</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203311257861.png" alt="" /></p>
<h3 id="æ–‡æ¡£æ•°æ®åº“"><a class="header" href="#æ–‡æ¡£æ•°æ®åº“">æ–‡æ¡£æ•°æ®åº“</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203311302289.png" alt="" /></p>
<h2 id="mapreduce"><a class="header" href="#mapreduce">MapReduce</a></h2>
<p>åˆ†å¸ƒå¼å¹¶è¡Œç¼–ç¨‹æ¨¡å‹ï¼Œç›¸æ¯”ä¸ä¼ ç»Ÿçš„å¹¶è¡Œç¼–ç¨‹æ¡†æ¶çš„åŒºåˆ«</p>
<h3 id="æ¨¡å‹ç®€ä»‹"><a class="header" href="#æ¨¡å‹ç®€ä»‹">æ¨¡å‹ç®€ä»‹</a></h3>
<table>
  <tr>
    <td>
      ä¼ ç»Ÿçš„è®¡ç®—æ–¹æ³•æ˜¯æ•°æ®å‘è®¡ç®—é æ‹¢
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204070954311.png" alt="" /></p>
</td>
<td> MapReduce è®¡ç®—é¡¹æ•°æ®é æ‹¢
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204070954635.png" alt="" /></p>
</td>
</tr>
</table>
<h3 id="ä½“ç³»ç»“æ„"><a class="header" href="#ä½“ç³»ç»“æ„">ä½“ç³»ç»“æ„</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204071239586.png" alt="" /></p>
<h4 id="client"><a class="header" href="#client">Client</a></h4>
<ul>
<li>ç”¨æˆ·å°†ç¼–å†™çš„ç¨‹åºæäº¤åˆ° Client</li>
<li>é€šè¿‡ Client æä¾›çš„å€Ÿå£æŸ¥çœ‹ä½œä¸šçš„è¿è¡ŒçŠ¶æ€</li>
</ul>
<h4 id="jobtracker"><a class="header" href="#jobtracker">JobTracker</a></h4>
<ul>
<li>è´Ÿè´£èµ„æºç›‘æ§</li>
<li>è´Ÿè´£ä½œä¸šè°ƒåº¦ (ä¾é  TaskSchedular å†³å®šä»»åŠ¡åº”è¯¥åˆ†å‘ç»™é‚£ä¸ª Taskracker)</li>
<li>ç›‘æµ‹åº•å±‚å…¶ä»– Taskracker ä»¥åŠå½“å‰è¿è¡Œçš„ Job çš„çŠ¶å†µ</li>
<li>å¦‚æœæ£€æµ‹åˆ°å¤±è´¥ï¼Œéœ€è¦æŠŠ Job è½¬ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œå¹¶ç»§ç»­è¿½è¸ª</li>
</ul>
<h4 id="tasktracker"><a class="header" href="#tasktracker">TaskTracker</a></h4>
<ul>
<li>æ‰§è¡Œå…·ä½“çš„ç›¸å…³ä»»åŠ¡ï¼Œä¸€èˆ¬æ˜¯ JobTracker å‘æ¥çš„å‘½ä»¤</li>
<li>æŠŠè‡ªå·±çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œä»»åŠ¡è¿è¡Œè¿›åº¦é€šè¿‡å¿ƒè·³çš„æ–¹å¼å‘é€ç»™ JobTracker</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="go-è¯­è¨€"><a class="header" href="#go-è¯­è¨€">Go è¯­è¨€</a></h1>
<p>###./ åŸºç¡€</p>
<h4 id="æ ¼å¼åŒ–"><a class="header" href="#æ ¼å¼åŒ–">æ ¼å¼åŒ–</a></h4>
<pre><code class="language-go">fmt.Printf(&quot;type %T value %v \n&quot;, a, a)
</code></pre>
<h4 id="å¾ªç¯"><a class="header" href="#å¾ªç¯">å¾ªç¯</a></h4>
<pre><code class="language-go">if num := 10; num &gt; 0 {
    fmt.Println(num)
}

for i := 1; i &lt; 10; i++ {
    fmt.Println(i)
    if i == 3 {
        break
    }
}

finger := 2
switch finger {
case 1:
    fmt.Println(1)
case 2:
    fmt.Println(2)
    fallthrough
default:
    println(&quot;sss&quot;)
}

dd := 1
switch {
case dd &gt; 0:
    println(0)
case dd &gt; -1:
    println(-1)
}
</code></pre>
<h4 id="æ•°ç»„-2"><a class="header" href="#æ•°ç»„-2">æ•°ç»„</a></h4>
<p>æ•°ç»„æœ‰å›ºå®šå¤§å°ï¼Œæ•°ç»„çš„å¤§å°æ˜¯ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤ [5]int å’Œ [25]int æ˜¯ä¸åŒç±»å‹</p>
<pre><code class="language-go">a := []int{2}
a[0] = 1
fmt.Println(a)

var b [3][2]int
b = [3][2]int{
    {1, 2},
    {1, 2},
    {1, 2},
}
fmt.Println(b)

veggies := []string{&quot;potatoes&quot;, &quot;tomatoes&quot;, &quot;brinjal&quot;}
fruits := []string{&quot;oranges&quot;, &quot;apples&quot;}
food := append(veggies, fruits...)
fmt.Println(&quot;food:&quot;, veggies, fruits, food)
fmt.Println(&quot;food:&quot;, cap(veggies), cap(fruits), cap(food))
fmt.Println(&quot;food:&quot;, len(veggies), len(fruits), len(food))
nums := []int{1, 2}
change(nums...)
pln(nums...)
</code></pre>
<h4 id="map-2"><a class="header" href="#map-2">map</a></h4>
<pre><code class="language-go">// map çš„é›¶å€¼ä¸º nilï¼Œå¿…é¡»ä½¿ç”¨ make åˆå§‹åŒ–
// map æ˜¯ å¼•ç”¨ç±»å‹ï¼Œå½“ map è¢«èµ‹å€¼ç»™å¦ä¸€ä¸ªå˜é‡æ˜¯åï¼Œä»–ä»¬å…±äº«ä¸€ä¸ª
// map ä¸èƒ½ä½¿ç”¨==åˆ¤æ–­ï¼Œ==åªèƒ½ç”¨æ¥åˆ¤æ–­ map æ˜¯å¦ä¸º nilï¼Œåº”è¯¥éå†å­—å…¸å…ƒç´ å»æ¯”è¾ƒä¸¤ä¸ªå­—å…¸
var mm map[string]int
// mm[&quot;s&quot;] = 1                    // å›æŠ¥é”™ï¼Œmap is nil
// fmt.Printf(&quot;%T %v \n&quot;, mm, mm) // è¿™é‡Œè™½ç„¶èƒ½æ‰“å°å‡º map[]ï¼Œä½†æ˜¯æ— æµäºäº‹
if mm == nil {
    mm = make(map[string]int)
    mm[&quot;s&quot;] = 1
    fmt.Printf(&quot;%T %v \n&quot;, mm, mm)
}
mmm := map[string]int{
    &quot;aaa&quot;: 1,
}
if v, ok := mmm[&quot;aa&quot;]; ok == true {
    fmt.Println(v)
    delete(mmm, &quot;aa&quot;)
} else {
    fmt.Println(&quot;no such key&quot;)
    fmt.Println(len(mmm))
    for k, v := range mmm {
        fmt.Println(k, v)
    }
}
</code></pre>
<h4 id="å­—ç¬¦ä¸²-ä¸-åˆ‡ç‰‡"><a class="header" href="#å­—ç¬¦ä¸²-ä¸-åˆ‡ç‰‡">å­—ç¬¦ä¸² ä¸ åˆ‡ç‰‡</a></h4>
<pre><code class="language-go">// å­—ç¬¦ä¸²
name := &quot;SeÃ±or&quot;
for i := 0; i &lt; len(name); i++ {
    fmt.Printf(&quot;%c&quot;, name[i])
}
fmt.Printf(&quot;\n&quot;)
for _, v := range name {
    fmt.Printf(&quot;%c&quot;, v)
}
fmt.Printf(&quot;\n&quot;)
name_ := []rune(name)
for i := 0; i &lt; len(name_); i++ {
    fmt.Printf(&quot;%c&quot;, name_[i])
}
</code></pre>
<p>å½“å¯¹åˆ‡ç‰‡è°ƒç”¨<code>append(slice, ...elems)</code>æ˜¯ï¼Œå¦‚æœè¶…å‡ºåˆ‡ç‰‡çš„ capï¼Œå°±ä¼šé‡æ–°åˆ†é…å†…å­˜ç©ºé—´ï¼Œå› æ­¤å¿…é¡»éœ€è¦ç”¨å˜é‡æ¥å—è¿”å›å€¼</p>
<pre><code class="language-go">//å…³äºåˆ‡ç‰‡
// a[x] æ˜¯ (*a)[x] çš„ç®€å†™å½¢å¼
// arr := [3]int{1, 2, 3}
// modify(&amp;arr)
// modify(arr[:]) è¿™ç§æ›´å¸¸ç”¨
// arr++ è¿™ç§ç›´æ¥è¿›è¡ŒæŒ‡é’ˆæ“ä½œä¸è¢«å…è®¸
func modify1(arr *[3]int) {
	(*arr)[0] = 90
}
func modify2(arr *[3]int) {
	arr[0] = 90
}

func change(elems ...int) {
	for i, v := range elems {
		v += 1        // æ— æ•ˆ
		elems[i] += 1 // æœ‰æ•ˆ
	}
}

func pln(elems ...int) {
	for i, v := range elems {
		fmt.Printf(&quot;index: %v value %v\n&quot;, i, v)
	}
}
</code></pre>
<h3 id="ç»“æ„ä½“-1"><a class="header" href="#ç»“æ„ä½“-1">ç»“æ„ä½“</a></h3>
<ul>
<li>ç»“æ„ä½“æ˜¯å€¼ç±»å‹ã€‚å¦‚æœå®ƒçš„æ¯ä¸€ä¸ªå­—æ®µéƒ½æ˜¯å¯æ¯”è¾ƒçš„ï¼Œåˆ™è¯¥ç»“æ„ä½“ä¹Ÿæ˜¯å¯æ¯”è¾ƒçš„ã€‚å¦‚æœä¸¤ä¸ªç»“æ„ä½“å˜é‡çš„å¯¹åº”å­—æ®µç›¸ç­‰ï¼Œåˆ™è¿™ä¸¤ä¸ªå˜é‡ä¹Ÿæ˜¯ç›¸ç­‰çš„ã€‚</li>
<li>å¦‚æœç»“æ„ä½“åŒ…å«ä¸å¯æ¯”è¾ƒçš„å­—æ®µï¼Œåˆ™ç»“æ„ä½“å˜é‡ä¹Ÿä¸å¯æ¯”è¾ƒã€‚</li>
</ul>
<h4 id="ä¹¦å†™"><a class="header" href="#ä¹¦å†™">ä¹¦å†™</a></h4>
<ul>
<li>
<p>åŒ¿åç»“æ„ä½“ï¼šstring,int å°±æ˜¯å­—æ®µåï¼Œå­—æ®µä¸èƒ½é‡å¤</p>
<pre><code class="language-go">type Person struct {
    string
    int
}
person := Person{&quot;aa&quot;, 1}
fmt.Println(person.int, person.string)
</code></pre>
</li>
<li>
<p>æå‡å­—æ®µï¼šåµŒå…¥çš„ç»“æ„ä½“ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨é‡Œé¢çš„å­—æ®µ</p>
<pre><code class="language-go">type Group struct {
    string
    int
    Person
}
</code></pre>
</li>
<li>
<p>åŒ¿å + æå‡ï¼Œå‘ä¸Šé¢çš„æƒ…å†µ</p>
<p>åŒ¿åçš„ç±»å‹å¯ä»¥é‡å¤ï¼Œä½†æ˜¯ä¼šä»¥è‡ªèº«çš„ä¸ºå‡†</p>
<pre><code class="language-go">group := Group{&quot;bb&quot;, 1, person}
fmt.Print(group.string, group.string)
</code></pre>
</li>
</ul>
<h4 id="ç»“æ„ä½“-tag"><a class="header" href="#ç»“æ„ä½“-tag">ç»“æ„ä½“ Tag</a></h4>
<p><strong>æ ¼å¼</strong> ç©ºæ ¼åˆ†å‰²çš„é”®å€¼å¯¹</p>
<p><strong>ä½¿ç”¨</strong> ç¤ºä¾‹ï¼šjson åº“èƒ½å¤Ÿååºåˆ—åŒ–ç»“æ„ä½“</p>
<ul>
<li>å¦‚æœåŠ ä¸Š omiteptyï¼Œå½“ç»“æ„ä½“ä¸ºç©ºæ˜¯å°±ä¼šè¢«å¿½ç•¥</li>
<li>å¦‚æœä¸åŠ ï¼Œä¸ºç©ºçš„å­—æ®µä¼šè¢«è§£æä¸ºç©ºå­—ç¬¦ä¸²&quot;&quot;</li>
</ul>
<pre><code class="language-go">type Person struct {
    Name string `json:&quot;name&quot;`
	Age  int    `json:&quot;age&quot;`
	Addr string `json:&quot;addr&quot;` // ,omitempty
}

func main() {
    p1 := Person{
		Name: &quot;Jack&quot;,
		Age:  22,
	}
	data1, _ := json.Marshal(p1)
	fmt.Printf(&quot;%s\n&quot;, data1)
}
</code></pre>
<p><strong>å¯ä»¥é€šè¿‡åå°„è¯»å– tag</strong></p>
<pre><code class="language-go">// ä¸‰ç§è·å– field
field := reflect.TypeOf(obj).FieldByName(&quot;Name&quot;)
field := reflect.ValueOf(obj).Type().Field(i)  // i è¡¨ç¤ºç¬¬å‡ ä¸ªå­—æ®µ
field := reflect.ValueOf(&amp;obj).Elem().Type().Field(i)  // i è¡¨ç¤ºç¬¬å‡ ä¸ªå­—æ®µ

// è·å– Tag
tag := field.Tag

// è·å–é”®å€¼å¯¹
labelValue := tag.Get(&quot;label&quot;)  // è·å–ä¸åˆ°å°±ä¼šè¿”å› &quot;&quot;
labelValue,ok := tag.Lookup(&quot;label&quot;)
</code></pre>
<ul>
<li>è·å–é”®å€¼å¯¹ï¼Œæœ‰ Get å’Œ Lookup ä¸¤ç§æ–¹æ³•ï¼Œä½†å…¶å® Get åªæ˜¯å¯¹ Lookup å‡½æ•°çš„ç®€å•å°è£…è€Œå·²ï¼Œå½“æ²¡æœ‰è·å–åˆ°å¯¹åº” tag
çš„å†…å®¹ï¼Œä¼šè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚
<pre><code class="language-go">func (tag StructTag) Get(key string) string {
    v, _ := tag.Lookup(key)
    return v
}
</code></pre>
</li>
<li>ç©º Tag å’Œä¸è®¾ç½® Tag æ•ˆæœæ˜¯ä¸€æ ·çš„</li>
</ul>
<h3 id="æ–¹æ³•--å‡½æ•°"><a class="header" href="#æ–¹æ³•--å‡½æ•°">æ–¹æ³• &amp; å‡½æ•°</a></h3>
<h4 id="ç»“æ„ä½“ä¸Šçš„æ–¹æ³•"><a class="header" href="#ç»“æ„ä½“ä¸Šçš„æ–¹æ³•">ç»“æ„ä½“ä¸Šçš„æ–¹æ³•</a></h4>
<ul>
<li>ç»“æ„ä½“æ–¹æ³•ï¼šä¸ç®¡æ˜¯ä¸€ä¸ªå€¼ï¼Œè¿˜æ˜¯ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨çš„æŒ‡é’ˆï¼Œè°ƒç”¨è¿™æ ·çš„æ–¹æ³•éƒ½æ˜¯åˆæ³•çš„ã€‚æˆ–è€…è¯´ï¼šç”¨<strong>ä¸€ä¸ªæŒ‡é’ˆ</strong>æˆ–è€…<strong>ä¸€ä¸ªå¯å–å¾—åœ°å€çš„å€¼</strong>æ¥è°ƒç”¨éƒ½æ˜¯åˆæ³•çš„</li>
<li>åŒ¿åå­—æ®µçš„æ–¹æ³•ï¼šå±äºç»“æ„ä½“çš„åŒ¿åå­—æ®µçš„æ–¹æ³•å¯ä»¥è¢«ç›´æ¥è°ƒç”¨ï¼Œå°±å¥½åƒè¿™äº›æ–¹æ³•æ˜¯å±äºå®šä¹‰äº†åŒ¿åå­—æ®µçš„ç»“æ„ä½“ä¸€æ ·ã€‚</li>
</ul>
<pre><code class="language-go">type rectangle struct {
	length int
	width  int
}

func (r *rectangle) area() {
	r.length += 1
}

// func (r rectangle) area() {
// 	r.length += 1
// }

r := rectangle{
    length: 10,
    width:  5,
}

r.area()
(&amp;r).area()
// {12, 5}
// å¦‚æœæ”¹ä¸º ä¸å¸¦*çš„æ–¹æ³•ï¼Œ{10, 5}
</code></pre>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶å™¨ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨å€¼æ¥æ”¶å™¨ï¼Ÿ</p>
<ul>
<li>ä¸€èˆ¬æ¥è¯´ï¼ŒæŒ‡é’ˆæ¥æ”¶å™¨å¯ä»¥ä½¿ç”¨åœ¨ï¼šå¯¹æ–¹æ³•å†…éƒ¨çš„æ¥æ”¶å™¨æ‰€åšçš„æ”¹å˜åº”è¯¥å¯¹è°ƒç”¨è€…å¯è§æ—¶ã€‚</li>
<li>æŒ‡é’ˆæ¥æ”¶å™¨ä¹Ÿå¯ä»¥è¢«ä½¿ç”¨åœ¨å¦‚ä¸‹åœºæ™¯ï¼šå½“æ‹·è´ä¸€ä¸ªç»“æ„ä½“çš„ä»£ä»·è¿‡äºæ˜‚è´µæ—¶ã€‚è€ƒè™‘ä¸‹ä¸€ä¸ªç»“æ„ä½“æœ‰å¾ˆå¤šçš„å­—æ®µã€‚åœ¨æ–¹æ³•å†…ä½¿ç”¨è¿™ä¸ªç»“æ„ä½“åšä¸ºå€¼æ¥æ”¶å™¨éœ€è¦æ‹·è´æ•´ä¸ªç»“æ„ä½“ï¼Œè¿™æ˜¯å¾ˆæ˜‚è´µçš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨æŒ‡é’ˆæ¥æ”¶å™¨ï¼Œç»“æ„ä½“ä¸ä¼šè¢«æ‹·è´ï¼Œåªä¼šä¼ é€’ä¸€ä¸ªæŒ‡é’ˆåˆ°æ–¹æ³•å†…éƒ¨ä½¿ç”¨ã€‚</li>
<li>åœ¨å…¶ä»–çš„æ‰€æœ‰æƒ…å†µï¼Œå€¼æ¥æ”¶å™¨éƒ½å¯ä»¥è¢«ä½¿ç”¨ã€‚</li>
</ul>
<h4 id="å­¤å„¿è§„åˆ™"><a class="header" href="#å­¤å„¿è§„åˆ™">å­¤å„¿è§„åˆ™ğŸ¶</a></h4>
<p>ä¸‹é¢çš„ä¸å…è®¸ï¼Œå› ä¸º int ç±»å‹å’Œè¿™ä¸ªæ–¹æ³•ï¼Œä¸å†åŒä¸€ä¸ªåŒ…é‡Œ</p>
<pre><code class="language-go">func (a int) add(b int) {
}
</code></pre>
<p>è§£å†³æ–¹æ³•</p>
<ul>
<li>å®šä¹‰ç±»å‹åˆ«å</li>
</ul>
<pre><code class="language-go">type myInt int

func (a myInt) add(b myInt) myInt {
    return a + b
}
</code></pre>
<ul>
<li>wrapper åŒ…è£…</li>
</ul>
<h4 id="å‡½æ•°-1"><a class="header" href="#å‡½æ•°-1">å‡½æ•°</a></h4>
<p><strong>åŒ¿åå‡½æ•°</strong></p>
<pre><code class="language-go">func main() {
    func(n string) {
        fmt.Println(&quot;Welcome&quot;, n)
    }(&quot;Gophers&quot;)
}
</code></pre>
<p><strong>è‡ªå®šä¹‰å‡½æ•°ç±»å‹</strong></p>
<pre><code class="language-go">type add func(a int, b int) int

func main() {
    var a add = func(a int, b int) int {
        return a + b
    }
    s := a(5, 6)
    fmt.Println(&quot;Sum&quot;, s)
}
</code></pre>
<p><strong>é«˜é˜¶å‡½æ•°</strong></p>
<pre><code class="language-go">// æ¥å—å‡½æ•°
func simple(a func(a, b int) int) {
    fmt.Println(a(60, 7))
}

// è¿”å›å‡½æ•°
func simple() func(a, b int) int {
    f := func(a, b int) int {
        return a + b
    }
    return f
}
</code></pre>
<h3 id="æ¥å£"><a class="header" href="#æ¥å£">æ¥å£</a></h3>
<p>ç±»ä¼¼äº dyn Train</p>
<pre><code class="language-go">type SalaryCalculator interface {
    CalculateSalary() int
}
employees := []SalaryCalculator{pemp1, pemp2, cemp1}
</code></pre>
<h4 id="æ¥å£çš„æ–­è¨€"><a class="header" href="#æ¥å£çš„æ–­è¨€">æ¥å£çš„æ–­è¨€</a></h4>
<ul>
<li>ç±»å‹æ–­è¨€</li>
</ul>
<pre><code class="language-go">func assert(i interface{}) {
    v, ok := i.(int)
    fmt.Println(v, ok)
    // å¦‚æœä¸æ˜¯ int ç±»å‹ï¼Œv å°±ä¼šè¢«èµ‹ä¸º T çš„é›¶å€¼
}
func main() {
    var s interface{} = 56
    assert(s)
    var i interface{} = &quot;Steven Paul&quot;
    assert(i)
}
</code></pre>
<ul>
<li>switch type æ³¨æ„ï¼šæŠŠå˜é‡ä¼ é€’åˆ°å‡½æ•°ä¸­åä¼šè‡ªåŠ¨è½¬æ¢ç±»å‹åˆ° interfaceï¼Œå› æ­¤è°ƒç”¨å‡½æ•°èƒ½è¡Œï¼Œä½†æ˜¯ä¸‹é¢ç›´æ¥ switch å°±ä¸è¡Œ</li>
<li>å›æŠ¥é”™ï¼ša (variable of type int) is not an interface</li>
</ul>
<pre><code class="language-go">func findType(i interface{}) {
    switch i.(type) {
    case string:
        fmt.Printf(&quot;I am a string and my value is %s\n&quot;, i.(string))
    case int:
        fmt.Printf(&quot;I am an int and my value is %d\n&quot;, i.(int))
    default:
        fmt.Printf(&quot;Unknown type\n&quot;)
    }
}

func main() {
	a := 1
	findType(a)

	switch interface{}(a).(type) {
	case string:
		fmt.Printf(&quot;I am a string and my value is %s\n&quot;, interface{}(a).(string))
	case int:
		fmt.Printf(&quot;I am an int and my value is %d\n&quot;, interface{}(a).(int))
	default:
		fmt.Printf(&quot;Unknown type\n&quot;)
	}
}
</code></pre>
<h4 id="æ¥å£ç±»å‹å˜é‡"><a class="header" href="#æ¥å£ç±»å‹å˜é‡">æ¥å£ç±»å‹å˜é‡</a></h4>
<p>å£°æ˜ä¸€ä¸ªå˜é‡æ˜¯æ¥å£ç±»å‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå˜é‡å¯ä»¥è¢«èµ‹å€¼ä¸ºï¼Œä»»ä½•å®ç°äº†æ¥å£çš„ç±»å‹</p>
<pre><code class="language-go">type Describer interface {
    Describe()
}
type Person struct {
    name string
    age  int
}
type Address struct {
    state   string
    country string
}
</code></pre>
<p>ç°åœ¨è¿˜ä¸èƒ½èµ‹å€¼ï¼Œæ¥ä¸‹æ¥ä¸ºä¸¤ä¸ª struct æˆ‘ä»¬å®ç°æ¥å£</p>
<p>ä¸º person å®ç° describeï¼Œä½¿ç”¨<strong>å€¼</strong>æ¥å—è€…ï¼Œä¸‹é¢ä¸¤ç§èµ‹å€¼éƒ½å¯ä»¥ï¼Œä¹Ÿéƒ½èƒ½è°ƒç”¨æ–¹æ³•</p>
<pre><code class="language-go">func (p Person) Describe() { // ä½¿ç”¨å€¼æ¥å—è€…å®ç°
    fmt.Printf(&quot;%s is %d years old\n&quot;, p.name, p.age)
}
var d1 Describer
p1 := Person{&quot;Sam&quot;, 25}
d1 = p1
d1.Describe()
p2 := Person{&quot;James&quot;, 32}
d1 = &amp;p2
d1.Describe()
</code></pre>
<p>ä¸º Address å®ç° describerï¼Œä½¿ç”¨<strong>æŒ‡é’ˆ</strong>æ¥å—è€…ï¼Œä¸‹é¢å°±æ¯”è¾ƒç‰¹æ®Š d =
a ä¸èƒ½ç›´æ¥èµ‹å€¼ï¼Œå¦‚æœæ˜¯åœ¨ç»“æ„ä½“çš„æ–¹æ³•ä¸­ï¼Œä¸‹é¢çš„ä¸¤ç§èµ‹å€¼éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯åœ¨æ¥å£ä¸­ä¸è¡Œ</p>
<p>å…¶åŸå› æ˜¯ï¼šå¯¹äºä½¿ç”¨æŒ‡é’ˆæ¥å—è€…çš„æ–¹æ³•ï¼Œç”¨<strong>ä¸€ä¸ªæŒ‡é’ˆ</strong>æˆ–è€…<strong>ä¸€ä¸ªå¯å–å¾—åœ°å€çš„å€¼</strong>æ¥è°ƒç”¨éƒ½æ˜¯åˆæ³•çš„ã€‚ä½†æ¥å£ä¸­å­˜å‚¨çš„å…·ä½“å€¼ï¼ˆConcrete
Valueï¼‰å¹¶ä¸èƒ½å–åˆ°åœ°å€ï¼Œå› æ­¤åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå¯¹äºç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨è·å– a çš„åœ°å€ï¼Œäºæ˜¯ç¨‹åºæŠ¥é”™ã€‚</p>
<pre><code class="language-go">func (a *Address) Describe() { // ä½¿ç”¨æŒ‡é’ˆæ¥å—è€…å®ç°
    fmt.Printf(&quot;State %s Country %s&quot;, a.state, a.country)
}
var d Describer
a := Address{&quot;Washington&quot;, &quot;USA&quot;}

//d = a  // è¿™æ˜¯ä¸åˆæ³•çš„ï¼Œä¼šæŠ¥é”™ï¼šAddress does not implement Describer

d = &amp;a // è¿™æ˜¯åˆæ³•çš„ï¼ŒAddress ç±»å‹çš„æŒ‡é’ˆå®ç°äº† Describer æ¥å£
d.Describe()
</code></pre>
<h4 id="æ¥å£å¯ä»¥åµŒå¥—"><a class="header" href="#æ¥å£å¯ä»¥åµŒå¥—">æ¥å£å¯ä»¥åµŒå¥—</a></h4>
<p>ç±»ä¼¼äºåŒ¿åç»“æ„ä½“çš„åµŒå¥— ä¸€ä¸ªç»“æ„ä½“å®ç°äº† Aï¼ŒBï¼Œé‚£å°±è¯´å®ƒä¹Ÿå®ç°äº† C</p>
<pre><code class="language-go">type A interface {
    foo()
}

type B interface {
    bar() int
}

type C interface {
    A
    B
}
</code></pre>
<h4 id="æ¥å£çš„é›¶å€¼"><a class="header" href="#æ¥å£çš„é›¶å€¼">æ¥å£çš„é›¶å€¼</a></h4>
<p>æ¥å£çš„é›¶å€¼æ˜¯ nilï¼ŒåŒæ—¶å…¶åº•å±‚å€¼ï¼ˆUnderlying Valueï¼‰å’Œå…·ä½“ç±»å‹ï¼ˆConcrete Typeï¼‰éƒ½ä¸º nilã€‚è°ƒç”¨æ–¹æ³•ä¼š panic</p>
<h4 id="æ¥å£çš„å‘"><a class="header" href="#æ¥å£çš„å‘">æ¥å£çš„å‘</a></h4>
<ul>
<li>ä¸èƒ½æŠŠ interface èµ‹å€¼ä¸ºåˆ«çš„ç±»å‹
<pre><code class="language-go">func main() {
    // å£°æ˜ a å˜é‡ï¼Œç±»å‹ intï¼Œåˆå§‹å€¼ä¸º 1
    var a int = 1

    // å£°æ˜ i å˜é‡ï¼Œç±»å‹ä¸º interface{}, åˆå§‹å€¼ä¸º aï¼Œæ­¤æ—¶ i çš„å€¼å˜ä¸º 1
    var i interface{} = a

    // å£°æ˜ b å˜é‡ï¼Œå°è¯•èµ‹å€¼ i
    var b int = i
}
</code></pre>
</li>
<li>åˆ‡ç‰‡ä¹Ÿä¸èƒ½å†åˆ†
<pre><code class="language-go">func main() {
    sli := []int{2, 3, 5, 7, 11, 13}

    var i interface{}
    i = sli

    g := i[1:3]
    fmt.Println(g)
}
</code></pre>
</li>
</ul>
<h3 id="channel"><a class="header" href="#channel">channel</a></h3>
<h4 id="ç‰¹æ€§"><a class="header" href="#ç‰¹æ€§">ç‰¹æ€§</a></h4>
<ul>
<li>go çš„ channel é»˜è®¤æ˜¯åŒå‘çš„ï¼Œæ—¢å¯ä»¥ sendï¼Œä¹Ÿå¯ä»¥ recv</li>
<li>channel å¿…é¡»æœ‰å‘é€ç«¯å’Œæ¥æ”¶ç«¯ï¼Œå¦åˆ™å°± panic</li>
<li>make(chan int, n) n è¡¨ç¤ºç¼“å†²åŒºå¤§å°ï¼Œå¯ä»¥çœç•¥ï¼Œé»˜è®¤ä¸º 0
<ul>
<li>è€Œå¯¹äºæ— ç¼“å†² channelï¼Œæ¥å—å’Œå‘é€éƒ½è¦åœ¨ä¸åŒæºç¨‹ä¹‹é—´ï¼Œä¸è®©ä¸¤ä¸ªäººäº’ç›¸é˜»å¡</li>
<li>å¯¹äºæœ‰ç¼“å†²åŒº channelï¼Œåœ¨ç¼“å†²åŒºå¤§å°å†…ï¼Œä¸¤ä¸ªä¸ä¼šäº’ç›¸é˜»å¡ï¼Œå¯ä»¥åœ¨åŒä¸€åç¨‹å†…</li>
<li>å¦‚æœè¶…è¿‡ç¼“å†²åŒºå¤§å°ï¼Œå°±ä¼š panicï¼Œæ‰€ä»¥è¶…è¿‡ç¼“å†²åŒºå¤§å°çš„è¿˜æ˜¯å¿…é¡»åœ¨å…¶ä»–çš„åç¨‹ä¸­å¤„ç†</li>
</ul>
</li>
<li>ç¼“å†²åŒºä¹Ÿæœ‰ len å’Œ cap çš„æ¦‚å¿µ</li>
<li>å¯¹äº rustï¼Œå¦‚æœè¶…å‡ºç¼“å†²åŒºå¤§å° send å°±ä¼šè¿”å› Error</li>
</ul>
<pre><code class="language-go">func sendData(sendch chan&lt;- int) {
    sendch &lt;- 10
}

func main() {
    cha1 := make(chan int)
    go sendData(cha1)
    fmt.Println(&lt;-cha1)
}
</code></pre>
<h4 id="å•å‘-channel"><a class="header" href="#å•å‘-channel">å•å‘ channel</a></h4>
<pre><code class="language-go">// å£°æ˜å‚æ•°æ˜¯ä¸€ä¸ªåªèƒ½å‘é€çš„ ch
func sendData(sendch chan&lt;- int) {
    sendch &lt;- 10
}

func main() {
    // å£°æ˜ä¸€ä¸ªåªèƒ½å‘é€çš„ channelï¼Œä¸‹é¢ä½¿ç”¨å®ƒå»æ¥å—å°±ä¼š panic
    // å¦‚æœå£°æ˜ä¸º chan intï¼Œä¸‹é¢çš„æ¥å—ä¸ä¼š panicï¼Œåœ¨ sendData ä¼šè¢«è½¬æ¢ä¸ºåªèƒ½å‘é€çš„ channelï¼Œè€Œ main ä¸­çš„ä»ç„¶æ˜¯åŒå‘çš„
    sendch := make(chan&lt;- int)
    go sendData(sendch)
    fmt.Println(&lt;-sendch)
}
</code></pre>
<h4 id="å…³é—­-channel"><a class="header" href="#å…³é—­-channel">å…³é—­ channel</a></h4>
<p>ä¸èƒ½ä¸€ç›´ send æˆ–è€…ä¸€ç›´ recvï¼Œå¤„ç†å®ŒåŠæ—¶æŠŠä¸€ç«¯ close äº†</p>
<pre><code class="language-go">func producer(chnl chan int) {
    for i := 0; i &lt; 10; i++ {
        chnl &lt;- i
    }
    // å‘é€å®Œæˆåï¼Œä½¿ç”¨ send å‡½æ•°æ˜¾å¼å…³é—­ channel
    close(chnl)
}

func main() {
    ch := make(chan int)
    go producer(ch)
    for {
        // é€šè¿‡ ok åˆ¤æ–­ channel æ˜¯å¦å…³é—­
        v, ok := &lt;-ch
        if ok == false {
            break
        }
        fmt.Println(&quot;Received &quot;, v, ok)
    }
}
</code></pre>
<h4 id="waitgroup"><a class="header" href="#waitgroup">waitGroup</a></h4>
<p>ç­‰å¾…ä¸€ç¾¤åç¨‹ç»“æŸ</p>
<p>æ³¨æ„ä¸€å®šè¦ä½¿ç”¨æŒ‡é’ˆ</p>
<h4 id="å·¥ä½œæ± "><a class="header" href="#å·¥ä½œæ± ">å·¥ä½œæ± </a></h4>
<pre><code class="language-go">// æ¨¡æ‹Ÿè€—æ—¶çš„è®¡ç®—
func calculate(number int) int {
	time.Sleep(2 * time.Second)
	return number
}

// ç”Ÿäº§è€…ï¼Œåˆ†å‘å·¥ä½œ
func produceJobs(jobs chan&lt;- Job, n int) {
	for i := 0; i &lt; n; i++ {
		// fmt.Printf(&quot;sending %d \n&quot;, i)
		jobs &lt;- Job{
			id:     i,
			number: i,
		}
	}
	close(jobs)
}

// æ¶ˆè´¹è€…ï¼Œæ¥å—å·¥ä½œï¼Œå¹²å®Œæ´»å°±é€šçŸ¥ä»¥ä¸‹ç®¡ç†å‘˜
func consumeFunc(jobs &lt;-chan Job, results chan&lt;- int, wg *sync.WaitGroup) {
	// æ¯ä¸ª worker éƒ½åœ¨æŠ¢å·¥ä½œï¼ŒçœŸç§¯æå•Š
	for job := range jobs {
		// fmt.Printf(&quot;id: %d\n&quot;, job.id)
		results &lt;- calculate(job.number)
	}
	wg.Done()
}

// ç®¡ç†å‘˜ï¼Œç­‰å¾…æ‰€æœ‰å·¥äººéƒ½é€šçŸ¥ä»–ï¼Œæ¯æ¬¡è¢«é€šçŸ¥ï¼Œè®¡æ•°å™¨å°±å‡ 1ï¼Œå½“è®¡æ•°å™¨ä¸º 0 æ˜¯å°±ä¸å†é˜»å¡
func consumeJobs(jobs &lt;-chan Job, results chan&lt;- int, worker_number int) {
	// ç­‰å¾…ä¸€æ‰¹ goroutine ç»“æŸï¼Œç±»ä¼¼äº join
	var wg sync.WaitGroup
	// ä¸ºæ¯ä¸€ä¸ªå·¥ä½œå¼€å¯ä¸€ä¸ª goroutine
	for i := 0; i &lt; worker_number; i++ {
		wg.Add(1)
		go consumeFunc(jobs, results, &amp;wg)
	}
	wg.Wait() // é˜»å¡å½“å‰ goroutine ç›´åˆ°è®¡æ•°å™¨å½’ 0ï¼Œæ‰€æœ‰ job éƒ½åº”è¯¥åšå®Œäº†ï¼Œresult åº”è¯¥ä¹Ÿéƒ½å‘é€å‡ºå»äº†
	close(results)
}

type Job struct {
	id     int
	number int
}

func main() {
	startTime := time.Now()

	jobs := make(chan Job, 10)
	results := make(chan int, 10)

	// å‘é€ work, jobs send
	go produceJobs(jobs, 100)
	// jobs recv | results send
	go consumeJobs(jobs, results, 50)
	// results recv
	a := 0
	for res := range results {
		a += res
	}
	fmt.Print(&quot;res: &quot;, a)

	endTime := time.Now()
	diff := endTime.Sub(startTime)
	fmt.Println(&quot;total time taken &quot;, diff.Seconds(), &quot;seconds&quot;)

}
</code></pre>
<h4 id="select"><a class="header" href="#select">select</a></h4>
<p>ç”¨æ³•æŒºæ™®é€š</p>
<ul>
<li>channel ä¸é™åˆ¶ send/recvï¼Œåªè¦æ˜¯å¯¹ channel çš„æ“ä½œå°±è¡Œ</li>
<li>å¦‚æœæœ‰å¤šä¸ª channel å‡†å¤‡å°±ç»ªï¼Œå°±éšæœºé€‰æ‹©ä¸€ä¸ªæ‰§è¡Œ</li>
<li>æ­»é”ä¸é»˜è®¤æƒ…å†µï¼šå¦‚æœ select ä¸€ç›´æ²¡æœ‰å‘½ä¸­ï¼Œå°±ä¼šè§¦å‘æ­»é”ï¼Œå¯¼è‡´ panicï¼Œç©º select ä¸€æ ·ä¹Ÿä¼šå¯¼è‡´ panic</li>
<li>å¯ä»¥å‡†å¤‡ä¸€ä¸ª timeout chanï¼Œåˆ°æ—¶é—´å°± send ä½œä¸ºè¶…æ—¶ä¿¡å·</li>
</ul>
<pre><code class="language-go">func main() {
    ch := make(chan string)
    select {
    case &lt;-ch:
    default:
        fmt.Println(&quot;default case executed&quot;)
    }
}
</code></pre>
<h3 id="å¹¶å‘-1"><a class="header" href="#å¹¶å‘-1">å¹¶å‘</a></h3>
<p>goroutine ä¸èƒ½ä¿è¯å¹¶å‘å®‰å…¨ï¼Œä¸‹é¢æ˜¯ä¸€äº›è§£å†³æ–¹æ³•</p>
<ul>
<li>æ€»ä½“è¯´æ¥ï¼Œå½“ Go åç¨‹éœ€è¦ä¸å…¶ä»–åç¨‹é€šä¿¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ channelã€‚è€Œå½“åªå…è®¸ä¸€ä¸ªåç¨‹è®¿é—®ä¸´ç•ŒåŒºæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ Mutexã€‚</li>
<li>å°±æˆ‘ä»¬ä¸Šé¢è§£å†³çš„é—®é¢˜è€Œè¨€ï¼Œæˆ‘æ›´å€¾å‘äºä½¿ç”¨ Mutexï¼Œå› ä¸ºè¯¥é—®é¢˜å¹¶ä¸éœ€è¦åç¨‹é—´çš„é€šä¿¡ã€‚æ‰€ä»¥ Mutex æ˜¯å¾ˆè‡ªç„¶çš„é€‰æ‹©ã€‚</li>
</ul>
<h4 id="mutex"><a class="header" href="#mutex">mutex</a></h4>
<pre><code class="language-go">func aa(wg *sync.WaitGroup, m *sync.Mutex) {
	m.Lock()
	x += 1
	m.Unlock()
	wg.Done()
}

func main() {
    var wg sync.WaitGroup
    var m sync.Mutex
    for i := 0; i &lt; 1000; i++ {
        wg.Add(1)
        go aa(&amp;wg, &amp;m)
    }
    wg.Wait()
    fmt.Print(x)
}
</code></pre>
<h4 id="channel-1"><a class="header" href="#channel-1">channel</a></h4>
<p>ä½¿ç”¨ç¼“å†²ä¸º 1 çš„ channel å®ç°</p>
<pre><code class="language-go">func aa(wg *sync.WaitGroup, ch chan bool) {
	ch &lt;- true
	x += 1
	&lt;-ch
	wg.Done()
}

func main() {
	startTime := time.Now()
	var wg sync.WaitGroup
	var ch = make(chan bool, 1)
	for i := 0; i &lt; 1000; i++ {
		wg.Add(1)
		go aa(&amp;wg, ch)
	}
	wg.Wait()
	fmt.Print(x)
}
</code></pre>
<h3 id="defer"><a class="header" href="#defer">defer</a></h3>
<h4 id="å®å‚æ±‚å€¼"><a class="header" href="#å®å‚æ±‚å€¼">å®å‚æ±‚å€¼</a></h4>
<p>å½“æ‰§è¡Œ defer è¯­å¥çš„æ—¶å€™ï¼Œå°±ä¼šå¯¹å»¶è¿Ÿå‡½æ•°çš„å®å‚è¿›è¡Œæ±‚å€¼ã€‚</p>
<pre><code class="language-go">func printA(a int) {
    fmt.Println(&quot;value of a in deferred function&quot;, a)
}
func main() {
    a := 5
    defer printA(a)
    a = 10
}
// value of a in deferred function 5
</code></pre>
<h4 id="defer-æ ˆ"><a class="header" href="#defer-æ ˆ">defer æ ˆ</a></h4>
<p>å½“ä¸€ä¸ªå‡½æ•°å†…å¤šæ¬¡è°ƒç”¨ defer æ—¶ï¼ŒGo ä¼šæŠŠ defer è°ƒç”¨æ”¾å…¥åˆ°ä¸€ä¸ªæ ˆä¸­ï¼ŒéšåæŒ‰ç…§åè¿›å…ˆå‡ºï¼ˆLast In First Out, LIFOï¼‰çš„é¡ºåºæ‰§è¡Œã€‚</p>
<p>ä¸‹é¢çš„ç¨‹åºï¼Œä½¿ç”¨ defer æ ˆï¼Œå°†ä¸€ä¸ªå­—ç¬¦ä¸²é€†åºæ‰“å°ã€‚</p>
<pre><code class="language-go">func main() {
    name := &quot;Naveen&quot;
    for _, v := range []rune(name) {
        defer fmt.Printf(&quot;%c&quot;, v)
    }
}
// å€’å™è¾“å‡ºï¼šneevaN
</code></pre>
<h4 id="defer-åœ¨-return-åæ‰§è¡Œ"><a class="header" href="#defer-åœ¨-return-åæ‰§è¡Œ">defer åœ¨ return åæ‰§è¡Œ</a></h4>
<pre><code class="language-go">import &quot;fmt&quot;

var name string = &quot;go&quot;

func myfunc() string {
    defer func() {
        name = &quot;python&quot;
    }()

    fmt.Printf(&quot;myfunc å‡½æ•°é‡Œçš„ nameï¼š%s\n&quot;, name) // go
    return name
}

func main() {
    myname := myfunc()
    fmt.Printf(&quot;main å‡½æ•°é‡Œçš„ name: %s\n&quot;, name) // python
    fmt.Println(&quot;main å‡½æ•°é‡Œçš„ myname: &quot;, myname) // go
}
</code></pre>
<h4 id="ä½¿ç”¨åœºæ™¯"><a class="header" href="#ä½¿ç”¨åœºæ™¯">ä½¿ç”¨åœºæ™¯</a></h4>
<pre><code class="language-go">func (r rect) area(wg *sync.WaitGroup) {
    // defer wg.Done() // ä»£æ›¿ä¸‹é¢çš„ 3 ä¸ª return ä¸­çš„ wg.Done()
    if r.length &lt; 0 {
        fmt.Printf(&quot;rect %v's length should be greater than zero\n&quot;, r)
        wg.Done()
        return
    }
    if r.width &lt; 0 {
        fmt.Printf(&quot;rect %v's width should be greater than zero\n&quot;, r)
        wg.Done()
        return
    }
    area := r.length * r.width
    fmt.Printf(&quot;rect %v's area %d\n&quot;, r, area)
    wg.Done()
}
</code></pre>
<h3 id="é”™è¯¯å¤„ç†-1"><a class="header" href="#é”™è¯¯å¤„ç†-1">é”™è¯¯å¤„ç†</a></h3>
<h4 id="é”™è¯¯æ¥å£"><a class="header" href="#é”™è¯¯æ¥å£">é”™è¯¯æ¥å£</a></h4>
<p>åœ¨æ ‡å‡†åº“é‡Œçš„å®šä¹‰</p>
<pre><code class="language-go">type error interface {
    Error() string
}
</code></pre>
<p>open å‡½æ•°çš„è®¾è®¡</p>
<pre><code class="language-go">type PathError struct {
    Op   string
    Path string
    Err  error
}

func (e *PathError) Error() string { return e.Op + &quot; &quot; + e.Path + &quot;: &quot; + e.Err.Error() }
</code></pre>
<h4 id="é”™è¯¯ç±»å‹æ–­è¨€"><a class="header" href="#é”™è¯¯ç±»å‹æ–­è¨€">é”™è¯¯ç±»å‹æ–­è¨€</a></h4>
<p>é€šè¿‡ç±»å‹æ–­è¨€æ‹¿åˆ°é”™è¯¯ä¿¡æ¯</p>
<pre><code class="language-go">func main() {
    f, err := os.Open(&quot;/test.txt&quot;)
    if err, ok := err.(*os.PathError); ok {
        fmt.Println(&quot;File at path&quot;, err.Path, &quot;failed to open&quot;)
        return
    }
    fmt.Println(f.Name(), &quot;opened successfully&quot;)
}
</code></pre>
<h4 id="å­é”™è¯¯ç±»å‹"><a class="header" href="#å­é”™è¯¯ç±»å‹">å­é”™è¯¯ç±»å‹</a></h4>
<pre><code class="language-go">type DNSError struct {
    ...
}

func (e *DNSError) Error() string {
    ...
}
func (e *DNSError) Timeout() bool {
    ...
}
func (e *DNSError) Temporary() bool {
    ...
}

func main() {
    addr, err := net.LookupHost(&quot;golangbot123.com&quot;)
    if err, ok := err.(*net.DNSError); ok {
        if err.Timeout() {
            fmt.Println(&quot;operation timed out&quot;)
        } else if err.Temporary() {
            fmt.Println(&quot;temporary error&quot;)
        } else {
            fmt.Println(&quot;generic error: &quot;, err)
        }
        return
    }
    fmt.Println(addr)
}
</code></pre>
<h4 id="panic-å’Œ-recover"><a class="header" href="#panic-å’Œ-recover">panic å’Œ recover</a></h4>
<p>ä¸‹é¢ä½¿ç”¨ recover å»æ¢å¤ panic</p>
<ul>
<li>æ³¨æ„ï¼šGo åç¨‹ä¸­è°ƒç”¨ recover æ‰ç®¡ç”¨ã€‚recover ä¸èƒ½æ¢å¤ä¸€ä¸ªä¸åŒåç¨‹çš„ panicã€‚</li>
</ul>
<pre><code class="language-go">func recoverName() {
    if r := recover(); r!= nil {
        fmt.Println(&quot;recovered from &quot;, r)
    }
}

func fullName(firstName *string, lastName *string) {
    defer recoverName()
    if firstName == nil {
        panic(&quot;runtime error: first name cannot be nil&quot;)
    }
    if lastName == nil {
        panic(&quot;runtime error: last name cannot be nil&quot;)
    }
    fmt.Printf(&quot;%s %s\n&quot;, *firstName, *lastName)
    fmt.Println(&quot;returned normally from fullName&quot;)
}
</code></pre>
<h4 id="æ¢å¤åè·å¾—å †æ ˆ"><a class="header" href="#æ¢å¤åè·å¾—å †æ ˆ">æ¢å¤åè·å¾—å †æ ˆ</a></h4>
<pre><code class="language-go">import (
    &quot;runtime/debug&quot;
)

func r() {
    if r := recover(); r != nil {
        fmt.Println(&quot;Recovered&quot;, r)
        debug.PrintStack()
    }
}
</code></pre>
<h3 id="åå°„"><a class="header" href="#åå°„">åå°„</a></h3>
<p><strong>åŸºç¡€</strong></p>
<pre><code class="language-go">type order struct {
	ordId      int
	customerId int
}

func play(q interface{}) {
	t := reflect.TypeOf(q)
	k := t.Kind()

	v := reflect.ValueOf(q)
	fieldsNum := v.NumField()
	fmt.Println(&quot;Type: &quot;, t, &quot;Kind: &quot;, k)
	fmt.Println(&quot;Value: &quot;, v, &quot;FieldNum: &quot;, fieldsNum)
	for i := 0; i &lt; fieldsNum; i++ {
		fmt.Println(t.Field(i).Name, v.Field(i).Type(), v.Field(i))
	}
}

func createQuery(q interface{}) {
    // æ‹¿åˆ°ç±»å‹
    if reflect.TypeOf(q).Kind() != reflect.Struct {
		return
	}
    // æ‹¿åˆ°ç±»å‹åç§°
	t := reflect.TypeOf(q).Name()
	query := fmt.Sprintf(&quot;insert into %s values(&quot;, t)
    // æ‹¿åˆ°å€¼
	v := reflect.ValueOf(q)
    // æ‹¿åˆ°å­—æ®µæ•°é‡
	for i := 0; i &lt; v.NumField(); i++ {
        // æ‹¿åˆ°å­—æ®µç±»å‹ï¼Œå­—æ®µåç§°ï¼Œå­—æ®µå€¼
		switch v.Field(i).Kind() {
		case reflect.Int:
			if i == 0 {
				query = fmt.Sprintf(&quot;%s%d&quot;, query, v.Field(i).Int())
			} else {
				query = fmt.Sprintf(&quot;%s, %d&quot;, query, v.Field(i).Int())
			}
		case reflect.String:
			if i == 0 {
				query = fmt.Sprintf(&quot;%s\&quot;%s\&quot;&quot;, query, v.Field(i).String())
			} else {
				query = fmt.Sprintf(&quot;%s, \&quot;%s\&quot;&quot;, query, v.Field(i).String())
			}
		default:
			fmt.Println(&quot;unsupported field type&quot;)
			return
		}
	}
	query = fmt.Sprintf(&quot;%s)&quot;, query)
	fmt.Println(query)
	return
}

func main() {
	o := order{
		ordId:      456,
		customerId: 56,
	}
	play(o)
	println(&quot;----------------------------------------&quot;)
	createQuery(o)

	var a int = 1
	b := reflect.ValueOf(a).String()
	fmt.Println(reflect.TypeOf(b))
}
</code></pre>
<p><strong>ä¿®æ”¹ç±»å‹</strong></p>
<pre><code class="language-go">func main() {
    var age interface{} = 25
    v := reflect.ValueOf(age)
    // ä»åå°„å¯¹è±¡åˆ°æ¥å£å˜é‡
    i := v.Interface().(int)
}
</code></pre>
<p><strong>å¯å†™æ€§</strong></p>
<pre><code class="language-go">func main() {
    var name string = &quot;Go ç¼–ç¨‹æ—¶å…‰&quot;
    v1 := reflect.ValueOf(&amp;name)
    fmt.Println(&quot;v1 å¯å†™æ€§ä¸ºï¼š&quot;, v1.CanSet())

    v2 := v1.Elem()
    fmt.Println(&quot;v2 å¯å†™æ€§ä¸ºï¼š&quot;, v2.CanSet())
}
</code></pre>
<h2 id="è¿›é˜¶"><a class="header" href="#è¿›é˜¶">è¿›é˜¶</a></h2>
<h3 id="å˜é‡-1"><a class="header" href="#å˜é‡-1">å˜é‡</a></h3>
<h4 id="make"><a class="header" href="#make">make</a></h4>
<p>make å‡½æ•°åˆ›å»º sliceã€map æˆ– chan ç±»å‹å˜é‡</p>
<p><strong>å’Œ new çš„åŒºåˆ«</strong></p>
<ul>
<li>
<p>newï¼šä¸ºæ‰€æœ‰çš„ç±»å‹åˆ†é…å†…å­˜ï¼Œå¹¶åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼Œè¿”å›æŒ‡é’ˆã€‚</p>
</li>
<li>
<p>makeï¼šåªèƒ½ä¸º sliceï¼Œmapï¼Œchan åˆ†é…å†…å­˜ï¼Œå¹¶åˆå§‹åŒ–ï¼Œè¿”å›çš„æ˜¯ç±»å‹ (æŒ‡é’ˆ)ã€‚å› ä¸ºè¿™ä¸‰ä¸ªæœ¬èº«å°±æ˜¯å¼•ç”¨ç±»å‹</p>
</li>
<li>
<p>sliceã€map å’Œ chan æ˜¯ Go ä¸­çš„å¼•ç”¨ç±»å‹ï¼Œå®ƒä»¬çš„åˆ›å»ºå’Œåˆå§‹åŒ–ï¼Œä¸€èˆ¬ä½¿ç”¨ makeã€‚ç‰¹åˆ«çš„ï¼Œchan åªèƒ½ç”¨ makeã€‚slice å’Œ map
è¿˜å¯ä»¥ç®€å•çš„æ–¹å¼ï¼š</p>
</li>
</ul>
<pre><code class="language-go">slice := []int{0, 0}
m := map[string]int{}
</code></pre>
<h4 id="åŒ¿åå˜é‡"><a class="header" href="#åŒ¿åå˜é‡">åŒ¿åå˜é‡</a></h4>
<ul>
<li>ä¸åˆ†é…å†…å­˜ï¼Œä¸å ç”¨å†…å­˜ç©ºé—´</li>
</ul>
<h4 id="æµ®ç‚¹æ•°"><a class="header" href="#æµ®ç‚¹æ•°">æµ®ç‚¹æ•°</a></h4>
<p>æµ®ç‚¹æ•°è½¬äºŒè¿›åˆ¶æ—¶ä¸¢å¤±äº†ç²¾åº¦ï¼Œè®¡ç®—å®Œå†è½¬å›åè¿›åˆ¶æ—¶å’Œç†è®ºç»“æœä¸åŒã€‚</p>
<ul>
<li>f32: 1 8</li>
<li>f64: 1 11</li>
</ul>
<h4 id="ä½œç”¨åŸŸ"><a class="header" href="#ä½œç”¨åŸŸ">ä½œç”¨åŸŸ</a></h4>
<p><strong>åˆ†ç±»</strong></p>
<ul>
<li>å†…ç½®ä½œç”¨åŸŸï¼šä¸éœ€è¦è‡ªå·±å£°æ˜ï¼Œæ‰€æœ‰çš„å…³é”®å­—å’Œå†…ç½®ç±»å‹ã€å‡½æ•°éƒ½æ‹¥æœ‰å…¨å±€ä½œç”¨åŸŸ</li>
<li>åŒ…çº§ä½œç”¨åŸŸï¼šå¿…é ˆå‡½æ•°å¤–å£°æ˜ï¼Œåœ¨è¯¥åŒ…å†…çš„æ‰€æœ‰æ–‡ä»¶éƒ½å¯ä»¥è®¿é—®</li>
<li>æ–‡ä»¶çº§ä½œç”¨åŸŸï¼šä¸éœ€è¦å£°æ˜ï¼Œå¯¼å…¥å³å¯ã€‚ä¸€ä¸ªæ–‡ä»¶ä¸­é€šè¿‡ import å¯¼å…¥çš„åŒ…åï¼Œåªåœ¨è¯¥æ–‡ä»¶å†…å¯ç”¨</li>
<li>å±€éƒ¨ä½œç”¨åŸŸï¼šåœ¨è‡ªå·±çš„è¯­å¥å—å†…å£°æ˜ï¼ŒåŒ…æ‹¬å‡½æ•°ï¼Œforã€if ç­‰è¯­å¥å—ï¼Œæˆ–è‡ªå®šä¹‰çš„ {} è¯­å¥å—å½¢æˆçš„ä½œç”¨åŸŸï¼Œåªåœ¨è‡ªå·±çš„å±€éƒ¨ä½œç”¨åŸŸå†…å¯ç”¨</li>
</ul>
<p><strong>ä½œç”¨è§„åˆ™</strong></p>
<ul>
<li>ä½å±‚ä½œç”¨åŸŸï¼Œå¯ä»¥è®¿é—®é«˜å±‚ä½œç”¨åŸŸ</li>
<li>åŒä¸€å±‚çº§çš„ä½œç”¨åŸŸï¼Œæ˜¯ç›¸äº’éš”ç¦»çš„</li>
<li>ä½å±‚ä½œç”¨åŸŸé‡Œå£°æ˜çš„å˜é‡ï¼Œä¼šè¦†ç›–é«˜å±‚ä½œç”¨åŸŸé‡Œå£°æ˜çš„å˜é‡</li>
</ul>
<p><strong>åŠ¨æ€ä½œç”¨åŸŸ</strong></p>
<p>ä¸‹é¢çš„ bash è„šæœ¬ä¸­ï¼Œfunc02 åœ¨ func01 å†…éƒ¨å¯ä»¥è®¿é—®åˆ° valueï¼Œä½†åœ¨ func01 å¤–é¢ä¸èƒ½ï¼Œå±äºåŠ¨æ€ä½œç”¨åŸŸ</p>
<pre><code class="language-shell">#!/bin/bash
func01() {
    local value=1
    func02
}
func02() {
    echo &quot;func02 sees value as ${value}&quot;
}

# æ‰§è¡Œå‡½æ•°
func01
func02
</code></pre>
<h3 id="åç¨‹æ± "><a class="header" href="#åç¨‹æ± ">åç¨‹æ± </a></h3>
<pre><code class="language-go">type Pool struct {
	work chan func()   // ä»»åŠ¡
	sem  chan struct{} // ä½¿ç”¨ç¼“å†²åŒºå¤§å°æ§åˆ¶å·¥äººæ•°é‡
}

func New(size int) *Pool {
	return &amp;Pool{
		work: make(chan func()),
		sem:  make(chan struct{}, size),
	}
}
func (p *Pool) worker(task func()) {
	defer func() { &lt;-p.sem }()
	for {
		task()
		task = &lt;-p.work
	}
}
func (p *Pool) NewTask(task func()) {
	// ç¬¬ä¸€æ¬¡åŠ æ–°ä»»åŠ¡æ—¶ï¼Œwork ç¼“å†²åŒºå¤§å°ä¸º 0ï¼Œå‘å‡ºå»ä¹Ÿæ²¡äººæ¥å—ï¼Œæ‰€ä»¥ä¸€å®šä¼šèµ°ç¬¬äºŒä¸ª
	// ç›¸å½“äºæ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªå·¥äººå¤„ç†ä»»åŠ¡ï¼Œworker æœ¬èº«æ˜¯ä¸ª for å¾ªç¯ï¼Œå®ƒå¤„ç†å®Œç¬¬ä¸€ä¸ªä»»åŠ¡åä¼šç»§ç»­æ¥å—æ–°ä»»åŠ¡
	// ç¬¬äºŒæ¬¡åŠ å…¥æ—¶ï¼Œå°±è¢«ç¬¬ä¸€ä¸ªå·¥äººå¤„ç†äº†ï¼Œ
	// å¦‚æœç¬¬ä¸‰ä¸ªåŠ å…¥ï¼Œå› ä¸º sem ç¼“å†²åŒºå¤§å°çš„é™åˆ¶ï¼Œä¸ä¼šç»§ç»­äº§ç”Ÿæ–°çš„ worker
	select {
	case p.work &lt;- task:
	case p.sem &lt;- struct{}{}:
		go p.worker(task)
	}
}
func main() {
	pool := New(2)
	for i := 0; i &lt; 5; i++ {
		pool.NewTask(func() {
			time.Sleep(1 * time.Second)
			fmt.Println(time.Now())
		})
	}
	time.Sleep(4 * time.Second)
}
</code></pre>
<h3 id="åŠ¨æ€ç±»å‹"><a class="header" href="#åŠ¨æ€ç±»å‹">åŠ¨æ€ç±»å‹</a></h3>
<p>æ¥å£åˆ†ä¸ºä¸¤ç§<code>iface</code>å’Œ<code>eface</code></p>
<p>æ‰€æœ‰çš„å˜é‡éƒ½å®ç°äº†ç©ºæ¥å£ (eface)</p>
<pre><code class="language-go">// å®šä¹‰é™æ€ç±»å‹
i := (int)(25)
i = &quot;Go ç¼–ç¨‹æ—¶å…‰&quot; // ä¼šæŠ¥é”™

// å®šä¹‰åŠ¨æ€ç±»å‹
i := (interface{})(25)
var i interface{}
i = 18

i = &quot;Go ç¼–ç¨‹æ—¶å…‰&quot; // ä¸Šé¢ä¸‰ç§éƒ½è¡Œï¼Œä¸ä¼šæŠ¥é”™
</code></pre>
<pre><code class="language-go">var reader io.Reader

tty, err := os.OpenFile(&quot;/dev/tty&quot;, os.O_RDWR, 0)
if err != nil {
    return nil, err
}

reader = tty
</code></pre>
<p>ç¬¬ä¸€è¡Œä»£ç ç»“æŸåï¼Œreader çš„é™æ€ç±»å‹ä¸º<code>io.Reader</code>è¿˜æ²¡æœ‰åŠ¨æ€ç±»å‹
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203060928375.png" alt="" />
è¢«èµ‹å€¼ä¸º tty åï¼Œreader çš„åŠ¨æ€ç±»å‹å˜ä¸º<code>*os.File</code>
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203060936153.png" alt="" /></p>
<pre><code class="language-go">//ä¸å¸¦å‡½æ•°çš„ interface
var empty interface{}

tty, err := os.OpenFile(&quot;/dev/tty&quot;, os.O_RDWR, 0)
if err != nil {
    return nil, err
}

empty = tty
</code></pre>
<p>åˆšå¼€å§‹ empty æ˜¯ efaceï¼Œ<code>_type</code>ä¸º nil
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203060938295.png" alt="" />
è¢«èµ‹å€¼åï¼Œ<code>_type</code>çš„<strong>é™æ€ç±»å‹</strong>ä¸º<code>*os.File</code>
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203060938635.png" alt="" /></p>
<h3 id="å¯¼å…¥"><a class="header" href="#å¯¼å…¥">å¯¼å…¥</a></h3>
<p>å¯¼å…¥æ–¹å¼ï¼š</p>
<ul>
<li>ç»å¯¹å¯¼å…¥ï¼šä» <code>$GOPATH/src</code> æˆ– <strong><code>$GOROOT</code></strong> æˆ–è€… <code>$GOPATH/pkg/mod</code> ç›®å½•ä¸‹æœç´¢åŒ…å¹¶å¯¼å…¥</li>
<li>ç›¸å¯¹å¯¼å…¥ï¼šä»å½“å‰ç›®å½•ä¸­æœç´¢åŒ…å¹¶å¼€å§‹å¯¼å…¥ã€‚å°±åƒä¸‹é¢è¿™æ ·</li>
</ul>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>å¯¼å…¥æ—¶ï¼Œæ˜¯æŒ‰ç…§ç›®å½•å¯¼å…¥ã€‚å¯¼å…¥ç›®å½•åï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰åŒ…ã€‚</li>
<li>åªè¦ä¸æ˜¯<code>.</code>æˆ–<code>..</code>å¼€å¤´ï¼Œå…¨éƒ½æ˜¯ç»å¯¹è·¯å¾„</li>
</ul>
<h3 id="context"><a class="header" href="#context">context</a></h3>
<p>å½“ä¸€ä¸ª goutine å¼€å¯åï¼Œåªèƒ½é€šè¿‡ channel çš„é€šçŸ¥å®ç°ç®¡ç†ï¼Œä½¿ç”¨ context æ›´æ–¹ä¾¿äº†</p>
<p>å½“ä½ æŠŠ Context ä¼ é€’ç»™å¤šä¸ª goroutine ä½¿ç”¨æ—¶ï¼Œåªè¦æ‰§è¡Œä¸€æ¬¡ cancel æ“ä½œï¼Œæ‰€æœ‰çš„ goroutine å°±å¯ä»¥æ”¶åˆ°
å–æ¶ˆçš„ä¿¡å·ï¼ŒContext æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥æ”¾å¿ƒåœ°åœ¨å¤šä¸ª goroutine ä¸­ä½¿ç”¨ã€‚</p>
<p>context åˆ›å»ºä¾èµ–äº 4 ä¸ªå‡½æ•°</p>
<ul>
<li>withCancel æœ€æ™®é€šï¼Œåªèƒ½ä½¿ç”¨ cancel å»ç»“æŸ</li>
<li>withDeadline å’Œ WithDeadline ä¼šåœ¨è¶…æ—¶åè‡ªåŠ¨ cancelï¼Œä¼ é€’çš„æ˜¯ç»å¯¹æ—¶é—´å’Œç›¸å¯¹æ—¶é—´</li>
<li>withValue èƒ½å¤Ÿæºå¸¦ä¸€äº›é”®å€¼å¯¹ (é”®åº”è¯¥æ˜¯å¯æ¯”çš„ï¼Œå€¼å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„)</li>
</ul>
<pre><code class="language-go">func WithCancel(parent Context) (ctx Context, cancel CancelFunc)
func WithDeadline(parent Context, deadline time.Time) (Context, CancelFunc)
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc)
func WithValue(parent Context, key, val interface{}) Context
</code></pre>
<pre><code class="language-go">func monitor(ctx context.Context, number int)  {
    for {
        select {
        case &lt;- ctx.Done():
            fmt.Printf(&quot;ç›‘æ§å™¨%vï¼Œç›‘æ§ç»“æŸã€‚\n&quot;, number)
            return
        default:
            fmt.Printf(&quot;ç›‘æ§å™¨%vï¼Œæ­£åœ¨ç›‘æ§ä¸­...\n&quot;, number)
            time.Sleep(2 * time.Second)
        }
    }
}

func main() {
    ctx01, cancel := context.WithCancel(context.Background())
    ctx02, cancel := context.WithDeadline(ctx01, time.Now().Add(1 * time.Second))

    defer cancel()

    for i :=1 ; i &lt;= 5; i++ {
        go monitor(ctx02, i)
    }

    time.Sleep(5  * time.Second)
    if ctx02.Err() != nil {
        fmt.Println(&quot;ç›‘æ§å™¨å–æ¶ˆçš„åŸå› ï¼š&quot;, ctx02.Err())
    }

    fmt.Println(&quot;ä¸»ç¨‹åºé€€å‡ºï¼ï¼&quot;)
}
</code></pre>
<h2 id="å‚è€ƒ-1"><a class="header" href="#å‚è€ƒ-1">å‚è€ƒ</a></h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651439981&amp;idx=4&amp;sn=b1ad1fd6e9ddf4618b0db904b067f7f6&amp;scene=19#wechat_redirect">2020 é‡å­¦ Go ç³»åˆ—ï¼š34. å›¾è§£é™æ€ç±»å‹ä¸åŠ¨æ€ç±»å‹</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åç¨‹ä¸å¼‚æ­¥"><a class="header" href="#åç¨‹ä¸å¼‚æ­¥">åç¨‹ä¸å¼‚æ­¥</a></h1>
<h2 id="åç¨‹çš„-c-å®ç°"><a class="header" href="#åç¨‹çš„-c-å®ç°">åç¨‹çš„ C å®ç°</a></h2>
<p><a href="https://github.com/xiaobing94/coroutine">C è¯­è¨€åç¨‹çš„ç®€å•å®ç°</a></p>
<p>linux
ä¸‹åœ¨å¤´æ–‡ä»¶<code>ucontext.h</code>æä¾›äº†<code>getcontext(),setcontext(),makecontext(),swapcontext()</code>å››ä¸ªå‡½æ•°å’Œ<code>mcontext_t å’Œ ucontext_t</code>ç»“æ„ä½“ã€‚</p>
<p>è¿™ 4 ä¸ªå‡½æ•°èƒ½å¤Ÿå®ç°ä¿å­˜ï¼Œè·å–ï¼Œè®¾ç½®ï¼Œåˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œæ˜¯åç¨‹å®ç°çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ yield çš„æ ¸å¿ƒ</p>
<p>ç»“æ„ä½“åˆ™ä¿ç•™äº†åç¨‹çš„ idï¼Œè¿è¡Œå †æ ˆç­‰ä¿¡æ¯</p>
<ul>
<li>
<p>ä¸åŒåç¨‹ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­ï¼Œç”±ä¸€ä¸ªè°ƒåº¦å™¨è¿›è¡Œæ¨è¿›å„ä¸ªåç¨‹</p>
</li>
<li>
<p>è°ƒåº¦å™¨ä¼šä¾æ¬¡æ‰§è¡Œæ¯ä¸ªåç¨‹ï¼Œæ¯å½“æŸä¸€ä¸ªåç¨‹è¿›è¡Œäº† yield æ“ä½œ (<code>swapcontext()</code>), è°ƒåº¦å™¨å°±ä¼šåˆ‡æ¢åˆ°å¦ä¸€ä¸ªåç¨‹çš„ä¸Šä¸‹æ–‡ï¼Œç»§ç»­æ¨è¿›</p>
</li>
<li>
<p>å½“æ‰€æœ‰åç¨‹éƒ½æ‰§è¡Œå®Œæˆï¼Œå°±ç»“æŸ</p>
</li>
</ul>
<p>ä¸‹é¢çš„å›¾ç‰‡æ˜¯é˜…è¯»äº†ä¸Šé¢ä»£ç åçš„æ•´ç†
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203262211252.png" alt="" /></p>
<h2 id="reactor-æœºåˆ¶"><a class="header" href="#reactor-æœºåˆ¶">Reactor æœºåˆ¶</a></h2>
<h1 id="å¼‚æ­¥"><a class="header" href="#å¼‚æ­¥">å¼‚æ­¥</a></h1>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122110854.png" alt="" />
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122111319.png" alt="" />
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122112837.png" alt="" />
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122112604.png" alt="" />
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122112493.png" alt="" />
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205122112531.png" alt="" /></p>
<h2 id="rust-å¼‚æ­¥åŸç†"><a class="header" href="#rust-å¼‚æ­¥åŸç†">Rust å¼‚æ­¥åŸç†</a></h2>
<h3 id="future-ç‰¹å¾"><a class="header" href="#future-ç‰¹å¾">Future ç‰¹å¾</a></h3>
<pre><code class="language-rs">trait Future {
    type Output;
    fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context)
        -&gt; Poll&lt;Self::Output&gt;;
}

enum Poll&lt;T&gt; {
    Pending,
    Ready(T),
}
</code></pre>
<h3 id="ç¼–è¯‘å¼‚æ­¥ä»£ç æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ"><a class="header" href="#ç¼–è¯‘å¼‚æ­¥ä»£ç æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ">ç¼–è¯‘å¼‚æ­¥ä»£ç æ—¶å‘ç”Ÿäº†ä»€ä¹ˆ</a></h3>
<p>ä¸‹é¢æ˜¯ä¸€æ®µå¼‚æ­¥ä»£ç ï¼Œå®ƒå‘ server å¼‚æ­¥è¯·æ±‚äº†ä¸€æ®µæ•°æ®ï¼Œæ¥ç€æŠŠç»“æœè¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œæœ€åå°†æ•°æ®é€šè¿‡ stream å¼‚æ­¥å‘é€å‡ºå»ï¼š</p>
<pre><code class="language-rs">async fn handle_request(
    server: &amp;RpcServer,
    mut stream: TcpStream,
    id: i32,
) -&gt; impl Future&lt;Output = ()&gt; {
    let row = get_row(&amp;server, id).await;

    let encoded = json::encode(&amp;row);

    stream.write_all(encoded.as_bytes()).await;
}
</code></pre>
<p>ç¼–è¯‘å™¨ä¼šä¸ºä¸ºè¿™ä¸ªå¼‚æ­¥å‡½æ•°åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œèƒ½å¤Ÿè¡¨ç°å½“å‰å¼‚æ­¥æ“ä½œçš„çŠ¶æ€ï¼š</p>
<pre><code class="language-rs">struct RequestHandler {
    server: &amp;RpcServer,
    stream: TcpStream,
    id: i32,
}
</code></pre>
<p>æ¥ç€éœ€è¦ä¸ºå®ƒå®ç° Future ç‰¹å¾</p>
<p>åœ¨ poll æ–¹æ³•å†…éƒ¨å°±æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæ¯æ¬¡è°ƒç”¨ poll å°±ä¼šå°è¯•æ¨è¿›å¼‚æ­¥ä»»åŠ¡ï¼Œå¹¶æ ¹æ®çŠ¶æ€ä½œå‡ºå¯¹åº”çš„æ´»åŠ¨</p>
<pre><code class="language-rs">impl Future for RequestHandler {
    type Output = ();
    fn poll(&amp;mut self, cx: &amp;mut Context) -&gt; Pool&lt;()&gt; {
        loop {
            match self.state {
                ...
            }
        }
    }
}
</code></pre>
<h3 id="çŠ¶æ€æœº"><a class="header" href="#çŠ¶æ€æœº">çŠ¶æ€æœº</a></h3>
<p>ç°åœ¨æˆ‘ä»¬è¦ä¸ºå®ƒæ‰‹åŠ¨ç¼–å†™ä¸€ä¸ªçŠ¶æ€æœº</p>
<p>é¦–å…ˆä¸ºäº†èƒ½å¤Ÿè·Ÿè¸ªè¯·æ±‚çš„çŠ¶æ€ï¼Œæˆ‘ä»¬è¦ä¸ºç»“æ„ä½“æ·»åŠ ä¸€ä¸ª state å­—æ®µï¼š</p>
<pre><code class="language-rs">struct RequestHandler {
    ...
    state: RHState
}
</code></pre>
<p>æ¥ç€ match çŠ¶æ€ï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„è¡Œä¸ºã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ªçŠ¶æ€æ˜¯ <code>Unpolled</code>ï¼Œæ­¤æ—¶è¿™ä¸ªå¼‚æ­¥å‡½æ•°è¿˜æ²¡æœ‰è¢« poll è¿‡ï¼Œå®ƒè¦è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œ</li>
<li>ç¬¬äºŒä¸ªçŠ¶æ€æ˜¯ <code>GettingRow</code>ï¼Œæˆ‘ä»¬ç­‰å¾…ä»æ•°æ®åº“è·å–æ•°æ®</li>
<li>ç¬¬ä¸‰ä¸ªçŠ¶æ€æ˜¯ <code>Writing</code>ï¼Œç­‰å¾…å†™å…¥ tcpstream</li>
<li>ç¬¬å››ä¸ªçŠ¶æ€æ˜¯ <code>Ready</code>ï¼Œå®Œæˆå¹¶å‡†å¤‡è¿”å›ç»“æœ</li>
</ul>
<h4 id="unpolled"><a class="header" href="#unpolled">Unpolled</a></h4>
<p>æˆ‘ä»¬é¦–å…ˆè°ƒç”¨ get_row å‡½æ•°ï¼Œå› ä¸ºå®ƒæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª future å¯¹è±¡ã€‚</p>
<pre><code class="language-rs">match self.state {
    Unpolled =&gt; {
        self.row_fut = Some(get_row(&amp;self.server, self.id));
        self.state = GettingRow
    }
}
</code></pre>
<p>åŒæ—¶æˆ‘ä»¬åœ¨ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ªå­—æ®µä¿å­˜è¿™ä¸ª future</p>
<pre><code class="language-rs">struct RequestHandler {
    ...
    row_fut: Option&lt;RowGet&gt;,
}
</code></pre>
<h4 id="gettingrow"><a class="header" href="#gettingrow">GettingRow</a></h4>
<p>ç¬¬äºŒé˜¶æ®µæˆ‘ä»¬å°±è¦å¼€å§‹å°è¯•æ¨è¿›å¼‚æ­¥ä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡å®Œæˆçš„è¯å°±æŠŠéœ€è¦çš„å˜é‡èµ‹å€¼åˆ°ç»“æ„ä½“ï¼Œå¹¶åˆå§‹åŒ–ä¸‹ä¸€ä¸ª future ä»»åŠ¡ï¼Œæ¨è¿›çŠ¶æ€ã€‚</p>
<pre><code class="language-rs">match self.state {
    ...
    GettingRow =&gt; {
        match self.row_fut.unwrap().poll(cx) {
            Poll::Pending =&gt; return Poll::Pending,
            Poll::Ready(row) =&gt; {
                self.row_fut = None;
                self.encoded = json::encode(row);
                self.write_fut = Some(self.stream.write_all(
                    self.encoded.as_bytes()));
                self.state = Writing;
            }
        }
    }
}
</code></pre>
<p>ç»“æ„ä½“éœ€è¦æ·»åŠ  encoded å­—æ®µï¼Œå’Œä¸‹ä¸€ä¸ª future ä»»åŠ¡ï¼š</p>
<pre><code class="language-rs">struct RequestHandler {
    ...
    encoded: String,
    write_fut: Option&lt;WriteAll&gt;,
}
</code></pre>
<h4 id="writing"><a class="header" href="#writing">Writing</a></h4>
<p>ç¬¬ä¸‰é˜¶æ®µä»»åŠ¡å¾ˆç®€å•ï¼Œå¦‚æœå†™å…¥å®Œæˆå°±æ¨è¿›çŠ¶æ€ï¼š</p>
<pre><code class="language-rs">match self.state {
    ...
    Writing =&gt; {
        match self.row_fut.unwrap().poll(cx) {
            Poll::Pending =&gt; return Poll::Pending,
            Poll::Ready(_) =&gt; self.state = Ready,
        }
    }
}
</code></pre>
<h4 id="ready"><a class="header" href="#ready">Ready</a></h4>
<p>æœ€åå°±è¿”å›å¼‚æ­¥å‡½æ•°çœŸæ­£çš„çš„è¿è¡Œç»“æœ</p>
<pre><code class="language-rs">match self.state {
    ...
    Ready =&gt; return Poll::Ready(())
}
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204110021532.png" alt="" /></p>
<h3 id="ä½¿ç”¨-enum-èŠ‚çœå†…å­˜"><a class="header" href="#ä½¿ç”¨-enum-èŠ‚çœå†…å­˜">ä½¿ç”¨ enum èŠ‚çœå†…å­˜</a></h3>
<p>ä½¿ç”¨ struct ä¿å­˜å¼‚æ­¥ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä¸ºæ‰€æœ‰å˜é‡å’Œå¼‚æ­¥ä»»åŠ¡éƒ½æå‰åˆ†é…å¥½å†…å­˜ã€‚</p>
<p>ä¸‹å›¾æ˜¯è¿™ä¸ªç»“æ„ä½“çš„å†…å­˜å¸ƒå±€
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204110022570.png" alt="" />
å¦‚æœä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡ä¸ä¼šåŒæ—¶è¿è¡Œï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªé˜¶æ®µçš„å¼‚æ­¥ä»»åŠ¡åº”è¯¥èƒ½å¤Ÿå¤ç”¨åŒä¸€å—å†…å­˜ï¼Œå°±åƒä¸‹å›¾é‡Œé‚£æ ·ï¼š
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202204110025475.png" alt="" />
å‡è®¾å¼‚æ­¥ä»»åŠ¡é‡Œé¢è¿˜åµŒå¥—ç€å…¶ä»–çš„å¼‚æ­¥ä»»åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„ä½“å°±ä¼šå˜å¾—æ›´å¤§ï¼ŒåµŒå¥—å±‚çº§è¶Šæ·±ï¼Œå†…å­˜å ç”¨å°±è¶Šå¤§</p>
<h3 id="æ€§èƒ½"><a class="header" href="#æ€§èƒ½">æ€§èƒ½</a></h3>
<h4 id="drop"><a class="header" href="#drop">drop</a></h4>
<pre><code class="language-rs">async fn do_stuff(context: Arc&lt;Context&gt;) {
    info!(&quot;running foo with context {}&quot;, context);
    foo().await;
} // &lt;- std::mem::drop(context);
</code></pre>
<p>å¯¹äºä¸Šé¢çš„å¼‚æ­¥å‡½æ•°æœ‰ä¸€ä¸ªå°å°çš„æ€§èƒ½é—®é¢˜ï¼Œæ¯å½“ä¸€ä¸ªå˜é‡è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼ŒRust éƒ½ä¼šéšå¼çš„åœ¨å‡½æ•°æœ«å°¾æ’å…¥ dropï¼Œæ‰€ä»¥ç›´åˆ°å‡½æ•°è¿è¡Œç»“æŸ context
å˜é‡æ‰ä¼šè¢«é‡Šæ”¾ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨æ‰“å®Œæ—¥å¿—ä¹‹åå°±ä¸éœ€è¦ context äº†ï¼Œæ²¡å¿…è¦ç­‰åˆ° foo æ‰§è¡Œå®Œåœ¨é‡Šæ”¾æ‰ context</p>
<p>å…¶ä¸­ä¸€ä¸ªè§£å†³æ–¹æ³•æ—¶å°† context ç§»åŠ¨åˆ°å‡½æ•°çš„å†…éƒ¨ä½œç”¨åŸŸï¼š</p>
<pre><code class="language-rs">async fn do_stuff(context: Arc&lt;Context&gt;) {
    {
        let context = context;
        info!(&quot;running foo with context {}&quot;, context);
    } // &lt;- std::mem::drop(context);
    foo().await;
}
</code></pre>
<p>drop ä¼šè¢«ç§»åŠ¨åˆ°å†…éƒ¨ä½œç”¨åŸŸçš„æœ«å°¾ï¼Œä½†æ˜¯è¿™æ ·ä¾ç„¶ä¸å®Œç¾ã€‚future åœ¨è¢« poll ä¹‹å‰ä»€ä¹ˆéƒ½ä¸ä¼šåšï¼Œå‡½æ•°å¼€å§‹çš„ä»»ä½•ä¸€è¡Œéƒ½ä¸ä¼šæ‰§è¡Œï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰ poll
æ—¶æˆ‘ä»¬è¿˜æ˜¯ä¸€åªæŒæœ‰ç€ context å˜é‡ã€‚</p>
<p>è§£å†³é—®é¢˜çš„æœ€å¥½åŠæ³•å®é™…ä¸Šæ˜¯è„±ç³–ï¼š</p>
<pre><code class="language-rs">fn do_stuff(context: Arc&lt;Context&gt;) -&gt; impl Future&lt;Output = ()&gt; {
    info!(&quot;running foo with context {}&quot;, context);
    async {
        foo().await;
    }
}
</code></pre>
<p>è¿™æ · context æ ¹æœ¬å°±ä¸ä¼šè¢«ä¿å­˜åœ¨æˆ‘ä»¬çš„çŠ¶æ€æœºé‡Œï¼Œæˆ‘ä»¬ä¹Ÿæ°¸è¿œä¸ä¼šæŒæœ‰å¯¹ context çš„å¼•ç”¨</p>
<h4 id="å¤§æ•°æ®-1"><a class="header" href="#å¤§æ•°æ®-1">å¤§æ•°æ®</a></h4>
<p>å¦ä¸€ä¸ªæ³¨æ„çš„ç‚¹æ˜¯ï¼Œå½“ä½ åœ¨ await ä¸€ä¸ªéå¸¸å¤§çš„ä¸´æ—¶å˜é‡æˆ–è€…è¡¨è¾¾å¼</p>
<pre><code class="language-rs">struct Big([u8; 1024]);

impl Drop for Big { /* print &quot;GOODBYE&quot; */ }

async fn foo(x: usize) -&gt; usize { /* ... */ }

async fn bar() -&gt; usize {
    let result = foo(Big::new().0.len()).await;
    result
}
</code></pre>
<p>å¦‚æœä½ å°è¯•æ‰“å° bar çš„å¤§å°ï¼š</p>
<pre><code class="language-rs">fn main() {
    dng!(std::mem::size_of_val(&amp;bar())); // 1024
}
</code></pre>
<p>ç»“æœä¼šéå¸¸å¤§ï¼Œé‚£æ˜¯å› ä¸º Rust ä¼šåœ¨çŠ¶æ€æœºé‡Œæ’å…¥ Big çš„å‰¯æœ¬ã€‚åŸå› æ˜¯ åªè¦ä½ åœ¨è¯­å¥ä¸­åˆ›å»ºä¸´æ—¶å˜é‡ï¼Œéƒ½ä¼šåœ¨è¯­å¥çš„æœ€åè°ƒç”¨è¯¥ä¸´æ—¶å˜é‡çš„ <code>drop</code>
å‡½æ•°ã€‚å› æ­¤åœ¨ <code>.await</code> è¿è¡Œåï¼Œ<code>drop</code> å‡½æ•°é‡Œçš„æ‰“å°ä¼šæ‰§è¡Œã€‚</p>
<p>å¼‚æ­¥å‡½æ•°é‡Œçš„ä¸´æ—¶å˜é‡éƒ½ä¼šå­˜æ´»åˆ° <code>.await</code> ä¹‹åã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šè®©è·å– len å’Œ è°ƒç”¨ foo æ–¹æ³•ä¹‹é—´æ’å…¥ä¸€ä¸ªåˆ†å·</p>
<pre><code class="language-rs">async fn bar() -&gt; usize {
    let len = Big::new().0.len();
    let result = foo(len).await;
    result
}
</code></pre>
<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·ï¼š</p>
<pre><code class="language-rs">async fn bar() -&gt; usize {
    let fut = foo(Big::new().0.len());
    let result = fut.await;
    result
}
</code></pre>
<p>å› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦åœ¨çŠ¶æ€æœºä¸­ä¿å­˜ Big çš„å‰¯æœ¬ï¼Œæ‰€ä»¥ç°åœ¨ bar å°±å°çš„å¤šäº†ï¼š</p>
<pre><code class="language-rs">fn main() {
    dng!(std::mem::size_of_val(&amp;bar())); // 24
}
</code></pre>
<p>å¦‚æœä½ æ²¡æœ‰ä¸º Big å®ç° Dropï¼Œç¼–è¯‘å™¨åº”è¯¥ä¸ºæ­¤åšå‡ºä¸€äº›ä¼˜åŒ–ï¼Œä¸è¿‡è¿™ä¸ªç°åœ¨ä¸è°ˆ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="magic-1"><a class="header" href="#magic-1">magic</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è½¯ä»¶æ¶æ„"><a class="header" href="#è½¯ä»¶æ¶æ„">è½¯ä»¶æ¶æ„</a></h1>
<h2 id="å…­è¾¹å½¢æ¶æ„-1"><a class="header" href="#å…­è¾¹å½¢æ¶æ„-1">å…­è¾¹å½¢æ¶æ„</a></h2>
<p>å…­è¾¹å½¢æ¶æ„ï¼Œæ˜¯ä¸€ç§è½¯ä»¶è®¾è®¡æ¨¡å¼ã€‚ä¾ç…§è¿™ç§æ¶æ„åˆ›å»ºçš„ç¨‹åºï¼Œèƒ½å¤Ÿåœ¨æ²¡æœ‰ UI
æˆ–æ•°æ®åº“çš„æƒ…å†µä¸‹æ­£å¸¸å·¥ä½œã€‚æ‰€ä»¥å³ä½¿æ²¡æœ‰æ•°æ®åº“ä½ ä¾ç„¶å¯ä»¥è¿›è¡Œå¼€å‘å’Œè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œè€Œä¸”æ— éœ€å…¶ä»–ç”¨æˆ·å‚ä¸ã€‚</p>
<h3 id="ç«¯å£ä¸é€‚é…å™¨-2"><a class="header" href="#ç«¯å£ä¸é€‚é…å™¨-2">ç«¯å£ä¸é€‚é…å™¨</a></h3>
<p>å…­è¾¹å½¢æ¶æ„ä¹Ÿå«åšç«¯å£ä¸é€‚é…å™¨æ¶æ„ã€‚</p>
<p><img src="https://alistair.cockburn.us/wp-content/uploads/2018/02/Hexagonal-architecture-complex-example.gif" alt="" /></p>
<p>ä»€ä¹ˆæ˜¯ç«¯å£ï¼Ÿ</p>
<p>ç«¯å£æŒ‡çš„æ˜¯å…­è¾¹å½¢çš„è¾¹ï¼Œå±äºåº”ç”¨ç¨‹åºçš„å†…éƒ¨ï¼Œæ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å…¥å£å’Œå‡ºå£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œè¡¨ç¤ºè®¾å¤‡å¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ç”¨ä¾‹ã€‚åœ¨ Rust é‡Œå°±æ˜¯ç”±ä¸€ä¸ª
Traitï¼Œä»¥åŠä¸€äº› DTO ç»„æˆ</p>
<p>ä»€ä¹ˆæ˜¯é€‚é…å™¨ï¼Ÿ</p>
<p>é€‚é…å™¨å›´ç»•ç€ç«¯å£ç¼–å†™ï¼Œèƒ½å¤Ÿå°†è¾“å…¥è½¬åŒ–ä¸ºç¬¦åˆç«¯å£çš„ç±»å‹ï¼Œå¹¶æŠŠè¾“å…¥è½¬åŒ–ä¸ºç”¨ç”¨ç¨‹åºå†…éƒ¨çš„æ–¹æ³•è°ƒç”¨ã€‚æ¢å¥è¯è¯´å°±æ˜¯ <code>controller</code> æˆ–è€…æ˜¯å‘½ä»¤è¡Œä¸€æ¡å‘½ä»¤å¤„ç†å™¨ã€‚</p>
<p>å½“ä»»ä½•å¤–éƒ¨è®¾å¤‡ (æ¯”å¦‚ï¼šWEBï¼ŒAPPï¼Œç»ˆç«¯ï¼Œæµ‹è¯•...)
æƒ³è¦è®¿é—®è¾“å…¥ç«¯å£æ—¶ï¼Œé¦–å…ˆè¿™ä¸ªè¾“å…¥ä¼šè¢«è¯¥è®¾å¤‡å¯¹åº”çš„è¾“å…¥é€‚é…å™¨ï¼Œè½¬åŒ–ä¸ºç¬¦åˆè¦æ±‚çš„å¯ç”¨çš„æ–¹æ³•è°ƒç”¨ï¼Œæˆ–è€…æ˜¯æ¶ˆæ¯ï¼Œç„¶åå†ä¼ é€’ç»™æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚</p>
<p>å½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºéœ€è¦å‘å¤–å‘é€æ•°æ®æ—¶ï¼Œé¦–å…ˆå®ƒä¼šæŠŠæ•°æ®é€šè¿‡è¾“å‡ºç«¯å£ä¼ é€’ç»™è¾“å‡ºé€‚é…å™¨ï¼Œç„¶åå†ä¼ é€’ç»™è¾“å‡ºå¯¹è±¡ (æ¯”å¦‚ï¼šæ•°æ®åº“ï¼Œmockï¼ŒAPIï¼Œé‚®ä»¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—...)</p>
<p>å› æ­¤æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¤–éƒ¨æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚</p>
<h3 id="åº”ç”¨ç¨‹åºæ ¸å¿ƒ-2"><a class="header" href="#åº”ç”¨ç¨‹åºæ ¸å¿ƒ-2">åº”ç”¨ç¨‹åºæ ¸å¿ƒ</a></h3>
<p>ä½¿ç”¨å…­è¾¹å½¢æ¶æ„ä¹‹åï¼Œæˆ‘ä»¬åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒéƒ¨åˆ†é€šå¸¸è¢«ç§°ä½œåŸŸï¼ŒåŸŸä¸­æœ‰ä¸‰ä¸ªæ ¸æ¦‚å¿µï¼š</p>
<ul>
<li>å®ä½“ (Entities)ï¼šåªæ˜¯ç®€å•çš„å®šä¹‰äº†å¯¹è±¡ã€‚</li>
<li>äº¤äº’å™¨ (Interactors)ï¼šå®ç°å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœ¬æ–‡é‡Œæˆ‘ä»¬ä¼šå°†å…¶ç§°ä¸ºç”¨ä¾‹ Usecaseã€‚</li>
<li>å­˜å‚¨åº“ (Repositories)ï¼šåªå®šä¹‰äº†æ“ä½œå®ä½“çš„æ–¹æ³•ã€‚</li>
</ul>
<h3 id="ä¼˜ç‚¹-2"><a class="header" href="#ä¼˜ç‚¹-2">ä¼˜ç‚¹</a></h3>
<p>åœ¨ä¼ ç»Ÿçš„åˆ†å±‚æ¶æ„ä¸­ï¼Œåªèƒ½ä»ä¸Šå¾€ä¸‹è°ƒç”¨ã€‚</p>
<p>è€Œç°åœ¨æˆ‘ä»¬æŠŠæ¥å£ä¿ç•™åœ¨åŸŸä¸­ï¼ŒåŸŸä¸å†ä¾èµ–å¤–éƒ¨çš„å¤–éƒ¨å®ç°ã€‚ä¿è¯äº†å¤–éƒ¨è®¾å¤‡æ˜¯å¯æ›¿æ¢çš„ã€‚å½“ä¸šåŠ¡é€»è¾‘éœ€è¦ç”¨åˆ°æ•°æ®å­˜å‚¨æ—¶ï¼Œç›´æ¥è°ƒç”¨æŠ½è±¡æ¥å£å³å¯ã€‚</p>
<h3 id="å‚è€ƒ-2"><a class="header" href="#å‚è€ƒ-2">å‚è€ƒ</a></h3>
<ul>
<li><a href="https://alexis-lozano.com/hexagonal-architecture-in-rust-1/">Hexagonal architecture in Rust</a></li>
</ul>
<h2 id="å¹²å‡€æ¶æ„"><a class="header" href="#å¹²å‡€æ¶æ„">å¹²å‡€æ¶æ„</a></h2>
<p><em>The Clean Architecture</em></p>
<ul>
<li><a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">Uncle Bob åŸæ–‡</a>
æ–‡ç« ä¸å¤ªé•¿ï¼Œ</li>
<li>å¾ˆå¥½çš„ç¿»è¯‘ + æ€»ç»“</li>
</ul>
<h3 id="å‚è€ƒ-3"><a class="header" href="#å‚è€ƒ-3">å‚è€ƒ</a></h3>
<p><a href="https://blog.jaggerwang.net/clean-architecture-in-practice/">å¹²å‡€æ¶æ„æœ€ä½³å®è·µ</a>
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202061150405.png" alt="" /></p>
<h3 id="åˆ†å±‚æ¶æ„"><a class="header" href="#åˆ†å±‚æ¶æ„">åˆ†å±‚æ¶æ„</a></h3>
<p>èµ·å§‹å’Œä¸Šé¢çš„å·®ä¸å¤šï¼Œæ€è·¯éƒ½ä¸€æ ·ï¼Œä¸‰å±‚æ¶æ„åŸºæœ¬å¯¹åº”</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202061222034.png" alt="" /></p>
<ul>
<li>User Interface å±‚ï¼š
ç³»ç»Ÿå¯¹å¤–æš´éœ²çš„æ¥å£å±‚ (API) å±‚ã€‚ä¸»è¦åŠŸèƒ½æ˜¯æ¥æ”¶å¤–éƒ¨çš„è°ƒç”¨ï¼Œè°ƒç”¨åº•å±‚çš„æœåŠ¡ï¼Œç„¶åå°†åº•å±‚æœåŠ¡è¿”å›çš„æ•°æ®è¿”å›ç»™è°ƒç”¨è€…ã€‚è¿™ä¸€å±‚åªåŒ…å«å¯¹å¤–çš„ DTO å¯¹è±¡çš„å£°æ˜ï¼Œæ¥å£å£°æ˜ï¼ŒDTO å¯¹è±¡è½¬æ¢ï¼Œæ—¥å¿—æ‰“å°ç­‰ã€‚ä¸èƒ½åŒ…å«å› ä¸ºé€»è¾‘ã€‚</li>
<li>Application å±‚ï¼šå¯¹åº”åˆ°ç³»ç»Ÿç”¨ä¾‹å±‚ã€‚å®ƒæè¿°äº†æ•´ä¸ªç³»ç»Ÿçš„å…¨éƒ¨åŠŸèƒ½ï¼Œå®ƒæ˜¯å¯¹åº•å±‚é¢†åŸŸå±‚å¯¹è±¡çš„ç»„ç»‡å’Œç¼–æ’ï¼Œé€šè¿‡å¯¹é¢†åŸŸå±‚å¯¹è±¡çš„ç¼–æ’ï¼Œå®ç°äº†ç”¨ä¾‹ã€‚Application å±‚ä¸å®ç°ä¸šåŠ¡é€»è¾‘ï¼Œå®ƒåªå¯¹åº•å±‚çš„é¢†åŸŸå¯¹è±¡è¿›è¡Œç¼–æ’ä»¥å®ç°ç”¨ä¾‹ã€‚ä¸€èˆ¬åœ¨è¿™ä¸€å±‚é‡Œä½¿ç”¨ä»“å‚¨å¯¹æ•°æ®è¿›è¡Œè¯»å–å’Œä¿å­˜ã€‚äº‹åŠ¡å¤„ç†ä¸€èˆ¬ä¹Ÿåœ¨è¿™ä¸€å±‚ã€‚è¿™ä¸€å±‚ä¸»è¦åŒ…æ‹¬ Serviceï¼Œç”¨æ¥è°ƒç”¨ Domain å±‚çš„å¯¹è±¡å®Œæˆä¸€ä¸ªä¸šåŠ¡ã€‚è®¿é—®ç¬¬ä¸‰æ–¹çš„è¿œç¨‹è°ƒç”¨ä¸€èˆ¬ä¹Ÿæ˜¯åœ¨è¿™ä¸€å±‚ã€‚</li>
<li>Domain å±‚ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ã€‚åŒ…å«å®ä½“ã€å€¼å¯¹è±¡å’Œé¢†åŸŸæœåŠ¡ç­‰é¢†åŸŸå¯¹è±¡ç­‰ã€‚å®ç°æ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘ã€‚ä¸šåŠ¡é€»è¾‘å°±æ˜¯å­˜åœ¨äºé—®é¢˜åŸŸå³ä¸šåŠ¡é¢†åŸŸä¸­çš„å®ä½“ã€æ¦‚å¿µã€è§„åˆ™å’Œç­–ç•¥ç­‰ï¼Œä¸å…·ä½“çš„å®ç°æŠ€æœ¯æ— å…³ï¼Œä¸»è¦åŒ…å«ï¼š1ï¼‰ä¸šåŠ¡å®ä½“ï¼ˆé¢†åŸŸå¯¹è±¡ï¼‰ã€‚2ï¼‰ä¸šåŠ¡è§„åˆ™ï¼šä¾‹å¦‚å€Ÿè®°å¡å–æ¬¾æ•°é¢ä¸å¾—è¶…è¿‡è´¦æˆ·ä½™é¢ç­‰ç­‰ã€‚3) ä¸šåŠ¡ç­–ç•¥ï¼š
ä¾‹å¦‚æœºç¥¨é¢„è®¢çš„è¶…è®¢ç­–ç•¥ç­‰ã€‚4) å®Œæ•´æ€§çº¦æŸï¼š
ä¾‹å¦‚è´¦æˆ·çš„è´¦å·ä¸å¾—ä¸ºç©ºã€‚5ï¼‰ä¸šåŠ¡æµç¨‹ï¼šæ¯”å¦‚ï¼Œâ€ä¸‹å•â€œæ˜¯ä¸€ä¸ªä¸šåŠ¡æµç¨‹ï¼Œå®ƒåŒ…æ‹¬â€œç”¨æˆ·ç™»å½• - é€‰æ‹©å•†å“ - ç»“ç®— - ä¸‹è®¢å• - ä»˜æ¬¾â€è¿™ä¸€ç³»åˆ—çš„åŠ¨ä½œã€‚
Infrastructure å±‚ï¼šè´Ÿè´£æ‰€æœ‰çš„å¯¹å¤–çš„äº¤äº’ã€‚æ¯”å¦‚æ•°æ®åº“è®¿é—®å±‚å®ç°ï¼ŒRPC æ¥å£ï¼ŒMQ ç­‰ã€‚</li>
</ul>
<h3 id="ç›®å½•ç»“æ„"><a class="header" href="#ç›®å½•ç»“æ„">ç›®å½•ç»“æ„</a></h3>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®ä¾‹ç›®å½• (è¾ƒä¸Šé¢çš„ç»“æ„æœ‰ä¿®æ”¹)</p>
<pre><code>.
â”œâ”€â”€ adapter # é€‚é…å±‚
â”‚   â”œâ”€â”€ api # API äº¤äº’æ¥å£ï¼Œå°†ç”¨ä¾‹é€‚é…ä¸º Rest API                    # controller
â”‚   â”œâ”€â”€ dao # æ•°æ®åº“è®¿é—®ï¼Œå®ç° usecase/port/dao ä¸‹çš„æ¥å£             # dao_impl
â”‚   â””â”€â”€ usecase # ç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œå®ç° usecase/port/service ä¸‹çš„æ¥å£     # usecase_impl
â”‚   â”œâ”€â”€ cli # å‘½ä»¤è¡Œäº¤äº’æ¥å£ï¼Œå°†ç”¨ä¾‹é€‚é…ä¸ºå‘½ä»¤
â”‚   â”œâ”€â”€ gui # å›¾å½¢äº¤äº’æ¥å£ï¼Œå°†ç”¨ä¾‹é€‚é…ä¸ºå›¾å½¢ç•Œé¢æ“ä½œ
â”œâ”€â”€ entity # å®ä½“å±‚
â”‚   â”œâ”€â”€ ...
â”‚   â””â”€â”€ user # ç”¨æˆ·å®ä½“                                           # model/do
â””â”€â”€ usecase # ç”¨ä¾‹å±‚
    â”œâ”€â”€ ...
    â”œâ”€â”€ UserUsecases.java # ç”¨æˆ·æ¨¡å—ç›¸å…³ç”¨ä¾‹                       # usecase | dao
    â”œâ”€â”€ exception # ç”¨ä¾‹å±‚å¼‚å¸¸
    â””â”€â”€ port # ç”¨ä¾‹å±‚ä¾èµ–çš„å¤–éƒ¨æœåŠ¡æ¥å£å®šä¹‰
</code></pre>
<p>æˆ–è€…æŠ½å‡ºä¸€ä¸ª domain ä»£æ›¿ entity å’Œ usecase</p>
<pre><code>.
â”œâ”€â”€ api
â”‚   â”œâ”€â”€ user # åŒ…å« controllerï¼Œå®ç°äº† dao å’Œ usecase
â”‚   â”‚   â”œâ”€â”€ usecase
â”‚   â”‚   â”œâ”€â”€ dao # å¯æ›¿æ¢ï¼Œä¾‹å¦‚æä¾› mysqlï¼Œpostgra ç­‰ä¸åŒå®ç°
â”‚   â”‚   â””â”€â”€ handler
â”‚   â””â”€â”€ article
â”‚
â””â”€â”€ domain
    â””â”€â”€ user # åŒ…å«äº† model | usecase | dao
    â””â”€â”€ article
</code></pre>
<h3 id="å‚è€ƒ-4"><a class="header" href="#å‚è€ƒ-4">å‚è€ƒ</a></h3>
<ul>
<li><a href="https://blog.jaggerwang.net/clean-architecture-in-practice/">å¹²å‡€æ¶æ„æœ€ä½³å®è·µ</a></li>
<li><a href="https://github.com/bxcodec/go-clean-arch">go-clean-arch</a></li>
<li><a href="https://lailin.xyz/post/go-training-week4-project-layout.html">Go å·¥ç¨‹åŒ– (äºŒ) é¡¹ç›®ç›®å½•ç»“æ„</a></li>
<li><a href="https://go-kratos.dev/blog/go-project-layout/">Go å·¥ç¨‹åŒ– - Project Layout æœ€ä½³å®è·µ</a></li>
</ul>
<h2 id="å…³äº-dodtobo-ç­‰å¯¹è±¡çš„å…³ç³»å›¾è§£"><a class="header" href="#å…³äº-dodtobo-ç­‰å¯¹è±¡çš„å…³ç³»å›¾è§£">å…³äº DOï¼ŒDTOï¼ŒBO ç­‰å¯¹è±¡çš„å…³ç³»å›¾è§£</a></h2>
<h3 id="æ¦‚å¿µ"><a class="header" href="#æ¦‚å¿µ">æ¦‚å¿µ</a></h3>
<p>POJOï¼ˆPlain Ordinary Java Objectï¼‰ï¼šåœ¨æœ¬è§„çº¦ä¸­ï¼ŒPOJO ä¸“æŒ‡åªæœ‰ setter/getter/toString çš„ç®€å•ç±»ï¼ŒåŒ…æ‹¬
DO/DTO/BO/VO ç­‰ã€‚</p>
<blockquote>
<p>ã€å‚è€ƒã€‘åˆ†å±‚é¢†åŸŸæ¨¡å‹è§„çº¦ï¼šâ€”ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘è§„çº¦ã€‹</p>
</blockquote>
<ul>
<li>DOï¼ˆData Objectï¼‰ï¼šä¸æ•°æ®åº“è¡¨ç»“æ„ä¸€ä¸€å¯¹åº”ï¼Œé€šè¿‡ DAO å±‚å‘ä¸Šä¼ è¾“æ•°æ®æºå¯¹è±¡ã€‚</li>
<li>DTOï¼ˆData Transfer Objectï¼‰ï¼šæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ŒService æˆ– Manager å‘å¤–ä¼ è¾“çš„å¯¹è±¡ã€‚</li>
<li>BOï¼ˆBusiness Objectï¼‰ï¼šä¸šåŠ¡å¯¹è±¡ã€‚å¯ä»¥ç”± Service å±‚è¾“å‡ºçš„å°è£…ä¸šåŠ¡é€»è¾‘çš„å¯¹è±¡ã€‚</li>
<li>Queryï¼šæ•°æ®æŸ¥è¯¢å¯¹è±¡ï¼Œå„å±‚æ¥æ”¶ä¸Šå±‚çš„æŸ¥è¯¢è¯·æ±‚ã€‚é¢å¤–è§„å®šï¼šã€å¼ºåˆ¶ã€‘è¶…è¿‡ 2 ä¸ªå‚æ•°çš„æŸ¥è¯¢å°è£…ï¼Œç¦æ­¢ä½¿ç”¨ Map ç±»æ¥ä¼ è¾“ã€‚</li>
<li>VOï¼ˆView Objectï¼‰ï¼šæ˜¾ç¤ºå±‚å¯¹è±¡ï¼Œé€šå¸¸æ˜¯ Web å‘æ¨¡æ¿æ¸²æŸ“å¼•æ“å±‚ä¼ è¾“çš„å¯¹è±¡ã€‚</li>
</ul>
<h3 id="è¯´äººè¯å°±æ˜¯"><a class="header" href="#è¯´äººè¯å°±æ˜¯">è¯´äººè¯å°±æ˜¯</a></h3>
<ul>
<li>
<p>DAOï¼šå°è£…å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå¸¸è§„çš„å¢åˆ æ”¹æŸ¥ï¼ˆCRUD æ“ä½œï¼‰éƒ½é€šè¿‡ DAO æ¥å®ç°ã€‚</p>
</li>
<li>
<p>PO/DO: è·Ÿæ•°æ®åº“è¡¨æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸€ä¸ª PO/DO æ•°æ®æ˜¯è¡¨çš„ä¸€æ¡è®°å½•ã€‚PO / DO åªæ˜¯æ•°æ®çš„å¯¹è±¡ï¼Œä¸åŒ…å«ä»»ä½•çš„æ“ä½œã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå­¦ç”Ÿè¡¨æ˜¯
StudentDOï¼Œå¯¹å­¦ç”Ÿè¡¨çš„å¢åˆ æ”¹æŸ¥ç­‰æ“ä½œå°±æ˜¯ StudentDAOã€‚</p>
</li>
<li>
<p>DTOï¼š</p>
<ul>
<li>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç³»ç»Ÿä¹‹é—´å¯ä»¥é€šè¿‡ DTO
è¿›è¡Œæ•°æ®ä¼ è¾“ï¼›https://www.google.com/search?q=&amp;oq=DDD+%E5%92%8C+%E5%B9%B2%E5%87%80%E6%9E%B6%E6%9E%84%E7%9A%84%E5%8C%BA%E5%88%AB&amp;aqs=chrome..69i57.9554j0j1&amp;sourceid=chrome&amp;ie=UTF-8</li>
<li>DTO ä¹Ÿå¯ä»¥åœ¨åº”ç”¨å†…éƒ¨ï¼Œæ ¸å¿ƒå±‚å’Œåº”ç”¨å±‚ä¹‹é—´ä¼ é€’æ•°æ®ï¼ŒDTO åªæ˜¯ç®€å•çš„æ•°æ®ä¼ è¾“ï¼Œæ²¡æœ‰ä¸šåŠ¡é€»è¾‘çš„å¤„ç†ï¼›</li>
<li>æœ‰çš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¡¨æœ‰ 10 ä¸ªå­—æ®µï¼Œid(å”¯ä¸€ id)ã€version(ç‰ˆæœ¬å·)ï¼Œgmt_create(è®°å½•åˆ›å»ºæ—¶é—´) è¿™äº›å­—æ®µä¸éœ€è¦å¯¹å¤–æä¾›ï¼Œæ‰€ä»¥
DTO å¯ä»¥åªå–æœ‰å«ä¹‰çš„ä¸šåŠ¡å­—æ®µï¼ŒDO æ˜¯å’Œæ•°æ®åº“è®°å½•çš„ä¸€ä¸€æ˜ å°„ï¼Œä½†æ˜¯ DTO åªéœ€è¦æŒ‰ç…§ä¸šåŠ¡éœ€è¦å®šä¹‰éœ€è¦çš„å­—æ®µã€‚</li>
</ul>
</li>
<li>
<p>BO: åŒ…å« PO/DO å’Œ DAOï¼Œæœ‰ç‚¹ç±»ä¼¼äº domain(entity, usecase) çš„æ¦‚å¿µï¼ŒBO
ä¸»è¦ä½œç”¨æ˜¯æŠŠä¸šåŠ¡é€»è¾‘å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡å¯ä»¥åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªå…¶å®ƒçš„å¯¹è±¡ï¼Œè¿˜èƒ½å¤Ÿå®Œæˆ DO - DTO ä¹‹é—´çš„è½¬æ¢</p>
</li>
<li>
<p>VO: å¯¹åº”é¡µé¢æ˜¾ç¤ºï¼ˆweb é¡µé¢/ç§»åŠ¨ç«¯ H5/Native è§†å›¾ï¼‰çš„æ•°æ®å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒDTO ä¸­æ—¶é—´ Date æ ¼å¼ï¼Œæˆ–è€…æ˜¯
yyyyMMddHHmmss çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ VO éœ€è¦çš„æ˜¯å‰ç«¯å±•ç¤ºçš„æ ¼å¼ï¼Œéœ€è¦è½¬æˆâ€yyyy å¹´ MM æœˆ dd æœˆ&quot;ï¼›</p>
</li>
</ul>
<h3 id="å›¾è§£"><a class="header" href="#å›¾è§£">å›¾è§£</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202061126981.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="riscv"><a class="header" href="#riscv">riscv</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common"><a class="header" href="#common">common</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="pgsql"><a class="header" href="#pgsql">PgSQL</a></h1>
<h2 id="-2"><a class="header" href="#-2"></a></h2>
<h2 id="åŸºæœ¬ä½¿ç”¨"><a class="header" href="#åŸºæœ¬ä½¿ç”¨">åŸºæœ¬ä½¿ç”¨</a></h2>
<h3 id="version"><a class="header" href="#version">version()</a></h3>
<pre><code class="language-sql">SELECT version();
</code></pre>
<h3 id="current_date"><a class="header" href="#current_date">current_date</a></h3>
<pre><code class="language-sql">SELECT CURRENT_DATE;
</code></pre>
<h3 id="crud"><a class="header" href="#crud">CRUD</a></h3>
<pre><code class="language-sql">SELECT 2 + 2;

DROP TABLE IF EXISTS weather;

DROP TABLE IF EXISTS cities;

-- internal commands, starts with '\'
-- create table
-- smallint, real, double precision, char(N), varchar(N), date, time, timestamp, and interval, as well as other types of general utility and a rich set of geometric types.
CREATE TABLE weather (
  city varchar(80),
  temp_lo int, -- low temperature
  temp_hi int, -- high temperature
  prcp real, -- precipitation
  date date
);

CREATE TABLE cities (
  name varchar(80),
  location point
);

INSERT INTO cities VALUES ('San Francisco', '(-194.0, 53.0)');

INSERT INTO weather VALUES ('San Francisco', 46, 50, 0.25, '1994-11-27');

INSERT INTO weather (city, temp_lo, temp_hi, prcp, date) VALUES ('San Francisco', 43, 57, 0.0, '1994-11-29');

INSERT INTO weather (date, city, temp_hi, temp_lo) VALUES ('1994-11-29', 'Hayward', 54, 37);

SELECT * FROM weather;

SELECT
  city,
  temp_lo,
  temp_hi,
  prcp,
  date
FROM
  weather;
</code></pre>
<h3 id="-3"><a class="header" href="#-3"><code>/</code></a></h3>
<pre><code class="language-sql">SELECT
  city,
  (temp_hi + temp_lo) / 2 AS temp_avg,
  date
FROM
  weather;

</code></pre>
<h3 id="-4"><a class="header" href="#-4"><code>&gt;</code></a></h3>
<pre><code class="language-sql">SELECT
  *
FROM
  weather
WHERE
  city = 'San Francisco'
  AND prcp &gt; 0.0;
</code></pre>
<h3 id="order-by"><a class="header" href="#order-by">ORDER BY</a></h3>
<pre><code class="language-sql">SELECT
  *
FROM
  weather
ORDER BY
  city;

SELECT
  *
FROM
  weather
ORDER BY
  city,
  temp_lo;
</code></pre>
<h3 id="distinct"><a class="header" href="#distinct">DISTINCT</a></h3>
<pre><code class="language-sql">SELECT DISTINCT
  city
FROM
  weather;

SELECT DISTINCT
  city
FROM
  weather
ORDER BY
  city;
</code></pre>
<h3 id="where"><a class="header" href="#where">WHERE</a></h3>
<pre><code class="language-sql">SELECT
  *
FROM
  weather,
  cities
WHERE
  city = name;
</code></pre>
<h3 id="join"><a class="header" href="#join">JOIN</a></h3>
<pre><code class="language-sql">SELECT
  *
FROM
  weather
  JOIN cities ON city = name;
</code></pre>
<pre><code class="language-sql">SELECT
  weather.city,
  weather.temp_lo,
  weather.temp_hi,
  weather.prcp,
  weather.date,
  cities.location
FROM
  weather
  JOIN cities ON weather.city = cities.name;
</code></pre>
<h3 id="join-on"><a class="header" href="#join-on">JOIN ON</a></h3>
<pre><code class="language-sql">SELECT
  *
FROM
  weather
  LEFT OUTER JOIN cities ON weather.city = cities.name;
</code></pre>
<pre><code class="language-sql">SELECT
  w1.city,
  w1.temp_lo AS low,
  w1.temp_hi AS high,
  w2.city,
  w2.temp_lo AS low,
  w2.temp_hi AS high
FROM
  weather w1
  JOIN weather w2 ON w1.temp_lo &lt; w2.temp_lo
    AND w1.temp_hi &gt; w2.temp_hi;
</code></pre>
<pre><code class="language-sql">SELECT
  *
FROM
  weather w
  JOIN cities c ON w.city = c.name;
</code></pre>
<h3 id="max"><a class="header" href="#max">MAX</a></h3>
<p>ERROR:</p>
<pre><code class="language-sql">SELECT city FROM weather WHERE temp_lo = max(temp_lo);     WRONG
</code></pre>
<pre><code class="language-sql">SELECT
  max(temp_lo)
FROM
  weather;
</code></pre>
<pre><code class="language-sql">SELECT
  city
FROM
  weather
WHERE
  temp_lo = (
    SELECT
      max(temp_lo)
    FROM
      weather);
</code></pre>
<pre><code class="language-sql">SELECT
  city,
  max(temp_lo),
  count(*) FILTER (WHERE temp_lo &lt; 30)
FROM
  weather
WHERE
  city LIKE 'S%' -- (1)
GROUP BY
  city
HAVING
  max(temp_lo) &lt; 40;
</code></pre>
<h3 id="update"><a class="header" href="#update">UPDATE</a></h3>
<pre><code class="language-sql">-- update
UPDATE
  weather
SET
  temp_hi = temp_hi - 2,
  temp_lo = temp_lo - 2
WHERE
  date &gt; '1994-11-28';
</code></pre>
<h3 id="delete"><a class="header" href="#delete">DELETE</a></h3>
<pre><code class="language-sql">DELETE FROM weather
WHERE city = 'Hayward';
</code></pre>
<h2 id="é«˜çº§åŠŸèƒ½"><a class="header" href="#é«˜çº§åŠŸèƒ½">é«˜çº§åŠŸèƒ½</a></h2>
<h3 id="view"><a class="header" href="#view">VIEW</a></h3>
<p>å¤§é‡ä½¿ç”¨è§†å›¾æ˜¯è‰¯å¥½çš„ SQL æ•°æ®åº“è®¾è®¡çš„ä¸€ä¸ªå…³é”®æ–¹é¢ã€‚è§†å›¾å…è®¸å°†è¡¨çš„ç»“æ„ç»†èŠ‚å°è£…åœ¨ä¸€è‡´çš„æ¥å£åé¢ï¼Œè¿™äº›ç»†èŠ‚å¯èƒ½ä¼šéšç€åº”ç”¨ç¨‹åºçš„å‘å±•è€Œæ”¹å˜ã€‚</p>
<p>è§†å›¾å‡ ä¹å¯ä»¥ç”¨åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨çœŸå®è¡¨çš„åœ°æ–¹ã€‚åœ¨å…¶ä»–è§†å›¾ä¸Šå»ºç«‹è§†å›¾çš„æƒ…å†µå¹¶ä¸å°‘è§ã€‚</p>
<pre><code class="language-sql">CREATE VIEW myview AS
SELECT
  name,
  temp_lo,
  temp_hi,
  prcp,
  date,
  location
FROM
  weather,
  cities
WHERE
  city = name;
</code></pre>
<pre><code class="language-sql">SELECT
  *
FROM
  myview;
</code></pre>
<h3 id="copy"><a class="header" href="#copy">COPY</a></h3>
<pre><code class="language-sql">COPY weather
FROM
  '/home/user/weather.txt';
</code></pre>
<h3 id="foreign-key"><a class="header" href="#foreign-key">FOREIGN KEY</a></h3>
<p>å¤–é”®çš„è¡Œä¸ºå¯ä»¥æ ¹æ®ä½ çš„åº”ç”¨è¿›è¡Œç»†å¾®çš„è°ƒæ•´ã€‚</p>
<pre><code class="language-sql">CREATE TABLE cities (
        name     varchar(80) primary key,
        location point
);

CREATE TABLE weather (
        city      varchar(80) references cities(name),
        temp_lo   int,
        temp_hi   int,
        prcp      real,
        date      date
);
</code></pre>
<p>running</p>
<pre><code class="language-sql">INSERT INTO weather VALUES ('Berkeley', 45, 53, 0.0, '1994-11-28');
</code></pre>
<p>should be</p>
<pre><code class="language-txt">ERROR:  insert or update on table &quot;weather&quot; violates foreign key constraint &quot;weather_city_fkey&quot;
DETAIL:  Key (city)=(Berkeley) is not present in table &quot;cities&quot;.

</code></pre>
<h3 id="transactions"><a class="header" href="#transactions">Transactions</a></h3>
<pre><code class="language-sql">BEGIN;
UPDATE accounts SET balance = balance - 100.00 WHERE name = 'Alice';
SAVEPOINT my_savepoint;
UPDATE accounts SET balance = balance + 100.00 WHERE name = 'Bob';
-- oops ... forget that and use Wally's account
ROLLBACK TO my_savepoint;
UPDATE accounts SET balance = balance + 100.00 WHERE name = 'Wally';
COMMIT;
</code></pre>
<h3 id="window-functions"><a class="header" href="#window-functions">Window Functions</a></h3>
<h4 id="å¿«é€Ÿå¼€å§‹"><a class="header" href="#å¿«é€Ÿå¼€å§‹">å¿«é€Ÿå¼€å§‹</a></h4>
<p>æ±‚æ‰€åœ¨éƒ¨é—¨çš„å¹³å‡å·¥èµ„</p>
<pre><code class="language-sql">SELECT
  depname, empno, salary, avg(salary)
OVER (PARTITION BY depname)
FROM empsalary;
</code></pre>
<pre><code class="language-txt">  depname  | empno | salary |          avg
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)
</code></pre>
<p>æ¯ä¸ªéƒ¨é—¨çš„å·¥èµ„æ’åï¼š</p>
<pre><code class="language-sql">SELECT depname, empno, salary,
       rank() OVER (PARTITION BY depname ORDER BY salary DESC)
FROM empsalary;
</code></pre>
<p>rank å‡½æ•°ä¸ºå½“å‰è¡Œçš„åˆ†åŒºä¸­æ¯ä¸ªä¸åŒçš„ ORDER BY å€¼äº§ç”Ÿä¸€ä¸ªæ•°å­—ç­‰çº§ï¼Œä½¿ç”¨ ORDER BY å­å¥å®šä¹‰çš„é¡ºåºã€‚rank ä¸éœ€è¦æ˜ç¡®çš„å‚æ•°ï¼Œå› ä¸ºå…¶è¡Œä¸ºå®Œå…¨ç”± OVER å­å¥å†³å®šã€‚</p>
<pre><code class="language-txt">  depname  | empno | salary | rank
-----------+-------+--------+------
 develop   |     8 |   6000 |    1
 develop   |    10 |   5200 |    2
 develop   |    11 |   5200 |    2
 develop   |     9 |   4500 |    4
 develop   |     7 |   4200 |    5
 personnel |     2 |   3900 |    1
 personnel |     5 |   3500 |    2
 sales     |     1 |   5000 |    1
 sales     |     4 |   4800 |    2
 sales     |     3 |   4800 |    2
(10 rows)
</code></pre>
<h4 id="order-by-1"><a class="header" href="#order-by-1">ORDER BY</a></h4>
<p>ORDER BY</p>
<pre><code class="language-sql">SELECT salary, sum(salary) OVER () FROM empsalary;
</code></pre>
<pre><code class="language-txt"> salary |  sum
--------+-------
   5200 | 47100
   5000 | 47100
   3500 | 47100
   4800 | 47100
   3900 | 47100
   4200 | 47100
   4500 | 47100
   4800 | 47100
   6000 | 47100
   5200 | 47100
(10 rows)
</code></pre>
<pre><code class="language-sql">SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;
</code></pre>
<pre><code class="language-txt"> salary |  sum
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)
</code></pre>
<h4 id="ä¸èƒ½ä½¿ç”¨çš„æƒ…å†µ"><a class="header" href="#ä¸èƒ½ä½¿ç”¨çš„æƒ…å†µ">ä¸èƒ½ä½¿ç”¨çš„æƒ…å†µ</a></h4>
<p>çª—å£å‡½æ•°åªå…è®¸åœ¨æŸ¥è¯¢çš„ SELECT å’Œ ORDER BY å­å¥ä¸­ä½¿ç”¨ã€‚å…¶ä»–åœ°æ–¹ä¾‹å¦‚ GROUP BYã€HAVING å’Œ WHERE å­å¥ä¸­æ˜¯ç¦æ­¢çš„ã€‚</p>
<p>è¿™æ˜¯å› ä¸ºå®ƒä»¬åœ¨é€»è¾‘ä¸Šæ˜¯åœ¨è¿™äº›å­å¥çš„å¤„ç†ä¹‹åæ‰§è¡Œçš„ã€‚</p>
<p>å¦å¤–ï¼Œçª—å£å‡½æ•°åœ¨éçª—å£èšåˆå‡½æ•°ä¹‹åæ‰§è¡Œã€‚è¿™æ„å‘³ç€åœ¨ä¸€ä¸ªçª—å£å‡½æ•°çš„å‚æ•°ä¸­åŒ…å«ä¸€ä¸ªèšåˆå‡½æ•°çš„è°ƒç”¨æ˜¯æœ‰æ•ˆçš„ï¼Œä½†åä¹‹åˆ™æ— æ•ˆã€‚</p>
<p>å¦‚æœéœ€è¦åœ¨çª—å£è®¡ç®—æ‰§è¡Œåå¯¹è¡Œè¿›è¡Œè¿‡æ»¤æˆ–åˆ†ç»„ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå­é€‰æ‹©ã€‚ä¾‹å¦‚ã€‚</p>
<pre><code class="language-sql">SELECT depname, empno, salary, enroll_date
FROM
  (SELECT depname, empno, salary, enroll_date,
          rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos
     FROM empsalary
  ) AS ss
WHERE pos &lt; 3;
</code></pre>
<h4 id="å¤šä¸ªçª—å£å‡½æ•°"><a class="header" href="#å¤šä¸ªçª—å£å‡½æ•°">å¤šä¸ªçª—å£å‡½æ•°</a></h4>
<p>ä¸Šè¿°æŸ¥è¯¢åªæ˜¾ç¤ºå†…éƒ¨æŸ¥è¯¢ä¸­æ’åå°äº 3 çš„è®°å½•ã€‚</p>
<p>å½“ä¸€ä¸ªæŸ¥è¯¢æ¶‰åŠåˆ°å¤šä¸ªçª—å£å‡½æ•°æ—¶ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªå•ç‹¬çš„ OVER å­å¥æ¥å†™å‡ºæ¯ä¸€ä¸ªçª—å£å‡½æ•°ã€‚</p>
<p>ä½†æ˜¯å¦‚æœå‡ ä¸ªå‡½æ•°éœ€è¦ç›¸åŒçš„çª—å£è¡Œä¸ºï¼Œè¿™æ ·åšæ˜¯é‡å¤å’Œå®¹æ˜“å‡ºé”™çš„ã€‚</p>
<p>ç›¸åï¼Œå¯ä»¥åœ¨ WINDOW å­å¥ä¸­å‘½åæ¯ä¸ªçª—å£è¡Œä¸ºï¼Œç„¶ååœ¨ OVER ä¸­å¼•ç”¨ã€‚æ¯”å¦‚è¯´ã€‚</p>
<pre><code class="language-sql">SELECT sum(salary) OVER w, avg(salary) OVER w
  FROM empsalary
  WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);
</code></pre>
<h3 id="inheritance-ç»§æ‰¿"><a class="header" href="#inheritance-ç»§æ‰¿">Inheritance ç»§æ‰¿</a></h3>
<p>åˆ›å»ºä¸¤ä¸ªè¡¨ã€‚ä¸€å¼ åŸå¸‚è¡¨å’Œä¸€å¼ é¦–éƒ½è¡¨ã€‚å½“ç„¶ï¼Œé¦–éƒ½ä¹Ÿæ˜¯åŸå¸‚ï¼Œ</p>
<p>æˆ‘ä»¬å¸Œæœ›åœ¨åˆ—å‡ºæ‰€æœ‰åŸå¸‚æ—¶ï¼Œèƒ½ä»¥éšå«çš„æ–¹å¼æ˜¾ç¤ºé¦–éƒ½ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¤‡é€‰æ–¹æ¡ˆã€‚</p>
<p>ä½¿ç”¨è§†å›¾å®ç°ï¼š</p>
<pre><code class="language-sql">CREATE TABLE capitals (
  name       text,
  population real,
  elevation  int,    -- (in ft)
  state      char(2)
);

CREATE TABLE non_capitals (
  name       text,
  population real,
  elevation  int     -- (in ft)
);

CREATE VIEW cities AS
  SELECT name, population, elevation FROM capitals
    UNION
  SELECT name, population, elevation FROM non_capitals;
</code></pre>
<p>ä½¿ç”¨ç»§æ‰¿å®ç°ï¼š</p>
<p>åœ¨ PostgreSQL ä¸­ï¼Œä¸€ä¸ªè¡¨å¯ä»¥ä»é›¶ä¸ªæˆ–å¤šä¸ªå…¶ä»–è¡¨ç»§æ‰¿ã€‚</p>
<pre><code class="language-sql">CREATE TABLE cities (
  name       text,
  population real,
  elevation  int     -- (in ft)
);

CREATE TABLE capitals (
  state      char(2) UNIQUE NOT NULL
) INHERITS (cities);
</code></pre>
<p>capitals ç»§æ‰¿äº†åŸå¸‚çš„æ‰€æœ‰åˆ—ï¼ˆåç§°ã€äººå£å’Œæµ·æ‹”ï¼‰ã€‚capitals è¡¨æœ‰ä¸€ä¸ªé¢å¤–çš„åˆ—ï¼Œstateã€‚</p>
<blockquote>
<p>name åˆ—çš„ç±»å‹æ˜¯ textï¼Œè¿™æ˜¯ PostgreSQL çš„åŸç”Ÿç±»å‹ï¼Œç”¨äºå¯å˜é•¿åº¦çš„å­—ç¬¦ä¸²ã€‚</p>
</blockquote>
<p>ç»§æ‰¿ä¼šè‡ªåŠ¨ä»å­è¡¨ä¸­æŸ¥è¯¢</p>
<pre><code class="language-sql">SELECT name, elevation
  FROM cities
  WHERE elevation &gt; 500;
</code></pre>
<p>ä½ å¯ä»¥ä½¿ç”¨ ONLY é¿å…è‡ªåŠ¨æŸ¥è¯¢</p>
<pre><code class="language-sql">SELECT name, elevation
    FROM ONLY cities
    WHERE elevation &gt; 500;
</code></pre>
<h2 id="sql-è¯­è¨€"><a class="header" href="#sql-è¯­è¨€">SQL è¯­è¨€</a></h2>
<h3 id="å¸¸é‡"><a class="header" href="#å¸¸é‡">å¸¸é‡</a></h3>
<ul>
<li>å­—ç¬¦ä¸²ï¼Œç”¨å•å¼•å·</li>
</ul>
<p>ä¸¤ä¸ªä»…ç”±è‡³å°‘ä¸€ä¸ªæ¢è¡Œçš„ç©ºç™½å¤„éš”å¼€çš„å­—ç¬¦ä¸²å¸¸é‡è¢«è¿æ¥èµ·æ¥ï¼Œå¹¶æœ‰æ•ˆåœ°å¤„ç†ï¼Œå°±åƒå­—ç¬¦ä¸²è¢«å†™æˆä¸€ä¸ªå¸¸é‡ä¸€æ ·ã€‚æ¯”å¦‚è¯´</p>
<pre><code class="language-sql">SELECT 'foo'
'bar';
</code></pre>
<p>å’Œ</p>
<pre><code class="language-sql">SELECT 'foobar';
</code></pre>
<p>ç›¸ç­‰</p>
<p>ä½†æ˜¯</p>
<pre><code class="language-sql">SELECT 'foo'      'bar';
</code></pre>
<p>æ˜¯ä¸åˆæ³•çš„</p>
<p>g</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="git"><a class="header" href="#git">Git</a></h1>
<h2 id="è¿œç¨‹ä»“åº“"><a class="header" href="#è¿œç¨‹ä»“åº“">è¿œç¨‹ä»“åº“</a></h2>
<h3 id="æœ¬åœ°åˆ›å»ºè¿œç¨‹ä»“åº“"><a class="header" href="#æœ¬åœ°åˆ›å»ºè¿œç¨‹ä»“åº“">æœ¬åœ°åˆ›å»ºè¿œç¨‹ä»“åº“</a></h3>
<p><a href="https://hub.github.com/">hub-git å‘½ä»¤è¡Œæ’ä»¶</a></p>
<pre><code>hub create
</code></pre>
<h3 id="æ·»åŠ è¿œç¨‹ä»“åº“"><a class="header" href="#æ·»åŠ è¿œç¨‹ä»“åº“">æ·»åŠ è¿œç¨‹ä»“åº“</a></h3>
<pre><code>git remote add origin(è¿œç¨‹ä»“åº“åï¼Œéšæ„) git@github.com:trdthg/trdthg.github.io.git
</code></pre>
<h3 id="è¿½è¸ªè¿œç¨‹åˆ†æ”¯"><a class="header" href="#è¿½è¸ªè¿œç¨‹åˆ†æ”¯">è¿½è¸ªè¿œç¨‹åˆ†æ”¯</a></h3>
<pre><code>æœ¬åœ°åˆ†æ”¯åå¯çœç•¥ï¼Œé»˜è®¤ä¸ºå½“å‰åˆ†æ”¯
git branch -u origin/remote_branch_name  &lt;local_branch_name&gt;

åˆ›å»ºåˆ†æ”¯æ—¶è¿½è¸ª
git checkout -b local_branch_name --track origin/remote_branch_name

-u é€‰é¡¹æ˜¯--set-upstream-to çš„ç®€å†™
git branch --set-upstream-to=origin/remote_branch_name  local_branch_name
</code></pre>
<h2 id="åˆ†æ”¯"><a class="header" href="#åˆ†æ”¯">åˆ†æ”¯</a></h2>
<h3 id="åˆ é™¤è¿œç¨‹åˆ†æ”¯"><a class="header" href="#åˆ é™¤è¿œç¨‹åˆ†æ”¯">åˆ é™¤è¿œç¨‹åˆ†æ”¯</a></h3>
<pre><code>git push origin --delete xxx
</code></pre>
<h3 id="åˆ é™¤æœ¬åœ°åˆ†æ”¯"><a class="header" href="#åˆ é™¤æœ¬åœ°åˆ†æ”¯">åˆ é™¤æœ¬åœ°åˆ†æ”¯</a></h3>
<pre><code>git branch -d xxx
git branch -D xxx
</code></pre>
<h3 id="ç¼“å­˜å½“å‰ä¿®æ”¹"><a class="header" href="#ç¼“å­˜å½“å‰ä¿®æ”¹">ç¼“å­˜å½“å‰ä¿®æ”¹</a></h3>
<pre><code>git stash

git stash list

git stash pop
</code></pre>
<h2 id="ä»“åº“ç®¡ç†"><a class="header" href="#ä»“åº“ç®¡ç†">ä»“åº“ç®¡ç†</a></h2>
<h3 id="æ‹†åˆ†ä»“åº“"><a class="header" href="#æ‹†åˆ†ä»“åº“">æ‹†åˆ†ä»“åº“</a></h3>
<ol>
<li>å°† src/locale ç›®å½•æ‹†åˆ†åˆ°ä¸€ä¸ªæ–°åˆ†æ”¯é‡Œ</li>
</ol>
<pre><code>git subtree split -P src/locale -b my-locale
</code></pre>
<blockquote>
<p>å¿…é¡»ä»ä»“åº“æ ¹ç›®å½•ä¸‹æ‰§è¡Œ</p>
</blockquote>
<ol start="2">
<li>ä»å¦ä¸€ä¸ªä»“åº“é‡Œæ‹‰å–ä¸Šé¢çš„åˆ†æ”¯</li>
</ol>
<pre><code>cd ..
mkdir repo
cd repo
git init

git pull ../dayjs my-locale
</code></pre>
<h2 id="æ‰“æ ‡ç­¾"><a class="header" href="#æ‰“æ ‡ç­¾">æ‰“æ ‡ç­¾</a></h2>
<h3 id="å…±äº«æ ‡ç­¾"><a class="header" href="#å…±äº«æ ‡ç­¾">å…±äº«æ ‡ç­¾</a></h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œgit push å‘½ä»¤å¹¶ä¸ä¼šä¼ é€æ ‡ç­¾åˆ°è¿œç¨‹ä»“åº“æœåŠ¡å™¨ä¸Šã€‚åœ¨åˆ›å»ºå®Œæ ‡ç­¾åä½ å¿…é¡»æ˜¾å¼åœ°æ¨é€æ ‡ç­¾åˆ°å…±äº«æœåŠ¡å™¨ä¸Šã€‚
è¿™ä¸ªè¿‡ç¨‹å°±åƒå…±äº«è¿œç¨‹åˆ†æ”¯ä¸€æ ·â€”â€”ä½ å¯ä»¥è¿è¡Œ git push origin tagnameã€‚</p>
<pre><code>git push origin v1.5
</code></pre>
<p>å¦‚æœæƒ³è¦ä¸€æ¬¡æ€§æ¨é€å¾ˆå¤šæ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¸¦æœ‰ --tags é€‰é¡¹çš„ git push å‘½ä»¤ã€‚è¿™å°†ä¼šæŠŠæ‰€æœ‰ä¸åœ¨è¿œç¨‹ä»“åº“æœåŠ¡å™¨ä¸Šçš„æ ‡ç­¾å…¨éƒ¨ä¼ é€åˆ°é‚£é‡Œã€‚</p>
<pre><code>git push origin --tags
</code></pre>
<h3 id="åˆ›å»ºæ ‡ç­¾"><a class="header" href="#åˆ›å»ºæ ‡ç­¾">åˆ›å»ºæ ‡ç­¾</a></h3>
<p>Git æ”¯æŒä¸¤ç§æ ‡ç­¾ï¼šè½»é‡æ ‡ç­¾ï¼ˆlightweightï¼‰ä¸é™„æ³¨æ ‡ç­¾ï¼ˆannotatedï¼‰ã€‚</p>
<pre><code>é™„æ³¨æ ‡ç­¾
åœ¨ Git ä¸­åˆ›å»ºé™„æ³¨æ ‡ç­¾ååˆ†ç®€å•ã€‚ æœ€ç®€å•çš„æ–¹å¼æ˜¯å½“ä½ åœ¨è¿è¡Œ tag å‘½ä»¤æ—¶æŒ‡å®š -a é€‰é¡¹
-m é€‰é¡¹æŒ‡å®šäº†ä¸€æ¡å°†ä¼šå­˜å‚¨åœ¨æ ‡ç­¾ä¸­çš„ä¿¡æ¯ã€‚

git tag -a v1.4 -m &quot;my version 1.4&quot;

è½»é‡æ ‡ç­¾
å¦ä¸€ç§ç»™æäº¤æ‰“æ ‡ç­¾çš„æ–¹å¼æ˜¯ä½¿ç”¨è½»é‡æ ‡ç­¾ã€‚ è½»é‡æ ‡ç­¾æœ¬è´¨ä¸Šæ˜¯å°†æäº¤æ ¡éªŒå’Œå­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­â€”â€”æ²¡æœ‰ä¿å­˜ä»»ä½•å…¶ä»–ä¿¡æ¯ã€‚ åˆ›å»ºè½»é‡æ ‡ç­¾ï¼Œä¸éœ€è¦ä½¿ç”¨ -aã€-s æˆ– -m é€‰é¡¹ï¼Œåªéœ€è¦æä¾›æ ‡ç­¾åå­—ï¼š

git tag v1.4-lw
</code></pre>
<h3 id="å¿˜è®°æ‰“æ ‡ç­¾"><a class="header" href="#å¿˜è®°æ‰“æ ‡ç­¾">å¿˜è®°æ‰“æ ‡ç­¾ï¼Ÿ</a></h3>
<p>åŠ ä¸Šåˆ†æ”¯å³å¯</p>
<pre><code>git tag -a v1.2 9fceb02
</code></pre>
<h3 id="åˆ é™¤æ ‡ç­¾"><a class="header" href="#åˆ é™¤æ ‡ç­¾">åˆ é™¤æ ‡ç­¾</a></h3>
<pre><code>git tag -d v1.4-lw
</code></pre>
<h2 id="git-hook"><a class="header" href="#git-hook">git hook</a></h2>
<p>git hook çš„æ‰€æœ‰ç±»å‹éƒ½åœ¨<code>.git/hooks</code>æ–‡ä»¶å¤¹ä¸‹</p>
<pre><code>applypatch-msg.sample      post-update.sample     pre-merge-commit.sample    pre-rebase.sample        update.sample
commit-msg.sample          pre-applypatch.sample  prepare-commit-msg.sample  pre-receive.sample
fsmonitor-watchman.sample  pre-commit.sample      pre-push.sample            push-to-checkout.sample
</code></pre>
<p>ä¸è¿‡ä¸€èˆ¬å¯ä»¥ä½¿ç”¨ <a href="https://github.com/typicode/husky">husky</a> è¿™ä¸ªæ’ä»¶å»å…·ä½“ä½¿ç”¨</p>
<h3 id="å®‰è£…"><a class="header" href="#å®‰è£…">å®‰è£…</a></h3>
<p>npm install husky -D</p>
<h3 id="ç”Ÿæˆ-husky-é…ç½®æ–‡ä»¶å¤¹"><a class="header" href="#ç”Ÿæˆ-husky-é…ç½®æ–‡ä»¶å¤¹">ç”Ÿæˆ ./husky é…ç½®æ–‡ä»¶å¤¹</a></h3>
<pre><code>npm set-script prepare &quot;husky install&quot;
npm run prepare
</code></pre>
<h3 id="add-a-hook"><a class="header" href="#add-a-hook">Add a hook:</a></h3>
<p>ä¸‹é¢å¯ä»¥ç›´æ¥æŠŠè¦æ‰§è¡Œçš„è„šæœ¬å†™åœ¨ <code>./husky/pre-commit</code> ä¸­</p>
<pre><code>npx husky add .husky/pre-commit &quot;npm test&quot;
git add .husky/pre-commit
</code></pre>
<h3 id="æµ‹è¯•"><a class="header" href="#æµ‹è¯•">æµ‹è¯•ï¼š</a></h3>
<pre><code>git commit -m &quot;Keep calm and commi
</code></pre>
<h2 id="gitignore"><a class="header" href="#gitignore">.gitignore</a></h2>
<h3 id="åŸºæœ¬è§„åˆ™"><a class="header" href="#åŸºæœ¬è§„åˆ™">åŸºæœ¬è§„åˆ™</a></h3>
<pre><code>.idea/          # å¿½ç•¥ä»“åº“ä¸­æ‰€æœ‰.idea (ç›®å½•)
/.idea/         # å¿½ç•¥ä»“åº“ä¸­ (æ ¹) ç›®å½•ä¸‹çš„.idea (ç›®å½•)
/.settings      # å¿½ç•¥ä»“åº“ä¸­ (æ ¹) ç›®å½•ä¸‹çš„ .settings (æ–‡ä»¶æˆ–ç›®å½•)
~'$'*.docx      # office æ‰“å¼€æ—¶ç”Ÿæˆçš„ (ä¸´æ—¶æ–‡ä»¶)

!etc/eclipse/.checkstyle    # (ä¸å¿½ç•¥) .checkstyle æ–‡ä»¶æˆ–ç›®å½•
</code></pre>
<h3 id="glob-æ¨¡å¼-æ­£åˆ™"><a class="header" href="#glob-æ¨¡å¼-æ­£åˆ™">glob æ¨¡å¼ (æ­£åˆ™)</a></h3>
<pre><code>doc/*.txt           # å¿½ç•¥ doc ç›®å½•ä¸‹ä¸€çº§çš„æ‰€æœ‰ (ä»¥ `.txt` ç»“å°¾) çš„ (æ–‡ä»¶æˆ–ç›®å½•)
doc/**/*.pdf        # å¿½ç•¥ doc (ç›®å½•ä¸‹æ‰€æœ‰çš„) .pdf æ–‡ä»¶æˆ–ç›®å½•

debug?.log          # å¿½ç•¥ debug?.log æ–‡ä»¶æˆ–ç›®å½•ï¼Œå…¶ä¸­ ? ä¸ºä»»æ„ä¸€ä¸ªå­—ç¬¦

debug[0-9].log      # å¿½ç•¥ debug0.logã€debug2.log ç­‰ï¼Œä½†ä¸å¿½ç•¥ debuga.log æ–‡ä»¶
debug[01].log       # ä»…å¿½ç•¥ debug0.logã€debug1.log
debug[!01].log      # ä¸å¿½ç•¥ debug0.logã€debug1.log
</code></pre>
<h3 id="ç‰¹æ€§-1"><a class="header" href="#ç‰¹æ€§-1">ç‰¹æ€§</a></h3>
<ul>
<li>ä»ä¸Šåˆ°ä¸‹ï¼Œåé¢è¦†ç›–å‰é¢çš„</li>
<li>ä»¥ä¸Šè§„åˆ™ä»…é€‚ç”¨äºæœªè¢«ç¼“å­˜æˆ–åŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶ å¦‚æœå¿½ç•¥å¤±æ•ˆï¼Œå¯ä»¥å°è¯•
<pre><code>.gitignore åªèƒ½å¿½ç•¥é‚£äº›åŸæ¥æ²¡æœ‰è¢« track çš„æ–‡ä»¶ï¼Œå¦‚æœæŸäº›æ–‡ä»¶å·²ç»è¢«çº³å…¥äº†ç‰ˆæœ¬ç®¡ç†ä¸­ï¼Œåˆ™ä¿®æ”¹.gitignore æ˜¯æ— æ•ˆçš„ã€‚
é‚£ä¹ˆè§£å†³æ–¹æ³•å°±æ˜¯å…ˆæŠŠæœ¬åœ°ç¼“å­˜åˆ é™¤ï¼ˆæ”¹å˜æˆæœª track çŠ¶æ€ï¼‰ï¼Œç„¶åå†æäº¤ã€‚

git rm -r --cached .

git add .
git commit -m 'update .gitignore'
</code></pre>
</li>
</ul>
<h2 id="å…¶ä»–-5"><a class="header" href="#å…¶ä»–-5">å…¶ä»–</a></h2>
<h3 id="pull"><a class="header" href="#pull">pull</a></h3>
<p><a href="https://www.runoob.com/git/git-pull.html">èœé¸Ÿ</a> git pull å…¶å®å°±æ˜¯ git fetch å’Œ git
merge FETCH_HEAD çš„ç®€å†™ã€‚å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre><code>git pull &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;è¿œç¨‹åˆ†æ”¯å&gt;:&lt;æœ¬åœ°åˆ†æ”¯å&gt;
</code></pre>
<h3 id="amend"><a class="header" href="#amend">amend</a></h3>
<p>è¦†ç›–æœ€è¿‘ä¸€æ¬¡ commit ä¿¡æ¯</p>
<pre><code>git commit --amend  -m &quot;:bug: Fix: xxx&quot; -s
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-ä¸å¸¸ç”¨å‘½ä»¤"><a class="header" href="#linux-ä¸å¸¸ç”¨å‘½ä»¤">Linux ä¸å¸¸ç”¨å‘½ä»¤</a></h1>
<ol>
<li><code>command &amp;</code> è®©è¿›ç¨‹åœ¨åå°è¿è¡Œï¼Œæ¯”å¦‚ï¼š<code>sleep 1000 &amp;</code></li>
<li>jobs æŸ¥çœ‹åå°è¿è¡Œçš„è¿›ç¨‹</li>
<li>fg %n è®©åå°è¿è¡Œçš„è¿›ç¨‹ n åˆ°å‰å°æ¥</li>
<li>bg %n è®©è¿›ç¨‹ n åˆ°åå°å»ï¼›</li>
</ol>
<h1 id="errno"><a class="header" href="#errno">errno</a></h1>
<p>å½“ç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·é˜»æ–­æ—¶ä¼šè¿”å› EINTRï¼Œä¸ºäº†é‡æ–°æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ä½ å¯ä»¥ä½¿ç”¨ while å¾ªç¯åˆ¤æ–­ errno ä¸ç­‰äº EINTRï¼Œæˆ–è€…æ˜¯ä¸ºä¿¡å·æŒ‡å®š SA_RESTARTï¼Œä½¿ç³»ç»Ÿè°ƒç”¨å¯ä»¥è‡ªåŠ¨é‡æ–°è¿è¡Œï¼Œä½†æ˜¯å¯¹æŸä¸€äº›ç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨æ²¡æœ‰å½±å“</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ•°æ®ç»“æ„"><a class="header" href="#æ•°æ®ç»“æ„">æ•°æ®ç»“æ„</a></h1>
<h2 id="äºŒå‰æœç´¢æ ‘"><a class="header" href="#äºŒå‰æœç´¢æ ‘">äºŒå‰æœç´¢æ ‘</a></h2>
<h3 id="åˆå§‹åŒ–-1"><a class="header" href="#åˆå§‹åŒ–-1">åˆå§‹åŒ–</a></h3>
<pre><code class="language-cpp">typedef struct Node {
    int data;
    struct Node* left;
    struct Node* right;
} Node;

typedef struct Tree {
    int init;
    int length;
    Node* root;
} Tree;

Node* initNode() {
    Node* p = (Node*)malloc(sizeof(Node));
    p -&gt; left = NULL;
    p -&gt; right = NULL;
    p -&gt; data = 0;
    return p;
}

Tree* initTree() {
    Tree* p = (Tree*)malloc(sizeof(Tree));
    p-&gt;root = initNode();
    p-&gt;init = 0;
    return p;
}
</code></pre>
<h3 id="éå†"><a class="header" href="#éå†">éå†</a></h3>
<pre><code class="language-cpp">void preorderTraversal(Node* node) {
    if (node != NULL) {
        printf(&quot;%d &quot;, node-&gt;data);
        preorderTraversal(node-&gt;left);
        preorderTraversal(node-&gt;right);
    }
}

void inorderTraversal(Node* node) {
    if (node != NULL) {
        inorderTraversal(node-&gt;left);
        printf(&quot;%d &quot;, node-&gt;data);
        inorderTraversal(node-&gt;right);
    }
}

void postorderTraversal(Node* node) {
    if (node != NULL) {
        postorderTraversal(node-&gt;left);
        postorderTraversal(node-&gt;right);
        printf(&quot;%d &quot;, node-&gt;data);
    }
}

void levalorderTraversal(Tree* tree) {
    printf(&quot;%d\n&quot;, tree-&gt;length);
    int arr[100];
    int i=0, j=0; // i è®°å½•å·²ç»åŠ å…¥çš„å…ƒç´ æ•°ï¼Œj è®°å½•æœ€åè¾“å‡ºçš„èŠ‚ç‚¹
    int size = 1; // è®°å½•å®é™…å…ƒç´ ä¸ªæ•°
    Node* nodes[100] = {NULL};
    Node* node = tree-&gt;root;
    nodes[0] = node;
    while (size &gt; 0) {
        printf(&quot;%d &quot;, nodes[j]-&gt;data);
        printf(&quot;%d  &quot;, node-&gt;data);
        j += 1;
        size -= 1;
        if (node-&gt;left != NULL)  {
            i += 1;
            nodes[i] = node-&gt;left;
            size += 1;
        }
        if (node-&gt;right != NULL) {
            i += 1;
            nodes[i] = node-&gt;right;
            size += 1;
        }
        node = nodes[j];
    }
}
</code></pre>
<h3 id="crud-1"><a class="header" href="#crud-1">CRUD</a></h3>
<pre><code class="language-cpp">#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;


Node* add(Tree* tree, int data) {
    Node* current = tree-&gt;root;
    Node* parent;
    tree-&gt;length += 1;
    if (tree-&gt;init == 0) {
        tree-&gt;init = 1;
        tree-&gt;root-&gt;data = data;
    } else {
        Node* node = initNode();
        node-&gt;data = data;
        while (1) {
            parent = current;
            if (data &lt;= current-&gt;data) {
                current = current-&gt;left;
                if (current == NULL) {
                    parent-&gt;left = node;
                    break;
                }
            } else {
                current = current-&gt;right;
                if (current == NULL) {
                    parent-&gt;right = node;
                    break;
                }
            }
        }
    }
    return 0;
}


Node* findMax(Node* node) {
    if (node-&gt;right != NULL) {
        findMax(node-&gt;right);
    } else {
        return node;
    }
}


Node* findMin(Node* node) {
    if (node-&gt;left != NULL) {
        findMax(node-&gt;left);
    } else {
        return node;
    }
}

int find(Node* node, int data) {
    if (node != NULL) {
        if (node-&gt;data == data) return node-&gt;data;
        else if (data &lt; node-&gt;data) find(node-&gt;left, data);
        else find(node-&gt;right, data);
    } else {
        return -1;
    }
}

int delete(Node* root, Node* node, int data) {
    Node* parent = node;
    // if (node == root &amp;&amp; data == root-&gt;data) {
    //     return 0;
    // }
    if (node != NULL &amp;&amp; node != root) {
        if (data &lt; node-&gt;data) {
            node = node-&gt;left;
        } else {
            node = node-&gt;right;
        }
    }
    if (data == node-&gt;data) {
        if (node-&gt;left == NULL &amp;&amp; node-&gt;right == NULL) {
            if (data &lt;= parent-&gt;data) parent-&gt;left = NULL; else parent-&gt;right = NULL;
        } else if (node-&gt;left == NULL) {
            if (data &gt; parent-&gt;data) parent-&gt;right = node-&gt;right; else parent-&gt;left = node-&gt;right;
        } else if (node-&gt;right == NULL) {
            if (data &lt; parent-&gt;data) parent-&gt;left = node-&gt;left; else parent-&gt;right = node-&gt;left;
        } else {
            Node* innerparent = node;
            Node* innernode = node-&gt;right;
            while (innernode-&gt;left != NULL) {
                innerparent = innernode;
                innernode = node-&gt;left;
            }
            node-&gt;data = innernode-&gt;data;
            if (innerparent == node) {
                node-&gt;right = innernode-&gt;right;
            } else {
                innerparent-&gt;left = NULL;
            }
        }
        return 1;
    } else if (data &lt; node-&gt;data) {
        delete(root, node, data);
    } else {
        delete(root, node, data);
    }
}
</code></pre>
<h3 id="ç¤ºä¾‹-1"><a class="header" href="#ç¤ºä¾‹-1">ç¤ºä¾‹</a></h3>
<pre><code class="language-cpp">int main(void) {
    Tree* tree = initTree();
    add(tree, 8);
    add(tree, 10);
    add(tree, 5);
    add(tree, 42);
    add(tree, 6);
    add(tree, 3);
    add(tree, 2);
    add(tree, 4);
    add(tree, 7);
    preorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    inorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    postorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    levalorderTraversal(tree);
    printf(&quot;\n&quot;);
    printf(&quot;max: %d min: %d\n&quot;, findMax(tree-&gt;root)-&gt;data, findMin(tree-&gt;root)-&gt;data);
    printf(&quot;find 3: %d \n&quot;, find(tree-&gt;root, 3));
    printf(&quot;delete: %d \n&quot;, delete(tree-&gt;root, tree-&gt;root, 8));
    preorderTraversal(tree-&gt;root);
    return 0;
}
</code></pre>
<h2 id="avl-æ ‘-è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘"><a class="header" href="#avl-æ ‘-è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘">AVL æ ‘ (è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘)</a></h2>
<h3 id="åˆå§‹åŒ–-2"><a class="header" href="#åˆå§‹åŒ–-2">åˆå§‹åŒ–</a></h3>
<p>åŒäºŒå‰æœç´¢æ ‘ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª height å±æ€§</p>
<pre><code class="language-cpp">Node* initNode() {
    Node* p = (Node*)malloc(sizeof(Node));
    p-&gt;left = NULL;
    p-&gt;right = NULL;
    p-&gt;value = 0;
    p-&gt;height = 1;
    return p;
}
Tree* initTree() {
    Tree* p = (Tree*)malloc(sizeof(Tree));
    p-&gt;root = initNode();
    p-&gt;init = 0;
    p-&gt;length = 0;
    return p;
}
Node* addCheck(Tree* tree, int value) {
    if (tree-&gt;init == 0) {
        tree-&gt;init = 1;
        tree-&gt;root-&gt;value = value;
        return tree-&gt;root;
    } else {
        return add(tree-&gt;root, value);
    }
}
void removeChect(Tree* tree, int value) {
    if (tree-&gt;init == 0) {
    } else {
        removeNode(tree-&gt;root, value);
    }
}
</code></pre>
<h3 id="æ—‹è½¬"><a class="header" href="#æ—‹è½¬">æ—‹è½¬</a></h3>
<ol>
<li>å³æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* RightRotation(Node* node) {
    Node* res = node-&gt;left;
    node-&gt;left = node-&gt;left-&gt;right;
    res-&gt;right = node;
    node-&gt;height = getHeight(node);
    res-&gt;height = getHeight(res);
    return res;
}
</code></pre>
<ol start="2">
<li>å·¦æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* LeftRotation(Node* node) {
    Node* res = node-&gt;right;
    node-&gt;right = node-&gt;right-&gt;left;
    res-&gt;left = node;
    node-&gt;height = getHeight(node);
    // res-&gt;height = getHeight(res);
    return res;
}
</code></pre>
<p>::: warning æ³¨æ„ å…ˆæ—‹çš„èŠ‚ç‚¹æ˜¯ node çš„å­èŠ‚ç‚¹ï¼Œä¸æ˜¯ node æœ¬èº« ::: 3. å…ˆå·¦åå³</p>
<pre><code class="language-cpp">Node* LeftRightRotation(Node* node) {
    node-&gt;left = LeftRotation(node-&gt;left);
    return RightRotation(node);
}
</code></pre>
<ol start="4">
<li>å…ˆå³åå·¦</li>
</ol>
<pre><code class="language-cpp">Node* RightLeftRotation(Node* node) {
    node-&gt;right = RightRotation(node-&gt;right);
    return LeftRotation(node);
}
</code></pre>
<h3 id="add"><a class="header" href="#add">add</a></h3>
<p><strong>æ³¨æ„äº‹é¡¹</strong></p>
<ol>
<li>ç›¸å¯¹äºæ™®é€šçš„äºŒå‰æœç´¢æ ‘ï¼ŒAVL æ ‘è¦è®°å½•å¹¶æ›´æ–° heightï¼Œå¿…é¡»ç”¨é€’å½’æ‰èƒ½åœ¨æ·»åŠ èŠ‚ç‚¹åé‡å›è€è·¯ï¼Œæ›´æ–°èµ°è¿‡çš„çš„èŠ‚ç‚¹</li>
<li>åœ¨åˆ¤æ–­æ˜¯å¦å¹³è¡¡æ—¶éœ€è¦ç¡®ä¿ height åŠæ—¶è¢«æ›´æ–°</li>
<li>åˆ¤æ–­æ—‹è½¬æ–¹å¼çš„æ¡ä»¶</li>
</ol>
<pre><code class="language-cpp">Node* add(Node* node, int value) {
    if (node == NULL) {
        Node* newNode = initNode();
        newNode-&gt;value = value;
        return newNode;
    } else if (value &lt; node-&gt;value) {
        node-&gt;left = add(node-&gt;left, value);
        node-&gt;height = getHeight(node);
        if (getBalanceFactor(node) == 2) {
            if (value &lt; node-&gt;left-&gt;value) {
                node = RightRotation(node);
            } else {
                node = LeftRightRotation(node);
            }
        }
    } else {
        node-&gt;right  = add(node-&gt;right, value);
        node-&gt;height = getHeight(node);
        if (getBalanceFactor(node) == -2) {
            if (value &lt; node-&gt;right-&gt;value) {
                node = LeftRotation(node);
            } else {
                node = RightLeftRotation(node);
            }
        }
    }
    node-&gt;height = getHeight(node);
    return node;
}
</code></pre>
<h3 id="remove-1"><a class="header" href="#remove-1">remove</a></h3>
<p><strong>æ³¨æ„äº‹é¡¹</strong> 4. æ³¨æ„æ—‹è½¬æ¡ä»¶</p>
<pre><code class="language-cpp">Node* removeNode(Node* node, int value) {
    if (node == NULL) {
        return NULL;
    }
    if (value == node-&gt;value) {
        if (node-&gt;left == NULL &amp;&amp; node-&gt;right == NULL) {
            return NULL;
        } else if (node-&gt;right == NULL) {
            return node-&gt;left;
        } else if (node-&gt;left == NULL) {
            return node-&gt;right;
        } else {
            Node* newNode = reHeightRight(node-&gt;right);
            node-&gt;value = newNode-&gt;value;
            node-&gt;right = newNode-&gt;right;
        }
    } else if (value &lt; node-&gt;value) {
        node-&gt;left = removeNode(node-&gt;left, value);
        node-&gt;height = getHeight(node);
        if (getBalanceFactor(node) == -2) {
            if (getHeight(node-&gt;left) &gt; 0) {
                node = RightRotation(node);
            } else {
                node = RightLeftRotation(node);
            }
        }
    } else {
        node-&gt;right = removeNode(node-&gt;right, value);
        node-&gt;height = getHeight(node);
        if (getBalanceFactor(node) == 2) {
            if (getHeight(node-&gt;left) &gt; 0) {
                node = LeftRightRotation(node);
            } else {
                node = LeftRotation(node);
            }
        }
    }
    node-&gt;height = getHeight(node);
}
</code></pre>
<h3 id="å·¥å…·æ–¹æ³•"><a class="header" href="#å·¥å…·æ–¹æ³•">å·¥å…·æ–¹æ³•</a></h3>
<ol>
<li>getHeight</li>
</ol>
<pre><code class="language-cpp">int getHeight(Node* node) {
    if (node == NULL) {
        return 0;
    }
    int hl, hr;
    if (node-&gt;left == NULL) {
        hl = 0;
    } else {
        hl = node-&gt;left-&gt;height;
    }
    if (node-&gt;right == NULL) {
        hr = 0;
    } else {
        hr = node-&gt;right-&gt;height;
    }
    return 1 + max(hl, hr);
}
</code></pre>
<ol start="2">
<li>reHeight é…åˆ remove ä½¿ç”¨ï¼Œä¿è¯å½“æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹çš„ node è¢« remove åï¼Œnode.right çš„ min è¢«åˆ é™¤åï¼Œ
node.right çš„ height è¢«æ›´æ–°</li>
</ol>
<pre><code class="language-cpp">Node* reHeightRight(Node* node) {
    Node* parent = node;
    if (node-&gt;left != NULL) {
        node = node-&gt;left;
        Node* newNode = reHeightRight(node);
        node-&gt;height = getHeight(node);
        return newNode;
    } else {
        return node;
    }
}
</code></pre>
<ol start="3">
<li>getBalanceFactor è·å–å¹³è¡¡å› å­</li>
</ol>
<pre><code class="language-cpp">int getBalanceFactor(Node* node) {
    // è·å–å¹³è¡¡å› å­ (å·¦å­æ ‘ - å³å­æ ‘ï¼Œæ³¨æ„ä¿ç•™è´Ÿå·)
    if (node == NULL) {
        return 0;
    }
    int a = getHeight(node-&gt;left) - getHeight(node-&gt;right);
    return a;
}
</code></pre>
<h3 id="å·²çŸ¥é—®é¢˜"><a class="header" href="#å·²çŸ¥é—®é¢˜">å·²çŸ¥é—®é¢˜</a></h3>
<ol>
<li>æ—‹è½¬æ¡ä»¶æœ‰å¾…ç¡®è®¤</li>
<li>å½“æ ¹èŠ‚ç‚¹è¢«æ—‹è½¬æ—¶ï¼Œtree.root æ— æ³•åŠæ—¶æ›´æ–° å·²è§£å†³ï¼šremove æ–¹æ³•å¤šä¼ ä¸€ä¸ª Tree* treeï¼Œåˆ¤æ–­ node==tree-&gt;root,
å¦‚æœæ˜¯ï¼Œåˆ™ tree-&gt;root = temp</li>
</ol>
<pre><code class="language-cpp">if (getBalanceFactor(node) == 2) {
    Node* temp = NULL;
    if (getHeight(node-&gt;left) &gt; 0) {
        temp = LeftRightRotation(node);
    } else {
        temp = LeftRotation(node);
    }
    if (node == tree-&gt;root) {
        tree-&gt;root = temp;
    } else {
        node = temp;
    }
}
</code></pre>
<h2 id="çº¢é»‘æ ‘"><a class="header" href="#çº¢é»‘æ ‘">çº¢é»‘æ ‘</a></h2>
<p>::: tip å»ºè®® ä¸å»ºè®®ç”¨é€’å½’ï¼Œå»ºè®®ç”¨ while å¾ªç¯å®ç°ï¼Œä¸æ˜¯é¡ºåºå›é€€ï¼Œè€Œæ˜¯è·³è¿çš„ :::
<img src="https://rbtree.phpisfuture.com/" alt="çº¢é»‘æ ‘åœ¨çº¿æ¼”ç¤º" /></p>
<h3 id="ç¬¬äºŒç‰ˆ"><a class="header" href="#ç¬¬äºŒç‰ˆ">ç¬¬äºŒç‰ˆ</a></h3>
<h3 id="åˆå§‹åŒ–-3"><a class="header" href="#åˆå§‹åŒ–-3">åˆå§‹åŒ–</a></h3>
<pre><code class="language-cpp">typedef struct Node {
    int key;
    int value;
    int color; // çº¢ä¸º 1ï¼Œé»‘ä¸º 0
    struct Node* parent;
    struct Node* left;
    struct Node* right;
} Node;

typedef struct Tree {
    int init;
    Node* root;
} Tree;

void preorderTraversal(Node* node) {
    if (node != NULL) {
        printf(&quot;%d %s &quot;, node-&gt;value, node-&gt;color ? &quot;r&quot; : &quot;b&quot;);
        preorderTraversal(node-&gt;left);
        preorderTraversal(node-&gt;right);
    }
}

Node* initNode() {
    Node* p = (Node*)malloc(sizeof(Node));
    p-&gt;key = 0;
    p-&gt;value = 0;
    p-&gt;color = red;
    p-&gt;parent = NULL;
    p-&gt;left = NULL;
    p-&gt;right = NULL;
    return p;
}

Tree* initTree() {
    Tree* p = (Tree*)malloc(sizeof(Tree));
    p-&gt;root = initNode();
    p-&gt;init = 0;
    return p;
}
</code></pre>
<h3 id="æ—‹è½¬-1"><a class="header" href="#æ—‹è½¬-1">æ—‹è½¬</a></h3>
<p>::: tip æ³¨æ„ å·¦/å³æ—‹ä¸å˜è‰²æ˜¯åˆ†å¼€çš„ï¼Œè¿™é‡Œåªæœ‰æ—‹è½¬ï¼Œå˜è‰²éœ€è¦åœ¨è°ƒç”¨å‰å®ç° å·¦å³/å³å·¦æ—‹çš„ç¬¬ä¸€æ¬¡ä¸éœ€è¦å˜è‰²ï¼Œç¬¬äºŒæ¬¡æ—‹è½¬å‰çš„å˜è‰²å·²ç»åµŒå…¥ä¸¤æ¬¡æ—‹è½¬ä¹‹é—´
:::</p>
<ol>
<li>å³æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* RightRotation(Node* node, Tree* tree) {
    Node* res = node-&gt;left;
    node-&gt;left = res-&gt;right;
    if (res-&gt;right != NULL)
        res-&gt;right-&gt;parent = node;
    res-&gt;right = node;
    res-&gt;parent = node-&gt;parent;
    if (node-&gt;parent == NULL) {
        tree-&gt;root = res;
    } else {
        if (node-&gt;parent-&gt;left == node)
            node-&gt;parent-&gt;left = res;
        else
            node-&gt;parent-&gt;right = res;
    }
    node-&gt;parent = res;
    // if (node == tree-&gt;root) {
    //     tree-&gt;root = res;
    // }
    return res;
}
</code></pre>
<ol start="2">
<li>å·¦æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* LeftRotation(Node* node, Tree* tree) {
    Node* res = node-&gt;right;
    node-&gt;right = res-&gt;left;
    if (res-&gt;left != NULL)
        res-&gt;left-&gt;parent = node;
    res-&gt;left = node;
    res-&gt;parent = node-&gt;parent;
    if (node-&gt;parent == NULL) {
        tree-&gt;root = res;
    } else {
        if (node-&gt;parent-&gt;left == node)
            node-&gt;parent-&gt;left = res;
        else
            node-&gt;parent-&gt;right = res;
    }
    node-&gt;parent = res;
    // if (node == tree-&gt;root) {
    //     tree-&gt;root = res;
    // }
    return res;
}
</code></pre>
<ol start="3">
<li>å·¦å³æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* LeftRightRotation(Node* node, Tree* tree) {
    node-&gt;left = LeftRotation(node-&gt;left, tree);
    node-&gt;color = red;
    node-&gt;left-&gt;color = black;
    RightRotation(node, tree);
}
</code></pre>
<ol start="4">
<li>å³å·¦æ—‹</li>
</ol>
<pre><code class="language-cpp">Node* RightLeftRotation(Node* node, Tree* tree) {
    node-&gt;right = RightRotation(node-&gt;right, tree);
    node-&gt;color = red;
    node-&gt;right-&gt;color = black;
    LeftRotation(node, tree);
}
</code></pre>
<h3 id="add-1"><a class="header" href="#add-1">add</a></h3>
<p>è¿™é‡Œåªéœ€è¦æ‰¾åˆ°æ­£ç¡®çš„ä½ç½®æ’å…¥å³å¯ï¼ŒfixUp() ä¼ å…¥çš„æ˜¯æ–°æ’å…¥çš„ node</p>
<pre><code class="language-cpp">Node* put(Node* node, int key, int value) {
    Node* parent = NULL;
    Node* newNode = initNode();
    newNode-&gt;key = key; newNode-&gt;value = value;
    // 1.æ·»åŠ æ–°èŠ‚ç‚¹
    while (node != NULL) {
        parent = node;
        if (value &lt; node-&gt;value) {
            node = node-&gt;left;
            if (node == NULL) {
                parent-&gt;left = newNode;
                newNode-&gt;parent = parent;
                break;
            }
        }
        else {
            node = node-&gt;right;
            if (node == NULL) {
                parent-&gt;right = newNode;
                newNode-&gt;parent = parent;
                break;
            }
        }
    }
    return newNode;
}

void putCheck(Tree* tree, int key, int value) {
    if (tree-&gt;init == 0) {
        tree-&gt;root-&gt;key = key;
        tree-&gt;root-&gt;value = value;
        tree-&gt;init = 1;
        tree-&gt;root-&gt;color = 0;
    } else {
        fixUp(put(tree-&gt;root, key, value), tree);
        tree-&gt;root-&gt;color = black;
    }
}
</code></pre>
<h4 id="remove-2"><a class="header" href="#remove-2">remove</a></h4>
<p>åˆ é™¤è¾ƒä¸ºå¤æ‚ï¼Œè¿™é‡Œå…ˆæŠŠä»£ç ä¸€èŠ‚ä¸¤åŠï¼Œä»¥ä¸‹ä¸ºæ–‡å­—å™è¿°ï¼š</p>
<ol>
<li>while å¾ªç¯ç›®çš„æ˜¯æ‰¾åˆ°è¦åˆ é™¤çš„ç‚¹</li>
</ol>
<h4 id="ç¬¬ä¸€éƒ¨åˆ†è‹¥æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹"><a class="header" href="#ç¬¬ä¸€éƒ¨åˆ†è‹¥æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹">ç¬¬ä¸€éƒ¨åˆ†ï¼Œè‹¥æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹</a></h4>
<ol>
<li>æŠŠç‚¹è¿›è¡Œå¯¹æ¥ï¼Œä¸€å…±å¯ä»¥æ‹†åˆ†ä¸º 4 å—</li>
<li>è‹¥è¢«åˆ é™¤çš„ç‚¹æ˜¯é»‘è‰²åˆ™è¿› fixUp(), ä¼ å…¥çš„æ˜¯è¢«åˆ å»èŠ‚ç‚¹çš„å³å­æ ‘çš„æœ€å°èŠ‚ç‚¹å³èŠ‚ç‚¹</li>
</ol>
<pre><code class="language-cpp">Node* removes(Node* node, int key, int value, Tree* tree) {
    Node* parent = NULL;  // è¿™ä¸ª parent æ˜¯æŒ‡ replace çš„ parent
    Node* child = NULL;
    Node* replace = NULL;
    int color;
    while (node != NULL) {
        // æ‰¾åˆ°äº†é‚£ä¸ªç‚¹
        if (node-&gt;value == value) {
            // ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½ä¸ä¸ºç©º
            /*
            *å…±æœ‰å››æ¬¡å¯¹æ¥è¿‡ç¨‹
            * 1. replace(ç§»åŠ¨å) å’Œ replace.father
            * 2. replace(ç§»åŠ¨å‰).right å’Œ replace.father
            * 3. replace(ç§»åŠ¨å) å’Œ node.right
            * 4. replace(ç§»åŠ¨å‰) å’Œ node.left
            */
            if (node-&gt;left != NULL &amp;&amp; node-&gt;right != NULL) {
                replace = node-&gt;right;
                while (replace-&gt;left != NULL) {
                    replace = replace-&gt;left;
                }
                // 1.1
                if (node-&gt;parent != NULL) {
                    if (node-&gt;parent-&gt;left == node) {
                        node-&gt;parent-&gt;left = replace;
                    } else {
                        node-&gt;parent-&gt;right = replace;
                    }
                } else {
                    tree-&gt;root = replace;
                }
                child = replace-&gt;right;
                parent = replace-&gt;parent;
                color = replace-&gt;color;
                // 2.
                if (parent == node) {
                    parent = replace;
                } else {
                    // è¢«æ›¿æ¢çš„èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹è¦è¢«æ¥åˆ° replace.parent ä¸Š
                    if (child != NULL) {child-&gt;parent = parent;}
                    parent-&gt;left = child;
                    // 3.
                    replace-&gt;right = node-&gt;right;
                    node-&gt;right-&gt;parent = replace;
                }
                // 1.2
                replace-&gt;parent = node-&gt;parent;
                replace-&gt;color = node-&gt;color;
                // 4.
                replace-&gt;left = node-&gt;left;
                node-&gt;left-&gt;parent = replace;

                if (color == black) {
                    if (child != NULL) {
                        fixUp(child, tree);
                    } else {
                        fixUp(parent, tree);
                    }
                }
                node = NULL;
                return NULL;
            }
</code></pre>
<h4 id="ç¬¬äºŒéƒ¨åˆ†è‹¥æœ€å¤šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹"><a class="header" href="#ç¬¬äºŒéƒ¨åˆ†è‹¥æœ€å¤šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹">ç¬¬äºŒéƒ¨åˆ†ï¼Œè‹¥æœ€å¤šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹</a></h4>
<pre><code class="language-cpp">            // è·å– node çš„å­èŠ‚ç‚¹
            if (node-&gt;left != NULL) {
                child = node-&gt;left;
            } else {
                child = node-&gt;right;
            }
            if (child != NULL) {
                child-&gt;parent = node-&gt;parent;
            }
            parent = node-&gt;parent;
            color = node-&gt;color;
            // node.å­èŠ‚ç‚¹è¦è¢«æ¥åˆ° node.parent ä¸Š
            if (parent != NULL) {
                if (parent-&gt;left == node) {
                    parent-&gt;left = child;
                } else {
                    parent-&gt;right = child;
                }
            } else {
                // ç‰¹æ®Šå¤„ç†è‹¥å»æ‰çš„èŠ‚ç‚¹æ˜¯æ ¹èŠ‚ç‚¹
                tree-&gt;root = child;
            }
            // è‹¥æœåˆ å»çš„ç‚¹æ˜¯é»‘è‰²çš„ï¼Œéœ€è¦ä¿®å¤
            node = NULL;
            if (child != NULL) {
                fixUp(child, tree);
            } else {
                fixUp(parent, tree);
            }
            return NULL;
        }
        // ç»§ç»­æ‰¾åˆ°è¦å»é™¤çš„ç‚¹
        if (value &lt; node-&gt;value) {
            node = node-&gt;left;
        } else {
            node = node-&gt;right;
        }
    }
    return NULL;
}
</code></pre>
<h3 id="fixup"><a class="header" href="#fixup">fixUp</a></h3>
<p>è¿™é‡Œæ˜¯æ ¸å¿ƒï¼šæ³¨æ„å›é€€çš„è·³è·ƒæ€§</p>
<ol>
<li>è‹¥åªæ˜¯å˜è‰²ï¼Œåˆ™ node = grandparent</li>
<li>è‹¥åªæ˜¯å·¦æ—‹æˆ–å³æ—‹ï¼Œåˆ™ node = parent</li>
<li>è‹¥æ˜¯å·¦å³æ—‹æˆ–å³å·¦æ—‹ï¼Œåˆ™ node = grandparent</li>
</ol>
<pre><code class="language-cpp">Node* fixUp(Node* node, Tree* tree) {
    Node* parent;
    Node* grandparent;
    Node* uncle;
    while (node-&gt;parent != NULL &amp;&amp; node-&gt;parent-&gt;color == red) {
        parent = node-&gt;parent;
        grandparent = parent-&gt;parent;
        if (grandparent == NULL) return NULL;
        if (parent == grandparent-&gt;left) {
            uncle = grandparent-&gt;right;
        } else {
            uncle = grandparent-&gt;left;
        }
        if (uncle != NULL &amp;&amp; uncle-&gt;color == red) {
            uncle-&gt;color = black;
            parent-&gt;color = black;
            grandparent-&gt;color = red;
            node = grandparent;
            continue;
        } else if (uncle == NULL || uncle-&gt;color == black) {
            if (grandparent-&gt;left == parent) {
                if (parent-&gt;left == node) {
                    parent-&gt;color = black;
                    grandparent-&gt;color = red;
                    RightRotation(grandparent, tree);
                } else {
                    LeftRightRotation(grandparent, tree);
                    node = node-&gt;parent;
                }
            } else {
                if (parent-&gt;left == node) {
                    RightLeftRotation(grandparent, tree);
                    node = node-&gt;parent;
                } else {
                    parent-&gt;color = black;
                    grandparent-&gt;color = red;
                    RightRotation(grandparent, tree);
                }
            }
        }
    }
}
</code></pre>
<h3 id="æµ‹è¯•æ ·ä¾‹"><a class="header" href="#æµ‹è¯•æ ·ä¾‹">æµ‹è¯•æ ·ä¾‹</a></h3>
<pre><code class="language-cpp">int main(void) {
    Tree* tree = initTree();
    putCheck(tree, 1, 80);
    putCheck(tree, 1, 40);
    putCheck(tree, 1, 160);
    putCheck(tree, 1, 20);
    putCheck(tree, 1, 60);
    // 1.å•å³æ—‹
    // putCheck(tree, 10);
    // putCheck(tree, 5);
    // 2.å·¦å³æ—‹
    // putCheck(tree, 5); putCheck(tree, 11);
    // 3.å³å·¦æ—‹
    // putCheck(tree, 30);
    // putCheck(tree, 25);
    // 4.çº¢çº¢
    putCheck(tree, 1, 10);
    putCheck(tree, 1, 30);
    putCheck(tree, 1, 25);
    // 5. æš‚æ—¶å°±è¿™æ ·äº†ï¼Œæ˜å¤©å†è¯´
    preorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    // 6. è´Ÿè½½æµ‹è¯•
    putCheck(tree, 1, 28);
    putCheck(tree, 1, 22);
    preorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    putCheck(tree, 1, 23);
    putCheck(tree, 1, 24);
    preorderTraversal(tree-&gt;root);
    printf(&quot;\n&quot;);
    // åˆ é™¤
    removeChect(tree, 1, 23);
    preorderTraversal(tree-&gt;root);
    return 0;
}
</code></pre>
<p><img src="https://www.cnblogs.com/skywang12345/p/3624343.html" alt="å‚è€ƒæ–‡ç« " /></p>
<h3 id="å¤±è´¥çš„å†™äº†ä¸€åŠç¬¬ä¸€ç‰ˆ"><a class="header" href="#å¤±è´¥çš„å†™äº†ä¸€åŠç¬¬ä¸€ç‰ˆ">å¤±è´¥çš„å†™äº†ä¸€åŠç¬¬ä¸€ç‰ˆ</a></h3>
<h4 id="åˆå§‹åŒ–-4"><a class="header" href="#åˆå§‹åŒ–-4">åˆå§‹åŒ–</a></h4>
<ol>
<li>ç›¸æ¯”äº AVL æ ‘ï¼Œçº¢é»‘æ ‘ä¸å†å¼ºè°ƒé«˜åº¦ï¼Œè½¬ä¸ºç”±çº¢é»‘åˆ¤æ–­æ˜¯å¦æ—‹è½¬æˆ–å˜è‰²</li>
<li>å› ä¸ºé«˜åº¦ä¸ç”¨æ”¹å˜ï¼Œæ‰€ä»¥ç”¨ while å¾ªç¯ä»£æ›¿é€’å½’ä¼šæ›´å¥½æ›´å®¹æ˜“</li>
</ol>
<pre><code class="language-cpp">typedef struct Node {
    int value;
    int color; // çº¢ä¸º 1ï¼Œé»‘ä¸º 0
    struct Node* parent;
    struct Node* left;
    struct Node* right;
} Node;

typedef struct Tree {
    int init;
    Node* root;
} Tree;

Node* initNode() {
    Node* p = (Node*)malloc(sizeof(Node));
    p-&gt;value = 0;
    p-&gt;color = red;
    p-&gt;parent = NULL;
    p-&gt;left = NULL;
    p-&gt;right = NULL;
    return p;
}

Tree* initTree() {
    Tree* p = (Tree*)malloc(sizeof(Tree));
    p-&gt;root = initNode();
    p-&gt;init = 0;
    return p;
}
</code></pre>
<h4 id="add-2"><a class="header" href="#add-2">add</a></h4>
<pre><code class="language-cpp">Node* add(Node* node, int value, Tree* tree) {
    // åˆ¤æ–­æ˜¯å¦é€’å½’åˆ° nilï¼Œå¹¶åˆ›å»ºæ–°èŠ‚ç‚¹
    if (node == NULL) {
        Node* newNode = initNode();
        newNode-&gt;value = value;
        return newNode;
    }
    // ğŸ‘ˆ
    if (value &lt; node-&gt;value) {
        Node* newNode = add(node-&gt;left, value, tree);
        // åˆ¤æ–­æ˜¯å¦å‘ç”Ÿæ—‹è½¬ï¼Œè‹¥æœæ—‹è½¬äº†åˆ™é€’å½’çš„ node ä¸ newNode çˆ¶å­å…³ç³»ä¼šå‘ç”Ÿæ”¹å˜ï¼Œè¦åˆ¤æ–­å¹¶åŠæ—¶ç»§ç»­å›é€€ï¼ŒçŸ¥é“çˆ¶å­å…³ç³»æ­£å¸¸
        if (newNode == tree-&gt;root) {
            return newNode;
        }
        // è‹¥çˆ¶å­å…³ç³»æ­£å¸¸ï¼Œåˆ™çº æ­£çˆ¶å­å…³ç³»ï¼Œå¥½åƒåªåœ¨æ–°å»ºæ–°å­èŠ‚ç‚¹æ—¶çœŸæ­£å‘æŒ¥ä½œç”¨ï¼Œå¾…è¯å®ï¼Œ
        // ç”¨é€’å½’å†™çœŸéš¾å—
        newNode-&gt;parent = node;
        node-&gt;left = newNode;
        // åˆ¤æ–­æ˜¯å¦éœ€è¦æ—‹è½¬æˆ–å˜è‰²
        // çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²
        // node-&gt;parent != tree-&gt;root è¿™ä¸ªå¾…å¤§é‡æµ‹è¯•
        if (node-&gt;color != black &amp;&amp; node != tree-&gt;root  &amp;&amp; node-&gt;parent != tree-&gt;root) {
            Node* newNode = reNode(node, leftdirctction, tree);
            // å¦‚æœåªæ¢é¢œè‰²åˆ™ç»“æ„æ²¡æœ‰è°ƒæ•´ï¼ŒæŒ‰æ­£å¸¸é€’å½’èµ°
            if (newNode == NULL) {return node;}
            // åˆ¤æ–­æ ¹æ˜¯å¦è¢«è½¬èµ°äº†
            else if (newNode-&gt;right == tree-&gt;root) {
                newNode-&gt;parent = NULL;
                newNode-&gt;color = black;
                tree-&gt;root = newNode;
            } else {
                // åªè¦è¿›äº†èˆ¹ï¼Œå°±ä¸èµ°å¯»å¸¸è·¯
                return newNode;
            }
        }
    } else { // ğŸ‘‰
        Node* newNode = add(node-&gt;right, value, tree);
        if (newNode == tree-&gt;root) {
            return newNode;
        } else if (node-&gt;parent == newNode) {
            return newNode;
        }
        newNode-&gt;parent = node;
        node-&gt;right = newNode;
        if (node-&gt;color != black &amp;&amp; node != tree-&gt;root) {
            Node* newNode = reNode(node, rightdirctction, tree);
            if (newNode == NULL) {return node;}
            else if (newNode-&gt;right == tree-&gt;root) {
                newNode-&gt;parent = NULL;
                newNode-&gt;color = black;
                tree-&gt;root = newNode;
            } else {
                return newNode;
            }
        }
    }
    return node;
}



Node* addCheck(Tree* tree, int value) {
    if (tree-&gt;init == 0) {
        tree-&gt;init = 1;
        tree-&gt;root-&gt;value = value;
        tree-&gt;root-&gt;color = black;
        return tree-&gt;root;
    } else {
        return add(tree-&gt;root, value, tree);
    }
}
</code></pre>
<h4 id="renode"><a class="header" href="#renode">reNode</a></h4>
<p>ç”¨äºæ—‹è½¬æˆ–å˜è‰²ï¼Œé…åˆå›¾ç‰‡é…Œæƒ…è§‚çœ‹ (ï¼ï¹ï¼œ)</p>
<ol>
<li>å•æ—‹çš„æƒ…å†µ</li>
</ol>
<pre><code class="language-cpp">Node* reNode(Node* node, int isleftdirection, Tree* tree) {
    Node* res = NULL; // å£°æ˜è¿”å›å€¼
    // æ‰¾åˆ°éœ€è¦ç”¨å¾—åˆ°çš„èŠ‚ç‚¹ï¼Œfather(node) å’Œ gradfather
    Node* grandfather = node-&gt;parent;
    Node* brother = NULL;
    // isleft çˆ¶èŠ‚ç‚¹æ˜¯ä¸æ˜¯çˆ·èŠ‚ç‚¹çš„å·¦æ”¯ï¼Œisleftdirection å­èŠ‚ç‚¹æ˜¯ä¸æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦æ”¯
    int isleft = node-&gt;value &lt; grandfather-&gt;value;
    if (isleft) brother = grandfather-&gt;right; else brother = grandfather-&gt;left;
    // è‹¥å…„å¼ŸèŠ‚ç‚¹ä¸ºçº¢è‰²åˆ™åªæ¢é¢œè‰²
    if (brother != NULL &amp;&amp; brother-&gt;color == red) {
        brother-&gt;color = black;
        node-&gt;color = black;
        grandfather-&gt;color = red;
        return NULL;
    } else {
        // è‹¥çˆ·èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹å‡ä¸ºçº¢è‰²ï¼Œéœ€è¦æŠŠå½“å‰èŠ‚ç‚¹è®¾ä¸ºçˆ·èŠ‚ç‚¹ï¼Œè¿™é‡Œç”¨ while å¾ªç¯ä¼šæ–¹ä¾¿å¾—å¤šï¼Œåœ¨æ­¤å¤„æš‚æ—¶åªå¤„ç†çˆ¶èŠ‚ç‚¹å’Œçˆ·èŠ‚ç‚¹åŒä¸ºçº¢è‰²ï¼Œå¦‚æœå†æœ‰æ›´é«˜è¾ˆçš„èŠ‚ç‚¹ï¼Œè¿™é‡Œä¸å†™äº†
        if (grandfather-&gt;parent == NULL) {
            return node;
        } else if (grandfather-&gt;color == red) {
            grandfather = grandfather-&gt;parent;
            // å•æ—‹å°±è¡Œ
            if (isleft) {
                res = RightRotation(grandfather);
            } else {
                res = LeftRotation(grandfather);
            }
        } else {
            if (isleft) {
                if (isleftdirection) {  // å·¦å·¦ å³æ—‹
                    res = RightRotation(grandfather);
                } else {  // å·¦å³ å·¦å³æ—‹
                    res = LeftRightRotation(grandfather);
                }
            } else {
                if (isleftdirection) { // å³å³ å·¦æ—‹
                    res = RightLeftRotation(grandfather);
                } else { // å³å·¦ å³å·¦æ—‹
                    res = LeftRotation(grandfather);
                }
            }
            return res;
        }
    }
}
</code></pre>
<h2 id="å¾…ç»­-13"><a class="header" href="#å¾…ç»­-13">å¾…ç»­...</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker"><a class="header" href="#docker">Docker</a></h1>
<h2 id="1-é•œåƒ"><a class="header" href="#1-é•œåƒ">1 é•œåƒ</a></h2>
<h3 id="11-è·å–é•œåƒ"><a class="header" href="#11-è·å–é•œåƒ">1.1 è·å–é•œåƒ</a></h3>
<p><code>docker pull</code></p>
<p>æ²¡å¿…è¦ï¼Œç›´æ¥ docker run å°±è¡Œäº†</p>
<h3 id="12-åˆ—å‡ºé•œåƒ"><a class="header" href="#12-åˆ—å‡ºé•œåƒ">1.2 åˆ—å‡ºé•œåƒ</a></h3>
<ol>
<li>
<p>åˆ—å‡ºæ‰€æœ‰ï¼š <code>docker image list</code></p>
</li>
<li>
<p>åˆ—å‡ºæ‰€æœ‰è™šæ‚¬é•œåƒï¼š <code>docker image list -f dangling=true</code></p>
<p>è¿™ä¸ªé•œåƒæ—¢æ²¡æœ‰ä»“åº“åï¼Œä¹Ÿæ²¡æœ‰æ ‡ç­¾ï¼Œå‡ä¸º <code>&lt;none&gt;</code></p>
</li>
</ol>
<h3 id="13-åˆ é™¤é•œåƒ"><a class="header" href="#13-åˆ é™¤é•œåƒ">1.3 åˆ é™¤é•œåƒ</a></h3>
<ol>
<li>
<p>åˆ é™¤ï¼š <code>docker image rm xxx</code></p>
<p>xxx å¯ä»¥æ˜¯ é•œåƒçŸ­ IDã€é•œåƒé•¿ IDã€é•œåƒåã€æˆ–è€…é•œåƒæ‘˜è¦</p>
</li>
<li>
<p>åˆ é™¤æ‰€æœ‰è™šæ‚¬é•œåƒï¼š <code>docker image prune</code></p>
</li>
<li>
<p>åˆ é™¤æ‰€æœ‰ä»“åº“åä¸º redis çš„é•œåƒï¼š<code>docker image rm $(docker image ls -q redis)</code></p>
</li>
</ol>
<h3 id="14-docker-drag"><a class="header" href="#14-docker-drag">1.4 docker-drag</a></h3>
<p>https://github.com/NotGlop/docker-drag</p>
<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>
<pre><code class="language-sh">python docker_pull.py hello-world

python docker_pull.py mysql/mysql-server:8.0

python docker_pull.py mcr.microsoft.com/mssql-tools

python docker_pull.py consul@sha256:6ba4bfe1449ad8ac5a76cb29b6c3ff54489477a23786afb61ae30fb3b1ac0ae9
</code></pre>
<p>åŠ è½½é•œåƒï¼š<code>docker image load -i xxx.tar</code></p>
<h2 id="2-å®¹å™¨"><a class="header" href="#2-å®¹å™¨">2 å®¹å™¨</a></h2>
<h3 id="20-åˆ—å‡ºå®¹å™¨"><a class="header" href="#20-åˆ—å‡ºå®¹å™¨">2.0 åˆ—å‡ºå®¹å™¨</a></h3>
<p><code>docker container ls -a</code></p>
<p><code>docker ps -a</code></p>
<h3 id="21-å¯åŠ¨å®¹å™¨"><a class="header" href="#21-å¯åŠ¨å®¹å™¨">2.1 å¯åŠ¨å®¹å™¨</a></h3>
<p>æ–°å»ºå®¹å™¨ï¼š <code>docker run -d -it ubuntu:18.04 /bin/bash</code></p>
<h3 id="22-é‡å¯å®¹å™¨"><a class="header" href="#22-é‡å¯å®¹å™¨">2.2 é‡å¯å®¹å™¨</a></h3>
<p><code>docker container start</code></p>
<h3 id="23-ç»ˆæ­¢å®¹å™¨"><a class="header" href="#23-ç»ˆæ­¢å®¹å™¨">2.3 ç»ˆæ­¢å®¹å™¨</a></h3>
<p><code>docker container stop</code></p>
<p><code>docker container restart</code></p>
<h3 id="24-è¿›å…¥å®¹å™¨"><a class="header" href="#24-è¿›å…¥å®¹å™¨">2.4 è¿›å…¥å®¹å™¨</a></h3>
<p><code>docker exec -it ubuntu:18.04 /bin/bash</code></p>
<h3 id="25-å¯¼å…¥å¯¼å‡º"><a class="header" href="#25-å¯¼å…¥å¯¼å‡º">2.5 å¯¼å…¥å¯¼å‡º</a></h3>
<ol>
<li>
<p>å¯¼å‡ºï¼š<code>docker export 7691a814370e &gt; ubuntu.tar</code></p>
</li>
<li>
<p>å¯¼å…¥ï¼š</p>
<ul>
<li>ä»æ–‡ä»¶ï¼š<code>cat ubuntu.tar | docker import - test/ubuntu:v1.0</code></li>
<li>ä»è·¯å¾„ï¼š<code>docker import http://example.com/exampleimage.tgz example/imagerepo</code></li>
</ul>
</li>
</ol>
<h3 id="26-åˆ é™¤å®¹å™¨"><a class="header" href="#26-åˆ é™¤å®¹å™¨">2.6 åˆ é™¤å®¹å™¨</a></h3>
<ul>
<li>
<p>åˆ é™¤å·²ç»å…³é—­çš„ä¸€ä¸ªå®¹å™¨ï¼š <code>docker container rm</code></p>
</li>
<li>
<p>åˆ é™¤æ‰€æœ‰å·²ç»å…³é—­çš„å®¹å™¨ï¼š<code>docker container prune</code></p>
</li>
</ul>
<h2 id="3-dockerfile"><a class="header" href="#3-dockerfile">3 Dockerfile</a></h2>
<p>è¿™é‡Œä¼šå°†ä¸€ä¸ª Dockerfile çš„æ„å»ºè¿‡ç¨‹</p>
<h3 id="env--arg"><a class="header" href="#env--arg">ENV &amp; ARG</a></h3>
<p>ARG ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡</p>
<ul>
<li><strong>åªåœ¨ build æœŸé—´ç”Ÿæ•ˆï¼Œrun æœŸæ— æ•ˆ</strong></li>
<li>åœ¨æ„å»ºé•œåƒçš„æ—¶å€™ä½¿ç”¨ <code>--build-arg</code> è¿›è¡Œä¼ é€’ï¼Œä¼š <strong>è¦†ç›–</strong> Dockerfile ä¸­æŒ‡å®šçš„åŒåå‚æ•°</li>
</ul>
<blockquote>
<p>çµæ´»ä½¿ç”¨ ARG æŒ‡ä»¤ï¼Œå¯ä»¥åœ¨ä¸ä¿®æ”¹ Dockerfile çš„æƒ…å†µä¸‹ï¼Œæ„å»ºä¸åŒé•œåƒã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ„å»ºé•œåƒçš„æ—¶å€™ï¼Œç»™å‚æ•°ä¼ é€’ä¸åŒçš„å€¼ï¼Œæ„å»ºå‡ºä¸åŒçš„é•œåƒ</p>
</blockquote>
<p>ENV æŒ‡ä»¤å’Œ ARG æŒ‡ä»¤ç‰¹åˆ«ç›¸ä¼¼</p>
<ul>
<li>ARG åœ¨ build çš„æ—¶å€™ç”Ÿæ•ˆï¼ŒENV åœ¨ run çš„æ—¶å€™ç”Ÿæ•ˆï¼Œéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™é‡Œå®šä¹‰çš„ç¯å¢ƒå˜é‡ã€‚</li>
<li><code>docker run --env</code> å¯ä»¥ä¿®æ”¹è¿™äº›å€¼</li>
</ul>
<h3 id="add--copy"><a class="header" href="#add--copy">ADD &amp; COPY</a></h3>
<p>COPY</p>
<ul>
<li>æ”¯æŒé€šé…ç¬¦</li>
<li>å¯ä»¥æ”¹å˜ç”¨æˆ·å’Œç»„</li>
</ul>
<pre><code class="language-dockerfile">COPY package.json /usr/src/app/
COPY hom* /mydir/
COPY hom?.txt /mydir/
COPY --chown=55:mygroup files* /mydir/
</code></pre>
<ul>
<li>å¦‚æœ src æ˜¯ URLï¼Œå¹¶ä¸” dest ä¸ä»¥æ–œæ ç»“å°¾ï¼Œåˆ™ä» URL ä¸‹è½½æ–‡ä»¶å¹¶å°†å…¶å¤åˆ¶åˆ° destã€‚</li>
<li>å¦‚æœ dest ä»¥æ–œæ ç»“å°¾ï¼Œå°†è‡ªåŠ¨æ¨æ–­å‡º url çš„åå­—ï¼ˆä¿ç•™æœ€åä¸€éƒ¨åˆ†ï¼‰ï¼Œä¿å­˜åˆ° dest</li>
<li>å¦‚æœ src æ˜¯ç›®å½•ï¼Œåˆ™å°†å¤åˆ¶ç›®å½•çš„æ•´ä¸ªå†…å®¹ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ã€‚</li>
</ul>
<p>ADD</p>
<ul>
<li>æºè·¯ç»æ˜¯ URL ä¼šå°è¯•ä¸‹è½½</li>
<li>æºè·¯å¾„æ˜¯å‹ç¼©æ–‡ä»¶ (gzip, bzip2 ä»¥åŠ xz), ä¼šè‡ªåŠ¨è§£å‹</li>
</ul>
<h3 id="expose"><a class="header" href="#expose">EXPOSE</a></h3>
<p>æŒ‡å®šå®¹å™¨å‘å¤–éƒ¨æš´éœ²çš„ç«¯å£ï¼Œä½†å¹¶ä¸ä¼šè‡ªåŠ¨æ˜ å°„åˆ°å®¿ä¸»æœºï¼Œä½¿ç”¨<code>-P</code>åä¼šå°†è¿™äº›ç«¯å£éšæœºæ˜ å°„åˆ°å®¿ä¸»æœº</p>
<pre><code class="language-dockerfile">EXPOSE 8080
EXPOSE 7000-8000
</code></pre>
<h3 id="run"><a class="header" href="#run">RUN</a></h3>
<pre><code class="language-dockerfile">RUN cd /app
RUN echo &quot;hello&quot; &gt; world.txt
</code></pre>
<p>ä¸Šé¢çš„ä¸¤ä¸ª<code>RUN</code>å¹¶ä¸æ˜¯åœ¨åŒä¸€ä¸ªç¯å¢ƒä¸‹è¿è¡Œçš„ï¼Œä»–ä»¬ä¸æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œä»–ä»¬çš„å·¥ä½œç›®å½•å½“ç„¶ä¹Ÿä¸ä¸€æ ·</p>
<p>å¯ä»¥é€šè¿‡<code>WORKDIR</code>å»åŒæ­¥ä¸åŒå‘½ä»¤çš„å·¥ä½œç›®å½•</p>
<pre><code class="language-dockerfile">WORKDIR /app
RUN echo &quot;hello&quot; &gt; world.txt
</code></pre>
<p>å¤šä¸ª<code>WORKDIR</code>ä¹‹é—´æ˜¯æœ‰è”ç³»çš„</p>
<pre><code class="language-dockerfile">WORKDIR /a
WORKDIR b
WORKDIR c

RUN pwd
# /a/b/c
</code></pre>
<h3 id="entrypoint"><a class="header" href="#entrypoint">ENTRYPOINT</a></h3>
<p>ENTRYPOINT é…ç½®å®¹å™¨å¯åŠ¨æ—¶çš„æ‰§è¡Œå‘½ä»¤</p>
<ul>
<li>ä¸ä¼šè¢«å¿½ç•¥ï¼Œ<strong>ä¸€å®šä¼šè¢«æ‰§è¡Œ</strong>ï¼Œå³ä½¿è¿è¡Œ docker run æ—¶æŒ‡å®šäº†å…¶ä»–å‘½ä»¤</li>
</ul>
<h3 id="volume"><a class="header" href="#volume">VOLUME</a></h3>
<p>æŒ‚è½½ä¸»æœºç›®å½• / æŒ‚è½½æ•°æ®å·</p>
<pre><code class="language-dockerfile">VOLUME: HostPath:ContainerPath
</code></pre>
<p>æŒ‚è½½åŒ¿åå·ï¼ŒåŒ¿åå·ä¸­çš„æ•°æ®ä¸ä¼šæŒä¹…åŒ–</p>
<pre><code class="language-dockerfile">VOLUME /data
</code></pre>
<p>å‘½ä»¤è¡ŒæŒ‚è½½</p>
<pre><code>--mount type=bind,source=/src/webapp,target=/usr/share/nginx/html,readonly \
</code></pre>
<table><thead><tr><th>key</th><th>value</th></tr></thead><tbody>
<tr><td>type</td><td>bind, volume, or tmpfs</td></tr>
<tr><td>source/src</td><td>Docker Host ä¸Šçš„ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶</td></tr>
<tr><td>destination/dst/target</td><td>è¢«æŒ‚è½½å®¹å™¨ä¸Šçš„ä¸€ä¸ªç›®å½•æˆ–è€…æ–‡ä»¶</td></tr>
<tr><td>readonly</td><td>æŒ‚è½½ä¸ºåªè¯»</td></tr>
</tbody></table>
<h3 id="æ ¼å¼"><a class="header" href="#æ ¼å¼">æ ¼å¼</a></h3>
<ol>
<li>
<p>æŒ‡å®šåŸºç¡€é•œåƒ</p>
<p>å®šåˆ¶ä¸€ä¸ªé•œåƒï¼Œéœ€è¦ä»¥ä¸€ä¸ªé•œåƒä¸ºåŸºç¡€</p>
<pre><code class="language-dockerfile">FROM alpine:latest
</code></pre>
</li>
<li>
<p>RUN æ‰§è¡Œå‘½ä»¤ æ ¼å¼ï¼š<code>RUN &lt;å‘½ä»¤&gt;</code>ï¼Œå°±åƒç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥çš„å‘½ä»¤ä¸€æ ·ã€‚åˆšæ‰å†™çš„ Dockerfile ä¸­çš„ <code>RUN</code> æŒ‡ä»¤å°±æ˜¯è¿™ç§æ ¼å¼ã€‚</p>
</li>
<li>
<p>ENTRYPOINT æ·»åŠ  prefix</p>
<p><code>ENTRYPOINT [ &quot;curl&quot;, &quot;-s&quot;, &quot;http://myip.ipip.net&quot; ]</code></p>
<p>ä»å¤–éƒ¨è¿è¡Œ<code>docker run myip -i</code>ï¼Œå°±ç›¸å½“äº<code>docker run myip curl -s http://myip.ipip.net -i</code></p>
</li>
</ol>
<h3 id="build"><a class="header" href="#build">build</a></h3>
<pre><code class="language-sh">docker build -t xxx .
</code></pre>
<h3 id="ä¾‹å­"><a class="header" href="#ä¾‹å­">ä¾‹å­</a></h3>
<h4 id="curl-è‡ªåŠ¨æŸ¥è¯¢-ip"><a class="header" href="#curl-è‡ªåŠ¨æŸ¥è¯¢-ip">curl è‡ªåŠ¨æŸ¥è¯¢ ip</a></h4>
<pre><code class="language-sh">FROM ubuntu:18.04

RUN apt-get update \
    &amp;&amp; apt-get install -y curl \
    &amp;&amp; rm -rf /var/lib/apt/lists/*

CMD [&quot;curl&quot;, &quot;-s&quot;, &quot;http://&quot;]
</code></pre>
<h4 id="redis--redis-json--redis-search"><a class="header" href="#redis--redis-json--redis-search">redis + redis-json + redis-search</a></h4>
<pre><code class="language-sh">FROM alpine:latest

COPY ./cargo-config /cargo-config

RUN mkdir -p ~/.cargo &amp;&amp; mv /cargo-config ~/.cargo/config \
\
        &amp;&amp; sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories \
        &amp;&amp; apk add --no-cache \
        redis \
        openssh \
        sudo \
        libgcc \
\
        clang-libs \
        git \
        bash \
        python3 \
        py3-setuptools \
        py3-pip \
        unzip \
        wget \
        alpine-sdk \
        cmake \
        cargo \
\
        &amp;&amp; mkdir -p /opt/build /opt/redis-modules \
\
        &amp;&amp; cd /opt/build \
        &amp;&amp; git clone https://github.com/RedisJSON/RedisJSON \
        &amp;&amp; cd RedisJSON \
        &amp;&amp; git submodule update --init --recursive \
        &amp;&amp; cd .. \
        &amp;&amp; git clone https://github.com/RediSearch/RediSearch \
\
        &amp;&amp; cd /opt/build/RedisJSON \
        &amp;&amp; make build shell=/bin/bash \
        &amp;&amp; cp target/release/librejson.so /opt/redis-modules \
\
        &amp;&amp; cd /opt/build/RediSearch \
        &amp;&amp; cmake . -DCMAKE_INSTALL_PREFIX=&quot;/opt/redis-modules&quot; -Bbuild \
        &amp;&amp; cmake --build build \
        &amp;&amp; cp build/redisearch.so /opt/redis-modules \
\
        &amp;&amp; rm -rf /opt/build \
        &amp;&amp; rm -rf ~/.cargo \
        &amp;&amp; strip /opt/redis-modules/*.so \
        &amp;&amp; apk del --purge alpine-sdk cmake cargo python3 py3-setuptools py3-pip unzip wget bash git clang-libs \
        &amp;&amp; adduser -D -s /bin/ash admin

USER admin
VOLUME [&quot;/home/admin&quot;]
WORKDIR /home/admin
EXPOSE 6379
CMD [&quot;redis-server&quot;, &quot;--loadmodule&quot;, &quot;/opt/redis-modules/librejson.so&quot;, &quot;--loadmodule&quot;, &quot;/opt/redis-modules/redisearch.so&quot;]
</code></pre>
<h2 id="4-è‡ªåŠ¨åŒ–"><a class="header" href="#4-è‡ªåŠ¨åŒ–">4 è‡ªåŠ¨åŒ–</a></h2>
<h3 id="pass-å‡­è¯ç®¡ç†"><a class="header" href="#pass-å‡­è¯ç®¡ç†">pass å‡­è¯ç®¡ç†</a></h3>
<ul>
<li>pass</li>
<li>docker-credential-pass</li>
</ul>
<p><img src="https://blog.csdn.net/Rambo_Yang/article/details/108294632" alt="Docker Login ç™»å½•å‡­è¯å®‰å…¨å­˜å‚¨" /></p>
<h3 id="å‘-1"><a class="header" href="#å‘-1">å‘</a></h3>
<p>gpg2 ä¸€å®šä¸è¦ä½¿ç”¨ sudo æ‰§è¡Œï¼Œdocker ä¹Ÿè¦åŠ åˆ° group é‡Œ</p>
<ul>
<li>
<p>æ³¨æ„<code>docker login</code>ç™»é™†çš„ url æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸ª url éœ€è¦æ—¶ jib ç™½åå•é‡Œæœ‰çš„</p>
<p><code>docker login</code>é»˜è®¤ç™»é™†çš„ url æ˜¯<code>index.docker.io/v1</code></p>
<p>å¦‚æœ jib æ— æ³•è¯†åˆ«ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ <code>docker login registry.hub.docker.com</code></p>
<p>ç°åœ¨æœ‰çš„å‡­è¯å¯ä»¥é€šè¿‡<code>docker-credential-pass list</code>æŸ¥çœ‹</p>
<pre><code>Â»Â»Â»Â» docker-credential-pass list
{&quot;https://index.docker.io/v1/&quot;:&quot;trdthg&quot;,&quot;registry.hub.docker.com&quot;:&quot;trdthg&quot;}
</code></pre>
</li>
<li>
<p>jib è‡ªåŠ¨ push éœ€è¦ä»ç™½åå• url ä¸­ä¸€ä¸ªä¸ªå°è¯•ï¼Œ<code>docker login</code></p>
</li>
</ul>
<h3 id="jib"><a class="header" href="#jib">jib</a></h3>
<p><img src="https://github.com/GoogleContainerTools/jib" alt="Jib" /></p>
<p>ç™»é™†æˆåŠŸä¼šæœ‰ä¸‹é¢çš„æç¤º</p>
<pre><code>[INFO] Using credentials from Docker config (/home/trdthg/.docker/config.json) for adoptopenjdk/openjdk8
</code></pre>
<h2 id="5-docker-compose"><a class="header" href="#5-docker-compose">5 docker-compose</a></h2>
<h3 id="é™åˆ¶èµ„æº"><a class="header" href="#é™åˆ¶èµ„æº">é™åˆ¶èµ„æº</a></h3>
<pre><code class="language-yml">redis:
  image: redis:alpine
  container_name: redis
  deploy:
    resources:
      limits:
        cpus: '0.50'
        memory: 50M
</code></pre>
<p><code>--compatibility</code>: ä»¥å…¼å®¹æ¨¡å¼è¿è¡Œï¼Œå°† v3 çš„è¯­æ³•è½¬åŒ–ä¸º v2 çš„è¯­æ³•ï¼Œè€Œä¸éœ€è¦å°† compose æ–‡ä»¶æ”¹ä¸º v2 çš„ç‰ˆæœ¬</p>
<pre><code class="language-shell">docker-compose --compatibility up -d
</code></pre>
<h3 id="å®Œæ•´é…ç½®å‚è€ƒ"><a class="header" href="#å®Œæ•´é…ç½®å‚è€ƒ">å®Œæ•´é…ç½®å‚è€ƒ</a></h3>
<pre><code class="language-yml">version: &quot;3&quot;  # æŒ‡å®š docker-compose è¯­æ³•ç‰ˆæœ¬
services:    # ä»ä»¥ä¸‹å®šä¹‰æœåŠ¡é…ç½®åˆ—è¡¨
  server_name:   # å¯å°† server_name æ›¿æ¢ä¸ºè‡ªå®šä¹‰çš„åå­—ï¼Œå¦‚ mysql/php éƒ½å¯ä»¥
    container_name: container_name  # æŒ‡å®šå®ä¾‹åŒ–åçš„å®¹å™¨åï¼Œå¯å°† container_name æ›¿æ¢ä¸ºè‡ªå®šä¹‰å
    image: xxx:latest # æŒ‡å®šä½¿ç”¨çš„é•œåƒååŠæ ‡ç­¾
    build:  # å¦‚æœæ²¡æœ‰ç°æˆçš„é•œåƒï¼Œéœ€è¦è‡ªå·±æ„å»ºä½¿ç”¨è¿™ä¸ªé€‰é¡¹
      context: /xxx/xxx/Dockerfile  # æŒ‡å®šæ„å»ºé•œåƒæ–‡ä»¶çš„è·¯å¾„
      dockerfile: ....     # æŒ‡å®š Dockerfile æ–‡ä»¶åï¼Œä¸Šä¸€æ¡æŒ‡å®šï¼Œè¿™ä¸€æ¡å°±ä¸è¦äº†
    ports:
      - &quot;00:00&quot;  # å®¹å™¨å†…çš„æ˜ å°„ç«¯å£ï¼Œæœ¬åœ°ç«¯å£ï¼šå®¹å™¨å†…ç«¯å£
      - &quot;00:00&quot;  # å¯æŒ‡å®šå¤šä¸ª
    volumes:
      - test1:/xx/xx  # è¿™é‡Œä½¿ç”¨ managed volume çš„æ–¹æ³•ï¼Œå°†å®¹å™¨å†…çš„ç›®å½•æ˜ å°„åˆ°ç‰©ç†æœºï¼Œæ–¹ä¾¿ç®¡ç†
      - test2:/xx/xx  # å‰è€…æ˜¯ volumes ç›®å½•ä¸‹çš„åå­—ï¼Œåè€…æ˜¯å®¹å™¨å†…ç›®å½•
      - test3:/xx/xx  # åœ¨æ–‡ä»¶çš„æœ€åè¿˜è¦ä½¿ç”¨ volumes æŒ‡å®šè¿™å‡ ä¸ª tests
    volumes_from:  # æŒ‡å®šå·å®¹å™¨
       - volume_container_name  # å·å®¹å™¨å
    restarts: always  # è®¾ç½®æ— è®ºé‡åˆ°ä»€ä¹ˆé”™ï¼Œé‡å¯å®¹å™¨
    depends_on:       # ç”¨æ¥è§£å†³ä¾èµ–å…³ç³»ï¼Œå¦‚è¿™ä¸ªæœåŠ¡çš„å¯åŠ¨ï¼Œå¿…é¡»åœ¨å“ªä¸ªæœåŠ¡å¯åŠ¨ä¹‹å
      - server_name   # è¿™ä¸ªæ˜¯åå­—å…¶ä»–æœåŠ¡åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­çš„ server_name
      - server_name1  # æŒ‰ç…§å…ˆåé¡ºåºå¯åŠ¨
    links:  # ä¸ depend_on ç›¸å¯¹åº”ï¼Œä¸Šé¢æ§åˆ¶å®¹å™¨å¯åŠ¨ï¼Œè¿™ä¸ªæ§åˆ¶å®¹å™¨è¿æ¥
      - mysql  # å€¼å¯ä»¥æ˜¯ - æœåŠ¡åï¼Œæ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥åœ¨è¯¥æœåŠ¡ä¸­ä½¿ç”¨ links ä¸­ mysql ä»£æ›¿è¿™ä¸ª mysql çš„ ip
    networks: # åŠ å…¥æŒ‡å®šçš„ç½‘ç»œï¼Œä¸ä¹‹å‰çš„æ·»åŠ ç½‘å¡åç±»ä¼¼
      - my_net  # bridge ç±»å‹çš„ç½‘å¡å
      - myapp_net # å¦‚æœæ²¡æœ‰ç½‘å¡ä¼šè¢«åˆ›å»ºï¼Œå»ºè®®ä½¿ç”¨æ—¶å…ˆåˆ›å»ºå·ï¼Œåœ¨æŒ‡å®š
    environment: # å®šä¹‰å˜é‡ï¼Œç±»ä¼¼ dockerfile ä¸­çš„ ENV
      - TZ=Asia/Shanghai  # è¿™é‡Œè®¾ç½®å®¹å™¨çš„æ—¶åŒºä¸ºäºšæ´²ä¸Šæµ·ï¼Œä¹Ÿå°±è§£å†³äº†å®¹å™¨é€šè¿‡ compose ç¼–æ’å¯åŠ¨çš„ æ—¶åŒºé—®é¢˜ï¼ï¼ï¼ï¼è§£å†³äº†å®¹å™¨çš„æ—¶åŒºé—®é¢˜ï¼ï¼ï¼
      å˜é‡å€¼ï¼šå˜é‡å   # è¿™äº›å˜é‡å°†ä¼šè¢«ç›´æ¥å†™åˆ°é•œåƒä¸­çš„/etc/profile
    command: [                        #ä½¿ç”¨ command å¯ä»¥è¦†ç›–å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤
            '--character-set-server=utf8mb4',            #è®¾ç½®æ•°æ®åº“è¡¨çš„æ•°æ®é›†
            '--collation-server=utf8mb4_unicode_ci',    #è®¾ç½®æ•°æ®åº“è¡¨çš„æ•°æ®é›†
            '--default-time-zone=+8:00'                    #è®¾ç½® mysql æ•°æ®åº“çš„ æ—¶åŒºé—®é¢˜ï¼ï¼ï¼ï¼è€Œä¸æ˜¯è®¾ç½®å®¹å™¨çš„æ—¶åŒºé—®é¢˜ï¼ï¼ï¼ï¼
    ]
  server_name2:  # å¼€å§‹ç¬¬äºŒä¸ªå®¹å™¨
    server_name:
      stdin_open: true # ç±»ä¼¼äº docker run -d
      tty: true  # ç±»ä¼¼äº docker run -t
volumes:   # ä»¥ä¸Šæ¯ä¸ªæœåŠ¡ä¸­æŒ‚è½½æ˜ å°„çš„ç›®å½•éƒ½åœ¨è¿™é‡Œå†™å…¥ä¸€æ¬¡ï¼Œä¹Ÿå«ä½œå£°æ˜ volume
  test1:
  test2:
  test3:
networks:  # å¦‚æœè¦æŒ‡å®š ip ç½‘æ®µï¼Œè¿˜æ˜¯åˆ›å»ºå¥½åœ¨ä½¿ç”¨å³å¯ï¼Œå£°æ˜ networks
  my_net:
    driver: bridge  # æŒ‡å®šç½‘å¡ç±»å‹
  myapp_net:
    driver: bridge
</code></pre>
<h3 id="spring-boot--mysql"><a class="header" href="#spring-boot--mysql">spring-boot + mysql</a></h3>
<h4 id="doocker-composeyml"><a class="header" href="#doocker-composeyml">doocker-compose.yml</a></h4>
<p>ç½‘ç»œï¼š</p>
<ul>
<li>
<p>å¦‚æœä¸ç‰¹æ®ŠæŒ‡æ˜ï¼Œæ‰€æœ‰çš„ service éƒ½ä¼šè‡ªåŠ¨åŠ å…¥ default ç½‘ç»œé‡Œ</p>
</li>
<li>
<p>host ä¼šè¢« service çš„åç§°ä»£æ›¿ <code>tguio.club =&gt; mysql</code></p>
</li>
<li>
<p>ç«¯å£å·ä¼šè¢«å®¹å™¨æš´éœ²çš„ç«¯å£ä»£æ›¿ <code>4205 =&gt; 3306</code></p>
</li>
<li>
<p>å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡è‡ªå·±æš´éœ²çš„ç«¯å£äº’ç›¸è®¿é—®</p>
</li>
<li>
<p>å®¿ä¸»æœºè¿˜æ˜¯éœ€è¦é€šè¿‡ç»‘å®šåˆ°å®¿ä¸»æœºä¸Šçš„ç«¯å£è®¿é—®</p>
</li>
</ul>
<pre><code class="language-yml">services:
  web:
    build: .
    ports:
      - &quot;8848:8848&quot;
    depends_on:
      - mysql
      - redis
  mysql:
    image: mysql:latest
    environment:
      MYSQL_DATABASE: dev
      MYSQL_USER: admin
      MYSQL_PASSWORD: admin
      MYSQL_ROOT_PASSWORD: 2022A22db
    ports:
      - &quot;4205:3306&quot;
    restart: always

  redis:
    image: &quot;redis:alpine&quot;
    ports:
      - &quot;5470:6379&quot;
</code></pre>
<pre><code class="language-yml">server:
  port: 8848
spring:
  datasource:
#    url: jdbc:mysql://tguio.club:4205/dev?serverTimezone=UTC&amp;useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8&amp;allowPublicKeyRetrieval=true
    url: jdbc:mysql://mysql:3306/dev?serverTimezone=UTC&amp;useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8&amp;allowPublicKeyRetrieval=true
    username: admin
    password: admin
  jpa:
    properties:
      hibernate:
        format_sql: true
#        show_sql: true
        hbm2ddl:
          auto: update
  redis:
#    host: tguio.club
    host: redis
    port: 5470
    pool:
      max-active: 8
      max-wait: -1
      max-idle: 4
      min-idle: 1
#    timeout: 5
</code></pre>
<h2 id="5-å…¶ä»–"><a class="header" href="#5-å…¶ä»–">5 å…¶ä»–</a></h2>
<h3 id="ç«¯å£æ˜ å°„"><a class="header" href="#ç«¯å£æ˜ å°„">ç«¯å£æ˜ å°„</a></h3>
<ul>
<li>ä¸€å¯¹ä¸€æŒ‡å®šï¼š<code>-p &lt;å®¿ä¸»ç«¯å£&gt;:&lt;å®¹å™¨ç«¯å£&gt;</code></li>
<li>ä¸€å¯¹ä¸€éšæœºï¼š
<ul>
<li><code>-P 80</code> æŠŠå®¹å™¨çš„ 80 ç«¯å£éšæœºæ˜ å°„å®¿ä¸»æœºä¸Š</li>
</ul>
</li>
<li>å¤šå¯¹å¤šæŒ‡å®šï¼š
<ul>
<li><code>-p 1000-2000:1000-2000</code> å®¹å™¨çš„ 1000-2000 çš„æ‰€æœ‰ç«¯å£ï¼Œæ˜ å°„åˆ°å®¿ä¸»æœºç«¯å£ 1000-2000</li>
</ul>
</li>
<li>å¤šå¯¹å¤šéšæœºï¼š
<ul>
<li><code>docker run --expose=1000-2000</code> å®¹å™¨çš„ 1000-2000 çš„æ‰€æœ‰ç«¯å£ï¼Œéšæœºæ˜ å°„åˆ°å®¿ä¸»æœº</li>
<li><code>docker run -P</code> æŠŠå®¹å™¨æš´éœ²çš„æ‰€æœ‰ç«¯å£éƒ½éšæœºæ˜ å°„å®¿ä¸»æœºä¸Š</li>
</ul>
</li>
</ul>
<h3 id="æ­£åˆ™åŒ¹é…ç”¨æ³•"><a class="header" href="#æ­£åˆ™åŒ¹é…ç”¨æ³•">æ­£åˆ™åŒ¹é…ç”¨æ³•</a></h3>
<ul>
<li>
<p>åˆ é™¤å®¹å™¨</p>
<p><code>sudo docker ps -a | awk '{print $1, $2}' | grep &quot;jdk&quot; | xargs -t sudo docker rm</code></p>
</li>
<li>
<p>åˆ é™¤é•œåƒ
<code>sudo docker images | awk '{print $1, $2}' | grep &quot;jdk&quot; | awk '{print $1}' | xargs -t sudo docker rmi</code></p>
<p>awk èƒ½å¤Ÿä¸”åˆ†ä¸ºä¸€è¡Œï¼Œprint èƒ½é€‰æ‹©å­—æ®µ</p>
</li>
</ul>
<h3 id="é‡å‘½å"><a class="header" href="#é‡å‘½å">é‡å‘½å</a></h3>
<pre><code>           é•œåƒ id   åç§°  tag(å¯çœç•¥)
docker tag e49db activemp:1.5.5
</code></pre>
<h3 id="æ·»åŠ sudoæƒé™"><a class="header" href="#æ·»åŠ sudoæƒé™">æ·»åŠ <code>sudo</code>æƒé™</a></h3>
<pre><code class="language-shell"># å¦‚æœ docker ç»„ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ ä¹‹ï¼š
sudo groupadd docker

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ° docker ç»„
sudo gpasswd -a trdthg docker

# æ·»åŠ è®¿é—®å’Œæ‰§è¡Œæƒé™
sudo chmod a+rw /var/run/docker.sock
</code></pre>
<h3 id="æ¨é€åˆ°-dockerhub"><a class="header" href="#æ¨é€åˆ°-dockerhub">æ¨é€åˆ° dockerhub</a></h3>
<ol>
<li>ç™»é™†</li>
</ol>
<pre><code>docker login -u xxx
Password: è¾“å…¥ token
</code></pre>
<ol start="2">
<li>æ¨é€ æ³¨æ„ï¼šéœ€è¦ä¿®æ”¹ image åç§°ä¸º <code>{username}/{image-name}:{tag}</code></li>
</ol>
<pre><code>docker push `{username}/{image-name}:{tag}`
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿è·¯è¿½è¸ª--æ€§èƒ½ç›‘æµ‹"><a class="header" href="#è¿è·¯è¿½è¸ª--æ€§èƒ½ç›‘æµ‹">è¿è·¯è¿½è¸ª / æ€§èƒ½ç›‘æµ‹</a></h1>
<h2 id="å…¨è¿è·¯è¿½è¸ª"><a class="header" href="#å…¨è¿è·¯è¿½è¸ª">å…¨è¿è·¯è¿½è¸ª</a></h2>
<h3 id="skywalking"><a class="header" href="#skywalking">skywalking</a></h3>
<p>è¿™é‡Œä½¿ç”¨æ¢é’ˆå®ç°ä¿¡æ¯æ”¶é›†ï¼Œä½¿ç”¨é»˜è®¤çš„ H2 å­˜å‚¨</p>
<h4 id="springboot-é…ç½®"><a class="header" href="#springboot-é…ç½®">springboot é…ç½®</a></h4>
<pre><code class="language-yml">server:
  port: 8848
spring:
  datasource:
    url: jdbc:mysql://mysql:3306/dev?serverTimezone=UTC&amp;useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8&amp;allowPublicKeyRetrieval=true
    username: admin
    password: admin
  jpa:
    properties:
      hibernate:
        format_sql: true
        hbm2ddl:
          auto: update
  redis:
    host: redis
    port: 6379
    pool:
      max-active: 8
      max-wait: -1
      max-idle: 4
      min-idle: 1
</code></pre>
<h4 id="dockerfile-é…ç½®"><a class="header" href="#dockerfile-é…ç½®">Dockerfile é…ç½®</a></h4>
<ol>
<li>
<p><code>ADD /target/decsion-engine-0.1.5.jar app.jar</code></p>
<ul>
<li>æ‹·è´é¡¹ç›®æ‰“åŒ…å¥½çš„ jar åŒ…</li>
</ul>
</li>
<li>
<p><code>ADD ./agent agent</code></p>
<ul>
<li>æ³¨æ„ï¼šagent éœ€è¦å’Œ jar åŒ…æ”¾ä¸€èµ·ï¼Œä¸ä»…ä»…æ˜¯ skywalking-agent.jarï¼Œ</li>
<li>config ä¸‹æ˜¯ skywalking çš„é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œå…¶ä¸­çš„å‚æ•°å¯ä»¥è¢« java ä¼ é€’çš„å‚æ•°è¦†ç›–</li>
<li>log ä¸‹å­˜å‚¨äº†æ—¥å¿—ï¼Œä¸€èˆ¬ç›‘æµ‹ä¿¡æ¯æ²¡æœ‰å¯ä»¥å°è¯•æŸ¥çœ‹è¯¥æ–‡ä»¶å¤¹</li>
<li>plugin ä¸‹å­˜å‚¨äº†å¯¹ä¸åŒè¿›ç¨‹çš„ä¿¡æ¯é‡‡é›†å·¥å…·ï¼Œå¿…é¡»ä¾èµ–ä»–ä»¬æ‰èƒ½æ­£å¸¸ç›‘æµ‹</li>
</ul>
</li>
<li>
<p><code>java xxx</code></p>
<ul>
<li>xxx æŒ‡æœåŠ¡çš„åå­—ï¼Œéšæ„</li>
<li>backend_service æŒ‡çš„æ˜¯ skywalking çš„é“¾æ¥
<ul>
<li>å¯ä»¥æ˜¯ docker-compose å®šä¹‰çš„ (oap:port1)</li>
<li>ä¹Ÿå¯ä»¥æ˜¯å®¿ä¸»æœºçš„ ip ç«¯å£ (192.168.xxx:port2)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å®Œæ•´</p>
</li>
</ol>
<pre><code class="language-yml">FROM adoptopenjdk/openjdk8
VOLUME [&quot;/tmp&quot;, &quot;/logs&quot;]
EXPOSE 8848
ADD /target/decsion-engine-0.1.5.jar app.jar
ADD ./agent agent
# ADD ./skywalking-agent.jar skywalking-agent.jar # è¿™ä¸ªä¸å¯¹

CMD java -javaagent:agent/skywalking-agent.jar -Dskywalking.agent.service_name=xxx -Dskywalking.collector.backend_service=192.168.31.226:11800 -jar app.jar

# ä¸‹é¢çš„ä¸€æ ·ï¼Œä¸å½±å“ï¼Œå¦‚æœæ²¡æˆåŠŸï¼Œä¸€å®šæ˜¯åˆ«çš„åœ°æ–¹å†™é”™äº†ğŸ˜…
# ENTRYPOINT [&quot;java&quot;, &quot;-javaagent:agent/skywalking-agent.jar&quot;, &quot;-Dskywalking.agent.service_name=xxx&quot;, &quot;-Dskywalking.collector.backend_service=192.168.31.226:11800&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]
</code></pre>
<h4 id="docker-composeyml"><a class="header" href="#docker-composeyml">docker-compose.yml</a></h4>
<p>éœ€è¦æ³¨æ„çš„ç‚¹</p>
<ul>
<li>æœåŠ¡çš„å…ˆåé¡ºåº
<ul>
<li>é€šè¿‡è®¾ç½® restart ä¸æ–­é‡è¯•ï¼Œç›´åˆ°ä¾èµ–çš„æœåŠ¡å¯åŠ¨å®Œæˆ</li>
</ul>
</li>
<li>ip(host), ç«¯å£å· (port)
<ul>
<li>å®¹å™¨ä¹‹é—´é€šè¿‡å¯ä»¥ç›´æ¥ç”¨<code>${container_name}:${container_port}</code>äº’ç›¸è®¿é—®ï¼š<code>mysql:3306</code></li>
<li>ä¹Ÿå¯ä»¥ç›´æ¥ç”¨<code>${host_ip}:${host_port}</code>äº’ç›¸è®¿é—®ï¼š<code>192.168.31.226:4205</code></li>
</ul>
</li>
</ul>
<pre><code class="language-yml">services:
  web:
#    image: &quot;trdthg/decision-engine:latest&quot;
    build: .
    ports:
      - &quot;8848:8848&quot;
    depends_on:
      - mysql
      - redis
      - oap
      - skywaling-ui
    restart: always
  mysql:
    image: mysql:latest
    environment:
      MYSQL_DATABASE: dev
      MYSQL_USER: admin
      MYSQL_PASSWORD: admin
      MYSQL_ROOT_PASSWORD: 2022A22db
    ports:
      - &quot;4205:3306&quot;
    logging:
      driver: &quot;none&quot;
    restart: always

  redis:
    image: &quot;redis:alpine&quot;
    ports:
      - &quot;5470:6379&quot;
    logging:
      driver: &quot;none&quot;
  oap:
    image: apache/skywalking-oap-server:8.4.0-es6
    container_name: oap
    restart: always
    ports:
      - 11800:11800 # agent ä¸ŠæŠ¥æ•°æ®çš„ç«¯å£ï¼Œè¿™æ˜¯ gRPC ç«¯å£
      - 12800:12800 # ui è¯»å–æ•°æ®çš„ç«¯å£ï¼Œè¿™æ˜¯ http ç«¯å£
    # logging:
    #   driver: &quot;none&quot;
  skywaling-ui:
    image: apache/skywalking-ui:8.4.0
    container_name: ui
    depends_on:
      - oap
    links:
      - oap
    ports:
      - 8088:8080
    environment:
      - SW_OAP_ADDRESS=http://oap:12800
    logging:
      driver: &quot;none&quot;
</code></pre>
<h4 id="å‚è€ƒ-5"><a class="header" href="#å‚è€ƒ-5">å‚è€ƒ</a></h4>
<ul>
<li><a href="https://segmentfault.com/a/1190000039836624">ä½¿ç”¨ docker éƒ¨ç½² spring boot å¹¶æ¥å…¥ skywalking</a></li>
</ul>
<h2 id="ç«ç„°å›¾"><a class="header" href="#ç«ç„°å›¾">ç«ç„°å›¾</a></h2>
<h3 id="ç«ç„°å›¾ç®€æ˜æ•™ç¨‹"><a class="header" href="#ç«ç„°å›¾ç®€æ˜æ•™ç¨‹">ç«ç„°å›¾ç®€æ˜æ•™ç¨‹</a></h3>
<h4 id="arthas"><a class="header" href="#arthas">arthas</a></h4>
<p>arthas æ˜¯ Alibaba å¼€æºçš„ Java
è¯Šæ–­å·¥å…·ï¼Œå…¶ä¸­æ•´åˆäº†å¾ˆå¤šå®ç”¨çš„å·¥å…·ï¼Œä¾‹å¦‚æŸ¥çœ‹å½“å‰ JVM çš„çº¿ç¨‹å †æ ˆä¿¡æ¯ã€æŸ¥çœ‹å’Œä¿®æ”¹ JVM çš„ç³»ç»Ÿå±æ€§ã€æ–¹æ³•æ‰§è¡Œæ•°æ®è§‚æµ‹ã€ç”Ÿæˆç«ç„°å›¾ç­‰ã€‚æœ€å¤§çš„ä¼˜ç‚¹æ˜¯å¯¹ç›‘æ§åº”ç”¨æ— ä»£ç ä¾µå…¥ï¼Œä¹Ÿä¸éœ€è¦é‡å¯ç›‘æ§åº”ç”¨æˆ–è€…æ·»åŠ å¯åŠ¨å‚æ•°å°±å¯ä»¥éšæ„ attach åˆ°ç›®æ ‡ JVM è¿›ç¨‹ç„¶åè¿›è¡Œå„ç§æ“ä½œã€‚
æ­¤å¤„é‡ç‚¹æåˆ°çš„æ˜¯ arthas ä¸­çš„ profiler åŠŸèƒ½ï¼Œå®é™…ä¸Šæ˜¯å¯¹ async-profiler çš„å°è£…ï¼Œå¯ä»¥å¯¹ JVM åº”ç”¨è¿›è¡Œé‡‡æ ·åè¾“å‡ºå„ç§ç±»å‹çš„ç«ç„°å›¾ã€‚</p>
<h4 id="åŸºæœ¬ä½¿ç”¨-1"><a class="header" href="#åŸºæœ¬ä½¿ç”¨-1">åŸºæœ¬ä½¿ç”¨</a></h4>
<h5 id="1-å®‰è£…å¯åŠ¨"><a class="header" href="#1-å®‰è£…å¯åŠ¨">1. å®‰è£…å¯åŠ¨</a></h5>
<p>å¯åŠ¨ profiler é‡‡æ ·åï¼Œéœ€è¦é€‰æ‹©å¯¹åº”çš„è¿›ç¨‹</p>
<pre><code class="language-shell">wget https://alibaba.github.io/arthas/arthas-boot.jar
java -jar arthas-boot.jar
</code></pre>
<h5 id="2-å¼€å§‹é‡‡é›†"><a class="header" href="#2-å¼€å§‹é‡‡é›†">2. å¼€å§‹é‡‡é›†</a></h5>
<h6 id="21-åŸºäº-cpu-ä½¿ç”¨ç‡é‡‡æ ·-é€‚ç”¨äº-cpu-å¯†é›†å‹"><a class="header" href="#21-åŸºäº-cpu-ä½¿ç”¨ç‡é‡‡æ ·-é€‚ç”¨äº-cpu-å¯†é›†å‹">2.1 åŸºäº CPU ä½¿ç”¨ç‡é‡‡æ · (é€‚ç”¨äº CPU å¯†é›†å‹)</a></h6>
<p>async-profiler æ”¯æŒå¯¹å¤šç§äº‹ä»¶åšé‡‡æ ·åˆ†æï¼Œä¾‹å¦‚ cpuã€allocã€lockã€cache-misses ç­‰ï¼Œå¸¸ç”¨çš„é‡‡æ ·äº‹ä»¶ä¸º cpu å’Œ wallã€‚å…¶ä¸­ç«ç„°å›¾é‡‡æ ·æœªæŒ‡å®šäº‹ä»¶æ—¶é»˜è®¤å¯¹ cpu äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œå³ On-CPU ç«ç„°å›¾ï¼Œä»…åŒ…å« JVM åœ¨ CPU æ‰§è¡Œæ—¶çš„é‡‡æ ·ï¼Œè€Œä¸åŒ…å« CPU ç­‰å¾…æ—¶çš„é‡‡æ ·ã€‚</p>
<pre><code class="language-hell">$ profiler start
Started [cpu] profiling
</code></pre>
<h6 id="22-åŸºäºæ ·æœ¬é‡‡æ ·å¯ä¼°ç®—è€—æ—¶-é€‚ç”¨äº-io-å¯†é›†å‹"><a class="header" href="#22-åŸºäºæ ·æœ¬é‡‡æ ·å¯ä¼°ç®—è€—æ—¶-é€‚ç”¨äº-io-å¯†é›†å‹">2.2 åŸºäºæ ·æœ¬é‡‡æ ·ï¼Œå¯ä¼°ç®—è€—æ—¶ (é€‚ç”¨äº IO å¯†é›†å‹)</a></h6>
<p>å¦‚æœéœ€è¦åˆ†æ IO å¯†é›†å‹åº”ç”¨ï¼Œæ¯”è¾ƒé€‚åˆå¯¹ wall äº‹ä»¶è¿›è¡Œé‡‡æ ·ï¼Œå¦‚ä¸‹å®˜æ–¹æè¿°ï¼Œwall äº‹ä»¶ä¼šå¯¹æ‰€æœ‰ä»»æ„çŠ¶æ€çš„çº¿ç¨‹è¿›è¡Œé‡‡æ ·ï¼Œæ—¢åŒ…å« CPU æ‰§è¡Œæ—¶çš„é‡‡æ ·ï¼Œä¹ŸåŒ…å«äº† CPU ç­‰å¾…æ—¶çš„é‡‡æ ·ï¼Œå¯ä»¥ç”¨æ¥æ›´æ˜¾è‘—åœ°åˆ†æçº¿ç¨‹åœ¨å„ä¸ªæ–¹æ³•ä¸Šçš„è€—æ—¶åˆ†å¸ƒã€‚</p>
<pre><code class="language-shell">$ profiler start -e wall
Started [wall] profiling
</code></pre>
<h5 id="3-æŸ¥çœ‹çŠ¶æ€"><a class="header" href="#3-æŸ¥çœ‹çŠ¶æ€">3. æŸ¥çœ‹çŠ¶æ€</a></h5>
<p>è·å–å·²é‡‡é›†çš„ sample çš„æ•°é‡</p>
<pre><code class="language-shell">$ profiler getSamples
</code></pre>
<p>æŸ¥çœ‹ profiler çŠ¶æ€</p>
<pre><code class="language-shell">$ profiler status
[cpu] profiling is running for 4 seconds
</code></pre>
<h5 id="4-ç”Ÿæˆç»“æœ"><a class="header" href="#4-ç”Ÿæˆç»“æœ">4. ç”Ÿæˆç»“æœ</a></h5>
<p>ç”Ÿæˆ svg æ ¼å¼ç»“æœ</p>
<pre><code class="language-shell">$ profiler stop --file xxx.svg --format svg
profiler output file: /tmp/demo/arthas-output/20191125-135546.svg
OK
</code></pre>
<h5 id="5-demo"><a class="header" href="#5-demo">5. demo</a></h5>
<pre><code class="language-java">@RestController
@RequestMapping
public class IndexController {@GetMapping(&quot;/&quot;)
    public String index() throws InterruptedException {
        long start = System.currentTimeMillis();
        cpuHandler();
        long time1 = System.currentTimeMillis();
        timeHandler();
        long time2 = System.currentTimeMillis();
        normalHandler();
        long time3 = System.currentTimeMillis();

        return String.format(&quot;%d %d %d&quot;, time1 - start, time2 - time1, time3 - time2);
    }

    private int cpuHandler() {
        int value = 0;
        int max = (int)(Math.random() * 100_000_000);
        for (int i = 0; i &lt; max; i++) {
            value += i;
        }
        return value;
    }

    private void timeHandler() throws InterruptedException {
        Thread.sleep(10);
    }

    private void normalHandler() {
        Random random = new Random();
        random.nextInt(100);
    }

}
</code></pre>
<ul>
<li>
<p>cpu äº‹ä»¶é‡‡æ ·</p>
<p>ç”±å›¾å¯ä»¥æ˜ç»†çš„çœ‹å‡ºæ¥ï¼Œindex æ–¹æ³•ä¸­ cpuHandler äº‹ä»¶é‡‡æ ·å æ¯”æœ€é«˜ï¼Œå³ On-CPU ä¸­ cpuHandler æ–¹æ³•å ç”¨çš„ CPU æœ€é«˜ã€‚å¦‚æœå› ä¸ºåº”ç”¨å ç”¨ CPU æ¶ˆè€—é«˜ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ï¼Œé‚£ä¹ˆé€šè¿‡è¯¥ç«ç„°å›¾å¾ˆå®¹æ˜“åˆ†æå‡ºæ¥éœ€è¦å¯¹ cpuHandler æ–¹æ³•ä¼˜åŒ–æ¥é™ä½ CPU æ¶ˆè€—ã€‚</p>
</li>
<li>
<p>wall äº‹ä»¶é‡‡æ ·</p>
<p>ç”±å›¾å¯ä»¥æ˜ç»†çš„çœ‹å‡ºæ¥ï¼Œindex æ–¹æ³•ä¸­ timeHandler äº‹ä»¶é‡‡æ ·å æ¯”æœ€é«˜ï¼Œå³ timeHandler æ–¹æ³•å ç”¨çº¿ç¨‹è€—æ—¶æ—¶é—´æœ€é«˜ã€‚å¦‚æœå› ä¸º index æ–¹æ³•è€—æ—¶è¾ƒé•¿ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ï¼Œé‚£ä¹ˆé€šè¿‡è¯¥ç«ç„°å›¾å¾ˆå®¹æ˜“åˆ†æå‡ºæ¥éœ€è¦å¯¹ timeHandler æ–¹æ³•ä¼˜åŒ–æ¥é™ä½çº¿ç¨‹è€—æ—¶æ—¶é—´</p>
</li>
</ul>
<p>ç›´æ¥è§‚å¯Ÿ&quot;å¹³é¡¶&quot;ï¼ˆplateausï¼‰å¾€å¾€ä¸èƒ½å¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºé¡¶éƒ¨è®°å½•çš„å¤šåŠæ˜¯å¯¹åº•å±‚åº“å‡½æ•°çš„è°ƒç”¨æƒ…å†µã€‚æˆ‘è®¤ä¸ºï¼Œè¦å¿«é€Ÿå®šä½æ€§èƒ½é—®é¢˜ï¼Œé¦–å…ˆåº”è¯¥è§‚å¯Ÿçš„æ˜¯ä¸šåŠ¡å‡½æ•°åœ¨ç«ç„°å›¾ä¸­çš„å®½åº¦ï¼Œç„¶ååœ¨å¾€é¡¶éƒ¨æ‰¾åˆ°ç¬¬ä¸€ä¸ªåº“å‡½æ•°æ¥ç¼©å°èŒƒå›´ï¼Œè€Œä¸æ˜¯ç›´æ¥å°±çœ‹å¹³é¡¶ã€‚</p>
<h2 id="prometheus"><a class="header" href="#prometheus">prometheus</a></h2>
<p>è¢«ç›‘æ§çš„è¿›ç¨‹éœ€è¦å‘<code>prometheus</code>å‘é€å›ºå®šæ ¼å¼çš„ä¿¡æ¯ï¼Œå› ä¸ºæ ¼å¼å›ºå®šï¼Œå¯ä»¥æ ¹æ®<code>prometheus</code>çš„æŸ¥è¯¢è¯­å¥å»ç­›é€‰æ•°æ®ï¼Œå¹¶å¯¼å‡ºå›¾æ ‡</p>
<h3 id="promql"><a class="header" href="#promql">PromQL</a></h3>
<p>ä¸€æ¡å®Œæ•´çš„æŸ¥è¯¢è¯­å¥ä¸»è¦æœ‰</p>
<ul>
<li>åŒ¹é…æ•°æ®æº</li>
<li>è¿ç®—</li>
<li>å‡½æ•° è¿™ä¸‰éƒ¨åˆ†ç»„æˆ</li>
</ul>
<ol>
<li>æŸ¥è¯¢å†…å­˜å ç”¨</li>
</ol>
<p>æ•°æ®æºï¼š</p>
<pre><code># HELP node_memory_MemFree_bytes Memory information field MemFree_bytes.
# TYPE node_memory_MemFree_bytes gauge
node_memory_MemFree_bytes 4.85957632e+08
# HELP node_memory_MemTotal_bytes Memory information field MemTotal_bytes.
# TYPE node_memory_MemTotal_bytes gauge
node_memory_MemTotal_bytes 1.6170528768e+10
</code></pre>
<p>è®¡ç®—ï¼š(æ€»å†…å­˜ - ç©ºé—²å†…å­˜) / æ€»å†…å­˜ * 100</p>
<pre><code>(
  (
    node_memory_MemTotal_bytes{instance=&quot;$node&quot;,job=&quot;$job&quot;}
    - node_memory_MemFree_bytes{instance=&quot;$node&quot;,job=&quot;$job&quot;}
  ) / (node_memory_MemTotal_bytes{instance=&quot;$node&quot;,job=&quot;$job&quot;} )) * 100
</code></pre>
<ol start="2">
<li>æŸ¥è¯¢ cpu æ€»å ç”¨</li>
</ol>
<p>å„ä¸ªå†…æ ¸çš„æ•°æ®</p>
<pre><code># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.
# TYPE node_cpu_seconds_total counter
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;idle&quot;} 134248.98
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;iowait&quot;} 94.73
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;irq&quot;} 0
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;nice&quot;} 2.6
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;softirq&quot;} 4554.64
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;steal&quot;} 0
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;system&quot;} 3190.14
node_cpu_seconds_total{cpu=&quot;0&quot;,mode=&quot;user&quot;} 6843.42

node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;idle&quot;} 12962.19
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;iowait&quot;} 12.3
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;irq&quot;} 0
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;nice&quot;} 2.05
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;softirq&quot;} 464.51
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;steal&quot;} 0
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;system&quot;} 2174.27
node_cpu_seconds_total{cpu=&quot;1&quot;,mode=&quot;user&quot;} 5931.27

node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;idle&quot;} 12798.81
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;iowait&quot;} 16.9
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;irq&quot;} 0
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;nice&quot;} 2.27
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;softirq&quot;} 39.99
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;steal&quot;} 0
node_cpu_seconds_total{cpu=&quot;10&quot;,mode=&quot;system&quot;} 2554.07

100 - (
  # å–å¹³å‡å€¼
  avg(
    # rate å‡½æ•°èƒ½å¤Ÿæ±‚ counter ç±»å‹æ•°æ®çš„å¢é•¿ç‡ï¼Œç±»ä¼¼äºåŠ é€Ÿåº¦ï¼Œèƒ½å¤Ÿåæ˜ å˜åŒ–çš„å‰§çƒˆç¨‹åº¦
    rate(
      # åªåŒ¹é… mode ä¸º idle çš„è¡Œï¼Œ
      node_cpu_seconds_total{instance=~&quot;$node&quot;,mode=&quot;idle&quot;}[$interval])
  ) * 100
)
</code></pre>
<h3 id="é…ç½®æ–‡ä»¶"><a class="header" href="#é…ç½®æ–‡ä»¶">é…ç½®æ–‡ä»¶</a></h3>
<pre><code class="language-yml">global:
  scrape_interval: 15s # å…¨å±€é»˜è®¤åˆ·æ–°æ—¶é—´
  external_labels:
    monitor: 'codelab-monitor'

scrape_configs:
  - job_name: 'service1' # ä¸€ä¸ª job å¯ä»¥ç›‘æ§å¤šä¸ªå®ä¾‹ï¼Œå®ä¾‹å¯ä»¥åˆ†ç»„
    scrape_interval: 5s
    static_configs:
      # - targets: ['localhost:8080', 'localhost:8081']
      #   labels:
      #     group: 'production'

      - targets: [&quot;service1:9100&quot;]
        labels:
          group: 'node'

  - job_name: 'jmeter' # jmeter è¿è¡Œè¿‡ç¨‹ä¸­ä¼šåœ¨ 9270 ç«¯å£ï¼Œå¯ä»¥ç›‘æ§
    scrape_interval: 5s
    static_configs:
      - targets: [&quot;jmeter:9270&quot;]
        labels:
          group: 'jmeter'
</code></pre>
<h3 id="ç›‘æµ‹-springboot"><a class="header" href="#ç›‘æµ‹-springboot">ç›‘æµ‹ springboot</a></h3>
<h2 id="jmeter"><a class="header" href="#jmeter">jmeter</a></h2>
<h3 id="è¿è¡Œæµ‹è¯•"><a class="header" href="#è¿è¡Œæµ‹è¯•">è¿è¡Œæµ‹è¯•</a></h3>
<pre><code>JVM_ARGS=&quot;-Xms1g -Xmx1g&quot; jmeter.sh -n -t benchmark.jmx
</code></pre>
<h3 id="å‚æ•°-1"><a class="header" href="#å‚æ•°-1">å‚æ•°</a></h3>
<pre><code>-n å‘½ä»¤è¡Œæ¨¡å¼

-t æŒ‡å®š jmx è„šæœ¬åœ°å€ï¼ˆåœ°å€å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼‰

-h æŸ¥çœ‹å¸®åŠ©
-v æŸ¥çœ‹ç‰ˆæœ¬
-p æŒ‡å®šè¯»å– jmeter å±æ€§æ–‡ä»¶ï¼Œæ¯”å¦‚ jmeter.properties æ–‡ä»¶ä¸­è®¾ç½®çš„
-l è®°å½•æµ‹è¯•ç»“æœçš„æ–‡ä»¶ï¼Œé€šå¸¸ç»“æœæ–‡ä»¶ä¸º jtl æ ¼å¼ï¼ˆæ–‡ä»¶å¯ä»¥æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œå¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼‰
-s ä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œï¼ˆä¹Ÿæ˜¯è¿œç¨‹æ–¹å¼ï¼Œå¯åŠ¨ Agentï¼‰
-H è®¾ç½®ä»£ç†ï¼Œä¸€èˆ¬å¡«å†™ä»£ç† IP
-P è®¾ç½®ä»£ç†ç«¯å£
-u ä»£ç†è´¦å·
-a ä»£ç†å£ä»¤
-J å®šä¹‰ jmeter å±æ€§ï¼Œç­‰åŒäºåœ¨ jmeter.properties ä¸­è¿›è¡Œè®¾ç½®
-G å®šä¹‰ jmeter å…¨å±€å±æ€§ï¼Œç­‰åŒäºåœ¨ Global.properties ä¸­è¿›è¡Œè®¾ç½®ï¼Œçº¿ç¨‹é—´å¯ä»¥å…±äº«ï¼‰
-D å®šä¹‰ç³»ç»Ÿå±æ€§ï¼Œç­‰åŒäºåœ¨ system.properties ä¸­è¿›è¡Œè®¾ç½®
-S åŠ è½½ç³»ç»Ÿå±æ€§æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡æ­¤å‚æ•°æŒ‡å®šåŠ è½½ä¸€ä¸ªç³»ç»Ÿå±æ€§æ–‡ä»¶ï¼Œæ­¤æ–‡ä»¶å¯ä»¥ç”¨æˆ·è‡ªå·±å®šä¹‰
-L å®šä¹‰ jmeter æ—¥å¿—çº§åˆ«ï¼Œå¦‚ debugã€infoã€error ç­‰
-j åˆ¶å®šæ‰§è¡Œæ—¥å¿—è·¯å¾„ã€‚ï¼ˆå‚æ•°ä¸ºæ—¥å¿—è·¯å¾„ï¼Œä¸å­˜åœ¨ä¸ä¼šè‡ªåŠ¨åˆ›å»ºï¼Œå°†æ—¥å¿—è¾“å‡ºåˆ°å‘½è¡Œæ§åˆ¶å°ï¼‰
-r å¼€å¯è¿œç¨‹è´Ÿè½½æœºï¼Œè¿œç¨‹æœºå™¨åˆ—è¡¨åœ¨ jmeter.properties ä¸­æŒ‡å®š
-R å¼€å¯è¿œç¨‹è´Ÿè½½æœºï¼Œå¯ä»¥æŒ‡å®šè´Ÿè½½æœº IPï¼Œä¼šè¦†ç›– jmeter.properties ä¸­ remote_hosts çš„è®¾ç½®
-d æŒ‡å®š Jmeter Home ç›®å½•
-X åœæ­¢è¿œç¨‹æ‰§è¡Œ
-g æŒ‡å®šæµ‹è¯•ç»“æœæ–‡ä»¶è·¯å¾„ï¼Œä»…ç”¨äºç”Ÿæˆæµ‹è¯•æŠ¥è¡¨ï¼Œå‚æ•°æ˜¯ csv ç»“æœæ–‡ä»¶
-e è®¾ç½®æµ‹è¯•å®Œæˆåç”Ÿæˆæµ‹è¯•æŠ¥è¡¨
-o æŒ‡å®šæµ‹è¯•æŠ¥å‘Šç”Ÿæˆæ–‡ä»¶å¤¹ï¼ˆæ–‡ä»¶å¤¹å¿…é¡»å­˜åœ¨ä¸”ä¸ºç©ºæ–‡ä»¶å¤¹ï¼‰
</code></pre>
<h3 id="æ’ä»¶"><a class="header" href="#æ’ä»¶">æ’ä»¶</a></h3>
<p>ä¸‹è½½åæ”¾åˆ°<code>lib/ext</code>ç›®å½•ä¸‹å³å¯</p>
<ul>
<li><a href="https://github.com/johrstrom/jmeter-prometheus-plugin/releases">prometheus</a></li>
</ul>
<h3 id="å¯¼å…¥-influxdb20"><a class="header" href="#å¯¼å…¥-influxdb20">å¯¼å…¥ influxdb2.0</a></h3>
<ol>
<li>é…ç½® influxdb</li>
</ol>
<p>æ–°å»ºè´¦å·ï¼Œé…ç½® token</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203172000131.png" alt="" /></p>
<ol start="2">
<li>é…ç½® jmeter</li>
</ol>
<p>åœ¨çº¿ç¨‹ç»„å†…æ·»åŠ ä¸€ä¸ªåç«¯æ§åˆ¶å™¨</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203171959109.png" alt="" /></p>
<ol start="3">
<li>åœ¨ influxdb UI æŸ¥çœ‹ç»“æœ</li>
</ol>
<p>å¯ä»¥é€šè¿‡é€”ä¸­çš„å¯è§†åŒ–ç•Œé¢é€‰æ‹©ï¼Œä¹Ÿå¯ä»¥è½¬æ¢ä¸º Flux æŸ¥è¯¢è¯­å¥</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203171957424.png" alt="" /></p>
<h2 id="gafana"><a class="header" href="#gafana">gafana</a></h2>
<h3 id="è¿æ¥-prometheus"><a class="header" href="#è¿æ¥-prometheus">è¿æ¥ prometheus</a></h3>
<ol>
<li>é…ç½®æ•°æ®æº</li>
<li>æ·»åŠ æŸ¥è¯¢è¯­å¥ (promQL)</li>
<li>é€‰æ‹©åˆé€‚çš„å›¾æ ‡ç±»å‹ï¼Œå®šåˆ¶ä¸€äº›å›¾æ ‡çš„æ ·å¼
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203172108901.png" alt="" /></li>
</ol>
<h3 id="è¿æ¥-influxdb"><a class="header" href="#è¿æ¥-influxdb">è¿æ¥ influxdb</a></h3>
<ol>
<li>é…ç½®æ•°æ®æº æ³¨æ„ urlï¼Œè¿™ä¸ª url éœ€è¦æ˜¯ docker çš„ï¼Œä¸æ˜¯æœ¬æœºçš„<code>http://172.20.0.5:8086</code></li>
</ol>
<pre><code>docker container inspect f65 | grep -i ipaddress
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203172005301.png" alt="" /></p>
<ol start="2">
<li>å¯¼å…¥æŸ¥è¯¢è¯­å¥ (Flux)</li>
</ol>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203172003871.png" alt="" /></p>
<h3 id="å‚è€ƒ-6"><a class="header" href="#å‚è€ƒ-6">å‚è€ƒ</a></h3>
<ul>
<li><a href="https://docs.influxdata.com/influxdb/v2.1/tools/grafana/">Use Grafana with InfluxDB OSS</a></li>
<li><a href="https://qainsights.com/jmeter-integration-with-influxdb-2-0/#Grafana_Integration">jmeter + influxdb + grafuna</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oci-è§„èŒƒ"><a class="header" href="#oci-è§„èŒƒ">OCI è§„èŒƒ</a></h1>
<h2 id="è¿è¡Œæ—¶è§„èŒƒ"><a class="header" href="#è¿è¡Œæ—¶è§„èŒƒ">è¿è¡Œæ—¶è§„èŒƒ</a></h2>
<h3 id="å®¹å™¨æ ¼å¼"><a class="header" href="#å®¹å™¨æ ¼å¼">å®¹å™¨æ ¼å¼</a></h3>
<p>ä¸€ä¸ªæ ‡å‡†çš„ container bundle åŒ…å«åŠ è½½å’Œè¿è¡Œå®¹å™¨æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬</p>
<ol>
<li>
<p><code>config.json</code>: åŒ…å«é…ç½®æ•°æ®</p>
</li>
<li>
<p><code>rootfs</code>: å®¹å™¨çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ</p>
<p><code>config.json</code>ä¸­çš„<code>route.path</code>å­—æ®µæŒ‡å®šï¼Œé»˜è®¤ä¸º<code>rootfs</code></p>
</li>
</ol>
<h3 id="è¿è¡Œæ—¶å’Œç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#è¿è¡Œæ—¶å’Œç”Ÿå‘½å‘¨æœŸ">è¿è¡Œæ—¶å’Œç”Ÿå‘½å‘¨æœŸ</a></h3>
<h4 id="çŠ¶æ€"><a class="header" href="#çŠ¶æ€">çŠ¶æ€</a></h4>
<p>åŒ…å«ä»¥ä¸‹å±æ€§</p>
<ul>
<li>
<p>ociVersion(string, REQUIRED): éµå®ˆçš„ OCI è¿è¡Œæ—¶è§„èŒƒè§„èŒƒçš„ç‰ˆæœ¬ã€‚</p>
</li>
<li>
<p>id(string, REQUIRED): æ˜¯å®¹å™¨çš„ ID. è¿™åœ¨æ­¤ä¸»æœºä¸Šçš„æ‰€æœ‰å®¹å™¨ä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚ä¸è¦æ±‚å®ƒåœ¨ä¸»æœºä¹‹é—´æ˜¯å”¯ä¸€çš„ã€‚</p>
</li>
<li>
<p>status(string, REQUIRED): æ˜¯å®¹å™¨çš„è¿è¡Œæ—¶çŠ¶æ€ã€‚è¯¥å€¼å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š</p>
<ul>
<li>creatingï¼šæ­£åœ¨åˆ›å»ºå®¹å™¨ï¼ˆç”Ÿå‘½å‘¨æœŸä¸­çš„ç¬¬ 2 æ­¥ï¼‰</li>
<li>created: è¿è¡Œæ—¶å·²ç»å®Œæˆåˆ›å»ºæ“ä½œï¼ˆç”Ÿå‘½å‘¨æœŸç¬¬ 2 æ­¥ä¹‹åï¼‰,å®¹å™¨è¿›ç¨‹æ—¢æ²¡æœ‰é€€å‡ºä¹Ÿæ²¡æœ‰æ‰§è¡Œç”¨æˆ·æŒ‡å®šçš„ç¨‹åº</li>
<li>running: å®¹å™¨è¿›ç¨‹å·²ç»æ‰§è¡Œäº†ç”¨æˆ·æŒ‡å®šçš„ç¨‹åºä½†è¿˜æ²¡æœ‰é€€å‡ºï¼ˆåœ¨ç”Ÿå‘½å‘¨æœŸçš„ç¬¬ 8 æ­¥ä¹‹åï¼‰</li>
<li>stoppedï¼šå®¹å™¨è¿›ç¨‹å·²é€€å‡ºï¼ˆç”Ÿå‘½å‘¨æœŸä¸­çš„ç¬¬ 10 æ­¥ï¼‰é™„åŠ å€¼å¯ä»¥ç”±è¿è¡Œæ—¶å®šä¹‰ï¼Œä½†æ˜¯ï¼Œå®ƒä»¬å¿…é¡»ç”¨äºè¡¨ç¤ºä¸Šé¢æœªå®šä¹‰çš„æ–°è¿è¡Œæ—¶çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>
<p>pid(int, REQUIRED when status is created or running on Linux, OPTIONAL åœ¨å…¶ä»–å¹³å°)
æ˜¯å®¹å™¨è¿›ç¨‹çš„ IDã€‚å¯¹äºåœ¨è¿è¡Œæ—¶å‘½åç©ºé—´ä¸­æ‰§è¡Œçš„é’©å­ï¼Œå®ƒæ˜¯è¿è¡Œæ—¶çœ‹åˆ°çš„ pidã€‚å¯¹äºåœ¨å®¹å™¨å‘½åç©ºé—´ä¸­æ‰§è¡Œçš„é’©å­ï¼Œå®ƒæ˜¯å®¹å™¨çœ‹åˆ°çš„ pidã€‚</p>
</li>
<li>
<p>bundle(string, REQUIRED) æ˜¯å®¹å™¨åŒ…ç›®å½•çš„ç»å¯¹è·¯å¾„ã€‚è¿™æ˜¯ä¸ºäº†å¯ä»¥åœ¨ä¸»æœºä¸Šæ‰¾åˆ°å®¹å™¨çš„é…ç½®å’Œæ ¹æ–‡ä»¶ç³»ç»Ÿã€‚</p>
</li>
<li>
<p>annotations(map, OPTIONAL) åŒ…å«ä¸å®¹å™¨å…³è”çš„æ³¨é‡Šåˆ—è¡¨ã€‚å¦‚æœæœªæä¾›æ³¨é‡Šï¼Œåˆ™æ­¤å±æ€§å¯èƒ½ä¸å­˜åœ¨æˆ–ä¸ºç©ºæ˜ å°„ã€‚</p>
</li>
</ul>
<p>åœ¨ json åºåˆ—åŒ–ä¸­å¿…é¡»è¡¨ç°ä¸º</p>
<pre><code class="language-json">{
    &quot;ociVersion&quot;ï¼š&quot;0.2.0&quot;,
    &quot;id&quot;ï¼š&quot;oci-container1&quot;,
    &quot;status&quot;ï¼š&quot;running&quot;,
    &quot;pid&quot;ï¼š4422,
    &quot;bundle&quot;ï¼š&quot;/containers/redis&quot;,
    &quot;annotations&quot;: {
        &quot;æˆ‘çš„é’¥åŒ™&quot;ï¼š&quot;æˆ‘çš„ä»·å€¼&quot;
    }
}
</code></pre>
<h4 id="ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#ç”Ÿå‘½å‘¨æœŸ">ç”Ÿå‘½å‘¨æœŸ</a></h4>
<ol>
<li><strong>è°ƒç”¨ create</strong>,æŒ‡å®š ID å’Œ bundle è·¯å¾„</li>
<li>è¿è¡Œæ—¶å¿…é¡»æ ¹æ®<code>config.json</code>åˆ›å»ºå®¹å™¨çš„è¿è¡Œç¯å¢ƒã€‚
<ul>
<li>å¦‚æœåˆ›å»ºå¤±è´¥å¿…é¡»æŠ›å‡ºé”™è¯¯ã€‚</li>
<li>å½“<code>config.json</code>ä¸­è§„å®šçš„èµ„æºæ­£åœ¨è¢«åˆ›å»ºæ—¶ï¼Œç”¨æˆ·å®šä¹‰çš„è¡Œä¸ºä¸€å®šä¸èƒ½è¢«æ‰§è¡Œã€‚</li>
<li>ä¹‹åå¯¹<code>config.json</code>çš„æ›´æ–°ä¸ä¼šå½±å“åˆ°å®¹å™¨ã€‚</li>
</ul>
</li>
<li>è°ƒç”¨<code>prestart hooks</code>.(å·²ç»å¼ƒç”¨ï¼Œè¢« 457 ä»£æ›¿)</li>
<li>è°ƒç”¨<code>createRuntime hooks</code></li>
<li>è°ƒç”¨<code>createContainer hooks</code></li>
<li><strong>è°ƒç”¨ start</strong>, æŒ‡å®šå®¹å™¨ ID</li>
<li>è°ƒç”¨<code>startContainer hooks</code></li>
<li>è¿è¡Œæ—¶è¿è¡Œç”¨æˆ·æŒ‡å®šçš„è¿›ç¨‹</li>
<li>è°ƒç”¨<code>postStart hooks</code>(warning if failed)</li>
<li>å®¹å™¨è¿›ç¨‹é€€å‡ºã€‚è¿™å¯èƒ½æ˜¯ç”±äºå‡ºé”™ã€é€€å‡ºã€å´©æºƒæˆ–è¿è¡Œæ—¶çš„ kill æ“ä½œè¢«è°ƒç”¨è€Œå‘ç”Ÿã€‚</li>
<li><strong>è°ƒç”¨ delete</strong></li>
<li>é€šè¿‡æ’¤é”€åœ¨æ­¥éª¤ 2 ä¸­çš„æ“ä½œæ¥é”€æ¯å®¹å™¨</li>
<li>è°ƒç”¨<code>postStop hooks</code>(warning if failed)</li>
</ol>
<p>ä¸Šè¿°é’©å­é™¤äº† 9ã€13 å¤–ï¼Œå¦‚æœè°ƒç”¨å¤±è´¥ï¼Œè¿è¡Œæ—¶å¿…é¡»æŠ›å‡ºé”™è¯¯ï¼Œåœæ­¢å®¹å™¨ï¼Œæ‰§è¡Œç¬¬ 12 æ­¥</p>
<h4 id="å¯¹äº-linux-ç³»ç»Ÿçš„ç‰¹æ®Šé…ç½®"><a class="header" href="#å¯¹äº-linux-ç³»ç»Ÿçš„ç‰¹æ®Šé…ç½®">å¯¹äº linux ç³»ç»Ÿçš„ç‰¹æ®Šé…ç½®</a></h4>
<p><strong>æ–‡ä»¶æè¿°ç¬¦</strong> é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶åªä¼šå°†<code>stdin, stdout and stderr</code>çš„æ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºå¼€å¯çŠ¶æ€</p>
<p>è¿è¡Œæ—¶å¯ä»¥ä¼ é€’é¢å¤–çš„æè¿°ç¬¦å»æ”¯æŒ socket ç­‰åŠŸèƒ½</p>
<p>ä¸€äº›æè¿°ç¬¦å¯èƒ½ä¼šè¢«é‡å®šå‘åˆ°<code>/dev/null</code> <strong>Dev symbolic links</strong> åœ¨ç”Ÿå‘½å‘¨æœŸçš„ç¬¬äºŒæ­¥ä¸­ï¼Œå½“ mount
è¿‡ç¨‹ç»“æŸå¦‚æœä¸‹é¢çš„æ–‡ä»¶å­˜åœ¨ï¼Œå°±è¦åˆ›å»ºå¯¹åº”çš„<code>symlinks</code></p>
<pre><code>Source	Destination
/proc/self/fd	/dev/fd
/proc/self/fd/0	/dev/stdin
/proc/self/fd/1	/dev/stdout
/proc/self/fd/2	/dev/stderr
</code></pre>
<h3 id="é…ç½®æ–‡ä»¶-1"><a class="header" href="#é…ç½®æ–‡ä»¶-1">é…ç½®æ–‡ä»¶</a></h3>
<h4 id="oci-ç‰ˆæœ¬"><a class="header" href="#oci-ç‰ˆæœ¬">OCI ç‰ˆæœ¬</a></h4>
<pre><code class="language-json">&quot;ociVersion&quot;: &quot;0.1.0&quot;
</code></pre>
<h4 id="root"><a class="header" href="#root">ROOT</a></h4>
<pre><code class="language-json">&quot;root&quot;: {
    &quot;path&quot;: &quot;rootfs&quot;,
    &quot;readonly&quot;: true
}
</code></pre>
<h4 id="mounts"><a class="header" href="#mounts">Mounts</a></h4>
<p>æŒ‡å®šäº† root ä¹‹å¤–çš„å…¶ä»–æŒ‚è½½ç‚¹</p>
<ul>
<li>type: linux ä¸“æœ‰ï¼Œæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼Œæ¯”å¦‚ ext4 ç­‰</li>
<li>options: å¯é€‰ï¼Œman page ä¸­ mount éƒ¨åˆ†è§„å®š</li>
</ul>
<pre><code class="language-json">&quot;mounts&quot;: [
    {
        &quot;destination&quot;: &quot;/tmp&quot;,
        &quot;type&quot;: &quot;tmpfs&quot;,
        &quot;source&quot;: &quot;tmpfs&quot;,
        &quot;options&quot;: [&quot;nosuid&quot;,&quot;strictatime&quot;,&quot;mode=755&quot;,&quot;size=65536k&quot;]
    },
    {
        &quot;destination&quot;: &quot;/data&quot;,
        &quot;type&quot;: &quot;none&quot;,
        &quot;source&quot;: &quot;/volumes/testing&quot;,
        &quot;options&quot;: [&quot;rbind&quot;,&quot;rw&quot;]
    }
]
</code></pre>
<h4 id="process"><a class="header" href="#process">Process</a></h4>
<p>æŒ‡å®šå®¹å™¨è¿è¡Œçš„è¿›ç¨‹çš„å‚æ•°</p>
<p><strong>é€šç”¨</strong></p>
<ul>
<li>terminal (bool, OPTIONAL): æ˜¯å¦ä¸ºè¿›ç¨‹åˆ†é…ä¸€ä¸ªä¸ºç»ˆç«¯</li>
<li>consoleSize (object, OPTIONAL): ç»ˆç«¯çš„å¤§å°
<ul>
<li>height (uint, REQUIRED)</li>
<li>width (uint, REQUIRED)</li>
</ul>
</li>
<li>cwd (string, REQUIRED): è¿›ç¨‹è¿è¡Œæ‰€åœ¨çš„æ ¹ç›®å½•</li>
<li>env (array of strings, OPTIONAL): ç¯å¢ƒå˜é‡</li>
<li>args (array of strings, OPTIONAL): è¿›ç¨‹è¿è¡Œéœ€è¦çš„å‚æ•°</li>
</ul>
<p><strong>POSIX</strong></p>
<ul>
<li>rlimits (array of objects, OPTIONAL) : å¯ä»¥ä¸ºè¿›ç¨‹è®¾ç½®èµ„æºé™åˆ¶ï¼Œæœ‰æ•ˆå€¼åœ¨ man page getrlimit(2)
<ul>
<li>type(string, REQUIRED) linux æˆ– solaris</li>
<li>soft(uint64, REQUIRED) å¯¹ç›¸åº”èµ„æºå®æ–½çš„é™åˆ¶å€¼ã€‚rlim.rlim_cur å¿…é¡»åŒ¹é…é…ç½®çš„å€¼ã€‚</li>
<li>hard(uint64, REQUIRED) å¯ä»¥ç”±éç‰¹æƒè¿›ç¨‹è®¾ç½®çš„è½¯é™åˆ¶çš„ä¸Šé™ã€‚rlim.rlim_max å¿…é¡»åŒ¹é…é…ç½®çš„å€¼ã€‚åªæœ‰ç‰¹æƒè¿›ç¨‹ï¼ˆä¾‹å¦‚æœ‰
CAP_SYS_RESOURCE èƒ½åŠ›çš„è¿›ç¨‹ï¼‰æ‰èƒ½æé«˜ç¡¬é™åˆ¶ã€‚</li>
</ul>
</li>
<li>user
<ul>
<li>uid(int, REQUIRED) æŒ‡å®šå®¹å™¨å‘½åç©ºé—´ä¸­çš„ç”¨æˆ· IDã€‚</li>
<li>gid(int, REQUIRED) æŒ‡å®šå®¹å™¨å‘½åç©ºé—´ä¸­çš„ç»„ IDã€‚</li>
<li>umask(int, OPTIONAL) æŒ‡å®šç”¨æˆ·çš„ umask</li>
<li>additionalGidsï¼ˆæ•´æ•°æ•°ç»„ï¼Œå¯é€‰ï¼‰æŒ‡å®šè¦æ·»åŠ åˆ°è¿›ç¨‹çš„å®¹å™¨å‘½åç©ºé—´ä¸­çš„å…¶ä»–ç»„ IDã€‚</li>
</ul>
</li>
</ul>
<p><strong>Linux</strong></p>
<ul>
<li>apparmorProfileï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰ä¸çŸ¥</li>
<li>capabilities(object, OPTIONAL) æ˜¯ä¸€ä¸ªåŒ…å«æ•°ç»„çš„å¯¹è±¡ï¼Œåˆ¶å®šäº†ä¸€ä¸ªè¿›ç¨‹æ‹¥æœ‰çš„èƒ½åŠ›
<ul>
<li>effectiveï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯é€‰ï¼‰è¯¥ effective å­—æ®µæ˜¯ä¸ºæµç¨‹ä¿ç•™çš„æœ‰æ•ˆåŠŸèƒ½æ•°ç»„ã€‚</li>
<li>boundingï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯é€‰ï¼‰è¯¥ bounding å­—æ®µæ˜¯ä¸ºè¿›ç¨‹ä¿ç•™çš„è¾¹ç•Œèƒ½åŠ›æ•°ç»„ã€‚</li>
<li>inheritableï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯é€‰ï¼‰è¯¥ inheritable å­—æ®µæ˜¯ä¸ºè¿›ç¨‹ä¿ç•™çš„å¯ç»§æ‰¿åŠŸèƒ½æ•°ç»„ã€‚</li>
<li>permittedï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯é€‰ï¼‰è¯¥ permitted å­—æ®µæ˜¯ä¸ºè¿›ç¨‹ä¿ç•™çš„å…è®¸åŠŸèƒ½çš„æ•°ç»„ã€‚</li>
<li>ambientï¼ˆå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¯é€‰ï¼‰è¯¥ ambient å­—æ®µæ˜¯ä¸ºè¿›ç¨‹ä¿ç•™çš„ç¯å¢ƒåŠŸèƒ½æ•°ç»„ã€‚</li>
</ul>
</li>
<li>noNewPrivileges(bool, OPTIONAL) è®¾ç½® noNewPrivileges ä¸º true å¯ä»¥é˜²æ­¢è¿›ç¨‹è·å¾—é¢å¤–çš„æƒé™ã€‚</li>
<li>oomScoreAdj (int, OPTIONAL) ä¸çŸ¥</li>
<li>selinuxLabel(string, OPTIONAL) ä¸çŸ¥</li>
</ul>
<pre><code class="language-json">&quot;process&quot;: {
    &quot;terminal&quot;: true,
    &quot;consoleSize&quot;: {
        &quot;height&quot;: 25,
        &quot;width&quot;: 80
    },
    &quot;user&quot;: {
        &quot;uid&quot;: 1,
        &quot;gid&quot;: 1,
        &quot;umask&quot;: 63,
        &quot;additionalGids&quot;: [5, 6]
    },
    &quot;env&quot;: [
        &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,
        &quot;TERM=xterm&quot;
    ],
    &quot;cwd&quot;: &quot;/root&quot;,
    &quot;args&quot;: [
        &quot;sh&quot;
    ],
    &quot;apparmorProfile&quot;: &quot;acme_secure_profile&quot;,
    &quot;selinuxLabel&quot;: &quot;system_u:system_r:svirt_lxc_net_t:s0:c124,c675&quot;,
    &quot;noNewPrivileges&quot;: true,
    &quot;capabilities&quot;: {
        &quot;bounding&quot;: [
            &quot;CAP_AUDIT_WRITE&quot;,
            &quot;CAP_KILL&quot;,
            &quot;CAP_NET_BIND_SERVICE&quot;
        ],
       &quot;permitted&quot;: [
            &quot;CAP_AUDIT_WRITE&quot;,
            &quot;CAP_KILL&quot;,
            &quot;CAP_NET_BIND_SERVICE&quot;
        ],
       &quot;inheritable&quot;: [
            &quot;CAP_AUDIT_WRITE&quot;,
            &quot;CAP_KILL&quot;,
            &quot;CAP_NET_BIND_SERVICE&quot;
        ],
        &quot;effective&quot;: [
            &quot;CAP_AUDIT_WRITE&quot;,
            &quot;CAP_KILL&quot;
        ],
        &quot;ambient&quot;: [
            &quot;CAP_NET_BIND_SERVICE&quot;
        ]
    },
    &quot;rlimits&quot;: [
        {
            &quot;type&quot;: &quot;RLIMIT_NOFILE&quot;,
            &quot;hard&quot;: 1024,
            &quot;soft&quot;: 1024
        }
    ]
}
</code></pre>
<h4 id="hostname"><a class="header" href="#hostname">Hostname</a></h4>
<p>å®¹å™¨çœ‹åˆ°çš„ä¸»æœºå</p>
<pre><code class="language-json">&quot;hostname&quot;ï¼š&quot;mrsdalloway&quot;
</code></pre>
<h4 id="ç‰¹å®šä¸-linux-å¹³å°çš„é…ç½®"><a class="header" href="#ç‰¹å®šä¸-linux-å¹³å°çš„é…ç½®">ç‰¹å®šä¸ linux å¹³å°çš„é…ç½®</a></h4>
<pre><code class="language-json">&quot;linux&quot;: {
    &quot;namespaces&quot;: [
        {
            &quot;type&quot;: &quot;pid&quot;
        }
    ]
}
</code></pre>
<h4 id="hooks"><a class="header" href="#hooks">Hooks</a></h4>
<ul>
<li>prestartï¼ˆå·²å¼ƒç”¨ï¼‰</li>
<li>createRuntime: åœ¨åˆ›å»ºè¿è¡Œæ—¶ç¯å¢ƒä¹‹åä½†æ˜¯åœ¨ pivot_root æˆ–ä»»ä½•ç­‰æ•ˆæ“ä½œä¹‹å‰ã€‚</li>
<li>createContainer: åŒä¸Šï¼Œä¸€èˆ¬åœ¨ mount ä¹‹åï¼Œpivot_root ä¹‹å‰</li>
<li>startContainer: å®¹å™¨å¯åŠ¨åï¼Œè¿è¡Œç”¨æˆ·è¿›ç¨‹ä¹‹å‰</li>
<li>poststart: è¿è¡Œç”¨æˆ·è¿›ç¨‹ä¹‹åï¼Œæ“ä½œè¿”å›ä¹‹å‰ã€‚</li>
<li>poststop: å®¹å™¨è¢«åˆ é™¤ä¹‹åï¼Œåˆ é™¤æ“ä½œè¿”å›ä¹‹å‰ã€‚</li>
</ul>
<pre><code class="language-json">&quot;hooks&quot;: {
    &quot;prestart&quot;: [
        {
            &quot;path&quot;: &quot;/usr/bin/fix-mounts&quot;,
            &quot;args&quot;: [&quot;fix-mounts&quot;, &quot;arg1&quot;, &quot;arg2&quot;],
            &quot;env&quot;:  [ &quot;key1=value1&quot;]
        },
        {
            &quot;path&quot;: &quot;/usr/bin/setup-network&quot;
        }
    ],
    &quot;createRuntime&quot;: [
        {
            &quot;path&quot;: &quot;/usr/bin/fix-mounts&quot;,
            &quot;args&quot;: [&quot;fix-mounts&quot;, &quot;arg1&quot;, &quot;arg2&quot;],
            &quot;env&quot;:  [ &quot;key1=value1&quot;]
        },
        {
            &quot;path&quot;: &quot;/usr/bin/setup-network&quot;
        }
    ],
    &quot;createContainer&quot;: [
        {
            &quot;path&quot;: &quot;/usr/bin/mount-hook&quot;,
            &quot;args&quot;: [&quot;-mount&quot;, &quot;arg1&quot;, &quot;arg2&quot;],
            &quot;env&quot;:  [ &quot;key1=value1&quot;]
        }
    ],
    &quot;startContainer&quot;: [
        {
            &quot;path&quot;: &quot;/usr/bin/refresh-ldcache&quot;
        }
    ],
    &quot;poststart&quot;: [
        {
            &quot;path&quot;: &quot;/usr/bin/notify-start&quot;,
            &quot;timeout&quot;: 5
        }
    ],
    &quot;poststop&quot;: [
        {
            &quot;path&quot;: &quot;/usr/sbin/cleanup.sh&quot;,
            &quot;args&quot;: [&quot;cleanup.sh&quot;, &quot;-f&quot;]
        }
    ]
}
</code></pre>
<h2 id="linux-å®¹å™¨é…ç½®"><a class="header" href="#linux-å®¹å™¨é…ç½®">linux å®¹å™¨é…ç½®</a></h2>
<h3 id="é»˜è®¤æ–‡ä»¶ç³»ç»Ÿ"><a class="header" href="#é»˜è®¤æ–‡ä»¶ç³»ç»Ÿ">é»˜è®¤æ–‡ä»¶ç³»ç»Ÿ</a></h3>
<p><code>Linux ABI</code>åŒ…å«ç³»ç»Ÿè°ƒç”¨å’Œä¸€äº›ç‰¹æ®Šçš„æ–‡ä»¶è·¯å¾„ï¼Œä¸‹é¢çš„æ–‡ä»¶è·¯å¾„åº”è¯¥æ˜¯å¯ç”¨çš„ |Path |	Type| | ---- | --- | |/proc
|proc| |/sys	 |sysfs| |/dev/pts|	devpts| |/dev/shm|	tmpfs|</p>
<h3 id="å‘½åç©ºé—´"><a class="header" href="#å‘½åç©ºé—´">å‘½åç©ºé—´</a></h3>
<ul>
<li>
<p>type (string, REQUIRED) - å‘½åç©ºé—´ç±»å‹ã€‚åº”è¯¥æ”¯æŒä»¥ä¸‹å‘½åç©ºé—´ç±»å‹ï¼š</p>
<ul>
<li>pid: å®¹å™¨å†…çš„è¿›ç¨‹å°†åªèƒ½çœ‹åˆ°åŒä¸€å®¹å™¨å†…æˆ–åŒä¸€ pid å‘½åç©ºé—´å†…çš„å…¶ä»–è¿›ç¨‹ã€‚</li>
<li>network: å®¹å™¨å°†æœ‰è‡ªå·±çš„ç½‘ç»œå †æ ˆã€‚</li>
<li>mount: å®¹å™¨å°†æœ‰ä¸€ä¸ªéš”ç¦»çš„å®‰è£…è¡¨ã€‚</li>
<li>ipc: å®¹å™¨å†…çš„è¿›ç¨‹å°†åªèƒ½é€šè¿‡ç³»ç»Ÿçº§ IPC ä¸åŒä¸€å®¹å™¨å†…çš„å…¶ä»–è¿›ç¨‹é€šä¿¡ã€‚</li>
<li>uts: å®¹å™¨å°†èƒ½å¤Ÿæ‹¥æœ‰è‡ªå·±çš„ä¸»æœºåå’ŒåŸŸåã€‚</li>
<li>user: å®¹å™¨å°†èƒ½å¤Ÿå°†ç”¨æˆ·å’Œç»„ ID ä»ä¸»æœºé‡æ–°æ˜ å°„åˆ°å®¹å™¨å†…çš„æœ¬åœ°ç”¨æˆ·å’Œç»„ã€‚</li>
<li>cgroup: å®¹å™¨å°†å…·æœ‰ cgroup å±‚æ¬¡ç»“æ„çš„éš”ç¦»è§†å›¾ã€‚</li>
</ul>
</li>
<li>
<p>path (string, OPTIONAL) - å‘½åç©ºé—´æ–‡ä»¶è·¯å¾„ã€‚æ­¤å€¼å¿…é¡»æ˜¯è¿è¡Œæ—¶æŒ‚è½½å‘½åç©ºé—´ä¸­çš„ç»å¯¹è·¯å¾„ã€‚</p>
<p>å¦‚æœ path æœªæŒ‡å®šï¼Œè¿è¡Œæ—¶å¿…é¡»åˆ›å»ºä¸€ä¸ªç±»å‹ä¸º çš„æ–°å®¹å™¨å‘½åç©ºé—´ typeã€‚</p>
</li>
</ul>
<pre><code class="language-json">&quot;namespaces&quot;: [
    {
        &quot;type&quot;: &quot;pid&quot;,
        &quot;path&quot;: &quot;/proc/1234/ns/pid&quot;
    },
    {
        &quot;type&quot;: &quot;network&quot;,
        &quot;path&quot;: &quot;/var/run/netns/neta&quot;
    },
    {
        &quot;type&quot;: &quot;mount&quot;
    },
    {
        &quot;type&quot;: &quot;ipc&quot;
    },
    {
        &quot;type&quot;: &quot;uts&quot;
    },
    {
        &quot;type&quot;: &quot;user&quot;
    },
    {
        &quot;type&quot;: &quot;cgroup&quot;
    }
]
</code></pre>
<h3 id="ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„"><a class="header" href="#ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„">ç”¨æˆ·å‘½åç©ºé—´æ˜ å°„</a></h3>
<ul>
<li>
<p>uidMappingsï¼ˆå¯¹è±¡æ•°ç»„ï¼Œå¯é€‰ï¼‰æè¿°ä»ä¸»æœºåˆ°å®¹å™¨çš„ç”¨æˆ·å‘½åç©ºé—´ uid æ˜ å°„ã€‚</p>
<p>æ¯ä¸ªæ¡ç›®å…·æœ‰ä»¥ä¸‹ç»“æ„ï¼š</p>
<ul>
<li>containerID (uint32, REQUIRED) - æ˜¯å®¹å™¨ä¸­çš„èµ·å§‹ uid/gidã€‚</li>
<li>hostID (uint32, REQUIRED) - æ˜¯ä¸»æœºä¸Šè¦æ˜ å°„åˆ° containerID çš„èµ·å§‹ uid/gidã€‚</li>
<li>size (uint32, REQUIRED) - æ˜¯è¦æ˜ å°„çš„ id æ•°ã€‚</li>
</ul>
</li>
</ul>
<p>è¿è¡Œæ—¶ä¸åº”è¯¥ä¿®æ”¹å¼•ç”¨æ–‡ä»¶ç³»ç»Ÿçš„æ‰€æœ‰æƒæ¥å®ç°æ˜ å°„ã€‚è¯·æ³¨æ„ï¼Œæ˜ å°„æ¡ç›®çš„æ•°é‡å¯èƒ½å—å†…æ ¸é™åˆ¶ã€‚</p>
<pre><code class="language-json">&quot;uidMappings&quot;: [
    {
        &quot;containerID&quot;: 0,
        &quot;hostID&quot;: 1000,
        &quot;size&quot;: 32000
    }
],
&quot;gidMappings&quot;: [
    {
        &quot;containerID&quot;: 0,
        &quot;hostID&quot;: 1000,
        &quot;size&quot;: 32000
    }
]
</code></pre>
<h3 id="è®¾å¤‡"><a class="header" href="#è®¾å¤‡">è®¾å¤‡</a></h3>
<ul>
<li>devicesï¼ˆå¯¹è±¡æ•°ç»„ï¼Œå¯é€‰ï¼‰åˆ—å‡ºå®¹å™¨ä¸­å¿…é¡»å¯ç”¨çš„è®¾å¤‡ã€‚è¿è¡Œæ—¶å¯ä»¥æ ¹æ®è‡ªå·±çš„å–œå¥½æä¾›å®ƒä»¬ï¼ˆmknod é€šè¿‡ä»è¿è¡Œæ—¶æŒ‚è½½å‘½åç©ºé—´ç»‘å®šæŒ‚è½½ï¼Œä½¿ç”¨ç¬¦å·é“¾æ¥ç­‰ï¼‰ã€‚
<ul>
<li>type (string, REQUIRED) - è®¾å¤‡ç±»å‹ï¼šc, b,u æˆ– p. å‚è€ƒ mknod(1)</li>
<li>path (string, REQUIRED) - å®¹å™¨å†…è®¾å¤‡çš„å®Œæ•´è·¯å¾„ã€‚å¦‚æœå·²ç»å­˜åœ¨ä¸è¯·æ±‚çš„è®¾å¤‡ä¸åŒ¹é…çš„æ–‡ä»¶ï¼Œåˆ™è¿è¡Œæ—¶å¿…é¡»ç”Ÿæˆé”™è¯¯ã€‚</li>
<li>major, minor (int64, REQUIRED unless type is p) - è®¾å¤‡çš„ä¸»è¦ã€æ¬¡è¦ç¼–å·ã€‚</li>
<li>fileMode (uint32, OPTIONAL) - è®¾å¤‡çš„æ–‡ä»¶æ¨¡å¼ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<code>cgroups</code>æ§åˆ¶å¯¹è®¾å¤‡çš„è®¿é—®ã€‚</li>
<li>uidï¼ˆuint32ï¼Œå¯é€‰ï¼‰- å®¹å™¨å‘½åç©ºé—´ä¸­è®¾å¤‡æ‰€æœ‰è€…çš„ IDã€‚</li>
<li>gid (uint32, OPTIONAL) -å®¹å™¨å‘½åç©ºé—´ä¸­è®¾å¤‡ç»„çš„ idã€‚</li>
</ul>
</li>
</ul>
<p>ç›¸åŒ typeï¼Œmajor å¹¶ä¸” minor ä¸åº”è¯¥ç”¨äºå¤šä¸ªè®¾å¤‡ã€‚</p>
<pre><code class="language-json">&quot;devices&quot;: [
    {
        &quot;path&quot;: &quot;/dev/fuse&quot;,
        &quot;type&quot;: &quot;c&quot;,
        &quot;major&quot;: 10,
        &quot;minor&quot;: 229,
        &quot;fileMode&quot;: 438,
        &quot;uid&quot;: 0,
        &quot;gid&quot;: 0
    },
    {
        &quot;path&quot;: &quot;/dev/sda&quot;,
        &quot;type&quot;: &quot;b&quot;,
        &quot;major&quot;: 8,
        &quot;minor&quot;: 0,
        &quot;fileMode&quot;: 432,
        &quot;uid&quot;: 0,
        &quot;gid&quot;: 0
    }
]
</code></pre>
<h4 id="é»˜è®¤è®¾å¤‡"><a class="header" href="#é»˜è®¤è®¾å¤‡">é»˜è®¤è®¾å¤‡</a></h4>
<pre><code>/dev/null
/dev/zero
/dev/full
/dev/random
/dev/urandom
/dev/tty
/dev/console is set up if terminal is enabled in the config by bind mounting the pseudoterminal pty to /dev/console.
/dev/ptmx. A bind-mount or symlink of the container's /dev/pts/ptmx.
</code></pre>
<h4 id="æ§åˆ¶ç»„-control-groups"><a class="header" href="#æ§åˆ¶ç»„-control-groups">æ§åˆ¶ç»„ (Control groups)</a></h4>
<ul>
<li>cgroupsPath (string, OPTIONAL) cgroups çš„è·¯å¾„</li>
<li>resources
<ul>
<li>
<p>devices: å¯ç”¨è®¾å¤‡åˆ—è¡¨</p>
<ul>
<li>allow (boolean, REQUIRED) - è¾“å…¥æ˜¯å…è®¸è¿˜æ˜¯æ‹’ç»ã€‚</li>
<li>type (string, OPTIONAL) - è®¾å¤‡ç±»å‹ï¼ša(all), c(char), or
b(block)ã€‚æœªè®¾ç½®çš„å€¼è¡¨ç¤ºâ€œå…¨éƒ¨â€ï¼Œæ˜ å°„åˆ° a.</li>
<li>major, minor (int64, OPTIONAL) -è®¾å¤‡çš„ä¸»è¦ã€æ¬¡è¦ç¼–å·ã€‚æœªè®¾ç½®çš„å€¼è¡¨ç¤ºâ€œå…¨éƒ¨â€ï¼Œæ˜ å°„åˆ°*æ–‡ä»¶ç³»ç»Ÿ API ä¸­ã€‚</li>
<li>accessï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰- è®¾å¤‡çš„ cgroup æƒé™ã€‚r(read)ã€w(write) å’Œ m(mknod) çš„ç»„åˆã€‚</li>
</ul>
</li>
<li>
<p>memory: å†…å­˜</p>
<ul>
<li>limit (int64, OPTIONAL) - è®¾ç½®å†…å­˜ä½¿ç”¨é™åˆ¶</li>
<li>reservation (int64, OPTIONAL) - è®¾ç½®å†…å­˜ä½¿ç”¨çš„è½¯é™åˆ¶</li>
<li>swap (int64, OPTIONAL) - è®¾ç½®å†…å­˜ + äº¤æ¢ä½¿ç”¨é™åˆ¶</li>
<li>kernel (int64, OPTIONAL, NOT RECOMMENDED) - è®¾ç½®å†…æ ¸å†…å­˜çš„ç¡¬é™åˆ¶</li>
<li>kernelTCP (int64, OPTIONAL, NOT RECOMMENDED) - è®¾ç½®å†…æ ¸ TCP ç¼“å†²å†…å­˜çš„ç¡¬é™åˆ¶</li>
</ul>
<p>ä»¥ä¸‹å±æ€§ä¸æŒ‡å®šå†…å­˜é™åˆ¶ï¼Œä½†ç”± memory æ§åˆ¶å™¨è¦†ç›–ï¼š</p>
<ul>
<li>swappiness (uint64, OPTIONAL) - è®¾ç½® vmscan çš„ swappiness å‚æ•°ï¼ˆå‚è§ sysctl çš„
vm.swappinessï¼‰å€¼æ˜¯ä» 0 åˆ° 100ã€‚æ›´é«˜æ„å‘³ç€æ›´å¤šçš„ swappyã€‚</li>
<li>disableOOMKiller (bool, OPTIONAL) - è¶…è¿‡å†…å­˜é™åˆ¶çš„è¿›ç¨‹ä¼šè¢«æ€æ­»</li>
<li>useHierarchy (bool, OPTIONAL) - æœªçŸ¥</li>
</ul>
</li>
<li>
<p>cpu: CPU</p>
<ul>
<li>shares (uint64, OPTIONAL) - æŒ‡å®š cgroup ä¸­ä»»åŠ¡å¯ç”¨çš„ CPU æ—¶é—´çš„ç›¸å¯¹ä»½é¢</li>
<li>quota (int64, OPTIONAL) - æŒ‡å®šä¸€ä¸ª cgroup ä¸­çš„æ‰€æœ‰ä»»åŠ¡åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…å¯ä»¥è¿è¡Œçš„æ€»æ—¶é—´ï¼ˆä»¥å¾®ç§’ä¸ºå•ä½ï¼‰ï¼ˆå®šä¹‰
period å¦‚ä¸‹ï¼‰</li>
<li>period (uint64, OPTIONAL) - ä»¥å¾®ç§’ä¸ºå•ä½æŒ‡å®šä¸€ä¸ª cgroup å¯¹ CPU èµ„æºçš„è®¿é—®åº”è¯¥é‡æ–°åˆ†é…çš„é¢‘ç‡ï¼ˆä»…é™ CFS
è°ƒåº¦ç¨‹åºï¼‰</li>
<li>realtimeRuntime (int64, OPTIONAL) - æŒ‡å®š cgroup ä¸­çš„ä»»åŠ¡å¯ä»¥è®¿é—® CPU
èµ„æºçš„æœ€é•¿è¿ç»­æ—¶é—´æ®µï¼ˆä»¥å¾®ç§’ä¸ºå•ä½ï¼‰</li>
<li>realtimePeriod (uint64, OPTIONAL) - ä¸å®æ—¶è°ƒåº¦ç¨‹åºç›¸åŒ period ä½†ä»…é€‚ç”¨äºå®æ—¶è°ƒåº¦ç¨‹åº</li>
<li>cpusï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰- å®¹å™¨å°†åœ¨å…¶ä¸­è¿è¡Œçš„ CPU åˆ—è¡¨</li>
<li>memsï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰- å®¹å™¨å°†åœ¨å…¶ä¸­è¿è¡Œçš„å†…å­˜èŠ‚ç‚¹åˆ—è¡¨</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="language-json">{
&quot;cgroupsPath&quot;: &quot;/myRuntime/myContainer&quot;,
&quot;resources&quot;: {
    &quot;memory&quot;: {
        &quot;limit&quot;: 536870912,
        &quot;reservation&quot;: 536870912,
        &quot;swap&quot;: 536870912,
        &quot;kernel&quot;: -1,
        &quot;kernelTCP&quot;: -1,
        &quot;swappiness&quot;: 0,
        &quot;disableOOMKiller&quot;: false
    },
    &quot;devices&quot;: [
        &quot;devices&quot;: [
            {
                &quot;allow&quot;: false,
                &quot;access&quot;: &quot;rwm&quot;
            },
            {
                &quot;allow&quot;: true,
                &quot;type&quot;: &quot;c&quot;,
                &quot;major&quot;: 10,
                &quot;minor&quot;: 229,
                &quot;access&quot;: &quot;rw&quot;
            },
            {
                &quot;allow&quot;: true,
                &quot;type&quot;: &quot;b&quot;,
                &quot;major&quot;: 8,
                &quot;minor&quot;: 0,
                &quot;access&quot;: &quot;r&quot;
            }
        ]
    ]
}
}
</code></pre>
<h3 id="å…¶ä»–-6"><a class="header" href="#å…¶ä»–-6">å…¶ä»–</a></h3>
<ul>
<li>Block IO ä¸åŒè®¾å¤‡çš„ IO æƒé‡</li>
<li>Network</li>
<li>Huge page limits</li>
<li>PIDs
<ul>
<li>pids è®¾ç½®ä»»åŠ¡æœ€å¤§æ•°é‡
<pre><code class="language-json">&quot;pids&quot;: {
    &quot;limit&quot;: 32771
}
</code></pre>
</li>
</ul>
</li>
<li>RDMA</li>
<li>Unified</li>
<li>IntelRdt</li>
<li>Sysctl: å…è®¸åœ¨å®¹å™¨è¿è¡Œæ—¶ä¿®æ”¹å†…æ ¸å‚æ•°</li>
<li>Seccomp</li>
<li>The Container Process State</li>
<li>Rootfs Mount Propagation</li>
<li>Masked Paths</li>
<li>Readonly Paths</li>
<li>Mount Label</li>
<li>Personality</li>
</ul>
<pre><code class="language-json">&quot;linux&quot;: {
    &quot;devices&quot;: [
        {
            &quot;path&quot;: &quot;/dev/fuse&quot;,
            &quot;type&quot;: &quot;c&quot;,
            &quot;major&quot;: 10,
            &quot;minor&quot;: 229,
            &quot;fileMode&quot;: 438,
            &quot;uid&quot;: 0,
            &quot;gid&quot;: 0
        },
        {
            &quot;path&quot;: &quot;/dev/sda&quot;,
            &quot;type&quot;: &quot;b&quot;,
            &quot;major&quot;: 8,
            &quot;minor&quot;: 0,
            &quot;fileMode&quot;: 432,
            &quot;uid&quot;: 0,
            &quot;gid&quot;: 0
        }
    ],
    &quot;uidMappings&quot;: [
        {
            &quot;containerID&quot;: 0,
            &quot;hostID&quot;: 1000,
            &quot;size&quot;: 32000
        }
    ],
    &quot;gidMappings&quot;: [
        {
            &quot;containerID&quot;: 0,
            &quot;hostID&quot;: 1000,
            &quot;size&quot;: 32000
        }
    ],
    &quot;sysctl&quot;: {
        &quot;net.ipv4.ip_forward&quot;: &quot;1&quot;,
        &quot;net.core.somaxconn&quot;: &quot;256&quot;
    },
    &quot;cgroupsPath&quot;: &quot;/myRuntime/myContainer&quot;,
    &quot;resources&quot;: {
        &quot;network&quot;: {
            &quot;classID&quot;: 1048577,
            &quot;priorities&quot;: [
                {
                    &quot;name&quot;: &quot;eth0&quot;,
                    &quot;priority&quot;: 500
                },
                {
                    &quot;name&quot;: &quot;eth1&quot;,
                    &quot;priority&quot;: 1000
                }
            ]
        },
        &quot;pids&quot;: {
            &quot;limit&quot;: 32771
        },
        &quot;hugepageLimits&quot;: [
            {
                &quot;pageSize&quot;: &quot;2MB&quot;,
                &quot;limit&quot;: 9223372036854772000
            },
            {
                &quot;pageSize&quot;: &quot;64KB&quot;,
                &quot;limit&quot;: 1000000
            }
        ],
        &quot;memory&quot;: {
            &quot;limit&quot;: 536870912,
            &quot;reservation&quot;: 536870912,
            &quot;swap&quot;: 536870912,
            &quot;kernel&quot;: -1,
            &quot;kernelTCP&quot;: -1,
            &quot;swappiness&quot;: 0,
            &quot;disableOOMKiller&quot;: false
        },
        &quot;cpu&quot;: {
            &quot;shares&quot;: 1024,
            &quot;quota&quot;: 1000000,
            &quot;period&quot;: 500000,
            &quot;realtimeRuntime&quot;: 950000,
            &quot;realtimePeriod&quot;: 1000000,
            &quot;cpus&quot;: &quot;2-3&quot;,
            &quot;mems&quot;: &quot;0-7&quot;
        },
        &quot;devices&quot;: [
            {
                &quot;allow&quot;: false,
                &quot;access&quot;: &quot;rwm&quot;
            },
            {
                &quot;allow&quot;: true,
                &quot;type&quot;: &quot;c&quot;,
                &quot;major&quot;: 10,
                &quot;minor&quot;: 229,
                &quot;access&quot;: &quot;rw&quot;
            },
            {
                &quot;allow&quot;: true,
                &quot;type&quot;: &quot;b&quot;,
                &quot;major&quot;: 8,
                &quot;minor&quot;: 0,
                &quot;access&quot;: &quot;r&quot;
            }
        ],
        &quot;blockIO&quot;: {
            &quot;weight&quot;: 10,
            &quot;leafWeight&quot;: 10,
            &quot;weightDevice&quot;: [
                {
                    &quot;major&quot;: 8,
                    &quot;minor&quot;: 0,
                    &quot;weight&quot;: 500,
                    &quot;leafWeight&quot;: 300
                },
                {
                    &quot;major&quot;: 8,
                    &quot;minor&quot;: 16,
                    &quot;weight&quot;: 500
                }
            ],
            &quot;throttleReadBpsDevice&quot;: [
                {
                    &quot;major&quot;: 8,
                    &quot;minor&quot;: 0,
                    &quot;rate&quot;: 600
                }
            ],
            &quot;throttleWriteIOPSDevice&quot;: [
                {
                    &quot;major&quot;: 8,
                    &quot;minor&quot;: 16,
                    &quot;rate&quot;: 300
                }
            ]
        }
    },
    &quot;rootfsPropagation&quot;: &quot;slave&quot;,
    &quot;seccomp&quot;: {
        &quot;defaultAction&quot;: &quot;SCMP_ACT_ALLOW&quot;,
        &quot;architectures&quot;: [
            &quot;SCMP_ARCH_X86&quot;,
            &quot;SCMP_ARCH_X32&quot;
        ],
        &quot;syscalls&quot;: [
            {
                &quot;names&quot;: [
                    &quot;getcwd&quot;,
                    &quot;chmod&quot;
                ],
                &quot;action&quot;: &quot;SCMP_ACT_ERRNO&quot;
            }
        ]
    },
    &quot;namespaces&quot;: [
        {
            &quot;type&quot;: &quot;pid&quot;
        },
        {
            &quot;type&quot;: &quot;network&quot;
        },
        {
            &quot;type&quot;: &quot;ipc&quot;
        },
        {
            &quot;type&quot;: &quot;uts&quot;
        },
        {
            &quot;type&quot;: &quot;mount&quot;
        },
        {
            &quot;type&quot;: &quot;user&quot;
        },
        {
            &quot;type&quot;: &quot;cgroup&quot;
        }
    ],
    &quot;maskedPaths&quot;: [
        &quot;/proc/kcore&quot;,
        &quot;/proc/latency_stats&quot;,
        &quot;/proc/timer_stats&quot;,
        &quot;/proc/sched_debug&quot;
    ],
    &quot;readonlyPaths&quot;: [
        &quot;/proc/asound&quot;,
        &quot;/proc/bus&quot;,
        &quot;/proc/fs&quot;,
        &quot;/proc/irq&quot;,
        &quot;/proc/sys&quot;,
        &quot;/proc/sysrq-trigger&quot;
    ],
    &quot;mountLabel&quot;: &quot;system_u:object_r:svirt_sandbox_file_t:s0:c715,c811&quot;
},
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unsorted"><a class="header" href="#unsorted">Unsorted</a></h1>
<h2 id="vitual-camera"><a class="header" href="#vitual-camera">Vitual Camera</a></h2>
<p><a href="https://rmsol.de/2020/04/25/v4l2/">Vitual Camera</a></p>
<pre><code class="language-sh">sudo modprobe -r v4l2loopback

sudo modprobe v4l2loopback devices=1 video_nr=21 exclusive_caps=1 card_label=&quot;Virtual Webcam&quot;

v4l2-ctl --list-devices

ffmpeg -re -i ~/Downloads/example.mp4 -f v4l2 /dev/video21
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="oauth-20-æµç¨‹åˆ†æ"><a class="header" href="#oauth-20-æµç¨‹åˆ†æ">OAuth 2.0 æµç¨‹åˆ†æ</a></h1>
<p><a href="https://www.oauth.com/">www.oauth.com</a></p>
<h2 id="1-getting-ready-å¼€å§‹"><a class="header" href="#1-getting-ready-å¼€å§‹">1. Getting ready å¼€å§‹</a></h2>
<h3 id="11-creating-an-applicationä¸€èˆ¬éœ€è¦-sign-up-as-a-developer"><a class="header" href="#11-creating-an-applicationä¸€èˆ¬éœ€è¦-sign-up-as-a-developer">1.1 Creating an Application(ä¸€èˆ¬éœ€è¦ sign up as a developer)</a></h3>
<p>user -&gt; entering basic information such as the name, website, logo, etc. server
-&gt; return a <strong>client_id</strong> (and a <strong>client_secret</strong> in some cases)</p>
<h3 id="12-redirect-urls-and-state"><a class="header" href="#12-redirect-urls-and-state">1.2 Redirect URLs and State</a></h3>
<ol>
<li>ä¸ºäº†ä½¿åŒä¸€ä¸ª clientID åŒæ—¶æ‹¥æœ‰å¤šä¸ªçŠ¶æ€ï¼ŒSome services may allow you to register multiple
redirect URLs æ¯”å¦‚ï¼š</li>
</ol>
<ul>
<li>Web app and Mobile app</li>
<li>development service and production service</li>
</ul>
<ol start="2">
<li>ä¸ºäº†ä¿è¯å®‰å…¨ï¼šå¿…é¡»ä½¿ç”¨ https é˜²æ­¢åœ¨è®¤è¯è¿‡ç¨‹ä¸­ code è¢«æ‹¦æˆª</li>
</ol>
<ul>
<li>å¤§å¤šæ•°æœåŠ¡ (service) éœ€è¦è·¯ç”±å®Œå…¨åŒ¹é…ï¼Œè¿™æ„å‘³ç€<a href="https://example.com/auth">https://example.com/auth</a> çš„é‡å®šå‘ URL å°†ä¸
<a href="https://example.com/auth?destination=account">https://example.com/auth?destination=account</a> ä¸åŒ¹é…ã€‚æ‰€ä»¥æœ€ä½³åšæ³•æ˜¯ä¸åœ¨ url é‡Œä½¿ç”¨ query
string parameters</li>
<li>å°‘éƒ¨åˆ†æœåŠ¡éœ€è¦å¯ä»¥ä»å¤šç§ url å‘èµ·è®¤è¯ï¼Œå¯ä»¥é€‰æ‹©æ³¨å†Œå¤šä¸ªé‡å®šå‘ urlï¼Œæˆ–è€…æ”¹å˜è¿™äº›è¯·æ±‚çš„é‡å®šå‘ urlï¼Œä½†æ˜¯ oauth2 æä¾›äº†ä¸€ç§æœºåˆ¶=&gt;
çŠ¶æ€å‚æ•° (State) State çš„ç‰¹ç‚¹</li>
</ul>
<ol start="3">
<li>State</li>
</ol>
<ul>
<li>å¯ä»¥ç”¨æ¥ä½œä¸ºåŠ å¯†çš„ salt</li>
<li>å¯ä»¥æ˜¯æŸç§éšæœºæ•°æ®</li>
<li>å¯¹ä¸ service æ¥è¯´æ˜¯ä¸å¯è§çš„ -&gt; åœ¨åˆå§‹åŒ–è®¤è¯è¯·æ±‚æ—¶ (initial authorization request) ä¼ å…¥çš„ä»»ä½• State
éƒ½ä¼šåœ¨ç”¨æˆ·æˆæƒç»™ app(user authorizes the application) åè¢«è¿”å›</li>
</ul>
<blockquote>
<p>state ç”¨äºé¢å¤–çš„å®‰å…¨æ£€æŸ¥ï¼Œå½“ github è¿”å›æ•°æ®æ—¶å¯ä»¥ç¡®è®¤ä¸æ˜¯æ”»å‡»è€…å‘å‡ºçš„è¯·æ±‚ï¼Œæ¯”å¦‚å°†æ”»å‡»è€…çš„ authorization token å‘é€ç»™
github, as well as SCRF attack</p>
</blockquote>
<p>æ¯”å¦‚ï¼šä½ å¯ä»¥å°†ä¸€ä¸ªé‡å®šå‘çš„ url ç»è¿‡ encode å like JWTï¼Œåœ¨ç”¨æˆ·è¿”å› app åè§£æè¿™ä¸ª JWT å°†ç”¨æˆ·å¸¦å›åˆé€‚çš„ä½ç½®</p>
<h2 id="2-accessing-data-è·å–æ•°æ®-github-ä¸ºä¾‹"><a class="header" href="#2-accessing-data-è·å–æ•°æ®-github-ä¸ºä¾‹">2. Accessing data è·å–æ•°æ® (github ä¸ºä¾‹)</a></h2>
<pre><code class="language-php">$out_app = &quot;åœ¨ github å¡«çš„ homepage&quot;

$authorizeURL = 'https://github.com/login/oauth/authorize';
// This is the endpoint we'll request an access token from
$tokenURL = 'https://github.com/login/oauth/access_token';
// This is the GitHub base URL for API requests
$apiURLBase = 'https://api.github.com/';
// The URL for this script, used as the redirect URL
$baseURL = 'https://' . $_SERVER['SERVER_NAME'] . $_SERVER['PHP_SELF'];
</code></pre>
<ol>
<li>è·å–ç™»å½•å‡­è¯ (access_token)</li>
</ol>
<pre><code class="language-php">   å¼€å§‹
    |
    | ä»æŸå¤„å‘èµ· HttpRequest é‡å®šå‘åˆ° authorizeURL(ä¸ä¸€å®šæ˜¯ our-app)
    | æºå¸¦
    | {
    |     'response_type'= 'code',
    |     'client_id' = $githubClientID,
    |     'redirect_uri' = $baseURL,
    |     'scope' = 'user public_repo',
    |     'status'= 'random_string(10)'
    | }
    âˆ¨
github è®¤è¯ç•Œé¢
    |
    | ç‚¹å‡»ç¡®è®¤
    | if status_send == status_resp:
    |     æºå¸¦ code å’Œ status é‡å®šå‘åˆ° app ç•Œé¢
    âˆ¨
our-app
    |
    | exchange the authorization code for an access token.
    | æºå¸¦
    | {
    |     'grant_type' =&gt; 'authorization_code',
    |     'client_id' =&gt; $githubClientID,
    |     'client_secret' =&gt; $githubClientSecret,
    |     'redirect_uri' =&gt; $baseURL,
    |     'code' =&gt; $_GET['code']
    | }
    | å†æ¬¡è¯·æ±‚ tokenURL ä½¿ç”¨ code äº¤æ¢ token
    | {
    |     &quot;access_token&quot;: &quot;e2f8c8e136c73b1e909bb1021b3b4c29&quot;,
    |     &quot;token_type&quot;: &quot;Bearer&quot;,
    |     &quot;scope&quot;: &quot;public_repo,user&quot;
    | }
    | é‡å®šå‘åˆ° homepage(baseURL)ï¼Œç”¨æˆ·æˆåŠŸç™»å½•
    âˆ¨
appHomePage
    |
    | æŠŠ access_token å­˜å…¥ sessionï¼Œä¸‹æ¬¡è¿›å…¥ app æ—¶å°±èƒ½é€šè¿‡ access_token è¿›å…¥ç™»å½•æˆåŠŸåçš„ç•Œé¢
    âˆ¨
   End
</code></pre>
<ol start="2">
<li>åˆ©ç”¨ access_token è·å–æ•°æ® ç›´æ¥åœ¨ header é‡Œæ·»åŠ  access_token è¯·æ±‚ apiURLBase å°±å®Œäº‹äº†</li>
</ol>
<h2 id="3-signing-in-with-google"><a class="header" href="#3-signing-in-with-google">3. Signing in with Google</a></h2>
<h3 id="31-å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯"><a class="header" href="#31-å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯">3.1 å¦‚ä½•è·å–ç”¨æˆ·ä¿¡æ¯</a></h3>
<p>ä¸¤ä¸ªå…³é”®è¯</p>
<ul>
<li>authorization é‰´æƒï¼štrying to gain access or modify something that belongs to
the user.</li>
<li>authentication æ ¡éªŒï¼šjust verifying who the user is OAuth is designed as a
authorization protocol(æˆæƒåè®®), æ‰€ä»¥ access_token ä¸èƒ½è¢«ç”¨æ¥åˆ¤æ–­ç”¨æˆ·æ˜¯è° æœ‰ä»¥ä¸‹å‡ ç§ä¸åŒ services ä¸º
app æä¾›çš„æ–¹æ³•å¯ä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯è°</li>
</ul>
<ol>
<li>a simple way: è®© api é¡ºä¾¿è¿”å›ä¸€äº› profile_info(ç”¨æˆ·ä¿¡æ¯), ä¸åŒ…å«åœ¨ OAuth æ ‡å‡†é‡Œ</li>
<li>a advanced approach: use OpenID Connect(an OAuth2.0 extension)
<ul>
<li>åˆ©ç”¨ id_token</li>
<li>ä½¿ç”¨ access_token å¦‚ä½•é€‰æ‹©è·å– user_info çš„æ–¹æ³• A: For performance-sensitive
applications where you might be reading ID tokens on every request or using
them to maintain a session, you should definitely validate the ID token
locally rather than making a network
request.<a href="https://developers.google.com/identity/protocols/OpenIDConnect#validatinganidtoken">https://developers.google.com/identity/protocols/OpenIDConnect#validatinganidtoken</a>
B: just for find the userâ€™s name and email after they sign in, then
extracting the data from the ID token and storing it in your application
session</li>
</ul>
</li>
</ol>
<h3 id="32-ä¸‹é¢ä»¥-google-æä¾›çš„-api-ä¸ºä¾‹"><a class="header" href="#32-ä¸‹é¢ä»¥-google-æä¾›çš„-api-ä¸ºä¾‹">3.2 ä¸‹é¢ä»¥ Google æä¾›çš„ api ä¸ºä¾‹</a></h3>
<pre><code class="language-php">$authorizeURL = 'https://accounts.google.com/o/oauth2/v2/auth';
// This is Google's OpenID Connect token endpoint
$tokenURL = 'https://www.googleapis.com/oauth2/v4/token';
// The URL for this script, used as the redirect URL
$baseURL = 'https://' . $_SERVER['SERVER_NAME'] . $_SERVER['PHP_SELF'];
</code></pre>
<p>ä¸ github çš„ä¸åŒ</p>
<ol>
<li>Google çš„è®¤è¯ç•Œé¢åªèƒ½é€‰æ‹©ä½¿ç”¨é‚£ä¸ªå¸å· (ç”¨æˆ·), æ²¡æœ‰ç‚¹å‡»æˆæƒçš„æŒ‰é’®</li>
<li>è¯·æ±‚ access_token çš„è¿”å›å€¼</li>
</ol>
<pre><code class="language-json">{
  &quot;access_token&quot;: &quot;ya29.Glins-oLtuljNVfthQU2bpJVJPTu&quot;,
  &quot;token_type&quot;: &quot;Bearer&quot;,
  &quot;expires_in&quot;: 3600,
  &quot;id_token&quot;: &quot;eyJhbGciOiJSUzI1NiIsImtpZCI6ImFmZmM2MjkwN
  2E0NDYxODJhZGMxZmE0ZTgxZmRiYTYzMTBkY2U2M2YifQ.eyJhenAi
  OiIyNzIxOTYwNjkxNzMtZm81ZWI0MXQzbmR1cTZ1ZXRkc2pkdWdzZX
  V0ZnBtc3QuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJhdWQi
  OiIyNzIxOTYwNjkxNzMtZm81ZWI0MXQzbmR1cTZ1ZXRkc2pkdWdzZX
  V0ZnBtc3QuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJzdWIi
  OiIxMTc4NDc5MTI4NzU5MTM5MDU0OTMiLCJlbWFpbCI6ImFhcm9uLn
  BhcmVja2lAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUs
  ImF0X2hhc2giOiJpRVljNDBUR0luUkhoVEJidWRncEpRIiwiZXhwIj
  oxNTI0NTk5MDU2LCJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2ds
  ZS5jb20iLCJpYXQiOjE1MjQ1OTU0NTZ9.ho2czp_1JWsglJ9jN8gCg
  WfxDi2gY4X5-QcT56RUGkgh5BJaaWdlrRhhN_eNuJyN3HRPhvVA_KJ
  Vy1tMltTVd2OQ6VkxgBNfBsThG_zLPZriw7a1lANblarwxLZID4fXD
  YG-O8U-gw4xb-NIsOzx6xsxRBdfKKniavuEg56Sd3eKYyqrMA0DWnI
  agqLiKE6kpZkaGImIpLcIxJPF0-yeJTMt_p1NoJF7uguHHLYr6752h
  qppnBpMjFL2YMDVeg3jl1y5DeSKNPh6cZ8H2p4Xb2UIrJguGbQHVIJ
  vtm_AspRjrmaTUQKrzXDRCfDROSUU-h7XKIWRrEd2-W9UkV5oCg&quot;
}
</code></pre>
<p>ä¸‹é¢æ˜¯å‰ä¸¤ç«¯çš„è§£ç ä¿¡æ¯æ®µ</p>
<pre><code class="language-json">{
  &quot;alg&quot;: &quot;RS256&quot;,
  &quot;kid&quot;: &quot;affc62907a446182adc1fa4e81fdba6310dce63f&quot;
}
{
  &quot;azp&quot;: &quot;272196069173-fo5eb41t3nduq6uetdsjdugseutfpmst.apps.googleusercontent.com&quot;,
  &quot;aud&quot;: &quot;272196069173-fo5eb41t3nduq6uetdsjdugseutfpmst.apps.googleusercontent.com&quot;,
  &quot;sub&quot;: &quot;117847912875913905493&quot;,
  &quot;email&quot;: &quot;aaron.parecki@gmail.com&quot;,
  &quot;email_verified&quot;: true,
  &quot;at_hash&quot;: &quot;iEYc40TGInRHhTBbudgpJQ&quot;,
  &quot;exp&quot;: 1524599056,
  &quot;iss&quot;: &quot;https://accounts.google.com&quot;,
  &quot;iat&quot;: 1524595456
}
</code></pre>
<p>access_token should be tracted as opaque(ä¸é€æ˜), å› ä¸ºé‡Œé¢æ²¡æœ‰é‡è¦ä¿¡æ¯ ä¸€èˆ¬æ¥è¯´ï¼Œæå– id_token
ä¸­çš„ä¿¡æ¯ä¹‹å‰è¿›è¡Œæ ¡éªŒæ˜¯å¾ˆé‡è¦çš„ï¼Œé˜²æ­¢è¿™ä¸ª token æ˜¯æœ‰å…¶ä»–äººä¸‹å‘çš„ï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† https ä»¥ç¡®ä¿ token ç¡®å®æ¥è‡ª Google
sub æ˜¯ç”¨æˆ·çš„æ ‡è¯†ç¬¦ï¼Œä¸å¸å·ç»‘å®šï¼Œå³ä½¿æ›´æ¢é‚®ç®±ä¹Ÿä¸ä¼šå˜</p>
<blockquote>
<p>ä¸‹é¢æ˜¯ä¸€äº›è§£é‡Š azp: æˆæƒæ¼”ç¤ºè€…çš„ client_idã€‚ä»…å½“è¯·æ±‚ ID ä»¤ç‰Œçš„ä¸€æ–¹ä¸ ID ä»¤ç‰Œçš„å—ä¼—ä¸åŒæ—¶æ‰éœ€è¦æ­¤å£°æ˜ã€‚aud: æ­¤ ID
ä»¤ç‰Œçš„ç›®æ ‡å—ä¼—ã€‚å®ƒå¿…é¡»æ˜¯æ‚¨åº”ç”¨ç¨‹åºçš„ OAuth 2.0 å®¢æˆ·ç«¯ ID ä¹‹ä¸€ã€‚</p>
</blockquote>
<h2 id="4-server-side-apps"><a class="header" href="#4-server-side-apps">4 Server-Side Apps</a></h2>
<ol>
<li>è¯·æ±‚ code æ—¶çš„ queryString</li>
</ol>
<ul>
<li>response_type: æƒ³è¦è·å–çš„è¿”å›å€¼ç±»å‹</li>
<li>client_id: app çš„ identifier</li>
<li>redirect_url(optional): æˆæƒå®Œæˆåçš„è·³è½¬é¡µé¢ (éœ€è¦åœ¨æ³¨å†Œ app æ—¶è®¾ç½®)</li>
<li>scope(optional): Include one or more scope values (space-separated) to request
additional levels of access. The values will depend on the particular
service.(ç”¨ç©ºæ ¼åˆ†éš”)</li>
<li>status: ä¼šè¢«æœåŠ¡ç«¯å®Œæ•´è¿”å›ï¼Œcan be used to letyour app persist data between the user
being directed to the authorization server and back againï¼Œ</li>
</ul>
<blockquote>
<p>æ¯”å¦‚ using it as session_key to indicate what action the app to perform after
authorization is complete(æ¯”å¦‚é‡å®šå‘çš„é“¾æ¥) å¦‚æœæ¯æ¬¡ request çš„ status éƒ½æ˜¯éšæœºç”Ÿæˆçš„ï¼Œstatus
ä¹Ÿèƒ½ç”¨æ¥ä¿æŠ¤ from CSRF</p>
</blockquote>
<ol start="2">
<li>äº¤æ¢ access_token çš„ queryString</li>
</ol>
<ul>
<li>grant_type(required): å¿…é¡»è¦è®¾ç½®ä¸º authorization_code</li>
<li>code(required): will be in the query string parameter â€œcodeâ€ in this request.</li>
<li>redirect_uri (possibly required)</li>
<li>Client Authentication (required): ä¸€èˆ¬æ˜¯ client_id å’Œ client_secret</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vim"><a class="header" href="#vim">vim</a></h1>
<h2 id="1-æ‰¹é‡æ³¨é‡Šä¸åæ³¨é‡Š"><a class="header" href="#1-æ‰¹é‡æ³¨é‡Šä¸åæ³¨é‡Š">1. æ‰¹é‡æ³¨é‡Šä¸åæ³¨é‡Š</a></h2>
<p>åœ¨ä½¿ç”¨ vim ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œç»å¸¸éœ€è¦ç”¨åˆ°æ‰¹é‡æ³¨é‡Šä¸åæ³¨é‡Šä¸€æ®µä»£ç ã€‚ä¸‹é¢ç®€è¦ä»‹ç»å…¶æ“ä½œã€‚</p>
<h3 id="11-å—é€‰æ‹©æ¨¡å¼"><a class="header" href="#11-å—é€‰æ‹©æ¨¡å¼">1.1 å—é€‰æ‹©æ¨¡å¼</a></h3>
<p>æ’å…¥æ³¨é‡Šï¼š</p>
<ul>
<li>
<p>ç”¨ v è¿›å…¥ virtual æ¨¡å¼</p>
</li>
<li>
<p>ç”¨ä¸Šä¸‹é”®é€‰ä¸­éœ€è¦æ³¨é‡Šçš„è¡Œæ•°</p>
</li>
<li>
<p>æŒ‰ Control+vï¼ˆwin ä¸‹é¢ ctrl+qï¼‰è¿›å…¥åˆ—æ¨¡å¼</p>
</li>
<li>
<p>æŒ‰å¤§äº›â€œIâ€è¿›å…¥æ’å…¥æ¨¡å¼ï¼Œè¾“å…¥æ³¨é‡Šç¬¦â€œ#â€æˆ–è€…æ˜¯&quot;//&quot;ï¼Œç„¶åç«‹åˆ»æŒ‰ä¸‹ ESCï¼ˆä¸¤ä¸‹ï¼‰</p>
</li>
</ul>
<p>å–æ¶ˆæ³¨é‡Šï¼š</p>
<ul>
<li>Ctrl + v è¿›å…¥å—é€‰æ‹©æ¨¡å¼ï¼Œé€‰ä¸­ä½ è¦åˆ é™¤çš„è¡Œé¦–çš„æ³¨é‡Šç¬¦å·ï¼Œæ³¨æ„// è¦é€‰ä¸­ä¸¤ä¸ªï¼Œé€‰å¥½ä¹‹åæŒ‰ d å³å¯åˆ é™¤æ³¨é‡Š</li>
</ul>
<h3 id="12-æ›¿æ¢å‘½ä»¤"><a class="header" href="#12-æ›¿æ¢å‘½ä»¤">1.2 æ›¿æ¢å‘½ä»¤</a></h3>
<p>æ‰¹é‡æ³¨é‡Šï¼š</p>
<ul>
<li>:èµ·å§‹è¡Œå·ï¼Œç»“æŸè¡Œå· s/^/æ³¨é‡Šç¬¦/g</li>
</ul>
<p>å–æ¶ˆæ³¨é‡Šï¼š</p>
<ul>
<li>:èµ·å§‹è¡Œå·ï¼Œç»“æŸè¡Œå· s/^æ³¨é‡Šç¬¦//g</li>
</ul>
<p>å®ä¾‹æ¼”ç¤ºï¼š</p>
<pre><code>åœ¨ 27 - 30 è¡Œæ·»åŠ  // æ³¨é‡Š
:27,30s#^#//#g

åœ¨ 27 - 30 è¡Œåˆ é™¤ // æ³¨é‡Š
:27,30s#^//##g

åœ¨ 10 - 20 è¡Œæ·»åŠ  # æ³¨é‡Š
:10,20s/^/#/g

åœ¨ 10 - 20 è¡Œåˆ é™¤ # æ³¨é‡Š
:10,20s/^/#/g
</code></pre>
<p>æ³¨æ„ä¾‹å­ä¸­æ­£åˆ™çš„åˆ†å‰²ç¬¦ä½¿ç”¨çš„æ˜¯ç›¸åçš„ç¬¦å·ï¼Œå¦‚æœåŒ¹é…// é‚£ä¹ˆä½¿ç”¨ #ä½œåˆ†éš”ç¬¦è¿™æ ·ä¸éœ€è¦å¯¹/ä½œè½¬ä¹‰å¤„ç†ï¼ŒèŠ‚çœè¾“å…¥æ¬¡æ•°ã€‚</p>
<h2 id="2-å¤åˆ¶ç²˜è´´"><a class="header" href="#2-å¤åˆ¶ç²˜è´´">2. å¤åˆ¶ç²˜è´´</a></h2>
<p>Vim ä¸­å¦‚ä½•å…¨é€‰å¹¶å¤åˆ¶ï¼Ÿï¼ˆåŒºåˆ†å¤§å°å†™ï¼ï¼ï¼ï¼‰</p>
<ul>
<li>å…¨éƒ¨åˆ é™¤ï¼šæŒ‰ esc é”®åï¼Œå…ˆæŒ‰ ggï¼ˆåˆ°è¾¾é¡¶éƒ¨ï¼‰ï¼Œç„¶å dG</li>
<li>å…¨éƒ¨å¤åˆ¶ï¼šæŒ‰ esc é”®åï¼Œå…ˆæŒ‰ ggï¼Œç„¶å ggyG</li>
<li>å…¨é€‰é«˜äº®æ˜¾ç¤ºï¼šæŒ‰ esc é”®åï¼Œå…ˆæŒ‰ ggï¼Œç„¶å ggvG æˆ–è€… ggVG</li>
<li>å•è¡Œå¤åˆ¶ï¼šæŒ‰ esc é”®åï¼Œç„¶å yy</li>
<li>å•è¡Œåˆ é™¤ï¼šæŒ‰ esc é”®åï¼Œç„¶å dd</li>
<li>ç²˜è´´ï¼šæŒ‰ esc é”®åï¼Œç„¶å p</li>
</ul>
<p>vim åªèƒ½ç²˜è´´ 50 è¡Œçš„é—®é¢˜ï¼š</p>
<p>åœ¨å½“å‰ç”¨æˆ·ä¸»ç›®å½•ï¼ˆ~ï¼‰ç¼–è¾‘~/.vimrcï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œæ–°å»ºè¿™ä¸ªæ–‡ä»¶ï¼‰ï¼Œæ·»åŠ ä¸€è¡Œ</p>
<pre><code class="language-text">:set viminfo='1000,&lt;500
</code></pre>
<p>è‡³äºä¸ºä»€ä¹ˆè¦è¾“å…¥è¾“å…¥â€™1000ï¼Œè¿™ä¸ªå…¶å®ä¸é‡è¦ï¼Œæœ€ä¸»è¦çš„æ˜¯è¾“å…¥&lt;500ï¼Œå®ƒæ˜¯è®¾ç½®å¯„å­˜å™¨ä¿å­˜çš„è¡Œæ•°çš„ï¼Œå³æœ€å¤§å€¼ä¸º 500ã€‚</p>
<h2 id="3-æ ¼å¼åŒ–"><a class="header" href="#3-æ ¼å¼åŒ–">3. æ ¼å¼åŒ–</a></h2>
<p>1ï¼Œgg è·³è½¬åˆ°ç¬¬ä¸€è¡Œ</p>
<p>2ï¼Œshift+v è½¬åˆ°å¯è§†æ¨¡å¼</p>
<p>3ï¼Œshift+g å…¨é€‰</p>
<p>4ï¼ŒæŒ‰ä¸‹ç¥å¥‡çš„ =</p>
<h4 id="4-æ‰¹é‡æ›¿æ¢"><a class="header" href="#4-æ‰¹é‡æ›¿æ¢">4. æ‰¹é‡æ›¿æ¢</a></h4>
<p><code>%s/åŸå˜é‡å/è¦ä¿®æ”¹åçš„å˜é‡å/g</code></p>
<p>åŠ ä¸ª c å°±æœ‰ u ä¿®æ”¹ç¡®è®¤æç¤º</p>
<p><code>%s/åŸå˜é‡å/è¦ä¿®æ”¹åçš„å˜é‡å/gc</code></p>
<p>å¦‚æœæ˜¯æ›¿æ¢ä¸€ä¸ªå‡½æ•°ä¸­çš„å˜é‡åï¼Œå¯ä»¥ç”¨ v å‘½ä»¤é€‰ä¸­å‡½æ•°ï¼Œç„¶åæ›¿æ¢ï¼›å¦‚æœæ˜¯æ›¿æ¢è‹¥å¹²æ–‡ä»¶ä¸­çš„å˜é‡ï¼ˆæˆ–å‡½æ•°ï¼‰åï¼Œéœ€è¦å…ˆé€‰å®š args åˆ—è¡¨ï¼Œç„¶åç”¨ argdo
%s//new_name/g | w æ¥ä¿®æ”¹åŠ ä¿å­˜ã€‚</p>
<h3 id="5-æŸ¥è¯¢å…³é”®å­—"><a class="header" href="#5-æŸ¥è¯¢å…³é”®å­—">5. æŸ¥è¯¢å…³é”®å­—</a></h3>
<p><code>/key</code></p>
<p>ä¸éœ€è¦<code>ï¼š</code></p>
<p>n ä¸‹ä¸€ä¸ªï¼ŒN ä¸Šä¸€ä¸ª</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="python"><a class="header" href="#python">Python</a></h1>
<h2 id="venv"><a class="header" href="#venv">venv</a></h2>
<ul>
<li>å®‰è£…
<ul>
<li><code>pip install virtualenv</code></li>
</ul>
</li>
<li>åˆ›å»º
<ul>
<li><code>python -m venv {myenv}</code></li>
<li>myenv æ˜¯è™šæ‹Ÿç¯å¢ƒçš„åå­— (å…¶å®æ˜¯è·¯å¾„)</li>
<li>ä¼šåœ¨è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹</li>
</ul>
</li>
<li>è¿›å…¥
<ul>
<li><code>source /home/trdthg/myproject/bigdata20/venv/bin/activate</code></li>
<li>å…¶å®å°±æ˜¯æ‰§è¡Œ venv ä¸‹çš„åå­—ä¸º activate çš„ shell è„šæœ¬</li>
</ul>
</li>
<li>é€€å‡º
<ul>
<li>è¿è¡Œ <code>deactivate</code></li>
</ul>
</li>
<li>å…¶ä»–è™šæ‹Ÿå·¥å…·
<ul>
<li>pipenv</li>
</ul>
</li>
</ul>
<h2 id="requirementstxt"><a class="header" href="#requirementstxt">requirements.txt</a></h2>
<ul>
<li>ç”Ÿæˆé¡¹ç›®ä¾èµ–
<ul>
<li>venv
<ul>
<li><code>pip3 freeze &gt; requirements.txt</code></li>
<li>æ³¨æ„ï¼šå¦‚æœä¸æ˜¯åœ¨è™šæ‹Ÿç¯å¢ƒä¸‹æ‰§è¡Œï¼Œä¼šæŠŠå…¨å±€çš„ä¾èµ–ä¹ŸåŠ è¿›å»</li>
</ul>
</li>
<li>pipenv
<ul>
<li>ç•¥è¿‡</li>
</ul>
</li>
<li>éè™šæ‹Ÿç¯å¢ƒ pipreqs
<ul>
<li><code>pipreqs /path/to/project</code></li>
</ul>
</li>
</ul>
</li>
<li>ä½¿ç”¨ requirements.txt
<ul>
<li><code>pip install -r requirements.txt</code></li>
</ul>
</li>
</ul>
<h2 id="setuppy"><a class="header" href="#setuppy">setup.py</a></h2>
<p>æ„Ÿè§‰ä¸å¥½ç”¨</p>
<ul>
<li><a href="https://towardsdatascience.com/requirements-vs-setuptools-python-ae3ee66e28af">requirements.txt vs setup.py in Python</a></li>
</ul>
<h2 id="scrapy"><a class="header" href="#scrapy">scrapy</a></h2>
<h3 id="ip-æ± "><a class="header" href="#ip-æ± ">IP æ± </a></h3>
<pre><code>docker run --network host --env DB_CONN=redis://:@localhost:6379/0 -p 5010:5010 jhao104/proxy_pool:2.4.0
</code></pre>
<pre><code class="language-py">class ProxyMiddleware(object):
    def __init__(self, proxy_url):
        self.proxy_url = proxy_url

    def get_random_proxy(self):
        try:
            print(&quot;-&quot;*100)
            print(&quot;è¯·æ±‚éšæœºä»£ç†&quot;)
            response = requests.get(&quot;http://127.0.0.1:5010/get?type=https&quot;)
            if response.status_code == 200:
                proxy = response.json()['proxy']
                return proxy
        except requests.ConnectionError:
            return False

    def process_request(self, request, spider):
        if request.meta.get('retry_times'):
            proxy = self.get_random_proxy()
            if proxy:
                uri = f'https://{proxy}'
                print(' ä½¿ç”¨ä»£ç† ' + proxy)
                request.meta['proxy'] = uri

    @classmethod
    def from_crawler(cls, crawler):
        settings = crawler.settings
        return cls(proxy_url=settings.get('PROXY_URL'))
</code></pre>
<h3 id="éšæœºä¸‹è½½å»¶è¿Ÿ"><a class="header" href="#éšæœºä¸‹è½½å»¶è¿Ÿ">éšæœºä¸‹è½½å»¶è¿Ÿ</a></h3>
<pre><code class="language-py">class RandomDelayMiddleware(object):
    def __init__(self, delay):
        self.delay = delay

    @classmethod
    def from_crawler(cls, crawler):
        delay = crawler.spider.settings.get(&quot;RANDOM_DELAY&quot;, 10)
        if not isinstance(delay, int):
            raise ValueError(&quot;RANDOM_DELAY need a int&quot;)
        return cls(delay)

    def process_request(self, request, spider):
        delay = random.randint(0, self.delay)
        print('-'*100)
        print(&quot;ä¸‹è½½å»¶è¿Ÿï¼š&quot;, delay, &quot;ç§’&quot;)
        time.sleep(delay)
</code></pre>
<h2 id="micropython"><a class="header" href="#micropython">MicroPython</a></h2>
<h3 id="micropython-----esp8266"><a class="header" href="#micropython-----esp8266">MicroPython --- esp8266</a></h3>
<h4 id="è¿è¡Œ"><a class="header" href="#è¿è¡Œ">è¿è¡Œ</a></h4>
<ol>
<li>å‡†å¤‡é¡¹ç›®</li>
</ol>
<ul>
<li>ä¸‹è½½ win10usb-series çš„é©±åŠ¨</li>
<li>ä¸‹è½½åŸºäº ESP8266 çš„ MicroPython
å›ºä»¶<a href="https://micropython.org/download/#esp8266">MicroPython çš„å®˜ç½‘</a></li>
<li>ä¸‹è½½ä¸²å£å·¥å…·<a href="https://www.putty.org/">Putty</a></li>
<li>ä¸‹è½½<a href="https://www.espressif.com/en/support/download/other-tools">çƒ§å½•å·¥å…·</a></li>
<li>ä¸‹è½½<a href="https://github.com/micropython/webrepl">webrepl å®¢æˆ·ç«¯</a></li>
</ul>
<ol start="2">
<li>çƒ§å½•è¿æ¥</li>
</ol>
<ul>
<li>çƒ§å†™å›ºä»¶æŠŠè¯¥å›ºä»¶çƒ§å†™åˆ° 0x0 ä½ç½®å³å¯ã€‚</li>
<li>ä¸Šç”µæ‰“å°å‡ºç°ä¸‹ä¾‹è¡¨ç¤ºæˆåŠŸ</li>
</ul>
<pre><code class="language-java">MicroPython v1.8.6-7-gefd0927 on 2016-11-10; ESP module with ESP8266
Type &quot;help()&quot; for more information.
&gt;&gt;&gt;
</code></pre>
<p>::: warning æ³¨æ„ putty è¿æ¥æ—¶ï¼Œè‹¥é”®ç›˜æ— æ³•è¾“å…¥ï¼Œå°è¯•è®¾ç½® (Connection -&gt; Serial -&gt; Flow control =
None) :::</p>
<h4 id="è¿æ¥-wifi"><a class="header" href="#è¿æ¥-wifi">è¿æ¥ WiFi</a></h4>
<ul>
<li>è¿æ¥</li>
</ul>
<pre><code class="language-python">import network
sta_if = network.WLAN(network.STA_IF)
sta_if.active(True)
sta_if.scan()                             # Scan for available access points
sta_if.connect(&quot;&lt;wifiname&gt;&quot;, &quot;&lt;password&gt;&quot;) # Connect to an AP
sta_if.isconnected()                      # Check for successful connection
</code></pre>
<ul>
<li>è®¾ç½®ä¸Šç”µè‡ªåŠ¨è¿æ¥ MicroPython åˆå§‹åŒ–åéƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œ main.py æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¾ç½®è¯¥æ–‡ä»¶å³å¯ä¸Šç”µè‡ªåŠ¨è¿æ¥
WiFiã€‚æ‰“å¼€è‡ªå·±å¸¸ç”¨çš„ç¼–è¾‘å™¨ï¼Œè¾“å…¥ä¸‹é¢ä»£ç ï¼Œå¹¶ä¿å­˜ä¸º main.py æ–‡ä»¶ï¼š</li>
</ul>
<pre><code class="language-python"># main.py
import network
import webrepl
import time

SSIDs = [(&quot;602&quot;, &quot;4602yyds&quot;)]

def do_connect():
    import network
    wlan = network.WLAN(network.STA_IF)
    wlan.active(True)
    if not wlan.isconnected():
        print('connecting to network...')
        wlan.connect(SSIDs[0][0], SSIDs[0][1])

    start = time.time()
    while not wlan.isconnected():
        time.sleep(1)
        if time.time()-start &gt; 5:
            print(&quot;connect timeout!&quot;)
            break

    if wlan.isconnected():
        print(&quot;successfully connected!&quot;)
        print('network config:', wlan.ifconfig())

def main():
    do_connect()
main()
</code></pre>
<h4 id="webrepl-ä¸Šä¼ æ–‡ä»¶"><a class="header" href="#webrepl-ä¸Šä¼ æ–‡ä»¶">WebREPL ä¸Šä¼ æ–‡ä»¶</a></h4>
<p>webrepl æ˜¯ MicroPython å®˜æ–¹æä¾›çš„æ–‡ä»¶ç®¡ç†å·¥å…·ã€‚å¹¶ä¸”æœ‰ä¸€ä¸ª webrepl å®¢æˆ·ç«¯å·¥å…·ï¼Œä½¿ç”¨å®ƒå¯ä»¥é€šè¿‡æµè§ˆå™¨æ¥è®¿ ESP8266ã€‚</p>
<ol>
<li>åˆå§‹åŒ– (putty)</li>
</ol>
<pre><code class="language-python">import webrepl_setup
</code></pre>
<ol start="2">
<li>å¯åŠ¨ (putty)</li>
</ol>
<pre><code class="language-python">import webrepl
webrepl.start()
</code></pre>
<ol start="3">
<li>è¿æ¥ (webrepl å®¢æˆ·ç«¯)</li>
</ol>
<ul>
<li>ESP8266 è¿æ¥å¥½ WiFi åï¼Œè¾“å…¥ sta_if.ifconfig() æŸ¥çœ‹è¿æ¥ä¿¡æ¯ï¼Œè¿”å›çš„å…ƒç»„ç¬¬ä¸€ä¸ª IP å°±æ˜¯æ— çº¿è·¯ç”±å™¨åˆ†é…ç»™ ESP8266
çš„ IPã€‚</li>
<li>å¦‚æœä½ çš„ç”µè„‘å’Œ ESP8266 åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ï¼Œä¿®æ”¹ WebREPL è¦è¿æ¥çš„åœ°å€ä¸º ESP8266 çš„ IPï¼Œç‚¹å‡»ã€ŒConnectã€ï¼Œè¿”å›ã€ŒWelcome
to MicroPython!ã€è¯´æ˜è¿æ¥æˆåŠŸï¼Œæ ¹æ®æç¤ºè¾“å…¥å¯†ç ï¼ˆå¯†ç é»˜è®¤ä¸æ˜¾ç¤ºï¼‰ã€‚å›è½¦åæ˜¾ç¤ºã€ŒWebREPL connectedã€è¡¨ç¤ºç™»å½•æˆåŠŸã€‚</li>
<li>ä¹‹åå°±å¯ä»¥ç”¨è¿™ä¸ªå®¢æˆ·ç«¯ä¸Šä¼ ä¸‹è½½æ–‡ä»¶äº†ã€‚</li>
</ul>
<h4 id="å¾…ç»­-14"><a class="header" href="#å¾…ç»­-14">å¾…ç»­...</a></h4>
<h2 id="conda"><a class="header" href="#conda">Conda</a></h2>
<h3 id="åŸºæœ¬æ“ä½œ-1"><a class="header" href="#åŸºæœ¬æ“ä½œ-1">åŸºæœ¬æ“ä½œ</a></h3>
<pre><code class="language-shell"># å®‰è£… PYTHON æŒ‡å®šç¯å¢ƒ
conda create -n $name python=$version
# åˆ—å‡ºæ‰€æœ‰ç¯å¢ƒ
conda env list
# è¿›å…¥ç¯å¢ƒ
conda activate $name
# é€€å‡ºç¯å¢ƒ
conda deactivate $name
# åˆ é™¤ç¯å¢ƒ
conda env remove -n $name
</code></pre>
<p>::: warning è‹¥ä¸è¿›å…¥ç¯å¢ƒï¼Œé»˜è®¤åœ¨ base ç¯å¢ƒè¿›è¡Œæ‰€æœ‰æ“ä½œ :::</p>
<h3 id="å¾…ç»­-15"><a class="header" href="#å¾…ç»­-15">å¾…ç»­...</a></h3>
<h2 id="æ¨¡æ‹Ÿè¾“å…¥"><a class="header" href="#æ¨¡æ‹Ÿè¾“å…¥">æ¨¡æ‹Ÿè¾“å…¥</a></h2>
<h3 id="pyuserinput"><a class="header" href="#pyuserinput">PyUserInput</a></h3>
<ol>
<li>å®‰è£…</li>
</ol>
<ul>
<li>å®‰è£… PyHook: <a href="https://www.lfd.uci.edu/%7Egohlke/pythonlibs/">PyHook</a> æ‰¾åˆ° PyHook ç›®å½•ï¼Œ
æ‰¾åˆ°å¯¹åº”çš„ python ç‰ˆæœ¬ï¼Œä¸‹è½½åç›´æ¥<code>pip install pyHookâ€‘1.5.1â€‘cp35â€‘cp35mâ€‘win_amd64.whl</code></li>
<li>å®‰è£… PyUserInput: <code>pip install PyUserput</code></li>
</ul>
<ol start="2">
<li>åŸºæœ¬æ“ä½œ</li>
</ol>
<pre><code class="language-python">from pymouse import *     # æ¨¡æ‹Ÿé¼ æ ‡æ‰€ä½¿ç”¨çš„åŒ…
from pykeyboard import *   # æ¨¡æ‹Ÿé”®ç›˜æ‰€ä½¿ç”¨çš„åŒ…
import time   # è¿ç»­è¿›è¡Œä¸¤ä¸ªåŠ¨ä½œå¯èƒ½å¤ªå¿«è€Œæ•ˆæœä¸æ˜æ˜¾ï¼Œå› æ­¤åŠ å…¥æš‚åœæ—¶é—´

m = PyMouse()   # é¼ æ ‡çš„å®ä¾‹ m
k = PyKeyboard()   # é”®ç›˜çš„å®ä¾‹ k
x_dim, y_dim = m.screen_size()     # è·å–å±å¹•å°ºå¯¸ï¼ˆä¸€èˆ¬ä¸ºç”µè„‘å±å¹•çš„åˆ†è¾¨ç‡ï¼Œå¦‚ 1920*1080ï¼‰
# ä¼°è®¡éœ€è¦ç‚¹å‡»çš„ä½ç½®åæ ‡ï¼ˆä¸çŸ¥é“æœ‰æ²¡æœ‰å®šä½ä»£ç ï¼Œæˆ‘æ²¡æ‰¾åˆ°ï¼Œæˆ‘æ˜¯è‡ªå·±ä¼°è®¡çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘çš„ç”µè„‘å±å¹•ä¸º (1920ï¼Œ1080)ï¼Œæˆ‘æƒ³è¦å•å‡»çš„åœ°æ–¹ä¼°è®¡åæ ‡ä¸º (10ï¼Œ500)ï¼‰

m.move(10, 500)   # å°†é¼ æ ‡ç§»åŠ¨åˆ°ä½ï¼ˆæ­¤æ­¥å¯å¿½ç•¥ï¼Œç›´æ¥å•å‡»ä¹Ÿå¯ï¼‰
time.sleep(0.5)   # æš‚åœ 0.5sï¼Œæ–¹ä¾¿è§‚å¯Ÿç§»åŠ¨ç»“æœ
m.click(10, 500, 1, 1)   # è¡¨ç¤ºåœ¨ (10, 500) çš„åœ°æ–¹ï¼Œå•å‡»å·¦é”®
</code></pre>
<ol start="3">
<li>å¸¸ç”¨å‡½æ•°</li>
</ol>
<pre><code class="language-python">k.type_string('Hello, World!')	# æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥å­—ç¬¦ä¸²
k.press_key('H')	# æ¨¡æ‹Ÿé”®ç›˜æŒ‰ H é”®
k.release_key('H')	# æ¨¡æ‹Ÿé”®ç›˜æ¾å¼€ H é”®
k.tap_key(&quot;H&quot;)	# æ¨¡æ‹Ÿç‚¹å‡» H é”®
k.tap_key('H',n=2,interval=5)	# æ¨¡æ‹Ÿç‚¹å‡» H é”®ï¼Œ2 æ¬¡ï¼Œæ¯æ¬¡é—´éš” 5 ç§’
k.tap_key(k.function_keys[5])	# ç‚¹å‡»åŠŸèƒ½é”® F5
k.tap_key(k.numpad_keys[5],3)	# ç‚¹å‡»å°é”®ç›˜ 5,3 æ¬¡
</code></pre>
<ol start="4">
<li>ç»„åˆé”®</li>
</ol>
<pre><code class="language-python">k.press_key(k.alt_key)	# æŒ‰ä½ alt é”®
k.tap_key(k.tab_key)	# ç‚¹å‡» tab é”®
k.release_key(k.alt_key)	# æ¾å¼€ alt é”®
</code></pre>
<ol start="5">
<li>å¸¸è§çš„é”®å’Œé”®å€¼ç </li>
</ol>
<pre><code class="language-python">å­—æ¯å’Œæ•°å­—é”®     æ•°å­—å°é”®ç›˜çš„é”®       åŠŸèƒ½é”®         å…¶å®ƒé”®
é”®   é”®ç       é”®   é”®ç           é”®   é”®ç        é”®         é”®ç 
A   65          0   96            F1   112       Backspace  8
B   66          1   97            F2   113       Tab        9
C   67          2   98            F3   114       Clear      12
D   68          3   99            F4   115       Enter      13
E   69          4   100           F5   116       Shift      16
F   70          5   101           F6   117       Control    17
G   71          6   102           F7   118       Alt        18
H   72          7   103           F8   119       Caps Lock  20
I    73         8   104           F9   120       Esc        27
J    74         9   105           F10  121       Spacebar   32
K   75          *   106           F11  122       Page Up    33
L   76          +   107           F12  123       Page Down  34
M   77        Enter 108                          End        35
N   78          -   109                          Home       36
O   79          .   110                          LeftArrow  37
P   80          /   111                          UpArrow    38
Q   81                                           RightArrow 39
R   82                                           DownArrow  40
S   83                                           Insert     45
T   84                                           Delete     46
U   85                                           Help       47
V   86                                           Num Lock   144
W  87
X   88
Y   89
Z   90
0   48
1   49
2   50
3   51
4   52
5   53
6   54
7   55
8   56
9   57
</code></pre>
<h2 id="æ ‡å‡†åº“"><a class="header" href="#æ ‡å‡†åº“">æ ‡å‡†åº“</a></h2>
<h3 id="httpclient"><a class="header" href="#httpclient">http.client</a></h3>
<ol>
<li>demo å®ä¾‹</li>
</ol>
<pre><code class="language-python">import json

h1 = HTTPConnection('127.0.0.1:7878')
body = json.dumps({&quot;aaa&quot;: 1, &quot;bbb&quot;: 2, &quot;ccc&quot;: &quot;sss&quot;}).encode(&quot;utf-8&quot;)
h1.request(&quot;POST&quot;, &quot;/&quot;, body=body, headers={&quot;Content-Type&quot;: &quot;application/json&quot;})
</code></pre>
<ol start="2">
<li>åŸºæœ¬æµç¨‹</li>
</ol>
<pre><code class="language-php">          --- start ---
                |
                |===== self.__state = _CS_IDLE
                v
HTTPConnection =&gt; _create_connect()
                |
                | socket  // è·å–è¿æ¥
                | _output // å‚¨å­˜è¯·æ±‚å­—ç¬¦ä¸²
                v
    request() -&gt; _send_request(method, url, body, headers)
                |
                |===== self.__state = _CS_REQ_STARTED
                v
    putrequests(method, url)
                |
                | self._output.append(method url http-vsn)
                v
[ putheaders(hdr, value) for hdr, vale in headers ]
                |
                | å½¢æˆäº†ä¸å¸¦ body çš„éƒ¨åˆ†
                v
    endheaders(body) -&gt; _send_output(body)
                |
                |===== self.__state = _CS_REQ_STARTED
                | self.__state = _CS_REQ_SENT
                | send(msg)
                | send(body) if body exists
                | send(b&quot;0\r\n\r\n&quot;)
                v
            ---end---
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="common-1"><a class="header" href="#common-1">common</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust"><a class="header" href="#rust">rust</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¼‚æ­¥è¿è¡Œæ—¶"><a class="header" href="#å¼‚æ­¥è¿è¡Œæ—¶">å¼‚æ­¥è¿è¡Œæ—¶</a></h1>
<h2 id="project1"><a class="header" href="#project1">project1</a></h2>
<p>å®ç°äº†ä¸€ä¸ªæœ€å°çš„ runtime</p>
<h3 id="æ¡†æ¶"><a class="header" href="#æ¡†æ¶">æ¡†æ¶</a></h3>
<ul>
<li>executor(MiniTokio): ä¿å­˜ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸æ–­å°è¯• poll æ¯ä¸ª taskï¼Œå¦‚æœä»»åŠ¡å®Œæˆå°±ç§»é™¤é˜Ÿåˆ—ï¼Œå¦‚æœæ²¡æœ‰å®Œæˆå°±åŠ åˆ°é˜Ÿå°¾
<pre><code class="language-rs">struct MiniTokio {
    tasks: VecDeque&lt;Task&gt;,
}
impl MiniTokio {
    pub fn new() -&gt; Self {
        Self {
            tasks: VecDeque::new(),
        }
    }
    fn run(&amp;mut self) {
        let waker = futures::task::noop_waker();
        let mut cx = Context::from_waker(&amp;waker);
        while let Some(mut task) = self.tasks.pop_front() {
            if task.as_mut().poll(&amp;mut cx).is_pending() {
                println!(&quot;a&quot;);
                self.tasks.push_back(task);
            }
        }
    }
}
</code></pre>
</li>
<li>task: å°è£…äº† future
<pre><code class="language-rs">type Task = Pin&lt;Box&lt;dyn Future&lt;Output = ()&gt;&gt;&gt;;
</code></pre>
</li>
<li>spawner: ä½œä¸º runtime çš„å‡½æ•°ï¼Œå°† task æ·»åŠ åˆ°é˜Ÿå°¾
<pre><code class="language-rs">fn spawn&lt;F&gt;(&amp;mut self, f: F)
where
    F: Future&lt;Output = ()&gt; + 'static,
{
    self.tasks.push_back(Box::pin(f));
}
</code></pre>
</li>
</ul>
<h3 id="project2"><a class="header" href="#project2">project2</a></h3>
<p>execotor æœ¬èº«çš„ push_back æ“ä½œå°±æ˜¯ wake çš„å®ç°</p>
<p>åªè¦æ²¡æœ‰ ready å°±é‡æ–°åŠ å…¥é˜Ÿåˆ—ï¼Œè¿™ç§åšæ³•æ‰§è¡Œå¤±è´¥å°±ç«‹å³é‡ä¼šå ç”¨å¤§é‡ cpu èµ„æºï¼Œåº”è¯¥ç­‰åˆ° ready æ˜¯åœ¨é‡æ–°å”¤é†’ (åŠ å…¥é˜Ÿåˆ—)</p>
<pre><code class="language-rs">fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
    if (Instant::now() &gt;= self.when) {
        Poll::Ready(&quot;aaa&quot;)
    } else {
        Poll::Pending
    }
}
</code></pre>
<h2 id="project2-1"><a class="header" href="#project2-1">project2</a></h2>
<h3 id="æ¡†æ¶-1"><a class="header" href="#æ¡†æ¶-1">æ¡†æ¶</a></h3>
<ul>
<li>execotor: åªéœ€è¦ä¸€ä¸ª receiverï¼Œä¸æ–­å°è¯•æ¥å—ä»»åŠ¡å» pollï¼Œç»“æœæ˜¯ä»€ä¹ˆæ— æ‰€è°“
<pre><code class="language-rs">struct MiniTokio {
    sender: Sender&lt;Arc&lt;Task&gt;&gt;,  // ç­‰ä¼šåœ¨è¯´è¿™ä¸ª
    receiver: Receiver&lt;Arc&lt;Task&gt;&gt;,
}

impl MiniTokio {
    pub fn new() -&gt; Self {
        let (cx, rx) = crossbeam::channel::unbounded();
        Self {
            sender: cx,
            receiver: rx,
        }
    }

    fn run(&amp;self) {
        while let Ok(task) = self.receiver.recv() {
            let waker = futures::task::waker(task.clone());
            let mut cx = Context::from_waker(&amp;waker);
            let mut future = task.future.lock().expect(&quot;åŠ é”å¤±è´¥&quot;);
            let _ = future.as_mut().poll(&amp;mut cx);
        }
    }
}
</code></pre>
</li>
<li>task: é™¤äº† future è¿˜æœ‰ä¸€ä¸ª sender, task å®ç°äº† Wakerï¼Œå½“ task pending æ—¶ä¼šæŒ‰ç…§ç­–ç•¥è°ƒç”¨ wake æ–¹æ³•ï¼Œ
æŠŠè‡ªå·± send åˆ° execotor
<pre><code class="language-rs">struct Task {
    future: Mutex&lt;Pin&lt;Box&lt;dyn Future&lt;Output = ()&gt; + Send&gt;&gt;&gt;,
    sender: Sender&lt;Arc&lt;Task&gt;&gt;,
}

impl ArcWake for Task {
    fn wake_by_ref(arc_self: &amp;Arc&lt;Self&gt;) {
        arc_self
            .sender
            .send(arc_self.clone())
            .expect(&quot;send ä¼š queue å¤±è´¥äº†&quot;);
    }
}
</code></pre>
</li>
<li>spawner: å› ä¸º execotor ç°åœ¨åŒæ—¶ä¿ç•™ç€ sender å’Œ receiverï¼Œä¸¤è€…éƒ½ä¸ä¼šè¢« dropï¼Œç¨‹åºä¸èƒ½æ­£å¸¸é€€å‡ºï¼Œä¸‹ä¸€æ­¥éœ€è¦å°†è¿™ä¸¤ä¸ªåˆ†ç¦»
<pre><code class="language-rs">fn spawn&lt;F&gt;(&amp;self, future: F)
    where
        F: Future&lt;Output = ()&gt; + Send + 'static,
    {
        let task = Task {
            future: Mutex::new(Box::pin(future)),
            sender: self.sender.clone(),
        };
        self.sender
            .send(Arc::new(task))
            .expect(&quot;spawner send new task failed&quot;);
    }
</code></pre>
</li>
</ul>
<h3 id="wake-å®ç°"><a class="header" href="#wake-å®ç°">wake å®ç°</a></h3>
<pre><code class="language-rs">fn poll(self: Pin&lt;&amp;mut Self&gt;, cx: &amp;mut Context&lt;'_&gt;) -&gt; Poll&lt;Self::Output&gt; {
    if Instant::now() &gt;= self.when {
        Poll::Ready(&quot;aaa&quot;)
    } else {
        // è¿™é‡Œè°ƒç”¨ wake ä¾èµ–çš„æ˜¯ task å®ç°çš„ wake æ–¹æ³•

        // 1. ç«‹å³ send
        cx.waker().wake_by_ref();

        // 2. è¿™ä¸ªæ˜¯ç¨å¾®ä¼˜åŒ–è¿‡çš„ wake ç­–ç•¥
        let waker = cx.waker().clone();
        let when = self.when;
        thread::spawn(move || {
            let now = Instant::now();
            if now &lt; when {
                thread::sleep(when - now);
            }
            waker.wake();
        });
        Poll::Pending
    }
}
</code></pre>
<h3 id="ä¸ä¼˜é›…çš„å…³é—­"><a class="header" href="#ä¸ä¼˜é›…çš„å…³é—­">ä¸ä¼˜é›…çš„å…³é—­</a></h3>
<pre><code class="language-rs">fn main() {
    let mut runtime = MiniTokio::new();
    runtime.spawn(async {
        let when = Instant::now() + Duration::from_secs(2);
        let future = Delay::new(when);

        let out = future.await;
        assert_eq!(out, &quot;aaa&quot;);

        println!(&quot;{out}&quot;);
        std::process::exit(0);  // éœ€è¦æ‰‹åŠ¨é€€å‡º
    });
    runtime.run();
}
</code></pre>
<h3 id="project3"><a class="header" href="#project3">project3</a></h3>
<ol>
<li>åˆ†ç¦» executor(receiver) å’Œ spawner(sender), å½“ receiver è¿è¡Œç»“æŸå receiver å°±é”€æ¯</li>
</ol>
<pre><code class="language-rs">struct Executor {
    ready_queue: Receiver&lt;Arc&lt;Task&gt;&gt;,
}

struct Task {
    future: Mutex&lt;Option&lt;BoxFuture&lt;'static, ()&gt;&gt;&gt;,
    task_sender: SyncSender&lt;Arc&lt;Task&gt;&gt;,
}

struct Spawner {
    task_sender: SyncSender&lt;Arc&lt;Task&gt;&gt;,
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="wasm-å®ç°ç”Ÿå‘½æ¸¸æˆ"><a class="header" href="#wasm-å®ç°ç”Ÿå‘½æ¸¸æˆ">Wasm å®ç°ç”Ÿå‘½æ¸¸æˆ</a></h1>
<h2 id="hello-wasm"><a class="header" href="#hello-wasm">hello-wasm</a></h2>
<p><a href="https://developer.mozilla.org/zh-CN/docs/WebAssembly/Rust_to_wasm">MDN æ•™ç¨‹</a></p>
<h3 id="å®‰è£…å‡†å¤‡"><a class="header" href="#å®‰è£…å‡†å¤‡">å®‰è£…å‡†å¤‡</a></h3>
<ul>
<li>å®‰è£… Rust</li>
<li>å®‰è£… wasm-pack</li>
</ul>
<pre><code>cargo install wasm-pack
</code></pre>
<ul>
<li>å®‰è£… node.js å¹¶æ³¨å†Œè´¦æˆ·</li>
</ul>
<pre><code class="language-powershell">&gt; npm adduser
Username: $username
Password:
Email: (this IS public) $you@example.com
</code></pre>
<h3 id="æ„å»º-webassembly-npm-åŒ…"><a class="header" href="#æ„å»º-webassembly-npm-åŒ…">æ„å»º WebAssembly npm åŒ…</a></h3>
<h4 id="æ–°å»ºé¡¹ç›®"><a class="header" href="#æ–°å»ºé¡¹ç›®">æ–°å»ºé¡¹ç›®</a></h4>
<pre><code>cargo new --lib hello-wasm

+-- Cargo.toml
+-- src
    +-- lib.rs
</code></pre>
<h4 id="librs"><a class="header" href="#librs">lib.rs</a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>extern crate wasm_bindgen;

use wasm_bindgen::prelude::*;

#[wasm_bindgen]
extern {
    pub fn alert(s: &amp;str);
}

#[wasm_bindgen]
pub fn greet(name: &amp;str) {
    alert(&amp;format!(&quot;Hello, {}!&quot;, name));
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="cargotoml"><a class="header" href="#cargotoml">Cargo.toml</a></h4>
<pre><code class="language-toml">[package]
name = &quot;hello-wasm&quot;
version = &quot;0.1.0&quot;
authors = [&quot;Your Name &lt;you@example.com&gt;&quot;]
description = &quot;A sample project with wasm-pack&quot;
license = &quot;MIT/Apache-2.0&quot;
repository = &quot;https://github.com/yourgithubusername/hello-wasm&quot;

[lib]
crate-type = [&quot;cdylib&quot;]

[dependencies]
wasm-bindgen = &quot;0.2&quot;
</code></pre>
<h4 id="æ„å»ºå‘å¸ƒ"><a class="header" href="#æ„å»ºå‘å¸ƒ">æ„å»ºå‘å¸ƒ</a></h4>
<pre><code class="language-shell"># æ„å»º
wasm-pack build --scope $mynpmusername
# å‘å¸ƒ
cd pkg
npm publish --access=public
</code></pre>
<h3 id="åœ¨-webpack-é¡¹ç›®ä½¿ç”¨"><a class="header" href="#åœ¨-webpack-é¡¹ç›®ä½¿ç”¨">åœ¨ webpack é¡¹ç›®ä½¿ç”¨</a></h3>
<h4 id="ç›®å½•"><a class="header" href="#ç›®å½•">ç›®å½•</a></h4>
<pre><code>+-- site
    +-- package.json
    +-- webpack.config.js
    +-- index.html
</code></pre>
<h4 id="packagejson-1"><a class="header" href="#packagejson-1">package.json</a></h4>
<pre><code class="language-json">{
  &quot;scripts&quot;: {
    &quot;serve&quot;: &quot;webpack-dev-server&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@mynpmusername/hello-wasm&quot;: &quot;^0.1.0&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;webpack&quot;: &quot;^4.25.1&quot;,
    &quot;webpack-cli&quot;: &quot;^3.1.2&quot;,
    &quot;webpack-dev-server&quot;: &quot;^3.1.10&quot;
  }
}
</code></pre>
<h4 id="webpackconfigjs"><a class="header" href="#webpackconfigjs">webpack.config.js</a></h4>
<pre><code class="language-js">const path = require(&quot;path&quot;);
module.exports = {
  entry: &quot;./index.js&quot;,
  output: {
    path: path.resolve(__dirname, &quot;dist&quot;),
    filename: &quot;index.js&quot;,
  },
  mode: &quot;development&quot;,
};
</code></pre>
<h4 id="indexhtml"><a class="header" href="#indexhtml">index.html</a></h4>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;hello-wasm example&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;script src=&quot;./index.js&quot;&gt;&lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h4 id="indexjs"><a class="header" href="#indexjs">index.js</a></h4>
<pre><code class="language-js">const js = import(&quot;./node_modules/@yournpmusername/hello-wasm/hello_wasm.js&quot;);
js.then((js) =&gt; {
  js.greet(&quot;WebAssembly&quot;);
});
</code></pre>
<h4 id="å¯åŠ¨"><a class="header" href="#å¯åŠ¨">å¯åŠ¨</a></h4>
<pre><code class="language-shell">$ npm install
$ npm run serve
</code></pre>
<h2 id="åº·å¨ç”Ÿå‘½æ¸¸æˆ"><a class="header" href="#åº·å¨ç”Ÿå‘½æ¸¸æˆ">åº·å¨ç”Ÿå‘½æ¸¸æˆ</a></h2>
<h3 id="å†…å­˜æ’å¸ƒ"><a class="header" href="#å†…å­˜æ’å¸ƒ">å†…å­˜æ’å¸ƒ</a></h3>
<p>js çš„<code>Object</code>, <code>Array</code>, <code>DOM Nodes</code>ç­‰å¯¹è±¡éƒ½å­˜å‚¨åœ¨ GC Heap ä¸Š
wasm çš„å†…å­˜æ˜¯å’Œ js åˆ†ç¦»çš„ï¼Œçº¿å‹æ’å¸ƒï¼Œrust çš„æ•°æ®å°±å­˜åœ¨å…¶ä¸­</p>
<h3 id="js-ä¸-rust-é€šè®¯"><a class="header" href="#js-ä¸-rust-é€šè®¯">js ä¸ rust é€šè®¯</a></h3>
<p>wasm ç›®å‰æ— æ³•ç›´æ¥è®¿é—® js çš„ GC Heap(è¿™ç‚¹å¯èƒ½ä¼šæ”¹å˜ï¼Œwasm ææ¡ˆæ­£å°è¯•ä¸º wasm åŠ å…¥é«˜çº§æ•°æ®ç±»å‹),
è€Œ js å¯ä»¥ç›´æ¥è®¿é—® wasm çš„å†…å­˜æ•°æ®ï¼Œè™½ç„¶éœ€è¦æŠŠæ•°æ®è½¬æ¢ä¸ºå›ºå®šå¤§å°çš„ buf array(u8, i32, f64 ...). wasm å‡½æ•°ä¹Ÿåªèƒ½æ¥å—è¿”å›æ ‡é‡å€¼ã€‚
ä¸Šé¢çš„å†…å®¹æ„æˆäº† js å’Œ wasm é€šè®¯çš„åŸºæœ¬æ¨¡å—</p>
<h3 id="wasm-bindgen"><a class="header" href="#wasm-bindgen">wasm-bindgen</a></h3>
<p>è¯¥å·¥å…·åŒ…è£…äº† rust æ•°æ®ç»“æ„ï¼Œå¹¶èƒ½å¤Ÿå°†æŒ‡é’ˆè¿”å›ç»™ jsï¼Œå°è£…äº† js å¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨ js-api</p>
<p>ä½†æ˜¯ä¾ç„¶éœ€è¦è€ƒè™‘å¦‚ä½•è®¾è®¡æ•°æ®ç»“æ„ä»¥é€‚é… wasm çš„éœ€è¦</p>
<h3 id="æ³¨æ„äº‹é¡¹-1"><a class="header" href="#æ³¨æ„äº‹é¡¹-1">æ³¨æ„äº‹é¡¹</a></h3>
<ul>
<li>
<p>æœ€å°åŒ– copy æ•°æ®ï¼Œåœ¨ js å’Œ wasm ä¹‹é—´æ‹·è´æ•°æ®ä¼šå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€ å¦‚æœ js èƒ½å¤Ÿä½¿ç”¨æŒ‡é’ˆç›´æ¥æ“ä½œ wasm æ•°æ®ï¼Œå°±èƒ½å¤§å¹…å‡å°‘å¼€é”€</p>
</li>
<li>
<p>æœ€å°åŒ–åºåˆ—åŒ–</p>
</li>
</ul>
<p>ä¸€äº›å¤§å‹çš„ï¼Œé•¿æœŸå­˜åœ¨çš„æ•°æ®ç»“æ„åº”è¯¥å°†æŒ‡é’ˆæš´éœ²ç»™ js</p>
<h3 id="ä¼˜åŒ–æ–¹å‘"><a class="header" href="#ä¼˜åŒ–æ–¹å‘">ä¼˜åŒ–æ–¹å‘</a></h3>
<ol>
<li>
<p>consle.EndTime è®¡ç®—å‡½æ•°æ‰§è¡Œæ—¶é—´</p>
</li>
<li>
<p>ç»“åˆæµè§ˆå™¨æ€§èƒ½åˆ†æå·¥å…·ï¼Œè§‚å¯Ÿå‡½æ•°è°ƒç”¨æ ˆçš„æ—¶é—´å æ¯”</p>
</li>
<li>
<p>bench å‡†å¤‡é¡¹ç›®</p>
</li>
</ol>
<ul>
<li>åˆ‡æ¢åˆ°<code>nightly</code>ç‰ˆæœ¬ï¼Œé¡¹ç›®æ ¹ç›®å½•ä¸‹å¢åŠ <code>toolchain</code>æ–‡ä»¶ï¼Œå†™å…¥<code>nightly</code>å³å¯</li>
<li>æ³¨é‡Šæ‰æ‰€æœ‰çš„<code>#[wasm-bindgen]</code></li>
<li>æ³¨é‡Šæ‰æ‰€æœ‰çš„<code>web-sys</code>è°ƒç”¨</li>
</ul>
<p>å¼€å§‹æµ‹è¯•ï¼Œå¹¶å°†ç»“æœå¯¼å‡ºåˆ° before.txt</p>
<pre><code class="language-shell">cargo bench | tee before.txt
</code></pre>
<p>ä» before.txt ä¸­è·å–è¿è¡Œç»“æœï¼Œæ‰¾åˆ°å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½¿ç”¨ perf å†æ¬¡è¿è¡Œè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶</p>
<pre><code>perf record -g target/release/deps/bench-2e4b55af5ebabae8 --bench
</code></pre>
<p>æŸ¥çœ‹ç»“æœ</p>
<pre><code>perf report
</code></pre>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241137609.png" alt="" />
æŒ‰ä¸‹<code>a</code>æŸ¥çœ‹æ±‡ç¼–ä»£ç çš„æ—¶é—´ç»Ÿè®¡ç»“æœ
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241138801.png" alt="" />
ç«Ÿç„¶ç›¸å·®äº†åå‡ å€</p>
<pre><code>before: test universe_ticks ... bench:     215,952 ns/iter (+/- 7,814)
after : test universe_ticks ... bench:      18,912 ns/iter (+/- 5,025)
</code></pre>
<p>ä» 10ms é™ä½åˆ° 3ms
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203241453849.png" alt="" /></p>
<h3 id="-å±•ç¤º"><a class="header" href="#-å±•ç¤º">ğŸ‰ å±•ç¤º</a></h3>
<p>åº·ä¸ºç”Ÿå‘½æ¸¸æˆ
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203231913525.png" alt="å›¾ç‰‡" /></p>
<h2 id="-idea"><a class="header" href="#-idea">â­ idea</a></h2>
<ul>
<li>å­—ç¬¦ç”»ç½‘é¡µ</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-quiz"><a class="header" href="#rust-quiz">Rust Quiz</a></h1>
<h2 id="1-statement-boundry"><a class="header" href="#1-statement-boundry">#1 <code>statement boundry</code></a></h2>
<h3 id="é¢˜ç›®"><a class="header" href="#é¢˜ç›®">é¢˜ç›®</a></h3>
<p>ä¸‹é¢çš„ 1 è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ</p>
<pre><code class="language-rs">macro_rules! m {
    ($( $s:stmt )*) =&gt; {
        $(
            { stringify!($s); 1 }
        )&lt;&lt;*
    };
}

fn main() {
    print!(
        &quot;{}{}{}&quot;,
        m! { return || true },
        m! { (return) || true },
        m! { {return} || true },
    );
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º"><a class="header" href="#æç¤º">æç¤º</a></h3>
<p>å®çš„è¾“å‡ºä¸­çš„è¡¨è¾¾å¼ä¸ <code>1 &lt;&lt; (n - 1)</code> æ•ˆæœç›¸åŒï¼Œå…¶ä¸­ n æ˜¯å®è¾“å…¥ä¸­åŒ…å«çš„ Rust è¯­å¥çš„æ•°é‡ã€‚</p>
<h3 id="è§£ç­”"><a class="header" href="#è§£ç­”">è§£ç­”</a></h3>
<p>ç­”æ¡ˆï¼š122</p>
<p>è¿™ä¸ªé—®é¢˜å›´ç»•ç€ Rust çš„è¯­æ³•è¾¹ç•Œè®¾è®¡ã€‚</p>
<blockquote>
<p>This question revolves around where the Rust grammar places statement
boundaries.</p>
</blockquote>
<p>å®çš„è¾“å…¥è§„åˆ™æ˜¯ <code>$( $s:stmt )*</code>, å®ƒèƒ½å¤ŸåŒ¹é…åˆ° 0 æˆ–å¤šä¸ª Rust è¯­å¥ã€‚</p>
<p>è¯¥è§„åˆ™å†…éƒ¨çš„ <code>$s: stmt</code> æ˜¯ä¸€ä¸ªç‰‡æ®µåˆ†ç±»ç¬¦ï¼Œå®ƒèƒ½å¤ŸåŒ¹é…åˆ°ä¸€ä¸ªç¬¦åˆ Rust è¯­æ³•è§„èŒƒçš„è¡¨è¾¾å¼ã€‚è¢«åŒ¹é…åˆ°çš„è¯­å¥å¯ä»¥åœ¨å±•å¼€åçš„ä»£ç ä¸­ä½œä¸º <code>$s</code> ã€‚</p>
<p>è€Œå¤–éƒ¨çš„ <code>$(...)*</code> éƒ¨åˆ†è¡¨ç¤ºä¸€ä¸ªé‡å¤ï¼Œå®ƒå¯ä»¥é‡å¤åŒ¹é… 0 æˆ–å¤šæ¬¡å†…å®¹ã€‚</p>
<blockquote>
<p>The input rule of the macro m! is $($s:stmt)<em>which matches zero or more Rust
statements. The $(...)</em> part of the rule is a repetition which matches the
contents of the repetition zero or more times, and the $s:stmt is a fragment
specifier that matches a Rust statement (stmt) conforming to the rules of the
Rust grammar. The matched statements are available within the expanded code as
the fragment variable $s.</p>
</blockquote>
<p>è¯­å¥æ˜¯å‡½æ•°ä½“ä¸­å…è®¸çš„æœ€é«˜çº§åˆ«çš„è¯­æ³•å•ä½ã€‚ä¸‹é¢æ‰€æœ‰çš„å†…å®¹éƒ½æ˜¯è¯­å¥çš„ä¾‹å­ã€‚</p>
<blockquote>
<p>A statement is the top-level unit of syntax permitted within a function body.
All of the following are examples of statements.</p>
</blockquote>
<pre><code class="language-rs">// Items are statements.
struct S { x: u64 }

// Let-bindings are statements.
let mut s = S { x: 1 }

// Expressions are statements.
s.x + 1
</code></pre>
<p>å‡½æ•°ä½“çš„è¯­æ³•è¦æ±‚æŸäº›ç±»å‹çš„è¯­å¥åé¢æœ‰ä¸€ä¸ªåˆ†å·ï¼Œä½†å¯¹äºå®çš„è¯­æ³•è€Œè¨€ï¼Œåˆ†å·å¹¶ä¸æ˜¯è¯­å¥çš„ä¸€éƒ¨åˆ†ã€‚</p>
<blockquote>
<p>The grammar of function bodies requires that some types of statements are followed by a semicolon, but the semicolon is not part of the statement for the purpose of macro syntax.</p>
</blockquote>
<p><code>m!</code> å°†ä¼šå±•å¼€æˆ 0 æˆ–å¤šä¸ªç”± <code>&lt;&lt;</code> åˆ†å‰²çš„ <code>{ stringify!($s); 1 }</code>ã€‚<code>$(...)&lt;&lt;*</code> éƒ¨åˆ†è¡¨ç¤ºé‡å¤è¯­å¥ä¹‹é—´ä½¿ç”¨ <code>&lt;&lt;</code> ä½œä¸ºåˆ†éš”ç¬¦ã€‚</p>
<blockquote>
<p>The macro m! expands to zero or more copies of <code>{ stringify!($s); 1 }</code> separated by the <code>&lt;&lt;</code> token. The <code>$(...)&lt;&lt;*</code> part of the rule is a repetition using <code>&lt;&lt;</code> as the separator.</p>
</blockquote>
<p>åœ¨å®ä¸­ä½¿ç”¨ <code>&lt;&lt;</code> ä½œä¸ºåˆ†éš”ç¬¦éå¸¸ä¸å¸¸è§ã€‚æœ€å¸¸ç”¨çš„åˆ†éš”ç¬¦æ˜¯é€—å·ï¼Œ<code>$(...),*</code>ï¼Œå…¶ä»–çš„å•ä¸€ç¬¦å·ä¹Ÿæ˜¯å…è®¸çš„ã€‚é‡è¦çš„æ˜¯ï¼Œ<code>macro_rules!</code> æŠŠæ‰€æœ‰çš„ Rust å†…ç½®æ“ä½œç¬¦éƒ½å½“æˆå• token</p>
<blockquote>
<p>Using <code>&lt;&lt;</code> as a separator in a repetition in a macro is highly unusual. The most commmonly used separator is the comma, written as <code>$(...),*</code>, but any other single token is allowed here. Crucially, macro_rules! treats all built-in Rust operators as single tokens, even those that consist of multiple characters like <code>&lt;&lt;</code>.</p>
</blockquote>
<p><code>{ stringify!($s); 1 }</code> æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå®ƒçš„è¿”å›å€¼æ°¸è¿œæ˜¯ 1ã€‚<code>stringify!($s)</code> è¢«ä¸¢å¼ƒäº†ï¼Œæ‰€ä»¥å®ƒå’Œ <code>{ 1 }</code> çš„æ•ˆæœæ˜¯ç›¸åŒçš„ã€‚è¿™é‡Œä½¿ç”¨ <code>stringify!($s)</code> æ˜¯ä¸ºäº†æ§åˆ¶é‡å¤çš„æ¬¡æ•°ï¼Œè§„åˆ™ä¸­å®šä¹‰çš„æ ‡å¿—ç¬¦</p>
<blockquote>
<p>The <code>{ stringify!($s); 1 }</code> is an expression whose value is always 1. The value of <code>stringify!($s)</code> is discarded, so this is equivalent to the expression <code>{ 1 }</code>. The reason for having <code>stringify!($s)</code> in there is to control the number of times the repetition is repeated, which is determined by which fragment variables are used within the repetition. Writing a repetition without using any fragment variables inside of it would not be legal.</p>
</blockquote>
<p>å‡è®¾æˆ‘ä»¬è°ƒç”¨å®æ—¶ä¼ å…¥ä¸‰æ¡è¯­å¥ï¼š</p>
<blockquote>
<p>Suppose we call this macro with three of the statements shown above as input.</p>
</blockquote>
<pre><code class="language-rs">m! {
    struct S { x: u64 }
    let mut s = S { x: 1 }
    s.x + 1
}
</code></pre>
<p>è¿™ä¸ªå®ä¼šè¢«å±•å¼€ä¸ºï¼š</p>
<blockquote>
<p>The macro expands to:</p>
</blockquote>
<pre><code class="language-rs">{ stringify!(struct S { x: u64 }); 1 }
    &lt;&lt; { stringify!(let mut s = S { x: 1 }); 1 }
    &lt;&lt; { stringify!(s.x + 1); 1 }
</code></pre>
<p>æ¯ä¸ª stringifys éƒ½ä¼šè¢«è½¬ä¸ºå­—ç¬¦ä¸²å­—é¢é‡ï¼š</p>
<blockquote>
<p>Each of the stringifys expands to a string literal:</p>
</blockquote>
<pre><code class="language-rs">{ &quot;struct S { x: u64 }&quot;; 1 }
    &lt;&lt; { &quot;let mut s = S { x: 1 }&quot;; 1 }
    &lt;&lt; { &quot;s.x + 1&quot;; 1 }
</code></pre>
<p>å­—ç¬¦ä¸²å­—é¢é‡çš„å€¼æ²¡æœ‰è¢«ä½¿ç”¨ã€‚æ‰€ä»¥è¿™ä¸ªç»“æœç­‰ä»·äº <code>{ 1 } &lt;&lt; { 1 } &lt;&lt; { 1 }</code>ï¼Œä¹Ÿç­‰ä»·äº <code>1 &lt;&lt; 1 &lt;&lt; 1</code>ã€‚<code>&lt;&lt;</code> æ“ä½œç¬¦å°±æ˜¯å·¦ç§»ï¼›ç»“æœæ˜¯ 4ã€‚</p>
<blockquote>
<p>The values of the string literals are not used. In this case the expression is equivalent to <code>{ 1 } &lt;&lt; { 1 } &lt;&lt; { 1 }</code>, which is equivalent to <code>1 &lt;&lt; 1 &lt;&lt; 1</code>. The <code>&lt;&lt;</code> operator is left-associative; the numeric value of this expression is 4.</p>
</blockquote>
<p>æ€»çš„æ¥è¯´ï¼ŒRust è¯­å¥æœ‰å¤šå°‘ï¼Œ1 å°±é‡å¤å¤šå°‘æ¬¡ã€‚æ‰€ä»¥è¿™ä¸ªå®å°±ç›¸å½“äº <code>1 &lt;&lt; (n - 1)</code>ã€‚å½“ n ä¸º 0 æ—¶ï¼Œè¯­å¥æ— æ³•å±•å¼€ï¼Œä¼šç¼–è¯‘å¤±è´¥ã€‚</p>
<blockquote>
<p>Altogether, the relevant behavior of this macro is that it evaluates to <code>1 &lt;&lt; 1 &lt;&lt; 1 &lt;&lt; ...</code> where the number of ones is equal to the number of Rust statements in the input of the macro. In closed form, the numeric value is <code>1 &lt;&lt; (n - 1)</code> where n is the number of statements, except in the case that n is zero where the macro expands to nothing and we get a syntax error at the call site.</p>
</blockquote>
<p>å‰©ä¸‹çš„å°±æ˜¯åˆ¤æ–­ä¸€ä¸‹è¿™ 3 æ¬¡è°ƒç”¨åˆ†åˆ«ä¼ å…¥äº†å¤šå°‘ä¸ª Rust è¯­å¥ã€‚</p>
<blockquote>
<p>It remains to determine how many statements are in the three invocations of m! in the quiz code.</p>
</blockquote>
<ol>
<li><code>return || true</code></li>
</ol>
<p>è¿™æ˜¯ä¸€æ¡ return è¯­å¥ï¼Œä»–è¿”å›çš„ y æ˜¯ä¸€ä¸ªé—­åŒ… <code>|| true</code>ã€‚ç­‰ä»·äº <code>(|| true)</code>ã€‚æ‰€ä»¥ä»–ä¼šè¢«è§£æä¸ºä¸€æ¡è¯­å¥ï¼Œè°ƒç”¨ <code>m!</code> çš„ç»“æœæ˜¯ 1ã€‚</p>
<blockquote>
<p>This is a return-expression that would return the closure <code>|| true</code>. It is
equivalent to return <code>(|| true)</code>. It is parsed as a single statement so the m! invocation evaluates to 1</p>
</blockquote>
<ol start="2">
<li><code>(return) || true</code></li>
</ol>
<p>è¿™æ˜¯ä¸€æ¡é€»è¾‘æˆ–è¯­å¥ã€‚<code>||</code> æ˜¯ä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼Œå·¦ä¾§æ˜¯ä¸€ä¸ª <code>(return)</code> è¯­å¥ (æˆ–è€…è¯´ <code>!</code> ç±»å‹)ï¼Œå³ä¾§æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ <code>true</code>ã€‚æ‰€ä»¥ <code>(return) || true</code> æ˜¯ä¸€ä¸ªè¯­å¥ï¼Œ<code>m!</code> çš„å€¼ä»ç„¶ä¸º 1ã€‚</p>
<blockquote>
<p>This is a logical-OR expression. The <code>||</code> is a binary operator, where the left-hand side is the expression <code>(return)</code> (of diverging type <code>!</code>) and the right-hand side is the expression <code>true</code>. This expression is a single statement so m! again evaluates to 1.</p>
</blockquote>
<ol start="3">
<li><code>{return} || true</code></li>
</ol>
<p>è¿™æ¡æ˜¯ä¸¤ä¸ªè¯­å¥ï¼ä¸€ä¸ªå—è¡¨è¾¾å¼ <code>return</code>ï¼Œåé¢åˆè·Ÿä¸€ä¸ªé—­åŒ… <code>|| true</code>ã€‚</p>
<blockquote>
<p>This one is two statements! A block-statement <code>{return}</code> followed by a closure expression <code>|| true</code>.</p>
</blockquote>
<p>Rust çš„è¯­æ³•åŒºåˆ†äº†éœ€è¦åˆ†å·çš„è¡¨è¾¾å¼ (ä½œä¸ºå•ä¸ªè¡¨è¾¾å¼) å’Œæ— éœ€åˆ†å·çš„ä¸€ç»„è¡¨è¾¾å¼ã€‚çœ‹çœ‹ä¸‹é¢çš„ä¸¤ä¸ªä¾‹å­ï¼š</p>
<blockquote>
<p>The Rust grammar distinguishes between expressions that require a semicolon in order to stand alone as a statement, and expressions that can be statements even without a semicolon. Consider two examples:</p>
</blockquote>
<pre><code class="language-rs">// ç»“å°¾ä¸éœ€è¦åˆ†å·ã€‚
for t in vec {
    /* ... */
}

// ç»“å°¾éœ€è¦åˆ†å·ã€‚
self.skip_whitespace()?;
</code></pre>
<p>ä¸éœ€è¦åˆ†å·çš„è¡¨è¾¾å¼éƒ½å®šä¹‰åœ¨ libsyntex é‡Œã€‚The distinction informs a few different early bail-out cases where the parser decides to finish parsing the current expression.(èƒ½åŠ›æœ‰é™ï¼Œä¸ä¼šç¿»è¯‘)</p>
<blockquote>
<p>The list of expression types that stand alone without a semicolon is defined here in libsyntax. The distinction informs a few different early bail-out cases where the parser decides to finish parsing the current expression.</p>
</blockquote>
<p>å—è¡¨è¾¾å¼ <code>{ /* ... */ }</code> ç»ˆæ­¢ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå’Œæœ¬é¢˜çš„æƒ…å†µç›¸åŒã€‚å¦‚æœè¿™æ ·åšåœ¨è¯­æ³•ä¸Šæ˜¯åˆç†çš„ï¼Œé‚£å°±æ„å‘³ç€è§£æå™¨åœ¨å—è¡¨è¾¾å¼ä¹‹åä¸ä¼šç«‹å³æ¶ˆè€—äºŒå…ƒè¿ç®—ç¬¦ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ã€‚</p>
<blockquote>
<p>Relevant to our case is that block expressions <code>{ /* ... */ }</code> terminate an expression if doing so would be syntactically sensible. The parser does not eagerly consume binary operators after a block expression. Thus one might write:</p>
</blockquote>
<pre><code class="language-rs">fn f() -&gt; &amp;'static &amp;'static bool {
    // å—è¡¨è¾¾å¼ã€‚
    {
        println!(&quot;What a silly function.&quot;);
    }

    // true çš„å¼•ç”¨çš„å¼•ç”¨ã€‚
    &amp;&amp;true
}
</code></pre>
<p>ä¸ºäº†æ­£ç¡®è§£æè¿™ç§æƒ…å†µï¼ˆå—è¡¨è¾¾å¼åé¢ç´§è·Ÿä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ï¼‰ï¼Œè§£æå™¨éœ€è¦åœ¨è¡¨è¾¾å¼çš„æœ«å°¾åŠæ—¶ç»ˆæ­¢ã€‚</p>
<blockquote>
<p>In order to parse a block followed by a binary operator, we would need to make it syntactically insensible for the parser to terminate an expression at the close curly brace. This would usually be done by wrapping in parentheses.</p>
</blockquote>
<pre><code class="language-rs">fn f() -&gt; bool {
    ({ true } &amp;&amp; true)
}
</code></pre>
<p>æ€»ä¹‹ï¼Œè¯¥ç¨‹åºçš„è¾“å‡ºæ˜¯ 112ã€‚</p>
<blockquote>
<p>Anyhow, the output of the program is 112.</p>
</blockquote>
<h2 id="2-impl-bitand"><a class="header" href="#2-impl-bitand">#2 <code>impl BitAnd</code></a></h2>
<h3 id="é¢˜ç›®-1"><a class="header" href="#é¢˜ç›®-1">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct S(i32);

impl std::ops::BitAnd&lt;S&gt; for () {
    type Output = ();

    fn bitand(self, rhs: S) {
        print!(&quot;{}&quot;, rhs.0);
    }
}

fn main() {
    let f = || ( () &amp; S(1) );
    let g = || { () &amp; S(2) };
    let h = || ( {} &amp; S(3) );
    let i = || { {} &amp; S(4) };
    f();
    g();
    h();
    i();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-1"><a class="header" href="#æç¤º-1">æç¤º</a></h3>
<p>å…¶ä¸­ä¸€ä¸ªé—­åŒ…å’Œå¦å¤–ä¸‰ä¸ªä¸åŒã€‚</p>
<h3 id="é¢˜è§£"><a class="header" href="#é¢˜è§£">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š123</p>
<p>fï¼Œg å’Œ h éƒ½æ˜¯ <code>impl Fn()</code>ã€‚é—­åŒ…çš„ body éƒ½ä¼šè¢«è§£æä¸ºå¯¹ä¸Šé¢ç”± BitAnd Trait å®šä¹‰çš„ bitwise-AND æ“ä½œç¬¦çš„è°ƒç”¨ã€‚å½“é—­åŒ…è¢«è°ƒç”¨æ—¶ï¼Œbitwise-AND ä¼šæ‰“å°å‡ºå³ä¾§ S çš„å†…å®¹ï¼Œé—­åŒ…åˆ™è¿”å› <code>()</code>ã€‚</p>
<blockquote>
<p>The closures f, g, and h are all of type impl Fn(). The closure bodies are parsed as an invocation of the user-defined bitwise-AND operator defined above by the BitAnd trait impl. When the closures are invoked, the bitwise-AND implementation prints the content of the S from the right-hand side and evaluates to ().</p>
</blockquote>
<p>é—­åŒ… i åˆ™ä¸ç—›ã€‚ä½¿ç”¨ rustfmt æ ¼å¼åŒ–ä»£ç ä¼šè®©ä»–æ›´æ¸…æ™°ï¼š</p>
<blockquote>
<p>The closure i is different. Formatting the code with rustfmt makes it clearer how i is parsed.</p>
</blockquote>
<pre><code class="language-rs">let i = || {
    {}
    &amp;S(4)
};
</code></pre>
<p>é—­åŒ…ä½“ç”±ä¸€ä¸ªç©ºçš„å—çŠ¶è¯­å¥ {} å’Œåé¢çš„å¯¹ S(4) çš„å¼•ç”¨ç»„æˆï¼Œè€Œä¸æ˜¯ä¸€ä¸ª bitwise-AND æ“ä½œã€‚i çš„ç±»å‹æ˜¯ <code>impl Fn() -&gt; &amp;'static S</code>ã€‚</p>
<blockquote>
<p>The closure body consists of an empty block-statement {} followed by a reference to S(4), not a bitwise-AND. The type of i is impl Fn() -&gt; &amp;'static S.</p>
</blockquote>
<p>f å¯¹è¿™ç§æƒ…å†µçš„è§£ææ˜¯ç”± libsyntax ä¸­çš„ä»£ç ç®¡ç†çš„ã€‚</p>
<blockquote>
<p>The parsing of this case is governed by this code in libsyntax.</p>
</blockquote>
<h2 id="3-const-initializer"><a class="header" href="#3-const-initializer">#3 <code>const initializer</code></a></h2>
<h3 id="é¢˜ç›®-2"><a class="header" href="#é¢˜ç›®-2">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct S {
    x: i32,
}

const S: S = S { x: 2 };

fn main() {
    let v = &amp;mut S;
    v.x += 1;
    S.x += 1;
    print!(&quot;{}{}&quot;, v.x, S.x);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-2"><a class="header" href="#æç¤º-2">æç¤º</a></h3>
<p><code>const</code> å’Œ ä¸å¯å˜çš„ <code>static</code> æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p>
<h3 id="é¢˜è§£-1"><a class="header" href="#é¢˜è§£-1">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š32</p>
<p>const çš„è¯­ä¹‰æ˜¯ï¼Œä»»ä½•åœ¨è¡¨è¾¾å¼ä½ç½®ä¸Šä»¥åç§°æåŠçš„ <code>const</code> éƒ½ä¼šè¢« const initializer çš„å€¼æ‰€æ›¿ä»£ã€‚ä¸Šé¢çš„ä»£ç å…¶å®ç­‰åŒäºï¼š</p>
<blockquote>
<p>The semantics of const is that any mention of the const by name in expression position is substituted with the value of the const initializer. In this quiz code the behavior is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">struct S {
    x: i32,
}

fn main() {
    let v = &amp;mut S { x: 2 };
    v.x += 1;
    S { x: 2 }.x += 1;
    print!(&quot;{}{}&quot;, v.x, S { x: 2 }.x);
}
</code></pre>
<p>è¿™é‡Œæˆ‘åªæ˜¯ç®€å•åœ°æŠŠæ¯ä¸€ä¸ªæåˆ° S çš„åœ°æ–¹éƒ½ç”¨ <code>const S</code> çš„å€¼æ¥ä»£æ›¿ï¼Œå³ <code>S { x: 2 }</code>ã€‚</p>
<blockquote>
<p>I have simply substituted every mention of S in expresson position with the value of const S which is S { x: 2 }.</p>
</blockquote>
<p>main çš„ç¬¬ä¸€è¡Œç­‰åŒäºï¼š</p>
<blockquote>
<p>The first line of main is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">let mut _tmp0 = S { x: 2 };
let v = &amp;mut _tmp0;
</code></pre>
<p>main çš„ç¬¬äºŒè¡Œæ”¹å˜äº† v æŒ‡å‘çš„ xï¼Œåœ¨ v å‰©ä½™çš„ç”Ÿå‘½æœŸå†…ï¼Œx ä»ç„¶å¯ä»¥é€šè¿‡ v è®¿é—®ï¼Œå› æ­¤æ‰“å°çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ 3ã€‚</p>
<blockquote>
<p>The second line of main mutates the value pointed to by v. The same value remains accessible through v for the rest of the lifetime of v, which is why the first character printed is 3.</p>
</blockquote>
<p>main çš„ç¬¬ä¸‰è¡Œæ”¹å˜äº†ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè¯¥å˜é‡åœ¨åˆ†å·ç»“å°¾å°±ç«‹å³è¶…å‡ºäº†ä½œç”¨åŸŸã€‚æ‰“å°çš„ç¬¬äºŒä¸ªå­—ç¬¦æ¥è‡ªä¸€ä¸ªå…¨æ–°çš„<code>S { x: 2 }</code>ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªæ‰“å°çš„æ˜¯ 2ã€‚</p>
<blockquote>
<p>The third line of main mutates a temporary that immediately goes out of scope at the semicolon. The second character printed is coming from a brand new S { x: 2 }, so 2 is printed.</p>
</blockquote>
<p>è¿™æ®µä»£ç ä¸­è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯ Rust ä¸­å…³äºå‘½åç©ºé—´å’Œåå­—è§£æçš„æ¦‚å¿µã€‚ä»»ä½•æŒ‡ä»£ç±»å‹çš„åå­—éƒ½åœ¨ç±»å‹å‘½åç©ºé—´ï¼Œä»»ä½•æŒ‡ä»£å€¼çš„åå­—éƒ½åœ¨å€¼å‘½åç©ºé—´ã€‚</p>
<p>è¿™æ˜¯ä¸¤ç»„ä¸åŒçš„åå­—ï¼Œè€Œè¯­è¨€çš„ç»“æ„ä½¿æˆ‘ä»¬æ€»æ˜¯å¯ä»¥çŸ¥é“åœ¨å“ªä¸ªå‘½åç©ºé—´ä¸­æŸ¥æ‰¾ä¸€ä¸ªåå­—ã€‚</p>
<blockquote>
<p>One additional wrinkle in this code is the concept of namespaces and name resolution in Rust. Any name that refers to a type lives in the type namespace, and any name that refers to a value lives in the value namespace. These are two separate sets of names, and the language is structured such that we can always tell which namespace to look up a name in.</p>
</blockquote>
<p>åœ¨ä»£ç çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç»“æ„ä½“ S çš„åç§°æ˜¯ç±»å‹åç§°ç©ºé—´çš„ä¸€éƒ¨åˆ†ï¼Œè€Œå¸¸é‡ S çš„åç§°æ˜¯å€¼åç§°ç©ºé—´çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥ï¼Œåœ¨åŒä¸€æ—¶é—´çœ‹åˆ°ä¸¤ä¸ªç›¸åŒåç§°çš„ä¸åŒäº‹ç‰©ã€‚</p>
<blockquote>
<p>In the context of the quiz code, the name of the struct S is part of the type namespace and the name of the const S is part of the value namespace. That is how we can have seemingly two different things with the same name in scope at the same time.</p>
</blockquote>
<h2 id="4-"><a class="header" href="#4-">#4 <code>..</code></a></h2>
<h3 id="é¢˜ç›®-3"><a class="header" href="#é¢˜ç›®-3">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn main() {
    let (.., x, y) = (0, 1, ..);
    print!(&quot;{}&quot;, b&quot;066&quot;[y][x]);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-3"><a class="header" href="#æç¤º-3">æç¤º</a></h3>
<p><code>..</code> åœ¨è¡¨è¾¾ä¸­å’Œæ¨¡å¼åŒ¹é…ä¸­å«ä¹‰ä¸åŒã€‚</p>
<blockquote>
<p>.. means one thing in an expression and something else in a pattern.</p>
</blockquote>
<h3 id="é¢˜è§£-2"><a class="header" href="#é¢˜è§£-2">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š54</p>
<p>è¿™ä¸ªé—®é¢˜å±•ç¤ºäº† <code>..</code>ä¸åŒå«ä¹‰</p>
<blockquote>
<p>This question demonstrates two different meanings of ...</p>
</blockquote>
<p>åœ¨è¡¨è¾¾å¼çš„ä¸€ä¾§ (å³ä¾§), <code>..</code> æ˜¯æ„é€ é—° <code>Range</code> ç±»å‹çš„è¯­æ³•ï¼Œè¡¨è¾¾å¼ <code>(0, 1, ..)</code> æ˜¯ä¸€ä¸ªæ‹¥æœ‰ä¸‰ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œå…¶ä¸­çš„ç¬¬ä¸‰ä¸ªæ‹¥æœ‰ RangeFull ç±»å‹ã€‚</p>
<blockquote>
<p>In expression position, .. is the syntax for constructing various types of ranges. Here the expression (0, 1, ..) is a tuple with three elements, the third one having type RangeFull.</p>
</blockquote>
<p>åœ¨æ¨¡å¼çš„ä¸€ä¾§ï¼Œ<code>..</code> è¢«ç”¨æ¥è¡¨ç¤ºä»»ä½•æ•°é‡çš„å…ƒç´ ã€‚æ‰€ä»¥æ¨¡å¼ <code>(.., x, y)</code> ä¼šåŒ¹é…åˆ°ä¸€ä¸ªæ‹¥æœ‰ä¸¤ä¸ªæˆ–è€…æ›´å¤šå…ƒç´ çš„å…ƒç»„ï¼Œå¹¶æŠŠå€’æ•°ç¬¬ 2 ä¸ªå…ƒç´ ç»‘å®šåˆ° x ä¸Šï¼Œæœ€åä¸€ä¸ªæ•°ç»‘å®šåˆ° y ä¸Šã€‚</p>
<blockquote>
<p>On the other hand in a pattern, .. is used to mean &quot;any number of elements&quot;. So the pattern (.., x, y) matches a tuple with 2 or more elements, binding the second-last one to x and the last one to y.</p>
</blockquote>
<p>æ‰€ä»¥åœ¨é¢çš„ç¬¬ 1 è¡Œï¼Œx çš„å€¼ä¸º 1ï¼Œy çš„å€¼ä¸º <code>(..)</code>ã€‚å› æ­¤æ‰“å°å‡ºæ¥çš„æ˜¯ <code>b&quot;066[..][1]&quot;</code>ã€‚</p>
<blockquote>
<p>Coming out of the first line of main, we have x = 1 and y = (..). Thus the value printed is going to be b&quot;066&quot;[..][1].</p>
</blockquote>
<p><code>b&quot;066&quot;</code> æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œä»–æ˜¯ä¸€ä¸ª Byte å½¢å¼çš„å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå®ƒçš„ç±»å‹æ˜¯ <code>&amp;'static [u8; 3]</code>, æ‹¥æœ‰ä¸‰ä¸ª ASCII å­—ç¬¦ <code>b'0'</code>, <code>b'6'</code>, <code>b'6'</code>ã€‚</p>
<blockquote>
<p>The expression b&quot;066&quot; is a byte-string literal of type &amp;'static [u8; 3] containing the three ASCII bytes b'0', b'6', b'6'.</p>
</blockquote>
<p>å½“æˆ‘ä»¬ç”¨ RangeFull å¯¹å­—èŠ‚ä¸²è¿›åˆ‡ç‰‡æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªé•¿åº¦ä¸º 3 çš„åŠ¨æ€å¤§å°çš„åˆ‡ç‰‡ [u8]ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è®¿é—®åˆ‡ç‰‡åœ¨ 1 å¤„çš„å…ƒç´ ï¼Œå³ç±»å‹ä¸º u8 çš„å­—èŠ‚ <code>b'6'</code>ã€‚å½“æ‰“å°æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ˜¯ ASCII æ•°å­— 6 çš„åè¿›åˆ¶è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯æ•°å­— 54ã€‚</p>
<blockquote>
<p>When we slice the byte-string with RangeFull we get a dynamically sized slice [u8] of length 3. Next we access element 1 of the slice, which is the byte b'6' of type u8. When printed, we see the decimal representation of the byte value of the ASCII digit 6, which is the number 54.</p>
</blockquote>
<h2 id="5-t-or-t"><a class="header" href="#5-t-or-t">#5 <code>T or &amp;T</code></a></h2>
<h3 id="é¢˜ç›®-4"><a class="header" href="#é¢˜ç›®-4">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn p(self);
}

impl&lt;T&gt; Trait for fn(T) {
    fn p(self) {
        print!(&quot;1&quot;);
    }
}

impl&lt;T&gt; Trait for fn(&amp;T) {
    fn p(self) {
        print!(&quot;2&quot;);
    }
}

fn f(_: u8) {}
fn g(_: &amp;u8) {}

fn main() {
    let a: fn(_) = f;
    let b: fn(_) = g;
    let c: fn(&amp;_) = g;
    a.p();
    b.p();
    c.p();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-4"><a class="header" href="#æç¤º-4">æç¤º</a></h3>
<p>å¦‚æœä½ ç†Ÿæ‚‰é«˜çº§ç”Ÿå‘½å‘¨æœŸç»‘å®šçš„è¯­æ³•ï¼Œå¯ä»¥å°è¯•å°† impl ç­¾åä¸­çš„æ‰€æœ‰ç±»å‹å’Œ main ä¸­çš„ç±»å‹è§£æ„ä¸ºå®Œå…¨æ˜¾å¼çš„å½¢å¼ã€‚</p>
<blockquote>
<p>If you are familiar with higher-rank trait bound syntax, try desugaring all the types in the impl signatures and types in main into their fully explicit form.</p>
</blockquote>
<h3 id="é¢˜è§£-3"><a class="header" href="#é¢˜è§£-3">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š112</p>
<p>ç¬¬ä¸€ä¸ª impl é€‚ç”¨äº <code>fn(T)</code> ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼Œå…¶ä¸­ T æ˜¯ä»»ä½•å•ä¸€çš„å…·ä½“ç±»å‹ã€‚ç¬¬äºŒä¸ª impl é€‚ç”¨äºæ›´é«˜ç­‰çº§çš„ <code>for&lt;'a&gt; fn(&amp;'a T)</code> ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼Œå…¶ä¸­ T ç±»å‹çš„ç”Ÿå‘½å‘¨æœŸè¶…è¿‡ <code>'a</code>ã€‚</p>
<blockquote>
<p>The first impl applies to function pointers of type fn(T) where T is any single concrete type. The second impl applies to function pointers of higher-ranked type for&lt;'a&gt; fn(&amp;'a T) for some concrete type T that outlives 'a.</p>
</blockquote>
<p>åœ¨ main ä¸­ï¼Œç¼–è¯‘å™¨ä¼šè‡ªåŠ¨ä½¿ç”¨ç±»å‹æ¨å¯¼ï¼Œç”¨æŸç§å…·ä½“çš„ç±»å‹æ¥æ›¿ä»£æ‰€æœ‰å‡ºç°çš„ <code>_</code>ã€‚</p>
<blockquote>
<p>Inside of main, the compiler is going to use type inference to substitute all occurrences of _ in a type by some concrete type.</p>
</blockquote>
<p>å¯¹äºé—­åŒ… aï¼Œæˆ‘ä»¬æ¨æ–­ <code>_ = u8</code>ï¼Œé—­åŒ…ç±»å‹ä¸º <code>fn(u8)</code>ï¼Œæ¥å—ä¸€ä¸ª <code>u8</code> ç±»å‹çš„å‚æ•°å¹¶è¿”å› <code>()</code>ã€‚</p>
<blockquote>
<p>For the closure a we infer _ = u8, yielding the closure type fn(u8) taking an argument of type u8 and returning ().</p>
</blockquote>
<p>å¯¹äº bï¼Œæˆ‘ä»¬æ¨æ–­ <code>_ = &amp;'x u8</code>, ä¸ºä¸€äº›å…·ä½“çš„ç”Ÿå‘½å‘¨æœŸ <code>'x</code>ï¼Œæœ€ç»ˆå°†è¢«é€å…¥å€Ÿç”¨æ£€æŸ¥å™¨ã€‚b çš„ç±»å‹æ˜¯ <code>fn(&amp;'x u8)</code>ã€‚</p>
<blockquote>
<p>For b we infer _ = &amp;'x u8 for some concrete lifetime 'x that will ultimately feed into the borrow checker. The type of b is fn(&amp;'x u8).</p>
</blockquote>
<p>æœ€åï¼Œå¯¹äº cï¼Œæˆ‘ä»¬æ¨æ–­ <code>_ = u8</code>ï¼Œäº§ç”Ÿæ›´é«˜ç­‰çº§çš„é—­åŒ…ç±»å‹ <code>&lt;'a&gt; fn(&amp;'a u8)</code>ã€‚</p>
<blockquote>
<p>And finally for c we infer _ = u8, yielding the higher-ranked closure type for&lt;'a&gt; fn(&amp;'a u8).</p>
</blockquote>
<p>ä»¥æ­¤ä¸ºæ¡†æ¶ï¼Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨ main ç»“å°¾å‡ºä¼šæ‰“å° 112ã€‚</p>
<blockquote>
<p>Framed in this way, it follows that the trait method calls at the end of main print 112.</p>
</blockquote>
<h2 id="6-size-of-"><a class="header" href="#6-size-of-">#6 <code>size of ()</code></a></h2>
<h3 id="é¢˜ç›®-5"><a class="header" href="#é¢˜ç›®-5">é¢˜ç›®</a></h3>
<pre><code class="language-rs">use std::mem;

fn main() {
    let a;
    let a = a = true;
    print!(&quot;{}&quot;, mem::size_of_val(&amp;a));
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-5"><a class="header" href="#æç¤º-5">æç¤º</a></h3>
<p>æœ‰ä¸¤ä¸ªåä¸º a çš„å˜é‡ï¼Œå®ƒä»¬å„è‡ªçš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<blockquote>
<p>There are two variables named a. What is the type of each one?</p>
</blockquote>
<h3 id="é¢˜è§£-4"><a class="header" href="#é¢˜è§£-4">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š0</p>
<p>è¿™é‡Œæœ‰ä¸¤ä¸ªåä¸º a e çš„å˜é‡ï¼Œç¬¬äºŒä¸ªä¼š &quot;é®è”½&quot; ç¬¬ä¸€ä¸ªï¼Œè¿™æ®µç¨‹åºç­‰ä»·äºï¼š</p>
<blockquote>
<p>There are two variables named a, one shadowing the other. The program is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">let a;
let b = a = true;
print!(&quot;{}&quot;, mem::size_of_val(&amp;b));
</code></pre>
<p>æ›´è¿›ä¸€æ­¥ï¼Œä¸º b èµ‹çš„å€¼æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ <code>a = true</code>;</p>
<blockquote>
<p>Further, the value being assigned to b is the expression a = true.</p>
</blockquote>
<p>åœ¨ Rust é‡Œï¼Œèµ‹å€¼è¡¨è¾¾å¼çš„è¿”å›å€¼å§‹ç»ˆæ˜¯ <code>()</code>ã€‚åœ¨ç®€åŒ–ä¸€ä¸‹ä»£ç ï¼š</p>
<blockquote>
<p>In Rust, assignment expressions always have the value (). Simplified some more, the quiz code is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">let a = true;
let b = ();
print!(&quot;{}&quot;, mem::size_of_val(&amp;b));
</code></pre>
<p>å…³äºå®ƒçš„è¡Œä¸ºè§„èŒƒï¼Œè¯·å‚è€ƒ size_of_val çš„æ–‡æ¡£ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒè¢«å®ä¾‹åŒ–ä¸º <code>T = ()</code>ï¼Œæˆ‘ä»¬æœ€ç»ˆä¼šæ‰“å°å‡º <code>size_of::&lt;()&gt;()</code> çš„å€¼ã€‚</p>
<blockquote>
<p>Refer to the documentation of size_of_val for a specification of its behavior, but in this case it is being instantiated with T = () and we end up printing the value of size_of::&lt;()&gt;().</p>
</blockquote>
<p><code>()</code> æ˜¯é›¶å¤§å°ç±»å‹æˆ– ZST çš„ä¸€ä¸ªä¾‹å­ï¼Œåœ¨è¿è¡Œæ—¶ç”±é›¶å­—èŠ‚çš„æ•°æ®è¡¨ç¤ºï¼Œæ‰€ä»¥ç¨‹åºä¼šæ‰“å°å‡º 0ã€‚</p>
<blockquote>
<p>() is one example of a zero-sized type or ZST and is represented by zero bytes of data at runtime, so the program prints 0.</p>
</blockquote>
<h2 id="7-match"><a class="header" href="#7-match">#7 <code>match</code></a></h2>
<h3 id="é¢˜ç›®-6"><a class="header" href="#é¢˜ç›®-6">é¢˜ç›®</a></h3>
<pre><code class="language-rs">#[repr(u8)]
enum Enum {
    First,
    Second,
}

impl Enum {
    fn p(self) {
        match self {
            First =&gt; print!(&quot;1&quot;),
            Second =&gt; print!(&quot;2&quot;),
        }
    }
}

fn main() {
    Enum::p(unsafe {
        std::mem::transmute(1u8)
    });
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-6"><a class="header" href="#æç¤º-6">æç¤º</a></h3>
<p>è°ƒç”¨ <code>Enum::p</code> æ—¶ä¼ å…¥çš„å‚æ•°ä¸€å®šæ˜¯ <code>Enum::Second</code>ã€‚</p>
<blockquote>
<p>The argument of the call to Enum::p is guaranteed to be Enum::Second.</p>
</blockquote>
<h3 id="é¢˜è§£-5"><a class="header" href="#é¢˜è§£-5">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1</p>
<p>å±•å¼€éšè—çš„æ¡ä»¶ï¼Œè¿™æ®µ Enum çš„å®šä¹‰å…¶å®ç­‰åŒäºï¼š</p>
<blockquote>
<p>Filling in the implicit discriminants, the definition of Enum is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">#[repr(u8)]
enum Enum {
    First = 0u8,
    Second = 1u8,
}
</code></pre>
<p><code>unsafe transmute</code> åªæ˜¯è½¬ç§»ä½ çš„æ³¨æ„ã€‚<code>#[repr(u8)]</code> ä¼šç¡®ä¿æˆ‘ä»¬çš„ç±»å‹å’Œ u8 æœ‰ç›¸åŒçš„å†…å­˜å¸ƒå±€ï¼Œè€Œ <code>Enum::Second</code> çš„åˆ¤åˆ«ä¼šç¡®ä¿ <code>Enum::Second</code> å’Œ 1u8 çš„å¸ƒå±€ç›¸åŒã€‚å› æ­¤è¿™é‡Œçš„ <code>transmute</code> çš„å®šä¹‰æ˜ç¡®ï¼Œç­‰ä»·äº <code>Enum::Second</code>ã€‚</p>
<blockquote>
<p>The unsafe transmute is a red herring. The attribute #[repr(u8)] guarantees that our type has the same representation as u8, and the discriminant on Enum::Second guarantees that Enum::Second has the same representation as 1u8. The transmute is well-defined and evaluates to Enum::Second.</p>
</blockquote>
<p>å¦‚æœæ–¹æ³• p çš„å®šæ—¶æ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>If the method p had been written as:</p>
</blockquote>
<pre><code class="language-rs">match self {
    Enum::First =&gt; print!(&quot;1&quot;),
    Enum::Second =&gt; print!(&quot;2&quot;),
}
</code></pre>
<p>è¿™ä¸ªç¨‹åºä¼šæ‰“å° 2ã€‚</p>
<blockquote>
<p>then this program would print 2.</p>
</blockquote>
<p>ä½†æ˜¯ï¼Œæ¨¡å¼åŒ¹é…é‡Œçš„ä¸¤ä¸ªåˆ†æ”¯éƒ½æ˜¯é€šé…ç¬¦ï¼Œèƒ½å¤ŸåŒ¹é…åˆ°ä»»ä½•å€¼ï¼Œå¹¶æŠŠå®ƒç»‘å®šåˆ° First æˆ–è€… Second ä¸Šã€‚æ¨¡å¼æŒ‰é¡ºåºåŒ¹é…ï¼Œæ‰€ä»¥è¿™é‡Œæ€»æ˜¯ä¼šåŒ¹é…åˆ° First åˆ†æ”¯ã€‚</p>
<blockquote>
<p>However, as written, both arms of the match expression are wildcard matches that successfully match any value and bind a variable with the name First or Second. Match arms are applied in order so the wildcard match in the first arm is always the one matched.</p>
</blockquote>
<p>ç¼–è¯‘å™¨ä¼šç»™æˆ‘ä»¬ä¸¤æ¡è­¦å‘Šã€‚ç¬¬ä¸€ä¸ªæ˜¯å®ƒæè¿°äº†åŒ¹é…çš„è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>The compiler helps us out with not one but two relevant warnings. First it describes exactly how this match is parsed and why that is probably silly.</p>
</blockquote>
<pre><code class="language-rs">warning: unreachable pattern
  --&gt; questions/007.rs:11:13
   |
10 |             First =&gt; print!(&quot;1&quot;),
   |             ----- matches any value
11 |             Second =&gt; print!(&quot;2&quot;),
   |             ^^^^^^ unreachable pattern
</code></pre>
<p>ç¬¬äºŒä¸ªæ˜¯ç¼–è¯‘å™¨æ„è¯†åˆ°äº†ç¨‹åºå‘˜å¯èƒ½å†™é”™äº†ä»£ç ï¼Œå¹¶ç»™å‡ºäº†å¯èƒ½æ­£ç¡®çš„æç¤ºã€‚</p>
<blockquote>
<p>Second, it recognizes what the programmer has done wrong and what they probably meant to write instead.</p>
</blockquote>
<pre><code class="language-rs">warning[E0170]: pattern binding `First` is named the same as one of the variants of the type `Enum`
  --&gt; questions/007.rs:10:13
   |
10 |             First =&gt; print!(&quot;1&quot;),
   |             ^^^^^ help: to match on the variant, qualify the path: `Enum::First`
</code></pre>
<p>åœ¨æ¨¡å¼ä¸­ç›´æ¥å†™é™å®šè·¯å¾„çš„æ–¹æ³•æ˜¯æŠŠæšä¸¾çš„å˜ä½“ä¹Ÿå¼•å…¥ä½œç”¨åŸŸï¼š</p>
<blockquote>
<p>An alternative to writing qualified paths in the pattern is to bring the variants into scope.</p>
</blockquote>
<pre><code class="language-rs">use Enum::*;

match self {
    First =&gt; print!(&quot;1&quot;),
    Second =&gt; print!(&quot;2&quot;),
}
</code></pre>
<p>é€šè¿‡<a href="https://doc.rust-lang.org/std/prelude/index.html">æ ‡å‡†åº“çš„ prelude</a>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¨¡å¼åŒ¹é…ä¸­ç›´æ¥ä½¿ç”¨ <code>OK</code> å’Œ <code>Some</code> (è€Œä¸æ˜¯ <code>Result::OK</code> å’Œ <code>Option::Some</code>)ã€‚</p>
<blockquote>
<p>Having variants brought into scope by the standard library prelude is what allows us to write Ok and Some in match arms, rather than the qualified paths Result::Ok and Option::Some.</p>
</blockquote>
<h2 id="8--"><a class="header" href="#8--">#8 <code>= = &gt;</code></a></h2>
<h3 id="é¢˜ç›®-7"><a class="header" href="#é¢˜ç›®-7">é¢˜ç›®</a></h3>
<pre><code class="language-rs">macro_rules! m {
    (==&gt;) =&gt; { print!(&quot;1&quot;); };
    (= = &gt;) =&gt; { print!(&quot;2&quot;); };
    (== &gt;) =&gt; { print!(&quot;3&quot;); };
    (= =&gt;) =&gt; { print!(&quot;4&quot;); };
}

fn main() {
    m!(==&gt;);
    m!(= = &gt;);
    m!(== &gt;);
    m!(= =&gt;);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-7"><a class="header" href="#æç¤º-7">æç¤º</a></h3>
<p>æ ¹æ® <code>macro_rules!</code> çš„è§„åˆ™ï¼Œ<code>==</code> æ˜¯ä¸€ä¸ª tokenï¼Œ<code>=&gt;</code> ä¹Ÿæ˜¯ä¸€ä¸ª tokenã€‚</p>
<blockquote>
<p>According to macro_rules!, == is one token and =&gt; is one token.</p>
</blockquote>
<h3 id="é¢˜è§£-6"><a class="header" href="#é¢˜è§£-6">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1214</p>
<p>åœ¨ <code>macro_rules!</code> çš„è¾“å…¥æ¨¡å¼ä¸­ï¼Œç›¸é‚»çš„æ ‡ç‚¹ç¬¦å·æ ¹æ®å®ƒä»¬çš„ç”¨æ³•ä¸åŒï¼Œä¼šè¢«åˆ’åˆ†ä¸ºå‡ ç»„ã€‚</p>
<blockquote>
<p>Adjacent punctuation characters in the input pattern of a macro_rules! macro are grouped according to how those characters are used by native Rust tokens.</p>
</blockquote>
<p><a href="https://docs.rs/syn/0.15.22/syn/token/index.html#structs">è¿™é‡Œ</a>åˆ—å‡ºäº† Rust ä¸­çš„å•å­—ç¬¦å’Œå¤šå­—ç¬¦ token åˆ—è¡¨</p>
<blockquote>
<p>This page contains a list of the single-character and multi-character punctuation tokens involved in the Rust grammar.</p>
</blockquote>
<p>åˆ—è¡¨ä¸­çš„æœ‰ä¸€ä¸ªä¾‹å­ï¼Œ<code>&lt;&lt;=</code> æ˜¯ä¸€ä¸ª tokenï¼ŒRust è¯­æ³•æŠŠå®ƒä½œä¸ºå·¦ç§»èµ‹å€¼ã€‚å› æ­¤åŒ…å« <code>&lt;&lt;=</code> çš„ä¸€ä¸ª <code>macro_rules!</code> è¾“å…¥ï¼Œåªæœ‰é‡åˆ° <code>&lt;&lt;=</code> ä¸”ä¸­é—´æ²¡æœ‰ç©ºæ ¼æ—¶æ‰ä¼šåŒ¹é…ã€‚</p>
<blockquote>
<p>As one example from that list, <code>&lt;&lt;=</code> is a single token because the Rust grammar uses that sequence of characters to mean left shift assignment. Thus a macro_rules! input rule containing <code>&lt;&lt;=</code> would only match if all three characters <code>&lt;&lt;=</code> are written consecutively without spaces in the invocation.</p>
</blockquote>
<p>ä½†æ˜¯ <code>=&lt;&lt;</code> åœ¨ Rust è¯­æ³•ä¸­ä¸æ˜¯ä¸€ä¸ª native tokenã€‚macro_rulesï¼çš„è§£æå™¨ä¼šæ ¹æ®è´ªå¿ƒå°†å…¶åˆ†è§£ä¸º Rust æ ‡è®°ã€‚ <code>=&lt;</code> ä¹Ÿä¸æ˜¯ä¸€ä¸ª native tokenï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬éœ€è¦åŒ¹é…ä¸€ä¸ª <code>=</code> æœ¬èº«ã€‚ç„¶åï¼Œ<code>&lt;&lt;</code> æ˜¯ä¸€ä¸ª native tokenã€‚åœ¨å®è§„åˆ™ä¸­å†™ <code>=&lt;&lt;</code> çš„è¡Œä¸ºä¸å†™ <code>= &lt;&lt;</code> çš„è¡Œä¸ºå®Œå…¨ç›¸åŒã€‚</p>
<blockquote>
<p>But for example <code>=&lt;&lt;</code> is not a native token in the Rust grammar. The parser of macro_rules! will decompose this into Rust tokens according to a greedy process. <code>=&lt;</code> is also not a native token, so first we would need to match a <code>=</code> by itself. Then <code>&lt;&lt;</code> is a native token. Writing <code>=&lt;&lt;</code> in a macro rule behaves exactly the same as writing <code>= &lt;&lt;</code>.</p>
</blockquote>
<p>ç°åœ¨è®©æˆ‘ä»¬ä»¥åŒæ ·çš„æ–¹å¼åˆ†è§£ä»£ç ä¸­çš„è§„åˆ™ã€‚</p>
<blockquote>
<p>Now let's decompose the rules in the quiz code the same way.</p>
</blockquote>
<ul>
<li><code>==&gt;</code> åˆ†è§£ä¸º <code>== &gt;</code>ã€‚</li>
<li><code>= = &gt;</code> å·²ç»è¢«åˆ†è§£äº†ã€‚</li>
<li><code>== &gt;</code> å·²ç»è¢«åˆ†è§£äº†ã€‚</li>
<li><code>= =&gt;</code> å·²ç»è¢«åˆ†è§£äº†ã€‚</li>
</ul>
<p>åœ¨æˆ‘ä»¬çš„å®é‡Œï¼Œç¬¬ä¸€æ¡è§„åˆ™åŠ ä¸åŠ ç©ºæ ¼æ˜¯ä¸€æ ·çš„ã€‚ç¬¬ä¸‰æ¡è§„åˆ™æ˜¯ä¸å¯è¾¾çš„ã€‚</p>
<blockquote>
<p>Our macro is the same as if we had written the first rule with a space. The third rule is unreachable.</p>
</blockquote>
<pre><code class="language-rs">macro_rules! m {
    (== &gt;) =&gt; { print!(&quot;1&quot;); };
    (= = &gt;) =&gt; { print!(&quot;2&quot;); };
    (== &gt;) =&gt; { print!(&quot;3&quot;); };
    (= =&gt;) =&gt; { print!(&quot;4&quot;); };
}
</code></pre>
<p>åœ¨ main ä¸­ï¼Œç¬¬ä¸€è¡Œå’Œç¬¬ä¸‰è¡Œéƒ½ç¬¦åˆç¬¬ä¸€æ¡å®è§„åˆ™ã€‚ç¬¬äºŒè¡ŒåŒ¹é…ç¬¬äºŒæ¡è§„åˆ™ï¼Œç¬¬å››è¡ŒåŒ¹é…ç¬¬å››æ¡è§„åˆ™ã€‚è¾“å‡ºç»“æœæ˜¯ 1214ã€‚</p>
<blockquote>
<p>Within main, the first and third lines both match the first macro rule. The second line matches the second rule and the fourth line matches the fourth rule. The output is 1214.</p>
</blockquote>
<p>è¿‡ç¨‹å®ä½¿ç”¨æ›´çµæ´»ã€æ›´å¼ºå¤§çš„å® APIï¼Œå¹¶ä¸”æ€»æ˜¯èƒ½å¤ŸåŒºåˆ†ç›¸åŒå­—ç¬¦çš„ä¸åŒé—´éš”ï¼Œä¾‹å¦‚ <code>== &gt;</code> ä¸ <code>==&gt;</code>ã€‚</p>
<blockquote>
<p>Procedural macros use a more flexible and powerful macro API and can always distinguish between different spacings of the same characters, such as == &gt; vs ==&gt;.</p>
</blockquote>
<h2 id="9-tttt"><a class="header" href="#9-tttt">#9 <code>$tt:tt</code></a></h2>
<h3 id="é¢˜ç›®-8"><a class="header" href="#é¢˜ç›®-8">é¢˜ç›®</a></h3>
<pre><code class="language-rs">macro_rules! m {
    (1) =&gt; { print!(&quot;1&quot;) };
    ($tt:tt) =&gt; { print!(&quot;2&quot;) };
}

macro_rules! e {
    ($e:expr) =&gt; { m!($e) };
}

macro_rules! t {
    ($tt:tt) =&gt; { e!($tt); m!($tt); };
}

fn main() {
    t!(1);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-8"><a class="header" href="#æç¤º-8">æç¤º</a></h3>
<p>ä¸€æ—¦è¢«åŒ¹é…ä¸º <code>$:expr</code>ï¼ŒåŒ¹é…åˆ°çš„è¡¨è¾¾å¼å°±å˜æˆäº†ä¸€ä¸ªä¸é€æ˜çš„æ ‡è®°æ ‘ã€‚</p>
<blockquote>
<p>Upon being matched as a $:expr, the matched expression becomes a single opaque token tree.</p>
</blockquote>
<h3 id="é¢˜è§£-7"><a class="header" href="#é¢˜è§£-7">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š21</p>
<p>è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°å®åŒ¹é…å™¨åœ¨åŒ¹é…å®çš„å…ƒå˜é‡æ—¶çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>This question involves the behavior of macro matchers as regards matching macro metavariables.</p>
</blockquote>
<p>ä»ä»£ç çš„æœ€åä¸€è¡Œçœ‹èµ·ï¼Œ<code>t!(1)</code> ä¼šåŒ¹é…åˆ° <code>t!</code> çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œç„¶åå±•å¼€ä¸º <code>e!(1); m!(1);</code></p>
<blockquote>
<p>Starting from the bottom of the quiz code, the invocation t!(1) matches the first rule of t! and expands to e!(1); m!(1);.</p>
</blockquote>
<p>è°ƒç”¨ <code>e!(1)</code> ä¼šåŒ¹é… <code>e!</code> çš„ç¬¬ä¸€æ¡è§„åˆ™ã€‚ä½œä¸ºè¿™ä¸ªåŒ¹é…çš„ä¸€éƒ¨åˆ†ï¼Œè¡¨è¾¾å¼ <code>1</code> ä¼šè¢«æ‰“åŒ…æˆä¸€ä¸ªä¸é€æ˜çš„è¡¨è¾¾å¼ tokenï¼Œç§°ä¸º <code>$e</code>ã€‚åœ¨æ¥ä¸‹æ¥çš„ä»»ä½•æ—¶å€™ï¼Œä»»ä½• <code>macro_rulesï¼</code>å®éƒ½ä¸å¯èƒ½æŸ¥çœ‹ <code>$e</code> çš„å†…éƒ¨ï¼Œå”¯ä¸€å¯ä»¥çŸ¥é“çš„æ˜¯ <code>$e</code> æ˜¯æŸä¸ªè¡¨è¾¾å¼ã€‚</p>
<blockquote>
<p>The invocation e!(1) matches the first rule of e!. As part of this match, the expression 1 is packaged into an opaque expression token called $e. At no subsequent point will it be possible for any macro_rules! macro to look inside of $e. All that can be known is that $e is some expression.</p>
</blockquote>
<p>åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œ<code>e!(1)</code> éƒ½ä¼šæ‰©å±•ä¸º <code>m!($e)</code>ï¼Œå…¶ä¸­ <code>$e</code> æ˜¯ä¸€ä¸ªåŒ…å« <code>1</code> çš„ä¸é€æ˜è¡¨è¾¾å¼ã€‚<code>m!($e)</code> å¹¶ä¸ç¬¦åˆ <code>m!</code> çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œå› ä¸º <code>$e</code> æ˜¯ä¸é€æ˜çš„ã€‚æ‰€ä»¥å®ƒåŒ¹é…äº† <code>m!</code> çš„ç¬¬äºŒæ¡è§„åˆ™ï¼Œå¹¶æ‰“å°å‡º 2ã€‚</p>
<blockquote>
<p>In any case, e!(1) expands to m!($e) where $e is an opaque expression containing 1. That m!($e) does not match the first rule of m! because $e is opaque. Instead it matches the second rule of m! and prints 2.</p>
</blockquote>
<p>åœ¨ <code>e!(1)</code> ä¹‹åæœ‰ä¸€ä¸ªå¯¹ <code>m!(1)</code> çš„è°ƒç”¨ï¼Œæ¥è‡ª <code>t!</code> çš„å±•å¼€ã€‚è¿™ä¸ªè°ƒç”¨ç¡®å®ç¬¦åˆ <code>m!</code> çš„ç¬¬ä¸€æ¡è§„åˆ™ï¼Œå¹¶æ‰“å°å‡º 1ã€‚æ‰€ä»¥è¿™ä¸ªç¨‹åºçš„è¾“å‡ºæ˜¯ 21ã€‚</p>
<blockquote>
<p>After e!(1) there is an invocation m!(1) coming from the expansion of t!. That one does match the first rule of m! and prints 1. The output of this program is 21.</p>
</blockquote>
<p>å¤§å¤šæ•°ç‰‡æ®µåˆ†ç±»ç¬¦éƒ½æœ‰è¿™ç§å˜ä¸ºä¸é€æ˜ token çš„è¡Œä¸ºï¼Œä½†æœ‰äº›æ²¡æœ‰ã€‚ä¸€æ—¦åŒ¹é…åˆ°å°±å˜ä¸ºä¸é€æ˜ token çš„ç‰‡æ®µåˆ†ç±»ç¬¦ï¼š</p>
<blockquote>
<p>Most fragment specifiers have this behavior of becoming opaque token boxes, but some do not. Specifiers that are opaque once matched:</p>
</blockquote>
<pre><code class="language-rs">$:block
$:expr
$:item
$:literal
$:meta
$:pat
$:path
$:stmt
$:ty
</code></pre>
<p>å‰©ä¸‹çš„ç‰‡æ®µåˆ†ç±»ç¬¦åŒ¹é…æˆåŠŸåä¸ä¼šå˜ä¸ºä¸é€æ˜çš„ï¼Œå¯ä»¥è¢«åç»­çš„è§„åˆ™æ£€æŸ¥åˆ°ï¼š</p>
<blockquote>
<p>The rest of the specifiers do not become opaque and can be inspected by subsequent rules:</p>
</blockquote>
<pre><code class="language-rs">$:ident
$:lifetime
$:tt
</code></pre>
<p>æ¯”å¦‚ï¼š</p>
<blockquote>
<p>For example:</p>
</blockquote>
<pre><code class="language-rs">macro_rules! m {
    ('a) =&gt; {};
}

macro_rules! l {
    ($l:lifetime) =&gt; {
        // $l is not opaque.
        m!($l);
    }
}

l!('a);
</code></pre>
<h2 id="10-traitf"><a class="header" href="#10-traitf">#10 <code>Trait::f</code></a></h2>
<h3 id="é¢˜ç›®-9"><a class="header" href="#é¢˜ç›®-9">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn f(&amp;self);
}

impl&lt;'a&gt; dyn Trait + 'a {
    fn f(&amp;self) {
        print!(&quot;1&quot;);
    }
}

impl Trait for bool {
    fn f(&amp;self) {
        print!(&quot;2&quot;);
    }
}

fn main() {
    Trait::f(&amp;true);
    Trait::f(&amp;true as &amp;dyn Trait);
    &lt;_ as Trait&gt;::f(&amp;true);
    &lt;_ as Trait&gt;::f(&amp;true as &amp;dyn Trait);
    &lt;bool as Trait&gt;::f(&amp;true);
    &lt;dyn Trait as Trait&gt;::f(&amp;true as &amp;dyn Trait);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-9"><a class="header" href="#æç¤º-9">æç¤º</a></h3>
<p>è¿™å¹¶ä¸èƒ½å¸®åŠ©ä½ è§£å†³é—®é¢˜ï¼Œä½†å¯èƒ½ä¼šè®©ä½ å¥½å—äº›ï¼šä½œè€…ä¹Ÿè¢«è¿™ä¸ªé—®é¢˜éš¾ä½äº†ã€‚</p>
<blockquote>
<p>This won't help you answer the question but may help feel better: the quiz author was also stumped by this one.</p>
</blockquote>
<h3 id="é¢˜è§£-8"><a class="header" href="#é¢˜è§£-8">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š222222</p>
<p>è¿™é“é¢˜é‡Œæœ‰ä¸€ä¸ª Trait æ–¹æ³• <code>Trait::f</code>ï¼ŒåŒæ—¶è¿˜æœ‰ç‰¹å¾å¯¹è±¡ <code>dyn Trait</code> çš„ f æ–¹æ³•ã€‚</p>
<blockquote>
<p>This question contains a trait method <code>Trait::f</code> as well as an inherent method f on the trait object type dyn Trait.</p>
</blockquote>
<p>æ®æˆ‘æ‰€çŸ¥ï¼Œé‰´äºè¿™äº›åå­—ä¼šç›¸äº’é®è”½ï¼Œåœ¨ <code>dyn Trait</code> å®ç°çš„ <code>f</code> æ–¹æ³•å®é™…ä¸Šæ˜¯æ— æ³•è°ƒç”¨çš„ã€‚ç›®å‰ï¼ŒRust ä¸­æ²¡æœ‰ä»»ä½•è¯­æ³•å¯ä»¥åœ¨ <code>dyn Trait</code> ä¸Šè°ƒç”¨å®ƒçš„ <code>f</code>ã€‚</p>
<blockquote>
<p>As far as I know, given that these names shadow each other, the inherent method is literally uncallable. There is currently no syntax in Rust for calling the inherent f on dyn Trait.</p>
</blockquote>
<p>å¦‚æœ trait æ–¹æ³•çš„åå­—å¯ä»¥ä»¥ä¸åŒçš„æ–¹å¼å‘½åï¼Œå¹¶ä¸”åªæœ‰ <code>dyn Trait</code> çš„æ–¹æ³•è¢«ç§°ä¸º <code>f</code>ï¼Œé‚£ä¹ˆ main çš„å‰ä¸¤è¡Œå°±ä¼šæˆåŠŸè°ƒç”¨ <code>dyn Trait</code> çš„æ–¹æ³•ã€‚ç„¶è€Œï¼Œç”±äºå†™çš„æ˜¯è¢«é®è”½çš„åå­—ï¼Œè¿™ä¼šå¯¼è‡´æ­§ä¹‰ï¼Œæœ€åè°ƒç”¨çš„æ˜¯ Trait çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>If the trait method were named something different and only the inherent method were called f, then the first two lines of main would successfully call the inherent method. However, as written with shadowed names, they disambiguate to the trait method.</p>
</blockquote>
<p>è¿˜æœ‰ä¸€ç§å¯ä»¥å°è¯•çš„è¯­æ³•ï¼š</p>
<blockquote>
<p>One additional syntax to try would be:</p>
</blockquote>
<pre><code class="language-rs">&lt;dyn Trait&gt;::f(&amp;true);
&lt;dyn Trait&gt;::f(&amp;true as &amp;dyn Trait);
</code></pre>
<p>å¦‚æœç‰¹å¾æ–¹æ³•çš„å‘½åä¸åŒï¼Œè¿™ä¸¤ä¸ªè°ƒç”¨éƒ½ä¼šè°ƒç”¨ <code>dyn Trait</code> çš„ <code>f</code> æ–¹æ³•ã€‚å¦‚æœ <code>dyn Trait</code> çš„æ–¹æ³•è¢«å‘½åä¸ºä¸åŒçš„ä¸œè¥¿ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè°ƒç”¨ Trait æ–¹æ³•ã€‚ä½†æ˜¯å¦‚æœ <code>Trait</code> æ–¹æ³•å’Œ <code>dyn Trait</code> æ–¹æ³•éƒ½å«ä½œ fï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šæŠ¥å‘Šä¸€ä¸ªæ­§ä¹‰ã€‚</p>
<blockquote>
<p>If the trait method were named something different, both of these would call the inherent method. If the inherent method were named something different, both of these would call the trait method. But if the trait method and the inherent method are both f then the compiler reports an ambiguity.</p>
</blockquote>
<pre><code class="language-rs">error[E0034]: multiple applicable items in scope
  --&gt; questions/010.rs:18:5
   |
18 |     &lt;dyn Trait&gt;::f(&amp;true);
   |     ^^^^^^^^^^^^^^ multiple `f` found
   |
note: candidate #1 is defined in an impl for the type `dyn Trait`
  --&gt; questions/010.rs:6:5
   |
6  |     fn f(&amp;self) {
   |     ^^^^^^^^^^^
note: candidate #2 is defined in the trait `Trait`
  --&gt; questions/010.rs:2:5
   |
2  |     fn f(&amp;self);
   |     ^^^^^^^^^^^^
   = help: to disambiguate the method call, write `Trait::f(...)` instead
</code></pre>
<p>ä¹Ÿè®¸æœ‰ä¸€å¤©ï¼Œåœ¨ä¸€ä¸ªè¢«ç‰¹å¾æ–¹æ³•æ‰€é®è”½çš„ç‰¹å¾å¯¹è±¡ä¸Šè°ƒç”¨å®ƒçš„æ–¹æ³•å¯èƒ½æ¶ˆé™¤æ­§ä¹‰ã€‚ä½†æ˜¯ç°åœ¨ï¼Œä»£ç åªèƒ½æ‰“å°å‡º 222222ã€‚</p>
<blockquote>
<p>Maybe some day it will be possible to disambiguate a call to an inherent method on a trait object shadowed by a trait method. For now, the quiz code prints 222222.</p>
</blockquote>
<h2 id="11-early--late-bound"><a class="header" href="#11-early--late-bound">#11 <code>early &amp; late bound</code></a></h2>
<h3 id="é¢˜ç›®-10"><a class="header" href="#é¢˜ç›®-10">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn f&lt;'a&gt;() {}
fn g&lt;'a: 'a&gt;() {}

fn main() {
    let pf = f::&lt;'static&gt; as fn();
    let pg = g::&lt;'static&gt; as fn();
    print!(&quot;{}&quot;, pf == pg);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-10"><a class="header" href="#æç¤º-10">æç¤º</a></h3>
<p>f å’Œ g çš„å†™æ³•æ˜¯ä¸èƒ½äº’æ¢çš„ã€‚</p>
<blockquote>
<p>The way that f and g are written is not interchangeable.</p>
</blockquote>
<h3 id="é¢˜è§£-9"><a class="header" href="#é¢˜è§£-9">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼šç¼–è¯‘å¤±è´¥</p>
<p>æ¯”è¾ƒå‡½æ•°æŒ‡é’ˆæ˜¯ä¸€ä¸ªåä¸»æ„ã€‚åœ¨ä¼˜åŒ–åçš„æ„å»ºä¸­ï¼Œå¾ˆå®¹æ˜“å‡ºç°æ— æ„ä¹‰çš„è¡Œä¸ºã€‚å…³äºè¿™ç§è¡Œä¸ºçš„ä¸€ä¸ªä»¤äººç ç›®ç»“èˆŒçš„ä¾‹å­ï¼Œè¯·çœ‹ <a href="https://github.com/rust-lang/rust/issues/54685">rust-lang/rust#54685</a>ï¼Œå…¶ä¸­ x == y åŒæ—¶ä¸ºçœŸï¼Œåˆä¸ä¸ºçœŸã€‚(è¯‘è€…æ³¨ï¼šè¯¥é—®é¢˜å·²ä¿®å¤)</p>
<blockquote>
<p>Function pointer comparison is generally a Bad Idea. It is easily possible to get nonsensical behavior in optimized builds. For a jaw-dropping example of such behavior, check out rust-lang/rust#54685 in which x == y is both true and not true at the same time.</p>
</blockquote>
<p>é‚£å°±æ˜¯è¯´ï¼Œè¿™æ®µä»£ç ç¼–è¯‘å¤±è´¥ã€‚ä¸‹é¢æ˜¯ç¼–è¯‘çš„è¾“å‡ºï¼š</p>
<blockquote>
<p>That said, the quiz code in this question fails to compile. Here is the compiler output:</p>
</blockquote>
<pre><code class="language-rs">error: cannot specify lifetime arguments explicitly if late bound lifetime parameters are present
 --&gt; questions/011.rs:5:18
  |
5 |     let pf = f::&lt;'static&gt; as fn();
  |                  ^^^^^^^
  |
note: the late bound lifetime parameter is introduced here
 --&gt; questions/011.rs:1:18
  |
1 | fn f&lt;'a&gt;() {}
  |      ^^
</code></pre>
<p>æ³›å‹å‚æ•°å¯ä»¥æ˜¯æ—©ç»‘å®šä¹Ÿå¯ä»¥æ˜¯æ™šç»‘å®šã€‚ç›®å‰ (ä»¥åŠå¯ä»¥é‡è§çš„æœªæ¥) ç±»å‹å‚æ•°éƒ½æ˜¯æ—©ç»‘å®šï¼Œä½†æ˜¯ç”Ÿå‘½å‘¨æœŸå‚æ•°ä¸¤è€…éƒ½æœ‰å¯èƒ½ã€‚</p>
<blockquote>
<p>Generic parameters can be either early bound or late bound. Currently (and for the foreseeable future) type parameters are always early bound, but lifetime parameters can be either early or late bound.</p>
</blockquote>
<p>æ—©ç»‘å®šæ˜¯åœ¨ç¼–è¯‘å™¨åœ¨å•æ€åŒ–è¿‡ç¨‹ä¸­å†³å®šçš„ã€‚å› ä¸ºç±»å‹å‚æ•°æ€»æ˜¯æ—©ç»‘å®šï¼Œä½ ä¸èƒ½æ‹¥æœ‰ä¸€ä¸ªæ³›å‹æœªæŒ‡å®šçš„å€¼ã€‚</p>
<blockquote>
<p>Early bound parameters are determined by the compiler during monomorphization. Since type parameters are always early bound, you cannot have a value whose type has an unresolved type parameter. For example:</p>
</blockquote>
<pre><code class="language-rs">fn m&lt;T&gt;() {}

fn main() {
    let m1 = m::&lt;u8&gt;; // ok
    let m2 = m; // error: cannot infer type for `T`
}
</code></pre>
<p>ä½†æ˜¯ï¼Œå¯¹äºç”Ÿå‘½å‘¨æœŸæ˜¯åˆæ³•çš„ï¼š</p>
<blockquote>
<p>However, this is often allowed for lifetime parameters:</p>
</blockquote>
<pre><code class="language-rs">fn m&lt;'a&gt;(_: &amp;'a ()) {}

fn main() {
    let m1 = m; // å³ä½¿æ²¡æœ‰æä¾› 'a ä¹Ÿå¯ä»¥
}
</code></pre>
<p>å› ä¸º 'a çš„å…·ä½“å–å€¼å–å†³ä¸å®ƒå¦‚ä½•è¢«è°ƒç”¨ï¼Œç”¨æˆ·å¯ä»¥çœç•¥ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œä»–ä¼šåœ¨è°ƒç”¨æ˜¯å†³å®šã€‚ç”Ÿå‘½å‘¨æœŸç”šè‡³å¯ä»¥åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½ä¸ä¸€æ ·ã€‚</p>
<blockquote>
<p>Since the actual choice of lifetime 'a depends on how it is called, we are allowed to omit the lifetime parameter and it will be determined at the call site. The lifetime can even be different for each time it gets called.</p>
</blockquote>
<p>é‰´äºæ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨è°ƒç”¨å‰æŒ‡å®šå‡½æ•°ä¸Šçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<blockquote>
<p>For this reason, we cannot specify the lifetime on this function until it is called:</p>
</blockquote>
<pre><code class="language-rs">// error: cannot specify lifetime arguments explicitly if late bound lifetime parameters are present
let m2 = m::&lt;'static&gt;;
</code></pre>
<p>æˆ‘ä»¬ç”šè‡³ä¸èƒ½è®©å€Ÿç”¨æ£€æŸ¥å™¨æå‰è‡ªåŠ¨æ¨æ–­ï¼š</p>
<blockquote>
<p>We may not even ask the borrow checker to infer it too soon:</p>
</blockquote>
<pre><code class="language-rs">// error: cannot specify lifetime arguments explicitly if late bound lifetime parameters are present
let m3 = m::&lt;'_&gt;;
</code></pre>
<p>æ™šç»‘å®šå‚æ•°çš„æ¦‚å¿µä¸ Rust ä¸­çš„å¦ä¸€ä¸ªç‰¹æ€§ &quot;é«˜é˜¶ç”Ÿå‘½å‘¨æœŸ&quot; æœ‰äº›é‡å¤ã€‚è¿™æ˜¯ä¸€ç§ç”¨äºè¡¨è¾¾ç‰¹å¾å‚æ•°çš„è¾¹ç•Œæ˜¯æ™šç»‘å®šçš„æœºåˆ¶ã€‚ç›®å‰è¿™åªé™äºç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œä½†åœ¨å…¶ä»–è¯­è¨€ï¼ˆå¦‚ Haskellï¼‰ä¸­ä¹Ÿå­˜åœ¨åŒæ ·çš„æƒ³æ³•ï¼Œç”¨äºç±»å‹å‚æ•°ï¼Œè¿™å°±æ˜¯ &quot;é«˜çº§&quot; ä¸€è¯çš„ç”±æ¥ã€‚</p>
<blockquote>
<p>The idea of late bound parameters overlaps considerably with a feature of Rust called &quot;higher ranked trait bounds&quot; (HRTB). This is a mechanism for expressing that bounds on a trait's parameters are late bound. Currently this is limited to lifetime parameters, but the same idea exists in other languages (such as Haskell) for type parameters, which is where the term &quot;higher ranked&quot; comes from.</p>
</blockquote>
<p>è¡¨è¾¾ HRTB çš„è¯­æ³•éœ€è¦ä½¿ç”¨ for å…³é”®å­—ã€‚ä¸ºäº†è¡¨è¾¾ä¸Šé¢ m1 çš„ç±»å‹ï¼Œä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<blockquote>
<p>The syntax to express a HRTB for lifetimes uses the for keyword. To express the type of m1 above, we could have written:</p>
</blockquote>
<pre><code class="language-rs">let m1: impl for&lt;'r&gt; Fn(&amp;'r ()) = m;
</code></pre>
<p>ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆï¼š&quot;è¿™é‡Œæœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œä½†æ˜¯ç›®å‰æˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å®ƒå…·ä½“æ˜¯ä»€ä¹ˆ&quot;.</p>
<blockquote>
<p>You can think of this as meaning: &quot;There is a lifetime but we don't need to know what it is just yet&quot;.</p>
</blockquote>
<p>æ™šç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ— é™åˆ¶çš„ï¼›æ²¡æœ‰æ˜ç¡®çš„è¯­æ³•æ¥è¡¨è¾¾ä¸€ä¸ªæ™šç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸå¿…é¡»è¶…è¿‡å…¶ä»–çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<blockquote>
<p>Late bound lifetimes are always unbounded; there is no syntax for expressing a late bound lifetime that must outlive some other lifetime.</p>
</blockquote>
<pre><code class="language-rs">error: lifetime bounds cannot be used in this context
 --&gt; src/main.rs:5:20
  |
5 |     let _: for&lt;'b: 'a&gt; fn(&amp;'b ());
  |                    ^^
</code></pre>
<p>æ•°æ®ç±»å‹ä¸Šçš„ç”Ÿå‘½å‘¨æœŸæ€»æ˜¯æ—©ç»‘å®šï¼Œé™¤éå¼€å‘è€…æ˜ç¡®ä½¿ç”¨ HRBT çš„è¯­æ³•ã€‚åœ¨å‡½æ•°ä¸Šï¼Œç”Ÿå‘½å‘¨æœŸé»˜è®¤æ˜¯æ™šç»‘å®šï¼Œåœ¨ä¸‹åˆ—æƒ…å†µä¸‹å¯ä»¥æ˜¯æ—©ç»‘å®šï¼š</p>
<blockquote>
<p>Lifetimes on data types are always early bound except when the developer has explicitly used the HRTB for syntax. On functions, lifetimes are late bound by default but can be early bound if:</p>
</blockquote>
<ul>
<li>
<p>ç”Ÿå‘½å‘¨æœŸåœ¨å‡½æ•°ç­¾åä¹‹å¤–å£°æ˜ï¼Œä¾‹å¦‚ï¼Œåœ¨ä¸€ä¸ªç»“æ„ä½“çš„æ–¹æ³•ä¸­;æˆ–è€…</p>
<blockquote>
<p>The lifetime is declared outside the function signature, e.g. in an associated method of a struct it could be from the struct itself; or</p>
</blockquote>
</li>
<li>
<p>ç”Ÿå‘½å‘¨æœŸå‚æ•°è¢«å…¶ä»–ä¸€äº›æ›´é•¿çš„ç”Ÿå‘½å‘¨æœŸæ‰€çº¦æŸã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œè¿™ç§çº¦æŸåœ¨ HRTB ä¸­æ˜¯æ— æ³•è¡¨è¾¾çš„ï¼Œå› ä¸º HRTB ä¼šæ¶‰åŠåˆ°ç”Ÿå‘½å‘¨æœŸçš„æ™šç»‘å®šã€‚</p>
<blockquote>
<p>The lifetime parameter is bounded below by some other lifetime that it must outlive. As we've seen, this constraint is not expressible in the HRTB that would be involved in late binding the lifetime.</p>
</blockquote>
</li>
</ul>
<p>æ ¹æ®è¿™äº›è§„åˆ™ï¼Œç­¾å <code>fn f&lt;'a&gt;()</code> æœ‰ä¸€ä¸ªæ™šæœŸç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸå‚æ•°ï¼Œè€Œç­¾å <code>fn g&lt;'a: 'a&gt;()</code> æœ‰ä¸€ä¸ªæ—©ç»‘å®šçš„ç”Ÿå‘½å‘¨æœŸå‚æ•° -- å°½ç®¡è¿™é‡Œçš„çº¦æŸæ˜¯æ— æ•ˆçš„ã€‚</p>
<blockquote>
<p>By these rules, the signature fn f&lt;'a&gt;() has a late bound lifetime parameter while the signature fn g&lt;'a: 'a&gt;() has an early bound lifetime parameter â€” even though the constraint here is ineffectual.</p>
</blockquote>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™äº›åŒºåˆ«æ˜¯ç¼–è¯‘å™¨å†…éƒ¨çš„æœ¯è¯­ï¼ŒRust ç¨‹åºå‘˜åœ¨æ—¥å¸¸ç¼–å†™ä»£ç æ—¶å¹¶ä¸éœ€è¦äº†è§£æˆ–æ€è€ƒè¿™äº›æœ¯è¯­ã€‚åªæœ‰åœ¨å°‘æ•°è¾¹ç¼˜æƒ…å†µä¸‹ï¼Œç±»å‹ç³»ç»Ÿçš„è¿™ä¸ªæ–¹é¢åœ¨è¯­è¨€ä¸­æ˜¯å¯ä»¥è§‚å¯Ÿåˆ°çš„ï¼Œæ¯”å¦‚åœ¨è¿™é“ Quiz çš„ä»£ç ä¸­ã€‚</p>
<blockquote>
<p>Ordinarily these distinctions are compiler-internal terminology that Rust programmers are not intended to know about or think about in everyday code. There are only a few edge cases where this aspect of the type system becomes observable in the surface language, such as in the original quiz code.</p>
</blockquote>
<h2 id="12-let-s--x----s"><a class="header" href="#12-let-s--x----s">#12 <code>let S { x, .. } = S</code></a></h2>
<h3 id="é¢˜ç›®-11"><a class="header" href="#é¢˜ç›®-11">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct D(u8);

impl Drop for D {
    fn drop(&amp;mut self) {
        print!(&quot;{}&quot;, self.0);
    }
}

struct S {
    d: D,
    x: u8,
}

fn main() {
    let S { x, .. } = S {
        d: D(1),
        x: 2,
    };
    print!(&quot;{}&quot;, x);

    let S { ref x, .. } = S {
        d: D(3),
        x: 4,
    };
    print!(&quot;{}&quot;, x);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-11"><a class="header" href="#æç¤º-11">æç¤º</a></h3>
<p>æ¨¡å¼ <code>S { ref x, .. }</code> ä» S ç±»å‹çš„å€¼çš„æ‰€æœ‰è€…é‚£é‡Œå€Ÿç”¨äº†ä¸€ä¸ª x æˆå‘˜ï¼Œå¹¶ç»‘å®šåˆ°äº†å˜é‡ x ä¸Šã€‚</p>
<blockquote>
<p>The pattern <code>S { ref x, .. }</code> borrows a binding x from the owner of a value of type S.</p>
</blockquote>
<h3 id="é¢˜è§£-10"><a class="header" href="#é¢˜è§£-10">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1243</p>
<p>æ¨¡å¼ <code>S { ref x, .. }</code> ä» S ç±»å‹çš„å€¼çš„æ‰€æœ‰è€…é‚£é‡Œå€Ÿç”¨ä¸€ä¸ªç»‘å®šçš„ xã€‚è¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ° drop è§¦å‘çš„ä½ç½®ã€‚D åœ¨å“ªé‡Œè¢« dropï¼Ÿ</p>
<blockquote>
<p>This question involves drop-placement. Where does D get dropped?</p>
</blockquote>
<p>åœ¨ç¬¬ä¸€ä¸ª let-binding ä¸­ï¼Œæˆ‘ä»¬å°†ä¸€ä¸ª S ç±»å‹çš„å€¼è§£æ„ä¸ºå®ƒçš„ u8 ç±»å‹çš„å­—æ®µ x ä»¥åŠä»£è¡¨ &quot;S çš„å…¶ä½™éƒ¨åˆ†&quot; çš„ <code>..</code>ã€‚<code>..</code> ä¼šç«‹å³è¢« dropï¼Œå› ä¸ºå®ƒä¸å†æœ‰æ‰€æœ‰è€…ã€‚</p>
<blockquote>
<p>In the first let-binding, we destructure a value of type S into its field x of type u8 as well as .. which represents &quot;the rest of S&quot;. The part that is the rest of S is dropped immediately at that point because it no longer has an owner.</p>
</blockquote>
<p>åœ¨ç¬¬äºŒä¸ª let-binding ä¸­ï¼Œæˆ‘ä»¬ä» S ç±»å‹çš„å€¼çš„æ‰€æœ‰è€…é‚£é‡Œå€Ÿç”¨ä¸€ä¸ªå­—æ®µ xã€‚åœ¨å­—æ®µ x è¢«å€Ÿç”¨æœŸé—´ï¼Œæ•´ä¸ª S ç±»å‹çš„å€¼å°†ä¿æŒåœ¨ä½œç”¨åŸŸå†…ï¼Œå¹¶åœ¨ main çš„é—­åˆå¤§æ‹¬å·å¤„é€€å‡ºä½œç”¨åŸŸã€‚</p>
<blockquote>
<p>In the second let-binding, we borrow a field x from the owner of a value of type S. The whole value of type S remains in scope during the time that its field x is borrowed, and goes out of scope at the close curly brace of main.</p>
</blockquote>
<p>æœ€åçš„è¾“å‡ºæ˜¯ 1243ã€‚</p>
<blockquote>
<p>The output is 1243.</p>
</blockquote>
<h2 id="13-eq"><a class="header" href="#13-eq">#13 <code>eq</code></a></h2>
<h3 id="é¢˜ç›®-12"><a class="header" href="#é¢˜ç›®-12">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct S;

fn main() {
    let [x, y] = &amp;mut [S, S];
    let eq = x as *mut S == y as *mut S;
    print!(&quot;{}&quot;, eq as u8);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-12"><a class="header" href="#æç¤º-12">æç¤º</a></h3>
<p>ä¸¤ä¸ªå¯å˜å¼•ç”¨æŒ‡å‘åŒä¸€ä¸ªå†…å­˜ä½ç½®å¯ä»¥å—ï¼Ÿä¼šå‡ºä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<blockquote>
<p>Is it okay for two mutable references to point to the same memory location? What could go wrong?</p>
</blockquote>
<h3 id="é¢˜è§£-11"><a class="header" href="#é¢˜è§£-11">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1</p>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼ŒS æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ã€‚é›¶å¤§å°ç±»å‹æ˜¯ç¼–è¯‘æ—¶çš„æ¦‚å¿µï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šæ¶ˆå¤±ï¼Œåœ¨è¿è¡Œæ—¶ä¼šä»¥é›¶å­—èŠ‚è¡¨ç¤ºã€‚</p>
<blockquote>
<p>In this code, S is a zero sized type or ZST. Zero sized types are compile-time concepts that disappear during compilation and have a runtime representation of zero bytes.</p>
</blockquote>
<p>main çš„ç¬¬ä¸€è¡Œåˆ›å»ºäº†ä¸€ä¸ªç±»å‹ä¸º [S; 2] çš„æœ¬åœ°å€¼ã€‚è®©æˆ‘ä»¬æŠŠè¿™ä¸ªä¸´æ—¶å€¼ç§°ä¸º tmpã€‚let-binding åœ¨ tmp ä¸­ç»‘å®šäº†ä¸¤ä¸ªå¼•ç”¨ï¼Œx æŒ‡çš„æ˜¯ <code>&amp;mut tmp[0]</code>ï¼Œy æŒ‡çš„æ˜¯ <code>&amp;mut tmp[1]</code>ã€‚</p>
<blockquote>
<p>The first line of main creates a local value of type [S; 2]. Let's refer to that temporary as tmp. The let-binding binds two references into tmp, x referring to &amp;mut tmp[0] and y referring to &amp;mut tmp[1].</p>
</blockquote>
<p>åœ¨ main çš„ç¬¬äºŒè¡Œï¼Œæˆ‘ä»¬æƒ³çŸ¥é“ä½œä¸ºæŒ‡é’ˆçš„ x å’Œ y æ˜¯å¦æœ‰ç›¸åŒçš„å€¼ã€‚</p>
<blockquote>
<p>On the second line of main we want to know whether x and y as pointers have the same value.</p>
</blockquote>
<p>æ•°ç»„ç±»å‹ <code>[S; 2]</code> æœ¬èº«å°±æ˜¯ä¸€ä¸ªé›¶å¤§å°çš„ç±»å‹ã€‚ä½ å¯ä»¥é€šè¿‡æ‰“å° <code>std::mem::size_of::&lt;[S; 2]&gt;()</code> çš„å€¼æ¥ç¡®è®¤è¿™ç‚¹ã€‚äº‹å®ä¸Šï¼Œæ•°ç»„çš„ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªå…ƒç´ æœ‰ç›¸åŒçš„å†…å­˜åœ°å€ã€‚</p>
<blockquote>
<p>The array type <code>[S; 2]</code> is itself a zero sized type. You can confirm this by printing the value of <code>std::mem::size_of::&lt;[S; 2]&gt;()</code>. Indeed the first and second element of the array have the same memory address.</p>
</blockquote>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹åŒä¸€å†…å­˜ä½ç½®æœ‰å¤šä¸ªå¯å˜å¼•ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œä½†æ˜¯åœ¨å¯¹é›¶å¤§å°ç±»å‹çš„å¯å˜å¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œè§£å¼•ç”¨æ˜¯ä¸å¯è¡Œçš„ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æ²¡æœ‰è¿åä»»ä½•å†…å­˜å®‰å…¨ä¿è¯ã€‚</p>
<blockquote>
<p>Ordinarily having multiple mutable references to the same memory location would not be safe, but in the case of mutable references to zero sized types, dereferencing is a no-op so there is no way to violate any memory safety guarantees this way.</p>
</blockquote>
<h2 id="14-trait-scope"><a class="header" href="#14-trait-scope">#14 <code>trait scope</code></a></h2>
<h3 id="é¢˜ç›®-13"><a class="header" href="#é¢˜ç›®-13">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait: Sized {
    fn is_reference(self) -&gt; bool;
}

impl&lt;'a, T&gt; Trait for &amp;'a T {
    fn is_reference(self) -&gt; bool {
        true
    }
}

fn main() {
    match 0.is_reference() {
        true =&gt; print!(&quot;1&quot;),
        false =&gt; print!(&quot;0&quot;),
    }

    match '?'.is_reference() {
        true =&gt; print!(&quot;1&quot;),
        false =&gt; {
            impl Trait for char {
                fn is_reference(self) -&gt; bool {
                    false
                }
            }
            print!(&quot;0&quot;)
        }
    }
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-13"><a class="header" href="#æç¤º-13">æç¤º</a></h3>
<p>åœ¨è¿™ä¸ª <a href="https://stackoverflow.com/a/28552082/6086311">Stack Overflow</a> çš„ç­”æ¡ˆä¸­æ¶‰åŠåˆ° trait æ–¹æ³•çš„è‡ªåŠ¨å¼•ç”¨ã€‚</p>
<blockquote>
<p>Trait method auto-ref is covered in this Stack Overflow answer.</p>
</blockquote>
<h3 id="é¢˜è§£-12"><a class="header" href="#é¢˜è§£-12">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š10</p>
<p>ç¨‹åºä¸­æ‰€æœ‰çš„ <code>Trait impls</code> éƒ½æ˜¯åœ¨ä½œç”¨åŸŸå†…çš„ï¼Œæ‰€ä»¥åœ¨ä¸€ä¸ªä»£ç å—å†…ç¼–å†™çš„å¯¹ char çš„ Trait impl æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ç‰¹åˆ«æ˜¯ï¼Œè¿™ä¸ª impl åœ¨æ•´ä¸ªç¨‹åºä¸­éƒ½æ˜¯å¯è§çš„ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨åŒ…å«è¯¥ impl çš„ä»£ç å—ä¸­ã€‚</p>
<blockquote>
<p>Trait impls anywhere in a program are always in scope, so there is no significance to the impl Trait for char being written inside of a block of code. In particular, that impl is visible throughout the whole program, not just within the block containing the impl.</p>
</blockquote>
<p>è¿™ä¸ªé—®é¢˜ä¸ trait æ–¹æ³•è‡ªåŠ¨å¼•ç”¨çš„è¡Œä¸ºæœ‰å…³ï¼Œè¿™ä¸ªé—®é¢˜åœ¨ <a href="https://stackoverflow.com/a/28552082/6086311">Stack Overflow</a> çš„ç­”æ¡ˆä¸­æœ‰æ‰€æ¶‰åŠã€‚</p>
<blockquote>
<p>This question relates to the behavior of trait method auto-ref which is covered in this Stack Overflow answer.</p>
</blockquote>
<p>å¯¹ <code>0.is_reference()</code> çš„è°ƒç”¨è§‚å¯Ÿåˆ°æ²¡æœ‰ä¸€ä¸ªæˆ‘ä»¬å¯ä»¥ç›´æ¥è°ƒç”¨çš„ä¸ºæ•´æ•°ç±»å‹çš„ Trait çš„å®ç°ã€‚æ‰€ä»¥æ–¹æ³•è§£æè‡ªåŠ¨æ’å…¥äº†ä¸€ä¸ªå¼•ç”¨ï¼Œå³ <code>(&amp;0).is_reference()</code>ã€‚è¿™ä¸€æ¬¡çš„è°ƒç”¨ä¸ <code>&amp;'a, T&gt; Trait</code> çš„ <code>impl&lt;'a, T&gt;</code> åŒ¹é…ï¼Œå¹¶æ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>The call to <code>0.is_reference()</code> observes that there is no implementation of Trait for an integer type that we could call directly. Method resolution inserts an auto-ref, effectively evaluating <code>(&amp;0).is_reference()</code>. This time the call matches impl&lt;'a, T&gt; Trait for &amp;'a T and prints 1.</p>
</blockquote>
<p>å¯¹ <code>'?'.is_reference()</code> çš„è°ƒç”¨åè€Œæ‰¾åˆ°äº† <code>char</code> çš„ <code>implated Trait</code>ï¼Œæ‰“å°å‡º 0ã€‚</p>
<blockquote>
<p>The call to <code>'?'.is_reference()</code> instead finds impl Trait for char, printing 0.</p>
</blockquote>
<h2 id="15-type-inference"><a class="header" href="#15-type-inference">#15 <code>type inference</code></a></h2>
<h3 id="é¢˜ç›®-14"><a class="header" href="#é¢˜ç›®-14">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn f(&amp;self);
}

impl Trait for u32 {
    fn f(&amp;self) {
        print!(&quot;1&quot;);
    }
}

impl&lt;'a&gt; Trait for &amp;'a i32 {
    fn f(&amp;self) {
        print!(&quot;2&quot;);
    }
}

fn main() {
    let x = &amp;0;
    x.f();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-14"><a class="header" href="#æç¤º-14">æç¤º</a></h3>
<p>ç±»å‹æ¨æ–­ä¼šæ¨æ–­å‡º x æ˜¯ä»€ä¹ˆç±»å‹ï¼Ÿ</p>
<blockquote>
<p>What type would type inference infer for x?</p>
</blockquote>
<h3 id="é¢˜è§£-13"><a class="header" href="#é¢˜è§£-13">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1</p>
<p>åœ¨ç±»å‹æ¨æ–­è¿‡ç¨‹ä¸­ï¼Œå˜é‡ x çš„ç±»å‹æ˜¯ <code>&amp;{integer}</code>ï¼Œæ˜¯å¯¹æŸä¸ªå°šæœªç¡®å®šçš„æ•´æ•°ç±»å‹çš„å¼•ç”¨ã€‚</p>
<blockquote>
<p>During type inference the variable x has type &amp;{integer}, a reference to some as yet undetermined integer type.</p>
</blockquote>
<p>å¦‚æœæˆ‘ä»¬æƒ³è§£å†³ trait æ–¹æ³•çš„è°ƒç”¨ <code>Trait::f(x)</code>ï¼Œæˆ‘ä»¬å‘ç°å®ƒçš„å‚æ•° x å¿…é¡»æ˜¯ <code>&amp;Self</code> ç±»å‹ï¼Œå³å®ç°äº† Trait çš„æŸä¸ª Self ç±»å‹ã€‚æˆ‘ä»¬å‘ç°æ¨æ–­ <code>0: u32</code> æ—¢æ»¡è¶³äº† u32 æ˜¯ä¸€ä¸ªæ•´æ•°çš„çº¦æŸï¼Œä¹Ÿæ»¡è¶³äº† u32 å®ç°äº† Traitï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•è°ƒç”¨æœ€ç»ˆè°ƒç”¨äº† <code>&lt;u32 as Trait&gt;::f(x)</code> å¹¶æ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>If we want to resolve the trait method call <code>Trait::f(x)</code>, we find that its argument x must be of type <code>&amp;Self</code> for some type Self that implements Trait. We find that inferring 0: u32 satisfies both the constraint that u32 is an integer as well as u32 implements Trait, so the method call ends up calling <code>&lt;u32 as Trait&gt;::f(x)</code> and prints 1.</p>
</blockquote>
<p>åœ¨è¿™ä¸ª <a href="https://stackoverflow.com/a/28552082/6086311">Stack Overflow</a> çš„ç­”æ¡ˆä¸­è¯¦ç»†ä»‹ç»äº† Trait æ–¹æ³•çš„è§£æã€‚</p>
<blockquote>
<p>Trait method resolution is covered in more detail in this <a href="https://stackoverflow.com/a/28552082/6086311">Stack Overflow</a> answer.</p>
</blockquote>
<h2 id="16---i"><a class="header" href="#16---i">#16 <code>--i</code></a></h2>
<h3 id="é¢˜ç›®-15"><a class="header" href="#é¢˜ç›®-15">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn main() {
    let mut x = 4;
    --x;
    print!(&quot;{}{}&quot;, --x, --x);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-15"><a class="header" href="#æç¤º-15">æç¤º</a></h3>
<p>Rust æ‰€æ”¯æŒçš„è¿ç®—ç¬¦é›†åœ¨ <code>std::ops</code> ä¸­æœ‰ç›¸å…³æ–‡æ¡£ã€‚</p>
<blockquote>
<p>The set of operators supported by Rust is documented in <code>std::ops</code>.</p>
</blockquote>
<h3 id="é¢˜è§£-14"><a class="header" href="#é¢˜è§£-14">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š44</p>
<p>ä¸ C æˆ– Java ä¸åŒï¼ŒRust ä¸­æ²¡æœ‰è‡ªå¢è‡ªå‡è¿ç®—ç¬¦ã€‚Rust è¯­è¨€è®¾è®¡çš„ FAQï¼ˆç½‘ä¸Šå·²ç»æ²¡æœ‰äº†ï¼‰æ›¾ç»æ¶‰åŠè¿‡åŸå› ã€‚</p>
<blockquote>
<p>Unlike C or Java, there is no unary increment or decrement operator in Rust. The Rust language design FAQ (no longer available online) used to touch on the reason:</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆ Rust æ²¡æœ‰è‡ªå¢å’Œè‡ªå‡è¿ç®—ç¬¦ï¼Ÿ</p>
<blockquote>
<p>Why doesn't Rust have increment and decrement operators?</p>
</blockquote>
<p>Preincrement å’Œ Postincrementï¼ˆä»¥åŠä¸ä¹‹å¯¹åº”çš„ Decrementï¼‰ï¼Œè™½ç„¶æ–¹ä¾¿ï¼Œä½†ä¹Ÿç›¸å½“å¤æ‚ã€‚å®ƒä»¬éœ€è¦å¯¹è®¡ç®—é¡ºåºè¶³å¤Ÿäº†è§£ï¼Œå¹¶ç»å¸¸å¯¼è‡´ C å’Œ C++ ä¸­ä¸€äº›å¾®å¦™çš„é”™è¯¯å’Œæœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>Preincrement and postincrement (and the decrement equivalents), while convenient, are also fairly complex. They require knowledge of evaluation order, and often lead to subtle bugs and undefined behavior in C and C++. x = x + 1 or x += 1 is only slightly longer, but unambiguous.</p>
</blockquote>
<p>åœ¨æ²¡æœ‰è‡ªå‡è¿ç®—ç¬¦çš„æƒ…å†µä¸‹ï¼Œ<code>--x</code> è¢«è§£æä¸º <code>-(-x)</code>ã€‚åœ¨ <code>x = 4</code> çš„æƒ…å†µä¸‹ï¼Œè¿™å°†æ˜¯ <code>-(-4)</code>ï¼Œä¹Ÿå°±æ˜¯ 4ã€‚è¯¥ç¨‹åºç­‰åŒäºï¼š</p>
<blockquote>
<p>In the absense of a decrement operator, --x is parsed as -(-x). In the case of x = 4 this would be -(-4) which is 4. The program is equivalent to:</p>
</blockquote>
<pre><code class="language-rs">fn main() {
    let mut x = 4;
    4;
    print!(&quot;{}{}&quot;, 4, 4);
}
</code></pre>
<h2 id="17--------"><a class="header" href="#17--------">#17 <code>-- - --</code></a></h2>
<h3 id="é¢˜ç›®-16"><a class="header" href="#é¢˜ç›®-16">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn main() {
    let mut a = 5;
    let mut b = 3;
    print!(&quot;{}&quot;, a-- - --b);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-16"><a class="header" href="#æç¤º-16">æç¤º</a></h3>
<p>Rust æ”¯æŒçš„æ“ä½œç¬¦éƒ½åœ¨ <code>stdï¼šï¼šops</code>ã€‚</p>
<blockquote>
<p>The set of operators supported by Rust is documented in <code>std::ops</code>.</p>
</blockquote>
<h3 id="é¢˜è§£-15"><a class="header" href="#é¢˜è§£-15">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š2</p>
<p>ä¸åƒ C æˆ–è€… Javaï¼ŒRust æ²¡æœ‰è‡ªå¢å’Œè‡ªå‡è¿ç®—ç¬¦ã€‚Rust è¯­è¨€è®¾è®¡çš„ FAQï¼ˆç½‘ä¸Šå·²ç»æ²¡æœ‰äº†ï¼‰æ›¾ç»æ¢è®¨è¿‡è¿™ä¸ªåŸå› ã€‚</p>
<blockquote>
<p>Unlike C or Java, there is no unary increment or decrement operator in Rust. The Rust language design FAQ (no longer available online) used to touch on the reason:</p>
</blockquote>
<p>ä¸ºä»€ä¹ˆ Rust æ²¡æœ‰è‡ªå¢å’Œè‡ªå‡è¿ç®—ç¬¦ï¼Ÿ</p>
<p>Preincrement (<code>++i</code>) å’Œ Postincrement (<code>--i</code>)ï¼ˆä»¥åŠä¸ä¹‹å¯¹åº”çš„ Decrementï¼‰ï¼Œè™½ç„¶æ–¹ä¾¿ï¼Œä½†ä¹Ÿç›¸å½“å¤æ‚ã€‚ç”¨æˆ·éœ€è¦çŸ¥é“æ±‚å€¼é¡ºåºï¼Œè¿™ç»å¸¸å¯¼è‡´ä¸€äº› C å’Œ C++ ä¸­å¾®å¦™çš„é”™è¯¯å’Œæœªå®šä¹‰çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>Why doesn't Rust have increment and decrement operators?
Preincrement and postincrement (and the decrement equivalents), while convenient, are also fairly complex. They require knowledge of evaluation order, and often lead to subtle bugs and undefined behavior in C and C++. x = x + 1 or x += 1 is only slightly longer, but unambiguous.</p>
</blockquote>
<p>åœ¨æ²¡æœ‰è‡ªå‡è¿ç®—ç¬¦ (åŒ…æ‹¬ <code>i--</code> å’Œ <code>--i</code>) çš„æƒ…å†µä¸‹ï¼Œ<code>a-- --b</code> ä¼šè¢«è§£æä¸º <code>a-(-(-(-b))))</code>ã€‚åœ¨ <code>a=5</code> å’Œ <code>b=3</code> çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„å€¼æ˜¯ <code>5-3</code>ï¼Œä¹Ÿå°±æ˜¯ <code>2</code>ã€‚</p>
<blockquote>
<p>In the absense of postfix and prefix decrement operators, a-- - --b is parsed as a - (-(-(-(-b)))). In the case of a = 5 and b = 3 the value of this expression is 5 - 3 which is 2.</p>
</blockquote>
<h2 id="18-f-and-f"><a class="header" href="#18-f-and-f">#18 <code>f() and f()</code></a></h2>
<h3 id="é¢˜ç›®-17"><a class="header" href="#é¢˜ç›®-17">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct S {
    f: fn(),
}

impl S {
    fn f(&amp;self) {
        print!(&quot;1&quot;);
    }
}

fn main() {
    let print2 = || print!(&quot;2&quot;);
    S { f: print2 }.f();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-17"><a class="header" href="#æç¤º-17">æç¤º</a></h3>
<p>è°ƒç”¨ <code>.f()</code> å¯ä»¥è§£æä¸ºå­—æ®µ f æˆ–å›ºæœ‰çš„æ–¹æ³• fï¼Œä½ å¦‚ä½•å†™å‡ºå¯¹å¦ä¸€ä¸ªçš„è°ƒç”¨ï¼Ÿ</p>
<blockquote>
<p>The call .f() resolves to either the field f or the inherent method f. How would you write a call to the other one?</p>
</blockquote>
<h3 id="é¢˜è§£-16"><a class="header" href="#é¢˜è§£-16">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1</p>
<p>ä¸€ä¸ªçœ‹èµ·æ¥åƒ <code>.f()</code>çš„è°ƒç”¨æ€»ä¼šè§£æåˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™é‡Œæ˜¯å›ºæœ‰çš„æ–¹æ³• <code>S::f</code>ã€‚å¦‚æœä½œç”¨åŸŸå†…æ²¡æœ‰æ–¹æ³• fï¼Œé‚£ä¹ˆå³ä½¿å­—æ®µ f å­˜åœ¨å¹¶åŒ…å«ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™æ ·çš„è°ƒç”¨ä¹Ÿä¸èƒ½ç¼–è¯‘ã€‚</p>
<blockquote>
<p>A call that looks like .f() always resolves to a method, in this case the inherent method <code>S::f</code>. If there were no method f in scope, a call like this would fail to compile even if a field f exists and contains a function pointer.</p>
</blockquote>
<p>ä¸ºäº†è°ƒç”¨å­˜å‚¨åœ¨å­—æ®µ f ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼Œæˆ‘ä»¬éœ€è¦åœ¨å­—æ®µå‘¨å›´å†™ä¸Šåœ†æ‹¬å·ã€‚</p>
<blockquote>
<p>To call the function pointer stored in field f, we would need to write parentheses around the field access:</p>
</blockquote>
<pre><code class="language-rs">fn main() {
    let print2 = || print!(&quot;2&quot;);
    (S { f: print2 }.f)();
}
</code></pre>
<h2 id="19-move-or-drop"><a class="header" href="#19-move-or-drop">#19 <code>move or drop</code></a></h2>
<h3 id="é¢˜ç›®-18"><a class="header" href="#é¢˜ç›®-18">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct S;

impl Drop for S {
    fn drop(&amp;mut self) {
        print!(&quot;1&quot;);
    }
}

fn main() {
    let s = S;
    let _ = s;
    print!(&quot;2&quot;);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-18"><a class="header" href="#æç¤º-18">æç¤º</a></h3>
<p>s æ‰€æœ‰æƒç§»åŠ¨äº†å—ï¼Ÿ</p>
<blockquote>
<p>Does s get moved?</p>
</blockquote>
<h3 id="é¢˜è§£-17"><a class="header" href="#é¢˜è§£-17">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š21</p>
<p>ç›¸å…³çš„ä¸€è¡Œæ˜¯ <code>let _ = s</code>ã€‚å¦‚æœè¿™ä¸€è¡Œæ²¡æœ‰ç§»åŠ¨ sï¼Œé‚£ä¹ˆ s å°†ç»§ç»­å­˜åœ¨ï¼Œç›´åˆ°å¤§æ‹¬å·ç»“å°¾ï¼Œç¨‹åºå°†æ‰“å° 21ã€‚ä½†æ˜¯å¦‚æœè¿™ä¸€è¡Œç§»åŠ¨äº† sï¼Œè€Œæ²¡æœ‰ç»‘å®šå®ƒï¼Œé‚£ä¹ˆè¢«ç§»åŠ¨çš„ S ç±»å‹çš„å€¼å°†è¢«ç«‹å³ dropï¼Œç¨‹åºå°†æ‰“å° 12ã€‚</p>
<blockquote>
<p>The relevant line is let _ = s. If this line does not move s then s will continue to live until the close curly brace and the program would print 21. But if this line does move s, without binding it, then the moved value of type S would be dropped immediately and the program would print 12.</p>
</blockquote>
<p>äº‹å®ä¸Šï¼Œs å¹¶æ²¡æœ‰è¢«ç§»åŠ¨ï¼Œè¾“å‡ºç»“æœæ˜¯ 21ã€‚</p>
<blockquote>
<p>In fact s does not get moved and the output is 21.</p>
</blockquote>
<h2 id="20-return-and-return"><a class="header" href="#20-return-and-return">#20 <code>return and return</code></a></h2>
<h3 id="é¢˜ç›®-19"><a class="header" href="#é¢˜ç›®-19">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn return1() {
    if (return { print!(&quot;1&quot;) }) {
    }
}

fn return2() {
    if return { print!(&quot;2&quot;) } {
    }
}

fn break1() {
    loop {
        if (break { print!(&quot;1&quot;) }) {
        }
    }
}

fn break2() {
    loop {
        if break { print!(&quot;2&quot;) } {
        }
    }
}

fn main() {
    return1();
    return2();
    break1();
    break2();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-19"><a class="header" href="#æç¤º-19">æç¤º</a></h3>
<p>Rust ä¸­æ¶‰åŠ break çš„è¯­æ³•ä¸æ¶‰åŠ return çš„è¯­æ³•ä¸åŒã€‚</p>
<blockquote>
<p>The Rust grammar involving break is different from the grammar involving return.</p>
</blockquote>
<h3 id="é¢˜è§£-18"><a class="header" href="#é¢˜è§£-18">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š121</p>
<p>è®©æˆ‘ä»¬ä»¥æ­¤ç ”ç©¶è¿™äº›å‡½æ•°ã€‚</p>
<blockquote>
<p>Let's work through the functions one at a time.</p>
</blockquote>
<ul>
<li>
<p><code>fn return1</code></p>
<p>if è¯­å¥çš„ï¼Œæ¡ä»¶ã€‚è¢«è§£æä¸ºä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ä¼šè¿”å› <code>{ print!(&quot;1&quot;) }</code> å³ ().è¿™ä¸ªå€¼éœ€è¦åœ¨è¿”å›å‰è¢«è®¡ç®—ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å° 1.</p>
<blockquote>
<p>The condition of the if-statement is parsed as a return-expression that returns the value { print!(&quot;1&quot;) } of type (). The value needs to be evaluated prior to being returned so this function prints 1.</p>
</blockquote>
</li>
<li>
<p><code>fn return2</code></p>
<p>è¿™ä¸ªå‡½æ•°å’Œ <code>return1</code> ä¸€æ ·ã€‚<code>return</code> å…³é”®å­—ä¼šç«‹å³æ¶ˆè€—æ‰è¿”å›å€¼ï¼Œå³ä½¿è¿”å›å€¼è¢«å¤§æ‹¬å·åŒ…è£¹ï¼ç”šè‡³æ˜¯åœ¨ if è¯­å¥çš„æ¡ä»¶ä¸­ï¼Œå¤§æ‹¬å· (ä¾‹å¦‚ç»“æ„ä½“) é€šå¸¸ä¹Ÿä¸ä¼šè¢«æ¥å—ã€‚</p>
<blockquote>
<p>This function is parsed the same as return1. The return keyword eagerly consumes a trailing return value, even if the return value begins with a curly brace, and even in the condition of an if-statement where curly braces such as in a struct literal would ordinarly not be accepted. This function prints 2.</p>
</blockquote>
</li>
<li>
<p><code>fn break1</code></p>
<p>if è¯­å¥çš„æ¡ä»¶æ˜¯æ˜¯ä¸ª break-with-value è¡¨è¾¾å¼ï¼Œå®ƒä¼šç»“æŸæ•´ä¸ªå¾ªç¯ï¼Œå¹¶è¿”å› <code>{ print!(&quot;1&quot;) }</code>, å³ ()ï¼Œå’Œ <code>return1</code> ç±»ä¼¼ï¼Œä¸ºäº†åœ¨æ‰“ç ´å¾ªç¯æ—¶è¿”å›å€¼ï¼Œè¿™ä¸ªå€¼éœ€è¦è¢«è®¡ç®—ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰“å° 1ï¼›</p>
<blockquote>
<p>The condition of the if-statement is a break-with-value expression that breaks out of the enclosing loop with the value { print!(&quot;1&quot;) } of type (). Similar to return1, in order to break with this value the value needs to be evaluated and this function prints 1.</p>
</blockquote>
</li>
<li>
<p><code>fn break2</code></p>
<p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° break å’Œ return è¯­æ³•çš„åŒºåˆ«ã€‚ä¸åƒ returnï¼Œif æ¡ä»¶é‡Œçš„ break å…³é”®å­—ä¸ä¼šç«‹å³è§£æå‡ºåé¢å¤§æ‹¬å·çš„å€¼ã€‚è¿™æ®µä»£ç ä¼šè¢«è§£æä¸ºï¼š</p>
<blockquote>
<p>Here we observe a difference between the grammar of break and the grammar of return. Unlike return, the break keyword in the condition of this if-statement does not eagerly parse a value that begins with a curly brace. This code is parsed as:</p>
</blockquote>
<pre><code class="language-rs">loop {
    if break {
        print!(&quot;2&quot;)
    }
    {}
}
</code></pre>
<p>æˆ‘ä»¬åœ¨æ‰§è¡Œ print å‰æ‰“ç ´äº†å¾ªç¯ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¸ä¼šæ‰§è¡Œ print.</p>
<blockquote>
<p>We break out of the loop before executing the print, so this function does not print anything.</p>
</blockquote>
<p>æˆ‘ç›¸ä¿¡ return å’Œ break ä¸åŒçš„åŸå› æ˜¯ï¼Œreturn åœ¨ Rust 1.0 ä»¥åŠä¹‹å‰æ˜¾ç„¶éƒ½æ˜¯æ”¯æŒçš„ï¼Œä½†æ˜¯ break-with-value æ˜¯åœ¨ Rust 1.19 æ‰è¢«å¼•å…¥ä¹‹åã€‚<code>break2</code> ä¸­çš„ä»£ç ä¸€ç›´éƒ½æ˜¯åˆæ³•çš„ Rust ä»£ç ï¼Œæ‰€ä»¥åœ¨å®ç° break-with-value è¿™ä¸ªè¯­è¨€ç‰¹æ€§æ—¶ä¹Ÿè€ƒè™‘åˆ°ä¸èƒ½æ”¹å˜å®ƒçš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>I believe the reason for the difference between return and break is that returning a value was obviously supported at Rust 1.0 and well before, but break-with-value was introduced fairly late, in Rust 1.19. The code in break2 was perfectly legal Rust code prior to Rust 1.19 so we cannot change its behavior when implementing the break-with-value language feature.</p>
</blockquote>
<p>æœªæ¥çš„ç‰ˆæœ¬æœ‰å¯èƒ½å¯¹è¿™ä¸¤ç§è¯­æ³•è¿›è¡Œè°ƒæ•´ï¼Œä½¿ä¹‹ç›¸äº’ä¸€è‡´ã€‚</p>
<blockquote>
<p>It is possible that a future Edition would adjust the two grammars to align with each other.</p>
</blockquote>
</li>
</ul>
<p>main çš„è¾“å‡ºä¸º 121ã€‚</p>
<blockquote>
<p>The output from main is 121.</p>
</blockquote>
<h2 id="21-return--break"><a class="header" href="#21-return--break">#21 <code>return &amp; break</code></a></h2>
<h3 id="é¢˜ç›®-20"><a class="header" href="#é¢˜ç›®-20">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn f(&amp;self);
}

impl&lt;F: FnOnce() -&gt; bool&gt; Trait for F {
    fn f(&amp;self) {
        print!(&quot;1&quot;);
    }
}

impl Trait for () {
    fn f(&amp;self) {
        print!(&quot;2&quot;);
    }
}

fn main() {
    let x = || { (return) || true; };
    x().f();

    let x = loop { (break) || true; };
    x.f();

    let x = || { return (|| true); };
    x().f();

    let x = loop { break (|| true); };
    x.f();

    let x = || { return || true; };
    x().f();

    let x = loop { break || true; };
    x.f();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-20"><a class="header" href="#æç¤º-20">æç¤º</a></h3>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œbreak å’Œ return å…³é”®å­—çš„è¯­æ³•æ˜¯ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p>The break and return keywords have the same grammar in this question.</p>
</blockquote>
<h3 id="é¢˜è§£-19"><a class="header" href="#é¢˜è§£-19">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š221111</p>
<p>æˆ‘ä»¬æƒ³çŸ¥é“ <code>return || true;</code> å’Œ <code>break || true;</code> çš„æ¯ä¸€ä¸ªå¯èƒ½çš„æ‹¬å·æ˜¯å¦è¯„ä¼°ä¸ºé—­åŒ… <code>|| true</code> æˆ–å•ä½å€¼ ()ã€‚</p>
<blockquote>
<p>We want to know whether each possible parenthesization of return || true; and break || true; evaluates to the closure || true or to the unit value ().</p>
</blockquote>
<ul>
<li>
<p><code>let x = || { (return) || true; };</code></p>
<p>åœ¨è¿™ä¸€è¡Œï¼Œx æ˜¯ä¸€ä¸ªè¿”å› () çš„é—­åŒ…ã€‚ç­‰ä»·äº <code>let x = || {}</code>.å½“æˆ‘ä»¬è°ƒç”¨ <code>x().f()</code> æ—¶ï¼Œæ–¹æ³• f ä¼šè¢«è§£æä¸º <code>impl Trait for ()</code>, å¹¶æ‰“å° 2.</p>
<blockquote>
<p>On this line, x is a closure that returns (). It is equivalent to let x = || {}. When we call x().f(), the method f resolves to impl Trait for () which prints 2.</p>
</blockquote>
<p>è¡¨è¾¾å¼ <code>(treturn)</code> çš„ç±»å‹æ˜¯åŸå§‹çš„ never ç±»å‹ï¼Œé€šå¸¸å†™æˆ <code>ï¼</code>ã€‚è®¡ç®— <code>! || true</code> æ˜¯åˆæ³•çš„ï¼Œå› ä¸º <code>!</code> å¯ä»¥è½¬ä¸ºä»»ä½•ç±»å‹ï¼Œåœ¨è¿™é‡Œæ˜¯ <code>bool</code>ã€‚è¡¨è¾¾å¼ <code>! || true</code> æ˜¯ä¸€ä¸ªé€»è¾‘æˆ–ï¼Œå·¦ä¾§å’Œå³ä¾§éƒ½æ˜¯ <code>bool</code>ã€‚</p>
<blockquote>
<p>The type of the expression (return) is the primitive never type, usually written as !. It is legal to compute ! || true because ! can fill in for any type, in this case bool. The expression ! || true is a logical-OR with bool on both the left-hand side and right-hand side.</p>
</blockquote>
<p><code>!</code> å¯ä»¥è½¬ä¸ºä»»ä½•ç±»å‹çš„è¡Œä¸ºå…è®¸æˆ‘ä»¬å†™å‡ºå¦‚ä¸‹ä»£ç ï¼š</p>
<blockquote>
<p>The behavior of ! of filling in for any type is what allows us to write:</p>
</blockquote>
<pre><code class="language-rs">fn f() -&gt; bool {
    unimplemented!()
}
</code></pre>
<p>å…¶ä¸­ <code>unimplemented!()</code> çš„ç±»å‹ï¼Œå› ä¸ºå®ƒåœ¨æ²¡æœ‰æ±‚å€¼çš„æƒ…å†µä¸‹ç›´æ¥ panicï¼Œå®ƒçš„è¿”å›å€¼ç±»å‹ä¹Ÿæ˜¯ <code>ï¼</code>ã€‚</p>
<blockquote>
<p>in which the type of unimplemented!(), since it panics without evaluating to any value, is also !.</p>
</blockquote>
</li>
<li>
<p><code>let x = loop { (break) || true; };</code></p>
<p>å’Œ <code>(return)</code> ç±»ä¼¼ï¼Œ<code>(break)</code> çš„ç±»å‹ä¹Ÿæ˜¯ <code>!</code>. è¿™è¡Œä»£ç ä¼šæ‰“ç ´å¾ªç¯ï¼Œå¹¶è¿”å› <code>()</code>, æ‰€ä»¥ <code>x</code> çš„ç±»å‹æ˜¯ <code>()</code>.è°ƒç”¨ <code>x.f()</code> ä¼šæ‰“å° 2.</p>
<blockquote>
<p>Similar to (return), the type of (break) is the never type !. This code breaks out of the loop with the implicit value (), so x is of type (). Calling x.f() will print 2.</p>
</blockquote>
</li>
<li>
<p><code>let x = || { return (|| true); };</code></p>
<p>åœ¨è¿™ä¸€è¡Œï¼Œ<code>x</code> æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå®ƒè¿”å›ä¸€ä¸ªè¿”å› true çš„é—­åŒ…ã€‚ä½ å¯ä»¥å†™ <code>x()()</code>ï¼Œå®ƒçš„å€¼ä¼šæ˜¯ trueã€‚</p>
<blockquote>
<p>On this line x is a closure that returns a closure that returns true. You could write x()() and that would be true.</p>
</blockquote>
<p>Quiz ä»£ç è°ƒç”¨äº† <code>x().f()</code>, è¿™ä¼šè§£æä¸º <code>impl&lt;F&gt; Trait for F where F: FnOnce() -&gt; bool</code>. æœ€ç»ˆæ‰“å° 1.</p>
<blockquote>
<p>The quiz code calls <code>x().f()</code> which resolves to <code>impl&lt;F&gt; Trait for F where F: FnOnce() -&gt; bool</code>. That trait impl prints 1.</p>
</blockquote>
</li>
<li>
<p><code>let x = loop { break (|| true); };</code></p>
<p>è¿™æ˜¯ä¸€ä¸ªåŒ…å« <code>break-with-value</code> è¡¨è¾¾å¼çš„å¾ªç¯ã€‚<code>break</code> çš„å‚æ•°å˜æˆäº†å¾ªç¯çš„è¿”å›å€¼ã€‚è¿™æ®µä»£ç ç­‰åŒäº <code>let x = || true</code>ã€‚</p>
<blockquote>
<p>This is a loop containing a break-with-value expression. The argument of the break becomes the value of the enclosing loop. This code is equivalent to let <code>x = || true</code>.</p>
</blockquote>
<p>å½“æˆ‘ä»¬è°ƒç”¨ <code>x.f()</code> æ—¶ï¼Œå®ƒä½¿ç”¨äº† FnOnce çš„ Trait å®ç°ï¼Œæ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>When we call <code>x.f()</code> it uses the FnOnce impl of Trait which prints 1.</p>
</blockquote>
</li>
<li>
<p><code>let x = || { return || true; };</code></p>
<p>ç°åœ¨æˆ‘ä»¬æ¥åˆ°äº†è¿™ä¸ªé—®ç­”é—®é¢˜çš„æ ¸å¿ƒã€‚<code>return || true</code> çš„è§£æä¸ <code>(return) || true</code> ç›¸åŒï¼Œè¿˜æ˜¯ä¸ <code>return (|| true)</code> ç›¸åŒï¼Ÿ</p>
<blockquote>
<p>Now we arrive at the meat of this quiz question. Is <code>return || true</code> parsed the same as <code>(return) || true</code> or as <code>return (|| true)</code>?</p>
</blockquote>
<p>ç»“æœæ˜¯åè€…ï¼Œæ‰€ä»¥ x æ˜¯ä¸€ä¸ªè¿”å› true çš„é—­åŒ…ã€‚<code>x().f()</code> æ‰“å° 1ã€‚</p>
<blockquote>
<p>It turns out to be the latter, so x is a closure that returns a closure that returns true. <code>x().f()</code> prints 1.</p>
</blockquote>
</li>
<li>
<p><code>let x = loop { break || true; };</code></p>
<p>è¿™ä¸ªä¹Ÿæ˜¯ç±»ä¼¼çš„é—®é¢˜ï¼Œè¿™æ˜¯ <code>(break) || true</code> è¿˜æ˜¯ <code>break (|| true)</code>ï¼Ÿ</p>
<blockquote>
<p>Similar question here, is this <code>(break) || true</code> or <code>break (|| true)</code>?</p>
</blockquote>
<p><code>break-with-value</code> è¯­è¨€åŠŸèƒ½æ˜¯åœ¨ 1.0 ä¹‹åçš„ä¸¤å¹´å (Rust 1.19) åŠ å…¥çš„ã€‚åœ¨ break-with-value ä¹‹å‰ï¼Œ<code>break || true</code> æ˜¯å®Œå…¨åˆæ³•çš„ Rust ä»£ç ï¼Œè§£æä¸º <code>(break) || true</code>ã€‚</p>
<blockquote>
<p>The break-with-value language feature was added to Rust more than two years after 1.0, in Rust 1.19. Prior to break-with-value, <code>break || true</code> was perfectly legal Rust code that parsed as <code>(break) || true</code>.</p>
</blockquote>
<p>åœ¨ Rust 1.19 ä¸­ï¼Œè¿™æ®µä»£ç çš„è¡Œä¸ºè¢«è¯­è¨€æ— æ„ä¸­æ‰“ç ´äº†ï¼Œç°åœ¨å®ƒè¢«è§£æä¸º <code>break (|| true)</code>ï¼Œæ‰“å°å‡ºæ¥çš„å€¼æ˜¯ 1ã€‚</p>
<blockquote>
<p>In Rust 1.19 the behavior of this code was unintentionally broken by the language such that now it parses as <code>break (|| true)</code> and the printed value is 1.</p>
</blockquote>
<p>å¦‚æœæˆ‘ä»¬åœ¨ Rust 1.19 çš„å¼€å‘è¿‡ç¨‹ä¸­æ³¨æ„åˆ°è¿™ç§æ„ä¹‰ä¸Šçš„å˜åŒ–ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè°ƒæ•´è§£æä»¥ä¿ç•™ç°æœ‰ä»£ç çš„æ„ä¹‰ã€‚ä¸å¹¸çš„æ˜¯ï¼Œè¿™æ ·åšä¼šå¯¼è‡´è¯­æ³•åœ¨ return å’Œ break ä¹‹é—´æœ‰ä¸åŒçš„è¡¨ç°ï¼Œé™¤äº†å†å²çš„æ„å¤–ï¼Œæ²¡æœ‰ä»»ä½•åˆç†çš„ç†ç”±ã€‚</p>
<blockquote>
<p>If we had noticed this change in meaning during the development of Rust 1.19, we may have adjusted the parsing to preserve the meaning of existing code. Unfortunately doing so would result in a grammar that behaves differently between return and break for no justifiable reason other than an accident of history.</p>
</blockquote>
<p>æˆ–è€…ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰å¯èƒ½è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ°¸è¿œä¸ä¼šå‡ºç°åœ¨çœŸå®ä»£ç ä¸­çš„è¯­æ³•è¾¹ç¼˜æ¡ˆä¾‹ï¼Œç”¨ Crater æ¥éªŒè¯è¿™ä¸€å‡è®¾ï¼Œå¹¶æœ‰æ„æ‰“ç ´è¿™ä¸€è¡Œä¸ºã€‚</p>
<blockquote>
<p>Or it is possible we would have ruled this an edge case of syntax that would never appear in real code, used Crater to validate that hypothesis, and broken the behavior intentionally.</p>
</blockquote>
</li>
</ul>
<p>main çš„å®Œæ•´è¾“å‡ºæ˜¯ 221111.</p>
<blockquote>
<p>The total output from main is 221111.</p>
</blockquote>
<h2 id="22---is-a-token"><a class="header" href="#22---is-a-token">#22 <code>- is a token</code></a></h2>
<h3 id="é¢˜ç›®-21"><a class="header" href="#é¢˜ç›®-21">é¢˜ç›®</a></h3>
<pre><code class="language-rs">macro_rules! m {
    ($a:tt) =&gt; { print!(&quot;1&quot;) };
    ($a:tt $b:tt) =&gt; { print!(&quot;2&quot;) };
    ($a:tt $b:tt $c:tt) =&gt; { print!(&quot;3&quot;) };
    ($a:tt $b:tt $c:tt $d:tt) =&gt; { print!(&quot;4&quot;) };
    ($a:tt $b:tt $c:tt $d:tt $e:tt) =&gt; { print!(&quot;5&quot;) };
    ($a:tt $b:tt $c:tt $d:tt $e:tt $f:tt) =&gt; { print!(&quot;6&quot;) };
    ($a:tt $b:tt $c:tt $d:tt $e:tt $f:tt $g:tt) =&gt; { print!(&quot;7&quot;) };
}

fn main() {
    m!(-1);
    m!(-1.);
    m!(-1.0);
    m!(-1.0e1);
    m!(-1.0e-1);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-21"><a class="header" href="#æç¤º-21">æç¤º</a></h3>
<p>macro ä¼šè®¡ç®—è¾“å…¥çš„ &quot;token&quot; çš„æ•°é‡ã€‚</p>
<blockquote>
<p>The macro is counting how many &quot;tokens&quot; are in its input.</p>
</blockquote>
<h3 id="é¢˜è§£-20"><a class="header" href="#é¢˜è§£-20">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š22222</p>
<p>æ‰€æœ‰çš„ mï¼è°ƒç”¨éƒ½ä¼ é€’äº†ä¸¤ä¸ªæ ‡è®°ä½œä¸ºè¾“å…¥ï¼šä¸€ä¸ªå‡å·ï¼Œç„¶åæ˜¯ä¸€ä¸ªæ•´æ•°æˆ–æµ®ç‚¹å­—æ ·çš„æ ‡è®°ã€‚</p>
<blockquote>
<p>All five invocations of m! pass two tokens as input: a minus sign followed by an integer or floating point literal token.</p>
</blockquote>
<p>æµ®ç‚¹å­—é¢ç¬¦å· <code>1.</code>ã€<code>1.0</code>ã€<code>1.0e1</code>ã€<code>1.0e-1</code> éƒ½æ˜¯å•ä¸€çš„åŸå­ç¬¦å·ã€‚</p>
<blockquote>
<p>The floating point literals 1., 1.0, 1.0e1, 1.0e-1 are each a single atomic token.</p>
</blockquote>
<p>Rust ç¼–è¯‘å™¨å†…ç½®çš„è§£æå™¨æ€»æ˜¯å°†è´Ÿå·ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ ‡è®°ï¼Œä¸æ•°å­—è¿›è¡ŒåŒºåˆ†ã€‚ç„¶è€Œï¼Œåœ¨è¿‡ç¨‹å®ä¸­ï¼Œç”¨æˆ·å®šä¹‰çš„è§£æå™¨å¯ä»¥é€šè¿‡å‘ <code>proc_macro::Literal</code> çš„æ„é€ å™¨ä¹‹ä¸€ä¼ é€’ä¸€ä¸ªè´Ÿçš„æ•´æ•°æˆ–è´Ÿçš„æµ®ç‚¹æ•°æ¥æ„é€ ä¸€ä¸ªè´Ÿæ•°ä½œä¸ºå•ä¸ªæ ‡è®°ã€‚å¦‚æœè¿™æ ·çš„è´Ÿæ•°æœ€ç»ˆå‡ºç°åœ¨éšåçš„è¿‡ç¨‹å®è°ƒç”¨çš„è¾“å…¥ä¸­ï¼Œåˆ™ç”±ç¼–è¯‘å™¨å†³å®šæ˜¯é‡å†™æˆä¸€å¯¹æ ‡è®°è¿˜æ˜¯å°†å…¶ä½œä¸ºä¸€ä¸ªæ ‡è®°ã€‚</p>
<blockquote>
<p>The parser built into the Rust compiler always parses a negative sign as a separate token from the numeric literal that is being negating. However, it is possible for a user-defined parser within a procedural macro to construct a negative number as a single token by passing a negative integer or negative floating point value to one of the constructors of <code>proc_macro::Literal</code>. If such a negative literal ends up in the input of a subsequent procedural macro invocation, it is up to the compiler whether to rewrite into a pair of tokens or keep them as one.</p>
</blockquote>
<p>ç¼–è¯‘å™¨çš„è§£æå™¨çš„è¡Œä¸ºåœ¨è¯­è¨€è¡¨é¢ä¹Ÿæ˜¯å¯ä»¥è§‚å¯Ÿåˆ°çš„ï¼Œä¸ä»…ä»…æ˜¯åœ¨å®ä¸­ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä»£ç æ‰“å°å‡º -81ï¼Œå› ä¸ºè¡¨è¾¾å¼è¢«è§£æä¸º <code>-(3i32.pow(4))</code> è€Œä¸æ˜¯ <code>(-3i32).pow(4)</code>ã€‚</p>
<blockquote>
<p>The behavior of the compiler's parser is observable in the surface language as well, not only in macros. For example the following code prints -81 because the expression is parsed as -(3i32.pow(4)) rather than (-3i32).pow(4).</p>
</blockquote>
<pre><code class="language-rs">fn main() {
    let n = -3i32.pow(4);
    println!(&quot;{}&quot;, n);
}
</code></pre>
<h2 id="23-method-lookup-order"><a class="header" href="#23-method-lookup-order">#23 <code>method lookup order</code></a></h2>
<h3 id="é¢˜ç›®-22"><a class="header" href="#é¢˜ç›®-22">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn f(&amp;self);
    fn g(&amp;self);
}

struct S;

impl S {
    fn f(&amp;self) {
        print!(&quot;1&quot;);
    }

    fn g(&amp;mut self) {
        print!(&quot;1&quot;);
    }
}

impl Trait for S {
    fn f(&amp;self) {
        print!(&quot;2&quot;);
    }

    fn g(&amp;self) {
        print!(&quot;2&quot;);
    }
}

fn main() {
    S.f();
    S.g();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-22"><a class="header" href="#æç¤º-22">æç¤º</a></h3>
<p>æˆ‘ä¸èƒ½å¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚è¿™æ˜¯ç”±è¯­è¨€æœ¬èº«åšå‡ºçš„ä¸€ä¸ªç›¸å½“éšæ„çš„é€‰æ‹©ã€‚è¯•è¯•æ‰€æœ‰çš„å¯èƒ½å§ï¼</p>
<blockquote>
<p>I can't help you with this one. This is a pretty arbitrary choice made by the language. Try all the possibilities!</p>
</blockquote>
<h3 id="é¢˜è§£-21"><a class="header" href="#é¢˜è§£-21">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š12</p>
<p><code>S.f()</code> ä¼šè°ƒç”¨å›ºæœ‰æ–¹æ³• fã€‚å¦‚æœä¸€ä¸ªå›ºæœ‰æ–¹æ³•å’Œä¸€ä¸ª Trait æ–¹æ³•åŒåï¼Œå¹¶ä¸”è¿”å›å€¼ç›¸åŒï¼Œæ™®é€šçš„æ–¹æ³•è°ƒç”¨æ€»æ˜¯ä¼šé€‰æ‹©å›ºæœ‰æ–¹æ³•ã€‚è°ƒç”¨è¿™å¿…é¡»å†™ <code>Trait::f(&amp;s)</code> æˆ–è€… <code>&lt;S as Trait&gt;::f(&amp;s)</code> å»è°ƒç”¨ Trait æ–¹æ³•ã€‚ </p>
<blockquote>
<p><code>S.f()</code> calls the inherent method f. If an inherent method and a trait method have the same name and receiver type, plain method call syntax will always prefer the inherent method. The caller would need to write <code>Trait::f(&amp;S)</code> or <code>&lt;S as Trait&gt;::f(&amp;S)</code> in order to call the trait method.</p>
</blockquote>
<p>å¯¹äºå®çš„ä½œè€…æ¥è¯´ï¼Œæ„è¯†åˆ°è¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚å®ç”Ÿæˆçš„ä»£ç é€šå¸¸ä¸åº”è¯¥ä½¿ç”¨æ™®é€šçš„æ–¹æ³•è°ƒç”¨è¯­æ³•æ¥è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ç±»å‹ä¸Šçš„ç‰¹å¾æ–¹æ³•ã€‚è¿™äº›è°ƒç”¨å¯èƒ½ä¼šè¢«ä¸ç‰¹è´¨æ–¹æ³•åŒåçš„å›ºæœ‰æ–¹æ³•æ— æ„ä¸­åŠ«æŒã€‚</p>
<blockquote>
<p>It is important for macro authors to be aware of this. Macro-generated code typically should not use method call syntax to invoke trait methods on types defined by the user. Those calls could get unintentially hijacked by inherent methods having the same name as the trait method.</p>
</blockquote>
<p>å¦ä¸€æ–¹é¢ï¼Œ<code>S.g()</code> è°ƒç”¨ç‰¹è´¨æ–¹æ³• <code>g</code>ã€‚åœ¨æ–¹æ³•è§£æè¿‡ç¨‹ä¸­ï¼Œå¦‚æœ <code>&amp;</code> å’Œ <code>ï¼†mut</code> éƒ½å¯ä»¥è°ƒç”¨ï¼Œè‡ªåŠ¨å¼•ç”¨æ€»æ˜¯å€¾å‘äºå°†æŸæ ·ä¸œè¥¿å˜æˆ <code>&amp;</code>ï¼Œè€Œä¸æ˜¯å°†å…¶å˜æˆ <code>&amp;mut</code>ã€‚</p>
<blockquote>
<p>On the other hand, S.g() calls the trait method g. Auto-ref during method resolution always prefers making something into &amp; over making it into &amp;mut where either one would work.</p>
</blockquote>
<p>è¯·å‚é˜… <a href="https://stackoverflow.com/a/28552082/6086311">Stack Overflow</a> çš„ç­”æ¡ˆï¼Œäº†è§£æ–¹æ³•è§£æè¿‡ç¨‹ä¸­è‡ªåŠ¨å¼•ç”¨çš„æ›´è¯¦ç»†è§£é‡Šã€‚</p>
<blockquote>
<p>See this Stack Overflow answer for a more detailed explanation of auto-ref during method resolution.</p>
</blockquote>
<h2 id="24-hygiene"><a class="header" href="#24-hygiene">#24 <code>Hygiene</code></a></h2>
<h3 id="é¢˜ç›®-23"><a class="header" href="#é¢˜ç›®-23">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn main() {
    let x: u8 = 1;
    const K: u8 = 2;

    macro_rules! m {
        () =&gt; {
            print!(&quot;{}{}&quot;, x, K);
        };
    }

    {
        let x: u8 = 3;
        const K: u8 = 4;

        m!();
    }
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-23"><a class="header" href="#æç¤º-23">æç¤º</a></h3>
<p>å®çš„å«ç”Ÿæ€§åªæ˜¯ç”¨äºå±€éƒ¨å˜é‡ã€‚</p>
<blockquote>
<p>Hygiene in macro_rules! only applies to local variables.</p>
</blockquote>
<h3 id="é¢˜è§£-22"><a class="header" href="#é¢˜è§£-22">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š14</p>
<p>è¿™ä¸ªç¨‹åºæ‰“å°å‡º 14ï¼Œå› ä¸ºå®çš„ &quot;å«ç”Ÿæ€§&quot;(Hygiene) åªé€‚ç”¨äºå±€éƒ¨å˜é‡ã€‚</p>
<blockquote>
<p>This program prints 14 because hygiene in macro_rules! only applies to local variables.</p>
</blockquote>
<p>ä½ å¯ä»¥æŠŠ Hygiene æƒ³è±¡æˆï¼šç»™æ¯æ¬¡æåˆ°çš„å±€éƒ¨å˜é‡çš„åå­—åˆ†é…ä¸€ç§é¢œè‰²ï¼Œå…è®¸åœ¨èŒƒå›´å†…æœ‰å¤šä¸ªå¯åŒºåˆ†çš„å±€éƒ¨å˜é‡åŒæ—¶å…·æœ‰ç›¸åŒçš„åå­—ã€‚</p>
<blockquote>
<p>You can imagine hygiene as a way of assigning a color to each mention of the name of a local variable, allowing for there to be multiple distinguishable local variables in scope simultaneously with the same name.</p>
</blockquote>
<p>åœ¨ main çš„é¡¶ç«¯ï¼Œå‡è®¾æˆ‘ä»¬è®¤ä¸ºå±€éƒ¨å˜é‡ x çš„åå­—æ˜¯ç´«è‰²çš„ xï¼Œå¸¸é‡ K çš„åå­—åªæ˜¯æ™®é€šçš„ Kï¼Œå› ä¸ºå¸¸é‡è¢«è®¤ä¸ºæ˜¯é¡¹ (Item) è€Œä¸æ˜¯å±€éƒ¨å˜é‡ï¼ˆä½ å¯ä»¥æŠŠé¡¹æ”¾åœ¨å‡½æ•°ä½“ä¹‹å¤–ï¼›ä½†æ˜¯ä¸èƒ½æŠŠå±€éƒ¨å˜é‡æ”¾åœ¨å‡½æ•°ä½“ä¹‹å¤–ï¼‰ã€‚</p>
<blockquote>
<p>At the top of main, suppose we consider the name of the local variable x to be a purple x. The name of the constant K is just plain K, as constants are considered items rather than local variables (you can place items outside of a function body; you cannot place local variables outside of a function body).</p>
</blockquote>
<pre><code>let   x: u8 = 1; // x ä¸ºç´«è‰²
const K: u8 = 2; // K ä¸ºæ— è‰²
</code></pre>
<p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼Œåœ¨ macro m! çš„å£°æ˜ä¸­ï¼Œæœ‰ä¸¤ä¸ªè¢«ç”¨åˆ°çš„æ ‡è¯†ç¬¦ã€‚å› ä¸ºä½œç”¨åŸŸå†…æœ‰ä¸€ä¸ªå˜é‡ xï¼Œæ‰€ä»¥åœ¨ m! å†…ä½¿ç”¨çš„æ ‡è¯†ç¬¦ x çš„é¢œè‰²ä¸å±€éƒ¨å˜é‡ x ç›¸åŒã€‚åœ¨ä½œç”¨åŸŸå†…æ²¡æœ‰å±€éƒ¨å˜é‡ Kï¼Œæ‰€ä»¥åœ¨å®çš„å£°æ˜ä¸­çš„ K è¢«åˆ†é…äº†ä¸€äº›æ–°çš„é¢œè‰²ï¼Œä¾‹å¦‚æ©™è‰²ã€‚</p>
<blockquote>
<p>Continuing down the body of main, within the declaration of the macro m! there are identifiers x and K being used. Since there is a local variable x in scope, the use of the identifier x within the macro body picks up the same color as the local variable x. There is no local variable K in scope so the K within the declaration of the macro is assigned some new color, say orange.</p>
</blockquote>
<pre><code>macro_rules! m {
    () =&gt; {
        print!(&quot;{}{}&quot;, x, K); // x ä¸ºç´«è‰²ï¼ŒK ä¸ºæ©™è‰²
    };
}
</code></pre>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªæ–°çš„ä½œç”¨åŸŸï¼ˆç”¨å¤§æ‹¬å·åˆ’å®šï¼‰ï¼ŒåŒ…å«å¦ä¸€ä¸ª x å’Œ Kã€‚æ¯ä¸€ä¸ªæ–°çš„å±€éƒ¨å˜é‡æ€»æ˜¯ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„é¢œè‰²ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™ä¸ª x å«åšè“è‰²ã€‚const ä¾ç„¶ä¸æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥æ²¡æœ‰ç»™ K åˆ†é…é¢œè‰²ã€‚</p>
<blockquote>
<p>Next we enter a new scope (delimited by curly braces) containing another x and K. Every new local variable always introduces a new color so let's call this x blue. The const again is not a local variable so no color is assigned to K.</p>
</blockquote>
<pre><code>{
    let   x: u8 = 3; // x ä¸ºè“è‰²
    const K: u8 = 4; // K ä¸ºæ— è‰²

    m!();
}
</code></pre>
<p>å½“ <code>m!()</code> å±•å¼€æ—¶ï¼Œå±•å¼€çš„ä»£ç åŒ…å«ä¸€ä¸ªç´«è‰²çš„ x å’Œä¸€ä¸ªæ©™è‰²çš„ Kã€‚ç´«è‰²çš„ x å¯ä»¥å’Œè“è‰²çš„ x åŒºåˆ†å¼€æ¥ï¼Œæ‰€ä»¥ç´«è‰²çš„ x çš„å€¼è¢«æ‰“å°å‡ºæ¥ï¼Œæ˜¯ 1ã€‚è‡³äº Kï¼Œä¸€ä¸ªä¸å«ç”Ÿçš„ï¼ˆæœªç€è‰²çš„ï¼‰K è¢«å…è®¸åƒä»»ä½•é¢œè‰²ä¸€æ ·ã€‚ç¬¬äºŒä¸ª K ä¼šé®è”½ç¬¬ä¸€ä¸ª Kã€‚å½“ m! å¯»æ‰¾ä¸€ä¸ªæ©™è‰²çš„ K æ—¶ï¼Œä¼šè¯†åˆ«åˆ°ç¬¬äºŒä¸ª Kï¼Œç¬¬äºŒä¸ª K çš„å€¼è¢«æ‰“å°å‡ºæ¥ï¼Œå³ 4ã€‚</p>
<blockquote>
<p>When m!() expands, the expanded code refers to a purple x and an orange K. The purple x is distinguishable from the blue x -- the value of the purple x is printed which is 1. As for the K, an unhygienic (uncolored) K is allowed to act like any color. The second K is shadowing the first one. It gets picked up when looking for an orange K and its value is printed, which is 4.</p>
</blockquote>
<p>æ‰€ä»¥è¾“å‡ºæ˜¯ 14ã€‚</p>
<blockquote>
<p>So the output of the quiz code is 14.</p>
</blockquote>
<h2 id="25-drop"><a class="header" href="#25-drop">#25 <code>drop</code></a></h2>
<h3 id="é¢˜ç›®-24"><a class="header" href="#é¢˜ç›®-24">é¢˜ç›®</a></h3>
<pre><code class="language-rs">use std::fmt::{self, Display};

struct S;

impl Display for S {
    fn fmt(&amp;self, formatter: &amp;mut fmt::Formatter) -&gt; fmt::Result {
        formatter.write_str(&quot;1&quot;)
    }
}

impl Drop for S {
    fn drop(&amp;mut self) {
        print!(&quot;2&quot;);
    }
}

fn f() -&gt; S {
    S
}

fn main() {
    let S = f(); 
    print!(&quot;{}&quot;, S);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-24"><a class="header" href="#æç¤º-24">æç¤º</a></h3>
<p>å¼„æ¸…æ¥šå“ªäº›å€¼è¢«å“ªäº›å˜é‡æ‰€æ‹¥æœ‰ã€‚å½“ä¸€ä¸ªå€¼ä¸å†æœ‰æ‰€æœ‰è€…æ—¶ï¼Œå®ƒå°±è¢« drop äº†ã€‚</p>
<blockquote>
<p>Figure out what values are owned by which variables where. A value is dropped when it no longer has an owner.</p>
</blockquote>
<h3 id="é¢˜è§£-23"><a class="header" href="#é¢˜è§£-23">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š212</p>
<p>ç¨‹åºæ‰“å° 212ã€‚</p>
<blockquote>
<p>This program prints 212.</p>
</blockquote>
<p>åœ¨å‡½æ•° f å†…ï¼Œæ²¡æœ‰ S ä¼šè¢« dropã€‚f å‡½æ•°å†…äº§ç”Ÿä¸€ä¸ª Sï¼Œç„¶åæŠŠå®ƒçš„æ‰€æœ‰æƒè¿”å›ç»™ f çš„è°ƒç”¨è€…ï¼›è°ƒç”¨è€…ä¼šå†³å®šä»€ä¹ˆæ—¶å€™ drop æ‰ä»–æ‹¿åˆ°çš„ Sã€‚</p>
<blockquote>
<p>No value of type S gets dropped within the body of function f. The function f conjures an S and returns ownership of it to the caller of f; the caller determines when to drop the S of which it received ownership.</p>
</blockquote>
<p>åœ¨ main çš„ç¬¬ä¸€è¡Œï¼Œæˆ‘ä»¬è°ƒç”¨äº† f(),ä½†æ˜¯å¹¶æ²¡æœ‰æŠŠå®ƒç»‘å®šåˆ°æŸä¸€ä¸ªå˜é‡ä¸Šã€‚æ‰€ä»¥ f() è¿”å›çš„ S ä¼šè¢«ç«‹å³ dropï¼Œæ‰“å°äº† 2ã€‚<code>let S = f()</code> ä¸­çš„ S æ˜¯ä¸€ä¸ªå•å…ƒç»“æ„ä½“çš„æ¨¡å¼åŒ¹é… (ä¸æ˜¯ä¸€ä¸ªå˜é‡)ï¼Œå®ƒèƒ½å¤Ÿé€šè¿‡è§£æ„åŒ¹é…åˆ° S ç»“æ„ä½“é‡Œçš„å­—æ®µï¼Œä½†æ˜¯è¿™é‡Œå¹¶æ²¡æœ‰å°†åŒ¹é…åˆ°çš„å­—æ®µç»‘å®šåˆ°æŸä¸€å˜é‡ã€‚</p>
<blockquote>
<p>On the first line of main, we call f() and perform an infallible match that binds no new variables. As no variables are declared on this line, there is no variable that could be the owner of the S returned by f() so that S is dropped at that point, printing 2. The S in let S = f() is a unit struct pattern (not a variable name) that matches a value of type S via destructuring but does not bind the value to any variable.</p>
</blockquote>
<p>main çš„ç¬¬äºŒè¡Œäº§ç”Ÿä¸€ä¸ªæ–°çš„ Sï¼Œå¹¶æ‰“å°ï¼Œæœ€ååœ¨åˆ†å·å¤„ drop å®ƒã€‚</p>
<blockquote>
<p>The second line of main conjures a new S, prints it, and drops it at the semicolon.</p>
</blockquote>
<h2 id="26-lazy-map"><a class="header" href="#26-lazy-map">#26 <code>lazy map</code></a></h2>
<h3 id="é¢˜ç›®-25"><a class="header" href="#é¢˜ç›®-25">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn main() {
    let input = vec![1, 2, 3];

    let parity = input
        .iter()
        .map(|x| {
            print!(&quot;{}&quot;, x);
            x % 2
        });

    for p in parity {
        print!(&quot;{}&quot;, p);
    }
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-25"><a class="header" href="#æç¤º-25">æç¤º</a></h3>
<p>è¯·æŸ¥é˜… <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html">Iterator</a> Trait çš„æ–‡æ¡£</p>
<blockquote>
<p>Refer to the documentation of the Iterator trait.</p>
</blockquote>
<h3 id="é¢˜è§£-24"><a class="header" href="#é¢˜è§£-24">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š112031</p>
<p>æ­£å¦‚ <code>Iterator::map</code> æ–¹æ³•çš„æ–‡æ¡£ä¸­æ‰€æè¿°çš„ï¼Œmap æ“ä½œæ˜¯æƒ°æ€§æ‰§è¡Œçš„ã€‚ä½œä¸ºå‚æ•°æä¾›ç»™ map çš„é—­åŒ…åªæœ‰åœ¨å€¼ä»ç»“æœè¿­ä»£å™¨ä¸­è¢«æ¶ˆè€—æ—¶æ‰ä¼šè¢«è°ƒç”¨ã€‚é—­åŒ…å¹¶ä¸ä¼šç«‹å³åº”ç”¨äºæ•´ä¸ªè¾“å…¥æµã€‚</p>
<blockquote>
<p>As described in the documentation of the Iterator::map method, the map operation is performed lazily. The closure provided as an argument to map is only invoked as values are consumed from the resulting iterator. The closure is not applied eagerly to the entire input stream up front.</p>
</blockquote>
<p>åœ¨è¿™æ®µä»£ç ä¸­ï¼Œfor å¾ªç¯æ˜¯é©±åŠ¨è¿­ä»£çš„å› ç´ ã€‚å¯¹äºä»å¥‡å¶æ€§è¿­ä»£å™¨ä¸­æ¶ˆè€—çš„æ¯ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬çš„é—­åŒ…éƒ½éœ€è¦è¢«æ‰§è¡Œä¸€æ¬¡ã€‚å› æ­¤ï¼Œè¾“å‡ºå°†åœ¨ç”±é—­åŒ…æ‰“å°çš„æ•°å­—å’Œç”±å¾ªç¯ä½“æ‰“å°çš„æ•°å­—ä¹‹é—´äº¤æ›¿è¿›è¡Œã€‚</p>
<blockquote>
<p>In this code, the for loop is what drives the iteration. For each element consumed from the parity iterator, our closure needs to be evaluated one time. Thus the output will alternate between numbers printed by the closure and numbers printed by the loop body.</p>
</blockquote>
<h2 id="27-dyn-trait"><a class="header" href="#27-dyn-trait">#27 <code>dyn Trait</code></a></h2>
<h3 id="é¢˜ç›®-26"><a class="header" href="#é¢˜ç›®-26">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Base {
    fn method(&amp;self) {
        print!(&quot;1&quot;);
    }
}

trait Derived: Base {
    fn method(&amp;self) {
        print!(&quot;2&quot;);
    }
}

struct BothTraits;
impl Base for BothTraits {}
impl Derived for BothTraits {}

fn dynamic_dispatch(x: &amp;dyn Base) {
    x.method();
}

fn static_dispatch&lt;T: Base&gt;(x: T) {
    x.method();
}

fn main() {
    dynamic_dispatch(&amp;BothTraits);
    static_dispatch(BothTraits);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-26"><a class="header" href="#æç¤º-26">æç¤º</a></h3>
<p><code>Base::method</code> å’Œ <code>Derived::method</code> ç¢°å·§æœ‰ç›¸åŒçš„åå­—ï¼Œä½†æ˜¯æ˜¯æ¯«ä¸ç›¸å…³çš„ä¸¤ä¸ªæ–¹æ³•ã€‚ä¸ä¼šäº’ç›¸è¦†ç›–ã€‚</p>
<blockquote>
<p>Base::method and <code>Derived::method</code> happen to have the same name but are otherwise unrelated methods. One does not override the other.</p>
</blockquote>
<h3 id="é¢˜è§£-25"><a class="header" href="#é¢˜è§£-25">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š11</p>
<p>è¿™ä¸¤ä¸ª Traitï¼Œ<code>Base</code> å’Œ <code>Derived</code> å„è‡ªå®šä¹‰äº†ä¸€ä¸ªåä¸º method çš„ Trait æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•åªæ˜¯ç¢°å·§æ‹¥æœ‰ç›¸åŒçš„åç§°ï¼Œä½†åœ¨å…¶ä»–æ–¹é¢å¹¶ä¸ç›¸å…³ï¼Œå¦‚ä¸‹æ–‡æ‰€è§£é‡Šã€‚</p>
<blockquote>
<p>The two traits Base and Derived each define a trait method called method. These methods happen to have the same name but are otherwise unrelated methods as explained below.</p>
</blockquote>
<p>ä¸¤ä¸ª Trait éƒ½ä¸º method æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„å®ç°ã€‚å¦‚æœæŸä¸ªå…·ä½“å®ç°æ²¡æœ‰å®šä¹‰æ–¹æ³•ï¼Œé‚£ä¹ˆé»˜è®¤çš„å®ç°åœ¨æ¦‚å¿µä¸Šä¼šè¢«å¤åˆ¶åˆ°å…·ä½“çš„å®ç°ä¸­ã€‚</p>
<p>é»˜è®¤å®ç°åœ¨æ¦‚å¿µä¸Šè¢«å¤åˆ¶åˆ°æ¯ä¸ªæ²¡æœ‰æ˜ç¡®å®šä¹‰ç›¸åŒæ–¹æ³•çš„ trait impl ä¸­ã€‚ä¾‹å¦‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒBothTraits çš„ impl Base æ²¡æœ‰æä¾›è‡ªå·±çš„ Base::method çš„å®ç°ï¼Œè¿™æ„å‘³ç€ BothTraits çš„ Base çš„å®ç°å°†ä½¿ç”¨è¯¥ trait å®šä¹‰çš„é»˜è®¤è¡Œä¸ºï¼Œå³ print!</p>
<blockquote>
<p>Both traits provide a default implementation of their trait method. Default implementations are conceptually copied into each trait impl that does not explicitly define the same method. In this case for example impl Base for BothTraits does not provide its own implementation of <code>Base::method</code>, which means the implementation of Base for BothTraits will use the default behavior defined by the trait i.e. print!(&quot;1&quot;).</p>
</blockquote>
<p>æ­¤å¤–ï¼ŒDerived å°† Base ä½œä¸ºä¸€ä¸ª supertraitï¼Œè¿™æ„å‘³ç€æ¯ä¸ªå®ç° Derived çš„ç±»å‹ä¹Ÿéƒ½éœ€è¦å®ç° Baseã€‚è¿™ä¸¤ä¸ª trait æ–¹æ³•å°½ç®¡åå­—ç›¸åŒï¼Œä½†å´æ²¡æœ‰å…³ç³» -- å› æ­¤ä»»ä½•å®ç° Derived çš„ç±»å‹éƒ½ä¼šæœ‰ Derived::method å’Œ Base::method çš„å®ç°ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªæ–¹æ³•å¯ä»¥è‡ªç”±åœ°æœ‰ä¸åŒçš„è¡Œä¸ºã€‚Supertraits ä¸æ˜¯ç»§æ‰¿ï¼Supertraits æ˜¯ä¸€ç§ç‰¹å¾çº¦æŸï¼Œå¦‚æœè¦å®ç° Derivedï¼Œé‚£ä¹ˆ Base ä¹Ÿå¿…é¡»è¢«å®ç°ã€‚</p>
<blockquote>
<p>Additionally, Derived has Base as a supertrait which means that every type that implements Derived is also required to implement Base. The two trait methods are unrelated despite having the same name -- thus any type that implements Derived will have an implementation of Derived::method as well as an implementation of <code>Base::method</code> and the two are free to have different behavior. Supertraits are not inheritance! Supertraits are a constraint that if some trait is implemented, some other trait must also be implemented.</p>
</blockquote>
<p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä» main è°ƒç”¨çš„ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“è¿‡ç¨‹ã€‚</p>
<blockquote>
<p>Let's consider what happens in each of the two methods called from main.</p>
</blockquote>
<ul>
<li>
<p><code>dynamic_dispatch(&amp;BothTraits)</code></p>
<p>å‚æ•° x æ˜¯ä¸€ä¸ªå¯¹ç‰¹å¾å¯¹è±¡ <code>dyn Base</code> çš„å¼•ç”¨ã€‚ç‰¹å¾å¯¹è±¡æ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ä¸€ä¸ª &quot;å°å«ç‰‡&quot;ï¼Œå®ƒå…·æœ‰å’Œ Trait ç›¸åŒçš„åç§° (å¦‚ä¸‹æ‰€ç¤º)ï¼Œå¯ä»¥é€šè¿‡å°†æ‰€æœ‰ç‰¹è´¨æ–¹æ³•çš„è°ƒç”¨ï¼Œè½¬å‘åˆ°åŸå§‹ç±»å‹çš„ç‰¹è´¨æ–¹æ³•ã€‚è½¬å‘æ˜¯é€šè¿‡è¯»å–ç‰¹å¾å¯¹è±¡é‡ŒåŒ…å«çš„å‡½æ•°æŒ‡é’ˆè¡¨æ¥å®Œæˆçš„ã€‚</p>
<blockquote>
<p>The argument x is a reference to the trait object type dyn Base. A trait object is a little shim generated by the compiler that implements the trait with the same name by forwarding all trait method calls to trait methods of whatever type the trait object was created from. The forwarding is done by reading from a table of function pointers contained within the trait object.</p>
</blockquote>
<pre><code class="language-rs">// Generated by the compiler.
//
// This is an implementation of the trait `Base` for the
// trait object type `dyn Base`, which you can think of as
// a struct containing function pointers.
impl Base for (dyn Base) {
    fn method(&amp;self) {
        /*
        Some automatically generated implementation detail
        that ends up calling the right type's impl of the
        trait method Base::method.
        */
    }
}
</code></pre>
<p>åœ¨ quiz ä»£ç é‡Œï¼Œ<code>x.method()</code> å®é™…ä¸Šæ˜¯è°ƒç”¨ç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•ï¼Œå®ƒçš„åå­—æ˜¯ <code>&lt;dyn Base as Base&gt;::method</code>ã€‚ç”±äº x æ˜¯é€šè¿‡å°† <code>BothTraits</code> è½¬æ¢ä¸º <code>dyn Base</code> å¾—åˆ°çš„ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„å®ç°å°†è½¬å‘åˆ° <code>&lt;BothTraits as Base&gt;::method</code>ï¼Œæœ€åæ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>In the quiz code, <code>x.method()</code> is a call to this automatically generated method whose fully qualified name is <code>&lt;dyn Base as Base&gt;::method</code>. Since x was obtained by converting a BothTraits to dyn Base, the automatically generated implementation detail will wind up forwarding to <code>&lt;BothTraits as Base&gt;::method</code> which prints 1.</p>
</blockquote>
<p>å¸Œæœ›ä»è¿™ä¸€åˆ‡å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿ä¸ <code>BothTraits</code> å®šä¹‰çš„ <code>Derived::method</code> æœ‰å…³ã€‚ç‰¹åˆ«è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>x.method()</code> ä¸å¯èƒ½æ˜¯å¯¹ <code>Derived::method</code> çš„è°ƒç”¨ï¼Œå› ä¸º x æ˜¯ <code>dyn Base</code> ç±»å‹ï¼Œè€Œ <code>dyn Base</code> å¹¶æ²¡æœ‰ <code>Derived</code> çš„å®ç°ã€‚</p>
<blockquote>
<p>Hopefully it's clear from all of this that nothing here has anything to do with the unrelated trait method Derived::method defined by BothTraits. Especially notice that <code>x.method()</code> cannot be a call to Derived::method because x is of type dyn Base and there is no implementation of Derived for dyn Base.</p>
</blockquote>
</li>
<li>
<p>static_dispatch(BothTraits)</p>
<p>åœ¨ç¼–è¯‘æ—¶æˆ‘ä»¬çŸ¥é“ <code>x.method()</code> æ˜¯å¯¹ <code>&lt;T as Base&gt;::method</code> çš„è°ƒç”¨ã€‚Rust ä¸­å¯¹æ³›å‹å‡½æ•°çš„ç±»å‹æ¨æ–­æ˜¯ç‹¬ç«‹äºæ³›å‹å‡½æ•°çš„ä»»ä½•å…·ä½“å®ä¾‹è€Œå‘ç”Ÿçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æˆ‘ä»¬çŸ¥é“ T å¯èƒ½æ˜¯ä»€ä¹ˆä¹‹å‰ï¼ŒåªçŸ¥é“å®ƒå®ç°äº† Base è¿™ä¸€äº‹å®ã€‚å› æ­¤ï¼Œå…·ä½“ç±»å‹ T ä¸Šçš„ä»»ä½•å›ºæœ‰æ–¹æ³•æˆ–ä»»ä½•å…¶ä»–ç‰¹å¾æ–¹æ³•éƒ½ä¸å¯èƒ½å½±å“ <code>x.method()</code> çš„è°ƒç”¨ã€‚åœ¨å†³å®š T çš„æ—¶å€™ï¼Œå·²ç»ç¡®å®š <code>x.method()</code> ä¼šè°ƒç”¨ <code>&lt;T as Base&gt;::method</code>ã€‚</p>
<blockquote>
<p>At compile time we know that <code>x.method()</code> is a call to <code>&lt;T as Base&gt;::method</code>. Type inference within generic functions in Rust happens independently of any concrete instantiation of the generic function i.e. before we know what T may be, other than the fact that it implements Base. Thus no inherent method on the concrete type T or any other trait method may affect what method <code>x.method()</code> is calling. By the time that T is decided, it has already been determined that <code>x.method()</code> is calling <code>&lt;T as Base&gt;::method</code>.</p>
</blockquote>
<p>æ³›å‹å‡½æ•°åœ¨å®ä¾‹åŒ–æ—¶ï¼ŒT ç­‰äº BothTraitsï¼Œæ‰€ä»¥è¿™å°†ä¼šè°ƒç”¨ <code>&lt;BothTraits as Base&gt;::method</code>ï¼Œæ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>The generic function is instantiated with T equal to BothTraits so this is going to call <code>&lt;BothTraits as Base&gt;::method</code> which prints 1.</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>If you are familiar with C++, the behavior of this code in Rust is different from the behavior of superficially analogous C++ code. In C++ the output would be 22 as seen in the following implementation. This highlights the difference between Rust's traits and supertraits vs C++'s inheritance.</p>
</blockquote>
<p>å¦‚æœä½ ç†Ÿæ‚‰ C++ï¼Œè¿™æ®µä»£ç åœ¨ Rust ä¸­çš„è¡Œä¸ºä¸è¡¨é¢ä¸Šç±»ä¼¼çš„ C++ä»£ç çš„è¡Œä¸ºæ˜¯ä¸åŒçš„ã€‚åœ¨ <code>C++</code> ä¸­ï¼Œè¾“å‡ºå°†æ˜¯ 22ï¼Œæ­£å¦‚åœ¨ä¸‹é¢çš„å®ç°ä¸­çœ‹åˆ°çš„é‚£æ ·ã€‚è¿™çªå‡ºäº† Rust çš„ traits å’Œ supertraits ä¸ C++ çš„ç»§æ‰¿ä¹‹é—´çš„åŒºåˆ«ã€‚</p>
<pre><code class="language-cpp">#include &lt;iostream&gt;

struct Base {
    virtual void method() const {
        std::cout &lt;&lt; &quot;1&quot;;
    }
};

struct Derived: Base {
    void method() const {
        std::cout &lt;&lt; &quot;2&quot;;
    }
};

void dynamic_dispatch(const Base &amp;x) {
    x.method();
}

template &lt;typename T&gt;
void static_dispatch(const T x) {
    x.method();
}

int main() {
    dynamic_dispatch(Derived{});
    static_dispatch(Derived{});
}
</code></pre>
<h2 id="28-_guard--_"><a class="header" href="#28-_guard--_">#28 <code>_guard &amp; _</code></a></h2>
<h3 id="é¢˜ç›®-27"><a class="header" href="#é¢˜ç›®-27">é¢˜ç›®</a></h3>
<pre><code class="language-rs">struct Guard;

impl Drop for Guard {
    fn drop(&amp;mut self) {
        print!(&quot;1&quot;);
    }
}

fn main() {
    let _guard = Guard;
    print!(&quot;3&quot;);
    let _ = Guard;
    print!(&quot;2&quot;);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-27"><a class="header" href="#æç¤º-27">æç¤º</a></h3>
<p>å½“ä¸€ä¸ªå€¼ä¸å†æœ‰æ‰€æœ‰è€…æ—¶ï¼Œå®ƒå°±è¢« drop äº†ã€‚</p>
<blockquote>
<p>A value is dropped when it no longer has an owner.</p>
</blockquote>
<h3 id="é¢˜è§£-26"><a class="header" href="#é¢˜è§£-26">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š3121</p>
<p>è¯¥ç¨‹åºæ‰“å°å‡º 3121ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>let _guard = Guard</code> çš„ <code>Drop</code> åœ¨ main çš„æœ«å°¾è¿è¡Œï¼Œä½†æ˜¯ <code>let _ = Guard</code> çš„ <code>Drop</code> å´ç«‹å³è¿è¡Œã€‚</p>
<blockquote>
<p>The program prints 3121. That is, the Drop impl for let _guard = Guard runs at the end of main but the Drop impl for let _ = Guard runs right away.</p>
</blockquote>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“ä¸€ä¸ªå€¼ä¸å†æœ‰æ‰€æœ‰è€…æ—¶ï¼Œå®ƒå°±ä¼šè¢«æ”¾å¼ƒã€‚å˜é‡ <code>_guard</code> æ‹¥æœ‰ Guard ç±»å‹çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”åœ¨ main ç»“æŸå‰ä¸€ç›´å¤„äºä½œç”¨åŸŸä¸­ã€‚<code>_</code> ä¸æ˜¯ä¸€ä¸ªå˜é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªé€šé…ç¬¦æ¨¡å¼ï¼Œå®ƒæ²¡æœ‰ç»‘å®šä»»ä½•ä¸œè¥¿ï¼›å› ä¸ºè¿™ä¸€è¡Œæ²¡æœ‰ç»‘å®šä»»ä½•å˜é‡ï¼Œæ‰€ä»¥æ²¡æœ‰å˜é‡æˆä¸º Guard ç±»å‹çš„ç¬¬äºŒä¸ªå€¼çš„æ‰€æœ‰è€…ï¼Œè¯¥å€¼åœ¨åŒä¸€è¡Œè¢«ä¸¢å¼ƒã€‚</p>
<blockquote>
<p>In general, a value is dropped when it no longer has an owner. The variable _guard owns the first value of type Guard and remains in scope until the end of main. The _ is not a variable but a wildcard pattern that binds nothing; since no variables are bound on this line, there is no variable to be the owner of the second value of type Guard and that value is dropped on the same line.</p>
</blockquote>
<p>ä¸‹åˆ’çº¿æ¨¡å¼ä¸å¸¦ä¸‹åˆ’çº¿çš„å˜é‡ä¹‹é—´çš„åŒºåˆ«åœ¨æŸäº›æƒ…å†µä¸‹å¾ˆé‡è¦ï¼Œç‰¹åˆ«æ˜¯å½“åœ¨ unsafe ä»£ç ä¸­ä½¿ç”¨é”æ—¶ï¼Œ</p>
<blockquote>
<p>This distinction between the underscore pattern vs variables with a leading underscore is incredibly important to remember when working with lock guards in unsafe code.</p>
</blockquote>
<pre><code class="language-rs">use std::sync::Mutex;

static MUTEX: Mutex&lt;()&gt; = Mutex::new(());

/// MUTEX must be held when accessing this value.
static mut VALUE: usize = 0;

fn main() {
    let _guard = MUTEX.lock().unwrap();
    unsafe {
        VALUE += 1;
    }
}
</code></pre>
<p>å¦‚æœè¿™æ®µä»£ç ä½¿ç”¨ <code>let _ = MUTEX.lock().unwrap()</code>ï¼Œåˆ™ä¼šç«‹å³é‡Šæ”¾äº’æ–¥é”ï¼Œæ— æ³•å¯¹ <code>VALUE</code> çš„è®¿é—®è¿›è¡Œé™åˆ¶ã€‚</p>
<blockquote>
<p>If this code were to use <code>let _ = MUTEX.lock().unwrap()</code> then the mutex guard would be dropped immediately, releasing the mutex and failing to guard the access of VALUE.</p>
</blockquote>
<h2 id="29-t--t"><a class="header" href="#29-t--t">#29 <code>(T) &amp; (T,)</code></a></h2>
<h3 id="é¢˜ç›®-28"><a class="header" href="#é¢˜ç›®-28">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Trait {
    fn p(&amp;self);
}

impl Trait for (u32) {
    fn p(&amp;self) { print!(&quot;1&quot;); }
}

impl Trait for (i32,) {
    fn p(&amp;self) { print!(&quot;2&quot;); }
}

impl Trait for (u32, u32) {
    fn p(&amp;self) { print!(&quot;3&quot;); }
}

impl Trait for (i32, i32,) {
    fn p(&amp;self) { print!(&quot;4&quot;); }
}

fn main() {
    (0).p();
    (0,).p();
    (0, 0).p();
    (0, 0,).p();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-28"><a class="header" href="#æç¤º-28">æç¤º</a></h3>
<p>æ‹¬å·å†…çš„å€¼ä¸åªæœ‰ä¸€ä¸ªå…ƒç´ çš„å…ƒç»„çš„ç±»å‹ä¸ä¸€æ ·ã€‚</p>
<blockquote>
<p>A value in parentheses does not have the same type as a 1-tuple.</p>
</blockquote>
<h3 id="é¢˜è§£-27"><a class="header" href="#é¢˜è§£-27">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1244</p>
<p>åœ¨å•å…ƒç´ å…ƒç»„çš„æƒ…å†µä¸‹ï¼Œå°¾éƒ¨çš„é€—å·æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºå®ƒå¯ä»¥å°†å…¶ä¸ä¸ <code>(0)</code> åŒºåˆ†å¼€æ¥ (<code>(0)</code> å’Œ <code>0</code> ç›¸åŒ)ã€‚ç„¶è€Œï¼Œå¯¹äºæ›´å¤§çš„å…ƒç»„ï¼Œå®ƒæ˜¯å®Œå…¨å¯é€‰çš„ï¼š<code>(i32)</code> ä¸ <code>(i32,)</code> æ˜¯ä¸åŒçš„ç±»å‹ï¼Œä½†æ˜¯ <code>(i32, i32)</code> å’Œ <code>(i32, i32, )</code> æ˜¯ç›¸åŒçš„ã€‚</p>
<blockquote>
<p>The trailing comma is required in the case of a 1-tuple, (0,), because it disambiguates it from (0) which is identical to 0. However, for larger tuples, it is entirely optional: (i32) is a distinct type from (i32,), but (i32, i32) and (i32, i32,) are the same.</p>
</blockquote>
<p>ä¸€ä¸ªæ•´å½¢ 0 å¯ä»¥è¢«æ¨æ–­ä¸ºä»»ä½•æ•´æ•°ç±»å‹ï¼Œä½†å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç±»å‹ä¿¡æ¯ï¼Œåˆ™é»˜è®¤æ¨æ–­ä¸º i32ã€‚<code>(0)</code> è¢«æ¨æ–­ä¸º <code>u32</code>ï¼Œ<code>(0,)</code> è¢«æ¨æ–­ä¸º <code>(i32,)</code>ï¼Œå› ä¸ºå®ƒä»¬åˆ†åˆ«å…·æœ‰å”¯ä¸€çš„ Trait å®ç°ã€‚</p>
<blockquote>
<p>An integral literal 0 can be inferred to be any integer type, but defaults to i32 if insufficient type information is available. (0) is inferred to be a u32 and (0,) is inferred to be a (i32,) because those are respectively the only integral and 1-tuple types with an implementation for Trait.</p>
</blockquote>
<p>ç”±äº <code>(0, 0)</code> å’Œ <code>(0, 0,)</code> å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œå®ƒä»¬çš„ <code>p</code> æ–¹æ³•çš„è¾“å‡ºä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯ Rust éœ€è¦åœ¨ Trait çš„ä¸¤ç§å¯èƒ½çš„å®ç°ä¸­è¿›è¡Œé€‰æ‹©ï¼Œå³ <code>(u32, u32)</code> å’Œ <code>(i32, i32)</code>ã€‚ç”±äº <code>i32</code> æ˜¯é»˜è®¤çš„æ•´å½¢ç±»å‹ï¼Œæ‰€ä»¥åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½ä¼šé€‰æ‹© <code>(i32, i32)</code>ã€‚</p>
<blockquote>
<p>Since (0, 0) and (0, 0,) have the same type, the output of their p methods must be the same, but Rust needs to somehow choose between the two possible implementations of Trait, namely (u32, u32) and (i32, i32). Since i32 is the default integral type, (i32, i32) is chosen in both cases.</p>
</blockquote>
<h2 id="30-clone"><a class="header" href="#30-clone">#30 <code>clone</code></a></h2>
<h3 id="é¢˜ç›®-29"><a class="header" href="#é¢˜ç›®-29">é¢˜ç›®</a></h3>
<pre><code class="language-rs">use std::rc::Rc;

struct A;

fn p&lt;X&gt;(x: X) {
    match std::mem::size_of::&lt;X&gt;() {
        0 =&gt; print!(&quot;0&quot;),
        _ =&gt; print!(&quot;1&quot;),
    }
}

fn main() {
    let a = &amp;A;
    p(a);
    p(a.clone());
    
    let b = &amp;();
    p(b);
    p(b.clone());
    
    let c = Rc::new(());
    p(Rc::clone(&amp;c));
    p(c.clone());
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-29"><a class="header" href="#æç¤º-29">æç¤º</a></h3>
<p>ä¸å¯å˜çš„æŒ‡é’ˆ <code>&amp;T</code> å’Œ <code>Rc&lt;T&gt;</code> å®ç°äº† <code>Clone</code>ï¼Œå³ä½¿ <code>T</code> å¹¶æ²¡æœ‰å®ç°ã€‚</p>
<blockquote>
<p>Immutable pointers <code>&amp;T</code> and <code>Rc&lt;T&gt;</code> implement Clone even if T doesn't.</p>
</blockquote>
<h3 id="é¢˜è§£-28"><a class="header" href="#é¢˜è§£-28">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š111011</p>
<p>è¿™é‡Œå‡ºç°çš„ä¸¤ä¸ªéå¼•ç”¨ç±»å‹ï¼Œ<code>()</code> å’Œ <code>A</code> éƒ½æ˜¯é›¶å¤§å°ç±»å‹ (ZST)ã€‚å¦‚æœä½ å‘å‡½æ•° <code>p&lt;X&gt;</code> ä¼ ä¸€ä¸ª <code>X = ()</code> æˆ–è€… <code>X = A</code>ï¼Œé‚£ä¹ˆä¼šæ‰“å° 0ã€‚å¦‚æœä¼ çš„æ˜¯ <code>X = ï¼†()</code> æˆ–è€… <code>X = &amp;A</code>ï¼Œæ— è®ºæŒ‡é’ˆæœ‰å¤šå¤§ï¼Œæ€»ä¼šæ‰“å° 1ã€‚</p>
<blockquote>
<p>Both of our non-reference types, <code>()</code> and <code>A</code>, are zero-sized types (ZST). The function <code>p&lt;X&gt;</code> will print 0 if it is passed a value of type <code>X = ()</code> or <code>X = A</code>, and it will print 1 if passed a reference <code>X = &amp;()</code> or <code>X = &amp;A</code> regardless of exactly how big pointers happen to be.</p>
</blockquote>
<p><code>p(a)</code> ç”¨ <code>X = &amp;A</code> è°ƒç”¨ pï¼Œå› ä¸ºå‚æ•° a æ˜¯ <code>&amp;A</code> ç±»å‹çš„ï¼›æ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>p(a) invokes p with X = &amp;A because the argument a is of type <code>&amp;A</code>; this prints 1.</p>
</blockquote>
<p>åœ¨ä¸‹ä¸€è¡Œ <code>p(a.clone())</code>ï¼Œå¦‚æœ A å®ç°äº† Cloneï¼Œé‚£ä¹ˆ <code>a.clone()</code> ä¼šè°ƒç”¨å¯¹åº”çš„å®ç°ã€‚ä½†æ˜¯å®ƒæ²¡æœ‰ï¼Œç¼–è¯‘å™¨å‘ç° <code>&amp;T</code> å®ç°äº† Cloneï¼Œæ‰€ä»¥è¿™é‡Œä¼šè°ƒç”¨ <code>&amp;A</code> å®ç°çš„ Cloneï¼Œå®ƒä¼šé€šè¿‡ç®€å•åœ°é‡å¤å¼•ç”¨ï¼Œå°†ä¸€ä¸ª <code>&amp;&amp;A</code> è½¬ä¸º <code>&amp;A</code>ã€‚å¯¹ p çš„è°ƒç”¨ä¸­ï¼Œ<code>X = &amp;A</code>ï¼Œä¹Ÿä¼šæ‰“å° 1ã€‚åœ¨å®è·µä¸­ï¼Œå½“åŒ…å«å¼•ç”¨çš„ç»“æ„æƒ³è¦æ´¾ç”Ÿå‡º Clone æ—¶ï¼ŒClone å¯¹å¼•ç”¨çš„å½±å“æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œä½†æ­£å¦‚è¿™é‡Œæ‰€çœ‹åˆ°çš„ï¼Œå®ƒæœ‰æ—¶ä¼šæ„å¤–åœ°å¯åŠ¨ã€‚</p>
<blockquote>
<p>On the next line, if A implemented Clone then a.clone() would be a call to that impl. But since it doesn't, the compiler finds another applicable impl which is the implementation of Clone for references &amp;T -- so concretely the clone call is calling the impl of Clone for &amp;A which turns a &amp;&amp;A into a &amp;A by simply duplicating the reference. We get another call to p with X = &amp;A printing 1. The impl of Clone for references is useful in practice when a struct containing a reference wants to derive Clone, but as seen here it can sometimes kick in unexpectedly.</p>
</blockquote>
<p>ç±»å‹ <code>()</code> ç¡®å®å®ç°äº† Cloneï¼Œæ‰€ä»¥ <code>b.clone()</code> è°ƒç”¨äº†è¯¥å®ç°ï¼Œäº§ç”Ÿäº† <code>()</code>ã€‚å¯¹ <code>&amp;()</code>çš„ Clone å®ç°ä¹Ÿé€‚ç”¨äº A çš„æƒ…å†µï¼Œä½†æ˜¯ç¼–è¯‘å™¨æ›´å–œæ¬¢è°ƒç”¨ trait impl for ()ï¼Œå°† <code>&amp;()</code> è½¬æ¢ä¸º <code>()</code> ï¼Œè€Œä¸æ˜¯ trait impl for &amp;()ï¼Œå°† <code>&amp;&amp;()</code> è½¬æ¢ä¸º <code>&amp;()</code>ï¼Œå› ä¸ºå‰è€…å¯¹ trait solver æ’å…¥çš„éšå¼å¼•ç”¨æˆ–å–æ¶ˆå¼•ç”¨çš„è¦æ±‚æ›´å°‘ã€‚åœ¨å¯¹ <code>b.clone()</code> çš„è°ƒç”¨ä¸­ï¼Œ<code>b</code> çš„ç±»å‹æ˜¯ <code>&amp;()</code>ï¼Œä¸ <code>impl Clone for ()</code> çš„å‚æ•°å®Œå…¨åŒ¹é…ï¼Œè€Œä¸ºäº†æ‹¿åˆ° <code>&amp;&amp;()</code> ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>impl Clone for &amp;()</code>ï¼Œç‰¹å¾æ±‚è§£å™¨è¿˜éœ€è¦æ’å…¥é¢å¤–çš„éšå¼å¼•ç”¨å±‚ -- æœ‰æ•ˆåœ°è®¡ç®— <code>(&amp;b).clone()</code>ã€‚</p>
<blockquote>
<p>The type () does implement Clone so b.clone() invokes that impl and produces (). The implementation of Clone for &amp;() would also be applicable as happened in the case of A, but the compiler prefers calling the trait impl for () which converts &amp;() to () over the trait impl for &amp;() which converts &amp;&amp;() to &amp;() because the former is the one that requires fewer implicit references or dereferences inserted by the trait solver. In the call to b.clone(), b is of type &amp;() which exactly matches the argument of the impl Clone for (), while in order to obtain a &amp;&amp;() to pass as argument to the impl Clone for &amp;() the trait solver would need to insert an additional layer of referencing implicitly -- effectively computing (&amp;b).clone().</p>
</blockquote>
<p>æˆ‘ä»¬åœ¨è°ƒç”¨ <code>p(b)</code> æ—¶å®é™…ä¼ å…¥çš„ <code>X = ï¼†()</code>ï¼Œè°ƒç”¨ <code>p(b.clone())</code> æ—¶åˆ™æ˜¯ <code>X = ()</code>ã€‚</p>
<blockquote>
<p>What we get is p(b) calling p with X = &amp;() and p(b.clone()) calling p with X = (). Together these print 10.</p>
</blockquote>
<p>æœ€åæ˜¯ Rcï¼Œä¸¤æ¬¡å¯¹ b çš„è°ƒç”¨éƒ½æ˜¯ <code>X = Rc&lt;()&gt;</code>ï¼Œå¤§å°ä¸ä¸ºé›¶ã€‚ä½¿ç”¨ <code>Rc::clone(&amp;c)</code> è€Œä¸æ˜¯ <code>c.clone()</code> æ¥å…‹éš†ä¸€ä¸ª Rc è¢«è®¤ä¸ºæ˜¯ä¹ æƒ¯æ€§çš„ï¼Œå› ä¸º <code>Rc::clone()</code> ä½¿äººæ˜æ˜¾æ„Ÿè§‰åˆ°è¿™æ˜¯ä¸€ä¸ªå¼•ç”¨è®¡æ•°çš„å¢åŠ ï¼Œè€Œä¸æ˜¯å…‹éš†åº•å±‚æ•°æ®ï¼Œä½†æœ€ç»ˆä¸¤è€…æŒ‡çš„æ˜¯åŒä¸€ä¸ªå‡½æ•°ã€‚è¦åœ¨ Rc å†…éƒ¨è°ƒç”¨ä¸€ä¸ªå€¼çš„å…‹éš†ï¼Œä½ éœ€è¦å…ˆå¯¹å®ƒè§£å¼•ç”¨ï¼š<code>(*c).clone()</code>ã€‚</p>
<blockquote>
<p>Finally in the Rc case, both calls to p are with <code>X = Rc&lt;()&gt;</code> which is non-zero sized. It is considered idiomatic to clone a Rc using <code>Rc::clone(&amp;c)</code> instead of <code>c.clone()</code> because it makes it apparent that this is a reference count bump rather than cloning underlying data, but ultimately both refer to the same function. To call the clone method of a value inside a Rc, you would need to dereference it first: <code>(*c).clone()</code>.</p>
</blockquote>
<h2 id="31-method-lookup-order"><a class="header" href="#31-method-lookup-order">#31 <code>method lookup order</code></a></h2>
<h3 id="é¢˜ç›®-30"><a class="header" href="#é¢˜ç›®-30">é¢˜ç›®</a></h3>
<pre><code class="language-rs">trait Or {
    fn f(self);
}

struct T;

impl Or for &amp;T {
    fn f(self) {
        print!(&quot;1&quot;);
    }
}

impl Or for &amp;&amp;&amp;&amp;T {
    fn f(self) {
        print!(&quot;2&quot;);
    }
}

fn main() {
    let t = T;
    let wt = &amp;T;
    let wwt = &amp;&amp;T;
    let wwwt = &amp;&amp;&amp;T;
    let wwwwt = &amp;&amp;&amp;&amp;T;
    let wwwwwt = &amp;&amp;&amp;&amp;&amp;T;
    t.f();
    wt.f();
    wwt.f();
    wwwt.f();
    wwwwt.f();
    wwwwwt.f();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-30"><a class="header" href="#æç¤º-30">æç¤º</a></h3>
<p>åœ¨æ–¹æ³•æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼ŒRust ä¼šè‡ªåŠ¨è§£å¼•ç”¨ï¼Œå¹¶ä»¥æ˜ç¡®çš„é¡ºåºå€Ÿç”¨æ¥æ”¶å™¨ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰åˆé€‚ç­¾åçš„å‡½æ•°ã€‚è¿™ä¸ªé¡ºåºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<blockquote>
<p>During a method lookup, Rust automatically derefences and borrows the receiver in a well-defined order until it finds the first function with a suitable signature. What is that order?</p>
</blockquote>
<h3 id="é¢˜è§£-29"><a class="header" href="#é¢˜è§£-29">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š111222</p>
<p>è¿™ç¯‡ <a href="https://doc.rust-lang.org/reference/expressions/method-call-expr.html">å¼•ç”¨</a> æè¿°äº† Rust çš„æ–¹æ³•æŸ¥æ‰¾é¡ºåºã€‚ç›¸å…³çš„æ®µè½å¦‚ä¸‹ï¼š </p>
<p>è·å¾— [å€™é€‰æ¥æ”¶æ–¹ç±»å‹] çš„æ–¹æ³•æ˜¯ï¼šåå¤è§£å¼•ç”¨æ¥å—è€…è¡¨è¾¾å¼çš„ç±»å‹ï¼Œå°†é‡åˆ°çš„æ¯ä¸ªç±»å‹æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œæœ€åå°è¯•åœ¨æœ€åè¿›è¡Œéå¤§å°èƒè¿«ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™æ·»åŠ ç»“æœç±»å‹ã€‚ç„¶åï¼Œå¯¹äºæ¯ä¸ªå€™é€‰çš„Tï¼Œå°† <code>&amp;T</code> å’Œ <code>&amp;mut T</code> æ·»åŠ åˆ°ç´§è·Ÿ <code>T</code> çš„åˆ—è¡¨ä¸­ã€‚</p>
<blockquote>
<p>The <a href="https://doc.rust-lang.org/reference/expressions/method-call-expr.html">Reference</a> describes Rust's method lookup order. The relevant paragraph is:</p>
</blockquote>
<blockquote>
<p>Obtain [the candidate receiver type] by repeatedly dereferencing the receiver expression's type, adding each type encountered to the list, then finally attempting an unsized coercion at the end, and adding the result type if that is successful. Then, for each candidate T, add &amp;T and &amp;mut T to the list immediately after T.</p>
</blockquote>
<p>æŠŠè¿™äº›è§„åˆ™æ·»åŠ åˆ°æ‰€ç»™çš„ä¾‹å­é‡Œï¼š</p>
<blockquote>
<p>Applying these rules to the given examples, we have:</p>
</blockquote>
<ul>
<li>
<p><code>t.f()</code>: æˆ‘ä»¬è¯•å›¾æ‰¾åˆ°ä¸€ä¸ªå®šä¹‰åœ¨ç±»å‹ <code>T</code> ä¸Šçš„å‡½æ•° fï¼Œä½†æ˜¯æ²¡æœ‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æœç´¢ç±»å‹ <code>&amp;T</code>ï¼Œå¹¶æ‰¾åˆ° <code>Or</code> ç‰¹å¾çš„ç¬¬ä¸€ä¸ªå®ç°ï¼Œç„¶åæˆ‘ä»¬å°±å®Œæˆäº†ã€‚åœ¨è°ƒç”¨æ—¶ï¼Œæ‰¾åˆ°çš„è°ƒç”¨ä¼šæ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>t.f(): We try to find a function f defined on the type T, but there is none. Next, we search the type &amp;T, and find the first implemenation of the Or trait, and we are done. Upon invocation, the resolved call prints 1.</p>
</blockquote>
</li>
<li>
<p><code>wt.f()</code>: æˆ‘ä»¬æœç´¢ä¸€ä¸ªå®šä¹‰åœ¨ <code>&amp;T</code> ä¸Šçš„å‡½æ•° fï¼Œç«‹åˆ»å°±æˆåŠŸäº†ã€‚è°ƒç”¨åï¼Œè¯¥å‡½æ•°æ‰“å°å‡º 1ã€‚</p>
<blockquote>
<p>We search for a function f defined on &amp;T, which immediately succeeds. Upon invocation, the function prints 1.</p>
</blockquote>
</li>
<li>
<p><code>wwt.f()</code>: æœç´¢é¡ºåºæ˜¯ <code>&amp;&amp;T -&gt; &amp;&amp;&amp;T -&gt; &amp;mut &amp;&amp;T -&gt; &amp;T</code>ï¼Œç»“æœæ‰“å° 1ã€‚</p>
<blockquote>
<p>The search order is <code>&amp;&amp;T -&gt; &amp;&amp;&amp;T -&gt; &amp;mut &amp;&amp;T -&gt; &amp;T</code>, and we're done. Upon invocation, the function prints 1.</p>
</blockquote>
</li>
<li>
<p><code>wwwt.f()</code>: <code>&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;T</code> è¿™ä¸ªæ‰“å° 2ã€‚</p>
<blockquote>
<p><code>&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;T</code>. This prints 2.</p>
</blockquote>
</li>
<li>
<p><code>wwwwt.f()</code>: <code>&amp;&amp;&amp;&amp;T</code> è¿™ä¸ªæ‰“å° 2ã€‚ </p>
<blockquote>
<p><code>&amp;&amp;&amp;&amp;T</code>. This prints 2.</p>
</blockquote>
</li>
<li>
<p><code>wwwwwt.f()</code>: <code>&amp;&amp;&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;&amp;&amp;T -&gt; &amp;mut &amp;&amp;&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;T</code> è¿™ä¸ªæ‰“å° 2ã€‚</p>
<blockquote>
<p><code>&amp;&amp;&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;&amp;&amp;T -&gt; &amp;mut &amp;&amp;&amp;&amp;&amp;T -&gt; &amp;&amp;&amp;&amp;T</code>. This prints 2.</p>
</blockquote>
</li>
</ul>
<h2 id="32-march-arm--if-guard"><a class="header" href="#32-march-arm--if-guard">#32 <code>march arm &amp; if guard</code></a></h2>
<h3 id="é¢˜ç›®-31"><a class="header" href="#é¢˜ç›®-31">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn check(x: i32) -&gt; bool {
    print!(&quot;{}&quot;, x);
    false
}

fn main() {
    match (1, 2) {
        (x, _) | (_, x) if check(x) =&gt; {
            print!(&quot;3&quot;)
        }
        _ =&gt; print!(&quot;4&quot;),
    }
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-31"><a class="header" href="#æç¤º-31">æç¤º</a></h3>
<p>æ— è®ºå“ªç§æ–¹å¼ï¼Œåœ¨ä¸åŒçš„æƒ…å†µä¸‹éƒ½ä¼šä»¤äººå›°æƒ‘ï¼›æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ­£ç¡®è¡Œä¸ºï¼Œæç¤ºå¯ä»¥å¸®åŠ©è¯†åˆ«ã€‚çŒœæµ‹ä¸¤è€…éƒ½æ˜¯ã€‚</p>
<blockquote>
<p>Either way would be confusing in different situations; there isn't a clear right behavior that a hint could help identify. Guess both. :/</p>
</blockquote>
<h3 id="é¢˜è§£-30"><a class="header" href="#é¢˜è§£-30">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š124</p>
<p>è¿™ä¸ªé—®é¢˜è¦†ç›–äº† match åˆ†æ”¯å’Œ guards çš„è¡Œä¸ºã€‚</p>
<blockquote>
<p>This question covers two behaviors of match arms and guards.</p>
</blockquote>
<p>é¦–å…ˆï¼ŒåŒ…å« <code>|</code> çš„åŒ¹é…è‡‚ä¸Šçš„ if guard æ˜¯é€‚ç”¨äºåŒ¹é…è‡‚ä¸­çš„æ‰€æœ‰å¤‡é€‰æ–¹æ¡ˆï¼Œè¿˜æ˜¯åªé€‚ç”¨äºå®ƒç›¸é‚»çš„æ–¹æ¡ˆã€‚åœ¨æµ‹éªŒä»£ç ä¸­ï¼Œ<code>check(x)</code> æ˜¯åŒæ—¶å¯¹ <code>(x, _)</code> å’Œ <code>(_, x)</code> æ‰§è¡Œï¼Œè¿˜æ˜¯åªè¦†ç›–äº† <code>(_, x)</code>ï¼Ÿæˆ‘ä»¬å¸Œæœ›åªæœ‰åœ¨å‰è€…çš„æƒ…å†µä¸‹ï¼Œ1 æ‰ä¼šè¢«æ‰“å°å‡ºæ¥ã€‚äº‹å®ä¸Šï¼Œ1 ç¡®å®è¢«æ‰“å°å‡ºæ¥äº†ã€‚ä¸€ä¸ªåŒ¹é…è‡‚æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ª if guardï¼Œè€Œä¸”è¿™ä¸ª guard é€‚ç”¨äºåŒ¹é…è‡‚ä¸­æ‰€æœ‰çš„ç”± <code>|</code> åˆ†éš”çš„å¤‡é€‰æ–¹æ¡ˆã€‚</p>
<blockquote>
<p>First, whether an if guard on a match-arm containing <code>|</code> applies to all alternatives in the match-arm or just to the one it is adjacent to. In the quiz code, does <code>check(x)</code> execute at all for <code>(x, _)</code> or does it only cover the <code>(_, x)</code> case? We would expect 1 would get printed if and only if the former is the case. In fact 1 does get printed. A match-arm gets to have at most one if guard and that guard applies to all the <code>|</code>-separated alternatives in the arm.</p>
</blockquote>
<p>å…¶æ¬¡ï¼Œè¿™ä¸ªé—®é¢˜è¿˜åŒ…æ‹¬åŒ¹é…è‡‚çš„ä¸€ç§ &quot;å›æº¯&quot; è¡Œä¸ºã€‚å½“ <code>check(x)</code> åœ¨ <code>(x, _)</code> ä¸Šè¿”å› false æ—¶ï¼Œæ•´ä¸ªåŒ¹é…è‡‚æ˜¯åœ¨è¿™é‡ŒåŒ¹é…å¤±è´¥ï¼Œè¿˜æ˜¯ Rust ç»§ç»­å‰è¿›åˆ° <code>(_, x)</code> å¹¶ç¬¬äºŒæ¬¡æ‰§è¡Œ guardï¼Ÿæˆ‘ä»¬æœŸæœ›å½“ä¸”ä»…å½“åä¸€ç§æƒ…å†µå‡ºç°æ—¶ 2 ä¼šè¢«æ‰“å°å‡ºæ¥ã€‚äº‹å®ä¸Šï¼Œ2 ç¡®å®è¢«æ‰“å°å‡ºæ¥äº†ï¼›if guard è¢«è¿è¡Œäº†å¤šæ¬¡ï¼Œåœ¨åŒ¹é…è‡‚ä¸­çš„æ¯ä¸€ä¸ª <code>|</code> åˆ†éš”çš„é€‰é¡¹ä¸­éƒ½æœ‰ä¸€æ¬¡ã€‚</p>
<blockquote>
<p>But second, this question also covers a kind of &quot;backtracking&quot; behavior of match-arms. After <code>check(x)</code> returns false on <code>(x, _)</code>, does the whole match-arm fail to match at that point or does Rust move on to <code>(_, x)</code> and execute the guard a second time? We would expect 2 to be printed if and only if the latter is the case. In fact 2 does get printed; the guard is being run multiple times, once per <code>|</code>-separated alternative in the match-arm.</p>
</blockquote>
<h2 id="33-ranges-method"><a class="header" href="#33-ranges-method">#33 <code>Range's method</code></a></h2>
<h3 id="é¢˜ç›®-32"><a class="header" href="#é¢˜ç›®-32">é¢˜ç›®</a></h3>
<pre><code class="language-rs">use std::ops::RangeFull;

trait Trait {
    fn method(&amp;self) -&gt; fn();
}

impl Trait for RangeFull {
    fn method(&amp;self) -&gt; fn() {
        print!(&quot;1&quot;);
        || print!(&quot;3&quot;)
    }
}

impl&lt;F: FnOnce() -&gt; T, T&gt; Trait for F {
    fn method(&amp;self) -&gt; fn() {
        print!(&quot;2&quot;);
        || print!(&quot;4&quot;)
    }
}

fn main() {
    (|| .. .method())();
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-32"><a class="header" href="#æç¤º-32">æç¤º</a></h3>
<p><code>||</code> æ˜¯ä¸€ä¸ªé—­åŒ…ã€‚<code>..</code> æ˜¯ range çš„è¯­æ³•ï¼Œé€šå¸¸ä¼šåœ¨åˆ‡ç‰‡ä¸­çœ‹åˆ°ï¼Œä¾‹å¦‚ <code>&amp;s[1..4]</code> æˆ–è€… <code>&amp;s[..s.len() - 1]</code>ã€‚</p>
<blockquote>
<p><code>||</code> is a closure introducer. <code>..</code> is range syntax, normally seen in slicing operations like <code>&amp;s[1..4]</code> or <code>&amp;s[..s.len() - 1]</code>.</p>
</blockquote>
<h3 id="é¢˜è§£-31"><a class="header" href="#é¢˜è§£-31">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š24</p>
<p>ä¸¤ä¸ªåˆç†çš„å¯èƒ½æ˜¯ 1 æˆ– 24ï¼Œå–å†³äºå¦‚ä½•åŒºåˆ† <code>|| .. .method()</code> çš„ä¼˜å…ˆçº§ã€‚</p>
<blockquote>
<p>The two rational possibilities are 1 or 24, depending on how the precedence of <code>|| .. .method()</code> is disambiguated.</p>
</blockquote>
<p>å¦‚ <code>|| ((..).method())</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œå…¶ä¸»ä½“è°ƒç”¨äº†æˆ‘ä»¬å¯¹ <code>RangeFull</code> çš„å®ç°çš„ Trait æ–¹æ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œmain ä¼šæ‰“å° 1ã€‚å®ƒä¸ä¼šæ‰“å° 13ï¼Œå› ä¸ºä» <code>(..).method()</code> è¿”å›çš„ <code>fn()</code> ä»æœªè¢« main è°ƒç”¨ã€‚</p>
<blockquote>
<p>As <code>|| ((..).method())</code>, which is a closure whose body invokes our impl of Trait on <code>RangeFull</code>. In this case main would print 1. It would not print 13 because the <code>fn()</code> returned from <code>(..).method()</code> is never invoked by main.</p>
</blockquote>
<p>å¦‚ <code>(|| ..).method()</code>ï¼Œå®ƒæ˜¯æˆ‘ä»¬å¯¹ <code>FnOnce()-&gt;T</code> å®ç°çš„ Trait çš„è°ƒç”¨ï¼Œå…¶ä¸­ <code>T</code> è¢«æ¨æ–­ä¸º <code>RangeFull</code>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œmain ä¼šæ‰“å° 24ã€‚</p>
<blockquote>
<p>As <code>(|| ..).method()</code>, which is an invocation of our impl of Trait on <code>FnOnce() -&gt; T</code> where T is inferred to be <code>RangeFull</code>. In this case main would print 24.</p>
</blockquote>
<p>åè€…æ‰æ˜¯æ­£ç¡®çš„ç­”æ¡ˆã€‚</p>
<blockquote>
<p>The latter of those is the correct answer.</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡æ˜¾å¼çš„æ‹¬å·æ¥å®ç°å‰è€…çš„è¡Œä¸ºï¼Œå¦‚ä¸Šæ–‡ä¸­æ‰€ç¤ºã€‚</p>
<blockquote>
<p>We can achieve the former behavior by explicitly parenthesizing as shown in the bullet above.</p>
</blockquote>
<p>åªæœ‰éƒ¨åˆ†æ‹¬å·å¦‚ <code>|| (.. .method())</code> æ˜¯ä¸å¤Ÿçš„ã€‚è¿™ä¼šå¯¼è‡´ä¸€ä¸ªè§£æé”™è¯¯ã€‚</p>
<blockquote>
<p>Partially parenthesizing as <code>|| (.. .method())</code> is not sufficient. This results in a parse error.</p>
</blockquote>
<pre><code class="language-rs">error: expected one of `)` or `,`, found `.`
  --&gt; src/main.rs:22:13
   |
22 |     (|| (.. .method()))();
   |            -^ expected one of `)` or `,`
   |            |
   |            help: missing `,`
</code></pre>
<p>æ­£ç¡®å¤„ç†åƒ <code>|| .. .method()</code> è¿™æ ·ç›¸å½“æ¨¡ç³Šçš„è¡¨è¾¾å¼å¯¹ Rust tooling æ¥è¯´æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œä» Rustfmt (<a href="https://github.com/rust-lang/rustfmt/issues/4808">rust-lang/rustfmt#4808</a>) å’Œ Syn (<a href="https://github.com/dtolnay/syn/issues/1019">dtolnay/syn#1019</a>) çš„ç›¸å…³é”™è¯¯ä¸­å¯ä»¥çœ‹å‡ºã€‚</p>
<blockquote>
<p>Correctly handling a quite ambiguous expression like || .. .method() is a challenge for tooling, as seen by the associated bugs in Rustfmt (<a href="https://github.com/rust-lang/rustfmt/issues/4808">rust-lang/rustfmt#4808</a>) and Syn (<a href="https://github.com/dtolnay/syn/issues/1019">dtolnay/syn#1019</a>).</p>
</blockquote>
<h2 id="34-size-of-fn"><a class="header" href="#34-size-of-fn">#34 <code>size of fn</code></a></h2>
<h3 id="é¢˜ç›®-33"><a class="header" href="#é¢˜ç›®-33">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn d&lt;T&gt;(_f: T) {
    match std::mem::size_of::&lt;T&gt;() {
        0 =&gt; print!(&quot;0&quot;),
        1 =&gt; print!(&quot;1&quot;),
        _ =&gt; print!(&quot;2&quot;),
    }
}

fn a&lt;T&gt;(f: fn(T)) {
    d(f);
}

fn main() {
    a(a::&lt;u8&gt;);
    d(a::&lt;u8&gt;);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-33"><a class="header" href="#æç¤º-33">æç¤º</a></h3>
<p>ç”¨ä»»ä½•å…¶ä»–æ•´æ•°ç±»å‹ä»£æ›¿ u8ï¼Œç­”æ¡ˆéƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>
<blockquote>
<p>The answer would be the same with any other integer type in place of u8.</p>
</blockquote>
<h3 id="é¢˜è§£-32"><a class="header" href="#é¢˜è§£-32">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š20</p>
<p>è¡¨è¾¾å¼ <code>a::&lt;u8&gt;</code> çš„ç±»å‹æ˜¯ä¸€ä¸ªé›¶å¤§å°ç±»å‹ï¼ˆZSTï¼‰ã€‚</p>
<blockquote>
<p>The expression <code>a::&lt;u8&gt;</code>'s type is a zero-sized type (ZST).</p>
</blockquote>
<p>Rust å›´ç»•å‡½æ•°ç±»å‹çš„ä½œå‡ºçš„é€‰æ‹©å’Œå…·ä½“å®ç°ä¸å‡ ä¹æ‰€æœ‰å…¶ä»–è¯­è¨€éƒ½ä¸åŒï¼Œä½†å®ƒæ˜¯ Rust è®¸å¤šé›¶å¼€é”€æŠ½è±¡çš„é‡è¦ä¿ƒæˆå› ç´ ã€‚åœ¨ Rust ä¸­ï¼Œæ¯ä¸ªå‡½æ•°ï¼ˆæˆ–æ³›å‹å‡½æ•°çš„æ¯ä¸ªä¸åŒå®ä¾‹ï¼‰éƒ½æœ‰è‡ªå·±çš„ç‹¬ç‰¹ç±»å‹ã€‚ç‰¹åˆ«æ˜¯ï¼Œå³ä½¿æ˜¯å…·æœ‰ç›¸åŒå‡½æ•°ç­¾åçš„ä¸¤ä¸ªå‡½æ•°ä¹Ÿä¼šæœ‰ä¸åŒçš„ç±»å‹ã€‚</p>
<blockquote>
<p>Rust's implementation choices around function types are different from nearly all other languages, but are an important enabler of many of Rust's zero-overhead abstractions. In Rust, every function (or every distinct instantiation of a generic function) has its own unique type. In particular, even two functions with the same function signature would have different types.</p>
</blockquote>
<p>æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„ç±»å‹ï¼Œè¿™ç§ç‰¹æ€§å…è®¸ç±»å‹æœ¬èº«æºå¸¦å°†è¢«è°ƒç”¨çš„å‡½æ•°çš„ä¿¡æ¯ï¼Œä¸éœ€è¦ä»»ä½•è¿è¡Œæ—¶çŠ¶æ€ï¼Œå¦‚æŒ‡é’ˆã€‚</p>
<blockquote>
<p>Having a unique type for each function allows the type itself to carry the information of what function will be called, not needing any runtime state such as a pointer.</p>
</blockquote>
<p>ä¸ºäº†ç†è§£è¿™ç§ä¼˜åŒ–æ–¹æ³•çš„ä¼˜åŠ¿ï¼Œè€ƒè™‘ <code>Iterator::map</code> å’Œä¸¤ä¸ªè°ƒç”¨ <code>iter.map(f)</code> å’Œ <code>iter.map(g)</code>ï¼Œå…¶ä¸­ <code>f</code> å’Œ <code>g</code> æ˜¯å…·æœ‰ç›¸åŒç­¾åçš„ä¸åŒå‡½æ•°ã€‚å› ä¸º <code>f</code> å’Œ <code>g</code> æœ‰ä¸åŒçš„ç±»å‹ï¼Œè¿™ä¸¤ä¸ª map è°ƒç”¨ä¼šäº§ç”Ÿä¸¤ä¸ªä¸åŒçš„æ³›å‹å‡½æ•°çš„å•æ€å®ä¾‹ï¼Œå…¶ä¸­ä¸€ä¸ªé™æ€åœ°è°ƒç”¨ <code>f</code>ï¼Œå¦ä¸€ä¸ªé™æ€åœ°è°ƒç”¨ <code>g</code>ï¼Œå°±åƒä½ ç›´æ¥ä¸ºæ¯ä¸ªå‡½æ•°å†™äº†ä¸€ä¸ªç‰¹æ®Šçš„ map å®ç°ï¼Œè€Œæ²¡æœ‰ map æä¾›çš„æŠ½è±¡ã€‚å› æ­¤ï¼Œæ³›å‹ map æ˜¯ä¸€ä¸ªé›¶æˆæœ¬çš„æŠ½è±¡ã€‚ä¼ ç»Ÿä¸Šï¼Œåœ¨å…¶ä»–è¯­è¨€å¦‚ C++ æˆ– Go ä¸­ï¼Œf å’Œ g ä¼šè¢«ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆä¼ é€’ç»™ mapï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ª map çš„å®ä¾‹ï¼ŒåŒ…å«ä¸€ä¸ªæ‰§è¡Œå‡½æ•°è°ƒç”¨çš„åŠ¨æ€åˆ†å‘ï¼Œè¿™é€šå¸¸ä¼šæ¯”é™æ€è°ƒç”¨å‡½æ•°æ›´æ…¢ã€‚è¿™ç§æ€§èƒ½ç¼ºé™·ä½¿å¾—è¿™äº›è¯­è¨€ä¸­çš„ map ä¸æ˜¯ä¸€ä¸ªé›¶æˆæœ¬çš„æŠ½è±¡ã€‚</p>
<blockquote>
<p>To understand the optimization advantages of this approach, consider <code>Iterator::map</code> and the two calls <code>iter.map(f)</code> and iter.map(g) where f and g are different functions with the same signature. Because f and g have distinct types, the two map calls would produce two different monomorphic instantiations of the generic map function, one of which statically calls f and the other statically calls g, as if you had directly written a special-purpose map implementation specific to each function without the abstraction provided by map. The generic map is thus a zero-overhead abstraction. Traditionally in other languages such as C++ or Go, in this situation f and g would be passed to map as a function pointer and there would be just one instantiation of map, containing a dynamic dispatch to execute the function call, which is usually going to be slower than statically calling the right function. This performance penalty makes map in those languages not a zero-overhead abstraction.</p>
</blockquote>
<p>ç›®å‰åœ¨ Rust ä¸­ï¼Œæ²¡æœ‰è¯­æ³•æ¥è¡¨è¾¾ç‰¹å®šçš„å‡½æ•°ç±»å‹ï¼Œæ‰€ä»¥å®ƒä»¬æ€»æ˜¯ä½œä¸ºä¸€ä¸ªé€šç”¨çš„ç±»å‹å‚æ•°ä¸ <code>FnOnce</code>ã€<code>Fn</code> æˆ– <code>FnMut</code> ç»‘å®šä¼ é€’ã€‚åœ¨é”™è¯¯ä¿¡æ¯ä¸­ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°å‡½æ•°ç±»å‹ä»¥ <code>fn(T) -&gt; U {fn_name}</code> çš„å½¢å¼å‡ºç°ï¼Œä½†ä½ ä¸èƒ½åœ¨ä»£ç ä¸­ä½¿ç”¨è¿™ç§è¯­æ³•ã€‚</p>
<blockquote>
<p>Currently in Rust there is no syntax to express the type of a specific function, so they are always passed as a generic type parameter with a FnOnce, Fn or FnMut bound. In error messages you might see function types appear in the form fn(T) -&gt; U {fn_name}, but you can't use this syntax in code.</p>
</blockquote>
<p>å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œ<code>fn(T) -&gt; U</code>ï¼Œåœ¨è¿è¡Œæ—¶æ˜¯æŒ‡é’ˆå¤§å°ã€‚å‡½æ•°ç±»å‹å¯ä»¥è¢«èƒè¿«ä¸ºå‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸€ç‚¹åœ¨ä½ éœ€è¦å°† &quot;é€‰æ‹©è°ƒç”¨é‚£ä¸ªå‡½æ•°&quot; æ¨è¿Ÿåˆ°è¿è¡Œæ—¶å¾ˆæœ‰ç”¨ã€‚</p>
<blockquote>
<p>On the other hand, a function pointer, fn(T) -&gt; U, is pointer-sized at runtime. Function types can be coerced into function pointers, which can be useful in case you need to defer the choice of function to call until runtime.</p>
</blockquote>
<p>åœ¨æµ‹éªŒä»£ç ä¸­ï¼Œmain ä¸­çš„ç¬¬ä¸€ä¸ªè°ƒç”¨åœ¨è°ƒç”¨ d ä¹‹å‰å°† <code>a::&lt;u8&gt;</code> ä»ä¸€ä¸ªå‡½æ•°èƒè¿«ä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ<code>(fn(fn(u8)) {a::&lt;u8&gt;}</code> åˆ° <code>fn(fn(u8)))</code>ï¼Œå› æ­¤åœ¨ä¸€ä¸ªå…·æœ‰ 64 ä½å‡½æ•°æŒ‡é’ˆçš„ç³»ç»Ÿä¸­ï¼Œå®ƒçš„å¤§å°ä¸º 8ã€‚main ä¸­çš„ç¬¬äºŒä¸ªè°ƒç”¨ä¸æ¶‰åŠå‡½æ•°æŒ‡é’ˆï¼›d è¢«ç›´æ¥è°ƒç”¨ï¼ŒT æ˜¯ <code>a::&lt;u8&gt;</code> çš„ä¸å¯è¡¨è¾¾çš„ç±»å‹ï¼Œå®ƒçš„å¤§å°ä¸ºé›¶ã€‚</p>
<blockquote>
<p>In the quiz code, the first call in main coerces <code>a::&lt;u8&gt;</code> from a function to a function pointer <code>(fn(fn(u8)) {a::&lt;u8&gt;}</code> to <code>fn(fn(u8)))</code> prior to calling d, so its size would be 8 on a system with 64-bit function pointers. The second call in main does not involve function pointers; d is directly called with T being the inexpressible type of <code>a::&lt;u8&gt;</code>, which is zero-sized.</p>
</blockquote>
<h2 id="35-hygiene-2"><a class="header" href="#35-hygiene-2">#35 <code>Hygiene 2</code></a></h2>
<h3 id="é¢˜ç›®-34"><a class="header" href="#é¢˜ç›®-34">é¢˜ç›®</a></h3>
<pre><code class="language-rs">macro_rules! x {
    ($n:expr) =&gt; {
        let a = X($n);
    };
}

struct X(u64);

impl Drop for X {
    fn drop(&amp;mut self) {
        print!(&quot;{}&quot;, self.0);
    }
}

fn main() {
    let a = X(1);
    x!(2);
    print!(&quot;{}&quot;, a.0);
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-34"><a class="header" href="#æç¤º-34">æç¤º</a></h3>
<p>æœ‰ä¸€äº›ç¨‹åºï¼Œcargo expand äº§ç”Ÿçš„å±•å¼€åçš„ä»£ç å¯ä»¥ç¼–è¯‘ï¼Œä½†å…¶è¡Œä¸ºä¸åŸå§‹ä»£æ€§ç çš„åŸå§‹å®å«ç”Ÿä¸åŒã€‚</p>
<blockquote>
<p>There are some programs for which cargo expand produces expanded code that compiles, but behaves differently than the original code with the original macro hygiene.</p>
</blockquote>
<h3 id="é¢˜è§£-33"><a class="header" href="#é¢˜è§£-33">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š121</p>
<p>æ ¹æ®ä½ å¯¹ macro å±•å¼€çš„å‡è®¾ï¼Œæœ¬é¢˜æœ‰ä¸¤æ¡çœ‹ä¼¼åˆç†çš„é”™è¯¯ç­”æ¡ˆï¼š</p>
<blockquote>
<p>There are two reasonable paths to an incorrect answer on this question, based on your assumptions around how this macro gets expanded:</p>
</blockquote>
<pre><code class="language-rs">1. let a = X(2);
2. { let a = X(2); }
</code></pre>
<p>å¦‚æœç¬¬ä¸€ç§å±•å¼€æ–¹å¼æ˜¯æ­£ç¡®çš„ï¼Œè¿™ä¸ªå®ä¼šå¼•å…¥ä¸€ä¸ªæ–°çš„ç»‘å®šï¼Œaï¼Œå®ƒå°†é®è”½ main ä¸­å·²ç»ç›´æ¥åˆ†é…çš„ aã€‚å› æ­¤ï¼Œmain ä¸­çš„ print è¯­å¥å°†é¦–å…ˆæ‰§è¡Œï¼Œæ‰“å° 2ï¼Œç„¶åå˜é‡å°†æŒ‰å¼•å…¥çš„é¡ºåºå€’åº dropï¼Œå…ˆæ‰“å° 2ï¼Œå†æ‰“å° 1ï¼Œæœ€åè¾“å‡º 221ã€‚</p>
<blockquote>
<p>If the first expansion were right, the macro would introduce a new binding, a, which shadows the a already directly assigned in main. So the print statement in main would execute first, printing 2, then the variables would drop in reverse order of introduction, printing 2 then 1, with a final output of 221.</p>
</blockquote>
<p>å¦‚æœç¬¬äºŒç§å±•å¼€æ–¹å¼æ˜¯æ­£ç¡®çš„ï¼Œè¿™ä¸ªå®ä¼šåœ¨ä¸€ä¸ªåµŒå¥—çš„ä½œç”¨åŸŸä¸­å¼•å…¥ aï¼Œåªåœ¨è¿™ä¸ªä½œç”¨åŸŸä¸­é®è”½å·²ç»å­˜åœ¨çš„ aï¼Œè€Œä¸æ˜¯åœ¨å®ƒä¹‹å¤–ã€‚ç”±äºæ–°çš„ a çš„ä½œç”¨åŸŸåœ¨æ‰“å°è¯­å¥ä¹‹å‰å°±ç»“æŸäº†ï¼Œæ‰€ä»¥å½“å®ƒè¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œå®ƒçš„ Drop impl å°†æ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„æ‰“å°ï¼Œæ‰“å° 2ã€‚æ¥ä¸‹æ¥ï¼Œmain ä¸­çš„æ‰“å°å°†æ‰“å° 1ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª a çš„å€¼ï¼Œæœ€åï¼Œå½“è¿™ä¸ªå€¼åœ¨ main ç»“æŸæ—¶ï¼Œå†æ‰“å° 1ï¼Œæœ€ç»ˆè¾“å‡º 211ã€‚</p>
<blockquote>
<p>If the second expansion were right, the macro would introduce a in a nested scope, shadowing the already existing a only inside of that scope and not beyond it. Since the new a's scope ends before the print statement, its Drop impl when going out of scope would be the first print to execute, printing 2. Next the print in main would print 1 which is the value of the first a, and finally 1 again when that value drops at the end of main, with final output 211.</p>
</blockquote>
<p>å¦‚æœä½ è¯»è¿‡å…³äºå®å«ç”Ÿæ€§çš„æ–‡ç« ï¼Œé‚£ä¹ˆä½ å¯èƒ½å·²ç»çŒœåˆ°å®ƒçš„å®ç°æ–¹å¼ä¸ç¬¬äºŒä¸ªé€‰é¡¹ç±»ä¼¼ã€‚é‡è¦çš„æ˜¯ï¼Œå®çš„å†…éƒ¨ç»“æ„ä¸ä¼šä¸è°ƒç”¨åœ°ç‚¹èŒƒå›´å†…çš„å˜é‡å‘ç”Ÿå†²çªï¼Œè€Œä¸” Rust å®åœ¨é˜²æ­¢æ„å¤–çš„åç§°å†²çªæ–¹é¢åšå¾—å¾ˆå¥½ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸æ˜¯å«ç”Ÿæ€§çš„å®ç°æ–¹å¼ï¼›åœ¨å®æ‰©å±•å‘¨å›´å¼•å…¥äººä¸ºçš„ä½œç”¨åŸŸä¼šä½¿å®ƒä»¬çš„ä½œç”¨æ›´åŠ æœ‰é™ï¼Œè€Œä¸”ä¸ä¼šè§£å†³å¾ˆå¤šå…¶ä»–çš„å«ç”Ÿæ€§é—®é¢˜ã€‚</p>
<blockquote>
<p>If you've read about macro hygiene then you might have guessed it would be implemented something like this second option. It's important that internals of a macro don't interfere coincidentally with variables in scope at the call site, and Rust macros mostly do a good job of preventing unintended name collisions. However, this is not how hygiene is implemented; introducing artificial scopes around macro expansions would make them more limited in their usefulness, and wouldn't solve a lot of other hygiene problems.</p>
</blockquote>
<p>ä½ å¯ä»¥æŠŠ lazily calcalute æƒ³è±¡æˆç»™æ¯ä¸ªæåˆ°çš„å±€éƒ¨å˜é‡çš„åå­—åˆ†é…ä¸€ä¸ªé¢œè‰²ï¼Œå…è®¸åœ¨ä½œç”¨åŸŸå†…æœ‰å¤šä¸ªå¯åŒºåˆ†çš„å±€éƒ¨å˜é‡åŒæ—¶æ‹¥æœ‰ç›¸åŒçš„æ–‡æœ¬åç§°ã€‚</p>
<blockquote>
<p>You can instead imagine hygiene as a way of assigning a color to each mention of the name of a local variable, allowing for there to be multiple distinguishable local variables in scope simultaneously with the same textual name.</p>
</blockquote>
<pre><code class="language-rs">fn main() {
    let a = X(1);
    let a = X(2);
    print!(&quot;{}&quot;, a.0);
}
</code></pre>
<p>æ‰€ä»¥æ‰“å°å‡ºæ¥çš„æ˜¯ main çš„æ ‡è¯†ç¬¦ a çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ 1ï¼Œç„¶åä¸¤ä¸ªå€¼æŒ‰ç…§å¼•å…¥çš„ç›¸åé¡ºåºä¸¢æ‰ï¼Œå…ˆæ‰“å° 2 å†æ‰“å° 1ï¼Œç¨‹åºçš„è¾“å‡ºæ˜¯ 121ã€‚</p>
<blockquote>
<p>So what's printed is the value of main's identifier a which is 1, then the two values are dropped in reverse order of introduction printing 2 then 1, and the output of the program is 121.</p>
</blockquote>
<h2 id="36-move--fn"><a class="header" href="#36-move--fn">ï¼ƒ36 <code>move &amp; Fn</code></a></h2>
<h3 id="é¢˜ç›®-35"><a class="header" href="#é¢˜ç›®-35">é¢˜ç›®</a></h3>
<pre><code class="language-rs">fn call(mut f: impl FnMut() + Copy) {
    f();
}

fn g(mut f: impl FnMut() + Copy) {
    f();
    call(f);
    f();
    call(f);
}

fn main() {
    let mut i = 0i32;
    g(move || {
        i += 1;
        print!(&quot;{}&quot;, i);
    });
}
</code></pre>
<ol>
<li>æœªå®šä¹‰çš„è¡Œä¸º</li>
<li>ç¼–è¯‘å¤±è´¥</li>
<li>ç¨‹åºç¡®å®šä¼šè¾“å‡ºï¼š[ ]</li>
</ol>
<h3 id="æç¤º-35"><a class="header" href="#æç¤º-35">æç¤º</a></h3>
<p>å˜é‡ <code>i</code> è¢«ç¼–è¯‘å™¨ç”Ÿæˆçš„é—­åŒ…å¯¹è±¡æ‰€æ•è·ã€‚</p>
<blockquote>
<p>The variable <code>i</code> is captured by value in the compiler-generated closure object.</p>
</blockquote>
<h3 id="é¢˜è§£-34"><a class="header" href="#é¢˜è§£-34">é¢˜è§£</a></h3>
<p>ç­”æ¡ˆï¼š1223</p>
<p>ä¼ å…¥ g çš„å¯¹è±¡æ˜¯ä¸€ä¸ª <code>FnMut</code> é—­åŒ…ï¼Œå®ƒæ•è·äº†ä¸€ä¸ªæ•´æ•°ã€‚å®é™…ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯å‘½åçš„ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ªç±»å‹ä¸º i32 çš„å­—æ®µï¼Œå¹¶æœ‰ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ“ä½œç¬¦ï¼Œè¯¥æ“ä½œç¬¦æ¥æ”¶ <code>&amp;mut self</code>ã€‚</p>
<blockquote>
<p>The object passed into g is a FnMut closure which captures an integer by value. Effectively it's an unnameable struct containing a single field whose type is i32, with a function call operator that takes &amp;mut self:</p>
</blockquote>
<pre><code class="language-rs">#[derive(Copy, Clone)]
pub struct UnnameableClosure {
    i: i32,
}

impl UnnameableClosure {
    pub fn unnameable_call_operator(&amp;mut self) {
        self.i += 1;
        print!(&quot;{}&quot;, self.i);
    }
}

let mut i = 0i32;
g(UnnameableClosure { i });
</code></pre>
<p>g é‡Œé¢çš„ 4 ä¸ªè°ƒç”¨çš„è¡Œä¸ºå¦‚ä¸‹ã€‚</p>
<blockquote>
<p>The behavior of the 4 calls inside g is as follows:</p>
</blockquote>
<ul>
<li>
<p><code>f()</code> è¿è¡Œé—­åŒ…ï¼Œå…¶é€šè¿‡å€¼æ•è·çš„ <code>i</code> çš„å€¼å˜ä¸º 1ã€‚</p>
<blockquote>
<p>f() runs the closure and its by-value captured value of i becomes 1.</p>
</blockquote>
</li>
<li>
<p><code>call(f)</code> åˆ¶é€ ä¸€ä¸ª <code>f</code> çš„å‰¯æœ¬ï¼Œä½œä¸º call çš„å‚æ•°ã€‚è¿™ä¸ªå‰¯æœ¬è¢«æ‰§è¡Œï¼Œå®ƒçš„ <code>i</code> å˜æˆäº† 2ï¼Œä½†æ˜¯åŸå§‹é—­åŒ…ä»ç„¶ä¿æŒç€å®ƒæ•è·çš„ <code>i</code> çš„å€¼ä¸º 1ã€‚<code>f</code> çš„å‰¯æœ¬åœ¨è°ƒç”¨ä¸»ä½“çš„æœ«å°¾è¶…å‡ºäº†ä½œç”¨åŸŸè¢« dropã€‚</p>
<blockquote>
<p>call(f) makes a copy of f to become the argument of call. The copy gets executed and its i becomes 2, but the original closure still holds a value of 1 for its captured i. The copy of the closure gets dropped as it goes out of scope at the end of the body of call.</p>
</blockquote>
</li>
<li>
<p><code>f()</code> ç¬¬äºŒæ¬¡è¿è¡ŒåŸå§‹é—­åŒ…ï¼Œå…¶ i å˜ä¸º 2ã€‚</p>
<blockquote>
<p>f() runs the original closure a second time and its i becomes 2.</p>
</blockquote>
</li>
<li>
<p><code>call(f)</code> ç¬¬äºŒæ¬¡å¤åˆ¶ f å¹¶æ‰§è¡Œå‰¯æœ¬ï¼Œå®ƒçš„ i å˜æˆäº† 3ã€‚</p>
<blockquote>
<p>call(f) copies f a second time and executes the copy, its i becomes 3.</p>
</blockquote>
</li>
</ul>
<p>ä» Rust 1.26 å¼€å§‹ï¼Œå¦‚æœé—­åŒ…çš„æ‰€æœ‰æ•è·éƒ½å®ç°äº† Cloneï¼Œåˆ™é—­åŒ…è‡ªåŠ¨å®ç°äº† Cloneï¼›å¦‚æœæ‰€æœ‰æ•è·éƒ½å®ç°äº† Copyï¼Œåˆ™é—­åŒ…è‡ªåŠ¨å®ç°äº† Copyã€‚</p>
<blockquote>
<p>Since Rust 1.26, closures automatically implement Clone if all their captures implement Clone, and Copy if all the captures implement Copy.</p>
</blockquote>
<p>å¦‚æœ quiz ä»£ç ä¸­çœç•¥äº† move å…³é”®å­—ï¼Œç¼–è¯‘å™¨ç”Ÿæˆçš„é—­åŒ…å°†é€šè¿‡å¯å˜å¼•ç”¨è€Œä¸æ˜¯é€šè¿‡å€¼æ•è· iã€‚</p>
<blockquote>
<p>If the move keyword were omitted from the quiz code, the compiler-generated closure would capture i by mutable reference instead of by value:</p>
</blockquote>
<pre><code class="language-rs">pub struct UnnameableClosure&lt;'a&gt; {
    i: &amp;'a mut i32,
}
</code></pre>
<p>å¹¶ä¸”ä¸å†æœ‰ Copy implï¼Œå› ä¸ºå°†ä¸€ä¸ªå¯å˜å¼•ç”¨å¤åˆ¶æˆå¤šä¸ªå‰¯æœ¬æ˜¯ä¸æ­£ç¡®çš„ï¼ˆaliasing xor mutationï¼›è¿™æ˜¯å€Ÿç”¨æ£€æŸ¥å™¨çš„é‡ç‚¹ï¼‰ã€‚</p>
<blockquote>
<p>and there would no longer be a Copy impl, because it's incorrect to duplicate a mutable reference into multiple copies (aliasing xor mutation; this is the point of the borrow checker).</p>
</blockquote>
<p>å¯¹äº Rust çš„åˆå­¦è€…æ¥è¯´ï¼Œä¸€ä¸ªç»å¸¸å‡ºç°çš„å›°æƒ‘æ˜¯ move, non-move é—­åŒ…ä¸ Fnã€FnMut å’Œ FnOnce é—­åŒ…ä¹‹é—´çš„å…³ç³»ã€‚è¿™æ˜¯ä¸¤ä¸ªå‡ ä¹å®Œå…¨ä¸åŒçš„ä¸œè¥¿ã€‚æ­£å¦‚ä¸Šé¢çš„ <code>UnnameableClosure</code> ä¼ªä»£ç æ‰€ç¤ºï¼Œmove ä¸ non-move æ˜¯æŒ‡ç¼–è¯‘å™¨ç”Ÿæˆçš„é—­åŒ…ç»“æ„çš„å­—æ®µæ˜¯å¦ä¸åŸå§‹è¢«æ•è·å˜é‡çš„ç±»å‹ç›¸åŒï¼Œæˆ–è€…æ˜¯å¯¹åŸå§‹æ•è·å˜é‡ç±»å‹çš„å¼•ç”¨ï¼ˆä¾‹å¦‚ï¼Œ<code>i32</code> ä¸ <code>&amp;mut i32</code>ï¼‰ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>Fn</code> vs <code>FnMut</code> vs <code>FnOnce</code> æ˜¯å…³äºç¼–è¯‘å™¨ç”Ÿæˆçš„é—­åŒ…ç»“æ„çš„è°ƒç”¨æ–¹æ³•æ˜¯å¦æœ‰ä¸€ä¸ªæ¥æ”¶å™¨ï¼Œè¯¥æ¥æ”¶å™¨æ˜¯ <code>&amp;self</code> vs <code>&amp;mut self</code> vs <code>self</code>ã€‚</p>
<blockquote>
<p>One recurring source of confusion for Rust beginners is the relationship between move and non-move closures vs Fn and FnMut and FnOnce closures. These are two nearly-orthogonal things. As illustrated in the UnnameableClosure pseudocode above, move vs non-move is about whether the fields of the compiler-generated closure struct have the same type as the original captured variable's type, vs are references to the original captured variable's type (i32 vs &amp;mut i32, for example). In contrast, Fn vs FnMut vs FnOnce is about whether the call method of the compiler-generated closure struct has a receiver which is &amp;self vs &amp;mut self vs self.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><hr />
<h2>sidebar_position: 1
sidebar_label: Rust è¯­è¨€
sidebar_class_name: green</h2>
<h1 id="rust-è¯­è¨€"><a class="header" href="#rust-è¯­è¨€">Rust è¯­è¨€</a></h1>
<h2 id="1-ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#1-ç”Ÿå‘½å‘¨æœŸ">1. ç”Ÿå‘½å‘¨æœŸ</a></h2>
<h3 id="è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ"><a class="header" href="#è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ">è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Only one reference in input, so the output must be derived from that input
fn foo(&amp;A) -&gt; &amp;B; // sugar for:
fn foo&lt;'a&gt;(&amp;'a A) -&gt; &amp;'a B;

// Many inputs, assume they're all independent
fn foo(&amp;A, &amp;B, &amp;C); // sugar for:
fn foo&lt;'a, 'b, 'c&gt;(&amp;'a A, &amp;'b B, &amp;'c C);

// Methods, assume all output lifetimes are derived from `self`
fn foo(&amp;self, &amp;B, &amp;C) -&gt; &amp;D; // sugar for:
fn foo&lt;'a, 'b, 'c&gt;(&amp;'a self, &amp;'b B, &amp;'c C) -&gt; &amp;'a D;
<span class="boring">}
</span></code></pre></pre>
<h2 id="2-æ™ºèƒ½æŒ‡é’ˆ"><a class="header" href="#2-æ™ºèƒ½æŒ‡é’ˆ">2. æ™ºèƒ½æŒ‡é’ˆ</a></h2>
<h3 id="åŸºæœ¬æ¦‚å¿µ"><a class="header" href="#åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a></h3>
<p>å®ç°äº† Deref Trait å’Œ Drop Trait çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆ</p>
<ol>
<li>Deref Trait: å…·æœ‰æŒ‡é’ˆè¯­ä¹‰</li>
<li>Drop Traitï¼šæ‹¥æœ‰å†…å­˜è‡ªåŠ¨ç®¡ç†çš„æœºåˆ¶</li>
</ol>
<p>çœ‹ä¸€çœ¼ Box çš„å®ç°</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
impl&lt;T: ?Sized, A: Allocator&gt; Deref for Box&lt;T, A&gt; {
    type Target = T;

    fn deref(&amp;self) -&gt; &amp;T {
        &amp;**self
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="ç®€å•å®ç°"><a class="header" href="#ç®€å•å®ç°">ç®€å•å®ç°</a></h3>
<p>æˆ‘ä»¬å®ç°ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ˆåªå®ç°äº† Deref Traitï¼‰</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::ops::Deref;

pub struct MySmartPointer&lt;T&gt; (T);

impl&lt;T&gt; MySmartPointer&lt;T&gt; {
    pub fn new(t: T) -&gt; Self {
        MySmartPointer(t)
    }
}

impl&lt;T&gt; Deref for MySmartPointer&lt;T&gt; {
    type Target = T;
    fn deref(&amp;self) -&gt; &amp;Self::Target {
        &amp;self.0
    }
}
// è°ƒç”¨*x å…¶å®å°±æ˜¯è°ƒç”¨ *x.deref()
let x = 5;
let a = MySmartPointer::new(x);
let b = Box::new(x);
assert_eq!(x, *a.deref());
assert_eq!(x, *a);
assert_eq!(x, *b.deref());
assert_eq!(x, *b);
print!(&quot;{}&quot;, a.to_string())
<span class="boring">}
</span></code></pre></pre>
<h3 id="è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº"><a class="header" href="#è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº">è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº</a></h3>
<ul>
<li>
<p>é‡åˆ°*è¿ç®—ç¬¦è‡ªåŠ¨æ¥å¼•ç”¨</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>assert_eq!(x, *a.deref());
assert_eq!(x, *a);
<span class="boring">}
</span></code></pre></pre>
</li>
<li>
<p>é‡åˆ° . è¿ç®—ç¬¦æ¥å¼•ç”¨è°ƒç”¨æ–¹æ³•</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>print!(&quot;{}&quot;, a.to_string())
<span class="boring">}
</span></code></pre></pre>
</li>
<li>
<p>å‚æ•°ä¼ é€’è‡ªåŠ¨è§£å¼•ç”¨</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let s = String::from(&quot;aaaa&quot;);
fn take_str(s: &amp;str) {
    print!(&quot;{}&quot;, s);
}
take_str(&amp;s);

#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]
impl ops::Deref for String {
    type Target = str;

    #[inline]
    fn deref(&amp;self) -&gt; &amp;str {
        unsafe { str::from_utf8_unchecked(&amp;self.vec) }
    }
}
<span class="boring">}
</span></code></pre></pre>
</li>
</ul>
<h3 id="è‡ªåŠ¨ç®¡ç†å†…å­˜"><a class="header" href="#è‡ªåŠ¨ç®¡ç†å†…å­˜">è‡ªåŠ¨ç®¡ç†å†…å­˜</a></h3>
<p>è‡ªåŠ¨åŒ–ç®¡ç†å†…å­˜ (dropï¼Œä½œç”¨åŸŸå¤–è‡ªåŠ¨é‡Šæ”¾å†…å­˜)</p>
<h2 id="2-atomic-åœ¨-rust-ä¸­çš„å®è·µ"><a class="header" href="#2-atomic-åœ¨-rust-ä¸­çš„å®è·µ">2. Atomic åœ¨ rust ä¸­çš„å®è·µ</a></h2>
<p><a href="https://www.youtube.com/watch?v=rMGWeSjctlY">Crust of Rust: Atomics and Memory Ordering</a></p>
<h3 id="ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex"><a class="header" href="#ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex">ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex</a></h3>
<pre><pre class="playground"><code class="language-rust">use std::{sync::atomic::{AtomicBool, Ordering, AtomicUsize}, thread::{self, spawn}, cell::UnsafeCell};

const UNLOCKED: bool = true;
const LOCKED: bool = false;

struct Mutex&lt;T&gt; {
    locked: AtomicBool,
    v: UnsafeCell&lt;T&gt;
}

unsafe impl&lt;T&gt; Sync for Mutex&lt;T&gt; where T: Send {}

impl&lt;T&gt; Mutex&lt;T&gt; {

    pub fn new(v: T) -&gt; Self {
        Self {
            locked: AtomicBool::new(UNLOCKED),
            v: UnsafeCell::new(v)
        }
    }

    /// æš´éœ²ä¸€ä¸ªå¯å˜å¼•ç”¨å‡ºå»
    ///
    /// å½“çº¿ç¨‹ A å’Œçº¿ç¨‹ B åŒæ—¶æ‰§è¡Œæ—¶ï¼ŒAï¼ŒB å¯èƒ½åŒæ—¶æ‹¿åˆ°ğŸ”“ï¼Œå¹¶åŒæ—¶ä¸Šé”ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰`çœ‹åˆ°`å¯¹æ–¹é¡µæ‹¿åˆ°äº†é”
    /// æ‰€ä»¥å°±å‡ºå…ˆäº†ï¼Œçº¿ç¨‹ A å’Œ B åŒæ—¶ä»å¯„å­˜å™¨æ‹¿åˆ°å€¼ 1ï¼Œæ”¹ä¸ºäº† 2ï¼Œç„¶åå¤åˆ¶åˆ°å¯„å­˜å™¨å†…ï¼Œåä¿®æ”¹çš„ä¼šè¦†ç›–å‰ä¸€æ¬¡ä¿®æ”¹
    /// ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸‹é¢æ˜¯ä¸€äº›è§£å†³æ–¹æ³•
    ///
    /// æ–¹æ¡ˆ 1ï¼Œä½¿ç”¨`compare_exchange`åˆå¹¶åŠ é”ä¸Šé”è¿‡ç¨‹
    /// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}
    ///
    /// #1 compare_exchange æ˜¯ä½æ•ˆçš„ï¼Œå¦‚æœæ˜¯å¤šæ ¸éƒ½åœ¨åŒæ—¶äº‰å¤ºé”ï¼Œ8 ä¸ªæ ¸ä¸­æœ‰ä¸€ä¸ªå’Œå…ˆæ‹¿åˆ°äº†é”
    /// é‚£ä¹ˆå‰©ä¸‹çš„ 7 ä¸ªæ ¸ä¾ç„¶ä¼šäº’ç›¸ç«äº‰ï¼Œè¿™ä¸ªå˜é‡çš„å†…å­˜å°±ä¼šåœ¨å¤šä¸ªæ ¸ä¸­ä¸æ–­æ‹·è´
    /// #2 ç›¸æ¯”äº mutexï¼Œmutex æ‹¿ä¸åˆ°é”å°±ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œ compare_exchange æ‹¿ä¸åˆ°å°±ä¼šè¿”å›ä¸€ä¸ª Err
    /// #3 rust ä¸­è¿˜æä¾›äº† compare_and_exchange_weakï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯
    ///     compare_and_exchange åªå…è®¸åœ¨åˆ¤æ–­ Current v alue å’Œä¼ å…¥çš„å€¼ä¸ä¸€æ ·æ—¶è¿”å› Err
    ///     compare_and_exchange_weak å³ä½¿åœ¨ä¸€æ ·çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šè¿”å› Errï¼Œè¿™ç§ç»†å°çš„å·®åˆ«èƒ½å¤Ÿç”¨äºæŸäº›åœºæ™¯ï¼Œè®©æ€§èƒ½æ›´å¥½
    ///     åŸå› æ˜¯ç”±äºåœ¨ä¸åŒå¹³å°ä¸Šçš„å®ç°ä¸åŒ
    ///         x86: compare_and_swap
    ///         ARM: LDREX STREX
    ///     åœ¨ x86 ä¸Š weak ä¸æ™®é€šçš„ç›¸åŒï¼Œ
    ///     åœ¨ ARM ä¸Šï¼š
    ///         compare_and_exchange: impl using a loop of LDREX and STREX
    ///         compare_and_exchange_weak: LDREX and STREX with no loop, it may be fake
    pub fn with_lock&lt;R&gt;(&amp;self, f: impl FnOnce(&amp;mut T) -&gt; R) -&gt; R {
        // æ‹¿ğŸ”“ ä¸ŠğŸ”“
        // while self.locked.load(Ordering::Relaxed) != UNLOCKED {}
        // self.locked.store(LOCKED, Ordering::Relaxed);

        // æ–¹æ¡ˆ 1
        // while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}

        // æ–¹æ¡ˆ 2 åœ¨ arm ä¸‹æœ‰æ›´å¥½çš„æ€§èƒ½
        while self.locked.compare_exchange_weak(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {
            // å‡å¦‚ç°åœ¨ current value å°±æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå·²ç»ä¿®æ”¹ä¸º LOCKED çŠ¶æ€ï¼Œé‚£ä¹ˆå°±å·²ç»æ‹¿åˆ°äº†æ‰€æœ‰æƒ
            // åŠ å…¥ç°åœ¨è¿˜æ²¡æœ‰ä¿®æ”¹å®Œæˆï¼Œcurrent value ä¾ç„¶æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šå¡ä½ï¼Œç›´åˆ°æœ‰åˆ«çš„çº¿ç¨‹æˆåŠŸæ‹¿åˆ°äº†æ‰€æœ‰æƒ
            while self.locked.load(Ordering::Relaxed) == LOCKED {
                thread::yield_now();
            }
            thread::yield_now();
        }

        // æš´éœ²æ•°æ®
        let ret = f(unsafe { &amp;mut *self.v.get() });
        // è§£ğŸ”“
        self.locked.store(UNLOCKED, Ordering::Relaxed);
        ret
    }
}

fn main() {
    let l: &amp;'static _ = Box::leak(Box::new(Mutex::new(0)));

    let handles: Vec&lt;_&gt; = (0..1000).map(|_| {
        thread::spawn(move || {
            for _ in 0..1000 {
                l.with_lock(|v| {
                    *v += 1;
                })
            }
        })
    }).collect();

    for handle in handles {
        handle.join().unwrap();
    }

    // è¿™é‡Œä¾ç„¶ä¼šæŠ¥é”™
    assert_eq!(l.with_lock(|v| *v), 1000 * 1000);

}
</code></pre></pre>
<h3 id="acquire-ä¸-release"><a class="header" href="#acquire-ä¸-release">Acquire ä¸ Release</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// ä½†æ˜¯å³ä½¿ç”¨äº†ä¸Šé¢çš„ä¸œè¥¿ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œè™½ç„¶åœ¨ X86 64 ä½ç³»ç»Ÿä¸Šæ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºä»–ä¸æ”¯æŒï¼ï¼Œä»–åªæ”¯æŒ Seq çš„ï¼Œä¸è¿‡è¿˜æ˜¯è¦è¯´æ˜é—®é¢˜
/// å› ä¸ºä¸‹é¢å¯¹å˜é‡ v çš„ä¿®æ”¹å’Œä¸Šé”é‡Šæ”¾é”çš„è¿‡ç¨‹æ¯«ä¸ç›¸å…³ï¼Œ
/// æ‰€ä»¥ä¸‹ä¸€è¡Œå¯èƒ½è¢«é‡æ–°æ’åˆ—åœ¨åŠ é”ä¹‹å‰ï¼Œæˆ–è€…è§£é”ä¹‹åï¼Œè¿™ä¸¤ç§éƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä½†æ˜¯ cpu å’Œç¼–è¯‘å™¨å°±å¯èƒ½è¿™æ ·åš
///
/// å¯¹æ­¤éœ€è¦ä½¿ç”¨ Acquire å’Œ Release
pub fn with_lock2&lt;R&gt;(&amp;self, f: impl FnOnce(&amp;mut T) -&gt; R) -&gt; R {
    // ä»»ä½•ä¹‹åçš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Acquire ä¹‹å‰
    // åˆ«çš„çº¿ç¨‹ä¸­çš„å†™æ“ä½œï¼Œå¯¹äºè¿™é‡Œçš„ Acquire éƒ½æ˜¯å¯è§çš„
    while self.locked.compare_exchange_weak(UNLOCKED, LOCKED, Ordering::Acquire, Ordering::Relaxed).is_err() {
        while self.locked.load(Ordering::Relaxed) == LOCKED {
            thread::yield_now();
        }
        thread::yield_now();
    }
    let ret = f(unsafe { &amp;mut *self.v.get() });

    // ä»»ä½•ä¹‹å‰çš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Release ä¹‹å
    // è¿™ä¸ªçº¿ç¨‹é‡Œçš„æ‰€æœ‰å†™æ“ä½œå¯¹åˆ«çš„çº¿ç¨‹ä¸­çš„ Acquire éƒ½æ˜¯å¯è§çš„
    self.locked.store(UNLOCKED, Ordering::Release);
    ret
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="å¿…éœ€ç”¨-seq-çš„åœºæ™¯"><a class="header" href="#å¿…éœ€ç”¨-seq-çš„åœºæ™¯">å¿…éœ€ç”¨ Seq çš„åœºæ™¯</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[test]
fn seq_test() {
    // fetch_add always succeed

    let x: &amp;'static _ = Box::leak(Box::new(AtomicBool::new(false)));
    let y: &amp;'static _ = Box::leak(Box::new(AtomicBool::new(false)));
    let z: &amp;'static _ = Box::leak(Box::new(AtomicUsize::new(0)));
    let tx = thread::spawn(move || {
        x.store(true, Ordering::Release);                  // ï¼ï¼ï¼
    });
    let ty = thread::spawn(move || {
        y.store(true, Ordering::Release);
    });
    let t1 = spawn(move || {
        while !x.load(Ordering::Acquire) {}
        if y.load(Ordering::Acquire) {
            z.fetch_add(1, Ordering::Release);
        }
    });
    let t2 = spawn(move || {
        while !y.load(Ordering::Acquire) {}                    // è¿™è¡Œå’Œä¸‹é¢ä¸€è¡Œå¯èƒ½é‡æ’ (æˆ–è€…è¯´ä¸æ˜¯é‡æ’ï¼Œå•çº¯æ—¶å¯è§æ€§çš„é—®é¢˜ï¼Œä¸‹é¢çš„ x å°±æ˜¯çœ‹åˆ°äº† x æ˜¯ false)
        if x.load(Ordering::Acquire) {                         // ï¼ï¼ï¼x ä¸º falseï¼Œå½“ x è¢«ä¿®æ”¹ä¸º true åï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜
            z.fetch_add(1, Ordering::Release);
        }
    });
    println!(&quot;{}&quot;, z.load(Ordering::SeqCst));

    // What are the possibles for z?
    // - is 0 possibly ?
    //   ç»è¿‡åˆ¤æ–­ï¼Œè‡³å°‘æœ‰ä¸‹é¢çš„æ¡ä»¶
    //     t1 must run after tx
    //     t2 must run after ty
    //   å‡ ç§æ’åˆ—ç»„åˆåº”è¯¥æ˜¯ 1 æˆ– 2ï¼Œæ²¡æœ‰ 0
    //   ä½†æ˜¯ 0 è¿˜æ˜¯å¯èƒ½çš„ï¼Œ
    //           t2    t1,t2
    //   MO(x)  false  true
    //           t1    t1,t2
    //   MO(y)  false  true
    // - is 1 possibly ?
    //   Yes: tx -&gt; t1 -&gt; ty -&gt; t2
    // - is 2 possibly ?
    //   Yes: tx -&gt; ty -&gt; t1 -&gt; t2

}
<span class="boring">}
</span></code></pre></pre>
<h2 id="3-å¸¸ç”¨-trait"><a class="header" href="#3-å¸¸ç”¨-trait">3. å¸¸ç”¨ Trait</a></h2>
<h3 id="31-read"><a class="header" href="#31-read">3.1 Read</a></h3>
<p>Read Trait çš„åŠŸèƒ½æ˜¯ï¼šä»æ•°æ®æºæ‹‰å– (Pull) ä¸€å®šæ•°æ®åˆ°æŒ‡å®šçš„ç¼“å†²åŒºï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p>
<p><strong>å…³äºé˜»å¡ï¼š</strong> read å‡½æ•°ä¸ä¿è¯ Read æ˜¯å¦ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œå¦‚æœä¸€ä¸ª read è¿‡ç¨‹é˜»å¡äº†è€Œä¸”ç­‰å¾…å¤±è´¥ï¼Œé‚£ä»–å°±ä¼šè¿”å›ä¸€ä¸ª [<code>Err</code>] æ ‡è®°ã€‚</p>
<p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>read()</code>è¿”å›çš„æ˜¯ [<code>OK(n)</code>] , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚
å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>reader å·²ç»åˆ°è¾¾äº†<code>the end of file</code>ï¼Œè€Œä¸”è¿™ä¸ª<code>file</code>å¯èƒ½ä¸ä¼šåœ¨äº§ç”Ÿæ–°æ•°æ®ã€‚æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ likelyï¼Œæ¯”å¦‚ï¼šåœ¨ linux
ç³»ç»Ÿä¸­ï¼Œread å¯èƒ½å¯¹ä¸€ä¸ª [<code>TcpStream</code>] è°ƒç”¨äº†<code>recv</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ0 ä»£è¡¨è¿™ä¸ªè¿æ¥å·²ç»è¢«æˆåŠŸå…³é—­ï¼Œå¦‚æœæ˜¯å¯¹ [<code>File</code>] ,
é‚£å°±å¯èƒ½æ„å‘³ç€ç¡®å®è¯»å–åˆ°äº†æ–‡ä»¶çš„æœ«å°¾ï¼Œä½†æ˜¯å¦‚æœæœ‰æ›´å¤šçš„æ•°æ®è¢«è¿½åŠ  (append) åˆ°æ–‡ä»¶æœ«å°¾ï¼Œé‚£ä¹ˆæœªæ¥çš„ read æ“ä½œä¾ç„¶èƒ½å¤Ÿæ­£å¸¸è¿”å›è¢«è¿½åŠ çš„æ•°æ®</li>
<li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li>
</ol>
<p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p>
<p><strong>å…³äºå®‰å…¨æ€§ï¼š</strong></p>
<ul>
<li>
<p>å› ä¸ºå®ç°è¿™ä¸ª Trait æ˜¯å®‰å…¨çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½ç”¨ <code>n &lt; buf.len()</code> å»ç¡®ä¿å®‰å…¨ï¼Œä½¿ç”¨ unsafe æ˜¯æ›´è¦å°å¿ƒç¡®ä¿è¯¸å¦‚è¶Šç•Œé—®é¢˜æ˜¯å¦ä¼šå‘ç”Ÿã€‚</p>
</li>
<li>
<p>read ä¸ä¿è¯ buf é‡Œçš„æ•°æ®æ˜¯å¯¹çš„ï¼Œæ‰€ä»¥ä¸æ¨èè¯»å–ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œåªæ¨èå‘ç¼“å†²åŒºé‡Œå†™å…¥æ•°æ®</p>
</li>
<li>
<p>ç›¸åº”çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½æœ‰ä»»ä½•å‡è®¾ï¼Œè¿™ä¸ª buf ä¼šè¢« read æ€ä¹ˆä½¿ç”¨ï¼Œread å‡½æ•°ä¹Ÿå¯èƒ½ä¼šä»ä¸­è¯»å–å†…å®¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯åœ¨è°ƒç”¨ read å‰ï¼Œè¿™ä¸ª buf
å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†ï¼Œè°ƒç”¨æ²¡æœ‰è¢«åˆå§‹åŒ–çš„ buf æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º</p>
</li>
</ul>
<p>*<strong>å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰è¯»å–è¿‡ä»»ä½•å­—èŠ‚ï¼Œå¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œ
è¯»å–è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¥è‡ª doc çš„ä¾‹å­</p>
<pre><pre class="playground"><code class="language-rust">use std::io;
use std::io::prelude::*;
use std::fs::File;
fn main() -&gt; io::Result&lt;()&gt; {
    let mut f = File::open(&quot;foo.txt&quot;)?;
    let mut buffer = [0; 10];
    // read up to 10 bytes
    let n = f.read(&amp;mut buffer[..])?;
    println!(&quot;The bytes: {:?}&quot;, &amp;buffer[..n]);
    Ok(())
}
</code></pre></pre>
<h3 id="32-write"><a class="header" href="#32-write">3.2 Write</a></h3>
<p>Write çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯å‘ writer ä¸­å†™å…¥ä¸€æ®µ bufï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•° <strong>å…³äºé˜»å¡ï¼š</strong> write ä¼šå°è¯•å‘ writer ä¸­å†™å…¥æ•´ä¸ª buf
é‡Œçš„å†…å®¹ï¼Œä½†æ˜¯å†™å…¥å¯èƒ½ä¸æˆåŠŸï¼Œæˆ–è€…å†™å…¥æ—¶äº§ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè°ƒç”¨ä¸€æ¬¡ write æ„å‘³ç€æœ€å¤šä¸€æ¬¡å°è¯•å†™å…¥ write å‡½æ•°åŒæ ·ä¸ä¿è¯ Write
æ˜¯å¦å¤„äºé˜»å¡çŠ¶æ€ä»¥ç­‰å¾…æ•°æ®è¢«å†™å…¥ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥é˜»å¡äº†ï¼Œä»–å¯èƒ½ä¼šè¿”å›ä¸€ä¸ª [<code>Err</code>]ã€‚</p>
<p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>write()</code>è¿”å›çš„æ˜¯ [<code>OK(n)</code>] , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚
å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>è¢«å†™å…¥çš„ä¸œè¥¿å·²ç»ä¸ä¼šæ¥å—æ–°æ•°æ®äº†ï¼Œä¹‹åä¹Ÿä¸ä¸€å®šä¼š</li>
<li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li>
</ol>
<p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p>
<p>*<strong>å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰ä»»ä½•å­—èŠ‚è¢«æˆåŠŸå†™å…¥ è¿”å›å€¼å°äº buf çš„é•¿åº¦ä¸è¢«å½“æˆæ˜¯é”™è¯¯
å¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œå†™å…¥è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p>
<p>åŒæ ·æ˜¯å®˜æ–¹çš„ demo</p>
<pre><pre class="playground"><code class="language-rust">use std::io::prelude::*;
use std::fs::File;
fn main() -&gt; std::io::Result&lt;()&gt; {
    let mut buffer = File::create(&quot;foo.txt&quot;)?;
    // Writes some prefix of the byte string, not necessarily all of it.
    buffer.write(b&quot;some bytes&quot;)?;
    Ok(())
}
</code></pre></pre>
<h3 id="33-seek--bufreader--bufwriter"><a class="header" href="#33-seek--bufreader--bufwriter">3.3 Seek &amp; BufReader &amp; BufWriter</a></h3>
<p>[<code>Read</code>] å’Œ [<code>Write</code>] æ˜¯æœ€é‡è¦çš„ä¸¤ä¸ª Traitï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„ Trait[<code>Seek</code>] å’Œ [<code>BufRead</code>],
è¿™ä¸¤ä¸ªéƒ½å»ºç«‹åœ¨ reader åªä¸Šï¼Œç”¨æ¥æ§åˆ¶ read çš„è¿‡ç¨‹ã€‚</p>
<p>[<code>Seek</code>] è®©ä½ æ§åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚å°†è¦è¯»å–çš„æ¥è‡ªå“ªé‡Œ</p>
<pre><pre class="playground"><code class="language-rust">use std::io;
use std::io::prelude::*;
use std::io::SeekFrom;
use std::fs::File;
fn main() -&gt; io::Result&lt;()&gt; {
    let mut f = File::open(&quot;foo.txt&quot;)?;
    let mut buffer = [0; 10];
    // skip to the last 10 bytes of the file
    f.seek(SeekFrom::End(-10))?;
    // read up to 10 bytes
    let n = f.read(&amp;mut buffer)?;
    println!(&quot;The bytes: {:?}&quot;, &amp;buffer[..n]);
    Ok(())
}
</code></pre></pre>
<p>åŸºäº byte çš„æ¥å£æ€§èƒ½ä¸ä½³ï¼Œæ‰€ä»¥æä¾›äº†å¾ˆå¤šåŸºäº buffer çš„æ¥å£ [<code>BufRead</code>] å°±æä¾›äº†æ›´å¤š Read ç›¸å…³çš„ API</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let f = File::open(&quot;foo.txt&quot;)?;
let mut reader = BufReader::new(f);
let mut buffer = String::new();
// read a line into buffer
reader.read_line(&amp;mut buffer)?;
<span class="boring">}
</span></code></pre></pre>
<p>[<code>BufWriter</code>] æ²¡æœ‰æä¾›æ›´å¤šå†™å…¥çš„æ–¹æ³•ï¼Œä»–åªæ˜¯ç¼“å†²äº†æ¯æ¬¡è°ƒç”¨</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let f = File::create(&quot;foo.txt&quot;)?;
{
    let mut writer = BufWriter::new(f);

    // write a byte to the buffer
    writer.write(&amp;[42])?;

} // the buffer is flushed once writer goes out of scope
<span class="boring">}
</span></code></pre></pre>
<h2 id="4-å…¶ä»–"><a class="header" href="#4-å…¶ä»–">4. å…¶ä»–</a></h2>
<h3 id="2-rc--arc"><a class="header" href="#2-rc--arc">2. Rc &amp; Arc</a></h3>
<h4 id="ä»‹ç»-1"><a class="header" href="#ä»‹ç»-1">ä»‹ç»</a></h4>
<blockquote>
<p>The key to our design is the RefCell type. The heart of RefCell is a pair of
methods:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn borrow(&amp;self) -&gt; Ref&lt;'_, T&gt;;
fn borrow_mut(&amp;self) -&gt; RefMut&lt;'_, T&gt;;
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>Introducing inherited mutability roots to shared types Shared smart pointer
types, including Rc and Arc, provide containers that can be cloned and shared
between multiple parties. Because the contained values may be
multiply-aliased, they can only be borrowed as shared references, not mutable
references. Without cells it would be impossible to mutate data inside of
shared boxes at all!</p>
</blockquote>
<blockquote>
<p>It's very common then to put a RefCell inside shared pointer types to
reintroduce mutability:</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust">use std::collections::HashMap;
use std::cell::RefCell;
use std::rc::Rc;
fn main() {
    let shared_map: Rc&lt;RefCell&lt;_&gt;&gt; = Rc::new(RefCell::new(HashMap::new()));
    shared_map.borrow_mut().insert(&quot;africa&quot;, 92388);
    shared_map.borrow_mut().insert(&quot;kyoto&quot;, 11837);
    shared_map.borrow_mut().insert(&quot;piccadilly&quot;, 11826);
    shared_map.borrow_mut().insert(&quot;marbles&quot;, 38);
}
</code></pre></pre>
<blockquote>
<p>Note that this example uses Rc and not Arc. RefCells are for single-threaded
scenarios. Consider using Mutex if you need shared mutability in a
multi-threaded situation</p>
</blockquote>
<h4 id="try_unwrap"><a class="header" href="#try_unwrap">try_unwrap()</a></h4>
<blockquote>
<p>Get T from Rc&lt;T&gt; try to use <code>try_unwrap()</code>, which moves out the contents
of an Rc if its refcount is 1 ::: warning unwrap on Result requires that you
can debug-print the error case. RefCell only implements Debug if T does. Node
doesn't implement Debug. try:
Rc::try_unwrap(old_head).ok().unwrap().into_inner().elem :::</p>
</blockquote>
<h3 id="4-cell--refcell"><a class="header" href="#4-cell--refcell">4. Cell &amp; RefCell</a></h3>
<blockquote>
<p>Shareable mutable containers.</p>
<p>Values of the Cell and RefCell types may be mutated through shared references
(i.e. the common &amp;T type), whereas most Rust types can only be mutated through
unique (&amp;mut T) references. We say that Cell and RefCell provide 'interior
mutability', in contrast with typical Rust types that exhibit 'inherited
mutability'.</p>
<p>Cell types come in two flavors: Cell and RefCell. Cell provides get and set
methods that change the interior value with a single method call. Cell though
is only compatible with types that implement Copy. For other types, one must
use the RefCell type, acquiring a write lock before mutating.</p>
<p>RefCell uses Rust's lifetimes to implement 'dynamic borrowing', a process
whereby one can claim temporary, exclusive, mutable access to the inner value.
Borrows for RefCells are tracked 'at runtime', unlike Rust's native reference
types which are entirely tracked statically, at compile time. Because RefCell
borrows are dynamic it is possible to attempt to borrow a value that is
already mutably borrowed; when this happens it results in thread panic.</p>
</blockquote>
<h3 id="5-ref--refmut"><a class="header" href="#5-ref--refmut">5. Ref &amp; RefMut</a></h3>
<h4 id="refmap"><a class="header" href="#refmap">Ref::map()</a></h4>
<ol>
<li>example1</li>
</ol>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>map(Ref&lt; T&gt;, f: F) -&gt; Ref&lt;U&gt;
// Get Ref&lt;T&gt; from Ref&lt;Node&lt;T&gt;&gt;
// my example
pub fn peek_front(&amp;self) -&gt; Option&lt;Ref&lt;T&gt;&gt; {
    self.head.as_ref().map(|node| {
        Ref::map(node.borrow(), |node| &amp;node.elem)
    })
}
<span class="boring">}
</span></code></pre></pre>
<ol start="2">
<li>example2</li>
</ol>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Makes a new Ref for a component of the borrowed data.

// The RefCell is already immutably borrowed, so this cannot fail.

// This is an associated function that needs to be used as Ref::map(...). A method would interfere with methods of the same name on the contents of a RefCell used through Deref.

use std::cell::{RefCell, Ref};

let c = RefCell::new((5, 'b'));
let b1: Ref&lt;(u32, char)&gt; = c.borrow();
let b2: Ref&lt;u32&gt; = Ref::map(b1, |t| &amp;t.0);
assert_eq!(*b2, 5)
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-print-å®"><a class="header" href="#rust-print-å®">Rust print! å®</a></h1>
<pre><code class="language-rs">print!(&quot;{}&quot;, &amp;a)
</code></pre>
<h2 id="1-print-å®"><a class="header" href="#1-print-å®">1. <code>print!</code> å®</a></h2>
<p><code>print!</code> å®ä¼šè°ƒç”¨ <code>format_args!</code> å°†<code>&quot;{}&quot;, &amp;a</code>è½¬æ¢ä¸ºä¸€ä¸ª <code>Arguments</code> ç»“æ„ä½“ï¼Œæ¥ç€ä½œä¸ºå‚æ•°ä¼ å…¥ <code>_print</code>
å‡½æ•°</p>
<pre><code class="language-rs">macro_rules! print {
    ($($arg:tt)*) =&gt; {
        $crate::io::_print($crate::format_args!($($arg)*))
    };
}
</code></pre>
<h2 id="2-format_args"><a class="header" href="#2-format_args">2. <code>format_args!</code></a></h2>
<p><code>format_args!</code> çš„å®ç°éœ€è¦ç¼–è¯‘å™¨ä»‹å…¥ (è¿™é‡Œæœ‰æ‡‚çš„å¤§ä½¬å¯ä»¥å¸®å¿™è§£ç­”)</p>
<pre><code class="language-rs">macro_rules! format_args {
    ($fmt:expr) =&gt; {{ /* compiler built-in */ }};
    ($fmt:expr, $($args:tt)*) =&gt; {{ /* compiler built-in */ }};
}

use std::fmt;
let s = fmt::format(format_args!(&quot;hello {}&quot;, &quot;world&quot;)); assert_eq!(s,
format!(&quot;hello {}&quot;, &quot;world&quot;));
</code></pre>
<p>Arguements ç»“æ„ä½“ç­¾åå¦‚ä¸‹ï¼š</p>
<pre><code class="language-rs">pub struct Arguments&lt;'a&gt; {
    // å­—ç¬¦ä¸²
    pieces: &amp;'a [&amp;'static str],

    // å‚æ•°åˆ—è¡¨
    // `ArgumentV1` ç»“æ„ä½“åŒ…å«å‚æ•°çš„å€¼ï¼Œä»¥åŠå®ƒå¯¹åº”çš„æ ¼å¼åŒ–æ–¹å¼ï¼ˆé€šè¿‡ {} {:p} æŒ‡å®šï¼‰
    args: &amp;'a [ArgumentV1&lt;'a&gt;],

    // å…·ä½“çš„æ ¼å¼åŒ–ä¿¡æ¯ã€‚
    // Arguement ç»“æ„ä½“ä¸­ä¿å­˜äº† å¯¹åº”çš„å‚æ•°åœ¨ args ä¸­çš„ç´¢å¼•
    // è¿˜æœ‰é¢å¤–çš„æ ¼å¼åŒ–ä¿¡æ¯ï¼Œæ¯”å¦‚å‚æ•°ä½ç½®ï¼Œå®½åº¦ï¼Œå¡«å……å­—ç¬¦ç­‰
    fmt: Option&lt;&amp;'a [rt::v1::Argument]&gt;,
}
</code></pre>
<p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹ï¼š</p>
<pre><code class="language-rs">fn main() {
    let a = 1;
    print!(&quot;hello{}aa{0}too{:p}ohmygod{:p}&quot;, a, &amp;a, &amp;a);
}
</code></pre>
<ul>
<li>å­—ç¬¦ä¸²ç‰‡æ®µæœ‰ 4 ä¸ªï¼Œæ‰€ä»¥ pieces çš„å€¼ä¸º [&quot;hello&quot;, &quot;aa&quot;, &quot;too&quot;, &quot;ohmygod&quot;]</li>
<li>å¦‚æœæœ‰ä¸¤ä¸ªè¿ç»­çš„ <code>{}</code>, å®ƒä»¬ä¸­é—´ç›¸å½“äºè¢«æ’å…¥äº†ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚</li>
<li>å‚æ•°åªæœ‰ä¸‰ä¸ªï¼Œæ‰€ä»¥ <code>arg</code> åªæœ‰ä¸‰ä¸ªå…ƒç´ ã€‚</li>
<li>ç”±äºåä¸¤ä¸ªéƒ½æ˜¯ä½¿ç”¨ <code>{:p}</code> æ‰“å°åœ°å€ï¼Œæ‰€ä»¥ <code>args[1]</code> å’Œ <code>args[2]</code> çš„ <code>formatter</code> çš„å€¼ç›¸åŒ</li>
<li>æœ‰å››ä¸ªä½ç½®éœ€è¦å¡«å……å‚æ•°ï¼Œæ‰€ä»¥ fmt æœ‰ 4 ä¸ªå…ƒç´ ã€‚</li>
</ul>
<p>ç”Ÿæˆçš„ Arguements ç»“æ„ä½“å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205221334215.jpg" alt="" /></p>
<p>ä¸‹é¢æ˜¯ cargo expand å±•å¼€åçš„ç»“æœï¼š</p>
<pre><code class="language-rs">#![feature(prelude_import)]
#[prelude_import]
use std::prelude::rust_2021::*;
#[macro_use]
extern crate std;
use std::fmt::Display;
fn main() {
    let a = 1;
    ::std::io::_print(::core::fmt::Arguments::new_v1_formatted(
        &amp;[&quot;hello&quot;, &quot;aa&quot;, &quot;too&quot;, &quot;ohmygod&quot;],
        &amp;[
            ::core::fmt::ArgumentV1::new_display(&amp;a),
            ::core::fmt::ArgumentV1::new_pointer(&amp;&amp;a),
            ::core::fmt::ArgumentV1::new_pointer(&amp;&amp;a),
        ],
        &amp;[
            ::core::fmt::rt::v1::Argument {
                position: 0usize,
                format: ::core::fmt::rt::v1::FormatSpec {
                    fill: ' ',
                    align: ::core::fmt::rt::v1::Alignment::Unknown,
                    flags: 0u32,
                    precision: ::core::fmt::rt::v1::Count::Implied,
                    width: ::core::fmt::rt::v1::Count::Implied,
                },
            },
            ::core::fmt::rt::v1::Argument {
                position: 0usize,
                format: ::core::fmt::rt::v1::FormatSpec {
                    fill: ' ',
                    align: ::core::fmt::rt::v1::Alignment::Unknown,
                    flags: 0u32,
                    precision: ::core::fmt::rt::v1::Count::Implied,
                    width: ::core::fmt::rt::v1::Count::Implied,
                },
            },
            ::core::fmt::rt::v1::Argument {
                position: 1usize,
                format: ::core::fmt::rt::v1::FormatSpec {
                    fill: ' ',
                    align: ::core::fmt::rt::v1::Alignment::Unknown,
                    flags: 0u32,
                    precision: ::core::fmt::rt::v1::Count::Implied,
                    width: ::core::fmt::rt::v1::Count::Implied,
                },
            },
            ::core::fmt::rt::v1::Argument {
                position: 2usize,
                format: ::core::fmt::rt::v1::FormatSpec {
                    fill: ' ',
                    align: ::core::fmt::rt::v1::Alignment::Unknown,
                    flags: 0u32,
                    precision: ::core::fmt::rt::v1::Count::Implied,
                    width: ::core::fmt::rt::v1::Count::Implied,
                },
            },
        ],
        unsafe { ::core::fmt::UnsafeArg::new() },
    ));
    ::std::io::_print(::core::fmt::Arguments::new_v1(
        &amp;[&quot;&quot;],
        &amp;[::core::fmt::ArgumentV1::new_display(&amp;&amp;a)],
    ));
}
</code></pre>
<h2 id="3-_print"><a class="header" href="#3-_print">3. _print()</a></h2>
<p>åªæ˜¯ç®€å•çš„è°ƒç”¨äº† <code>print_to</code>, æŒ‡å®šäº†è¾“å‡ºåˆ° <code>stdout</code></p>
<pre><code class="language-rs">pub fn _print(args: fmt::Arguments&lt;'_&gt;) {
    print_to(args, stdout, &quot;stdout&quot;);
}
</code></pre>
<p>print_to å‡½æ•°å…·ä½“å†…å®¹å¦‚ä¸‹ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨äº†ç¼“å†²åŒºçš„ <code>write_fmt</code> æ–¹æ³•</p>
<pre><code class="language-rs">fn print_to&lt;T&gt;(args: fmt::Arguments&lt;'_&gt;, global_s: fn() -&gt; T, label: &amp;str)
where
    T: Write,
{
    // å°è¯•æ‹¿åˆ°è¾“å‡ºçš„ç¼“å†²åŒº w
    if OUTPUT_CAPTURE_USED.load(Ordering::Relaxed) &amp;&amp; OUTPUT_CAPTURE.try_with(|s| {
            s.take().map(|w| { // w: Arc&lt;Mutex&lt;Vec&lt;u8&gt;&gt;&gt;
                // è°ƒç”¨ write_fmt æ–¹æ³•
                let _ = w.lock().unwrap_or_else(|e| e.into_inner()).write_fmt(args);
                s.set(Some(w));
            })
        }) == Ok(Some(()))
    {
        // Successfully wrote to capture buffer.
        return;
    }
    //
    if let Err(e) = global_s().write_fmt(args) {
        panic!(&quot;failed printing to {label}: {e}&quot;);
    }
}
</code></pre>
<h2 id="4-wwrite_fmtargs"><a class="header" href="#4-wwrite_fmtargs">4. <code>w.write_fmt(args)</code></a></h2>
<pre><code class="language-rs">fn write_fmt(&amp;mut self, fmt: fmt::Arguments&lt;'_&gt;) -&gt; Result&lt;()&gt; {
    // åˆ›å»ºä¸€ä¸ª Adapter å°† fmt è½¬åŒ–ä¸ºä¸€ä¸ª impl Writeï¼Œé¡ºä¾¿å‚¨å­˜é”™è¯¯ä¿¡æ¯
    struct Adapter&lt;'a, T: ?Sized + 'a&gt; {
        inner: &amp;'a mut T,
        error: Result&lt;()&gt;,
    }

    // è¿™ä¸ª write_str å®é™…ä¸Šå°±æ˜¯è°ƒç”¨äº† Vec&lt;u8&gt; çš„ write_all() æ–¹æ³•
    impl&lt;T: Write + ?Sized&gt; fmt::Write for Adapter&lt;'_, T&gt; {
        fn write_str(&amp;mut self, s: &amp;str) -&gt; fmt::Result {
            match self.inner.write_all(s.as_bytes()) {
                ...
            }
        }
    }

    let mut output = Adapter { inner: self, error: Ok(()) };
    match fmt::write(&amp;mut output, fmt) {
        Ok(()) =&gt; Ok(()),
        ...
    }
}
</code></pre>
<h2 id="5æœ€åæ˜¯-fmtwritemut-output-fmt"><a class="header" href="#5æœ€åæ˜¯-fmtwritemut-output-fmt">5.æœ€åæ˜¯ fmt::write(&amp;mut output, fmt)</a></h2>
<pre><code class="language-rs">pub fn write(output: &amp;mut dyn Write, args: Arguments&lt;'_&gt;) -&gt; Result {
    let mut formatter = Formatter::new(output);
    let mut idx = 0;
    match args.fmt {
        None =&gt; {
            // å¦‚æœæ²¡æœ‰æ ¼å¼åŒ–æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨é»˜è®¤çš„æ ¼å¼åŒ–æ–¹æ³•ã€‚
            // éå†æ‰€æœ‰`å‚æ•°`ï¼Œæ¯æ¬¡å…ˆè¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå†ä½¿ç”¨æ ¼å¼åŒ–æ–¹æ³•è¾“å‡ºä¸€ä¸ªå‚æ•°
            for (i, arg) in args.args.iter().enumerate() {
                // å®‰å…¨æ€§ï¼šargs.args å’Œ args.pieces æ¥è‡ªåŒä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™é‡Œçš„ get_unchecked æ˜¯å®‰å…¨çš„
                let piece = unsafe { args.pieces.get_unchecked(i) };
                if !piece.is_empty() {
                    // è¿™é‡Œçš„ formatter å°±æ˜¯ä¹‹å‰çš„ Adapter,
                    // write_str å°±æ˜¯è°ƒç”¨ Vec&lt;u8&gt; å¯¹åº”çš„å®ç°
                    formatter.buf.write_str(*piece)?;
                }
                (arg.formatter)(arg.value, &amp;mut formatter)?;
                idx += 1;
            }
        }
        Some(fmt) =&gt; {
            // æ¯ä¸ªæ ¼å¼åŒ–æ–¹æ³•éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å‚æ•°ã€‚æ¯æ¬¡è¾“å‡ºå‚æ•°å‰ï¼Œéƒ½è¾“å‡ºä¸€ä¸ªå­—ç¬¦ä¸²ç‰‡æ®µ
            // æ³¨æ„ï¼šè¿™é‡Œæ˜¯å¯¹ fmt è¿›è¡Œéå†ï¼Œå› ä¸ºå‚æ•°æ•°é‡å’Œéœ€è¦å¡«å……æ•°é‡ä¸æ˜¯ä¸€ä¸€å¯¹åº”
            for (i, arg) in fmt.iter().enumerate() {
                ...åŒä¸Š
                // è¿™é‡Œçš„ run è¿˜æ˜¯ä¼šè°ƒç”¨
                // (arg.formatter)(arg.value, &amp;mut formatter)?;
                // åªä¸è¿‡ä¼šä¸º formatter æ·»åŠ ä¸€äº›é¢å¤–ä¿¡æ¯
                unsafe { run(&amp;mut formatter, arg, args.args) }?;
                idx += 1;
            }
        }
    }

    // æ‰“å°æœ«å°¾å¤šä½™çš„å­—ç¬¦ä¸²
    if let Some(piece) = args.pieces.get(idx) {
        formatter.buf.write_str(*piece)?;
    }

    Ok(())
}
</code></pre>
<p>è‡³æ­¤ï¼Œä¸€ä¸ª <code>print!</code> çš„å¤§ä½“æµç¨‹å°±ç»“æŸäº†</p>
<h2 id="6-ä¸ºä»€ä¹ˆ-print-a-æ— æ³•æ‰“å°å‡ºåœ°å€"><a class="header" href="#6-ä¸ºä»€ä¹ˆ-print-a-æ— æ³•æ‰“å°å‡ºåœ°å€">6. ä¸ºä»€ä¹ˆ <code>print!(&quot;{}&quot;, &amp;a)</code> æ— æ³•æ‰“å°å‡ºåœ°å€</a></h2>
<p>é€šè¿‡ä¸Šé¢çš„è®²è§£ï¼Œæ‰“å°çš„å…³é”®å°±åœ¨äºä¸‹é¢è¿™è¡Œä»£ç ï¼š</p>
<pre><code class="language-rs">// argï¼šArgumentV1
(arg.formatter)(arg.value, &amp;mut formatter)?
</code></pre>
<p><code>formatter</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼š</p>
<pre><code class="language-rs">// This struct represents the generic &quot;argument&quot; which is taken by the Xprintf family of functions. It contains a function to format the given value.
// At compile time it is ensured that the function and the value have the correct types, and then this struct is used to canonicalize arguments to one type.

// è¯¥ç»“æ„è¡¨ç¤º Xprintf ç³»åˆ—å‡½æ•°é‡‡ç”¨çš„é€šç”¨â€œå‚æ•°â€ã€‚å®ƒåŒ…å«ä¸€ä¸ªæ ¼å¼åŒ–ç»™å®šå€¼çš„å‡½æ•°ã€‚
// åœ¨ç¼–è¯‘æ—¶ï¼Œç¡®ä¿å‡½æ•°å’Œå€¼å…·æœ‰æ­£ç¡®çš„ç±»å‹ï¼Œç„¶åä½¿ç”¨æ­¤ç»“æ„å°†å‚æ•°è§„èŒƒåŒ–ä¸ºä¸€ç§ç±»å‹ã€‚

pub struct ArgumentV1&lt;'a&gt; {
    value: &amp;'a Opaque,
    formatter: fn(&amp;Opaque, &amp;mut Formatter&lt;'_&gt;) -&gt; Result,
}
// NB. Argument is essentially an optimized partially applied formatting function,
// equivalent to `exists T.(&amp;T, fn(&amp;T, &amp;mut Formatter&lt;'_&gt;) -&gt; Result`.
extern &quot;C&quot; {
    type Opaque;
}

pub struct Formatter&lt;'a&gt; {
    flags: u32,
    fill: char,
    align: rt::v1::Alignment,
    width: Option&lt;usize&gt;,
    precision: Option&lt;usize&gt;,

    buf: &amp;'a mut (dyn Write + 'a),
}
</code></pre>
<p>ä¸‹é¢æ˜¯ stackoverflow ä¸Šçš„è§£ç­”</p>
<p><code>print!</code>, <code>println!</code>, <code>eprint!</code>, <code>eprintln!</code>, <code>write!</code>, <code>writeln!</code> and <code>format!</code>
è¿™äº›å®ä¼šéšå¼çš„æ‹¿èµ°å‚æ•°çš„å¼•ç”¨</p>
<pre><code class="language-rs">fn main() {
    let x = 5;
    println!(&quot;{}&quot;, x);
}
</code></pre>
<p>åœ¨ nightly çš„ç¼–è¯‘å™¨ä¸Šä½¿ç”¨ <code>rustc -Z unstable-options --pretty</code> å±•å¼€ä¸Šé¢çš„ä»£ç ï¼š</p>
<blockquote>
<p>æˆ–è€…æ˜¯ <code>cargo expand</code></p>
</blockquote>
<pre><code class="language-rs">#![feature(prelude_import)]
#[prelude_import]
use std::prelude::v1::*;
#[macro_use]
extern crate std;
fn main() {
    let x = 5;
    {
        ::std::io::_print(::core::fmt::Arguments::new_v1(
            &amp;[&quot;&quot;, &quot;\n&quot;],
            &amp;match (&amp;x,) {
                (arg0,) =&gt; [::core::fmt::ArgumentV1::new(
                    arg0,
                    ::core::fmt::Display::fmt,
                )],
            },
        ));
    };
}
</code></pre>
<p>æ•´ç†ä¹‹åå°±æ˜¯ï¼š</p>
<pre><code class="language-rs">use std::{fmt, io};

fn main() {
    let x = 5;
    io::_print(fmt::Arguments::new_v1(
        &amp;[&quot;&quot;, &quot;\n&quot;],
        &amp;[fmt::ArgumentV1::new(&amp;x, fmt::Display::fmt)],
        //                     ^^
    ));
}
</code></pre>
<p>æ³¨æ„ <code>&amp;x</code>.</p>
<p>å¦‚æœä½ å†™çš„æ˜¯ <code>println!(&quot;{}&quot;, &amp;x)</code>ï¼ŒRust ç¼–è¯‘å™¨ä¾ç„¶èƒ½å¤Ÿå¸®ä½ å¤„ç†è¿™ä¸¤å±‚å¼•ç”¨;</p>
<p>å› ä¸º Rust ä¸º &amp;T(T: Display) ä¹Ÿå®ç°äº† Display</p>
<pre><code class="language-rs">// æœ‰ç‚¹åƒæ™ºèƒ½æŒ‡é’ˆçš„ Deref
impl&lt;'a, T&gt; Display for &amp;'a T where T: Display + ?Sized
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å†…ç½‘ç©¿é€å·¥å…·"><a class="header" href="#å†…ç½‘ç©¿é€å·¥å…·">å†…ç½‘ç©¿é€å·¥å…·</a></h1>
<p><a href="https://github.com/trdthg/net-piercer">net-piercer(github)</a></p>
<p>è®¾è®¡æ¶æ„å›¾</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202203262224928.svg" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="channel-æºç å‰–æ"><a class="header" href="#channel-æºç å‰–æ">Channel æºç å‰–æ</a></h1>
<h2 id="æ ‡å‡†åº“-channel"><a class="header" href="#æ ‡å‡†åº“-channel">æ ‡å‡†åº“ channel</a></h2>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202205181708400.png" alt="" /></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="too-many-lists"><a class="header" href="#too-many-lists">Too-Many-Lists</a></h1>
<h2 id="1-a-bad-stack"><a class="header" href="#1-a-bad-stack">1. A Bad Stack</a></h2>
<h3 id="å¼•ä¾‹"><a class="header" href="#å¼•ä¾‹">å¼•ä¾‹</a></h3>
<ul>
<li>ç”¨è¿™ç§æ–¹å¼ä¼šæœ‰æ ‡ç­¾å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼Œå±äºå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€çš„é»˜è®¤æ–¹æ³•</li>
<li>æ‰€ä»¥ç”¨ä¸‹é¢çš„ C-like ç»“æ„ä½“å½¢å¼å ç”¨ç©ºé—´æ›´å°ï¼Œ</li>
<li>è€Œä¸”å•ä¸ªèŠ‚ç‚¹èƒ½æ‰¿è½½æ›´å¤šå†…å®¹</li>
</ul>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[derive(Debug)]
pub enum List&lt;T&gt; {
    Empty,
    Elem(T, Box&lt;List&lt;T&gt;&gt;),
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="å®Œæ•´æ¡ˆä¾‹"><a class="header" href="#å®Œæ•´æ¡ˆä¾‹">å®Œæ•´æ¡ˆä¾‹</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 2.1. Layout
pub struct List {
    head: Link,
}
enum Link {
    Empty,
    More(Box&lt;Node&gt;),
}
struct Node {
    elem: i32,
    next: Link,
}
use std::mem;
impl List {
    // 2.2. New
    pub fn new() -&gt; Self {
        List {
            head: Link::Empty,
        }
    }
    // 2.4. Push
    pub fn push(&amp;mut self, elem: i32) {
        let new_node = Box::new(Node {
            elem,
            next: mem::replace(&amp;mut self.head, Link::Empty),
        });
        self.head = Link::More(new_node)
    }
    // 2.5. Pop
    // ç›¸æ¯”äºä¸Šä¸€ä¸ªæ›´å¸¸ç”¨è€Œä¸”æ›´ç®€æ´çš„å†™æ³•
    pub fn pop(&amp;mut self) -&gt; Option&lt;i32&gt; {
        match mem::replace(&amp;mut self.head, Link::Empty) {
            Link::Empty =&gt; None,
            Link::More(node) =&gt; {
                self.head = node.next;
                Some(node.elem)
            }
        }
    }
}

// 2.6. Testing
#[cfg(test)]
mod test {
    #[test]
    fn basics() {
        // TODO
        use super::-;
        let mut list = List::new();

        // Check empty list behaves right
        assert_eq!(list.pop(), None);

        // Populate list
        list.push(1);
        list.push(2);
        list.push(3);

        // Check normal removal
        assert_eq!(list.pop(), Some(3));
        assert_eq!(list.pop(), Some(2));

        // Push some more just to make sure nothing's corrupted
        list.push(4);
        list.push(5);

        // Check normal removal
        assert_eq!(list.pop(), Some(5));
        assert_eq!(list.pop(), Some(4));

        // check exhaustion
        assert_eq!(list.pop(), Some(1));
        assert_eq!(list.pop(), None);

        // Check drop
        list.push(1);
        list.push(2);
        list.push(3);

    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="drop-çš„æ‰‹åŠ¨ç¼–å†™"><a class="header" href="#drop-çš„æ‰‹åŠ¨ç¼–å†™">Drop çš„æ‰‹åŠ¨ç¼–å†™</a></h3>
<p>å°è¯•æ ¹æ®å°¾é€’å½’å†™å‡º drop å‡½æ•°ï¼Œå¤±è´¥</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 2.7. Drop
impl Drop for List {
    fn drop(&amp;mut self) {
        self.head.drop();
    }
}
impl Drop for Link {
    fn drop(&amp;mut self) {
        match self {
            Link::Empty =&gt; {},
            Link::More(ref mut boxed_node) =&gt; {
                boxed_node.drop();
            }
        }
    }
}
impl Drop for Box&lt;Node&gt; {
    fn drop(&amp;mut self) {
        self.ptr.drop();   // uh oh, not tail recursive!
        deallocate(self.ptr);
    }
}
impl Drop for Node {
    fn drop(&amp;mut self) {
        self.next.drop();
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>::: danger &gt;We can't drop the contents of the Box after deallocating, so there's
no way to drop in a tail-recursive manner! &gt;Instead we're going to have to
manually write an iterative drop for List that hoists nodes out of their boxes.
::: So, the next is the real way to write drop ourselfs</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Drop for List {
    fn drop(&amp;mut self) {
        println!(&quot;å¼€å§‹ drop&quot;);
        let mut cur_link = mem::replace(&amp;mut self.head, Link::Empty);
        while let Link::More(mut boxed_node) = cur_link {
            println!(&quot;{}&quot;, boxed_node.elem);
            cur_link = mem::replace(&amp;mut boxed_node.next, Link::Empty);
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="unimplemented"><a class="header" href="#unimplemented">unimplemented!</a></h3>
<p>::: warning</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// è¿”å› unimplemented!()
impl List {
    pub fn pop(&amp;mut self) -&gt; Option&lt;i32&gt; {
        match &amp;self.head {
            Link::Empty =&gt; {
                // TODO
            },
            Link::More(node) =&gt; {
                // TODO
            }
        }
        unimplemented!()
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>:::</p>
<h2 id="2-an-ok-singly-linked-stack"><a class="header" href="#2-an-ok-singly-linked-stack">2. An Ok Singly-Linked Stack</a></h2>
<h3 id="ä¼˜åŒ–ç›®æ ‡"><a class="header" href="#ä¼˜åŒ–ç›®æ ‡">ä¼˜åŒ–ç›®æ ‡</a></h3>
<ol>
<li>3.1: Option ç®€åŒ–è¯­æ³•</li>
</ol>
<ul>
<li>use Option to replace our own Enum</li>
<li>use Option.take() to replace mem::replace(&amp;self, None)</li>
<li>use option.take().map(|elem {}|) to replace match option { None =&gt; None,
Some(x) =&gt; Some(y) }</li>
</ul>
<ol start="2">
<li>3.2 Generic é€šç”¨æ€§</li>
</ol>
<ul>
<li>just use T to replace i32</li>
</ul>
<ol start="3">
<li>3.3 Peek(å·çœ‹) å®ç° peek</li>
</ol>
<ul>
<li></li>
<li>æ³¨æ„ 3 è€…çš„åŒºåˆ«</li>
<li>self.head.take() -&gt; self -&gt; Option(T)</li>
<li>self.head.as_ref() -&gt; &amp;self -&gt; Option(&amp;T)</li>
<li>self.head.as_mut() -&gt; &amp;mut self -&gt; Option(&amp;mut T)</li>
</ul>
<ol start="4">
<li>3.4 - 3.6 ä¸‰ç§è¿­ä»£å™¨</li>
</ol>
<ul>
<li>IntoIter - T</li>
<li>IterMut - &amp;mut T</li>
<li>Iter - &amp;T</li>
</ul>
<blockquote>
<p>map(): Maps an Option&lt;T&gt; to Option&lt;U&gt; by applying a function to a
contained value. as_ref()-&gt;&amp;self: Converts from &amp;Option&lt;T&gt; to
Option&lt;&amp;T&gt;. as_mut()-&gt;&amp;mut self: Converts from &amp;mut Option&lt;T&gt; to
Option&lt;&amp;mut T&gt;. take()-&gt;&amp;mut self: Takes the value out of the option,
leaving a [None] in its place</p>
</blockquote>
<h3 id="option--generic"><a class="header" href="#option--generic">Option &amp; Generic</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::mem;

#[derive(Debug)]
pub struct List&lt;T&gt; {
    head: Link&lt;T&gt;,
}

type Link&lt;T&gt; = Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;;

#[derive(Debug)]
struct Node&lt;T&gt; {
    elem: T,
    next: Link&lt;T&gt;,
}

impl&lt;T&gt; List&lt;T&gt; {
    // 2.2. New
    pub fn new() -&gt; Self {
        List { head: None }
    }
    // 2.4. Push
    pub fn push(&amp;mut self, elem: T) {
        let new_node = Box::new(Node {
            elem,
            // next: mem::replace(&amp;mut self.head, None),
            next: self.head.take(),
        });
        self.head = Some(new_node);
    }
    // 2.5. Pop
    pub fn pop(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.head.take().map(|node| {
            self.head = node.next;
            node.elem  //  node.elem not need to be wrapped by Some()
        })
    }

}
<span class="boring">}
</span></code></pre></pre>
<h3 id="peek"><a class="header" href="#peek">Peek</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; List&lt;T&gt; {
    /-
    impl&lt;T&gt; Option&lt;T&gt; {
        pub fn as_ref(&amp;self) -&gt; Option&lt;&amp;T&gt;;
    }
    -/

    pub fn peek(&amp;self) -&gt; Option&lt;&amp;T&gt; {

        // Converts from &amp;Option&lt;T&gt; to Option&lt;&amp;T&gt;.

        // self             -&gt; &amp;List
        // self.head        -&gt; &amp;Option&lt; Box&lt;Node&lt;T&gt;&gt;&gt;
        // self.head.as_ref -&gt;  Option&lt;&amp;Box&lt;Node&lt;T&gt;&gt;&gt;
        // map(node)        -&gt;         &amp;Box&lt;Node&lt;T&gt;&gt;
        // node.elem        -&gt;                   T
        // &amp;node.elem       -&gt;         &amp;         T
        // map-&gt;&amp;node.elem  -&gt;  Option&lt;&amp;         T  &gt;
        self.head.as_ref().map(|node| {
            &amp;node.elem
        })
    }
    pub fn peek_mut(&amp;mut self) -&gt; Option&lt;&amp;mut T&gt; {
        // Converts from &amp;mut Option&lt;T&gt; to Option&lt;&amp;mut T&gt;.

        // self             -&gt; &amp;mut List
        // self.head        -&gt; &amp;mut Option&lt;     Box&lt;Node&lt;T&gt;&gt;&gt;
        // self.head.as_mut -&gt;      Option&lt;&amp;mut Box&lt;Node&lt;T&gt;&gt;&gt;
        // map(node)        -&gt;             &amp;mut Box&lt;Node&lt;T&gt;&gt;
        // node.elem        -&gt;                           T
        // &amp;mut node.elem   -&gt;             &amp;mut          T
        // map-&gt;&amp;node.elem  -&gt;      Option&lt;&amp;mut          T  &gt;
        self.head.as_mut().map(|node| {
            &amp;mut node.elem
        })
    }
    pub fn peek_(&amp;mut self) -&gt; Option&lt;T&gt; {
        // warning(not sure): mut_only_in_this_fu_but_only_read_after_read
        // Takes the value out of the option, leaving a [None] in its place

        // self             -&gt; &amp;mut List
        // self.head        -&gt; &amp;mut Option&lt;     Box&lt;Node&lt;T&gt;&gt;&gt;
        // self.head.take   -&gt;      Option&lt;&amp;mut Box&lt;Node&lt;T&gt;&gt;&gt;

        // self.head        -&gt; &amp;mut Option&lt;None&gt;
        // temp             -&gt; &amp;mut Option&lt;     Box&lt;Node&lt;T&gt;&gt;&gt;

        // map(node)        -&gt;                  Box&lt;Node&lt;T&gt;&gt;
        // node.elem        -&gt;                           T
        // map-&gt;node.elem   -&gt;      Option&lt;              T  &gt;
        self.head.take().map(|node| {
            node.elem
        })
    }

}

#[test]
fn peek() {
    let mut list = List::new();
    assert_eq!(list.peek(), None);
    assert_eq!(list.peek_mut(), None);
    list.push(1); list.push(2); list.push(3);

    assert_eq!(list.peek(), Some(&amp;3));
    assert_eq!(list.peek_mut(), Some(&amp;mut 3));
    // match list.peek_mut() {
    //     Some(k) =&gt; {-k = 30},
    //     None =&gt; {}
    // }
    list.peek_mut().map(|val| {
        -val = 30;
    });
    assert_eq!(list.peek_mut(), Some(&amp;mut 30));
    if let Some(val) = list.peek_mut() {
        println!(&quot;{}&quot;, val);
        -val = 10;
    }
    assert_eq!(list.peek_mut(), Some(&amp;mut 10));
    assert_eq!(list.pop(), Some(10));
    assert_eq!(list.peek(), Some(&amp;2));
    if let Some(val) = list.peek_() {
        println!(&quot;{}&quot;, val);
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="intoiter"><a class="header" href="#intoiter">IntoIter</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 3.4 IntoIter------------------------------------------------------------------------------

pub struct IntoIter&lt;T&gt;(List&lt;T&gt;);

impl&lt;T&gt; List&lt;T&gt; {
    pub fn into_iter(self) -&gt; IntoIter&lt;T&gt; {
        IntoIter(self)
    }
}

impl&lt;T&gt; Iterator for IntoIter&lt;T&gt; {
    type Item = T;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.0.pop()
    }
}

#[test]
fn into_iter_test() {
    let mut list = List::new();
    list.push(1);
    list.push(2);
    list.push(3);
    let mut iter = list.into_iter();
    assert_eq!(iter.next(), Some(3));
    assert_eq!(iter.next(), Some(2));
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="iter"><a class="header" href="#iter">Iter</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// 3.5 Iter------------------------------------------------------------------------------
pub struct Iter&lt;'a, T&gt; {
    next: Option&lt;&amp;'a Node&lt;T&gt;&gt;
}

impl&lt;T&gt; List&lt;T&gt; {
    // 1. initial
    // pub fn iter&lt;'a&gt;(&amp;'a self) -&gt; Iter&lt;'a, T&gt; {
    // 2. apply lifetime elision
    // pub fn iter(&amp;self) -&gt; Iter&lt;T&gt; {
    // 3. Or, if you're not comfortable &quot;hiding&quot; that a struct contains a lifetime, you can use the Rust 2018 &quot;explicitly elided lifetime&quot; syntax, '_:
    pub fn iter(&amp;self) -&gt; Iter&lt;'_, T&gt; {

        // self             -&gt; &amp;List                    | self                -&gt; &amp;List
        // self.head        -&gt; &amp;Option&lt; Box&lt;Node&lt;T&gt;&gt;&gt;   | self.head           -&gt; &amp;Option&lt; Box&lt;Node&lt;T&gt;&gt;&gt;
        // self.head.as_ref -&gt;  Option&lt;&amp;Box&lt;Node&lt;T&gt;&gt;&gt;   | self.head.as_deref  -&gt; &amp;Option&lt;     Node&lt;T&gt; &gt;
        // map(node)        -&gt;         &amp;Box&lt;Node&lt;T&gt;&gt;    |
        // -node            -&gt;          Box&lt;Node&lt;T&gt;&gt;    |
        // --node           -&gt;              Node&lt;T&gt;     |
        // &amp;--node          -&gt;             &amp;Node&lt;T&gt;     |
        // map-&gt;node        -&gt;  Option&lt;    &amp;Node&lt;T&gt; &gt;   |

        // can be replaced by the next line
        Iter { next: self.head.as_ref().map(|node| { &amp;--node }) }

        // Iter { next: self.head.as_deref() }

        // node: expected struct `second::Node`, found struct `std::boxed::Box`
        // -node: expected `&amp;second::Node&lt;T&gt;`, found struct `std::boxed::Box`
        // --node: expected `&amp;second::Node&lt;T&gt;`, found struct `second::Node`
    }
}

impl&lt;'a, T&gt; Iterator for Iter&lt;'a, T&gt; {
    type Item = &amp;'a T;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {

        // self                  -&gt; &amp;mut Iter                           | self                   -&gt; &amp;mut Iter
        // self.next             -&gt; &amp;mut Option&lt;         &amp;Node&lt;T&gt; &gt;     | self.next              -&gt; &amp;mut Option&lt;         &amp;Node&lt;T&gt;&gt;
        // map(node)             -&gt; &amp;mut                 &amp;Node&lt;T&gt;       | map(node)              -&gt; &amp;mut                 &amp;Node&lt;T&gt;
        //     node.next         -&gt; &amp;mut Option&lt;         &amp;Node&lt;T&gt; &gt;     |     node.next          -&gt; &amp;mut Option&lt;     Box&lt; Node&lt;T&gt;&gt;&gt;
        //     node.next.as_ref  -&gt;      Option&lt;&amp;mut Box&lt; Node&lt;T&gt;&gt;&gt;     |     node.next.as_deref -&gt; &amp;mut Option&lt;          Node&lt;T&gt; &gt;
        //     map(inner_node)   -&gt;             &amp;mut Box&lt; Node&lt;T&gt;&gt;      |
        //     -inner_node       -&gt;                  Box&lt; Node&lt;T&gt;&gt;      |
        //     --inner_node      -&gt;                       Node&lt;T&gt;       |
        //     &amp;--inner_node     -&gt;                      &amp;Node&lt;T&gt;       |
        //     map(inner_node)   -&gt;      Option&lt;         &amp;Node&lt;T&gt; &gt;     |
        // self.next             -&gt; &amp;mut Option&lt;         &amp;Node&lt;T&gt;&gt;      | self.next              -&gt; &amp;mut Option&lt;&amp; Node&lt;T&gt;&gt;
        // node.elem             -&gt; &amp;mut                       T        |
        // &amp;node.elem            -&gt; &amp;mut                      &amp;T        |
        // map-&gt;&amp;node.elem       -&gt; &amp;mut Option&lt;              &amp;T &gt;      |

        self.next.map(|node| {
            self.next = (-node).next.as_ref().map(|node| &amp;--node);
            // self.next = node.next.as_deref();
            // self.next = node.next.as_ref().map::&lt;&amp;Node&lt;T&gt;, _&gt;(|node| &amp;node);
            // node.next = Some(Box::new(Node{elem: 1, next: None}));
            &amp;node.elem
        })
    }
}

#[test]
fn iter() {
    let mut list = List::new();
    list.push(1); list.push(2); list.push(3);

    let mut iter = list.iter();
    assert_eq!(iter.next(), Some(&amp;3));
    assert_eq!(iter.next(), Some(&amp;2));
    assert_eq!(iter.next(), Some(&amp;1));
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="3-a-persistent-stack"><a class="header" href="#3-a-persistent-stack">3. A Persistent Stack</a></h2>
<h3 id="å®ç°ç›®æ ‡"><a class="header" href="#å®ç°ç›®æ ‡">å®ç°ç›®æ ‡</a></h3>
<pre><code>list1 = A -&gt; B -&gt; C -&gt; D
list2 = tail(list1) = B -&gt; C -&gt; D
list3 = push(list2, X) = X -&gt; B -&gt; C -&gt; D

list1 -&gt; A ---+
              |
              v
list2 ------&gt; B -&gt; C -&gt; D
              ^
              |
list3 -&gt; X ---+
</code></pre>
<h3 id="basic"><a class="header" href="#basic">Basic</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use std::rc::Rc;
// basic -------------------------------------------------------------------
pub struct List&lt;T&gt; {
    head: Link&lt;T&gt;
}

type Link&lt;T&gt; = Option&lt;Rc&lt;Node&lt;T&gt;&gt;&gt;;

struct Node&lt;T&gt; {
    elem: T,
    next: Link&lt;T&gt;,
}

impl&lt;T&gt; List&lt;T&gt; {
    pub fn new() -&gt; List&lt;T&gt; {
        List { head: None }
    }
    pub fn prepend(&amp;self, elem: T) -&gt; List&lt;T&gt; {
        List { head: Some(Rc::new(Node { elem, next: self.head.clone() })) }
    }
    pub fn tail(&amp;self) -&gt; List&lt;T&gt; {
        List { head: self.head.as_ref().and_then(|node| node.next.clone()) }
    }
    pub fn head(&amp;self) -&gt; Option&lt;&amp;T&gt; {
        self.head.as_ref().map(|node| &amp;node.elem)
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="iter-1"><a class="header" href="#iter-1">Iter</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Iter ------------------------------------------------------------------
pub struct Iter&lt;'a, T&gt; {
    next: Option&lt;&amp;'a Node&lt;T&gt;&gt;
}
impl&lt;'a, T&gt; Iterator for Iter&lt;'a, T&gt; {
    type Item = &amp;'a T;
    fn next(&amp;mut self) -&gt; Option&lt;&amp;'a T&gt; {
        self.next.map(|node| {
            self.next = node.next.as_ref().map(|node| &amp;--node);
            &amp;node.elem
        })
    }
}
impl&lt;T&gt; List&lt;T&gt; {
    pub fn iter(&amp;self) -&gt; Iter&lt;T&gt; {
        Iter { next: self.head.as_ref().map(|node| &amp;--node) }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="drop-1"><a class="header" href="#drop-1">Drop</a></h3>
<p>å¤šäº†åˆ¤æ–­ ref count çš„è¿‡ç¨‹</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// drop ------------------------------------------------------------
impl&lt;T&gt; Drop for List&lt;T&gt; {
    fn drop(&amp;mut self) {
        let mut head = self.head.take();
        while let Some(node) = head {
            if let Ok(mut node) = Rc::try_unwrap(node) {
                head = node.next.take();
            } else {
                break
            }
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="test-1"><a class="header" href="#test-1">Test</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[cfg(Test)]
mod test {
    use super::List;
    #[test]
    fn basics_test() {
        let list = List::new();
        list.prepend(1).prepend(2).prepend(3);

        assert_eq!(list.head(), Some(&amp;3));
        let list = list.tail();
        assert_eq!(list.head(), Some(&amp;2));
        let list = list.tail();
        assert_eq!(list.head(), Some(&amp;1));
        let list = list.tail();
        assert_eq!(list.head(), None);
        let list = list.tail();
        assert_eq!(list.head(), None);
    }
    #[test]
    fn iter_test() {
        let list = List::new().prepend(1).prepend(2).prepend(3);

        let mut iter = list.iter();
        assert_eq!(iter.next(), Some(&amp;3));
        assert_eq!(iter.next(), Some(&amp;2));
        assert_eq!(iter.next(), Some(&amp;1));
    }

}
<span class="boring">}
</span></code></pre></pre>
<h2 id="4-a-bad-safe-deque"><a class="header" href="#4-a-bad-safe-deque">4. A Bad Safe Deque</a></h2>
<p>åŠ å…¥äº† Rc å’Œ RefCell</p>
<h3 id="layout"><a class="header" href="#layout">Layout</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>se std::rc::Rc;
use std::cell::{ Ref, RefMut, RefCell };

pub struct List&lt;T&gt; {
    head: Link&lt;T&gt;,
    tail: Link&lt;T&gt;,
}

type Link&lt;T&gt; = Option&lt;Rc&lt;RefCell&lt;Node&lt;T&gt;&gt;&gt;&gt;;

struct Node&lt;T&gt; {
    elem: T,
    next: Link&lt;T&gt;,
    prev: Link&lt;T&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="basic-1"><a class="header" href="#basic-1">Basic</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; List&lt;T&gt; {
    pub fn new() -&gt; List&lt;T&gt; {
        List { head: None, tail: None }
    }
    // 5.2 Building ä¸‹`
    pub fn push_front(&amp;mut self, elem: T) {
        let new_head = Node::new(elem);
        match self.head.take() {
            Some(old_head) =&gt; {
                old_head.borrow_mut().prev = Some(new_head.clone());
                new_head.borrow_mut().next = Some(old_head);
                self.head = Some(new_head);
            },
            None =&gt; {
                self.head = Some(new_head.clone());
                self.tail = Some(new_head);
            }
        }
    }
    // 5.3 Breaking
    pub fn pop_front(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.head.take().map(|old_head| {
            // ä¸´æ—¶å€Ÿç”¨ old_headï¼Œå¹¶ take äº† next çš„ ownership
            match old_head.borrow_mut().next.take() {
                Some(new_head) =&gt; {
                    new_head.borrow_mut().prev = None;
                    self.head = Some(new_head);
                }
                None =&gt; {
                    self.tail.take();
                }
            }
            Rc::try_unwrap(old_head).ok().unwrap().into_inner().elem
        })
    }
    // 5.4 Peeking
    // pub fn peek(&amp;self) -&gt; Option&lt;&amp;T&gt; {
    //     self.head.as_ref().map(|node| {
    //         // Rc::try_unwrap(node).ok().unwrap().into_inner().elem
    //         // &amp;node.borrow().elem
    //     })
    // }
    pub fn peek_front(&amp;self) -&gt; Option&lt;Ref&lt;T&gt;&gt; {
        self.head.as_ref().map(|node| {
            Ref::map(node.borrow(), |node| &amp;node.elem)
        })
    }
    pub fn peek_front_mut(&amp;mut self) -&gt; Option&lt;RefMut&lt;T&gt;&gt; {
        self.head.as_ref().map(|node| {
            RefMut::map(node.borrow_mut(), |node| &amp;mut node.elem)
        })
    }
    // Back ---------------------------------------------------------
    pub fn push_back(&amp;mut self, elem: T) {
        let new_tail = Node::new(elem);
        match self.tail.take() {
            Some(old_tail) =&gt; {
                old_tail.borrow_mut().next = Some(new_tail.clone());
                new_tail.borrow_mut().prev = Some(old_tail.clone());
                self.tail = Some(new_tail);
            }
            None =&gt; {
                self.head = Some(new_tail.clone());
                self.tail = Some(new_tail);
            }
        }
    }
    pub fn pop_back(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.tail.take().map(|old_tail| {
            match old_tail.borrow_mut().prev.take() {
                Some(new_tail) =&gt; {
                    new_tail.borrow_mut().next.take();
                    self.tail = Some(new_tail);
                }
                None =&gt; {
                    self.head = None;
                }
            }
            Rc::try_unwrap(old_tail).ok().unwrap().into_inner().elem
        })
    }
    pub fn peek_back(&amp;self) -&gt; Option&lt;Ref&lt;T&gt;&gt; {
        self.tail.as_ref().map(|node| {
            Ref::map(node.borrow(), |node| &amp;node.elem)
        })
    }
    pub fn peek_back_mut(&amp;mut self) -&gt; Option&lt;RefMut&lt;T&gt;&gt; {
        self.tail.as_ref().map(|node| {
            RefMut::map(node.borrow_mut(), |node| &amp;mut node.elem)
        })
    }
}

impl&lt;T&gt; Node&lt;T&gt; {
    pub fn new(elem: T) -&gt; Rc&lt;RefCell&lt;Node&lt;T&gt;&gt;&gt; {
        Rc::new(RefCell::new(Node {
            elem,
            next:None,
            prev: None,
        }))
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="drop-2"><a class="header" href="#drop-2">Drop</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl&lt;T&gt; Drop for List&lt;T&gt; {
    fn drop(&amp;mut self) {
        while self.pop_front().is_some() {}
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="iterator"><a class="header" href="#iterator">Iterator</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// å¦ä¸€ä¸ªæ–¹å‘ç›´æ¥å®ç° DoubleEndedIterator Trait å°±è¡Œ
// IntoIter
pub struct IntoIter&lt;T&gt;(List&lt;T&gt;);

impl&lt;T&gt; List&lt;T&gt; {
    pub fn into_iter(self) -&gt; IntoIter&lt;T&gt; {
        IntoIter(self)
    }
}

// natural
impl&lt;T&gt; Iterator for IntoIter&lt;T&gt; {
    type Item = T;
    fn next(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.0.pop_front()
    }
}
// reverse
impl&lt;T&gt; DoubleEndedIterator for IntoIter&lt;T&gt; {
    fn next_back(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.0.pop_back()
    }
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="iterdanger"><a class="header" href="#iterdanger">Iter(danger)</a></h3>
<p>:::warning</p>
<p>æ— æ³•å®ç°è€Œä¸”æ ¹æœ¬çœ‹ä¸æ‡‚ï¼Œä¸€å¤´é›¾æ°´</p>
<p>:::</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Iter
pub struct Iter&lt;'a, T&gt;(Option&lt;Ref&lt;'a, Node&lt;T&gt;&gt;&gt;);

impl&lt;T&gt; List&lt;T&gt; {
    pub fn iter(&amp;self) -&gt; Iter&lt;T&gt; {
        Iter(self.head.as_ref().map(|head| {head.borrow()}))
        // è‹¥ä¸º Ref&lt;T&gt;
        // Iter(self.head.as_ref().map(|head| {Ref::map(head.borrow(), |head| &amp;head.elem)}))
    }
}

impl&lt;'a, T&gt; Iterator for Iter&lt;'a, T&gt; {
    type Item = Ref&lt;'a, T&gt;;
    fn next(&amp;mut self) -&gt; Option&lt;Ref&lt;'a, T&gt;&gt; {
        self.0.take().map(|node_ref| {
            // self.0 = node_ref.next.as_ref().map(|head| {head.borrow()});
            // // node_ref åœ¨é—­åŒ…å†…è¢«å€Ÿç”¨
            // Ref::map(node_ref, |node| &amp;node.elem)
            // // node_ref åœ¨é—­åŒ…å¤–å†æ¬¡è¢«å€Ÿç”¨
            let (next, elem) = Ref::map_split(node_ref, |node| {
                (&amp;node.next, &amp;node.elem)
            });
            self.0 = next.as_ref().map(|head| head.borrow());
            elem
        })
    }
}
<span class="boring">}
</span></code></pre></pre>
<h2 id="5-an-unsafe-queue"><a class="header" href="#5-an-unsafe-queue">5. An Unsafe Queue</a></h2>
<h3 id="51-safe-rust"><a class="header" href="#51-safe-rust">5.1 Safe Rust</a></h3>
<p>Well, pushing is actually fine.</p>
<h4 id="push"><a class="header" href="#push">push</a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// An Unsafe Queue

/-
input list:
[Some(ptr)] -&gt; (A, Some(ptr)) -&gt; (B, None)

flipped push X:
[Some(ptr)] -&gt; (A, Some(ptr)) -&gt; (B, Some(ptr)) -&gt; (X, None)

-/

// Layout
pub struct List&lt;'a, T&gt; {
    head: Link&lt;T&gt;,
    tail: Option&lt;&amp;'a mut Node&lt;T&gt;&gt;,
}

type Link&lt;T&gt; = Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;;

struct Node&lt;T&gt; {
    elem: T,
    next: Link&lt;T&gt;,
}

// Basic
impl&lt;'a, T&gt; List&lt;'a, T&gt; {
    pub fn new() -&gt; List&lt;'a, T&gt; {
        List { head: None, tail: None }
    }

    pub fn push(&amp;'a mut self, elem: T) {
        let new_tail = Box::new(Node {
            elem: elem,
            // When you push onto the tail, your next is always None
            next: None,
        });

        // Put the box in the right place, and then grab a reference to its Node
        match self.tail.take() {
            Some(old_tail) =&gt; {
                // If the old tail existed, update it to point to the new tail
                old_tail.next = Some(new_tail);
                self.tail = old_tail.next.as_deref_mut()
            }
            None =&gt; {
                // Otherwise, update the head to point to it
                self.head = Some(new_tail);
                self.tail = self.head.as_deref_mut()
            }
        };
    }
}
<span class="boring">}
</span></code></pre></pre>
<blockquote>
<p>However pop is another story. If they're popping elements outside of our
range, it should still be fine. We can't see those nodes so nothing will
happen. However if they try to pop off the node we're pointing at...
&gt;everything will blow up! In particular when they go to unwrap the result of
the try_unwrap, it will actually fail, and the whole program will panic.</p>
</blockquote>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub fn pop(&amp;mut self) -&gt; Option&lt;T&gt; {
    self.head.take().map(|head| {
        let head = -head;
        self.head = head.next;
        if self.head.is_none() {
            self.tail = None;
        }
        head.elem
    })
}
<span class="boring">}
</span></code></pre></pre>
<h3 id="52-unsafe-rust"><a class="header" href="#52-unsafe-rust">5.2 Unsafe Rust</a></h3>
<h4 id="layout-1"><a class="header" href="#layout-1">Layout</a></h4>
<pre><code class="language-rus">// Layout
pub struct List&lt;T&gt; {
    head: Link&lt;T&gt;,
    tail: -mut Node&lt;T&gt;,
}

type Link&lt;T&gt; = Option&lt;Box&lt;Node&lt;T&gt;&gt;&gt;;

struct Node&lt;T&gt; {
    elem: T,
    next: Link&lt;T&gt;,
}

use std::ptr;
impl&lt;T&gt; List&lt;T&gt; {
    pub fn new() -&gt; Self {
        List { head: None, tail:  ptr::null_mut()}
    }
    pub fn push(&amp;mut self, elem: T) {
        let mut new_tail = Box::new(Node {
            elem,
            next: None,
        });

        let raw_tail: -mut _ = &amp;mut -new_tail;
        if !self.tail.is_null() {
            unsafe {
                (-self.tail).next = Some(new_tail);
            }
        } else {
            self.head = Some(new_tail);
        }
        self.tail = raw_tail;
    }
    pub fn pop(&amp;mut self) -&gt; Option&lt;T&gt; {
        self.head.take().map(|head| {
            let head = -head;
            self.head = head.next;
            if self.head.is_none() {
                self.tail = ptr::null_mut()
            };
            head.elem
        })
    }
}
</code></pre>
<h4 id="extras"><a class="header" href="#extras">Extras</a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct IntoIter&lt;T&gt;(List&lt;T&gt;);

pub struct Iter&lt;'a, T&gt; {
    next: Option&lt;&amp;'a Node&lt;T&gt;&gt;
}

pub struct IterMut&lt;'a, T&gt; {
    next: Option&lt;&amp;'a mut Node&lt;T&gt;&gt;
}

impl&lt;T&gt; List&lt;T&gt; {
    pub fn peek(&amp;self) -&gt; Option&lt;&amp;T&gt; {
        self.head.as_ref().map(|node| {
            &amp;node.elem
        })
    }
    pub fn peek_mut(&amp;mut self) -&gt; Option&lt;&amp;mut T&gt; {
        self.head.as_mut().map(|node| {
            &amp;mut node.elem
        })
    }
    pub fn into_iter(self) -&gt; IntoIter&lt;T&gt; {
        IntoIter(self)
    }
    pub fn iter(&amp;self) -&gt; Iter&lt;T&gt; {
        Iter { next: self.head.as_deref() }
    }
    pub fn iter_mut(&amp;mut self) -&gt; IterMut&lt;T&gt; {
        IterMut { next: self.head.as_deref_mut() }
    }
}

impl&lt;T&gt; Iterator for IntoIter&lt;T&gt; {
    type Item = T;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.0.pop()
    }
}
impl&lt;'a, T&gt; Iterator for Iter&lt;'a, T&gt; {
    type Item = &amp;'a T;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.next.map(|node| {
            self.next = node.next.as_deref();
            &amp;node.elem
        })
    }
}
impl&lt;'a, T&gt; Iterator for IterMut&lt;'a, T&gt; {
    type Item = &amp;'a mut T;
    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt; {
        self.next.take().map(|node| {
            self.next = node.next.as_deref_mut();
            &amp;mut node.elem
        })
    }
}
<span class="boring">}
</span></code></pre></pre>
<h4 id="test-2"><a class="header" href="#test-2">test</a></h4>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod test {
    use super::List;
    #[test]
    fn basics() {
        let mut list = List::new();

        // Check empty list behaves right
        assert_eq!(list.pop(), None);

        // Populate list
        list.push(1);
        list.push(2);
        list.push(3);

        // Check normal removal
        assert_eq!(list.pop(), Some(1));
        assert_eq!(list.pop(), Some(2));

        // Push some more just to make sure nothing's corrupted
        list.push(4);
        list.push(5);

        // Check normal removal
        assert_eq!(list.pop(), Some(3));
        assert_eq!(list.pop(), Some(4));

        // Check exhaustion
        assert_eq!(list.pop(), Some(5));
        assert_eq!(list.pop(), None);
    }
    #[test]
    fn into_iter() {
        let mut list = List::new();
        list.push(1); list.push(2); list.push(3);

        let mut iter = list.into_iter();
        assert_eq!(iter.next(), Some(1));
        assert_eq!(iter.next(), Some(2));
        assert_eq!(iter.next(), Some(3));
        assert_eq!(iter.next(), None);
    }

    #[test]
    fn iter() {
        let mut list = List::new();
        list.push(1); list.push(2); list.push(3);

        let mut iter = list.iter();
        assert_eq!(iter.next(), Some(&amp;1));
        assert_eq!(iter.next(), Some(&amp;2));
        assert_eq!(iter.next(), Some(&amp;3));
        assert_eq!(iter.next(), None);
    }

    #[test]
    fn iter_mut() {
        let mut list = List::new();
        list.push(1); list.push(2); list.push(3);

        let mut iter = list.iter_mut();
        assert_eq!(iter.next(), Some(&amp;mut 1));
        assert_eq!(iter.next(), Some(&amp;mut 2));
        assert_eq!(iter.next(), Some(&amp;mut 3));
        assert_eq!(iter.next(), None);
    }
}
<span class="boring">}
</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rust-1"><a class="header" href="#rust-1">rust</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="riscv-1"><a class="header" href="#riscv-1">riscv</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="riscv-2"><a class="header" href="#riscv-2">riscv</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è¿œç¨‹-usb"><a class="header" href="#è¿œç¨‹-usb">è¿œç¨‹ USB</a></h1>
<p>https://unix.stackexchange.com/questions/201757/how-can-i-set-up-a-usb-proxy-for-dev-ttyusb0-over-the-network
https://cygwin.com/cygwin-ug-net/using-specialnames.html#pathnames-posixdevices</p>
<h2 id="socat"><a class="header" href="#socat">socat</a></h2>
<ul>
<li>linux
<ul>
<li>socat</li>
</ul>
</li>
<li>windows
<ul>
<li>com2tcp</li>
<li>socat-windows</li>
</ul>
</li>
</ul>
<pre><code class="language-make">get-remote-usb:
        ssh nixos &quot;socat PTY,raw,echo=0,link=/home/trdthg/tmp/dev/ttyVUSB0 tcp:47.94.225.51:50100&quot;
set-remote-usb:
        socat.exe /dev/ttyS11,raw,echo=0 tcp-listen:50100,reuseaddr
set-remote-usb2:
        com2tcp.bat --baud 460800 COM12 50100
set-frp:
        frpc -c C:/Users/trdth/github/frp/frpc.ini
</code></pre>
<h2 id="usbip"><a class="header" href="#usbip">usbip</a></h2>
<ul>
<li>
<p>linux: just install</p>
</li>
<li>
<p>windows: usbip-win https://github.com/cezanne/usbip-win
https://usbip.sourceforge.net/</p>
</li>
<li>
<p>https://www.linux-magazine.com/Issues/2018/208/Tutorial-USB-IP</p>
</li>
<li>
<p>https://pluhuxc.github.io/2018/11/01/usbip.html</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="èµ„æºæ•´ç†"><a class="header" href="#èµ„æºæ•´ç†">èµ„æºæ•´ç†</a></h1>
<ul>
<li><a href="https://tech.meituan.com/2017/04/21/mt-leaf.html">Leafâ€”â€”ç¾å›¢ç‚¹è¯„åˆ†å¸ƒå¼ ID ç”Ÿæˆç³»ç»Ÿ</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="linux-å‘è¡Œç‰ˆé…ç½®"><a class="header" href="#linux-å‘è¡Œç‰ˆé…ç½®">Linux å‘è¡Œç‰ˆé…ç½®</a></h1>
<h2 id="nixos"><a class="header" href="#nixos">nixos</a></h2>
<h3 id="å®‰è£…æ³¨æ„"><a class="header" href="#å®‰è£…æ³¨æ„">å®‰è£…æ³¨æ„</a></h3>
<p>åœ¨æ‰§è¡Œæœ€åçš„ <code>nixos-install</code> ä¹‹å‰è®°å¾—æ‰“å¼€ç½‘ç»œè®¾ç½®ï¼Œä¸ç„¶å°±è¦é‡è£…</p>
<h3 id="ç½‘ç»œè®¾ç½®"><a class="header" href="#ç½‘ç»œè®¾ç½®">ç½‘ç»œè®¾ç½®</a></h3>
<pre><code class="language-sh">systemctl start wpa_supplicant

wpa_cli
add_network
set_network 0 ssid | psk | key_mgmt

WPA-PSK

list_network
enable_network 0
</code></pre>
<p>å…³é—­è®¾å¤‡ï¼ˆwifiï¼‰è¢«ç¦ç”¨</p>
<pre><code class="language-sh">rfkill list
rfkill unblock all
</code></pre>
<h3 id="äº®åº¦è®¾ç½®"><a class="header" href="#äº®åº¦è®¾ç½®">äº®åº¦è®¾ç½®</a></h3>
<pre><code class="language-sh">programs.light.enable = true;
</code></pre>
<pre><code class="language-sh">light -U 30 # darker.
light -A 30 # brighter.
</code></pre>
<h3 id="éŸ³é‡è°ƒèŠ‚"><a class="header" href="#éŸ³é‡è°ƒèŠ‚">éŸ³é‡è°ƒèŠ‚</a></h3>
<pre><code class="language-sh">
alsamixer

amixer set Master mute
amixer set Master unmute
amixer set Master 10%
amixer set Master 20%
</code></pre>
<h2 id="i3wm"><a class="header" href="#i3wm">i3wm</a></h2>
<h3 id="å¤šå±å¹•"><a class="header" href="#å¤šå±å¹•">å¤šå±å¹•</a></h3>
<pre><code class="language-sh">xrandr
xrandr --output DP-1 --auto --right-of eDP-1
</code></pre>
<h2 id="manjaro"><a class="header" href="#manjaro">manjaro</a></h2>
<h3 id="cpu-è°ƒé¢‘"><a class="header" href="#cpu-è°ƒé¢‘">cpu è°ƒé¢‘</a></h3>
<ol>
<li>æŸ¥çœ‹å½“å‰æ‰€æœ‰ CPU çš„ä¿¡æ¯ï¼š</li>
</ol>
<pre><code class="language-shell">cpupower -c all frequency-info
</code></pre>
<ol start="2">
<li>è®¾ç½®æ‰€æœ‰ CPU ä¸ºæ€§èƒ½æ¨¡å¼ï¼š</li>
</ol>
<pre><code class="language-shell">cpupower -c all frequency-set -g performance
</code></pre>
<ul>
<li>
<p>performance: å›ºå®šæœ€é«˜è¿è¡Œé¢‘ç‡ä¸Šï¼Œä¸åŠ¨æ€è°ƒèŠ‚ã€‚</p>
</li>
<li>
<p>powersave: å›ºå®šå·¥ä½œåœ¨å…¶æ”¯æŒçš„æœ€ä½è¿è¡Œé¢‘ç‡ä¸Š</p>
</li>
<li>
<p>ondemand: æŒ‰éœ€å¿«é€ŸåŠ¨æ€è°ƒæ•´ CPU é¢‘ç‡ï¼Œä¸€æœ‰ cpu è®¡ç®—é‡çš„ä»»åŠ¡ï¼Œå°±ä¼šç«‹å³è¾¾åˆ°æœ€å¤§é¢‘ç‡è¿è¡Œï¼Œç­‰æ‰§è¡Œå®Œæ¯•å°±ç«‹å³å›åˆ°æœ€ä½é¢‘ç‡ï¼›</p>
</li>
<li>
<p>conservative:
ä¸ ondemand ä¸åŒï¼Œå¹³æ»‘åœ°è°ƒæ•´ CPU é¢‘ç‡ï¼Œé¢‘ç‡çš„å‡é™æ˜¯æ¸å˜å¼çš„ï¼Œä¼šè‡ªåŠ¨åœ¨é¢‘ç‡ä¸Šä¸‹é™è°ƒæ•´ï¼Œå’Œ ondemand çš„åŒºåˆ«åœ¨äºå®ƒä¼šæŒ‰éœ€åˆ†é…é¢‘ç‡ï¼Œè€Œä¸æ˜¯ä¸€å‘³è¿½æ±‚æœ€é«˜é¢‘ç‡ï¼›</p>
</li>
</ul>
<h3 id="è‡ªåŠ¨æŒ‚è½½"><a class="header" href="#è‡ªåŠ¨æŒ‚è½½">è‡ªåŠ¨æŒ‚è½½</a></h3>
<pre><code class="language-shell"># 100mb è™šæ‹Ÿç¡¬ç›˜
mount tmpfs in /home/trdthg/tmp/
tmpfs /home/trdthg/tmp tmpfs size=96m 0 0

# 1.æŸ¥çœ‹ç”µè„‘ä¸­æ‰€æœ‰ç¡¬ç›˜çš„åˆ†åŒºæƒ…å†µã€‚
# å‘½ä»¤å¦‚ä¸‹ï¼š
# sudo fdisk -l
# 2.ç»“æœå¦‚ä¸‹
# /dev/nvme0n1p3    567296  210282495 209715200   100G Microsoft åŸºæœ¬æ•°æ®
# /dev/nvme0n1p4 210282496  872337407 662054912 315.7G Microsoft åŸºæœ¬æ•°æ®

#auto mount windows fs
/dev/nvme0n1p3 /mnt/C ntfs nls=utf8,umask=000   0   0
/dev/nvme0n1p4 /mnt/D ntfs nls=utf8,umask=000   0   0

# æ³¨ï¼š æœ«å°¾çš„ 2 è¡Œæ˜¯æ·»åŠ çš„å†…å®¹ã€‚å…¶ä¸­/dev/nvme0n1p3 ä¸€è¡Œä»£è¡¨ C ç›˜åˆ†åŒºå°†è‡ªåŠ¨æŒ‚è½½åˆ°/mnt/C ç›®å½•ä¸‹ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸º NTFSï¼ˆå¦‚æœæ­¥éª¤ 1 ä¸­æŸ¥çœ‹åˆ† åŒºçš„æ–‡ä»¶ç³»ç»Ÿä¸º FAT32 æ—¶ï¼Œæ­¤å¤„è¯·å†™ vfatï¼‰ï¼Œå­—ç¬¦ç¼–ç ä¸º utf8ã€‚umask è¡¨ç¤ºæ–‡ä»¶ç›®å½•çš„æƒé™ï¼Œæ­¤å‚æ•°ä»¥åŠä¹‹åçš„ 2 ä¸ªå‚æ•°éƒ½ä¸º 0 å³å¯ã€‚ä»¥ä¸‹å‡ è¡Œä»¥ æ­¤ç±»æ¨ã€‚æ­¤å¤„å¯ä»¥é€‰æ‹©æ€§çš„æ·»åŠ éœ€è¦è‡ªåŠ¨æŒ‚è½½çš„åˆ†åŒºï¼Œä¸æƒ³æŒ‚è½½çš„åˆ†åŒºä¸ç”¨ä¹¦å†™ã€‚
</code></pre>
<h3 id="openssh-serversshd-å¯åŠ¨"><a class="header" href="#openssh-serversshd-å¯åŠ¨">openssh-server(sshd) å¯åŠ¨</a></h3>
<h3 id="openssh"><a class="header" href="#openssh">OpenSSH</a></h3>
<p>OpenSSH å¯ä»¥æ”¯æ’‘ Manjaro æˆä¸º SSH Serverï¼Œä»¥ä¾¿å…¶ä»–ä¸»æœºå¯ä»¥é€šè¿‡ SSH è¿æ¥åˆ° Manjaroã€‚</p>
<pre><code class="language-shell"># å®‰è£… OpenSSH
sudo pacman -S openssh
# å¼€æœºè‡ªå¯ sshd æœåŠ¡
sudo systemctl enable sshd
# å¯åŠ¨ sshd æœåŠ¡
sudo systemctl start sshd
# é‡å¯ sshd æœåŠ¡
sudo systemctl restart sshd
</code></pre>
<h2 id="gamepad"><a class="header" href="#gamepad">gamepad</a></h2>
<p>é©±åŠ¨ä¸‹è½½ï¼šxboxdrv</p>
<p>è“ç‰™ï¼š</p>
<pre><code class="language-txt">bluetoothctl pair &lt;mac_addr&gt;
bluetoothctl connect &lt;mac_addr&gt;
bluetoothctl remove &lt;mac_addr&gt;
bluetoothctl trust &lt;mac_addr&gt;
</code></pre>
<p><a href="https://zhongguo.eskere.club/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8bluetoothctl%E5%9C%A8linux%E4%B8%8A%E7%AE%A1%E7%90%86%E8%93%9D%E7%89%99%E8%AE%BE%E5%A4%87/2021-05-16/">å¦‚ä½•ä½¿ç”¨ bluetoothctl åœ¨ Linux ä¸Šç®¡ç†è“ç‰™è®¾å¤‡</a></p>
<p>æµ‹è¯•ï¼š</p>
<p><a href="https://www.shumeijiang.com/2021/08/04/%E6%A0%91%E8%8E%93%E6%B4%BE%E5%92%8C%E6%89%8B%E6%9F%84-%E8%93%9D%E7%89%99%E8%BF%9E%E6%8E%A5.html">æ ‘è“æ´¾å’Œæ‰‹æŸ„ - è“ç‰™è¿æ¥</a></p>
<p>èµ„æ–™ï¼š</p>
<p><a href="https://www.makeuseof.com/tag/get-game-controllers-running-linux/">How to Set Up and Use Game Controllers on Linux</a>
<a href="https://wiki.archlinux.org/title/Gamepad">Arch-Wiki Gamepad</a>
<a href="https://help.wooting.io/en/article/guide-configuring-xinput-support-for-linux-69m32u/">Guide â€“ Configuring XInput support for Linux</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ•°æ®åº“å­˜å‚¨å¼•æ“"><a class="header" href="#æ•°æ®åº“å­˜å‚¨å¼•æ“">æ•°æ®åº“å­˜å‚¨å¼•æ“</a></h1>
<h2 id="bitcast"><a class="header" href="#bitcast">Bitcast</a></h2>
<ul>
<li>æ—¥å¿—å‹</li>
<li>åŸºäº hash è¡¨</li>
</ul>
<ol>
<li>åªæ”¯æŒè¿½åŠ 
Bitcast ä»…æ”¯æŒè¿½åŠ æ“ä½œï¼ˆAppend-onlyï¼‰ï¼Œå³æ‰€æœ‰çš„å†™æ“ä½œåªè¿½åŠ è€Œä¸ä¿®æ”¹è€çš„æ•°æ®ã€‚</li>
<li>å¤šç‰ˆæœ¬æ–‡ä»¶
<ul>
<li>æ¯ä¸ªæ–‡ä»¶æœ‰ä¸€å®šçš„å¤§å°é™åˆ¶ï¼Œå½“æ–‡ä»¶å¢åŠ åˆ°ç›¸åº”çš„å¤§å°æ—¶ï¼Œå°±ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œè€çš„æ–‡ä»¶åªè¯»ä¸å†™ã€‚</li>
<li>åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶æ˜¯å¯å†™çš„ï¼Œç”¨äºæ•°æ®è¿½åŠ ï¼Œç§°ä¸ºæ´»è·ƒæ•°æ®æ–‡ä»¶ï¼ˆactive data fileï¼‰ã€‚è€Œå…¶ä»–å·²ç»è¾¾åˆ°å¤§å°é™åˆ¶çš„æ–‡ä»¶ï¼Œç§°ä¸ºè€æ•°æ®æ–‡ä»¶ï¼ˆolder data fileï¼‰ã€‚</li>
</ul>
</li>
<li>æ—¥å¿—æ–‡ä»¶
<ul>
<li>Bitcast æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®æ˜¯ä¸€æ¡ä¸€æ¡çš„ &quot;æ“ä½œ&quot;, æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåºåˆ—åŒ–åˆ°æ—¥å¿—æ–‡ä»¶é‡Œ (åŒ…æ‹¬åˆ é™¤).</li>
<li>å†™å…¥æ—¶é¦–å…ˆå°† Key-Value è®°å½•è¿½åŠ åˆ°æ´»è·ƒæ•°æ®æ–‡ä»¶çš„æœ«å°¾ï¼Œæ¥ç€æ›´æ–°å†…å­˜å“ˆå¸Œè¡¨ï¼Œå› æ­¤ï¼Œæ¯ä¸ªå†™æ“ä½œæ€»å…±éœ€è¦è¿›è¡Œä¸€æ¬¡é¡ºåºçš„ç£ç›˜å†™å…¥å’Œä¸€æ¬¡å†…å­˜æ“ä½œã€‚</li>
</ul>
</li>
<li>æ—¥å¿—å‹ç¼©
<ul>
<li>Bitcask éœ€è¦å®šæœŸæ‰§è¡Œåˆå¹¶ï¼ˆCompactionï¼‰æ“ä½œä»¥å®ç°åƒåœ¾å›æ”¶ã€‚</li>
<li>åˆå¹¶æ“ä½œï¼Œå³å°†æ‰€æœ‰è€æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®æ‰«æä¸€éå¹¶ç”Ÿæˆæ–°çš„æ•°æ®æ–‡ä»¶ï¼ŒåŒä¸€ä¸ª key çš„å¤šä¸ªæ“ä½œä»¥åªä¿ç•™æœ€æ–°ä¸€ä¸ªçš„åŸåˆ™è¿›è¡Œåˆ é™¤ï¼Œæ¯æ¬¡åˆå¹¶åï¼Œæ–°ç”Ÿæˆçš„æ•°æ®æ–‡ä»¶å°±ä¸å†æœ‰å†—ä½™æ•°æ®äº†ã€‚</li>
</ul>
</li>
<li>hash ç´¢å¼•
<ul>
<li>å“ˆå¸Œç´¢å¼•å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¦‚æœä¸åšé¢å¤–çš„å·¥ä½œï¼ŒæœåŠ¡å™¨æ–­ç”µé‡å¯é‡å»ºå“ˆå¸Œè¡¨éœ€è¦æ‰«æä¸€éæ•°æ®æ–‡ä»¶</li>
<li>å¦‚æœæ•°æ®æ–‡ä»¶å¾ˆå¤§ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚å¯ä»¥é€šè¿‡ç´¢å¼•æ–‡ä»¶ï¼ˆhint fileï¼‰æ¥æé«˜é‡å»ºå“ˆå¸Œè¡¨çš„é€Ÿåº¦ã€‚</li>
</ul>
</li>
</ol>
<h2 id="lsm"><a class="header" href="#lsm">LSM</a></h2>
<h3 id="æ ¸å¿ƒæ€æƒ³"><a class="header" href="#æ ¸å¿ƒæ€æƒ³">æ ¸å¿ƒæ€æƒ³</a></h3>
<p><strong>æ”¾å¼ƒéƒ¨åˆ†è¯»èƒ½åŠ›ï¼Œæ¢å–å†™å…¥çš„æœ€å¤§åŒ–èƒ½åŠ›</strong></p>
<p>å…ˆå¯ä»¥å°†æ›´æ–°çš„æ•°æ®é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œç­‰åˆ°ç§¯ç´¯è¶³å¤Ÿå¤šä¹‹åï¼Œå†ä½¿ç”¨å½’å¹¶æ’åºçš„æ–¹å¼å°†å†…å­˜å†…çš„æ•°æ®åˆå¹¶è¿½åŠ åˆ°ç£ç›˜ä¸­ã€‚</p>
<p>LSM-tree çš„ä¸»è¦æ€æƒ³æ˜¯åˆ’åˆ†ä¸åŒç­‰çº§çš„æ ‘ã€‚</p>
<ul>
<li>ä»¥ä¸¤çº§æ ‘ä¸ºä¾‹ï¼Œå¯ä»¥æƒ³è±¡ä¸€ä»½ç´¢å¼•æ•°æ®ç”±ä¸¤æ£µæ ‘ç»„æˆï¼Œä¸€æ£µæ ‘å­˜åœ¨äºå†…å­˜ï¼Œä¸€æ£µæ ‘å­˜åœ¨äºç£ç›˜ã€‚</li>
<li>å†…å­˜ä¸­çš„æ ‘å¯ä»¥ä¸ä¸€å®šæ˜¯ B æ ‘ï¼Œå¯ä»¥æ˜¯å…¶ä»–çš„æ ‘ï¼Œä¾‹å¦‚ AVL æ ‘ã€‚å› ä¸ºæ•°æ®å¤§å°æ˜¯ä¸åŒçš„ï¼Œæ²¡å¿…è¦ç‰ºç‰² CPU æ¥è¾¾åˆ°æœ€å°çš„æ ‘é«˜åº¦ï¼Œè€Œå­˜åœ¨äºç£ç›˜çš„æ ‘åˆ™æ˜¯ä¸€æ£µ B æ ‘ã€‚</li>
</ul>
<h3 id="å†™å…¥è¿‡ç¨‹"><a class="header" href="#å†™å…¥è¿‡ç¨‹">å†™å…¥è¿‡ç¨‹</a></h3>
<ul>
<li>
<p>åœ¨ LSM æ ‘ä¸­ï¼Œå†™å…¥æ•°æ®æ—¶é¦–å…ˆä¼šæ’å…¥åˆ°å†…å­˜çš„æ ‘ä¸­ã€‚</p>
</li>
<li>
<p>å½“å†…å­˜ä¸­çš„æ ‘çš„æ•°æ®è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œä¼šè¿›è¡Œåˆå¹¶æ“ä½œã€‚åˆå¹¶æ“ä½œä¼šé¡ºåºéå†å†…å­˜ä¸­çš„æ ‘çš„å¶å­èŠ‚ç‚¹ï¼Œå¹¶ä¸ç£ç›˜ä¸­çš„æ ‘çš„å¶å­èŠ‚ç‚¹è¿›è¡Œåˆå¹¶</p>
<ul>
<li>å½“è¢«åˆå¹¶çš„æ•°æ®é‡è¾¾åˆ°ç£ç›˜çš„å­˜å‚¨é¡µçš„å¤§å°æ—¶ï¼Œä¼šå°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ŒåŒæ—¶æ›´æ–°çˆ¶äº²èŠ‚ç‚¹å¯¹å¶å­èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚</li>
</ul>
</li>
<li>
<p>LSM æ ‘å¯ä»¥åˆ’åˆ†æˆå¾ˆå¤šå±‚çº§çš„æ ‘</p>
<ul>
<li>ç¬¬ 0 å±‚å­˜å‚¨åœ¨å†…å­˜ï¼Œç¬¬ 1 åˆ° k å±‚å­˜å‚¨åœ¨ç£ç›˜ï¼Œæ¯å±‚çš„æ•°æ®éƒ½æ˜¯æœ‰åºçš„ã€‚</li>
<li>æ•°æ®é¦–å…ˆä¼šæ’å…¥åˆ°ç¬¬ 0 å±‚ï¼Œç„¶ååå°é€å±‚åˆå¹¶ã€‚</li>
<li>æ¯ä¸€å±‚çš„æ•°æ®è¶…è¿‡ä¸€å®šé˜ˆå€¼æ—¶ï¼Œå¾€ä¸‹ä¸€å±‚åˆå¹¶ã€‚</li>
<li>è¯»å–å¶ç”±äºä¸çŸ¥é“æ•°æ®åœ¨å“ªä¸€å±‚ä¸Šï¼Œå¯èƒ½éœ€è¦éå†æ‰€æœ‰çš„å±‚ã€‚</li>
</ul>
</li>
</ul>
<h3 id="level-db"><a class="header" href="#level-db">Level DB</a></h3>
<p>LevelDB å­˜å‚¨å¼•æ“ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>å†…å­˜ä¸­çš„ MemTable å’Œä¸å¯å˜ MemTableï¼ˆä¹Ÿç§°ä¸º Frozen MemTableï¼‰</li>
<li>ç£ç›˜ä¸Šçš„å‡ ç§ä¸»è¦æ–‡ä»¶ï¼š
<ul>
<li>å½“å‰ï¼ˆCurrentï¼‰æ–‡ä»¶</li>
<li>æ¸…å•ï¼ˆManifestï¼‰æ–‡ä»¶</li>
<li>æ“ä½œæ—¥å¿—ï¼ˆCommit Logï¼Œä¹Ÿç§°ä¸ºæäº¤æ—¥å¿—ï¼‰æ–‡ä»¶</li>
<li>SSTable æ–‡ä»¶</li>
</ul>
</li>
</ul>
<p>å†™å…¥è¿‡ç¨‹ï¼š</p>
<ul>
<li>å½“åº”ç”¨å†™å…¥ä¸€æ¡è®°å½•æ—¶ï¼ŒLevelDB ä¼šé¦–å…ˆå°†ä¿®æ”¹æ“ä½œå†™å…¥åˆ°æ“ä½œæ—¥å¿—æ–‡ä»¶ï¼ŒæˆåŠŸåå†å°†ä¿®æ”¹æ“ä½œåº”ç”¨åˆ° MemTableï¼Œè¿™æ ·å°±å®Œæˆäº†å†™å…¥æ“ä½œã€‚</li>
<li>å½“ MemTable å ç”¨çš„å†…å­˜è¾¾åˆ°ä¸€ä¸ªä¸Šé™å€¼åï¼Œéœ€è¦å°†å†…å­˜çš„æ•°æ®è½¬å‚¨åˆ°å¤–å­˜æ–‡ä»¶ä¸­ã€‚</li>
<li>LevelDB ä¼šå°†åŸå…ˆçš„ MemTable å†»ç»“æˆä¸ºä¸å¯å˜ MemTableï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–° MemTableã€‚æ–°åˆ°æ¥çš„æ•°æ®è¢«è®°å…¥æ–°çš„æ“ä½œæ—¥å¿—æ–‡ä»¶å’Œæ–°ç”Ÿæˆçš„ MemTable ä¸­ã€‚</li>
<li>ä¸å¯å˜ MemTable çš„å†…å®¹æ˜¯ä¸å¯æ›´æ”¹çš„ï¼Œåªèƒ½è¯»å–ä¸èƒ½å†™å…¥æˆ–è€…åˆ é™¤ã€‚LevelDB åå°çº¿ç¨‹ä¼šå°†ä¸å¯å˜ MemTable çš„æ•°æ®æ’åºåè½¬å‚¨åˆ°ç£ç›˜ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„ SSTable æ–‡ä»¶ï¼Œè¿™ä¸ªæ“ä½œç§°ä¸º Compactionã€‚</li>
<li>SSTable æ–‡ä»¶æ˜¯å†…å­˜ä¸­çš„æ•°æ®ä¸æ–­è¿›è¡Œ Compaction æ“ä½œåå½¢æˆçš„ï¼Œä¸” SSTable çš„æ‰€æœ‰æ–‡ä»¶æ˜¯ä¸€ç§å±‚çº§ç»“æ„ï¼Œç¬¬ 0 å±‚ä¸º Level 0ï¼Œç¬¬ 1 å±‚ä¸º Level 1ï¼Œä»¥æ­¤ç±»æ¨ã€‚</li>
</ul>
<blockquote>
<p>SSTable: SSTable æ˜¯ä¸€ä¸ªé”®æ˜¯æœ‰åºçš„ï¼Œå­˜å‚¨å­—ç¬¦ä¸²å½¢å¼é”®å€¼å¯¹çš„æ–‡ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªå†…éƒ¨åŒ…å«äº†ä»»æ„é•¿åº¦ã€æ’å¥½åºçš„é”®å€¼å¯¹é›†åˆçš„æ–‡ä»¶ã€‚SSTable æ–‡ä»¶ç”±ä¸¤éƒ¨åˆ†æ•°æ®ç»„æˆï¼šç´¢å¼•å’Œé”®å€¼å¯¹æ•°æ®ã€‚æ‰€æœ‰çš„ key å’Œ value éƒ½æ˜¯ç´§å‡‘åœ°å­˜æ”¾åœ¨ä¸€èµ·çš„ï¼Œå¦‚æœè¦è¯»å–æŸä¸ªé”®å¯¹åº”çš„å€¼ï¼Œéœ€è¦é€šè¿‡ç´¢å¼•ä¸­çš„ key:offset æ¥å®šä½ã€‚SSTable åœ¨åºåˆ—åŒ–æˆæ–‡ä»¶ä¹‹åï¼Œæ˜¯ä¸å¯å˜çš„ï¼Œå› ä¸ºæ­¤æ—¶çš„ SSTableï¼Œå°±ç±»ä¼¼äºä¸€ä¸ªæ•°ç»„ä¸€æ ·ï¼Œå¦‚æœæ’å…¥æˆ–è€…åˆ é™¤ï¼Œéœ€è¦ç§»åŠ¨ä¸€å¤§ç‰‡æ•°æ®ï¼Œå¼€é”€æ¯”è¾ƒå¤§ã€‚</p>
</blockquote>
<p>åŠ å¿«è®¿é—®æ•ˆç‡ï¼š</p>
<ul>
<li>LSM æ ‘å†™å…¥æ•ˆç‡å¾ˆé«˜ï¼Œä½†è¯»å–å¯èƒ½éœ€è¦è®¿é—®è¾ƒå¤šçš„ç£ç›˜æ–‡ä»¶ï¼Œæ•ˆç‡è¾ƒä½ã€‚ä¸ºäº†åŠ å¿«è¯»å–æ•ˆç‡ï¼Œå·¥ç¨‹å®ç°ä¸Šä¸€èˆ¬ä½¿ç”¨ Bloom Filter æ¥åŠ å¿«è¯»å–æ•ˆç‡ã€‚å®ƒä½¿ç”¨å¾ˆå°çš„å­˜å‚¨ç©ºé—´æ¢æ¥è¾ƒå¤§çš„è¯»å–æ•ˆç‡æå‡ã€‚</li>
</ul>
<p>Bloom Filter æ˜¯ä¸€ç§ç©ºé—´æ•ˆç‡å¾ˆé«˜çš„éšæœºæ•°æ®ç»“æ„ï¼Œå®ƒåˆ©ç”¨ä½æ•°ç»„å¾ˆç®€æ´åœ°è¡¨ç¤ºä¸€ä¸ªé›†åˆï¼Œå¹¶èƒ½åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºè¿™ä¸ªé›†åˆã€‚</p>
<ul>
<li>Bloom Filter çš„è¿™ç§é«˜æ•ˆæ˜¯æœ‰ä¸€å®šä»£ä»·çš„ï¼šåœ¨åˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å±äºæŸä¸ªé›†åˆæ—¶ï¼Œæœ‰å¯èƒ½ä¼šæŠŠä¸å±äºè¿™ä¸ªé›†åˆçš„å…ƒç´ è¯¯è®¤ä¸ºå±äºè¿™ä¸ªé›†åˆï¼ˆfalse positiveï¼‰ã€‚å› æ­¤ï¼ŒBloom Filter ä¸é€‚åˆé‚£äº›â€œé›¶é”™è¯¯â€çš„åº”ç”¨åœºåˆã€‚</li>
<li>è€Œåœ¨èƒ½å®¹å¿ä½é”™è¯¯ç‡çš„åº”ç”¨åœºåˆä¸‹ï¼ŒBloom Filter é€šè¿‡æå°‘çš„é”™è¯¯æ¢å–äº†å­˜å‚¨ç©ºé—´çš„æå¤§èŠ‚çœã€‚</li>
</ul>
<blockquote>
<p>åˆå§‹çŠ¶æ€æ—¶ï¼ŒBloom Filter æ˜¯ä¸€ä¸ªåŒ…å« m ä½çš„ä½æ•°ç»„ï¼Œæ¯ä¸€ä½éƒ½ç½®ä¸º 0ã€‚ä¸ºäº†è¡¨è¾¾ S={x1, x2,â€¦,xn}è¿™æ ·ä¸€ä¸ª n ä¸ªå…ƒç´ çš„é›†åˆï¼ŒBloom Filter ä½¿ç”¨ k ä¸ªç›¸äº’ç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°ï¼ˆHash Functionï¼‰ï¼Œå®ƒä»¬åˆ†åˆ«å°†é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ æ˜ å°„åˆ°{1,â€¦,m}çš„èŒƒå›´ä¸­ã€‚å¯¹ä»»æ„ä¸€ä¸ªå…ƒç´  xï¼Œç¬¬ i ä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„çš„ä½ç½® hi(x) å°±ä¼šè¢«ç½®ä¸º 1ï¼ˆ1â‰¤iâ‰¤kï¼‰ã€‚æ³¨æ„ï¼Œå¦‚æœä¸€ä¸ªä½ç½®å¤šæ¬¡è¢«ç½®ä¸º 1ï¼Œé‚£ä¹ˆåªæœ‰ç¬¬ä¸€æ¬¡ä¼šèµ·ä½œç”¨ï¼Œåé¢å‡ æ¬¡å°†æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚åœ¨åˆ¤æ–­ y æ˜¯å¦å±äºè¿™ä¸ªé›†åˆæ—¶ï¼Œæˆ‘ä»¬å¯¹ y åº”ç”¨ k æ¬¡å“ˆå¸Œå‡½æ•°ï¼Œå¦‚æœæ‰€æœ‰ hi(y) çš„ä½ç½®éƒ½æ˜¯ 1ï¼ˆ1â‰¤iâ‰¤kï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸º y æ˜¯é›†åˆä¸­çš„å…ƒç´ ï¼Œå¦åˆ™å°±è®¤ä¸º y ä¸æ˜¯é›†åˆä¸­çš„å…ƒç´ ã€‚</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç½‘ç«™æ›´æ–°æ—¥å¿—"><a class="header" href="#ç½‘ç«™æ›´æ–°æ—¥å¿—">ç½‘ç«™æ›´æ–°æ—¥å¿—</a></h1>
<h2 id="v4-mdbook"><a class="header" href="#v4-mdbook">v4 mdbook</a></h2>
<p>2023.4.24 Docusaurus æ‡’å¾—æŠ˜è…¾äº†ï¼Œmdbook æ¯”è¾ƒç†Ÿï¼Œè¿˜èƒ½é€šè¿‡æ¨¡æ¿å¼•ç”¨ä»£ç æ–‡ä»¶ï¼Œå°±ç”¨å®ƒäº†ã€‚</p>
<h2 id="v3-docusaurus"><a class="header" href="#v3-docusaurus">v3 Docusaurus</a></h2>
<p>2022.10.21 ä» vuepress2 è¿ç§»åˆ° Docusaurus</p>
<h2 id="v2-vuepress2"><a class="header" href="#v2-vuepress2">v2 vuepress2</a></h2>
<p>è¿ç§»åˆ° vite åçš„æ„å»ºé€Ÿåº¦æ˜¯çœŸæ»´å¿«ï¼</p>
<h2 id="v1-vuepress1"><a class="header" href="#v1-vuepress1">v1 vuepress1</a></h2>
<p>åŸºäº typora å¤„ç†å›¾ç‰‡</p>
<pre><code class="language-sh"># rm -rf docs/.vuepress/dist
cd vuePressBlog
# ç”Ÿæˆé™æ€æ–‡ä»¶
pnpm run build

# å›¾ç‰‡æºä¿®æ”¹
rm docs/.vuepress/public/assets/img/*
cp /home/trthg/.config/Typora/typora-user-images/* docs/.vuepress/public/assets/img/

# md å¼•ç”¨å›¾ç‰‡è·¯å¾„ä¿®æ”¹
sed -i &quot;s/\/home\/trthg\/.config\/Typora\/typora-user-images/\/assets\/img/g&quot; `grep -rl &quot;/assets/img&quot; ./`

# # /* ä¼šå¿½ç•¥ã€‚å¼€å¤´çš„æ–‡ä»¶   /. ä¸ä¼š
rm -r ../assets
rm -r ../java
rm -r ../other
rm -r ../js
rm -r ../python
rm -r ../rust
rm -r ../ioclub
rm -r ../magic
rm ../*.html
# rm ../*.png
# rm ../*.jpg

mv docs/.vuepress/dist/* ../

curDate=$(date &quot;+%Y-%m-%d&quot;)
curTime=$(date &quot;+%H:%M:%S&quot;)
# # git init
cd ..
git add .
git commit -s -m &quot;commit: $curDate $curTime&quot;
git push -u origin main
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ioclub"><a class="header" href="#ioclub">ioclub</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="b-æ ‘ä»¥åŠåœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨"><a class="header" href="#b-æ ‘ä»¥åŠåœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨">B+ æ ‘ä»¥åŠåœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨</a></h1>
<ul>
<li><a href="other/ioclub/share_1.html#b%E6%A0%91%E4%BB%A5%E5%8F%8A%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">B+ æ ‘ä»¥åŠåœ¨æ•°æ®åº“ä¸­çš„åº”ç”¨</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%BA%93">ä»€ä¹ˆæ˜¯æ•°æ®åº“</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E6%8A%80%E6%9C%AF%E5%88%9D%E8%A1%B7">æŠ€æœ¯åˆè¡·</a></li>
<li><a href="other/ioclub/share_1.html#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F">æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</a></li>
<li><a href="other/ioclub/share_1.html#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E5%88%86%E7%B1%BB">æ•°æ®åº“çš„åˆ†ç±»</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E5%85%B3%E7%B3%BB%E6%95%B0%E6%8D%AE%E5%BA%93">å…³ç³»æ•°æ®åº“</a></li>
<li><a href="other/ioclub/share_1.html#%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93nosql">éå…³ç³»å‹æ•°æ®åº“ï¼ˆNoSQLï¼‰</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="other/ioclub/share_1.html#%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93">å¦‚ä½•å®ç°ä¸€ä¸ªæ•°æ®åº“ï¼Ÿ</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E4%BD%BF%E7%94%A8%E5%8D%95%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E7%9A%84%E7%BC%BA%E7%82%B9">ä½¿ç”¨å•æ–‡ä»¶å­˜å‚¨çš„ç¼ºç‚¹</a></li>
<li><a href="other/ioclub/share_1.html#%E7%9B%AE%E6%A0%87">ç›®æ ‡</a></li>
</ul>
</li>
<li><a href="other/ioclub/share_1.html#%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF">å®ç°æ€è·¯</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E4%BD%BF%E7%94%A8%E6%95%B0%E7%BB%84%E5%AD%98%E5%82%A8">ä½¿ç”¨æ•°ç»„å­˜å‚¨</a></li>
<li><a href="other/ioclub/share_1.html#%E4%BD%BF%E7%94%A8%E6%A0%91%E5%AD%98%E5%82%A8">ä½¿ç”¨æ ‘å­˜å‚¨</a>
<ul>
<li><a href="other/ioclub/share_1.html#%E4%BA%8C%E5%8F%89%E6%A0%91">äºŒå‰æ ‘</a></li>
<li><a href="other/ioclub/share_1.html#%E6%9F%A5%E8%AF%A2%E7%9A%84%E8%80%97%E6%97%B6%E5%9C%A8%E5%93%AA%E9%87%8C">æŸ¥è¯¢çš„è€—æ—¶åœ¨å“ªé‡Œ</a></li>
<li><a href="other/ioclub/share_1.html#%E5%A4%9A%E5%8F%89%E6%A0%91">å¤šå‰æ ‘</a>
<ul>
<li><a href="other/ioclub/share_1.html#b%E6%A0%91">B æ ‘</a></li>
<li><a href="other/ioclub/share_1.html#b%E6%A0%91-1">B+ æ ‘</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="ä»€ä¹ˆæ˜¯æ•°æ®åº“"><a class="header" href="#ä»€ä¹ˆæ˜¯æ•°æ®åº“">ä»€ä¹ˆæ˜¯æ•°æ®åº“</a></h2>
<p><strong>æ•°æ®åº“</strong>ï¼Œåˆç§°ä¸ºæ•°æ®ç®¡ç†ç³»ç»Ÿï¼Œç®€è€Œè¨€ä¹‹å¯è§†ä¸º<a href="https://zh.wikipedia.org/w/index.php?title=%E9%9B%BB%E5%AD%90%E5%8C%96&amp;action=edit&amp;redlink=1">ç”µå­åŒ–</a>çš„<a href="https://zh.wikipedia.org/wiki/%E6%A1%A3%E6%A1%88%E6%9F%9C">æ–‡ä»¶æŸœ</a>â€”â€”å­˜å‚¨ç”µå­<a href="https://zh.wikipedia.org/wiki/%E6%AA%94%E6%A1%88">æ–‡ä»¶</a>çš„å¤„æ‰€ï¼Œç”¨æˆ·å¯ä»¥å¯¹<a href="https://zh.wikipedia.org/wiki/%E6%AA%94%E6%A1%88">æ–‡ä»¶</a>ä¸­çš„èµ„æ–™è¿è¡Œæ–°å¢ã€æˆªå–ã€æ›´æ–°ã€åˆ é™¤ç­‰æ“ä½œ [<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93#cite_note-1">1]</a>ã€‚</p>
<h3 id="æŠ€æœ¯åˆè¡·"><a class="header" href="#æŠ€æœ¯åˆè¡·">æŠ€æœ¯åˆè¡·</a></h3>
<p>åœ¨<a href="https://zh.wikipedia.org/wiki/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">æ“ä½œç³»ç»Ÿ</a>å‡ºç°ä¹‹åï¼Œéšç€<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA">è®¡ç®—æœº</a>åº”ç”¨èŒƒå›´çš„æ‰©å¤§ã€éœ€è¦å¤„ç†çš„<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE">æ•°æ®</a>è¿…é€Ÿè†¨èƒ€ã€‚æœ€åˆï¼Œæ•°æ®ä¸<a href="https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BA%8F">ç¨‹åº</a>ä¸€æ ·ï¼Œä»¥ç®€å•çš„æ–‡ä»¶ä½œä¸ºä¸»è¦å­˜å‚¨å½¢å¼ã€‚ä»¥è¿™ç§æ–¹å¼ç»„ç»‡çš„æ•°æ®åœ¨é€»è¾‘ä¸Šæ›´ç®€å•ï¼Œä½†<a href="https://zh.wikipedia.org/wiki/%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7">å¯æ‰©å±•æ€§</a>å·®ï¼Œè®¿é—®è¿™ç§æ•°æ®çš„ç¨‹åºéœ€è¦äº†è§£æ•°æ®çš„å…·ä½“ç»„ç»‡æ ¼å¼ã€‚å½“ç³»ç»Ÿæ•°æ®é‡å¤§æˆ–è€…ç”¨æˆ·è®¿é—®é‡å¤§æ—¶ï¼Œåº”ç”¨ç¨‹åºè¿˜éœ€è¦è§£å†³æ•°æ®çš„å®Œæ•´æ€§ã€ä¸€è‡´æ€§ä»¥åŠå®‰å…¨æ€§ç­‰ä¸€ç³»åˆ—çš„é—®é¢˜ã€‚å› æ­¤ï¼Œå¿…é¡»å¼€å‘å‡ºä¸€ç§<a href="https://zh.wikipedia.org/wiki/%E7%B3%BB%E7%BB%9F%E8%BD%AF%E4%BB%B6">ç³»ç»Ÿè½¯ä»¶</a>ï¼Œå®ƒåº”è¯¥èƒ½å¤Ÿåƒæ“ä½œç³»ç»Ÿå±è”½äº†ç¡¬ä»¶è®¿é—®å¤æ‚æ€§é‚£æ ·ï¼Œå±è”½æ•°æ®è®¿é—®çš„å¤æ‚æ€§ã€‚ç”±æ­¤äº§ç”Ÿäº†æ•°æ®ç®¡ç†ç³»ç»Ÿï¼Œå³æ•°æ®åº“ã€‚</p>
<h3 id="æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ"><a class="header" href="#æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ">æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</a></h3>
<p>ä¸»æ¡ç›®ï¼š<a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F">æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</a></p>
<p><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F">æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</a>ï¼ˆè‹±è¯­ï¼šDatabase Management
Systemï¼Œç®€ç§°<a href="https://zh.wikipedia.org/wiki/DBMS">DBMS</a>ï¼‰æ˜¯ä¸ºç®¡ç†<a href="https://zh.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E5%BA%AB">æ•°æ®åº“</a>è€Œè®¾è®¡çš„ç”µè„‘<a href="https://zh.wikipedia.org/wiki/%E8%BB%9F%E9%AB%94">è½¯ä»¶</a>ç³»ç»Ÿï¼Œä¸€èˆ¬å…·æœ‰å­˜å‚¨ã€æˆªå–ã€å®‰å…¨ä¿éšœã€å¤‡ä»½ç­‰åŸºç¡€åŠŸèƒ½ã€‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå¯ä»¥ä¾æ®å®ƒæ‰€æ”¯æŒçš„<a href="https://zh.wikipedia.org/w/index.php?title=%E8%B3%87%E6%96%99%E5%BA%AB%E6%A8%A1%E5%9E%8B&amp;action=edit&amp;redlink=1">æ•°æ®åº“æ¨¡å‹</a>æ¥ä½œåˆ†ç±»ï¼Œä¾‹å¦‚<a href="https://zh.wikipedia.org/wiki/%E9%97%9C%E8%81%AF%E6%A8%A1%E5%9E%8B">å…³ç³»å¼</a>ã€<a href="https://zh.wikipedia.org/wiki/XML">XML</a>ï¼›æˆ–ä¾æ®æ‰€æ”¯æŒçš„ç”µè„‘ç±»å‹æ¥ä½œåˆ†ç±»ï¼Œä¾‹å¦‚æœåŠ¡å™¨èšç±»ã€ç§»åŠ¨ç”µè¯ï¼›æˆ–ä¾æ®æ‰€ç”¨æŸ¥è¯¢è¯­è¨€æ¥ä½œåˆ†ç±»ï¼Œä¾‹å¦‚<a href="https://zh.wikipedia.org/wiki/SQL">SQL</a>ã€<a href="https://zh.wikipedia.org/w/index.php?title=XQuery&amp;action=edit&amp;redlink=1">XQuery</a>ï¼›æˆ–ä¾æ®æ€§èƒ½å†²é‡é‡ç‚¹æ¥ä½œåˆ†ç±»ï¼Œä¾‹å¦‚æœ€å¤§è§„æ¨¡ã€æœ€é«˜è¿è¡Œé€Ÿåº¦ï¼›äº¦æˆ–å…¶ä»–çš„åˆ†ç±»æ–¹å¼ã€‚ä¸è®ºä½¿ç”¨å“ªç§åˆ†ç±»æ–¹å¼ï¼Œä¸€äº› DBMS èƒ½å¤Ÿè·¨ç±»åˆ«ï¼Œä¾‹å¦‚ï¼ŒåŒæ—¶æ”¯æŒå¤šç§æŸ¥è¯¢è¯­è¨€ã€‚</p>
<h3 id="æ•°æ®åº“çš„åˆ†ç±»"><a class="header" href="#æ•°æ®åº“çš„åˆ†ç±»">æ•°æ®åº“çš„åˆ†ç±»</a></h3>
<h4 id="å…³ç³»æ•°æ®åº“"><a class="header" href="#å…³ç³»æ•°æ®åº“">å…³ç³»æ•°æ®åº“</a></h4>
<ul>
<li>
<p><a href="https://www.mysql.com/cn/">MySQL</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/Microsoft_Access">Microsoft Access</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/Microsoft_SQL_Server">Microsoft SQL Server</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93">Oracle æ•°æ®åº“</a></p>
<p>ç±»ä¼¼äº excel è¡¨æ ¼ï¼Œæ‰€æœ‰æ•°æ®ä»¥è¡¨æ ¼çš„å½¢å¼æŒ‰è¡Œæˆ–æŒ‰åˆ—å­˜å‚¨</p>
</li>
</ul>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021248061.png" alt="" /></p>
<h4 id="éå…³ç³»å‹æ•°æ®åº“a-hrefhttpszhwikipediaorgwikinosqlnosqla"><a class="header" href="#éå…³ç³»å‹æ•°æ®åº“a-hrefhttpszhwikipediaorgwikinosqlnosqla">éå…³ç³»å‹æ•°æ®åº“ï¼ˆ<a href="https://zh.wikipedia.org/wiki/NoSQL">NoSQL</a>ï¼‰</a></h4>
<ul>
<li>
<p><a href="https://zh.wikipedia.org/wiki/MongoDB">MongoDB</a></p>
</li>
<li>
<p><a href="https://zh.wikipedia.org/wiki/Redis">Redis</a></p>
</li>
</ul>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021249305.png" alt="" /></p>
<h2 id="å¦‚ä½•å®ç°ä¸€ä¸ªæ•°æ®åº“"><a class="header" href="#å¦‚ä½•å®ç°ä¸€ä¸ªæ•°æ®åº“">å¦‚ä½•å®ç°ä¸€ä¸ªæ•°æ®åº“ï¼Ÿ</a></h2>
<h3 id="ä½¿ç”¨å•æ–‡ä»¶å­˜å‚¨çš„ç¼ºç‚¹"><a class="header" href="#ä½¿ç”¨å•æ–‡ä»¶å­˜å‚¨çš„ç¼ºç‚¹">ä½¿ç”¨å•æ–‡ä»¶å­˜å‚¨çš„ç¼ºç‚¹</a></h3>
<ol>
<li>å•ä¸ªæ–‡ä»¶å­˜å‚¨æ•°æ®æ•ˆç‡ä½ï¼Œè¯»å–é€Ÿåº¦æ…¢</li>
<li>å¦‚æœæ–‡ä»¶è¿‡å¤§ (å‡ ä¸ª G), å°±ä¸èƒ½ç›´æ¥æŠŠæ•´ä¸ªæ–‡ä»¶è¯»å…¥å†…å­˜å†è¿›è¡Œæ“ä½œ , å³ä½¿èƒ½å¤Ÿè¯»å…¥å†…å­˜ï¼Œé‚£ä¹Ÿæ˜¯å®Œå…¨æ²¡æœ‰å¿…è¦çš„ï¼Œæˆ‘ä»¬éœ€è¦çš„æ•°æ®å¯èƒ½åªæœ‰ä¸€è¡Œï¼Œ
æƒ³è¦æ‰¾åˆ°è¿™ä¸€è¡Œå°±æŠŠæ‰€æœ‰æ•°æ®å…¨éƒ¨è¯»å–æ˜¯å¾ˆæµªè´¹çš„</li>
<li>å¦‚æœå¯¹æ–‡ä»¶çš„ä¿®æ”¹é€Ÿåº¦è¿‡å¿«ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ–‡ä»¶'æŸå'</li>
</ol>
<h3 id="ç›®æ ‡"><a class="header" href="#ç›®æ ‡">ç›®æ ‡</a></h3>
<ol>
<li>åŠ é€Ÿæ–‡ä»¶è¯»å–é€Ÿåº¦</li>
<li>èƒ½å¤Ÿå®ç°åˆ†å¿«è¯»å–</li>
<li>èƒ½å¤Ÿåœ¨ä¿®æ”¹æ–‡ä»¶æ—¶ï¼Œä¿è¯æ•°æ®çš„å®Œæ•´æ€§ (å…ˆä¸æ)</li>
</ol>
<h2 id="å®ç°æ€è·¯"><a class="header" href="#å®ç°æ€è·¯">å®ç°æ€è·¯</a></h2>
<h3 id="ä½¿ç”¨æ•°ç»„å­˜å‚¨"><a class="header" href="#ä½¿ç”¨æ•°ç»„å­˜å‚¨">ä½¿ç”¨æ•°ç»„å­˜å‚¨</a></h3>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021249677.png" alt="" />
<strong>ä¼˜ç‚¹</strong></p>
<ol>
<li>å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®é‡å°‘çš„æ—¶å€™å°šä¸”å¯ä»¥ï¼Œ</li>
<li>å¯ä»¥é€šè¿‡ç´¢å¼• (ä¸‹æ ‡) è®¿é—®æ•°æ®å…ƒç´ ï¼Œé€Ÿåº¦æœ€å¿«</li>
</ol>
<p><strong>ç¼ºç‚¹</strong></p>
<ol>
<li>
<p>å½“æ¯ä¸ªå…ƒç´ å˜å¤§æ—¶ï¼Œè¿™ç§æ–¹å¼å°±ä¼šå ç”¨è¾ƒå¤§çš„å†…å­˜</p>
<p>(ä¾æ¬¡ä¸º å­¦å·ï¼Œå§“åï¼Œæˆç»©ï¼ŒæŒ‰ç…§å­¦å·æ’åº)</p>
</li>
</ol>
<p><strong>ä¼˜åŒ–</strong></p>
<p>ç»“åˆä¹‹å‰äºŒåˆ†çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å°è¯•å°†æ•°ç»„ä¸­å­¦å·æœ€å°ï¼Œæœ€å¤§ï¼Œå’Œä½äºä¸­é—´çš„å…ƒç´ æå–å‡ºæ¥</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021250084.png" alt="" />
å½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢å­¦å·ä¸º 3 çš„å­¦ç”Ÿæ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦å…ˆè¯»å–ä¸Šä¸€å±‚çš„ 3 ä¸ªå…ƒç´ ï¼Œåœ¨ çŸ¥é“ 1 &lt; 3 &lt; 5 åå°±åªéœ€è¦åœ¨æ•°ç»„ç´¢å¼•ä» 1 åˆ° 5 ä¸­æŸ¥è¯¢å­¦å·ä¸º 3 çš„å…ƒç´ äº†</p>
<p><strong>æ›´å¤§æ›´å¤š</strong></p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021252950.png" alt="" />
è¿™æ˜¯ä¸€ç§å®ç°æ€è·¯ï¼Œä¸è¿‡ä¸æ˜¯æˆ‘ä»¬è®²çš„é‡ç‚¹ï¼Œåªæ˜¯ä¸ºäº†æ‹“å±•ä¸€ä¸‹å¤§å®¶çš„äº‹ä¸š</p>
<p>(è¿™ä¸ªä¸œè¥¿å«è·³è¡¨ï¼Œå¯ä»¥å®ç°å¯¹é“¾è¡¨çš„äºŒåˆ†ï¼Œæ„Ÿå…´è¶£çš„è‡ªå·±å¯ä»¥å»æŸ¥ï¼Œæˆ‘æ²¡äº²æ‰‹å®ç°è¿‡)</p>
<p><strong>ç»“æœ</strong></p>
<p>å®ç°äº†æŸ¥è¯¢é€Ÿåº¦çš„ä¼˜åŒ–ï¼Œä½†æ˜¯å¦‚æœæ¯ä¸ªèŠ‚ç‚¹éƒ½å•ç‹¬åˆ†ä¸€ä¸ªæ–‡ä»¶ï¼Œç¡¬ç›˜å¯¹äºå­˜å‚¨å¤§é‡å°æ–‡ä»¶æ˜¯ä½æ•ˆçš„ (è¿™é‡Œä¸å±•å¼€è®²), ä¸é€‚å’Œåœ¨ç¡¬ç›˜ä¸­å­˜å‚¨</p>
<h3 id="ä½¿ç”¨æ ‘å­˜å‚¨"><a class="header" href="#ä½¿ç”¨æ ‘å­˜å‚¨">ä½¿ç”¨æ ‘å­˜å‚¨</a></h3>
<h4 id="äºŒå‰æ ‘"><a class="header" href="#äºŒå‰æ ‘">äºŒå‰æ ‘</a></h4>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021252234.png" alt="" />
æ ‘çš„ä»»æ„èŠ‚ç‚¹çš„å·¦å­æ ‘çš„èŠ‚ç‚¹å¯¹åº”çš„å€¼éƒ½æ¯”å³å­æ ‘çš„å€¼å°ï¼Œ
äºŒå‰æŸ¥æ‰¾æ ‘ç›¸æ¯”äºå…¶ä»–æ•°æ®ç»“æ„çš„ä¼˜åŠ¿åœ¨äºæŸ¥æ‰¾ã€æ’å…¥çš„<a href="https://zh.wikipedia.org/wiki/%E6%97%B6%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6">æ—¶é—´å¤æ‚åº¦</a>è¾ƒä½ã€‚äºŒå‰æŸ¥æ‰¾æ ‘æ˜¯åŸºç¡€æ€§æ•°æ®ç»“æ„ï¼Œç”¨äºæ„å»ºæ›´ä¸ºæŠ½è±¡çš„æ•°æ®ç»“æ„ï¼Œå¦‚<a href="https://zh.wikipedia.org/wiki/%E9%9B%86%E5%90%88_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">é›†åˆ</a>ã€<a href="https://zh.wikipedia.org/wiki/%E5%A4%9A%E9%87%8D%E9%9B%86">å¤šé‡é›†</a>ã€<a href="https://zh.wikipedia.org/wiki/%E5%85%B3%E8%81%94%E6%95%B0%E7%BB%84">å…³è”æ•°ç»„</a>ç­‰ã€‚</p>
<p>æˆ‘ä»¬åˆ†æä¸€ä¸‹å¯¹äºä½¿ç”¨äºŒå‰æ ‘è¿›è¡ŒæŸ¥è¯¢éœ€è¦çš„æ¬¡æ•°</p>
<pre><code class="language-python"># 1. '**'åœ¨ python ä¸­è¡¨ç¤ºæ¬¡æ–¹ï¼Œprint(3**2)
# 2. æ•°å­—ä¸­é—´çš„ä¸‹åˆ’çº¿ä¼šè¢«å¿½è§†ï¼Œä½œç”¨åªæ˜¯ä¸ºäº†çœ‹æ•°å­—æ—¶æ›´æ–¹ä¾¿

2**27 = 134_000_000
2**26 = 67_000_000
2**25 = 34_000_000
2**24 = 17_000_000
</code></pre>
<p>ä» 1 äº¿æ•°æ®ä¸­æŸ¥è¯¢æœ€å¤§åªéœ€è¦ 27 æ¬¡ï¼Œæ•ˆæœéå¸¸å¥½ï¼Œä½†æ˜¯è¿™è¿˜è¿œè¿œä¸å¤Ÿ</p>
<p>è®©æˆ‘ä»¬ç»§ç»­åˆ†æ</p>
<h4 id="æŸ¥è¯¢çš„è€—æ—¶åœ¨å“ªé‡Œ"><a class="header" href="#æŸ¥è¯¢çš„è€—æ—¶åœ¨å“ªé‡Œ">æŸ¥è¯¢çš„è€—æ—¶åœ¨å“ªé‡Œ</a></h4>
<p>å¯¹äºäºŒå‰æ ‘</p>
<pre><code> ä»ç£ç›˜ä¸­è¯»å–ä¸€ä¸ªèŠ‚ç‚¹
   |
 å¾—åˆ°èŠ‚ç‚¹å†…å­˜å‚¨çš„å­¦å·
   |
 æ¯”è¾ƒè¯¥èŠ‚ç‚¹çš„å­¦å·å’Œæˆ‘ä»¬éœ€è¦æŸ¥è¯¢çš„å­¦å·
   |
æ‰¾åˆ°å·¦å­æ ‘æˆ–å³å­æ ‘åœ¨ç¡¬ç›˜ä¸­çš„ä½ç½®
   |
  è¿›è¡Œä¸‹ä¸€æ¬¡
</code></pre>
<p>æˆ‘ä»¬è¿™é‡Œå…ˆè®¨è®ºæœºæ¢°ç¡¬ç›˜çš„æ¡ä»¶ä¸‹</p>
<p>ä¸‹é¢å°±æ˜¯ä¸€å¼ æœºæ¢°ç¡¬ç›˜çš„å›¾ç‰‡ï¼Œæœ€é‡è¦çš„å°±æ˜¯ç£å¤´å’Œç£ç›˜ä¸¤ä¸ªç»“æ„ï¼Œæ¯æ¬¡ç¡¬ç›˜æŠŠæ–‡ä»¶è¯»å–åˆ°å†…å­˜ä¸­ï¼Œéƒ½éœ€è¦å…ˆæŠŠç£å¤´æ—‹è½¬åˆ°å¯¹åº”çš„ä½ç½®ï¼Œæ‰èƒ½å¼€å§‹è¯»å–å­˜å‚¨åœ¨æ–‡ä»¶ä¸­çš„æ•°æ®</p>
<p><img src="https://bkimg.cdn.bcebos.com/pic/32fa828ba61ea8d3c3793017940a304e251f584d?x-bce-process=image/watermark,image_d2F0ZXIvYmFpa2U4MA==,g_7,xp_5,yp_5/format,f_auto" alt="???" /></p>
<p>å› ä¸ºä»ç¡¬ç›˜è¯»å–æ•°æ®çš„é€Ÿåº¦è¿œè¿œä½äºæ¯”è¾ƒèŠ‚ç‚¹çš„é€Ÿåº¦ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°½é‡é™ä½äºŒå‰æ ‘çš„æ·±åº¦ (å³é™ä½æ£€ç´¢æ•°æ®çš„æ¬¡æ•°),</p>
<h4 id="å¤šå‰æ ‘"><a class="header" href="#å¤šå‰æ ‘">å¤šå‰æ ‘</a></h4>
<h5 id="b-æ ‘"><a class="header" href="#b-æ ‘">B æ ‘</a></h5>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021253576.png" alt="" /></p>
<p>å‡å¦‚æˆ‘ä»¬ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨æ›´å¤šåˆ†æ”¯ï¼Œæˆ‘ä»¬å°±èƒ½ç”¨æ›´å°‘çš„æ¬¡æ•°æŸ¥åˆ°ç›¸åº”çš„æ•°æ®èŠ‚ç‚¹ï¼Œè¿™æœ¬èº«æ˜¯ä¸€ç§å¾ˆå¥½çš„ç»“æ„ï¼Œå·²ç»èƒ½å¤Ÿè§£å†³ä¸€äº›é—®é¢˜ï¼Œ
PostgreSql å°±æä¾›äº† B æ ‘ä½œä¸ºå­˜å‚¨ç»“æ„</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021254278.png" alt="" />
ç°åœ¨æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨äº†å¤šä¸ªå…ƒç´ æ•°æ®ï¼Œæ¯ä¸ªå…ƒç´ ä¸­éƒ½åŒ…å«äº†ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯ï¼Œ</p>
<p>æ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œå¦‚æœå­¦å·åŒ¹é…æˆ‘ä»¬å°±ç›´æ¥è¿”å›ç»“æœï¼Œå¦‚æœä¸åŒ¹é…ï¼Œå°±ç»§ç»­æ·±å…¥ä¸‹ä¸€å±‚</p>
<p><strong>ç¼ºç‚¹</strong></p>
<p>ä½†æ˜¯åœ¨çœŸå®ç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸å¯èƒ½åªæœ‰ä¸€ä¸ªåºå·ï¼Œæˆ‘ä»¬ç°åœ¨æŠŠå›¾æ‰©å……ä¸‹</p>
<p>å­˜å‚¨çš„ä¿¡æ¯è¶Šå¤šï¼Œå•ä¸ªå…ƒç´ å°±è¶Šå¤§ï¼Œæˆ‘ä»¬èƒ½è¯»å–åˆ°å†…å­˜ä¸­çš„å…ƒç´ ä¸ªæ•°å°±ä¼šå˜å°‘ï¼Œæ ‘çš„åˆ†å‰å°±ä¸ä¼šå¤ªå¤šä¸ºäº†è®©åˆ†å‰è¶³å¤Ÿå¤šï¼Œæˆ‘ä»¬å¼•å…¥ B+ æ ‘</p>
<h5 id="b-æ ‘-1"><a class="header" href="#b-æ ‘-1">B+ æ ‘</a></h5>
<p>ä¸ºäº†èƒ½å¤Ÿè®©ä¸€ä¸ªèŠ‚ç‚¹å­˜å‚¨æ›´å¤šçš„å…ƒç´ ï¼Œæˆ‘ä»¬å†³å®šæŠ›å¼ƒèŠ‚ç‚¹ä¸­å­˜å‚¨çš„æ— ç”¨çš„ä¿¡æ¯ï¼Œä¹‹ä¿ç•™å­¦å·è¿™ä¸€é¡¹æ•°æ®ï¼Œç„¶åä¹‹åœ¨å¶å­èŠ‚ç‚¹ (å°±æ˜¯æœ€åä¸€å±‚çš„èŠ‚ç‚¹) å­˜å‚¨å®Œæ•´çš„èŠ‚ç‚¹
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021254900.png" alt="" /></p>
<p>ç°åœ¨æˆ‘ä»¬å¾—åˆ°æœ€å¥½çš„ç»“æ„äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡åŠ è½½ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰å‡ ç™¾å‡ åƒä¸ªå­¦å·ï¼Œå‡å¦‚æœ‰ 100 ä¸ªåˆ†æ”¯ï¼Œä¸¤å±‚æ•°æ®å°±èƒ½å¤Ÿå­˜å‚¨ 100 * 100 =
10_000 ä¸ªæ•°æ®ï¼Œåœ¨ 10000 ä¸ªäººä¸­åªç”¨ä¸¤æ¬¡å°±èƒ½æŸ¥åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ï¼Œæƒ³å¯¹äºäºŒå‰æ ‘ 2**13 = 8192 éœ€è¦å¤§æ¦‚ 13 æ¬¡ï¼Œæˆ‘ä»¬ç°åœ¨ç£ç›˜åªéœ€è¦æ—‹è½¬ 2 +
1 æ¬¡å°±èƒ½è¯»åˆ°æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªé£è·ƒã€‚</p>
<p><strong>å°é—®é¢˜</strong></p>
<p>å­¦å·ä¸º 10, 20, 30 çš„å­¦ç”Ÿçš„æ•°æ®å»å“ªäº†ï¼Ÿæ²¡äº†ï¼Ÿ
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021254452.png" alt="" /></p>
<p>æ¯”å¦‚æˆ‘ä»¬ç°åœ¨éœ€è¦æŸ¥è¯¢å­¦å·ä¸º 10 çš„å­¦ç”Ÿçš„æ•°æ®ï¼Œæˆ‘ä»¬åœ¨åœ¨æŸ¥è¯¢ç¬¬ä¸€å±‚æ—¶å·²ç»æ‰¾åˆ°äº† 10ï¼Œä½†æ˜¯ä¾ç„¶ä¸èƒ½åœï¼Œéœ€è¦ç»§ç»­æƒ³ä¸‹æŸ¥æ‰¾ï¼ŒçŸ¥é“æ‰¾åˆ°æœ€åä¸€å±‚èŠ‚ç‚¹ä¸ºæ­¢</p>
<p><strong>å°æ‹“å±•</strong></p>
<p>æŠŠæœ€åä¸€å±‚çš„æ•°æ®ä¸²èµ·æ¥ï¼Œæˆ‘ä»¬å°±èƒ½å®ç°åŒºé—´æŸ¥è¯¢ï¼Œæ¯”å¦‚æŸ¥è¯¢å­¦å¥½ä¸º 12 åˆ° 22 çš„æ‰€æœ‰å­¦ç”Ÿçš„æ•°æ®</p>
<p><img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021255491.png" alt="" /></p>
<p><strong>ä¸€ä¸ª demo</strong>
<img src="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202021255706.png" alt="" /></p>
<p><strong>å¿«è¦å¿˜è®°çš„å›ºæ€ç¡¬ç›˜</strong></p>
<p>å¦‚æœä½ ç”¨çš„æ˜¯å›ºæ€ç¡¬ç›˜ï¼Œé‚£ä¹ˆ B+ æ ‘......å’</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ioclub-1"><a class="header" href="#ioclub-1">ioclub</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2021-åç«¯"><a class="header" href="#2021-åç«¯">2021-åç«¯</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_1"><a class="header" href="#backend_1">backend_1</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_2"><a class="header" href="#backend_2">backend_2</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_3"><a class="header" href="#backend_3">backend_3</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_4"><a class="header" href="#backend_4">backend_4</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2021-åç«¯-1"><a class="header" href="#2021-åç«¯-1">2021-åç«¯</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_1-1"><a class="header" href="#backend_1-1">backend_1</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_2-1"><a class="header" href="#backend_2-1">backend_2</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_3-1"><a class="header" href="#backend_3-1">backend_3</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backend_4-1"><a class="header" href="#backend_4-1">backend_4</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2021-åç«¯-2"><a class="header" href="#2021-åç«¯-2">2021-åç«¯</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è®¡ç®—æœºç»„æˆåŸç†"><a class="header" href="#è®¡ç®—æœºç»„æˆåŸç†">è®¡ç®—æœºç»„æˆåŸç†</a></h1>
<h2 id="41-å­˜å‚¨å™¨æ¦‚è¿°"><a class="header" href="#41-å­˜å‚¨å™¨æ¦‚è¿°">4.1 å­˜å‚¨å™¨æ¦‚è¿°</a></h2>
<h3 id="åˆ†ç±»"><a class="header" href="#åˆ†ç±»">åˆ†ç±»</a></h3>
<p>æŒ‰å­˜å‚¨ä»‹è´¨ï¼š</p>
<ul>
<li>
<p>1 åŠå¯¼ä½“å­˜å‚¨å™¨ï¼šTTL, MOS (å®¹æ˜“ä¸¢å¤±ï¼Œæ–­ç”µå°±æ²¡)</p>
</li>
<li>
<p>2.1 ç£è¡¨é¢å­˜å‚¨å™¨ï¼š(å¡‘æ–™æˆ–é‡‘å±åŸºç‰‡æ¶‚ç£å±‚å¹¶ç£åŒ–) ç£å¤´ ç£è½½ä½“ (ç›˜ç‰‡)</p>
</li>
<li>
<p>2.2 ç£èŠ¯å­˜å‚¨å™¨ï¼šç¡¬ç£ææ–™ ç¯å½¢å…ƒä»¶</p>
</li>
<li>
<p>3 å…‰ç›˜å­˜å‚¨å™¨ï¼šæ¿€å…‰ ç£å…‰ææ–™</p>
</li>
</ul>
<p>æŒ‰å­˜å‚¨æ–¹å¼ï¼š</p>
<ol>
<li>
<p>å­˜å–æ—¶é—´ä¸åœ°å€æ— å…³ (éšæœºè®¿é—®)</p>
<ul>
<li>éšæœºå­˜å‚¨å™¨ (RAM random-access memory) åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯è¯»å¯å†™</li>
<li>åªè¯»å­˜å‚¨å™¨ (ROM read-only memory) åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­åªè¯»</li>
</ul>
</li>
<li>
<p>å­˜å–æ—¶é—´ä¸åœ°å€æœ‰å…³ (ä¸²è¡Œè®¿é—®)</p>
<ul>
<li>é¡ºåºå­˜å‚¨å­˜å‚¨å™¨ ç£å¸¦</li>
<li>ç›´æ¥å­˜å‚¨å­˜å‚¨å™¨ ç¡¬ç›˜ (å®šä½ ç£å¤´ä¸€æ ‹ï¼Œåœåœ¨æŒ‡å®šçš„æŸ±é¢ä¸Šï¼Œè¯»å†™å¤´ç§»åŠ¨åˆ°æŸ±é¢ä¸‹ï¼Œç­‰å¾…ç£ç›˜æŒ‡å®šçš„åŒºåŸŸæ—‹è½¬è¿‡æ¥)</li>
</ul>
</li>
</ol>
<p>æŒ‰åœ¨è®¡ç®—æœºä¸­çš„ä½œç”¨ï¼š</p>
<ol>
<li>ä¸»å­˜å‚¨å™¨
<ul>
<li>RAM
<ul>
<li>é™æ€ RAM cache</li>
<li>åŠ¨æ€ RAM å†…å­˜æ¡</li>
</ul>
</li>
<li>ROM
<ul>
<li>MROM å‡ºå‚å‚å®¶å†™å…¥</li>
<li>PROM ä¸€æ¬¡å¯ç¼–ç¨‹</li>
<li>EPROM å¯æ“¦é‹ï¼Œå¯ç¼–ç¨‹ ROM, æ“¦å†™å¤æ‚</li>
<li>EEPROM æ›´å®¹æ˜“æ“¦å†™</li>
</ul>
</li>
</ul>
</li>
<li>Flash Memory å¤§ç¡¬ç›˜ç¼“å†²</li>
<li>é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨ (Cache)</li>
<li>è¾…åŠ©å­˜å‚¨å™¨ ç£ç›˜ ç£å¸¦ å…‰ç›˜</li>
</ol>
<h3 id="å±‚æ¬¡ç»“æ„"><a class="header" href="#å±‚æ¬¡ç»“æ„">å±‚æ¬¡ç»“æ„</a></h3>
<ol>
<li>å­˜å‚¨å™¨çš„ä¸‰ä¸ªä¸»è¦ç‰¹æ€§çš„å…³ç³»</li>
</ol>
<p>é€Ÿåº¦ ä»·æ ¼ å®¹é‡</p>
<p>å¯„å­˜å™¨ &gt; ç¼“å­˜ &gt; ä¸»å­˜ &gt; ç¡¬ç›˜ &gt; å…‰ç›˜ &gt; ç£å¸¦</p>
<ol start="2">
<li>å­˜å‚¨å±‚æ¬¡</li>
</ol>
<ul>
<li>cache &lt;=&gt; ä¸»å­˜
<ul>
<li>è§£å†³ CPU å’Œä¸»å­˜é€Ÿåº¦å·®å¼‚è¿‡å¤§</li>
</ul>
</li>
<li>ä¸»å­˜ &lt;=&gt; è¾…å­˜
<ul>
<li>è§£å†³å®¹é‡é—®é¢˜</li>
<li>è™šæ‹Ÿåœ°å€ç©ºé—´</li>
</ul>
</li>
</ul>
<pre><code>   +-----------------------------+
   |                             |
+--+--+      +-------+        +--+--+        +-----+
|     |------|       |--------|     |--------|     |
| CPU |      | cache |        | ä¸»å­˜ |       | è¾…å­˜ |
|     |------|       |--------|     |--------|     |
+--+--+      +-------+        +--+--+        +-----+
   |                             |
   +-----------------------------+
</code></pre>
<h2 id="42-ä¸»å­˜å‚¨å™¨"><a class="header" href="#42-ä¸»å­˜å‚¨å™¨">4.2 ä¸»å­˜å‚¨å™¨</a></h2>
<h3 id="æ¦‚è¿°-5"><a class="header" href="#æ¦‚è¿°-5">æ¦‚è¿°</a></h3>
<ol>
<li>ä¸»å­˜å‚¨å™¨åŸºæœ¬ç»„æˆ</li>
</ol>
<pre><code>+-------+     +---------+       +-----+
|       |&lt;---&gt;|         |&lt;-----&gt;|     |  æ•°æ®æ€»çº¿
| å­˜å‚¨ä½“ |     | è¯»å†™ç”µè·¯ |       | MDR | &lt;========&gt;
|       |&lt;---&gt;|         |&lt;-----&gt;|     |
+-------+     +---------+       +-----+
  ï¿ª   ï¿ª          ï¿ª   ï¿ª
+-------+     +---------+
| é©±åŠ¨å™¨ |     | æ§åˆ¶ç”µè·¯ |
+-------+     +---------+
  ï¿ª   ï¿ª          ï¿ª   ï¿ª
+-------+       è¯»   å†™
| è¯‘ç å™¨ |
+-------+
  ï¿ª   ï¿ª
+-------+
|  MAR  |
+-------+
    ï¿ª
    | åœ°å€æ€»çº¿
    |
</code></pre>
<p>MAR ä¸­ä¿å­˜äº†ç”± 01 ä»£ç æ„æˆçš„åœ°å€ è¯‘ç å™¨å°† 01 ä»£ç è¯‘ç ä¹‹åä¼šå¯¹åº”å­˜å‚¨ä½“çš„å­˜å‚¨å•å…ƒ
æ¥ç€é€‰ä¸­çš„å­˜å‚¨å•å…ƒçš„å¼€å…³æ‰“å¼€ï¼Œå­˜å‚¨ä½“ä¸­çš„æ•°æ®ä¼šé€åˆ°æ•°æ®çº¿ä¸Šï¼Œæˆ–è€…æ•°æ®çº¿ä¸Šçš„æ•°æ®ä¼šä¿å­˜åˆ°å­˜å‚¨å•å…ƒé‡Œ</p>
<ol start="2">
<li>ä¸»å­˜å’Œ CPU çš„è”ç³»</li>
</ol>
<pre><code>+------------+
|            |
| +-------+  | æ•°æ®æ€»çº¿   +-------+
| |  MAR  |&lt;=|==========&gt;|       |
| +-------+  |           |       |
|            |     è¯»    |       |
|            |----------&gt;|       |
|     CPU    |     å†™    |  ä¸»å­˜  |
|            |----------&gt;|       |
|            |           |       |
| +-------+  | åœ°å€æ€»çº¿   |       |
| |  MAR  |==|==========&gt;|       |
| +-------+  |           +-------+
|            |
+------------+
</code></pre>
<ul>
<li>å­˜å‚¨å™¨å’Œä¸»å­˜éœ€è¦æ•°æ®äº¤æ¢ï¼Œæ‰€ä»¥æ•°æ®æ€»çº¿æ˜¯åŒå‘çš„</li>
<li>è¯»å’Œå†™éƒ½æ˜¯ç«™åœ¨ CPU è§’åº¦æ¥è¯´çš„ï¼ŒCPU éœ€è¦å‘å‡ºè¯»æˆ–è€…å†™ä¿¡å·</li>
</ul>
<ol start="3">
<li>ä¸»å­˜ä¸­å­˜å‚¨å•å…ƒåœ°å€çš„åˆ†é…</li>
</ol>
<pre><code>å­—åœ°å€      å­—èŠ‚åœ°å€         å­—åœ°å€      å­—èŠ‚åœ°å€
  0    +--+--+--+--+         0    +--+--+--+--+
  4    |1 |2 |3 |4 |         4    |4 |3 |2 |1 |
  8    |5 |6 |7 |8 |         8    |8 |7 |6 |5 |
       +--+--+--+--+              +--+--+--+--+
       å°ç«¯å¯¹é½                       å¤§ç«¯å¯¹é½
</code></pre>
<p>ä¸¾ä¾‹ï¼šå°† 16 è¿›åˆ¶æ•° 0X12345678H å­˜å‚¨</p>
<pre><code>å­—åœ°å€      å­—èŠ‚åœ°å€        å­—åœ°å€      å­—èŠ‚åœ°å€
  0    +--+--+--+--+       0    +--+--+--+--+
  4    |12|34|56|78|       4    |78|56|34|12|
       +--+--+--+--+            +--+--+--+--+
</code></pre>
<ol start="4">
<li>å­˜å‚¨å™¨çš„æŠ€æœ¯æŒ‡æ ‡</li>
</ol>
<ul>
<li>å­˜å‚¨å®¹é‡ï¼šä¸»å­˜å­˜å‚¨äºŒè¿›åˆ¶ä»£ç çš„æ€»ä½æ•°</li>
<li>å­˜å‚¨é€Ÿåº¦
<ul>
<li>å­˜å–æ—¶é—´ï¼šå­˜å‚¨å™¨çš„è®¿é—®æ—¶é—´ï¼Œè¯»å‡ºæ—¶é—´ï¼Œå†™å…¥æ—¶é—´</li>
<li>å­˜å–å‘¨æœŸï¼šè¿ç»­ä¸¤æ¬¡ç‹¬ç«‹çš„å­˜å‚¨å™¨æ“ä½œ (è¯»æˆ–å†™) æ‰€éœ€è¦çš„æœ€å°é—´éš”æ—¶é—´</li>
</ul>
</li>
<li>å­˜å‚¨å™¨çš„å¸¦å®½</li>
</ul>
<h3 id="åŠå¯¼ä½“èŠ¯ç‰‡æ¦‚è¿°"><a class="header" href="#åŠå¯¼ä½“èŠ¯ç‰‡æ¦‚è¿°">åŠå¯¼ä½“èŠ¯ç‰‡æ¦‚è¿°</a></h3>
<h4 id="1-åŸºæœ¬ç»“æ„"><a class="header" href="#1-åŸºæœ¬ç»“æ„">1. åŸºæœ¬ç»“æ„</a></h4>
<pre><code>         +-------------------------+
         | +----+   +----+  +----+ |
  åœ°å€çº¿  | | è¯‘ |   | å­˜ |   | è¯» | |  æ•°æ®çº¿
  =====&gt; | | ç  |   | å‚¨ |   | å†™ | | &lt;=====&gt;
         | | é©± |   | çŸ© |   | ç”µ | |
         | | åŠ¨ |   | é˜µ |   | è·¯ | |
         | +----+   +----+  +----+ |
ç‰‡é€‰çº¿---&gt;|                         | &lt;--- è¯»/å†™æ§åˆ¶çº¿
         +-------------------------+
</code></pre>
<ul>
<li>
<p>åœ°å€çº¿ï¼šå•å‘ï¼Œç”±å¤–éƒ¨è¾“å…¥ï¼Œèƒ½å¤Ÿè¡¨ç¤ºæœ‰å¤šå°‘ä¸ªå­˜å‚¨å•å…ƒ</p>
</li>
<li>
<p>æ•°æ®çº¿ï¼šåŒå‘ï¼Œè¯»å‡ºå’Œå†™å…¥çš„æ•°æ®éƒ½é€šè¿‡æ•°æ®çº¿ä¼ è¾“ï¼Œè¡¨ç¤ºå­˜å‚¨å•å…ƒæœ‰å¤šå°‘ä¿¡æ¯</p>
</li>
<li>
<p>ç‰‡é€‰çº¿ï¼šå†…å­˜æ¡ä¸Šæœ‰å¾ˆå¤šèŠ¯ç‰‡ï¼Œéœ€è¦ç”±å®ƒç¡®å®šã€‚(CS/CE)</p>
<p>ä¸€ä¸ªå­˜å‚¨å•å…ƒçš„å®¹é‡æ˜¯ 1bï¼Œéœ€è¦ 8 ä¸ªå­˜å‚¨å•å…ƒç»„æˆä¸€ç»„æ‰èƒ½è¡¨ç¤º 1 å­—èŠ‚ï¼Œå¾ˆå¤šç»„å°±æ„æˆäº†ä¸€ä¸ªå¤§å­˜å‚¨å™¨ï¼Œç‰‡é€‰çº¿èƒ½å¤ŸæŒ‡å®šç»„</p>
</li>
<li>
<p>è¯»/å†™æ§åˆ¶çº¿ï¼šè¯»å†™çš„æ§åˆ¶ä¿¡å· (ä¾‹å¦‚ WE ä½ç”µå¹³å†™ï¼Œé«˜ç”µå¹³è¯»ï¼ŒOE å…è®¸è¯»ï¼ŒWE å…è®¸å†™)</p>
</li>
</ul>
<p>èŠ¯ç‰‡å®¹é‡ = 2 ^ åœ°å€çº¿æ¡æ•° Ã— 2 ^ æ•°æ®çº¿æ¡æ•°</p>
<h4 id="2-è¯‘ç å™¨"><a class="header" href="#2-è¯‘ç å™¨">2. è¯‘ç å™¨</a></h4>
<p>å°†è¾“å…¥åœ°å€æ˜ å°„åˆ°å¯¹åº”çš„çº¿è·¯ï¼Œæ‰¾åˆ°å¯¹åº”çš„å­˜å‚¨å•å…ƒ</p>
<ul>
<li>çº¿é€‰æ³•ï¼šæ¯ä¸ªåœ°å€éƒ½å¯¹åº”ä¸€æ ¹çº¿ï¼Œçº¿å¤ªå¤šä¸ç°å®</li>
<li>é‡åˆæ³•ï¼šåœ°å€ä¿¡å·åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå¯ä»¥ç­‰åˆ†ä¹Ÿå¯ä»¥ä¸ç­‰åˆ†ï¼ŒæŒ‰ç…§çŸ©é˜µçš„ x y é€‰æ‹©</li>
</ul>
<h4 id="3-éšæœºå­˜å–å­˜å‚¨å™¨-ram"><a class="header" href="#3-éšæœºå­˜å–å­˜å‚¨å™¨-ram">3. éšæœºå­˜å–å­˜å‚¨å™¨ (RAM)</a></h4>
<ol>
<li>é™æ€ RAM(SRAM)</li>
</ol>
<p>è¡Œé€‰ï¼Œåˆ—é€‰åŒæ—¶æ‰“å¼€ï¼Œå®Œæˆè¯»å†™æ“ä½œ</p>
<ol start="2">
<li>åŠ¨æ€ RAM(DRAM)</li>
</ol>
<p>å‡å¦‚æ•°æ®ä¿å­˜çš„æ˜¯ 0</p>
<ul>
<li>é¢„å……ç”µï¼šè¯»æ•°æ®çº¿ä¸ºé«˜ç”µå¹³ 1</li>
<li>è¯»é€‰æ‹©çº¿æœ‰æ•ˆï¼Œè¿™æ˜¯è¯»å‡ºçš„æ•°æ®ä¸º 1ï¼Œéœ€è¦å–åçš„åˆ°çœŸå®æ•°æ®</li>
</ul>
<p>å‡å¦‚æ•°æ®ä¿å­˜çš„æ˜¯ 1</p>
<ul>
<li>æ•°æ®æ˜¯é«˜ç”µå¹³ï¼Œt1 ä¹Ÿå¯¼é€šï¼Œæ¥åœ°ï¼Œ</li>
<li>æ•°æ®ç”µå®¹æ”¾ç”µä¼šå˜ä¸º 0ï¼Œè¯»æ•°æ®çº¿ä¹Ÿä¼šå˜ä¸ºä½ç”µå¹³
<blockquote>
<p>æ³¨æ„ï¼šè¯»æ•°æ®çº¿ä¸èƒ½ä¸€ç›´å……ç”µ</p>
</blockquote>
</li>
<li>è¿™æ˜¯è¯»é€‰æ‹©çº¿ä¼šè¯»åˆ° 0, å–åå¾—åˆ°çœŸå®æ•°æ®</li>
<li><strong>æ³¨æ„</strong>: å› ä¸ºæ•°æ®æ”¹å˜äº†ï¼Œéœ€è¦é‡æ–°å†™å…¥åŸå§‹æ•°æ®ã€‚å†™å…¥æ—¶å°±é€šè¿‡å†™é€‰æ‹©çº¿å†™å…¥ï¼Œå†™é€‰æ‹©çº¿ä¼šæ§åˆ¶ä¸€æ•´è¡Œ</li>
</ul>
<ol start="3">
<li>åŠ¨æ€ RAM æ—¶åº</li>
</ol>
<p>è¡Œåˆ—åœ°å€åˆ†å¼€ä¼ é€</p>
<ul>
<li>å¼•è„šæ•°é‡æ›´å°‘ï¼Œé€Ÿåº¦ç›¸å¯¹ä¼šæ…¢</li>
<li>é™æ€ RAM ä¹Ÿå¯ä»¥å®ç°ï¼Œä½†æ˜¯å®ƒé€Ÿåº¦æ›´å¿«ï¼Œä»·æ ¼æ›´é«˜ï¼Œä¸èƒ½èˆå¼ƒæ€§èƒ½</li>
</ul>
<h4 id="4-åªè¯»å­˜å‚¨å™¨"><a class="header" href="#4-åªè¯»å­˜å‚¨å™¨">4. åªè¯»å­˜å‚¨å™¨</a></h4>
<ol>
<li>æ©è†œ ROM(MROM)</li>
</ol>
<ul>
<li>
<p>å‡ºå‚æ—¶å†™å…¥ï¼Œä¸èƒ½ä¿®æ”¹</p>
</li>
<li>
<p>å¯ä»¥ä¿å­˜å¸¸ç”¨çš„å‡½æ•°ç­‰</p>
</li>
<li>
<p>è¡Œåˆ—é€‰æ‹©çº¿äº¤å‰å¤„æœ‰ MOS ç®¡ä¸º 1</p>
</li>
<li>
<p>è¡Œåˆ—é€‰æ‹©çº¿äº¤å‰å¤„æ—  MOS ç®¡ä¸º 0</p>
</li>
</ul>
<ol start="2">
<li>PROM (ä¸€æ¬¡æ€§ç¼–ç¨‹)</li>
</ol>
<p>èä¸</p>
<ol start="3">
<li>EPROM(å¤šæ¬¡æ€§ç¼–ç¨‹)</li>
</ol>
<p>å¿…é¡»æ•´å—æ“¦å‡º</p>
<ol start="4">
<li>EPPRAM</li>
</ol>
<ul>
<li>ç”µå¯æ“¦å†™</li>
<li>å±€éƒ¨æ“¦å†™</li>
<li>å…¨éƒ¨æ“¦å†™</li>
</ul>
<ol start="5">
<li>Flash Memory(é—ªé€Ÿå‹å­˜å‚¨å™¨)</li>
</ol>
<h4 id="5-å­˜å‚¨å™¨å’Œ-cpu-çš„è¿æ¥"><a class="header" href="#5-å­˜å‚¨å™¨å’Œ-cpu-çš„è¿æ¥">5. å­˜å‚¨å™¨å’Œ CPU çš„è¿æ¥</a></h4>
<p>å­˜å‚¨å™¨å®¹é‡çš„æ‹“å±•</p>
<ol>
<li>ä½æ‹“å±•ï¼ˆå¢åŠ å­˜å‚¨å­—é•¿ï¼‰</li>
</ol>
<p>ç”¨ 16K Ã— 4 ä½ çš„å­˜å‚¨èŠ¯ç‰‡ç»„æˆ 1K Ã— 8 ä½çš„å­˜å‚¨å™¨</p>
<ul>
<li>
<p>å‡†å¤‡ä¸¤ä¸ªèŠ¯ç‰‡ï¼ˆä»¥ 2114 ä¸ºä¾‹ï¼‰</p>
</li>
<li>
<p>1K å¯¹åº” 10 æ ¹åœ°å€çº¿ï¼Œåˆ†åˆ«è¿æ¥åˆ°ä¸¤ä¸ªèŠ¯ç‰‡ä¸Š</p>
</li>
<li>
<p>æ¯ä¸€ä¸ªèŠ¯ç‰‡è¾“å‡º 4 ä½æ•°æ®ï¼ŒæŠŠå®ƒä»¬åˆ†åˆ«æ¥åˆ° 8 æ ¹åœ°å€çº¿ä¸Š</p>
</li>
<li>
<p>ç‰‡é€‰çº¿ä¼šåŒæ—¶é€‰ä¸­ä¸¤ä¸ªèŠ¯ç‰‡ï¼Œä»–ä»¬ä¼šåŒæ—¶å·¥ä½œ</p>
</li>
</ul>
<ol start="2">
<li>å­—æ‹“å±•ï¼ˆå¢åŠ å­˜å‚¨å™¨å™¨çš„å®¹é‡ï¼‰</li>
</ol>
<p>ç”¨ 1K Ã— 8 ä½çš„å­˜å‚¨èŠ¯ç‰‡ç»„æˆ 2K Ã— 8 ä½çš„å­˜å‚¨å™¨</p>
<p>2K å¯¹åº” 11 æ ¹åœ°å€çº¿</p>
<p>ä½¿ç”¨æœ€é«˜ä½ä½œä¸ºèŠ¯ç‰‡é€‰æ‹©çš„ä¿¡å·</p>
<ol start="3">
<li>å­—ä½æ‹“å±•</li>
</ol>
<p>ç”¨ 1K Ã— 4 ä½çš„å­˜å‚¨èŠ¯ç‰‡ç»„æˆ 4K Ã— 8 ä½</p>
<p>å…ˆç”¨ä¸¤ä¸ª 1K Ã— 4 çš„ç»„æˆ 1 ä¸ª 1K Ã— 8 çš„</p>
<pre><code>4K å¯¹åº” 12 æ ¹åœ°å€çº¿
4K A11 A10 A9 ... A1 A0

1K         A9 ... A1 A0
</code></pre>
<p>å¯ä»¥ç”¨æœ€é«˜ 2 ä½é€‰æ‹© 4 ä¸ªèŠ¯ç‰‡ï¼Œä¸¤ä½è¯‘ç å‡º 4 æ ¹çº¿ï¼Œå†³å®šæ˜¯å“ªä¸€ä¸ªèŠ¯ç‰‡</p>
<p>å­˜å‚¨å™¨ä¸ CPU çš„è¿æ¥</p>
<ol>
<li>
<p>åœ°å€çº¿çš„è¿æ¥</p>
</li>
<li>
<p>æ•°æ®çº¿çš„è¿æ¥</p>
</li>
<li>
<p>è¯»/å†™å‘½ä»¤çº¿çš„è¿æ¥</p>
</li>
<li>
<p>ç‰‡é€‰çº¿çš„è¿æ¥</p>
</li>
<li>
<p>åˆç†é€‰æ‹©å­˜å‚¨èŠ¯ç‰‡</p>
</li>
<li>
<p>å…¶ä»–ï¼Œæ—¶åºï¼Œè´Ÿè½½</p>
</li>
</ol>
<h4 id="6-å­˜å‚¨å™¨çš„æ ¡éªŒ"><a class="header" href="#6-å­˜å‚¨å™¨çš„æ ¡éªŒ">6. å­˜å‚¨å™¨çš„æ ¡éªŒ</a></h4>
<ol>
<li>å¥‡å¶æ ¡éªŒ</li>
</ol>
<p>è®¡ç®—ä¸€ç»„å­˜å‚¨å•å…ƒä¸­ 1 çš„ä¸ªæ•°ï¼Œå¦‚æœ 1 çš„ä¸ªæ•°æ˜¯å¶æ•°ï¼Œæ ¡éªŒç å°±ä¸º 0, 1 çš„ä¸ªæ•°æ˜¯å¥‡æ•°ï¼Œæ ¡éªŒç å˜ä¸º 1</p>
<p>å‡å¦‚çº é”™ç å‘ç”Ÿç¿»è½¬å‘¢ï¼Ÿå¹¶æ— å½±å“</p>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>åªèƒ½çŸ¥é“å‡ºé”™ï¼Œä½†ä¸çŸ¥åˆ°å‡ºé”™çš„ä½ç½®</li>
<li>å¦‚æœæœ‰å¶æ•°ä½å‘ç”Ÿç¿»è½¬ï¼Œæ— æ³•æ£€æŸ¥åˆ°å‡ºé”™</li>
</ul>
<ol start="2">
<li>æ±‰æ˜ç </li>
</ol>
<p>å°†æ•°æ®åˆ†ç»„ï¼Œå¹¶åˆ©ç”¨äºŒåˆ†æ³•åå¤ç¡®è®¤å¯¹æ¯”é”™è¯¯ï¼Œèƒ½å¤Ÿå‘ç°ä¸¤ä¸ªæ•°æ®ç¿»è½¬ï¼Œæ— æ³•è§£å†³ 3 ä¸ªæ•°æ®ç¿»è½¬</p>
<p>ç”±äºæ±‰æ˜ç çš„æ€§è´¨ï¼Œçº é”™ç å‡ºç°åœ¨ 2^n ä½ä¸Šã€‚æ•°æ®å—è¶Šå¤§ï¼Œçº é”™å—çš„ç›¸å¯¹å æ¯”å°±è¶Šå°‘</p>
<ol start="3">
<li>LDPC</li>
</ol>
<h4 id="7-æé«˜è®¿å­˜é€Ÿåº¦"><a class="header" href="#7-æé«˜è®¿å­˜é€Ÿåº¦">7. æé«˜è®¿å­˜é€Ÿåº¦</a></h4>
<ul>
<li>é‡‡ç”¨é«˜é€Ÿå™¨ä»¶</li>
<li>é‡‡ç”¨å±‚æ¬¡ç»“æ„ Cache-ä¸»å­˜</li>
<li>è°ƒæ•´ä¸»å­˜ç»“æ„</li>
</ul>
<ol>
<li>å•ä½“å¤šå­—ç»“æ„</li>
</ol>
<p>æ¯æ¬¡å‘æ•°æ®ä¸­å–å‡ºå¤šä¸ªè®°å½•</p>
<p>å¸¦å®½å¯èƒ½æé«˜ 4 å€</p>
<ol start="2">
<li>å¤šä½“å¹¶è¡Œç³»ç»Ÿ</li>
</ol>
<ul>
<li>
<p>é«˜ä½äº¤å‰ï¼Œé¡ºåºç¼–å€</p>
<p>ä¸åŒå­˜å‚¨ä½“ä¹‹é—´å¯ä»¥å¹¶è¡Œï¼Œä½†æ˜¯ CPU åªä¼šé¢‘ç¹è®¿é—®æŸä¸€ä¸ªå­˜å‚¨ä½“</p>
</li>
<li>
<p>ä½ä½äº¤å‰ï¼Œå„ä¸ªå­˜å‚¨ä½“è½®æµç¼–å€</p>
<p>éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶ï¼Œåœ¨å­˜å–å‘¨æœŸå†…</p>
</li>
</ul>
<h2 id="43-é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨"><a class="header" href="#43-é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨">4.3 é«˜é€Ÿç¼“å†²å­˜å‚¨å™¨</a></h2>
<h3 id="1"><a class="header" href="#1">1.</a></h3>
<h3 id="2cache-å’Œ-ä¸»å­˜çš„æ˜ å°„"><a class="header" href="#2cache-å’Œ-ä¸»å­˜çš„æ˜ å°„">2.Cache å’Œ ä¸»å­˜çš„æ˜ å°„</a></h3>
<ol>
<li>ç›´æ¥æ˜ å°„</li>
</ol>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¯ä¸ªç¼“å­˜å— i å’Œè‹¥å¹²ä¸ªä¸»å­˜å—å¯¹åº”</li>
<li>æ¯ä¸ªä¸»å­˜å— j åªèƒ½å’Œ 1 å¹²ä¸ªç¼“å­˜å—å¯¹åº”</li>
</ul>
<p>è¿‡ç¨‹ï¼š</p>
<ul>
<li>å°†ä¸»å­˜å‚¨å™¨çš„æ¯ä¸ªå•å…ƒæŒ‰ç…§æ‰€åœ¨åœ°å€å–æ¨¡ï¼ˆCache å¤§å°ï¼‰åˆ†ç»„</li>
<li>æ ¹æ®åœ°å€å°±èƒ½ç›´æ¥æ‰¾åˆ°åœ°å€åœ¨ Cache ä¸­çš„ä½ç½®ï¼Œ</li>
<li>æ¥ç€åœ¨ç»è¿‡æ¯”è¾ƒå™¨æ¯”è¾ƒç»„å·æ˜¯å¦å¯¹åº”åˆ¤æ–­æ˜¯å¦å‘½ä¸­</li>
</ul>
<p>ä¼˜ç‚¹ï¼šé€Ÿåº¦å¿«</p>
<ul>
<li>åªéœ€è¦ä¸€ä¸ªé¢å¤–çš„æ ‡è®°ï¼Œç»„å·</li>
<li>CPU ä¸‰çº§ç¼“å­˜ï¼Œé€‚åˆåšä¸ºä¸€çº§ç¼“å­˜ï¼Œè¿½æ±‚æè‡´é€Ÿåº¦</li>
</ul>
<p>ç¼ºç‚¹ï¼šåˆ©ç”¨ç‡ä¸é«˜ï¼Œ</p>
<ul>
<li>å‡å¦‚ Cache ä¸æ»¡ï¼Œ1 å·å·²ç»è¢«å ç”¨ï¼Œå…¶ä»–ç»„ 1 å·çš„å­˜å‚¨è®°å½•ä¹Ÿä¸èƒ½åˆ©ç”¨åˆ°ç©ºçš„ Cache èµ„æº</li>
</ul>
<ol start="2">
<li>å…¨ç›¸è¿æ˜ å°„</li>
</ol>
<p>ç‰¹ç‚¹ï¼š</p>
<ul>
<li>
<p>ä¸»å­˜çš„ä»»ä¸€å—å¯ä»¥æ˜ å°„åˆ° Cache çš„ä»»ä¸€å—</p>
</li>
<li>
<p>ä¸»å­˜å‚¨å™¨ä¾ç„¶éœ€è¦åˆ†ç»„</p>
</li>
<li>
<p>Cache éœ€è¦é™¤äº†ç»„å·ï¼Œè¿˜è¦æ ‡è®°ç¬¬å‡ ä½</p>
</li>
<li>
<p>åœ¨æ¯”è¾ƒæ—¶éœ€è¦åŒæ—¶æ¯”è¾ƒç»„å·ï¼Œä½å·</p>
</li>
</ul>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>åˆ©ç”¨ç‡é«˜</li>
<li>é€‚åˆåšä¸º CPU åå‡ çº§ç¼“å­˜</li>
</ul>
<ol start="3">
<li>ç»„ç›¸è¿æ˜ å°„</li>
</ol>
<p>å‰ä¸¤ç§æ–¹æ³•çš„æŠ˜ä¸­</p>
<p>è®©æ¯ä¸ªä¸»å­˜å—å¯ä»¥å’Œ n ä¸ª ç¼“å­˜å—å¯¹åº”ï¼Œå®ƒå¯ä»¥é€‰æ‹©è¿™ n ä¸ªä¸­çš„ä»»æ„ä¸€ä¸ª</p>
<h3 id="3æ›¿æ¢ç®—æ³•"><a class="header" href="#3æ›¿æ¢ç®—æ³•">3.æ›¿æ¢ç®—æ³•</a></h3>
<ol>
<li>å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰</li>
</ol>
<p>æ²¡æœ‰ä½“ç°ç¨‹åºçš„å±€éƒ¨å‹åŸç†</p>
<ol start="2">
<li>æœ€è¿‘æœ€å°‘ä½¿ç”¨ç®—æ³•ï¼ˆLRUï¼‰</li>
</ol>
<p>å¾ˆå¥½ä½“ç°ç¨‹åºçš„å±€éƒ¨å‹åŸç†</p>
<p>å®ç°å¤æ‚ï¼šï¼ˆæ»‘åŠ¨çª—å£ + æ¬¡æ•°ï¼‰ï¼Ÿ</p>
<p>æœ€è¿‘æœ€æ—§ä½¿ç”¨ç®€å•æ›¿ä»£ï¼Ÿ</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è®¡ç®—æœºç½‘ç»œ"><a class="header" href="#è®¡ç®—æœºç½‘ç»œ">è®¡ç®—æœºç½‘ç»œ</a></h1>
<h2 id="1-æ¦‚è¿°"><a class="header" href="#1-æ¦‚è¿°">1. æ¦‚è¿°</a></h2>
<h2 id="2-åº”ç”¨å±‚"><a class="header" href="#2-åº”ç”¨å±‚">2. åº”ç”¨å±‚</a></h2>
<h3 id="ç”µè·¯äº¤æ¢-circuit-switching"><a class="header" href="#ç”µè·¯äº¤æ¢-circuit-switching">ç”µè·¯äº¤æ¢ circuit-switching</a></h3>
<p>é¢‘åˆ†ï¼Œæ—¶åˆ†</p>
<p>å»ºç«‹è¿æ¥ - æ•°æ®ä¼ è¾“ - é‡Šæ”¾èµ„æº</p>
<h3 id="åˆ†ç»„-åŒ…-äº¤æ¢-package-switching"><a class="header" href="#åˆ†ç»„-åŒ…-äº¤æ¢-package-switching">åˆ†ç»„ (åŒ…) äº¤æ¢ package-switching</a></h3>
<p>ä¸ºæ¯ä¸€ä¸ªè¿æ¥åªåˆ†é…ä¸€å°å—èµ„æºï¼ŒåŒæ—¶æœåŠ¡å¤šä¸ª (ç”¨æˆ·) è¿æ¥</p>
<p>ç«¯åˆ°ç«¯</p>
<ul>
<li>
<p>æ‰€æœ‰æ•°æ®åŒ…éƒ½æ˜¯åˆ©ç”¨çš„å®Œæ•´çš„å¸¦å®½ï¼Œå¸¦å®½ä¸ç”¨åˆ†ç‰‡</p>
</li>
<li>
<p>é™åˆ¶åœ¨äº¤æ¢æœºè½¬å‘çš„èƒ½åŠ›</p>
</li>
<li>
<p>ä¸éœ€è¦é¢„ç•™èµ„æº</p>
</li>
<li>
<p>ä¸éœ€è¦æå‰å’Œè½¬å‘è®¾å¤‡æ²Ÿé€šï¼Œ</p>
</li>
<li>
<p>éœ€è¦å­˜å‚¨è½¬å‘</p>
</li>
<li>
<p>è¶…è¿‡è½¬å‘èƒ½åŠ›ä¼šæœ‰æ’é˜Ÿå»¶è¿Ÿï¼Œç”šè‡³äº§ç”Ÿä¸¢åŒ…</p>
<ul>
<li>ç”µè·¯äº¤æ¢ä¼šé™åˆ¶å‘é€é€Ÿç‡ï¼Œä¸ä¼šåœ¨ä¸­é—´äº§ç”Ÿä¸å¯ç”¨</li>
</ul>
</li>
</ul>
<h2 id="3-ä¼ è¾“å±‚"><a class="header" href="#3-ä¼ è¾“å±‚">3. ä¼ è¾“å±‚</a></h2>
<h3 id="1-ä¼ è¾“å±‚æœåŠ¡"><a class="header" href="#1-ä¼ è¾“å±‚æœåŠ¡">1. ä¼ è¾“å±‚æœåŠ¡</a></h3>
<ol>
<li>
<p>ä¼ è¾“å±‚å’Œç½‘ç»œå±‚çš„åŒºåˆ«</p>
<ul>
<li>ç½‘ç»œå±‚ï¼šä¸»æœºé—´çš„é€»è¾‘é€šä¿¡</li>
<li>ä¼ è¾“å±‚ï¼šè¿›ç¨‹é—´çš„é€»è¾‘é€šä¿¡</li>
</ul>
<p>ä¼ è¾“å±‚çš„æœåŠ¡ = ä¼ è¾“å±‚çš„åè®® + ç½‘ç»œå±‚çš„æœåŠ¡</p>
<p>ä¸åŒä¸»æœºè¿›ç¨‹é—´æ•°æ®ä¼ è¾“ = ä¼ è¾“å±‚çš„åè®® + è¿›ç¨‹æ‰€åœ¨ä¸»æœºé—´æ•°æ®ä¼ è¾“</p>
<p>å‘é€ç«¯ï¼š</p>
<ul>
<li>æ¥æ”¶åº”ç”¨å±‚çš„æ¶ˆæ¯</li>
<li>è®¾ç½®æŠ¥æ–‡å¤´éƒ¨å­—æ®µçš„å€¼</li>
<li>åˆ›å»ºæŠ¥æ–‡æ®µ</li>
<li>æŠŠæŠ¥æ–‡ç«¯ä¼ é€’ç»™å¯¹åº” IP</li>
</ul>
<p>æ¥æ”¶ç«¯ï¼š</p>
<ul>
<li>ä»æŸ IP æ¥æ”¶ æŠ¥æ–‡æ®µ</li>
<li>æ£€æŸ¥ header çš„å€¼</li>
<li>è§£æåº”ç”¨å±‚æ¶ˆæ¯</li>
<li>é€šè¿‡ socket æŠŠæ•°æ®å¤šè·¯åˆ†è§£åˆ°åº”ç”¨</li>
</ul>
</li>
<li>
<p>ä¸¤ä¸ªä¼ è¾“å±‚åè®®</p>
<p>TCP(Transmission Control Protocol):</p>
<ul>
<li>å¯é ä¼ è¾“ (reliable, in-order delivery)</li>
<li>æ‹¥å¡æ§åˆ¶ (congestion control)</li>
<li>æµé‡æ§åˆ¶ (flow control)ï¼šç¡®ä¿å‘é€ç«¯ä¸ä¼šå‘é€è¿‡å¤šæ•°æ®å¯¼è‡´æ¥æ”¶ç«¯ buffer æº¢å‡ºè€Œä¸¢åŒ…çš„æœºåˆ¶</li>
<li>é¢å‘å»ºç«‹</li>
</ul>
<p>UDP(User Datagram Protocol):</p>
<ul>
<li>ä¸å¯é ä¼ è¾“ (unreliable, unordered delivery)</li>
<li>å°½åŠ›è€Œä¸º (no-frills extension of &quot;best-effort&quot; IP)</li>
</ul>
</li>
</ol>
<h3 id="2-å¤šè·¯å¤ç”¨--å¤šè·¯åˆ†è§£"><a class="header" href="#2-å¤šè·¯å¤ç”¨--å¤šè·¯åˆ†è§£">2. å¤šè·¯å¤ç”¨ / å¤šè·¯åˆ†è§£</a></h3>
<blockquote>
<p><em>Multiplexing/demultiplexing</em></p>
</blockquote>
<ul>
<li>åˆ›å»º socket æ—¶éœ€è¦æŒ‡å®šæœ¬æœºç«¯å£å·</li>
<li>è¿æ¥ UDP æ—¶éœ€è¦æŒ‡å®šç›®çš„ä¸»æœºçš„ IP å’Œ ç«¯å£å·</li>
<li>å½“æ¥æ”¶ç«¯æ¥æ”¶åˆ° UDP æŠ¥æ–‡åä¼šæ£€æŸ¥ç›®çš„ç«¯å£ï¼Œç„¶å£æŠ•é€’åˆ°å¯¹åº”çš„è¿›ç¨‹</li>
</ul>
<p>TCP é¢å‘è¿æ¥ï¼ŒTCP socket å®šä¹‰äº†ä¸€ä¸ªå››å…ƒç»„</p>
<p>æ€»ç»“</p>
<ul>
<li>UDP å¤šè·¯åˆ†è§£åªä½¿ç”¨ç«¯å£å·</li>
<li>TCP å¤šè·¯åˆ†è§£ä½¿ç”¨ æºå’Œç›®åœ°çš„ IP å’Œ ç«¯å£</li>
<li>å¤šè·¯å¤ç”¨å’Œå¤šè·¯åˆ†è§£å‘ç”Ÿåœ¨æ‰€æœ‰å±‚</li>
</ul>
<h3 id="3-æ— è¿æ¥ä¼ è¾“-udp"><a class="header" href="#3-æ— è¿æ¥ä¼ è¾“-udp">3. æ— è¿æ¥ä¼ è¾“ UDP</a></h3>
<h4 id="udp-ç‰¹ç‚¹"><a class="header" href="#udp-ç‰¹ç‚¹">UDP ç‰¹ç‚¹</a></h4>
<ol>
<li>
<p>UDP æ˜¯ä¸€ç§å°½åŠ›è€Œä¸ºçš„åè®®</p>
<ul>
<li>UDP æŠ¥æ–‡æ®µå¯èƒ½ä¼šä¸¢å¤±</li>
<li>ä¹Ÿå¯èƒ½ä¼šä¹±åº</li>
</ul>
</li>
<li>
<p>æ— è¿æ¥</p>
<ul>
<li>UDP å‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¸éœ€è¦æ¡æ‰‹</li>
<li>æ¯ä¸€ä¸ª UDP æ•°æ®æ®µéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸Šä¸‹å¯èƒ½æ²¡æœ‰å…³ç³»</li>
<li>åªæœ‰ checkout ç”¨äºé”™è¯¯æ£€éªŒ</li>
</ul>
</li>
</ol>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦-udp"><a class="header" href="#ä¸ºä»€ä¹ˆéœ€è¦-udp">ä¸ºä»€ä¹ˆéœ€è¦ UDPï¼Ÿ</a></h4>
<ol>
<li>æ— è¿æ¥ç®€å†ï¼ˆå¯èƒ½ä¼šå¢åŠ å»¶è¿Ÿï¼‰</li>
<li>ç®€å•ï¼Œå‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¸éœ€è¦ä¿å­˜è¿æ¥çŠ¶æ€</li>
<li>æ²¡æœ‰æ‹¥å¡æ§åˆ¶ï¼ŒUDP ä¼šå°½å¯èƒ½å¿«çš„é€è¾¾</li>
</ol>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<p>æµåª’ä½“ app</p>
<ul>
<li>ä½å»¶è¿Ÿ</li>
<li>é€Ÿåº¦æ•æ„Ÿ</li>
</ul>
<p>å¦‚ä½•åœ¨ UDP ä¸Šä¸ªæ„å»ºå¯é ä¼ è¾“ï¼šåœ¨åº”ç”¨å±‚ä¸Šæ„å»ºå¯é æ€§</p>
<h4 id="udp-æŠ¥æ–‡æ®µæ ¼å¼"><a class="header" href="#udp-æŠ¥æ–‡æ®µæ ¼å¼">UDP æŠ¥æ–‡æ®µæ ¼å¼</a></h4>
<pre><code class="language-txt">+---------+---------+
| æºç«¯å£   | ç›®çš„ç«¯å£ |
+---------+---------+
| é•¿åº¦     | æ ¡éªŒå’Œ   |
+---------+---------+
| åº”ç”¨æ•°æ®ï¼ˆæ¶ˆæ¯ï¼‰     |
|                   |
+-------------------+
</code></pre>
<ul>
<li>é•¿åº¦ï¼šUDP æŠ¥æ–‡æ®µçš„é•¿åº¦ï¼ˆåŒ…å« headerï¼‰</li>
<li>æ•°æ®ï¼šä¸Šå±‚åè®®æ•°æ®ï¼Œä¾‹å¦‚ DNSï¼ŒSNMP</li>
<li>checksumï¼šé”™è¯¯æ£€æµ‹ï¼ˆæ•°å­¦æ‰‹æ®µçš„å†—ä½™ï¼‰</li>
</ul>
<h4 id="checksum-è®¡ç®—æ–¹æ³•"><a class="header" href="#checksum-è®¡ç®—æ–¹æ³•">checksum è®¡ç®—æ–¹æ³•</a></h4>
<p>å°†æ‰€æœ‰æ•°æ®æ±‚å’Œ</p>
<ul>
<li>å‡å¦‚å‘é€ 5 bit æ•°æ® (7, 11, 12, 0, 6), å®é™…ä¼šå‘é€ (7, 11, 12, 0, 6, 36)</li>
<li>æ¥æ”¶æ–¹é‡æ–°è®¡ç®—æ•°å­—ä¹‹å’Œï¼Œå¹¶ä¸æ”¶åˆ°çš„æ¯”è¾ƒ</li>
<li>å‘é€æ–¹æ³•é€çš„æ˜¯å®é™…æ•°æ®çš„åç  (-36), è¢«ç§°ä¸º checkout</li>
</ul>
<p>é—®é¢˜</p>
<p>å¦‚ä½•ç”¨ 4 bit è¡¨ç¤º 36 å’Œ -36ï¼Ÿ</p>
<p>ç­”ï¼š1s è¡¥è¿ç®—</p>
<ul>
<li><code>36 = 0001 0100</code></li>
<li><code>0100 + 0100 = 0110 = 6</code></li>
<li><code>+6 = 0100 -6 = 1001 å–åå¾—åˆ° -6</code></li>
<li><code>-36 å¯ä»¥ç”¨ 1001(9) è¡¨ç¤º</code></li>
</ul>
<pre><code class="language-txt"> 1110 0110 0110 0110
 1101 0101 0101 0101

11011 1011 1011 1011
 1011 1011 1011 1100
</code></pre>
<h3 id="4-å¯é ä¼ è¾“"><a class="header" href="#4-å¯é ä¼ è¾“">4. å¯é ä¼ è¾“</a></h3>
<h4 id="rdt"><a class="header" href="#rdt">rdt</a></h4>
<p>Rdt1.0:</p>
<ol>
<li>ä¸‹å±‚çš„ channel æ˜¯å¯é çš„
<ul>
<li>ä¸ä¼šå‘ç”Ÿæ¯”ç‰¹ç¿»è½¬</li>
<li>ä¸ä¼šä¸¢åŒ…</li>
</ul>
</li>
<li>ä¸º senderï¼Œreceiver è®¾ç½®ä¸åŒçš„ FSM
<ul>
<li>sender å’Œ receiver åˆ†åˆ«ä»ä¸‹å±‚çš„ channel å‘é€å’Œæ¥æ”¶æ•°æ®</li>
</ul>
</li>
</ol>
<p>Rdt2.0:</p>
<ul>
<li>å‘é€ç«¯å‘é€æ•°æ®</li>
<li>æ¥æ”¶ç«¯æ¥æ”¶æ•°æ®ï¼Œå¦‚æœæ¥æ”¶åˆ°çš„æ•°æ®æ­£ç¡®ï¼Œè¿”å› ACKï¼Œå¦‚æœæ•°æ®é”™è¯¯ï¼Œè¿”å› NAKã€‚</li>
<li>å‘é€ç«¯æ ¹æ®æ”¶åˆ°çš„æ˜¯ ACK è¿˜æ˜¯ NAKï¼Œé€‰æ‹©é‡ä¼ </li>
</ul>
<p>é—®é¢˜ï¼š</p>
<ol>
<li>å‡ºç°æ¯”ç‰¹ç¿»è½¬
<ul>
<li>ä½¿ç”¨ checksum æ£€æµ‹é”™è¯¯</li>
<li>ack/nak ç¡®è®¤</li>
<li>é‡ä¼ </li>
</ul>
</li>
<li>å¦‚ä½•ä»é”™è¯¯æ¢å¤ï¼š
<ul>
<li>è‡ªåŠ¨è¯·æ±‚é‡ä¼ </li>
</ul>
</li>
<li>æ–°çš„çŠ¶æ€æœº
<ul>
<li>sender ä½¿ç”¨ udt_send å‘é€æ•°æ®ï¼Œå‘é€å®Œæ¯•åç­‰å¾…æ¥æ”¶ ACKã€‚</li>
<li>å¦‚æœæ¥æ”¶åˆ°äº† ACKï¼Œå°±æ˜¯æˆåŠŸã€‚</li>
<li>å¦‚æœæ¥æ”¶åˆ°äº† NAKï¼Œå°±ä¼šé‡ä¼ ã€‚</li>
</ul>
</li>
</ol>
<p>ç¼ºç‚¹ï¼š</p>
<ol>
<li>å¦‚æœæ¥æ”¶æ–¹æˆåŠŸæ¥æ”¶ï¼Œä½†æ˜¯è¿”å›å¤±è´¥ï¼Œä¼šå¯¼è‡´æ¶ˆæ¯ä¸ä¸€è‡´</li>
</ol>
<p>rdt2.1:</p>
<p>è§£å†³åŒæ­¥é—®é¢˜ å’Œ ACK/NAK å‡ºé”™ï¼š</p>
<ul>
<li>å‘é€ç«¯å‘é€çš„æ•°æ®é™¤äº†æ•°æ®å’Œ checksum ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªåºåˆ—å·</li>
<li>åœ¨æ¥æ”¶ç«¯è¿”å› ACK æˆ– NAK æ˜¯ï¼Œè¿˜ä¼šè¿”å›åºåˆ—å·</li>
<li>å‘é€ç«¯ç›´åˆ°æ”¶åˆ°æ­£ç¡®çš„åºåˆ—åŒ–æ‰ä¼šè½¬æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€</li>
<li>æ˜¯éœ€è¦ 0 å’Œ 1 ä¸¤ä¸ªçŠ¶æ€å…¶å®å°±å¤Ÿäº†ï¼ŒåŒºåˆ†æ–°åŒ…å’Œæ—§åŒ…</li>
</ul>
<p>rdt2.2:</p>
<p>å»æ‰ NAKï¼Œéƒ½ç”¨ ACK è¡¨ç¤ºï¼š</p>
<ul>
<li>å‘é€æ–¹å‘é€ ACK</li>
<li>æ¥æ”¶æ–¹æ¥æ”¶åˆ°æ•°æ®ï¼Œå¦‚æœæ­£ç¡®ï¼Œè¿”å›åŸæœ¬çš„ ACKï¼Œå¦‚æœé”™è¯¯ï¼Œè¿”å›å…¶ä»–æ•°æ®è¡¨ç¤ºé”™è¯¯ã€‚</li>
<li>å‘é€æ–¹æ£€æŸ¥ ACKï¼Œå¦‚æœ ACK ç›¸åŒï¼Œåˆ™åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€</li>
</ul>
<p>rdt3.0:</p>
<ol>
<li>å¯èƒ½å‘é€ä¸¢åŒ…
<ul>
<li>å‘é€ç«¯ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå¯èƒ½æ˜¯æ•°æ®ä¸¢äº† æˆ–è€… ACK ä¸¢äº†ï¼Œæ— æ³•åŒºåˆ†ï¼Œç»Ÿä¸€é‡ä¼ </li>
<li>ç­‰å¾…å¤šä¹…ï¼Œå‡†æœ¬è®¡æ•°å™¨ï¼Œç­‰å¾…è¶…æ—¶</li>
</ul>
</li>
</ol>
<h4 id="pipelined-protocols-æµæ°´çº¿"><a class="header" href="#pipelined-protocols-æµæ°´çº¿">Pipelined protocols (æµæ°´çº¿)</a></h4>
<p>æé«˜æ•ˆç‡ï¼Œåœ¨å‘é€ç«¯æ”¶åˆ°ç¡®è®¤åå¯ä»¥å‘é€æ›´å¤šæ•°æ®</p>
<p>æ¯æ¬¡å‘é€å¤šä»½æ•°æ®ï¼Œå½“ä»½æ•°æé«˜åˆ°ä¸€å®šç¨‹åº¦ï¼Œåˆ©ç”¨ç‡å°±åˆ° 100%, æ— æ³•ç»§ç»­æé«˜æ•ˆç‡</p>
<ol>
<li>
<p>go-Back-N</p>
<p>æ»‘åŠ¨çª—å£ï¼Œé‡ä¼ å¾ˆå¤š</p>
<p>ç§¯ç´¯ç¡®è®¤æœºåˆ¶</p>
<ul>
<li>
<p>å‘é€æ–¹å‘é€ 5 ä¸ªæ•°æ®åŒ…</p>
</li>
<li>
<p>å‡å¦‚ç¬¬ 3 ä¸ªä¸¢å¤±ï¼Œæ¥æ”¶æ–¹ä¼šè¿”å›é”™è¯¯çš„åºå·</p>
</li>
<li>
<p>å‘é€ç«¯ä»è¿™é‡Œé‡æ–°å‘é€</p>
</li>
<li>
<p>åœ¨æ¥æ”¶æ–¹</p>
</li>
<li>
<p>å¦‚æœåˆ°è¾¾åˆ†ç»„æ˜¯æŒ‰åºåˆ°è¾¾ï¼Œé‚£ä¹ˆå‘é€ ACKï¼Œå‘é€æ–¹æ­£å¸¸ç§»åŠ¨çª—å£</p>
</li>
<li>
<p>å¦‚æœä¸æ˜¯æŒ‰åºåˆ°è¾¾ï¼Œé‚£ä¹ˆæ¥æ”¶æ–¹ä¸¢å¼ƒæ‰€æœ‰å¤±åºåˆ†ç»„ï¼›ä¸¢å¼ƒä¸€ä¸ªæ­£ç¡®æ¥æ”¶çš„å¤±åºåˆ†ç»„å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šçš„é‡ä¼ </p>
</li>
<li>
<p>å¦‚æœæŸä¸ªç¡®è®¤ä¸¢å¤±ï¼Œåç»­çš„ç¡®è®¤ï¼ˆåªæœ‰å‘é€ç«¯æ­£ç¡®æ¥æ”¶åˆ°äº†æ•°æ®æ‰å¯èƒ½ä¼šæœ‰åç»­çš„ç¡®è®¤ï¼‰ä¹Ÿèƒ½ä½¿å‘é€ç«¯æ­£å¸¸ç§»åŠ¨çª—å£</p>
</li>
</ul>
</li>
<li>
<p>selective repeat(é€‰æ‹©é‡ä¼ )</p>
<ul>
<li>æ¥æ”¶æ–¹å› ä¸ºæœ‰ bufferï¼Œæ‰€ä»¥ä¸ç”¨æŒ‰åºæ¥æ”¶åˆ†ç»„ï¼Œå¤±åºçš„åˆ†ç»„ä¼šè¢«ç¼“å­˜</li>
<li>å‘é€æ–¹çš„ bufferï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½æœ‰å„è‡ªçš„è®¡æ•°å™¨ï¼Œä¸ç”¨é‡ä¼ å¤šçš„æ•°æ®åŒ…</li>
</ul>
<p>ä¸ºäº†é˜²æ­¢è¯¯åˆ¤æ•°æ®åŒ…</p>
<p>ACK ç¼–å·æ•°é‡è‡³å°‘è¦ = å‘é€çª—å£ + æ¥æ”¶çª—å£</p>
</li>
</ol>
<h3 id="tcp"><a class="header" href="#tcp">TCP</a></h3>
<p><img src="draft/./computer_network/tcp_segment_format.jpg" alt="TCP" /></p>
<ul>
<li>æºç«¯å£å’Œç›®çš„ç«¯å£å­—æ®µï¼šå„å  2 å­—èŠ‚ã€‚ç«¯å£æ˜¯è¿è¾“å±‚ä¸åº”ç”¨å±‚çš„æœåŠ¡æ¥å£ã€‚è¿è¾“å±‚çš„å¤ç”¨å’Œåˆ†ç”¨åŠŸèƒ½éƒ½è¦é€šè¿‡ç«¯å£æ‰èƒ½å®ç°ã€‚</li>
<li>åºå·å­—æ®µï¼šå  4 å­—èŠ‚ã€‚TCP è¿æ¥ä¸­ä¼ é€çš„æ•°æ®æµä¸­çš„æ¯ä¸€ä¸ªå­—èŠ‚éƒ½ç¼–ä¸Šä¸€ä¸ªåºå·ã€‚åºå·å­—æ®µçš„å€¼åˆ™æŒ‡çš„æ˜¯æœ¬æŠ¥æ–‡æ®µæ‰€å‘é€çš„æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·ã€‚</li>
<li>ç¡®è®¤å·å­—æ®µï¼šå  4 å­—èŠ‚ï¼Œæ˜¯æœŸæœ›æ”¶åˆ°å¯¹æ–¹çš„ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·ã€‚</li>
<li>æ•°æ®åç§»ï¼ˆå³é¦–éƒ¨é•¿åº¦ï¼‰ï¼šå  4 ä½ï¼Œå®ƒæŒ‡å‡º TCP æŠ¥æ–‡æ®µçš„æ•°æ®èµ·å§‹å¤„è·ç¦» TCP æŠ¥æ–‡æ®µçš„èµ·å§‹å¤„æœ‰å¤šè¿œã€‚â€œæ•°æ®åç§»â€çš„å•ä½æ˜¯ 32 ä½å­—ï¼ˆä»¥ 4 å­—èŠ‚ä¸ºè®¡ç®—å•ä½ï¼‰ã€‚</li>
<li>ä¿ç•™å­—æ®µï¼šå  6 ä½ï¼Œä¿ç•™ä¸ºä»Šåä½¿ç”¨ï¼Œä½†ç›®å‰åº”ç½®ä¸º 0ã€‚</li>
<li>ç´§æ€¥ URGï¼šå½“ URG ï€½ 1 æ—¶ï¼Œè¡¨æ˜ç´§æ€¥æŒ‡é’ˆå­—æ®µæœ‰æ•ˆã€‚å®ƒå‘Šè¯‰ç³»ç»Ÿæ­¤æŠ¥æ–‡æ®µä¸­æœ‰ç´§æ€¥æ•°æ®ï¼Œåº”å°½å¿«ä¼ é€ (ç›¸å½“äºé«˜ä¼˜å…ˆçº§çš„æ•°æ®)ã€‚</li>
<li>ç¡®è®¤ ACKï¼šåªæœ‰å½“ ACK ï€½ 1 æ—¶ç¡®è®¤å·å­—æ®µæ‰æœ‰æ•ˆã€‚å½“ ACK ï€½ 0 æ—¶ï¼Œç¡®è®¤å·æ— æ•ˆã€‚</li>
<li>æ¨é€ PSH (PuSH)ï¼šæ¥æ”¶ TCP æ”¶åˆ° PSH = 1 çš„æŠ¥æ–‡æ®µï¼Œå°±å°½å¿«åœ°äº¤ä»˜æ¥æ”¶åº”ç”¨è¿›ç¨‹ï¼Œè€Œä¸å†ç­‰åˆ°æ•´ä¸ªç¼“å­˜éƒ½å¡«æ»¡äº†åå†å‘ä¸Šäº¤ä»˜ã€‚</li>
<li>å¤ä½ RST (ReSeT) ï¼šå½“ RST ï€½ 1 æ—¶ï¼Œè¡¨æ˜ TCP è¿æ¥ä¸­å‡ºç°ä¸¥é‡å·®é”™ï¼ˆå¦‚ç”±äºä¸»æœºå´©æºƒæˆ–å…¶ä»–åŸå› ï¼‰ï¼Œå¿…é¡»é‡Šæ”¾è¿æ¥ï¼Œç„¶åå†é‡æ–°å»ºç«‹è¿è¾“è¿æ¥ã€‚</li>
<li>åŒæ­¥ SYNï¼šåŒæ­¥ SYN = 1 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªè¿æ¥è¯·æ±‚æˆ–è¿æ¥æ¥å—æŠ¥æ–‡ã€‚</li>
<li>ç»ˆæ­¢ FIN (FINis) ï¼šç”¨æ¥é‡Šæ”¾ä¸€ä¸ªè¿æ¥ã€‚FIN ï€½ 1 è¡¨æ˜æ­¤æŠ¥æ–‡æ®µçš„å‘é€ç«¯çš„æ•°æ®å·²å‘é€å®Œæ¯•ï¼Œå¹¶è¦æ±‚é‡Šæ”¾è¿è¾“è¿æ¥ã€‚</li>
<li>çª—å£å­—æ®µï¼šå  2 å­—èŠ‚ï¼Œç”¨æ¥è®©å¯¹æ–¹è®¾ç½®å‘é€çª—å£çš„ä¾æ®ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚</li>
<li>æ£€éªŒå’Œï¼šå  2 å­—èŠ‚ã€‚æ£€éªŒå’Œå­—æ®µæ£€éªŒçš„èŒƒå›´åŒ…æ‹¬é¦–éƒ¨å’Œæ•°æ®è¿™ä¸¤éƒ¨åˆ†ã€‚åœ¨è®¡ç®—æ£€éªŒå’Œæ—¶ï¼Œè¦åœ¨ TCP æŠ¥æ–‡æ®µçš„å‰é¢åŠ ä¸Š 12 å­—èŠ‚çš„ä¼ªé¦–éƒ¨ã€‚</li>
<li>ç´§æ€¥æŒ‡é’ˆå­—æ®µï¼šå  16 ä½ï¼ŒæŒ‡å‡ºåœ¨æœ¬æŠ¥æ–‡æ®µä¸­ç´§æ€¥æ•°æ®å…±æœ‰å¤šå°‘ä¸ªå­—èŠ‚ï¼ˆç´§æ€¥æ•°æ®æ”¾åœ¨æœ¬æŠ¥æ–‡æ®µæ•°æ®çš„æœ€å‰é¢ï¼‰ã€‚</li>
<li>é€‰é¡¹å­—æ®µï¼šé•¿åº¦å¯å˜ã€‚TCP æœ€åˆåªè§„å®šäº†ä¸€ç§é€‰é¡¹ï¼Œå³æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ MSSã€‚MSS å‘Šè¯‰å¯¹æ–¹ TCPï¼šâ€œæˆ‘çš„ç¼“å­˜æ‰€èƒ½æ¥æ”¶çš„æŠ¥æ–‡æ®µçš„æ•°æ®å­—æ®µçš„æœ€å¤§é•¿åº¦æ˜¯ MSS ä¸ªå­—èŠ‚ã€‚</li>
</ul>
<p>TCP seq åºåˆ—å·</p>
<h4 id="tcp-feature"><a class="header" href="#tcp-feature">TCP Feature</a></h4>
<ul>
<li>Point to Point (å•æ’­ï¼Œå•å‘é€è€…ï¼Œå•æ¥æ”¶è€…)</li>
<li>reliable, in-order byte stream</li>
<li>pipelinedï¼ˆæ‹¥å¡æ§åˆ¶ï¼Œæµé‡æ§åˆ¶ï¼‰</li>
<li>send &amp; receive buffers</li>
<li>full deplex data(å…¨åŒå·¥ï¼ŒåŒå‘æ•°æ®ä¼ è¾“ï¼ŒMSS(æœ€å¤§æŠ¥æ–‡é•¿åº¦))</li>
<li>connection-orinted(æ¡æ‰‹ï¼Œåˆå§‹åŒ– sender å’Œ receiver çš„çŠ¶æ€)</li>
<li>flow controlled(å‘é€ç«¯ä¸èƒ½è¶…è¿‡æ¥æ”¶ç«¯çš„å¤„ç†èƒ½åŠ›)</li>
</ul>
<h3 id="flow-control"><a class="header" href="#flow-control">Flow Control</a></h3>
<p>ä¸ºä»€ä¹ˆéœ€è¦æµé‡æ§åˆ¶ï¼Ÿ</p>
<ul>
<li>å‘é€è€…æ¥æ”¶è€…çš„é€Ÿç‡ä¸ä¸€å®šåŒ¹é…ï¼Œå¦‚æœå‘çš„å¿«ï¼Œå¯èƒ½äº§ç”Ÿæ¶ˆæ¯å †ç§¯</li>
</ul>
<p>å¦‚ä½•è§£å†³ï¼Ÿ</p>
<ul>
<li>æ¥æ”¶ç«¯éœ€è¦é€šçŸ¥å‘é€ç«¯è‡ªå·±çš„ç¼“å†²åŒºå¤§å°ï¼Œè®©å®ƒä¸è¦å‘é€å¤ªå¤šã€‚å¯¹åº”çš„å°±æ˜¯ TCP åè®®ä¸­è§„å®šçš„ Receive Window (æ¥æ”¶çª—å£) å­—æ®µ</li>
</ul>
<blockquote>
<p>æ³¨æ„æ»‘åŠ¨çª—å£ (å‘é€çª—å£)ï¼Œæ¥æ”¶çª—å£ï¼Œä»¥åŠä¹‹åçš„æ‹¥å¡çª—å£çš„åŒºåˆ«</p>
</blockquote>
<h3 id="congestion-control"><a class="header" href="#congestion-control">Congestion Control</a></h3>
<h4 id="æ‹¥å¡"><a class="header" href="#æ‹¥å¡">æ‹¥å¡</a></h4>
<ul>
<li>å¤ªå¤šå‘é€æºå‘é€äº†å¤ªå¤šçš„æ•°æ®ï¼Œè¶…è¿‡äº†ç½‘ç»œçš„æ‰¿è½½èƒ½åŠ›</li>
<li>å¯¹èµ„æºéœ€æ±‚çš„æ€»å’Œ &gt; å¯ç”¨èµ„æº</li>
<li>ä¸æµé‡æ§åˆ¶ä¸åŒ</li>
<li>è¡¨ç°
<ul>
<li>ä¸¢åŒ…</li>
<li>é«˜å»¶è¿Ÿ</li>
</ul>
</li>
<li>top-10 question!</li>
</ul>
<h4 id="è§£å†³æ–¹æ³•-1"><a class="header" href="#è§£å†³æ–¹æ³•-1">è§£å†³æ–¹æ³•</a></h4>
<ol>
<li>
<p>ç«¯åˆ°ç«¯</p>
<ul>
<li>æ²¡æœ‰æ¥è‡ªç½‘ç»œçš„æ˜ç¡®åé¦ˆ</li>
<li>ç«¯ç³»ç»Ÿé€šè¿‡ä¸¢åŒ…å’Œå»¶è¿Ÿæ¨æµ‹å‡ºå¯èƒ½é€šè¿‡æ‹¥å¡</li>
<li>TCP é‡‡ç”¨è¿™ç§æ–¹æ³•</li>
</ul>
</li>
<li>
<p>ç½‘ç»œå±‚è¾…åŠ©</p>
<ul>
<li>è·¯ç”±ä¸»åŠ¨åé¦ˆç»™ç«¯ç³»ç»Ÿ
<ul>
<li>ç”± 1 ä¸ª bit æŒ‡å‡ºç½‘ç»œå­˜åœ¨æ‹¥å¡ (SNA, DECbit, TCP/IP ECN, ATM)</li>
<li>å‘é€ç«¯éœ€è¦ä»¥ä¸€ä¸ªå›ºå®šçš„é€Ÿç‡å‘é€æ•°æ®</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="draft/./computer_network/congestion_ctl.png" alt="congestion_ctl" /></p>
<h4 id="ä¸‰å¤§é—®é¢˜"><a class="header" href="#ä¸‰å¤§é—®é¢˜">ä¸‰å¤§é—®é¢˜</a></h4>
<ol>
<li>
<p>å¦‚ä½•é™åˆ¶å‘é€é€Ÿåº¦ï¼Ÿ</p>
<ul>
<li>
<p>Last Byte Sent(ä¸Šä¸€ä¸ªå‘é€çš„å­—èŠ‚) - Last Byte Acked(æœ€åç¡®è®¤çš„å­—èŠ‚) &lt; CongWin(æ‹¥å¡çª—å£)</p>
</li>
<li>
<p>rate(å‘é€é€Ÿç‡) = CongWIn / RTT B/s</p>
</li>
</ul>
</li>
<li>
<p>å¦‚ä½•æ£€æµ‹åˆ°æ‹¥å¡ï¼Ÿ
loss event = timeout or 3 duplicate acks</p>
</li>
<li>
<p>åº”è¯¥å‘é€å¤šå¿«ï¼Ÿ</p>
<ul>
<li>
<p>AIMD</p>
<ul>
<li>åŠ æ³•å¢åŠ ï¼Œä¹˜æ³•å‡å° (additive increase, multiplicative decrease)</li>
<li>å¢åŠ æœ‰ä¸€ä¸ªå•ä½ï¼ˆ1 å­—èŠ‚ï¼Œ1kï¼‰ï¼Œä¸€èˆ¬ä»¥ MSS æ•°é‡ä¸ºå•ä½</li>
<li>å›¾åƒè¡¨ç°ä¸ºé”¯é½¿çŠ¶</li>
</ul>
</li>
<li>
<p>slow start</p>
<ul>
<li>è¿æ¥å¼€å§‹æ—¶ï¼ŒCongWin ä¸º 1MSSï¼Œ
<ul>
<li>æ¯æ¬¡æ¥æ”¶åˆ° ACKï¼ŒCongWin å°±ä¼šä¹˜ 2</li>
<li>æ…¢å¯åŠ¨å…¶å®å¹¶ä¸æ…¢ï¼Œå¢åŠ çš„é€Ÿåº¦å¾ˆå¿«</li>
</ul>
</li>
<li>é€Ÿåº¦å¢åŠ æœ‰ä¸€å®šå¾—é˜ˆå€¼ï¼Œå½“è¶…è¿‡é˜ˆå€¼åï¼Œåˆ°è¾¾æ–°é˜¶æ®µï¼Œä¸€èˆ¬ç§°ä¸º &quot;æ‹¥å¡é¿å…&quot;ï¼Œæ¯æ¬¡åªä¼šå¢åŠ  1 ä¸ª MSSã€‚</li>
</ul>
</li>
<li>
<p>conservative after timeout events</p>
<ul>
<li>å‘ç”Ÿä¸¢åŒ…å
<ul>
<li>çª—å£æ‰å› 1 MSS</li>
<li>çº¿æ€§å¢åŠ </li>
</ul>
</li>
<li>æ”¶åˆ° 3 ä¸ªé‡å¤çš„ ACK
<ul>
<li>çª—å£ç åŠ</li>
<li>çº¿æ€§å¢åŠ </li>
<li>å¿«é€Ÿé‡ä¼ </li>
</ul>
</li>
<li>æ–°çš„é˜ˆå€¼éƒ½ä¸ºä¸Šæ¬¡é˜ˆå€¼çš„ä¸€åŠ</li>
</ul>
<blockquote>
<p>ä¸¢åŒ…ç›¸å¯¹äº 3 ä¸ªé‡å¤çš„ ACK æ›´ä¸¥é‡</p>
</blockquote>
</li>
<li>
<p>TCP CUBIC</p>
<ul>
<li>çª—å£å‡åŠåï¼Œå¢åŠ çš„é€Ÿåº¦æ”¹ä¸º <code>x^3</code> çš„æ›²çº¿</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="tcp-å…¬å¹³æ€§"><a class="header" href="#tcp-å…¬å¹³æ€§">TCP å…¬å¹³æ€§</a></h3>
<p>AIMD å…·æœ‰è¾ƒå¥½çš„å…¬å¹³æ€§ï¼Œä½¿å¾—ä¸åŒè¿æ¥å æœ‰çš„å¸¦å®½ç›¸ç­‰</p>
<blockquote>
<p>å¦‚æœ TCP å’Œ UDP åŒæ—¶ç«äº‰ä¼šæ€æ ·ï¼ŸTCP ä¼šä¸»åŠ¨é™ä½é€Ÿåº¦ï¼ŒUDP åˆ™ä¸ç®¡
æƒ³è¦å¯é ä¼ è¾“ï¼Œä¸æƒ³è¦æ‹¥å¡æ§åˆ¶æ€ä¹ˆåŠï¼Ÿåœ¨ UDP çš„åŸºç¡€ä¸Šè‡ªè¡Œå®ç°å¯é ä¼ è¾“ (QUIC å°±æ˜¯è¿™ä¹ˆå¹²)</p>
</blockquote>
<h2 id="4-ç½‘ç»œå±‚"><a class="header" href="#4-ç½‘ç»œå±‚">4. ç½‘ç»œå±‚</a></h2>
<h3 id="ç®€ä»‹-1"><a class="header" href="#ç®€ä»‹-1">ç®€ä»‹</a></h3>
<ul>
<li>æä¾›ä¸»æœºé—´çš„æ•°æ®ä¼ è¾“</li>
<li>å‘é€ç«¯å°†æ®µ (segments) å°è£…ä¸ºæ•°æ®æŠ¥ï¼Œæ¥æ”¶ç«¯æŠŠ segments å‘é€åˆ°ä¼ è¾“å±‚</li>
<li>ç½‘ç»œå±‚åè®®åœ¨å„ä¸ªä¸»æœºå’Œè·¯ç”±é—´</li>
<li>router ä¼šç¡®è®¤ç»è¿‡ä»–çš„æ‰€æœ‰ IP æ•°æ®æŠ¥çš„ header å­—æ®µ</li>
</ul>
<h3 id="è½¬å‘--è·¯ç”±"><a class="header" href="#è½¬å‘--è·¯ç”±">è½¬å‘ &amp; è·¯ç”±</a></h3>
<p>è·¯ç”±ï¼šå†³å®šä»å‘é€æºå‘é€çš„ packets åˆ°ç›®çš„åœ°çš„è·¯å¾„</p>
<ul>
<li>è·¯ç”±é€‰æ‹©ç®—æ³•</li>
</ul>
<p>è½¬å‘ï¼šæŠŠ packets ä»è·¯ç”±çš„è¾“å…¥è½¬å‘åˆ°åˆé€‚çš„è¾“å‡º</p>
<ul>
<li>å¦‚ä½•é€šè¿‡æŸä¸€ä¸ªäº¤æ¢æœº</li>
</ul>
<h3 id="æ•°æ®å¹³é¢æ§åˆ¶å¹³é¢"><a class="header" href="#æ•°æ®å¹³é¢æ§åˆ¶å¹³é¢">æ•°æ®å¹³é¢ï¼Œæ§åˆ¶å¹³é¢</a></h3>
<ol>
<li>
<p>æ•°æ®å¹³é¢</p>
<ul>
<li>å±€éƒ¨çš„</li>
</ul>
</li>
<li>
<p>æ§åˆ¶å¹³é¢</p>
<ul>
<li>å…¨å±€çš„</li>
<li>Per-router control plane
<ul>
<li>æ¯ä¸€ä¸ªè·¯ç”±è®¾å¤‡å•ç‹¬å®ç°è·¯ç”±ç®—æ³•</li>
</ul>
</li>
<li>Software-Defined Networking(SDN) control plane
<ul>
<li>ç”±ä¸€ä¸ªé›†ä¸­å¼çš„è®¡ç®—æœºè®¡ç®—è·¯ç”±å¹¶å‘ä¸‹å‘é€äº†è·¯ç”±è¡¨</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="æ˜¯å¦å»ºç«‹è¿æ¥"><a class="header" href="#æ˜¯å¦å»ºç«‹è¿æ¥">æ˜¯å¦å»ºç«‹è¿æ¥</a></h3>
<ul>
<li>ä¸‰ç§é‡è¦çš„ç½‘ç»œæ¶æ„
<ul>
<li>ATM, frame relay, X.25</li>
</ul>
</li>
<li>åœ¨æ•°æ®æŠ¥æµåŠ¨å‰ï¼Œä¸¤ä¸ªä¸»æœºä»¥åŠå®ƒä»¬ä¹‹é—´çš„è·¯ç”±ä¼šå»ºç«‹è™šæ‹Ÿè¿æ¥</li>
<li>ç½‘ç»œå±‚å’Œä¼ è¾“å±‚è¿æ¥çš„åŒºåˆ«
<ul>
<li>ç½‘ç»œå±‚ï¼šä¸¤ä¸ªä¸»æœºä¹‹é—´ (ä¹Ÿå¯èƒ½åŒ…å«ä¹‹é—´çš„äº¤æ¢æœº)</li>
<li>ä¼ è¾“å±‚ï¼šä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´</li>
</ul>
</li>
</ul>
<h3 id="è™šç”µè·¯--æ•°æ®æŠ¥"><a class="header" href="#è™šç”µè·¯--æ•°æ®æŠ¥">è™šç”µè·¯ &amp; æ•°æ®æŠ¥</a></h3>
<ul>
<li>
<p>è™šç”µè·¯</p>
<ul>
<li>æœ‰è¿æ¥</li>
</ul>
</li>
<li>
<p>æ•°æ®æŠ¥</p>
<ul>
<li>æ— è¿æ¥</li>
</ul>
</li>
</ul>
<blockquote>
<p>ç½‘ç»œå±‚åº”è¯¥æ˜¯é¢å‘è¿æ¥çš„è¿˜æ˜¯æ— è¿æ¥çš„ï¼Ÿ
åœ¨è®¡ç®—æœºé€šä¿¡ä¸­ï¼Œå¯é äº¤ä»˜åº”è¯¥ç”±è°æ¥è´Ÿè´£ï¼Ÿæ˜¯ç½‘ç»œè¿˜æ˜¯ç«¯ç³»ç»Ÿï¼Ÿ</p>
</blockquote>
<p>è½¬å‘è¡¨çš„å»ºç«‹</p>
<p>å¯¹äºè™šç”µè·¯ï¼Œè½¬å‘è¡¨ä¼šåœ¨å»ºç«‹è¿æ¥æ—¶äº§ç”Ÿ</p>
<h3 id="ip-åœ°å€"><a class="header" href="#ip-åœ°å€">IP åœ°å€</a></h3>
<blockquote>
<p><em>addressing, forwarding, routing</em></p>
</blockquote>
<ul>
<li>åœ°å€å—å¦‚ä½•è®¾è®¡</li>
<li>å¯¹å­˜å‚¨å’Œè½¬å‘çš„å½±å“</li>
</ul>
<h4 id="ip-åœ°å€çš„ç¼–å€æ–¹æ³•"><a class="header" href="#ip-åœ°å€çš„ç¼–å€æ–¹æ³•">IP åœ°å€çš„ç¼–å€æ–¹æ³•</a></h4>
<p>åˆ†ç±»çš„ IP åœ°å€</p>
<ul>
<li>æ¯ä¸€ç±»åœ°å€éƒ½ç”±ä¸¤ä¸ªå›ºå®šé•¿åº¦çš„å­—æ®µç»„æˆ
<ul>
<li>ç½‘ç»œå· net-id: æ ‡å¿—ä¸»æœºï¼ˆæˆ–è·¯ç”±å™¨ï¼‰è¿æ¥åˆ°çš„ç½‘ç»œ</li>
<li>ä¸»æœºå· host-idï¼šæ ‡å¿—è¯¥ä¸»æœºæˆ–è·¯ç”±å™¨</li>
</ul>
</li>
<li>ä¸¤çº§çš„ IP åœ°å€å¯ä»¥è®°ä¸ºï¼š<code>IP åœ°å€ ::= { &lt;ç½‘ç»œå·&gt;, &lt;ä¸»æœºå·&gt;}</code></li>
</ul>
<blockquote>
<p><code>::=</code> è¡¨ç¤º &quot;å®šä¹‰ä¸º&quot;</p>
</blockquote>
<table><thead><tr><th>ç½‘ç»œç±»åˆ«</th><th>é¦–éƒ¨</th><th>åœ°å€èŒƒå›´</th></tr></thead><tbody>
<tr><td>A ç±»</td><td>0</td><td>1.0.0.0 - 127.255.255.255</td></tr>
<tr><td>B ç±»</td><td>10</td><td>128.0.0.0 - 191.255.255.255</td></tr>
<tr><td>C ç±»</td><td>110</td><td>192.0.0.0 - 223.255.255.255</td></tr>
<tr><td>D ç±»</td><td>1110</td><td>224.0.0.0 - 239.255.255.255</td></tr>
<tr><td>E ç±»</td><td>1111</td><td></td></tr>
</tbody></table>
<p>| ç±»åˆ« | æœ€å¤§ç½‘ç»œæ•° | ç¬¬ä¸€ä¸ªå¯ç”¨çš„ç½‘ç»œå· | æœ€åä¸€ä¸ªå¯ç”¨çš„ç½‘ç»œå· | æ¯ä¸ªç½‘ç»œä¸­çš„æœ€å¤§ä¸»æŠ€æœ¯ |
| A |  126(2^7 - 2)     | 1       | 126         | 16,777,214 |
| B | 16383(2^14 - 1)   | 128.1   | 191.255     | 65,534 |
| C | 2097151(2^21 - 1) | 192.0.1 | 223.255.255 | 254 |</p>
<ul>
<li>
<p>ç§æœ‰åœ°å€</p>
<ul>
<li>A: 10.0.0.0 - 10.255.255.255(10.0.0.0/8 prefix)</li>
<li>B: 172.16.0.0 - 172.31.255.255(172.16.0.0/12 prefix)</li>
<li>C: 192.168.0.0 - 192.168.255.255(192.168.0.0/16 prefix)</li>
</ul>
</li>
<li>
<p>127.0.0.1: loopback</p>
</li>
<li>
<p>255.255.255.255:</p>
</li>
<li>
<p>0.0.0.0:</p>
</li>
</ul>
<p>å­ç½‘çš„åˆ’åˆ†</p>
<p>CIDR æ–¹æ¡ˆ</p>
<ul>
<li>æ— åˆ†ç±»çš„ç¼–åˆ¶æ–¹æ³•</li>
</ul>
<h4 id="ip-åœ°å€çš„ä¸€äº›é‡è¦ç‰¹ç‚¹"><a class="header" href="#ip-åœ°å€çš„ä¸€äº›é‡è¦ç‰¹ç‚¹">IP åœ°å€çš„ä¸€äº›é‡è¦ç‰¹ç‚¹</a></h4>
<ul>
<li>IP åœ°å€æ˜¯ &quot;åˆ†ç­‰çº§&quot; çš„åœ°è´¨ç»“æ„
<ul>
<li>æ–¹ä¾¿äº† IP ç®¡ç†ï¼šIP ç®¡ç†æœºæ„åˆ†é… IP æ—¶åªåˆ†é…ç½‘ç»œå·ï¼Œå‰©ä¸‹çš„äº¤ç”±å•ä½è‡ªè¡Œç®¡ç†</li>
<li>å‡å°äº†è·¯ç”±è¡¨çš„å¤§å°ï¼šè·¯ç”±å™¨ä»…æ ¹æ®ç½‘ç»œå·æ¥è½¬å‘è·¯ç”±ï¼ˆä¸ç”¨è€ƒè™‘ç›®çš„ä¸»æœºå·ï¼‰ï¼Œå‡å°‘äº†è·¯ç”±è¡¨é¡¹æ•°ï¼Œå‡å°äº†å­˜å‚¨ç©ºé—´ã€‚</li>
</ul>
</li>
<li>å®é™…ä¸Š IP åœ°å€æ ‡å¿—ä¸€ä¸ªä¸»æœºå’Œä¸€æ¡é“¾è·¯çš„æ¥å£
<ul>
<li>å½“ä¸€ä¸ªä¸»æœºåŒæ—¶è¿æ¥åˆ°ä¸¤ä¸ªç½‘ç»œä¸Šæ—¶ï¼Œå®ƒå¿…é¡»åŒæ—¶æœ‰ä¸¤ä¸ª IP åœ°å€ï¼Œå¹¶ä¸” net-id å¿…é¡»ä¸åŒï¼ˆç§°ä¸ºå¤šå½’å±ä¸»æœºï¼‰</li>
<li>ä¸€ä¸ªè·¯ç”±å™¨è‡³å°‘è¦è¿æ¥åˆ°ä¸¤ä¸ªç½‘ç»œï¼Œæ‰èƒ½å°† IP æ•°æ®æŠ¥æ€»ä¸€ä¸ªç½‘ç»œè½¬å‘åˆ°å¦ä¸€ä¸ªç½‘ç»œã€‚å› æ­¤è·¯ç”±å™¨è‡³å°‘æœ‰ä¸¤ä¸ªä¸åŒçš„ IP åœ°å€</li>
</ul>
</li>
<li>ç”¨è½¬å‘å™¨æˆ–è€…ç½‘æ¡¥è¿æ¥èµ·æ¥çš„è‹¥å¹²å±€åŸŸç½‘ä»å±ä»¥ä¸€ä¸ªç½‘ç»œï¼Œè¿™äº›å±€åŸŸç½‘æœ‰ç›¸åŒçš„ net-id</li>
</ul>
<h4 id="åˆ†ç±»-ip-åœ°å€çš„è·¯ç”±è½¬å‘"><a class="header" href="#åˆ†ç±»-ip-åœ°å€çš„è·¯ç”±è½¬å‘">åˆ†ç±» IP åœ°å€çš„è·¯ç”±è½¬å‘</a></h4>
<ul>
<li>direct delivery ç›´æ¥æŠ•é€’/äº¤ä»˜</li>
<li>indirect delivery é—´æ¥æŠ•é€’/äº¤ä»˜</li>
<li>Route basedï¼ŒåŸºäºè·¯å¾„ï¼ˆæ„å»ºè½¬å‘è¡¨å›°éš¾ï¼Œç»´æŠ¤éš¾åº¦å¤§ï¼‰</li>
<li>Next hop basedï¼ŒåŸºäºä¸‹ä¸€è·³ï¼ˆç±»ä¼¼äº &quot;è·¯ç‰Œ&quot;ï¼‰</li>
</ul>
<ol>
<li>
<p>å¦‚æœå¤šä¸ªæº IP æœ‰ç›¸åŒçš„ä¸‹ä¸€è·³ï¼Œä»–ä»¬çš„ç›®çš„åœ°å€å¯ä»¥åˆå¹¶</p>
</li>
<li>
<p>Default routingï¼ˆç¼ºçœï¼ˆé»˜è®¤ï¼‰è·¯ç”±ï¼‰</p>
</li>
</ol>
<h4 id="åˆ’åˆ†å­ç½‘å’Œæ„é€ è¶…ç½‘"><a class="header" href="#åˆ’åˆ†å­ç½‘å’Œæ„é€ è¶…ç½‘">åˆ’åˆ†å­ç½‘å’Œæ„é€ è¶…ç½‘</a></h4>
<ol>
<li>
<p>ä»ä¸¤æ IP åˆ° ä¸‰çº§ IP åœ°å€
åŸå› ï¼š</p>
<ul>
<li>IP åœ°å€åˆ©ç”¨ç‡ä½</li>
<li>ä¸ºæ¯ä¸€ä¸ªç‰©ç†ç½‘ç»œåˆ†é…ä¸€ä¸ªç½‘ç»œå·ä¼šä½¿è·¯ç”±è¡¨å˜å¤§ï¼Œé™ä½æ€§èƒ½</li>
<li>ä¸¤æ IP åœ°å€ä¸å¤Ÿçµæ´»</li>
</ul>
</li>
<li>
<p>å­ç½‘æ©ç </p>
</li>
</ol>
<p>å­ç½‘æ©ç å‰ä¸€éƒ¨åˆ†ä¸º 1ï¼Œåä¸€éƒ¨åˆ†å…¨ä¸º 0ï¼Œå°†å­ç½‘æ©ç ä¸ IP åœ°å€è¿›è¡Œ &quot;ä¸&quot; è¿ç®—ï¼Œå°±èƒ½æ‰¾åˆ° IP åœ°å€çš„å­ç½‘éƒ¨åˆ†ã€‚</p>
<p>å¯ä»¥ç”¨æ¥åŒºåˆ† net-id å’Œ host-id æˆ–è€… subnet-id å’Œ host-id</p>
<p>ä¸åŒçš„å­ç½‘æ©ç å¯ä»¥å¾—åˆ°ç›¸åŒçš„ç½‘ç»œåœ°å€ï¼Œä½†æ˜¯ä¸åŒçš„æ©ç çš„æ•ˆæœæ˜¯ä¸åŒçš„ã€‚å¦‚æœä½¿ç”¨ï¼Œè·¯ç”±å™¨ç»™å‡ºç›®çš„çš„ç½‘ç»œåœ°å€å¤–ï¼Œè¿˜å¿…é¡»åŒæ—¶ç»™å‡ºè¯¥ç½‘ç»œçš„å­ç½‘æ©ç ã€‚</p>
<p>è‹¥ä¸€ä¸ªè·¯ç”±å™¨è¿æ¥åœ¨ä¸¤ä¸ªå­ç½‘ä¸Šï¼Œä»–å°±æœ‰ä¸¤ä¸ªç½‘ç»œåœ°å€å’Œå­ç½‘æ©ç </p>
<h4 id="æ— åˆ†ç±»ç¼–å€-cidr"><a class="header" href="#æ— åˆ†ç±»ç¼–å€-cidr">æ— åˆ†ç±»ç¼–å€ CIDR</a></h4>
<ol>
<li>
<p>CIDR ç‰¹ç‚¹</p>
<ul>
<li>æ¶ˆé™¤äº† Aï¼ŒBï¼ŒC ç±»åœ°å€ï¼Œä»¥åŠåˆ’åˆ†å­ç½‘çš„æ¦‚å¿µ</li>
<li>ä½¿ç”¨å„ç§é•¿åº¦çš„ &quot;ç½‘ç»œå‰ç¼€&quot; ä»£æ›¿åˆ†ç±»åœ°å€ä¸­çš„ç½‘ç»œå·å’Œå­ç½‘å·ã€‚</li>
<li>ä»ä¸‰çº§ç¼–åˆ¶ï¼ˆå–æ¶ˆå­ç½‘æ©ç ï¼‰å˜å›äºŒçº§ç¼–åˆ¶</li>
</ul>
</li>
<li>
<p>æ— åˆ†ç±»çš„ä¸¤çº§ç¼–å€</p>
<ul>
<li>IP è®°æ³•ï¼š<code>IP åœ°å€ ::= {&lt;ç½‘ç»œå‰ç¼€&gt;, &lt;ä¸»æœºå·&gt;}</code></li>
<li>CIDR è¿˜æ˜¯ç”¨æ–œçº¿è®°æ³•ï¼šåœ¨ IP åœ°å€é¢åŠ ä¸€ä¸ª <code>/</code>ï¼Œåé¢è·Ÿä¸Šç½‘ç»œå‰ç¼€æ‰€å çš„ä½æ•°ã€‚ï¼ˆå¯¹åº”å­ç½‘æ©ç ä¸­ 1 çš„ä¸ªæ•°ï¼‰</li>
<li>ä¸¾ä¾‹ï¼š128.14.32.0/20 <code>min: 128.14.32.0, max: 128.14.47.255</code></li>
<li>å…¨ 0 å’Œå…¨ 1 ä¸€èˆ¬ä¸ä½¿ç”¨</li>
</ul>
</li>
<li>
<p>å¯å˜æ©ç é•¿åº¦å‘å³ç§»èƒ½åˆ’åˆ†ä¸ºå°å—ï¼Œå‘å·¦ç§»åˆå¹¶ä¸ºå¤§å—</p>
</li>
<li>
<p>è·¯ç”±èšåˆå‡å°‘äº†è·¯ç”±è¡¨çš„è¡¨é¡¹</p>
</li>
</ol>
<h3 id="ip-é…ç½®"><a class="header" href="#ip-é…ç½®">IP é…ç½®</a></h3>
<ul>
<li>
<p>ç³»ç»Ÿç®¡ç†å‘˜å°† IP ç¡¬ç¼–ç åˆ°æ–‡ä»¶ä¸­
UNIX: /etc/rc.config</p>
</li>
<li>
<p>DHCP: Dynamic Host Configuration Protocal:</p>
<p>ä»æœåŠ¡å™¨åŠ¨æ€è·å– IP</p>
</li>
</ul>
<p>ç›®çš„ï¼šå…è®¸ä¸»æœºåŠ å…¥ç½‘ç»œåï¼Œä»ç½‘ç»œæœåŠ¡å™¨ï¼ŒåŠ¨æ€è·å–è‡ªå·±çš„ IP åœ°å€ã€‚</p>
<ul>
<li>æ”¯æŒé‡ç½®ï¼Œå¤ç”¨ï¼Œæ‰‹æœºç”¨æˆ·</li>
</ul>
<h3 id="dhcp"><a class="header" href="#dhcp">DHCP</a></h3>
<p>Overview</p>
<ul>
<li>ä¸»æœºå¹¿æ’­ &quot;DHCP discover&quot; æ¶ˆæ¯</li>
<li>DHCP æœåŠ¡å™¨å›å¤ &quot;DHCP offer&quot; æ¶ˆæ¯</li>
<li>ä¸»æœºè¯·æ±‚ IP åœ°å€ï¼š&quot;DHCP request&quot; æ¶ˆæ¯</li>
<li>DHCP æœåŠ¡å™¨å‘é€åœ°å€ï¼š&quot;DHCP ack&quot; æ¶ˆæ¯</li>
</ul>
<h3 id="nat-ç½‘ç»œåœ°å€è½¬æ¢"><a class="header" href="#nat-ç½‘ç»œåœ°å€è½¬æ¢">NAT ç½‘ç»œåœ°å€è½¬æ¢</a></h3>
<h4 id="åŠ¨æœº"><a class="header" href="#åŠ¨æœº">åŠ¨æœº</a></h4>
<p>å¯¹å¤–éƒ¨ä¸–ç•Œè€Œè¨€ï¼Œæœ¬åœ°ç½‘ç»œåªä½¿ç”¨ä¸€ä¸ª IP åœ°å€</p>
<ul>
<li>ä¸éœ€è¦ ISP æä¾›ä¸€ç³»åˆ—åœ°å€ï¼Œæ‰€æœ‰è®¾åˆ«å…±ç”¨ä¸€ä¸ª IP åœ°å€ã€‚</li>
<li>æ— éœ€é€šçŸ¥å¤–éƒ¨å®é™…å°±å¯ä»¥æ›´æ¢æœ¬åœ°ç½‘ç»œçš„è®¾å¤‡ IP.</li>
<li>å¯ä»¥åœ¨ä¸æ”¹å˜æœ¬åœ°è®¾å¤‡ IP æƒ…å†µä¸‹æ›´æ¢ ISP.</li>
<li>å†…ç½‘å¯¹å¤–ä¸è®¾å¤‡ä¸å¯è§ã€‚</li>
</ul>
<h4 id="å®ç°-1"><a class="header" href="#å®ç°-1">å®ç°</a></h4>
<p>NAT è·¯ç”±å¿…é¡»</p>
<ul>
<li>
<p>å°†æ¯ä¸ªå‘å¤–å‘é€æ•°æ®æŠ¥çš„æº IP åœ°å€ï¼Œç«¯å£æ›¿æ¢ä¸º NAT çš„ IP åœ°å€ï¼Œæ–°ç«¯å£</p>
<p>. .è¿œç¨‹å®¢æˆ·/æœåŠ¡å™¨å°†ä½¿ç”¨ NAT çš„ IP åœ°å€ï¼Œæ–°ç«¯å£ä½œä¸ºç›®æ ‡åœ°å€è¿›è¡Œå“åº”ã€‚</p>
</li>
<li>
<p>åœ¨ NAT è½¬æ¢è¡¨ä¸­è®°å½•æ¯ä¸€ä¸ªæº IP åœ°å€ï¼Œç«¯å£åˆ° NAT IP åœ°å€ï¼Œæ–°ç«¯å£çš„æ˜ å°„</p>
</li>
<li>
<p>ä¼ å…¥çš„æ•°æ®æŠ¥ï¼Œå°† NAT IP åœ°å€å’Œç«¯å£æ›¿æ¢ä¸º NAT è¡¨ä¸­ç›¸åº”çš„æº IP åœ°å€ï¼Œç«¯å£ã€‚</p>
</li>
</ul>
<h4 id="nat-çš„ç¼ºç‚¹"><a class="header" href="#nat-çš„ç¼ºç‚¹">NAT çš„ç¼ºç‚¹</a></h4>
<ul>
<li>16 ä½ç«¯å£å·ï¼š60000 åŒæ—¶è¿æ¥åˆ°åŒä¸€ä¸ªåœ°å€</li>
<li>NAT æœ‰äº‰è®®
<ul>
<li>routers should only process up to layer 3</li>
<li>violates end-to-end argument(è¿èƒŒ e2e åŸåˆ™)</li>
<li>NAT possibility must be taken into account by app designers, eg, P2P applications</li>
<li>address shortage should instead be solved by IPv6</li>
</ul>
</li>
</ul>
<h4 id="nat-çš„é—®é¢˜"><a class="header" href="#nat-çš„é—®é¢˜">NAT çš„é—®é¢˜</a></h4>
<p>å¤–éƒ¨çš„å®¢æˆ·ç«¯å¦‚ä½•è®¿é—®å†…ç½‘åœ°å€ï¼Ÿ</p>
<ul>
<li>
<ol>
<li>é™æ€é…ç½®ç«¯å£è½¬å‘</li>
</ol>
</li>
<li>
<ol start="2">
<li>Universal Plug and Play (UPnP) Internet Gateway Device (IGD) Protocol.</li>
</ol>
<ul>
<li>learn public IP address (138.76.29.7)</li>
<li>enumerate existing port mappings</li>
<li>add/remove port mappings (with lease times)</li>
</ul>
<blockquote>
<p>è‡ªåŠ¨é…ç½®é™æ€ç«¯å£æ˜ å°„</p>
</blockquote>
</li>
<li>
<ol start="3">
<li>ä¸­ç»§ (Skype ä½¿ç”¨)</li>
</ol>
<ul>
<li></li>
</ul>
</li>
</ul>
<h3 id="ip-æ•°æ®æŠ¥æ ¼å¼"><a class="header" href="#ip-æ•°æ®æŠ¥æ ¼å¼">IP æ•°æ®æŠ¥æ ¼å¼</a></h3>
<p>é¦–éƒ¨ (20 å­—èŠ‚å›ºå®š + å˜é•¿) + æ•°æ®</p>
<ul>
<li>ç‰ˆæœ¬â€”â€”å  4 ä½ï¼ŒæŒ‡ IP åè®®çš„ç‰ˆæœ¬ï¼Œç›®å‰çš„ IP åè®®ç‰ˆæœ¬å·ä¸º 4 (å³ IPv4)</li>
<li>é¦–éƒ¨é•¿åº¦â€”â€”å  4 ä½ï¼Œå¯è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼æ˜¯ 15 ä¸ªå•ä½ (ä¸€ä¸ªå•ä½ä¸º 4 å­—èŠ‚) å› æ­¤ IP çš„é¦–éƒ¨é•¿åº¦çš„æœ€å¤§å€¼æ˜¯ 60 å­—èŠ‚ã€‚</li>
<li>åŒºåˆ†æœåŠ¡â€”â€”å  8 ä½ï¼Œç”¨æ¥è·å¾—æ›´å¥½çš„æœåŠ¡åœ¨æ—§æ ‡å‡†ä¸­å«åšæœåŠ¡ç±»å‹ï¼Œä½†å®é™…ä¸Šä¸€ç›´æœªè¢«ä½¿ç”¨è¿‡ã€‚1998 å¹´è¿™ä¸ªå­—æ®µæ”¹åä¸ºåŒºåˆ†æœåŠ¡ã€‚åªæœ‰åœ¨ä½¿ç”¨åŒºåˆ†æœåŠ¡ï¼ˆDiffServï¼‰æ—¶ï¼Œè¿™ä¸ªå­—æ®µæ‰èµ·ä½œç”¨ã€‚åœ¨ä¸€èˆ¬çš„æƒ…å†µä¸‹éƒ½ä¸ä½¿ç”¨è¿™ä¸ªå­—æ®µ</li>
<li>æ€»é•¿åº¦â€”â€”å  16 ä½ï¼ŒæŒ‡é¦–éƒ¨å’Œæ•°æ®ä¹‹å’Œçš„é•¿åº¦ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œå› æ­¤æ•°æ®æŠ¥çš„æœ€å¤§é•¿åº¦ä¸º 65535 å­—èŠ‚ã€‚æ€»é•¿åº¦å¿…é¡»ä¸è¶…è¿‡æœ€å¤§ä¼ é€å•å…ƒ MTUã€‚</li>
<li>æ ‡è¯† (identification) å  16 ä½ï¼Œå®ƒæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨æ¥äº§ç”Ÿæ•°æ®æŠ¥çš„æ ‡è¯†ã€‚</li>
<li>æ ‡å¿— (flag) å  3 ä½ï¼Œç›®å‰åªæœ‰å‰ä¸¤ä½æœ‰æ„ä¹‰ã€‚æ ‡å¿—å­—æ®µçš„æœ€ä½ä½æ˜¯ MF (More Fragment)ã€‚
<ul>
<li>MF = 1 è¡¨ç¤ºåé¢â€œè¿˜æœ‰åˆ†ç‰‡â€ã€‚</li>
<li>MF = 0 è¡¨ç¤ºæœ€åä¸€ä¸ªåˆ†ç‰‡ã€‚</li>
<li>æ ‡å¿—å­—æ®µä¸­é—´çš„ä¸€ä½æ˜¯ DF (Don't Fragment) ã€‚åªæœ‰å½“ DF = 0 æ—¶æ‰å…è®¸åˆ†ç‰‡ã€‚</li>
</ul>
</li>
<li>ç‰‡åç§» (12 ä½) æŒ‡å‡ºï¼šè¾ƒé•¿çš„åˆ†ç»„åœ¨åˆ†ç‰‡åæŸç‰‡åœ¨åŸåˆ†ç»„ä¸­çš„ç›¸å¯¹ä½ç½®ã€‚ç‰‡åç§»ä»¥ 8 ä¸ªå­—èŠ‚ä¸ºåç§»å•ä½ã€‚</li>
<li>ç”Ÿå­˜æ—¶é—´ (8 ä½) è®°ä¸º TTL (Time To Live) æ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­å¯é€šè¿‡çš„è·¯ç”±å™¨æ•°çš„æœ€å¤§å€¼ã€‚</li>
<li>åè®® (8 ä½) å­—æ®µæŒ‡å‡ºæ­¤æ•°æ®æŠ¥æºå¸¦çš„æ•°æ®ä½¿ç”¨ä½•ç§åè®®ä»¥ä¾¿ç›®çš„ä¸»æœºçš„ IP å±‚å°†æ•°æ®éƒ¨åˆ†ä¸Šäº¤ç»™å“ªä¸ªå¤„ç†è¿‡ç¨‹</li>
<li>é¦–éƒ¨æ£€éªŒå’Œ (16 ä½) å­—æ®µåªæ£€éªŒæ•°æ®æŠ¥çš„é¦–éƒ¨ä¸æ£€éªŒæ•°æ®éƒ¨åˆ†ã€‚è¿™é‡Œä¸é‡‡ç”¨ CRC æ£€éªŒç è€Œé‡‡ç”¨ç®€å•çš„è®¡ç®—æ–¹æ³•ã€‚</li>
<li>æºåœ°å€å’Œç›®çš„åœ°å€éƒ½å„å  4 å­—èŠ‚</li>
</ul>
<h3 id="è·¯ç”±"><a class="header" href="#è·¯ç”±">è·¯ç”±</a></h3>
<h4 id="è·¯ç”±ç®—æ³•"><a class="header" href="#è·¯ç”±ç®—æ³•">è·¯ç”±ç®—æ³•</a></h4>
<ul>
<li>
<p>å…¨å±€çš„</p>
<ul>
<li>é“¾è·¯çŠ¶æ€ (link state) ç®—æ³•</li>
<li>æ‰€æœ‰è·¯ç”±å™¨éƒ½æœ‰å®Œæ•´çš„æ‹“æ‰‘ç»“æ„å’Œé“¾è·¯æˆæœ¬ä¿¡æ¯</li>
</ul>
</li>
<li>
<p>åˆ†å¸ƒå¼çš„</p>
<ul>
<li>è·¯å¾„å‘é‡ (distance vector) ç®—æ³•</li>
<li>è·¯ç”±å™¨çŸ¥é“æœ‰ç‰©ç†è¿æ¥çš„é‚»å±…ï¼Œä¸é‚»å±…çš„é“¾æ¥æˆæœ¬</li>
<li>è¿­ä»£è®¡ç®—çš„è¿‡ç¨‹ï¼Œä¸é‚»å±…äº¤æ¢ä¿¡æ¯</li>
</ul>
</li>
<li>
<p>é™æ€</p>
<ul>
<li>è·¯å¾„æ›´æ–°ç¼“æ…¢</li>
</ul>
</li>
<li>
<p>åŠ¨æ€</p>
<ul>
<li>è·¯å¾„æ›´æ–°æ›´å¿«</li>
<li>å®šæœŸæ›´æ–°</li>
<li>åº”å¯¹é“¾è·¯å˜åŒ–çš„æˆæœ¬</li>
</ul>
</li>
</ul>
<h4 id="dijkstra-ç®—æ³•"><a class="header" href="#dijkstra-ç®—æ³•">Dijkstra ç®—æ³•</a></h4>
<p>ç®—æ³•å¤æ‚æ€§ï¼šN ä¸ªèŠ‚ç‚¹</p>
<ul>
<li>æ¯æ¬¡è¿­ä»£ï¼šéœ€è¦æ£€æŸ¥æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œwï¼Œä¸åœ¨ N ä¸­çš„èŠ‚ç‚¹ n(n+1)/2 çš„æ¯”è¾ƒã€‚O(n2)</li>
<li>å¯èƒ½æœ‰æ›´æœ‰æ•ˆçš„å®ç°ã€‚O(nlogn)</li>
</ul>
<p>æœ‰å¯èƒ½å‡ºç°éœ‡è¡ï¼šä¾‹å¦‚ï¼Œé“¾è·¯æˆæœ¬=æ‰¿è½½æµé‡çš„æ•°é‡</p>
<h4 id="distance-vector-ç®—æ³•"><a class="header" href="#distance-vector-ç®—æ³•">Distance Vector ç®—æ³•</a></h4>
<p><code>d(x, y) = min { c(x, v) + d(v, y) }</code></p>
<h4 id="å¯¹æ¯”-1"><a class="header" href="#å¯¹æ¯”-1">å¯¹æ¯”</a></h4>
<p>link state(LS):</p>
<ul>
<li>æŠŠè·ç¦»å‘é‡å‘Šè¯‰æ‰€æœ‰äºº</li>
</ul>
<p>distance vector(DV):</p>
<ul>
<li>æŠŠè·ç¦»å‘é‡åªå‘Šè¯‰é‚»å±…</li>
</ul>
<p>å®é™…ä¸Šéƒ½æœ‰ç¼ºç‚¹ï¼š</p>
<ul>
<li>è¿™ä¸¤ä¸ªç®—æ³•éƒ½åªé€‚åˆè§„æ¨¡è¾ƒå°çš„ç½‘ç»œ</li>
<li>è·¯ç”±å™¨ä¸ä¸€å®šèƒ½æ‰§è¡Œç»Ÿä¸€çš„è·¯ç”±ç®—æ³•</li>
</ul>
<h3 id="åˆ†å±‚è·¯ç”±"><a class="header" href="#åˆ†å±‚è·¯ç”±">åˆ†å±‚è·¯ç”±</a></h3>
<p>å¼•å…¥ AS è‡ªæ²»ç³»ç»Ÿï¼Œä½¿ç”¨å†…éƒ¨å¤–éƒ¨ä¸¤å¥—è·¯ç”±ç®—æ³•</p>
<ul>
<li>AS ä»¥å†…ï¼šä½¿ç”¨ intra-AS è·¯ç”±ç®—æ³•</li>
<li>AS ä¹‹é—´ï¼šinter-AS ç®—æ³•</li>
</ul>
<h4 id="intra-as-è·¯ç”±"><a class="header" href="#intra-as-è·¯ç”±">Intra-AS è·¯ç”±</a></h4>
<p>ä¹Ÿç§°ä¸º (Interior Gateway Protocols) IGP å†…éƒ¨ç½‘å…³åè®®</p>
<ul>
<li>
<p>RIP</p>
<ul>
<li>distance vector</li>
<li>æœ€è¿œç»è¿‡ 15 ä¸ªè·¯ç”±å™¨</li>
<li>æ¯ 20 ç§’äº¤æ¢ä¸€æ¬¡è·¯ç”±</li>
<li>é€‚ç”¨äºå°å‹ç½‘ç»œ</li>
</ul>
</li>
<li>
<p>OSPF</p>
<ul>
<li>Dij</li>
<li>OSPF æ˜¯åˆ†å±‚çš„ï¼Œå…·æœ‰å¯æ‰©å±•æ€§</li>
<li>é€šå‘Šæ”¾åœ¨ UDP é‡Œ</li>
</ul>
</li>
<li>
<p>IGRP</p>
</li>
</ul>
<h4 id="inter-as-è·¯ç”±"><a class="header" href="#inter-as-è·¯ç”±">Inter-AS è·¯ç”±</a></h4>
<p>(Border Gateway Protocol) BGP è¾¹ç¼˜ç½‘å…³åè®®</p>
<p>é€šå‘Šæ˜¯è·¯å¾„å‘é‡ (Path Vector)ï¼Œä» AS-a åˆ° AS-b çš„è·¯å¾„å‘</p>
<p>åŸºäºç­–ç•¥è·¯ç”±ï¼Œæ–¹ä¾¿ç®¡ç†ï¼Œä¸æ˜¯ä¸ºäº†æ‰¾åˆ°æœ€ä¼˜è·¯ç”±</p>
<p>é€šå‘Šæ”¾åœ¨ TCP é‡Œ</p>
<h2 id="é“¾è·¯å±‚"><a class="header" href="#é“¾è·¯å±‚">é“¾è·¯å±‚</a></h2>
<p>é“¾è·¯çš„ç±»å‹</p>
<ul>
<li>ç‚¹å¯¹ç‚¹</li>
<li>å¹¿æ’­æˆ–å…±äº«å¼é“¾è·¯</li>
<li>äº¤æ¢å¼</li>
</ul>
<p>é—®é¢˜ï¼š</p>
<ol>
<li>
<p>å¸§</p>
<ul>
<li>æŠŠä¸Šå±‚çš„æ•°æ®ç»„è£…æˆå¸§</li>
</ul>
<p>è§£å†³é€æ˜ä¼ è¾“</p>
<ul>
<li>æ¯”ç‰¹å¡«å……</li>
<li>å­—èŠ‚</li>
</ul>
</li>
<li>
<p>æ£€é”™</p>
<p>å¥‡å¶æ ¡éªŒ</p>
<p>CRC: å¾ªç¯å†—ä½™æ ¡éªŒ</p>
</li>
<li>
<p>å¯é ä¼ è¾“</p>
</li>
<li>
<p>å¹¿æ’­çš„ç‰¹æœ‰é—®é¢˜</p>
<ul>
<li>å¤šè·¯æ§åˆ¶</li>
<li>åœ°å€åŒºåˆ†</li>
</ul>
</li>
</ol>
<h3 id="å¤šè·¯è®¿é—®åè®®-multi-access-protocol"><a class="header" href="#å¤šè·¯è®¿é—®åè®®-multi-access-protocol">å¤šè·¯è®¿é—®åè®® (multi access protocol)</a></h3>
<p>æ¥æ”¶ç«¯åŒæ—¶æ¥å—ä¸¤ä¸ªä»¥ä¸Šä¿¡å·æ—¶ä¼šå‘ç”Ÿå†²çªï¼Œå¤šè·¯è®¿é—®éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜</p>
<p>å¤šè·¯è®¿é—®ç‰¹ç‚¹ï¼š</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>ä¿¡é“åˆ’åˆ† (Channel Partitioning)
<ul>
<li>æ—¶åˆ†ï¼šå¯èƒ½ä¼šäº§ç”Ÿæµªè´¹</li>
<li>é¢‘åˆ†ï¼šä¸å¤Ÿçµæ´»</li>
<li>ç åˆ† (CDMA):</li>
</ul>
</li>
<li>éšæœºè®¿é—® (Random Access)
<ul>
<li>å¯èƒ½äº§ç”Ÿå†²çª</li>
<li>éœ€è¦ä»å†²çªä¸­æ¢å¤</li>
</ul>
</li>
<li>è½®è½¬ (&quot;Taking turn&quot;)
<ul>
<li>èŠ‚ç‚¹å¤šçš„æ—¶å€™è½®è½¬æ—¶é—´ä¼šå˜é•¿</li>
</ul>
</li>
</ul>
<h4 id="éšæœºè®¿é—®"><a class="header" href="#éšæœºè®¿é—®">éšæœºè®¿é—®</a></h4>
<p>å¦‚ä½•æ£€é”™ï¼Œå¦‚ä½•æ¢å¤ï¼Ÿ</p>
<ol>
<li>
<p>ALOHA:</p>
<ul>
<li>æœ‰æ•°æ®å°±å‘ï¼Œæœ‰å†²çªå°±åœæ­¢</li>
<li>æœ€å¤§åˆ©ç”¨ç‡ 37%</li>
</ul>
</li>
<li>
<p>Pure ALOHA:</p>
<ul>
<li>æœ€å¤§åˆ©ç”¨ç‡ 18%</li>
</ul>
</li>
<li>
<p>CSMA (è½½æ³¢ç›‘å¬ï¼Œå¤šç‚¹æ¥å…¥):</p>
<ul>
<li>å…ˆå»ç›‘å¬æ˜¯å¦æœ‰å…¶ä»–äººå‘æ•°æ®ï¼Œæ²¡æœ‰äº†å†å‘</li>
</ul>
</li>
<li>
<p>CSMA/CD (Collision detection)</p>
<ul>
<li>å¸¦æœ‰å†²çªæ£€æµ‹ï¼Œä¸€è¾¹å‘ä¸€è¾¹æ£€æµ‹</li>
</ul>
</li>
</ol>
<h4 id="è½®æµè®¿é—®"><a class="header" href="#è½®æµè®¿é—®">è½®æµè®¿é—®</a></h4>
<ul>
<li>
<p>è½®è¯¢ (Polling)</p>
</li>
<li>
<p>ä»¤ç‰Œä¼ é€’ (Token passing)</p>
</li>
</ul>
<h3 id="mac-åœ°å€"><a class="header" href="#mac-åœ°å€">MAC åœ°å€</a></h3>
<p>ä¸€èˆ¬ç›´æ¥å†™å…¥ç½‘å¡</p>
<ul>
<li>48 bit</li>
</ul>
<p>å¹¿æ’­åœ°å€ï¼š<code>FF-FF-FF-FF-FF-FF</code></p>
<h3 id="arp-address-resolution-protocol"><a class="header" href="#arp-address-resolution-protocol">ARP (address resolution protocol)</a></h3>
<p>ARP åœ°å€è§£æåè®®</p>
<p>é€šè¿‡ ARP è¡¨å°† ip è§£æä¸º MAC åœ°å€</p>
<table><thead><tr><th>IP addr</th><th>MAC addr</th><th>TTL</th></tr></thead><tbody>
<tr><td></td><td></td><td></td></tr>
</tbody></table>
<p>å¦‚ä½•æ„å»º ARP è¡¨ï¼Ÿ</p>
<ol>
<li>
<p>å¹¿æ’­ï¼šA é€šè¿‡å¹¿æ’­å‘é€ ARP è¯·æ±‚</p>
</li>
<li>
<p>å“åº”ï¼šB å“åº”æ—¶æ˜¯å•æ’­ï¼Œè¿”å›è‡ªå·±çš„ MAC åœ°å€</p>
</li>
<li>
<p>ä¿å­˜ï¼šA å°†æ”¶åˆ°çš„æ•°æ®æ”¾å…¥è‡ªå·±çš„ ARP è¡¨</p>
</li>
</ol>
<p>è·¯ç”±å™¨ä¸ä¼šæ”¹å˜æº IP å’Œç›®çš„ IP, ç›®çš„ MAC åœ°å€åˆ™ä¼šä¸€ç›´æ”¹å˜</p>
<ol>
<li>å‘é€æ–¹æ˜¯ä¸»æœºï¼Œè¦æŠŠ IP æ•°æ®æŠ¥å‘é€åˆ°æœ¬ç½‘ç»œä¸Šçš„å¦ä¸€ä¸ª ä¸»æœºã€‚è¿™æ—¶ç”¨ ARP æ‰¾åˆ°ç›®çš„ä¸»æœºçš„ç¡¬ä»¶åœ°å€ã€‚</li>
<li>å‘é€æ–¹æ˜¯ä¸»æœºï¼Œè¦æŠŠ IP æ•°æ®æŠ¥å‘é€åˆ°å¦ä¸€ä¸ªç½‘ç»œä¸Šçš„ä¸€ ä¸ªä¸»æœºã€‚è¿™æ—¶ç”¨ ARP æ‰¾åˆ°æœ¬ç½‘ç»œä¸Šçš„ä¸€ä¸ªè·¯ç”±å™¨çš„ç¡¬ä»¶ åœ°å€ã€‚å‰©ä¸‹çš„å·¥ä½œç”±è¿™ä¸ªè·¯ç”±å™¨æ¥å®Œæˆã€‚</li>
<li>å‘é€æ–¹æ˜¯è·¯ç”±å™¨ï¼Œè¦æŠŠ IP æ•°æ®æŠ¥è½¬å‘åˆ°æœ¬ç½‘ç»œä¸Šçš„ä¸€ä¸ª ä¸»æœºã€‚è¿™æ—¶ç”¨ ARP æ‰¾åˆ°ç›®çš„ä¸»æœºçš„ç¡¬ä»¶åœ°å€ã€‚</li>
<li>å‘é€æ–¹æ˜¯è·¯ç”±å™¨ï¼Œè¦æŠŠ IP æ•°æ®æŠ¥è½¬å‘åˆ°å¦ä¸€ä¸ªç½‘ç»œä¸Šçš„ ä¸€ä¸ªä¸»æœºã€‚è¿™æ—¶ç”¨ ARP æ‰¾åˆ°æœ¬ç½‘ç»œä¸Šå¦ä¸€ä¸ªè·¯ç”±å™¨çš„ç¡¬ ä»¶åœ°å€ã€‚å‰©ä¸‹çš„å·¥ä½œç”±è¿™ä¸ªè·¯ç”±å™¨æ¥å®Œæˆã€‚</li>
</ol>
<h3 id="repeaters-ä¸­ç»§å™¨"><a class="header" href="#repeaters-ä¸­ç»§å™¨">Repeaters (ä¸­ç»§å™¨)</a></h3>
<h3 id="hubsé›†çº¿å™¨"><a class="header" href="#hubsé›†çº¿å™¨">Hubs(é›†çº¿å™¨)</a></h3>
<ul>
<li>å’Œä¸­ç»§å™¨æ˜¯åŒä¸€ç±»è®¾å¤‡ï¼Œåªä¸è¿‡ç«¯å£æ•°é‡æ›´å¤š</li>
<li>é›†çº¿å™¨ä¼šå°†ä»ä¸€ä¸ªé“¾è·¯ä¼ æ¥çš„æ•°æ®è½¬å‘åˆ°æ‰€æœ‰å…¶ä»–é“¾è·¯</li>
<li>æ‰€æœ‰è¿æ¥çš„é“¾è·¯éƒ½ä¼šå‘ç”Ÿå†²çª</li>
<li>ç”¨é›†çº¿å™¨ç»„æˆçš„æ›´å¤§å±€åŸŸç½‘éƒ½åœ¨ä¸€ä¸ªç¢°æ’åŸŸé‡Œï¼Œæ‰€ä»¥æ€»ååé‡å¹¶æœªæé«˜</li>
</ul>
<h3 id="bridgeç½‘æ¡¥"><a class="header" href="#bridgeç½‘æ¡¥">Bridge(ç½‘æ¡¥)</a></h3>
<h3 id="switchäº¤æ¢æœº"><a class="header" href="#switchäº¤æ¢æœº">Switch(äº¤æ¢æœº)</a></h3>
<ul>
<li>å¤šç«¯å£çš„ç½‘æ¡¥</li>
<li>æ™ºèƒ½åŒ–è½¬å‘ï¼Œè‡ªåŠ¨å­¦ä¹ </li>
</ul>
<p>äº¤æ¢æœºå¯ä»¥åˆ†å‰²å†²çªåŸŸ</p>
<p>Switch Table (äº¤æ¢è¡¨)</p>
<p>| MAC address of host | interface to reach MAC | time stamp |</p>
<ul>
<li>äº¤æ¢æœºä¸€å®šä¸èƒ½æˆç¯ï¼Œå¦åˆ™ä¼šäº§ç”Ÿå¹¿æ’­é£æš´</li>
</ul>
<table><thead><tr><th></th><th>é›†çº¿å™¨</th><th>äº¤æ¢æœº</th><th>è·¯ç”±å™¨</th></tr></thead><tbody>
<tr><td>åˆ†å‰²å†²çªåŸŸ</td><td>0</td><td>1</td><td>1</td></tr>
<tr><td>åˆ†å‰²å¹¿æ’­åŸŸ</td><td>0</td><td>0</td><td>1</td></tr>
<tr><td>å³æ’å³ç”¨</td><td>1</td><td>1</td><td>0</td></tr>
<tr><td>æœ€æœ‰è·¯å¾„</td><td>0</td><td>0</td><td>1</td></tr>
<tr><td>ç›´é€šè½¬å‘</td><td>1</td><td>1</td><td>0</td></tr>
</tbody></table>
<h3 id="vlan"><a class="header" href="#vlan">VLAN</a></h3>
<ul>
<li>è™šæ‹Ÿå±€åŸŸç½‘</li>
<li>å¯ä»¥è·¨äº¤æ¢æœº</li>
<li>è·¨ VLAN çš„æµé‡éƒ½éœ€è¦ç»è¿‡è·¯ç”±å™¨è½¬å‘</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="lets-dev-a-package-manager"><a class="header" href="#lets-dev-a-package-manager">Let's Dev: A Package Manager</a></h1>
<p>å¤§å®¶å¥½ï¼ä»Šå¤©ï¼Œæˆ‘ä»¬è¦å†™ä¸€ä¸ªæ–°çš„åŒ…ç®¡ç†å™¨ï¼Œç”šè‡³æ¯” Yarn è¿˜è¦å¥½ï¼å¥½å§ï¼Œä¹Ÿè®¸ä¸æ˜¯ï¼Œä½†è‡³å°‘æˆ‘ä»¬ä¼šç©å¾—å¼€å¿ƒï¼Œäº†è§£åŒ…ç®¡ç†å™¨çš„å·¥ä½œåŸç†ï¼Œå¹¶æ€è€ƒ Yarn
çš„ä¸‹ä¸€æ­¥å¯èƒ½ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆ†å¸ƒå¼ç³»ç»Ÿ"><a class="header" href="#åˆ†å¸ƒå¼ç³»ç»Ÿ">åˆ†å¸ƒå¼ç³»ç»Ÿ</a></h1>
<h2 id="ä¼˜åŠ¿"><a class="header" href="#ä¼˜åŠ¿">ä¼˜åŠ¿</a></h2>
<ul>
<li>
<p>é€šè¿‡å¹¶è¡Œè®¡ç®—å¢åŠ å®¹é‡ (parallelism)</p>
</li>
<li>
<p>é€šè¿‡å¤åˆ¶å®¹å¿æ•…éšœ (fault tolerance)</p>
</li>
<li>
<p>åŒ¹é…ç‰©ç†è®¾å¤‡çš„åˆ†å¸ƒ (physical)</p>
</li>
<li>
<p>é€šè¿‡éš”ç¦»æ¥å®ç°å®‰å…¨ (security / isolated)</p>
<ul>
<li>å°†å®‰å…¨çš„å’Œä¸å®‰å…¨çš„è®¡ç®—æ”¾åœ¨ä¸åŒæœºå™¨ä¸Šè¿è¡Œ</li>
<li>ç³»ç»Ÿé—´é€šè¿‡ç½‘ç»œè¿›è¡Œäº¤äº’</li>
</ul>
</li>
</ul>
<h2 id="æŒ‘æˆ˜"><a class="header" href="#æŒ‘æˆ˜">æŒ‘æˆ˜</a></h2>
<ul>
<li>
<p>åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰è®¸å¤šéƒ¨åˆ†ç»„æˆï¼Œè¿™äº›éƒ¨åˆ†æ˜¯åŒæ—¶è¿è¡Œçš„ï¼Œä¼šé‡åˆ°å„ç§å¹¶å‘ç¼–ç¨‹å’Œå¤æ‚äº¤äº’å¸¦æ¥çš„é—®é¢˜ã€‚å› æ­¤éœ€è¦æŸäº›æœºåˆ¶åœ¨æ—¶é—´ä¸Šè¿›è¡Œæ§åˆ¶ï¼ˆæ¯”å¦‚è¶…æ—¶æœºåˆ¶ï¼Œç†”æ–­æœºåˆ¶ï¼‰ã€‚</p>
</li>
<li>
<p>å¤šå°è®¡ç®—æœºåŠ ç½‘ç»œä¼šä½¿æ•…éšœåŸå› ä¹Ÿæ›´åŠ å¤æ‚</p>
</li>
<li>
<p>æ€§èƒ½ï¼Œn å°è®¡ç®—æœºå¹¶ä¸èƒ½è¾¾åˆ° n å€çš„æ€§èƒ½</p>
</li>
</ul>
<h2 id="ä¸»é¢˜"><a class="header" href="#ä¸»é¢˜">ä¸»é¢˜</a></h2>
<ol>
<li>
<p>ä¸€è‡´æ€§</p>
<p>é€šç”¨çš„åŸºç¡€è®¾æ–½éœ€è¦æœ‰æ˜ç¡®çš„è¡Œä¸ºã€‚ä¾‹å¦‚ï¼Œ&quot;Get(k) è·å–æœ€è¿‘ä¸€æ¬¡ Put(k,v) çš„å€¼&quot;ã€‚</p>
<p>å®ç°è‰¯å¥½çš„è¡Œä¸ºæ˜¯å¾ˆéš¾çš„ï¼ &quot;å¤åˆ¶&quot; çš„æœåŠ¡å™¨å¾ˆéš¾ä¿æŒä¸€è‡´ã€‚</p>
</li>
<li>
<p>æ€§èƒ½</p>
<p>ç›®æ ‡ï¼šå¯æ‰©å±•çš„ååé‡</p>
<p>Nx ä¸ªæœåŠ¡å™¨ï¼Œé€šè¿‡å¹¶è¡Œçš„ CPUã€ç£ç›˜ã€ç½‘ç»œå®ç° Nx ä¸ªæ€»ååé‡ã€‚éšç€ N çš„å¢é•¿ï¼Œæ‰©å±•ä¼šå˜å¾—æ›´åŠ å›°éš¾ï¼Œè´Ÿè½½ä¸å¹³è¡¡ã€‚æœ‰äº›äº‹æƒ…ä¸ä¼šéšç€ N çš„å¢åŠ è€ŒåŠ å¿«ï¼Œä¾‹å¦‚åˆå§‹åŒ–ã€äº¤äº’ã€‚</p>
</li>
<li>
<p>æƒè¡¡</p>
<p>å®¹é”™æ€§ã€ä¸€è‡´æ€§å’Œæ€§èƒ½æ˜¯æ•Œäººã€‚å®ç°å®¹é”™æ€§å’Œä¸€è‡´æ€§éœ€è¦é€šä¿¡</p>
<ul>
<li>
<p>å‘é€æ•°æ®åˆ°å¤‡ä»½</p>
</li>
<li>
<p>æ£€æŸ¥æ•°æ®æ˜¯å¦æ˜¯æœ€æ–°çš„ã€‚</p>
</li>
<li>
<p>é€šä¿¡é€šå¸¸å¾ˆæ…¢ï¼Œè€Œä¸”ä¸å¯æ‰©å±•</p>
</li>
<li>
<p>è®¸å¤šè®¾è®¡åªæä¾›å¼±çš„ä¸€è‡´æ€§ï¼Œä»¥è·å¾—é€Ÿåº¦ã€‚</p>
<ul>
<li>ä¾‹å¦‚ï¼ŒGet() å¹¶ä¸*äº§ç”Ÿæœ€æ–°çš„ Put()! å¯¹äºåº”ç”¨ç¨‹åºçš„ç¨‹åºå‘˜æ¥è¯´ï¼Œè¿™æ˜¯å¾ˆç—›è‹¦çš„ï¼Œä½†å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æƒè¡¡ã€‚</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬ä¼šåœ¨ä¸€è‡´æ€§/æ€§èƒ½ä¸­çœ‹åˆ°è®¸å¤šè®¾è®¡ç‚¹ã€‚</p>
</li>
<li>
<p>å®ç°</p>
<p>RPCã€çº¿ç¨‹ã€å¹¶å‘æ§åˆ¶ã€‚</p>
</li>
</ol>
<h2 id="lab"><a class="header" href="#lab">Lab</a></h2>
<ul>
<li>
<p>Map-Reduce</p>
</li>
<li>
<p>Raft è§£å†³å®¹é”™æ€§</p>
</li>
<li>
<p>ä½¿ç”¨ Raft æ„å»º K/V serverï¼Œå®ƒå¯ä»¥è¢«å¤åˆ¶</p>
</li>
<li>
<p>Sharded K/V server å°†æœ‰å¯å¤åˆ¶èƒ½åŠ›çš„ä¸»å¤‡ K/V server å…‹éš†åˆ°å¤šä¸ªç»„ä¸­ï¼Œå¹¶å°†ä¹‹å‰çš„æ•°æ®åˆ†å‰²å­˜å‚¨åˆ°è¿™äº›ç»„ä¸­ï¼Œæé«˜è¿è¡Œé€Ÿåº¦ï¼ˆæ¯ä¸ªç»„åªå­˜å‚¨è‡ªå·±å¯¹åº”çš„æ•°æ®ï¼Œç»„åˆèµ·æ¥å°±æ˜¯ä¸€æ•´ä»½æ•°æ®ï¼‰ã€‚åŒæ—¶è¿˜è¦å®ç°åœ¨ä¸åŒçš„æœåŠ¡æœŸé—´ç§»åŠ¨æ•°æ®ï¼Œä¿è¯ä¸ä¼šä¸¢å¤±ï¼ˆæ•°æ®åˆ†ç‰‡åˆ°å„ä¸ªç»„ä¸­ï¼Œå„ç»„çš„æœåŠ¡å™¨å†…ä¹Ÿä¼šæœ‰ä¸»ä»å¤åˆ¶ï¼‰ã€‚</p>
</li>
</ul>
<h2 id="map-reduce"><a class="header" href="#map-reduce">Map-Reduce</a></h2>
<p>ä»¥ä¸€ä¸ª word-count ä¸ºä¾‹ï¼Œå¦‚æœé›†ç¾¤è¦å¯¹ä¸Šä¸‡çš„æ–‡ä»¶è¿›è¡Œè®¡ç®—ï¼ŒGFS ä¼šå…ˆå¯»æ‰¾åˆ°æ–‡ä»¶çš„æ‰€åœ¨ä½ç½®ï¼Œç„¶åç›´æ¥åœ¨æœ¬æœºçš„ map-reduce ç¨‹åºä¸­è¿è¡Œï¼Œä»è€ŒèŠ‚çº¦äº†å¤§é‡çš„ç½‘ç»œä¼ è¾“ã€‚</p>
<blockquote>
<p>å°†æŒ‰è¡Œå­˜å‚¨è½¬æ¢ä¸ºæŒ‰åˆ—å­˜å‚¨çš„è¿‡ç¨‹ï¼Œåœ¨è®ºæ–‡ä¸­æˆä¸º shuffle</p>
</blockquote>
<h3 id="æ¦‚è¿°-6"><a class="header" href="#æ¦‚è¿°-6">æ¦‚è¿°</a></h3>
<p>èƒŒæ™¯ï¼šåœ¨å¤š TB çº§æ•°æ®é›†ä¸Šè¿›è¡Œå¤šå°æ—¶çš„è®¡ç®—ï¼Œä¾‹å¦‚ï¼Œå»ºç«‹æœç´¢ç´¢å¼•ï¼Œæˆ–æ’åºï¼Œæˆ–åˆ†æç½‘ç»œçš„ç»“æ„ï¼Œåªæœ‰åœ¨æœ‰ 1000 å°è®¡ç®—æœºçš„æƒ…å†µä¸‹æ‰å®ç”¨ã€‚</p>
<p>ä½†æ˜¯åº”ç”¨ä¸æ˜¯ç”±åˆ†å¸ƒå¼ç³»ç»Ÿä¸“å®¶ç¼–å†™çš„ï¼Œå®ƒçš„æ€»ä½“ç›®æ ‡æ˜¯è®©éä¸“ä¸šçš„ç¨‹åºå‘˜ä¹Ÿèƒ½è½»æ¾ä½¿ç”¨ï¼Œå¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œä»–åªéœ€è¦å®šä¹‰ Map å’Œ Reduce å‡½æ•° (é€šå¸¸æ˜¯ç›¸å½“ç®€å•çš„åŒæ­¥ä»£ç ). MR ç®¡ç†å¹¶éšè—äº†åˆ†å¸ƒå¼çš„æ‰€æœ‰ç»†èŠ‚ï¼</p>
<p>ä¸€ä¸ª MapReduce ä½œä¸šçš„æŠ½è±¡è§†å›¾</p>
<pre><code>è¾“å…¥ 1 -&gt; Map -&gt; a,1 b,1
è¾“å…¥ 2 -&gt; Map -&gt; b,1
è¾“å…¥ 3 -&gt; Map -&gt; a,1 c,1
| | |
| | -&gt; Reduce -&gt; c,1
| -----&gt; Reduce -&gt; b,2
---------&gt; Reduce -&gt; a,2
</code></pre>
<ul>
<li>
<ol>
<li>è¾“å…¥æ–‡ä»¶ï¼ˆå·²ç»ï¼‰è¢«åˆ†æˆ M ä¸ªæ–‡ä»¶</li>
</ol>
</li>
<li>
<ol start="2">
<li>MR å¯¹æ¯ä¸ªè¾“å…¥æ–‡ä»¶è°ƒç”¨ Map()ï¼Œäº§ç”Ÿä¸€ç»„ k2, v2 çš„ &quot;ä¸­é—´&quot; æ•°æ®ï¼Œæ¯ä¸ª Map() è°ƒç”¨éƒ½æ˜¯ä¸€ä¸ª &quot;ä»»åŠ¡&quot;</li>
</ol>
</li>
<li>
<ol start="3">
<li>å½“åœ°å›¾è¢« Reduce æ—¶ã€‚MR ä¼šæ”¶é›†ç»™å®š k2 çš„æ‰€æœ‰ä¸­é—´ v2ã€‚å¹¶å°†æ¯ä¸ªé”®å’Œå€¼ä¼ é€’ç»™ä¸€ä¸ª Reduce è°ƒç”¨</li>
</ol>
</li>
<li>
<ol start="4">
<li>æœ€ç»ˆè¾“å‡ºæ˜¯æ¥è‡ª Reduce() çš„&lt;k2,v3&gt;å¯¹çš„é›†åˆã€‚</li>
</ol>
</li>
</ul>
<p>ä»¥ wordcount ä¸ºä¾‹ï¼š</p>
<ul>
<li>Map(k, v) å°† v åˆ†å‰²æˆå•è¯</li>
<li>å¯¹äºæ¯ä¸ªè¯ w, emit(w, &quot;1&quot;)</li>
<li>Reduce(k, v_set)</li>
<li>emit(len(v_set))</li>
</ul>
<h3 id="mapreduce-ç³»ç»Ÿçš„ä¼˜ç¼ºç‚¹"><a class="header" href="#mapreduce-ç³»ç»Ÿçš„ä¼˜ç¼ºç‚¹">MapReduce ç³»ç»Ÿçš„ä¼˜ç¼ºç‚¹</a></h3>
<ol>
<li>
<p>MapReduce çš„æ‰©å±•æ€§å¾ˆå¥½ã€‚</p>
<p>N ä¸ª worker è®¡ç®—æœºï¼ˆå¯èƒ½ï¼‰è®©ä½ è·å¾— Nx çš„ååé‡ã€‚Maps() å’Œ Reduce() å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œå› ä¸ºå®ƒä»¬ä¸ç›¸äº’å½±å“ã€‚å› æ­¤ï¼Œæ›´å¤šçš„è®¡ç®—æœºå¯ä»¥å¸¦æ¥æ›´å¤šçš„ååé‡ï¼</p>
</li>
<li>
<p>MapReduce éšè—äº†å¾ˆå¤šç»†èŠ‚ã€‚</p>
<ul>
<li>å‘é€åº”ç”¨ä»£ç åˆ°æœåŠ¡å™¨</li>
<li>è·Ÿè¸ªå“ªäº›ä»»åŠ¡å·²ç»å®Œæˆ</li>
<li>å°†ä¸­é—´æ•°æ®ä» Maps &quot;æ´—&quot; åˆ° Reduce ä¸­å»</li>
<li>å¹³è¡¡æœåŠ¡å™¨ä¸Šçš„è´Ÿè½½</li>
<li>ä»æ•…éšœä¸­æ¢å¤ã€‚</li>
</ul>
</li>
<li>
<p>MapReduce é™åˆ¶äº†åº”ç”¨ç¨‹åºå¯ä»¥åšçš„äº‹ã€‚</p>
<ul>
<li>æ²¡æœ‰äº’åŠ¨æˆ–çŠ¶æ€ (é™¤äº†é€šè¿‡ä¸­é—´è¾“å‡º)</li>
<li>æ²¡æœ‰è¿­ä»£</li>
<li>æ²¡æœ‰å®æ—¶æˆ–æµå¼å¤„ç†</li>
</ul>
</li>
<li>
<p>MapReduce è¾“å…¥å’Œè¾“å‡ºéƒ½å­˜å‚¨åœ¨ GFS é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿä¸Š</p>
<ul>
<li>MR éœ€è¦å·¨å¤§çš„å¹¶è¡Œè¾“å…¥å’Œè¾“å‡ºçš„ååé‡ã€‚</li>
<li>GFS å°†æ–‡ä»¶åˆ†å‰²åˆ°è®¸å¤šæœåŠ¡å™¨ä¸Šï¼Œä»¥ 64MB ä¸ºä¸€ä¸ªå—ã€‚
<ul>
<li>Map å¹¶è¡Œè¯»å–</li>
<li>Reduce å¹¶è¡Œå†™å…¥</li>
</ul>
</li>
<li>GFS è¿˜å°†æ¯ä¸ªæ–‡ä»¶å¤åˆ¶åˆ° 2 æˆ– 3 ä¸ªæœåŠ¡å™¨ä¸Š</li>
</ul>
</li>
</ol>
<h3 id="mr-çš„å·¥ä½œç»†èŠ‚"><a class="header" href="#mr-çš„å·¥ä½œç»†èŠ‚">MR çš„å·¥ä½œç»†èŠ‚</a></h3>
<ol>
<li>
<p>MapReduce éœ€è¦ä¸€ä¸ªåè°ƒå™¨ï¼Œå°†ä»»åŠ¡åˆ†é…ç»™ worker å¹¶çºªå½•è¿›åº¦ã€‚</p>
<p>åè°ƒå™¨å°† Map ä»»åŠ¡åˆ†é…ç»™ workerï¼Œç›´åˆ°æ‰€æœ‰çš„ Map å®Œæˆã€‚</p>
<ul>
<li>Map å°†è¾“å‡ºï¼ˆæˆ–è€…è¯´ä¸­é—´æ•°æ®ï¼‰å†™åˆ°æœ¬åœ°ç£ç›˜ä¸Š</li>
<li>Map é€šè¿‡å“ˆå¸Œå°†è¾“å‡ºåˆ†å‰²åˆ°æ¯ä¸ª Reduce ä»»åŠ¡çš„ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚</li>
</ul>
<p>åœ¨æ‰€æœ‰ Map å®Œæˆåï¼Œåè°ƒå™¨å°† Reduce ä»»åŠ¡åˆ†é…ç»™ worker</p>
<ul>
<li>æ¯ä¸ª Reduce ä»»åŠ¡ä»ï¼ˆæ‰€æœ‰ï¼‰Map worker é‚£é‡Œè·å–å…¶ä¸­é—´è¾“å‡ºã€‚</li>
<li>æ¯ä¸ª Reduce ä»»åŠ¡åœ¨ GFS ä¸Šå†™å…¥ä¸€ä¸ªå•ç‹¬çš„è¾“å‡ºæ–‡ä»¶</li>
</ul>
</li>
<li>
<p>ä»€ä¹ˆå¯èƒ½ä¼šé™åˆ¶æ€§èƒ½ï¼Ÿ</p>
<p>CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œï¼Ÿåœ¨ 2004 å¹´ï¼Œè®ºæ–‡ä½œè€…å—åˆ°äº†ç½‘ç»œå®¹é‡çš„é™åˆ¶ã€‚</p>
<p>MR åœ¨ç½‘ç»œä¸Šå‘é€ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>Map ä» GFS è¯»å–è¾“å…¥ã€‚</li>
<li>Reduces è¯»å– Map çš„ä¸­é—´è¾“å‡ºã€‚é€šå¸¸å’Œè¾“å…¥ä¸€æ ·å¤§ï¼Œä¾‹å¦‚ç”¨äºæ’åºã€‚</li>
<li>Reduces å†™è¾“å‡ºæ–‡ä»¶åˆ° GFSã€‚</li>
</ul>
<p>åœ¨ MR çš„ shuffle è¿‡ç¨‹ä¸­ï¼Œä¸€åŠçš„æµé‡è¦ç»è¿‡æ ¹äº¤æ¢æœºã€‚</p>
<p>è®ºæ–‡çš„æ ¹äº¤æ¢æœºé€Ÿåº¦ä¸º 100 ~ 200 Gb/sï¼Œæ€»å…±æœ‰ 1800 å°æœºå™¨ï¼Œæ‰€ä»¥æ¯å°æœºå™¨å¯ä»¥åˆ†å¾— 55 Gb/sã€‚ç›¸æ¯”äºç£ç›˜æˆ– RAM çš„é€Ÿåº¦å°å¾—å¤šã€‚</p>
</li>
<li>
<p>MR å¦‚ä½•å°½é‡å‡å°‘ç½‘ç»œçš„ä½¿ç”¨ï¼Ÿ</p>
<ul>
<li>
<p>åè°ƒå™¨è¯•å›¾åœ¨å­˜å‚¨å…¶è¾“å…¥çš„ GFS æœåŠ¡å™¨ä¸ŠåŸåœ°è¿è¡Œæ¯ä¸ª Map ä»»åŠ¡ã€‚æ‰€æœ‰çš„è®¡ç®—æœºéƒ½ä¼šåŒæ—¶è¿è¡Œ GFS å’Œ MR worker, æ‰€ä»¥ Map çš„è¾“å…¥éƒ½ä¼šé€šè¿‡ GFS åœ¨æœ¬åœ°ç£ç›˜è¯»å–ï¼Œè€Œä¸æ˜¯ç½‘ç»œã€‚</p>
</li>
<li>
<p>ä¸­é—´æ•°æ®è¢«åˆ†å‰²ä¸ºè®¸å¤šæ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶éƒ½å­˜å‚¨äº†è®¸å¤š key. æ–‡ä»¶æ•°é‡æ¯” key è¦å°‘å¾—å¤šï¼Œå¤§æ–‡ä»¶ä¼ è¾“çš„æ•ˆç‡è¦æ›´é«˜</p>
</li>
</ul>
</li>
<li>
<p>MR å¦‚ä½•å¤„ç†è´Ÿè½½å‡è¡¡ï¼Ÿ</p>
<p>å¦‚æœ N-1 ä¸ªæœåŠ¡å™¨å¿…é¡»ç­‰å¾… 1 ä¸ªæ…¢é€ŸæœåŠ¡å™¨å®Œæˆï¼Œåˆ™æ˜¯æµªè´¹å’Œç¼“æ…¢çš„ã€‚ä½†æœ‰äº›ä»»åŠ¡å¯èƒ½ç¡®å®æ¯”å…¶ä»–ä»»åŠ¡èŠ±çš„æ—¶é—´æ›´é•¿ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šæ¯” worker æ•°é‡å¤šå¾—å¤šçš„ä»»åŠ¡</p>
<ul>
<li>åè°ƒå™¨å°†æ–°çš„ä»»åŠ¡åˆ†é…ç»™å®Œæˆå…ˆå‰ä»»åŠ¡çš„ workerã€‚</li>
<li>å› æ­¤ï¼Œæ²¡æœ‰ä¸€ä¸ªä»»åŠ¡å¤§åˆ°å¯ä»¥æ”¯é…å®Œæˆæ—¶é—´ï¼ˆå¸Œæœ›å¦‚æ­¤ï¼‰ã€‚</li>
<li>å› æ­¤ï¼Œå¿«çš„æœåŠ¡å™¨ä¼šæ¯”æ…¢çš„æœåŠ¡å™¨åšæ›´å¤šçš„ä»»åŠ¡ï¼Œå®Œæˆçš„æ—¶é—´ä¹Ÿå·®ä¸å¤šã€‚</li>
</ul>
</li>
<li>
<p>MR çš„å®¹é”™æ€§å¦‚ä½•ï¼Ÿ</p>
<p>å¦‚æœä¸€ä¸ª worker åœ¨ MP ä»»åŠ¡ä¸­å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ
MR ä¼šå¯¹ç¨‹åºå‘˜éšè—æ•…éšœã€‚</p>
<p>MR ä¸å¿…ä»å¤´å¼€å§‹é‡æ–°è¿è¡Œæ•´ä¸ªå·¥ä½œï¼Œå®ƒåªé‡æ–°è¿è¡Œå¤±è´¥çš„ Map å’Œ Reduceã€‚å‡è®¾ MR å°†ä¸€ä¸ª Map è¿è¡Œäº†ä¸¤æ¬¡ï¼Œä¸€ä¸ª Reduce çœ‹åˆ°äº†ç¬¬ä¸€æ¬¡è¿è¡Œçš„è¾“å‡ºã€‚å¦ä¸€ä¸ª Reduce çœ‹åˆ°äº†ç¬¬äºŒæ¬¡è¿è¡Œçš„è¾“å‡ºï¼Ÿ</p>
<p>æ­£ç¡®æ€§è¦æ±‚é‡æ–°æ‰§è¡Œæ—¶äº§ç”Ÿå®Œå…¨ç›¸åŒçš„è¾“å‡ºã€‚æ‰€ä»¥ Map å’Œ Reduce å¿…é¡»æ˜¯çº¯ç¡®å®šæ€§çš„å‡½æ•°ã€‚å®ƒä»¬åªå…è®¸çœ‹å®ƒä»¬çš„å‚æ•°/è¾“å…¥ã€‚æ²¡æœ‰çŠ¶æ€ï¼Œæ²¡æœ‰æ–‡ä»¶ I/Oï¼Œæ²¡æœ‰äº¤äº’ï¼Œæ²¡æœ‰å¤–éƒ¨é€šä¿¡ã€‚</p>
<p>å¦‚æœä½ æƒ³å…è®¸ non-functional çš„ Map æˆ– Reduce å‘¢ï¼Ÿworker å¤±è´¥å°†é‡æ–°æ‰§è¡Œæ•´ä¸ªå·¥ä½œã€‚æˆ–è€…æ˜¯å›æ»šåˆ°æŸä¸ªå…¨å±€æ£€æŸ¥ç‚¹ã€‚</p>
</li>
<li>
<p>å´©æºƒæ¢å¤çš„ç»†èŠ‚</p>
<ul>
<li>
<p>ä¸€ä¸ª Map worker å´©æºƒäº†ã€‚</p>
<ul>
<li>åè°ƒå™¨æ³¨æ„åˆ° worker ä¸å†å“åº” ping</li>
<li>åè°ƒå™¨çŸ¥é“å“ªäº› Map ä»»åŠ¡åœ¨è¯¥ worker ä¸Šè¿è¡Œ
<ul>
<li>è¿™äº›ä»»åŠ¡çš„ä¸­é—´è¾“å‡ºç°åœ¨å·²ç»ä¸¢å¤±ï¼Œå¿…é¡»é‡æ–°è¿è¡Œ</li>
<li>åè°ƒå™¨é€šçŸ¥å…¶ä»– worker è¿è¡Œè¿™äº›ä»»åŠ¡</li>
</ul>
</li>
<li>å¦‚æœæ‰€æœ‰çš„ Reduce ä»»åŠ¡éƒ½è·å–äº†ä¸­é—´æ•°æ®ï¼Œå¯ä»¥ä¸é‡æ–°è¿è¡Œã€‚</li>
</ul>
</li>
<li>
<p>ä¸€ä¸ª Reduce worker å´©æºƒäº†ã€‚</p>
<ul>
<li>å®Œæˆçš„ä»»åŠ¡æ˜¯å¥½çš„ -- å·²ç»å­˜å‚¨åœ¨ GFS ä¸­ï¼Œå¹¶ä¸”ä¿å­˜æœ‰å‰¯æœ¬ã€‚</li>
<li>åè°ƒå™¨åœ¨å…¶ä»– worker ä¸Šé‡æ–°å¯åŠ¨æœªå®Œæˆçš„ä»»åŠ¡ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>å…¶ä»–æ•…éšœ/é—®é¢˜ã€‚</p>
<ul>
<li>
<p>å¦‚æœåè°ƒè€…ç»™ä¸¤ä¸ª worker åˆ†é…äº†ç›¸åŒçš„ Map ä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ</p>
<p>= ä¹Ÿè®¸åè°ƒå™¨é”™è¯¯åœ°è®¤ä¸ºä¸€ä¸ª worker æ­»äº†ã€‚å®ƒå°†åªå‘Šè¯‰ Reduce worer å…¶ä¸­ä¸€ä¸ªã€‚</p>
</li>
<li>
<p>å¦‚æœåè°ƒè€…ç»™äº†ä¸¤ä¸ª worker åŒæ ·çš„ Reduce() ä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>ä»–ä»¬éƒ½ä¼šè¯•å›¾åœ¨ GFS ä¸Šå†™ä¸‹åŒä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ï¼</li>
<li>GFS çš„åŸå­é‡å‘½åå¯ä»¥é˜²æ­¢æ··åˆï¼›ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶å°†æ˜¯å¯è§çš„ã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœä¸€ä¸ª worker éå¸¸æ…¢ --&quot;æ•£å…µæ¸¸å‹‡&quot;ï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>ä¹Ÿè®¸æ˜¯ç¡¬ä»¶å®ƒå¼±ã€‚</li>
<li>åè°ƒå™¨å¯åŠ¨æœ€åå‡ ä¸ªä»»åŠ¡çš„ç¬¬äºŒä¸ªå‰¯æœ¬ã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœä¸€ä¸ª worker ç”±äºç¡¬ä»¶æˆ–è½¯ä»¶æŸåè€Œè®¡ç®—å‡ºä¸æ­£ç¡®çš„è¾“å‡ºï¼Œæ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>å¤ªç³Ÿç³•äº†ï¼MR å‡è®¾ &quot;æ•…éšœåœæ­¢&quot; çš„ CPU å’Œè½¯ä»¶ã€‚</li>
</ul>
</li>
<li>
<p>å¦‚æœåè°ƒå™¨å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ</p>
</li>
</ul>
</li>
<li>
<p>ç›®å‰çš„çŠ¶å†µï¼Ÿ</p>
<ul>
<li>å½±å“åŠ›å·¨å¤§ï¼ˆHadoop, Spark, &amp;cï¼‰ã€‚</li>
<li>å¯èƒ½è°·æ­Œå·²ç»ä¸ä½¿ç”¨äº†ã€‚
<ul>
<li>è¢«Flume/FlumeJavaå–ä»£ï¼ˆè§Chambersç­‰äººçš„è®ºæ–‡ï¼‰ã€‚</li>
<li>GFS è¢« Colossusï¼ˆæ²¡æœ‰å¥½çš„æè¿°ï¼‰å’Œ BigTable å–ä»£ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç»“è®º</p>
<p>MapReduce ä½¿å¤§é›†ç¾¤è®¡ç®—æµè¡Œèµ·æ¥ã€‚</p>
<ul>
<li>ä¸æ˜¯æœ€æœ‰æ•ˆæˆ–æœ€çµæ´»çš„ã€‚</li>
<li>æ‰©å±•æ€§å¥½ã€‚</li>
<li>æ˜“äºç¼–ç¨‹</li>
</ul>
<p>è¿™äº›åœ¨å®è·µä¸­æ˜¯å¾ˆå¥½çš„æƒè¡¡ã€‚ç°åœ¨å·²ç»æœ‰äº†ä¸€äº›æ›´é«˜çº§çš„ç»§æ‰¿è€…ã€‚</p>
</li>
</ol>
<h3 id="è®ºæ–‡ç»†èŠ‚"><a class="header" href="#è®ºæ–‡ç»†èŠ‚">è®ºæ–‡ç»†èŠ‚</a></h3>
<div style="break-before: page; page-break-before: always;"></div><h1 id="2022-ç§‹å†¬å­£å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥"><a class="header" href="#2022-ç§‹å†¬å­£å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥">2022 ç§‹å†¬å­£å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥</a></h1>
<h2 id="11-æœˆ"><a class="header" href="#11-æœˆ">11 æœˆ</a></h2>
<h3 id="116---11-26"><a class="header" href="#116---11-26">11.6 - 11-26</a></h3>
<p>RISC-V æ‰‹å†Œè¯»å®Œï¼Œé¡ºä¾¿è·Ÿç€ç±³è€å¸ˆçš„è¯¾æœ‰å·©å›ºäº†ä¸€ä¸‹ï¼Œæ„Ÿè§‰æ¯”çœ‹ä¹¦ç†è§£äº†æ›´å¤šã€‚</p>
<blockquote>
<p>æŠ˜è…¾äº†æ–°ç³»ç»Ÿï¼Œä½œä¸šï¼Œè€ƒè¯•ï¼Œå¹¸äºæ—©çœ‹äº†åå‡ å¤©ã€‚åˆšå¥½èµ¶ä¸Šäº†è¿›åº¦ã€‚</p>
</blockquote>
<h3 id="116"><a class="header" href="#116">11.6</a></h3>
<p>RISC-V æ‰‹å†Œå‰åŠéƒ¨åˆ†</p>
<h3 id="112---115"><a class="header" href="#112---115">11.2 - 11.5</a></h3>
<p>RISC-V é»‘çš®ä¹¦ç¬¬äºŒç« å®Œæˆ</p>
<h3 id="1028---111"><a class="header" href="#1028---111">10.28 - 11.1</a></h3>
<p>è¯» RISC-V æ‰‹å†Œå‰ä¸¤ç« ã€‚è®¡ç»„ 2.7, 2.8 æ™•ã€‚</p>
<p>çœ‹äº†å…³äºé“¾æ¥è„šæœ¬çš„è§†é¢‘ (æ²¡è®°ç¬”è®°), æ„Ÿè§‰è¦åœ¨çœ‹ä¸€éã€‚</p>
<h3 id="1026---1027"><a class="header" href="#1026---1027">10.26 - 10.27</a></h3>
<p>Rust Quiz å®Œæˆã€‚</p>
<h3 id="1025"><a class="header" href="#1025">10.25</a></h3>
<p>Rust Quiz ç¬¬ 20 é¢˜ã€‚</p>
<p>é»‘çš®ä¹¦ 2.0 - 2.6</p>
<h3 id="1024"><a class="header" href="#1024">10.24</a></h3>
<p>Rust Quiz ç¬¬ 19 é¢˜ã€‚</p>
<h3 id="1023"><a class="header" href="#1023">10.23</a></h3>
<p>çœ‹äº†è®¡ç®—æœºç»„æˆä¸è®¾è®¡ï¼šç¡¬ä»¶è½¯ä»¶æ¥å£ RISC-V ç‰ˆ (é»‘çš®ä¹¦) ç¬¬ä¸€ç« </p>
<p>Rust Quiz ç¬¬ 10 é¢˜ã€‚</p>
<h3 id="1022"><a class="header" href="#1022">10.22</a></h3>
<p>ä»Šå¤©å‘ç° classroom çš„ rust ç¯å¢ƒæ²¡äº†ï¼Œzsh çš„ history ä¹Ÿæ²¡æœ‰ä¿å­˜ã€‚ä¸è¿‡æäº¤çš„ä»£ç æ²¡ä¸¢ã€‚å†æ¬¡å®‰è£…ç¯å¢ƒã€‚</p>
<p>rustlings åšå®Œäº†ï¼Œå§‘ä¸”ç®—æ˜¯ä¸ªæœ‰ Rust åŸºç¡€çš„äººï¼ˆç¬‘ï¼‰ã€‚å‘ç° macro éƒ¨åˆ†ä¸æ˜¯å¾ˆç†Ÿã€‚</p>
<p>å¼€å¯ Rust Quizï¼Œä»Šå¤©åšäº†/ç¿»è¯‘åˆ°ç¬¬ 6 é“é¢˜ï¼Œé¢˜ç›®å¾ˆç»†ã€‚</p>
<blockquote>
<p>é¡ºä¾¿ç¿»ä¸€ä¸‹ï¼Œä¸º RustCN ä½œè´¡çŒ®ï¼Ÿ</p>
</blockquote>
<h3 id="1021"><a class="header" href="#1021">10.21</a></h3>
<p>ä»Šå¤©å¼€å§‹å­¦ä¹ ï¼Œé…ç½®å¹¶ç†Ÿæ‚‰äº† github classroom çš„ç¯å¢ƒï¼ŒçœŸä¸é”™ã€‚</p>
<p>rrustlings åšäº†äºŒåå‡ ä¸ªé¢˜ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç¼–è¯‘åŸç†"><a class="header" href="#ç¼–è¯‘åŸç†">ç¼–è¯‘åŸç†</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åƒåœ¾è½¯ä»¶"><a class="header" href="#åƒåœ¾è½¯ä»¶">åƒåœ¾è½¯ä»¶</a></h1>
<ul>
<li>æ•°æ®åº“è¿æ¥å·¥å…·</li>
<li><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8">git-credential-helper</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é“¾æ¥è„šæœ¬"><a class="header" href="#é“¾æ¥è„šæœ¬">é“¾æ¥è„šæœ¬</a></h1>
<h2 id="åˆ’åˆ†å†…å­˜"><a class="header" href="#åˆ’åˆ†å†…å­˜">åˆ’åˆ†å†…å­˜</a></h2>
<div style="break-before: page; page-break-before: always;"></div><h1 id="æ•°æ®åº“è®¾è®¡"><a class="header" href="#æ•°æ®åº“è®¾è®¡">æ•°æ®åº“è®¾è®¡</a></h1>
<h2 id="èšåˆå‡½æ•°"><a class="header" href="#èšåˆå‡½æ•°">èšåˆå‡½æ•°</a></h2>
<p>çŠ¶æ€</p>
<p>key ä¼˜åŒ–</p>
<p>å¼€æ”¾å¯»å€ï¼ˆæ²¡æœ‰é“¾è¡¨ï¼Œå†…å­˜è¿ç»­ï¼Œcache ä¼˜åŒ–ï¼ŒæŒ‡é’ˆè·³è½¬å°‘ï¼Œå‘é‡åŒ–ä¼˜åŒ–ï¼‰ï¼Œæ‹‰é“¾ï¼ˆkey å†²çªï¼‰</p>
<p>string çŸ­ä¸å¦‚ä¸å­˜å¼•ç”¨ string é•¿å°±ä¸æ–¹ä¾¿</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="draft"><a class="header" href="#draft">draft</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="computer_network"><a class="header" href="#computer_network">computer_network</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="computer_network-1"><a class="header" href="#computer_network-1">computer_network</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
