<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>原子操作与内存顺序 | Trdthg&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="logo.png">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.b52f6a3a.css" as="style"><link rel="preload" href="/assets/js/app.db3bc2f4.js" as="script"><link rel="preload" href="/assets/js/2.8e748a32.js" as="script"><link rel="preload" href="/assets/js/28.0ee308ff.js" as="script"><link rel="prefetch" href="/assets/js/10.1cd99fe5.js"><link rel="prefetch" href="/assets/js/11.04c41877.js"><link rel="prefetch" href="/assets/js/12.024f3e49.js"><link rel="prefetch" href="/assets/js/13.0464a7aa.js"><link rel="prefetch" href="/assets/js/14.717714ac.js"><link rel="prefetch" href="/assets/js/15.f609f486.js"><link rel="prefetch" href="/assets/js/16.df5ead6d.js"><link rel="prefetch" href="/assets/js/17.198224c3.js"><link rel="prefetch" href="/assets/js/18.d4e73e39.js"><link rel="prefetch" href="/assets/js/19.4895316d.js"><link rel="prefetch" href="/assets/js/20.2ec18c91.js"><link rel="prefetch" href="/assets/js/21.f1cfc916.js"><link rel="prefetch" href="/assets/js/22.603cd1b0.js"><link rel="prefetch" href="/assets/js/23.f9c16c3a.js"><link rel="prefetch" href="/assets/js/24.22757670.js"><link rel="prefetch" href="/assets/js/25.3de0e7ca.js"><link rel="prefetch" href="/assets/js/26.b4fa3f47.js"><link rel="prefetch" href="/assets/js/27.28561eb7.js"><link rel="prefetch" href="/assets/js/29.aa5f65b6.js"><link rel="prefetch" href="/assets/js/3.3ec313a7.js"><link rel="prefetch" href="/assets/js/30.01c5d56f.js"><link rel="prefetch" href="/assets/js/31.03a25f72.js"><link rel="prefetch" href="/assets/js/32.be0dc821.js"><link rel="prefetch" href="/assets/js/33.413a31f5.js"><link rel="prefetch" href="/assets/js/34.4b83ab1c.js"><link rel="prefetch" href="/assets/js/35.6511d364.js"><link rel="prefetch" href="/assets/js/36.3ff452ac.js"><link rel="prefetch" href="/assets/js/37.7e49428b.js"><link rel="prefetch" href="/assets/js/4.ef75752b.js"><link rel="prefetch" href="/assets/js/5.1d90f67d.js"><link rel="prefetch" href="/assets/js/6.5163448b.js"><link rel="prefetch" href="/assets/js/7.9a186dae.js"><link rel="prefetch" href="/assets/js/8.e550dfbf.js"><link rel="prefetch" href="/assets/js/9.ca89ae3f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b52f6a3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Trdthg's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/java.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/js/vue.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/python/python.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/wasm.html" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/magic/haskell.html" class="nav-link">
  魔法
</a></div><div class="nav-item"><a href="/ioclub/oauth2.html" class="nav-link">
  IO Club
</a></div><div class="nav-item"><a href="/other/other.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/trdthg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/java.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/js/vue.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/python/python.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/wasm.html" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/magic/haskell.html" class="nav-link">
  魔法
</a></div><div class="nav-item"><a href="/ioclub/oauth2.html" class="nav-link">
  IO Club
</a></div><div class="nav-item"><a href="/other/other.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/trdthg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/magic/memory_ordering.html" aria-current="page" class="active sidebar-link">原子操作与内存顺序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#程序运行问题" class="sidebar-link">程序运行问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_1-编译器重排" class="sidebar-link">1. 编译器重排</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_2-指令重排" class="sidebar-link">2.指令重排</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_3-cpu-cache" class="sidebar-link">3. CPU Cache</a></li></ul></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#术语" class="sidebar-link">术语</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_1-happens-before" class="sidebar-link">1. happens-before</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_2-sequenced-before" class="sidebar-link">2. sequenced-before</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_3-synchronized-with" class="sidebar-link">3. synchronized-with</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_4-inter-thread" class="sidebar-link">4. inter-thread</a></li></ul></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#内存顺序" class="sidebar-link">内存顺序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_1-relaxed" class="sidebar-link">1. Relaxed</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_2-acquire-release" class="sidebar-link">2. Acquire-Release</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_3-sequence" class="sidebar-link">3. Sequence</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_4-fence" class="sidebar-link">4. Fence</a></li></ul></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#其他" class="sidebar-link">其他</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_1-tips" class="sidebar-link">1. Tips</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_2-atomic能替代锁吗" class="sidebar-link">2. Atomic能替代锁吗?</a></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#_3-atomic的应用场景" class="sidebar-link">3. Atomic的应用场景</a></li></ul></li><li class="sidebar-sub-header"><a href="/magic/memory_ordering.html#引用" class="sidebar-link">引用</a></li></ul></li><li><a href="/magic/fd.html" class="sidebar-link">文件系统</a></li><li><a href="/magic/haskell.html" class="sidebar-link">Haskell 学习</a></li><li><a href="/magic/docker.html" class="sidebar-link">Docker</a></li><li><a href="/magic/linuxIO.html" class="sidebar-link">Linux IO 多路复用</a></li><li><a href="/magic/vim.html" class="sidebar-link">vim</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="原子操作与内存顺序"><a href="#原子操作与内存顺序" class="header-anchor">#</a> 原子操作与内存顺序</h1> <p>原子操作能够用来实现无🔓并发</p> <h2 id="程序运行问题"><a href="#程序运行问题" class="header-anchor">#</a> 程序运行问题</h2> <p>下面列举了影响代码执行顺序的诸多原因</p> <h3 id="_1-编译器重排"><a href="#_1-编译器重排" class="header-anchor">#</a> 1. 编译器重排</h3> <p>编译器会尽可能优化代码，在单线程下一般不会出现问题</p> <div class="language-js extra-class"><pre class="language-js"><code>x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码可能被优化为下面的样子</p> <div class="language-py extra-class"><pre class="language-py"><code>x <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
</code></pre></div><p>但是在多线程下可能会有问题</p> <h3 id="_2-指令重排"><a href="#_2-指令重排" class="header-anchor">#</a> 2.指令重排</h3> <p>类似于上面的，下面的代码中y = 200可能会先于x = 100执行，打印出的x可能是0或100
例1:</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>    <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// global variable</span>
    <span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>     <span class="token comment">// global variable</span>

    Thread<span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>           Thread<span class="token operator">-</span><span class="token number">2</span><span class="token operator">:</span>
    x <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>y <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    y <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> x<span class="token punctuation">;</span>
</code></pre></div><p>例2:</p> <div class="language-rust extra-class"><pre class="language-rust"><code>初始状态<span class="token punctuation">:</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token number">1</span>
线程<span class="token number">1</span>        线程<span class="token number">2</span>
y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          y <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre></div><p>这段程序实际上有两种可能的结果：</p> <ul><li>y = 3：线程 2 在线程 1 完成之前检查了 x 的值</li> <li>y = 6：线程 2 在线程 1 完成之后检查了 x 的值</li> <li>y = 2：线程 2 看到了 x = 1，但是没看到 y = 3，接下来用计算结果覆盖了 y = 3</li></ul> <h3 id="_3-cpu-cache"><a href="#_3-cpu-cache" class="header-anchor">#</a> 3. CPU Cache</h3> <p>由于一次复制操作涉及到 move(内存 -&gt; 寄存器) add mov(寄存器 -&gt; 内存)三条汇编指令，在add操作完成后，数据还没有被拷贝到内存时，另一个线程可能读取到此时还没有被修改的数据，或者是两个线程同时修改，结果某一个线程修改的结果被另一个线程覆盖</p> <h2 id="术语"><a href="#术语" class="header-anchor">#</a> 术语</h2> <p>下列术语定义了多线程和单线程中各个变量操作之间的关系
这些关系只是我们期望的，想要确保下面的关系在活动中是正常的，就需要内存顺序了</p> <h3 id="_1-happens-before"><a href="#_1-happens-before" class="header-anchor">#</a> <strong>1. happens-before</strong></h3> <p>先于，或者说B能看到A操作的结果，AB分别在两个线程里</p> <h3 id="_2-sequenced-before"><a href="#_2-sequenced-before" class="header-anchor">#</a> 2. sequenced-before</h3> <p>同上A,B在一个线程内</p> <h3 id="_3-synchronized-with"><a href="#_3-synchronized-with" class="header-anchor">#</a> <strong>3. synchronized-with</strong></h3> <p>x是支持原子操作的变量
A写入(store)x，B读取(load)x，分别在两个线程内，则A((store)就是synchornized-with B(load)的</p> <h3 id="_4-inter-thread"><a href="#_4-inter-thread" class="header-anchor">#</a> 4. inter-thread</h3> <p>跨线程
第三点说到 A：store synchornized-with B: load
那么A happens-before B
多线程中写入先于读取</p> <h2 id="内存顺序"><a href="#内存顺序" class="header-anchor">#</a> 内存顺序</h2> <h3 id="_1-relaxed"><a href="#_1-relaxed" class="header-anchor">#</a> 1. Relaxed</h3> <p>只保证在同一个线程中满足Happens-before，这是最宽松的规则，他对编译器和CPU不做任何限制，可以乱需，因此下面的例子不保证会成功</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span><span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-acquire-release"><a href="#_2-acquire-release" class="header-anchor">#</a> 2. Acquire-Release</h3> <p><strong>Release 释放</strong> ，设定内存屏障(Memory barrier)，保证它之前的操作永远在它之前，但是它后面的操作可能被重排到它前面
<strong>Acquire 获取</strong> , 设定内存屏障，保证在它之后的访问永远在它之后，但是它之前的操作却有可能被重排到它后面，往往和 <code>Release</code>在不同线程中联合使用
<strong>AcqRel</strong>: Acquire和Release的结合，同时拥有它们俩提供的保证。比如你要对一个 atomic 自增 1，同时希望该操作之前和之后的读取或写入操作不会被重新排序</p> <p>这两个操作通常成对使用，对store使用Release，对load使用Acquire
先后顺序具体看下面的代码</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span><span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-sequence"><a href="#_3-sequence" class="header-anchor">#</a> 3. Sequence</h3> <p>顺序一致性，强制所有线程看到一致的原子操作，完全的分界点，SeqCst就像是AcqRel的加强版，它不管原子操作是属于读取还是写入的操作，只要某个线程有用到SeqCst的原子操作，线程中该SeqCst操作前的数据操作绝对不会被重新排在该SeqCst操作之后，且该SeqCst操作后的数据操作也绝对不会被重新排在SeqCst操作前。
下面的例子，只有使用 SeqCst ordering，才能保证 Z 最后的值不为 0</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">write_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 1</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">write_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// 3</span>
        <span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// 4</span>
        <span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">write_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">write_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t3 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">read_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t4 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t3<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t4<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span><span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-fence"><a href="#_4-fence" class="header-anchor">#</a> 4. Fence</h3> <p>fence是支持synchornized-with的另一种方式, 可以和Acquire-Release对比一下</p> <p>例1：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span>
            <span class="token constant">DATA</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>                                 <span class="token comment">// A</span>
        <span class="token punctuation">}</span>
        <span class="token constant">READY</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// B: 内存屏障 ↑</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">JoinHandle</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span><span class="token constant">READY</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>         <span class="token comment">// C: 内存屏障 ↓</span>

        <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token constant">DATA</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// D</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>例2：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
    <span class="token function">fence</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 2</span>
    <span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token operator">!</span><span class="token class-name">Y</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment">// 4</span>
    <span class="token function">fence</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 5</span>
    <span class="token keyword">if</span> <span class="token class-name">X</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// 6</span>
        <span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">write_x_then_y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token function">read_y_then_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token macro property">assert_ne!</span><span class="token punctuation">(</span><span class="token class-name">Z</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://doc.rust-lang.org/std/sync/atomic/fn.fence.html" target="_blank" rel="noopener noreferrer">fence的官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
An atomic fence.
Depending on the specified order, a fence prevents the compiler and CPU from reordering certain types of memory operations around it. That creates synchronizes-with relationships between it and atomic operations or fences in other threads.</p> <p>A fence ‘A’ which has (at least) Release ordering semantics, synchronizes with a fence ‘B’ with (at least) Acquire semantics, if and only if there exist operations X and Y, both operating on some atomic object ‘M’ such that A is sequenced before X, Y is synchronized before B and Y observes the change to M. This provides a happens-before dependence between A and B.</p> <div class="language- extra-class"><pre class="language-text"><code>    Thread 1                                          Thread 2

fence(Release);      A --------------
x.store(3, Relaxed); X ---------    |
                               |    |
                               |    |
                               -------------&gt; Y  if x.load(Relaxed) == 3 {
                                    |-------&gt; B      fence(Acquire);
                                                     ...
                                                 }
</code></pre></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="_1-tips"><a href="#_1-tips" class="header-anchor">#</a> 1. Tips</h3> <ul><li>不知道怎么选择时，优先使用SeqCst，虽然会稍微减慢速度，但是慢一点也比出现错误好</li> <li>多线程只计数fetch_add而不使用该值触发其他逻辑分支的简单使用场景，可以使用Relaxed
参考 <a href="https://stackoverflow.com/questions/30407121/which-stdsyncatomicordering-to-use" target="_blank" rel="noopener noreferrer">Which std::sync::atomic::Ordering to use?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>在多线程环境中要使用Atomic需要配合Arc</li></ul> <h3 id="_2-atomic能替代锁吗"><a href="#_2-atomic能替代锁吗" class="header-anchor">#</a> 2. Atomic能替代锁吗?</h3> <p>那么原子类型既然这么全能，它可以替代锁吗？答案是不行：</p> <ul><li>对于复杂的场景下，锁的使用简单粗暴，不容易有坑</li> <li>std::sync::atomic包中仅提供了数值类型的原子操作：AtomicBool, AtomicIsize, AtomicUsize, AtomicI8, AtomicU16等，而锁可以应用于各种类型</li> <li>在有些情况下，必须使用锁来配合，例如上一章节中使用Mutex配合Condvar</li></ul> <h3 id="_3-atomic的应用场景"><a href="#_3-atomic的应用场景" class="header-anchor">#</a> 3. Atomic的应用场景</h3> <p>事实上，Atomic虽然对于用户不太常用，但是对于高性能库的开发者、标准库开发者都非常常用，它是并发原语的基石，除此之外，还有一些场景适用：</p> <ul><li>无锁(lock free)数据结构</li> <li>全局变量，例如全局自增ID, 在后续章节会介绍</li> <li>跨线程计数器，例如可以用于统计指标</li></ul> <h2 id="引用"><a href="#引用" class="header-anchor">#</a> 引用</h2> <p><a href="https://www.jianshu.com/p/511cde6b62a6" target="_blank" rel="noopener noreferrer">Rust 并发编程 - Memory Ordering (siddontang
)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://www.zhihu.com/question/24301047" target="_blank" rel="noopener noreferrer">知乎<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="http://senlinzhan.github.io/2017/12/04/cpp-memory-order/" target="_blank" rel="noopener noreferrer">理解 C++ 的 Memory Order (Senlin's Blog)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://skyao.io/learning-rust/std/sync/atomic-type.html" target="_blank" rel="noopener noreferrer">Rust学习笔记<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://course.rs/advance/concurrency-with-threads/sync2.html" target="_blank" rel="noopener noreferrer">rust语言圣经<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://learnku.com/docs/nomicon/2018/83-atomic-operation/4742" target="_blank" rel="noopener noreferrer">Rust 高级编程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/magic/fd.html">
        文件系统
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.db3bc2f4.js" defer></script><script src="/assets/js/2.8e748a32.js" defer></script><script src="/assets/js/28.0ee308ff.js" defer></script>
  </body>
</html>
