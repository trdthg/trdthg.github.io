<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022217241.jpg"><title>Rust | Trdthg's blog</title><meta name="description" content="我的个人网站">
    <link rel="modulepreload" href="/assets/app.2196ae99.js"><link rel="modulepreload" href="/assets/rust.html.358571c0.js"><link rel="modulepreload" href="/assets/rust.html.e78a10d8.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.e8e8fc80.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">Trdthg&#39;s blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="学习笔记 📚"><span class="title">学习笔记 📚</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="学习笔记 📚"><span class="title">学习笔记 📚</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>前端相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/frontend/vdom" class="" aria-label="虚拟 DOM"><!--[--><!--]--> 虚拟 DOM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/js_advanced" class="" aria-label="Js 进阶"><!--[--><!--]--> Js 进阶 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/list" class="" aria-label="资料"><!--[--><!--]--> 资料 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/vue" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/http" class="" aria-label="HTTP 相关"><!--[--><!--]--> HTTP 相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/flutter" class="" aria-label="Flutter"><!--[--><!--]--> Flutter <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Python 相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/other/python" class="" aria-label="总览"><!--[--><!--]--> 总览 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java 相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/java/java" class="" aria-label="基础知识"><!--[--><!--]--> 基础知识 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/sourceread" class="" aria-label="部分源码"><!--[--><!--]--> 部分源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/spring" class="" aria-label="Spring 框架"><!--[--><!--]--> Spring 框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/springboot" class="" aria-label="常用工具"><!--[--><!--]--> 常用工具 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="小玩具 🎮"><span class="title">小玩具 🎮</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="小玩具 🎮"><span class="title">小玩具 🎮</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projects/mini_vue" class="" aria-label="Mini-Vue"><!--[--><!--]--> Mini-Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_bundle" class="" aria-label="打包器"><!--[--><!--]--> 打包器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_tokio" class="" aria-label="异步运行时"><!--[--><!--]--> 异步运行时 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Rust 🦀"><span class="title">Rust 🦀</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Rust 🦀"><span class="title">Rust 🦀</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/rust/rust" class="router-link-active" aria-label="语言特性"><!--[--><!--]--> 语言特性 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/wasm" class="" aria-label="Wasm"><!--[--><!--]--> Wasm <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/lists" class="" aria-label="Rust 链表"><!--[--><!--]--> Rust 链表 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/go" class="" aria-label="Go 学习笔记"><!--[--><!--]--> Go 学习笔记 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="魔法 🔮"><span class="title">魔法 🔮</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="魔法 🔮"><span class="title">魔法 🔮</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/magic/haskell" class="" aria-label="Haskell 学习笔记"><!--[--><!--]--> Haskell 学习笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/fd" class="" aria-label="文件描述符"><!--[--><!--]--> 文件描述符 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/linuxIO" class="" aria-label="IO 多路复用"><!--[--><!--]--> IO 多路复用 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/memory_ordering" class="" aria-label="原子操作/内存顺序"><!--[--><!--]--> 原子操作/内存顺序 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/async" class="" aria-label="协程异步思考"><!--[--><!--]--> 协程异步思考 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/software_arch" class="" aria-label="软件架构"><!--[--><!--]--> 软件架构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/cicd" class="" aria-label="CI/CD"><!--[--><!--]--> CI/CD <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="IO Club ⚽"><span class="title">IO Club ⚽</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="IO Club ⚽"><span class="title">IO Club ⚽</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>分享</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/share_1" class="" aria-label="关于数据库与 B+ 树"><!--[--><!--]--> 关于数据库与 B+ 树 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>授课</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_1" class="" aria-label="后端 1"><!--[--><!--]--> 后端 1 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_2" class="" aria-label="后端 2"><!--[--><!--]--> 后端 2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_3" class="" aria-label="后端 3"><!--[--><!--]--> 后端 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_4" class="" aria-label="后端 4"><!--[--><!--]--> 后端 4 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其他 📦"><span class="title">其他 📦</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其他 📦"><span class="title">其他 📦</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/other/hadoop" class="" aria-label="大数据"><!--[--><!--]--> 大数据 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/script" class="" aria-label="脚本"><!--[--><!--]--> 脚本 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/datastructure" class="" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/vim" class="" aria-label="Vim"><!--[--><!--]--> Vim <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/git" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/docker" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/analyze" class="" aria-label="性能监测工具"><!--[--><!--]--> 性能监测工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oci" class="" aria-label="OCI 规范"><!--[--><!--]--> OCI 规范 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oauth2" class="" aria-label="OAuth2.0"><!--[--><!--]--> OAuth2.0 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/article" class="" aria-label="文章翻译"><!--[--><!--]--> 文章翻译 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/trdthg" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="切换夜间"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="学习笔记 📚"><span class="title">学习笔记 📚</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="学习笔记 📚"><span class="title">学习笔记 📚</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>前端相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/frontend/vdom" class="" aria-label="虚拟 DOM"><!--[--><!--]--> 虚拟 DOM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/js_advanced" class="" aria-label="Js 进阶"><!--[--><!--]--> Js 进阶 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/list" class="" aria-label="资料"><!--[--><!--]--> 资料 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/vue" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/http" class="" aria-label="HTTP 相关"><!--[--><!--]--> HTTP 相关 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/flutter" class="" aria-label="Flutter"><!--[--><!--]--> Flutter <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Python 相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/other/python" class="" aria-label="总览"><!--[--><!--]--> 总览 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java 相关</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/java/java" class="" aria-label="基础知识"><!--[--><!--]--> 基础知识 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/sourceread" class="" aria-label="部分源码"><!--[--><!--]--> 部分源码 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/spring" class="" aria-label="Spring 框架"><!--[--><!--]--> Spring 框架 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/springboot" class="" aria-label="常用工具"><!--[--><!--]--> 常用工具 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="小玩具 🎮"><span class="title">小玩具 🎮</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="小玩具 🎮"><span class="title">小玩具 🎮</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projects/mini_vue" class="" aria-label="Mini-Vue"><!--[--><!--]--> Mini-Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_bundle" class="" aria-label="打包器"><!--[--><!--]--> 打包器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_tokio" class="" aria-label="异步运行时"><!--[--><!--]--> 异步运行时 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Rust 🦀"><span class="title">Rust 🦀</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Rust 🦀"><span class="title">Rust 🦀</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/rust/rust" class="router-link-active" aria-label="语言特性"><!--[--><!--]--> 语言特性 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/wasm" class="" aria-label="Wasm"><!--[--><!--]--> Wasm <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/lists" class="" aria-label="Rust 链表"><!--[--><!--]--> Rust 链表 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/go" class="" aria-label="Go 学习笔记"><!--[--><!--]--> Go 学习笔记 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="魔法 🔮"><span class="title">魔法 🔮</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="魔法 🔮"><span class="title">魔法 🔮</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/magic/haskell" class="" aria-label="Haskell 学习笔记"><!--[--><!--]--> Haskell 学习笔记 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/fd" class="" aria-label="文件描述符"><!--[--><!--]--> 文件描述符 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/linuxIO" class="" aria-label="IO 多路复用"><!--[--><!--]--> IO 多路复用 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/memory_ordering" class="" aria-label="原子操作/内存顺序"><!--[--><!--]--> 原子操作/内存顺序 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/async" class="" aria-label="协程异步思考"><!--[--><!--]--> 协程异步思考 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/software_arch" class="" aria-label="软件架构"><!--[--><!--]--> 软件架构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/cicd" class="" aria-label="CI/CD"><!--[--><!--]--> CI/CD <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="IO Club ⚽"><span class="title">IO Club ⚽</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="IO Club ⚽"><span class="title">IO Club ⚽</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>分享</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/share_1" class="" aria-label="关于数据库与 B+ 树"><!--[--><!--]--> 关于数据库与 B+ 树 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>授课</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_1" class="" aria-label="后端 1"><!--[--><!--]--> 后端 1 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_2" class="" aria-label="后端 2"><!--[--><!--]--> 后端 2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_3" class="" aria-label="后端 3"><!--[--><!--]--> 后端 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_4" class="" aria-label="后端 4"><!--[--><!--]--> 后端 4 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其他 📦"><span class="title">其他 📦</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其他 📦"><span class="title">其他 📦</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/other/hadoop" class="" aria-label="大数据"><!--[--><!--]--> 大数据 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/script" class="" aria-label="脚本"><!--[--><!--]--> 脚本 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/datastructure" class="" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/vim" class="" aria-label="Vim"><!--[--><!--]--> Vim <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/git" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/docker" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/analyze" class="" aria-label="性能监测工具"><!--[--><!--]--> 性能监测工具 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oci" class="" aria-label="OCI 规范"><!--[--><!--]--> OCI 规范 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oauth2" class="" aria-label="OAuth2.0"><!--[--><!--]--> OAuth2.0 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/article" class="" aria-label="文章翻译"><!--[--><!--]--> 文章翻译 <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/trdthg" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Rust <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_1-生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. 生命周期"><!--[--><!--]--> 1. 生命周期 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#自动处理生命周期" class="router-link-active router-link-exact-active sidebar-item" aria-label="自动处理生命周期"><!--[--><!--]--> 自动处理生命周期 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_2-智能指针" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. 智能指针"><!--[--><!--]--> 2. 智能指针 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#基本概念" class="router-link-active router-link-exact-active sidebar-item" aria-label="基本概念"><!--[--><!--]--> 基本概念 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#简单实现" class="router-link-active router-link-exact-active sidebar-item" aria-label="简单实现"><!--[--><!--]--> 简单实现 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#自动解引用的时机" class="router-link-active router-link-exact-active sidebar-item" aria-label="自动解引用的时机"><!--[--><!--]--> 自动解引用的时机 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#自动管理内存" class="router-link-active router-link-exact-active sidebar-item" aria-label="自动管理内存"><!--[--><!--]--> 自动管理内存 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_2-atomic-在-rust-中的实践" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. Atomic 在 rust 中的实践"><!--[--><!--]--> 2. Atomic 在 rust 中的实践 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#使用-atomic-实现简单的-mutex" class="router-link-active router-link-exact-active sidebar-item" aria-label="使用 Atomic 实现简单的 Mutex"><!--[--><!--]--> 使用 Atomic 实现简单的 Mutex <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#acquire-与-release" class="router-link-active router-link-exact-active sidebar-item" aria-label="Acquire 与 Release"><!--[--><!--]--> Acquire 与 Release <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#必需用-seq-的场景" class="router-link-active router-link-exact-active sidebar-item" aria-label="必需用 Seq 的场景"><!--[--><!--]--> 必需用 Seq 的场景 <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_3-常用-trait" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. 常用 Trait"><!--[--><!--]--> 3. 常用 Trait <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_3-1-read" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1 Read"><!--[--><!--]--> 3.1 Read <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_3-2-write" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2 Write"><!--[--><!--]--> 3.2 Write <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_3-3-seek-bufreader-bufwriter" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3 Seek &amp; BufReader &amp; BufWriter"><!--[--><!--]--> 3.3 Seek &amp; BufReader &amp; BufWriter <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_4-其他" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. 其他"><!--[--><!--]--> 4. 其他 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_2-rc-arc" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. Rc &amp; Arc"><!--[--><!--]--> 2. Rc &amp; Arc <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_4-cell-refcell" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. Cell &amp; RefCell"><!--[--><!--]--> 4. Cell &amp; RefCell <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_5-ref-refmut" class="router-link-active router-link-exact-active sidebar-item" aria-label="5. Ref &amp; RefMut"><!--[--><!--]--> 5. Ref &amp; RefMut <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="rust" tabindex="-1"><a class="header-anchor" href="#rust" aria-hidden="true">#</a> Rust</h1><h2 id="_1-生命周期" tabindex="-1"><a class="header-anchor" href="#_1-生命周期" aria-hidden="true">#</a> 1. 生命周期</h2><h3 id="自动处理生命周期" tabindex="-1"><a class="header-anchor" href="#自动处理生命周期" aria-hidden="true">#</a> 自动处理生命周期</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// Only one reference in input, so the output must be derived from that input</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">B</span><span class="token punctuation">;</span>

<span class="token comment">// Many inputs, assume they&#39;re all independent</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;b</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;c</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;b</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;c</span> <span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Methods, assume all output lifetimes are derived from `self`</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">D</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;b</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;c</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;b</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;c</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">D</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_2-智能指针" tabindex="-1"><a class="header-anchor" href="#_2-智能指针" aria-hidden="true">#</a> 2. 智能指针</h2><h3 id="基本概念" tabindex="-1"><a class="header-anchor" href="#基本概念" aria-hidden="true">#</a> 基本概念</h3><p>实现了 Deref Trait 和 Drop Trait 的就是智能指针</p><ol><li>Deref Trait: 具有指针语义</li><li>Drop Trait：拥有内存自动管理的机制</li></ol><p>看一眼 Box 的实现</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[stable(feature = <span class="token string">&quot;rust1&quot;</span>, since = <span class="token string">&quot;1.0.0&quot;</span>)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">Allocator</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token keyword">self</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="简单实现" tabindex="-1"><a class="header-anchor" href="#简单实现" aria-hidden="true">#</a> 简单实现</h3><p>我们实现一个智能指针（只实现了 Deref Trait）</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">MySmartPointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用*x 其实就是调用 *x.deref()</span>
<span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">MySmartPointer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="自动解引用的时机" tabindex="-1"><a class="header-anchor" href="#自动解引用的时机" aria-hidden="true">#</a> 自动解引用的时机</h3><ul><li><p>遇到*运算符自动接引用</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>遇到 . 运算符接引用调用方法</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>参数传递自动解引用</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;aaaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">take_str</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">take_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[stable(feature = <span class="token string">&quot;rust1&quot;</span>, since = <span class="token string">&quot;1.0.0&quot;</span>)]</span>
<span class="token keyword">impl</span> <span class="token namespace">ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">str</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vec<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul><h3 id="自动管理内存" tabindex="-1"><a class="header-anchor" href="#自动管理内存" aria-hidden="true">#</a> 自动管理内存</h3><p>自动化管理内存 (drop，作用域外自动释放内存)</p><h2 id="_2-atomic-在-rust-中的实践" tabindex="-1"><a class="header-anchor" href="#_2-atomic-在-rust-中的实践" aria-hidden="true">#</a> 2. Atomic 在 rust 中的实践</h2><p><a href="https://www.youtube.com/watch?v=rMGWeSjctlY" target="_blank" rel="noopener noreferrer">Crust of Rust: Atomics and Memory Ordering<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="使用-atomic-实现简单的-mutex" tabindex="-1"><a class="header-anchor" href="#使用-atomic-实现简单的-mutex" aria-hidden="true">#</a> 使用 Atomic 实现简单的 Mutex</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AtomicBool</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> spawn<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">cell<span class="token punctuation">::</span></span><span class="token class-name">UnsafeCell</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">UNLOCKED</span><span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">LOCKED</span><span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    locked<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">,</span>
    v<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Sync</span> <span class="token keyword">for</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            locked<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            v<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// 暴露一个可变引用出去</span>
    <span class="token comment">///</span>
    <span class="token comment">/// 当线程 A 和线程 B 同时执行时，A，B 可能同时拿到🔓，并同时上锁，这两个线程并没有`看到`对方页拿到了锁</span>
    <span class="token comment">/// 所以就出先了， 线程 A 和 B 同时从寄存器拿到值 1，改为了 2，然后复制到寄存器内，后修改的会覆盖前一次修改</span>
    <span class="token comment">/// 为了解决上述问题，下面是一些解决方法</span>
    <span class="token comment">///</span>
    <span class="token comment">/// 方案 1，使用`compare_exchange`合并加锁上锁过程</span>
    <span class="token comment">/// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span>
    <span class="token comment">///</span>
    <span class="token comment">/// #1 compare_exchange 是低效的，如果是多核都在同时争夺锁，8 个核中有一个和先拿到了锁</span>
    <span class="token comment">/// 那么剩下的 7 个核依然会互相竞争，这个变量的内存就会在多个核中不断拷贝</span>
    <span class="token comment">/// #2 相比于 mutex，mutex 拿不到锁就会阻塞线程，而 compare_exchange 拿不到就会返回一个 Err</span>
    <span class="token comment">/// #3 rust 中还提供了 compare_and_exchange_weak，最大的区别是</span>
    <span class="token comment">///     compare_and_exchange 只允许在判断 Current v alue 和传入的值不一样时返回 Err</span>
    <span class="token comment">///     compare_and_exchange_weak 即使在一样的时候也可能会返回 Err，这种细小的差别能够用于某些场景，让性能更好</span>
    <span class="token comment">///     原因是由于在不同平台上的实现不同</span>
    <span class="token comment">///         x86: compare_and_swap</span>
    <span class="token comment">///         ARM: LDREX STREX</span>
    <span class="token comment">///     在 x86 上 weak 与普通的相同，</span>
    <span class="token comment">///     在 ARM 上：</span>
    <span class="token comment">///         compare_and_exchange: impl using a loop of LDREX and STREX</span>
    <span class="token comment">///         compare_and_exchange_weak: LDREX and STREX with no loop, it may be fake</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_lock</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span> <span class="token punctuation">{</span>
        <span class="token comment">// 拿🔓 上🔓</span>
        <span class="token comment">// while self.locked.load(Ordering::Relaxed) != UNLOCKED {}</span>
        <span class="token comment">// self.locked.store(LOCKED, Ordering::Relaxed);</span>

        <span class="token comment">// 方案 1</span>
        <span class="token comment">// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span>

        <span class="token comment">// 方案 2 在 arm 下有更好的性能</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token constant">LOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 假如现在 current value 就是 UNLOCKED 状态，已经修改为 LOCKED 状态，那么就已经拿到了所有权</span>
            <span class="token comment">// 加入现在还没有修改完成，current value 依然是 UNLOCKED 状态，当前线程就会卡住，直到有别的线程成功拿到了所有权</span>
            <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOCKED</span> <span class="token punctuation">{</span>
                <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 暴露数据</span>
        <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解🔓</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> l<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handles<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1000</span> <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span><span class="token function">with_lock</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>v <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> handle <span class="token keyword">in</span> handles <span class="token punctuation">{</span>
        handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里依然会报错</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">with_lock</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h3 id="acquire-与-release" tabindex="-1"><a class="header-anchor" href="#acquire-与-release" aria-hidden="true">#</a> Acquire 与 Release</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// 但是即使用了上面的东西也有可能会出问题，虽然在 X86 64 位系统上没有出现问题，这是因为他不支持！，他只支持 Seq 的，不过还是要说明问题</span>
<span class="token comment">/// 因为下面对变量 v 的修改和上锁释放锁的过程毫不相关，</span>
<span class="token comment">/// 所以下一行可能被重新排列在加锁之前，或者解锁之后，这两种都是不允许的，但是 cpu 和编译器就可能这样做</span>
<span class="token comment">///</span>
<span class="token comment">/// 对此需要使用 Acquire 和 Release</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_lock2</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span> <span class="token punctuation">{</span>
    <span class="token comment">// 任何之后的读写操作不会被重排到 Acquire 之前</span>
    <span class="token comment">// 别的线程中的写操作，对于这里的 Acquire 都是可见的</span>
    <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token constant">LOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOCKED</span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 任何之前的读写操作不会被重排到 Release 之后</span>
    <span class="token comment">// 这个线程里的所有写操作对别的线程中的 Acquire 都是可见的</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="必需用-seq-的场景" tabindex="-1"><a class="header-anchor" href="#必需用-seq-的场景" aria-hidden="true">#</a> 必需用 Seq 的场景</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">seq_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fetch_add always succeed</span>

    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> z<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tx <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// ！！！</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ty <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            z<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token comment">// 这行和下面一行可能重排 (或者说不是重排，单纯时可见性的问题，下面的 x 就是看到了 x 是 false)</span>
        <span class="token keyword">if</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                         <span class="token comment">// ！！！ x 为 false，当 x 被修改为 true 后，也不会发生改变</span>
            z<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// What are the possibles for z?</span>
    <span class="token comment">// - is 0 possibly ?</span>
    <span class="token comment">//   经过判断，至少有下面的条件</span>
    <span class="token comment">//     t1 must run after tx</span>
    <span class="token comment">//     t2 must run after ty</span>
    <span class="token comment">//   几种排列组合应该是 1 或 2，没有 0</span>
    <span class="token comment">//   但是 0 还是可能的，</span>
    <span class="token comment">//           t2    t1,t2</span>
    <span class="token comment">//   MO(x)  false  true</span>
    <span class="token comment">//           t1    t1,t2</span>
    <span class="token comment">//   MO(y)  false  true</span>
    <span class="token comment">// - is 1 possibly ?</span>
    <span class="token comment">//   Yes: tx -&gt; t1 -&gt; ty -&gt; t2</span>
    <span class="token comment">// - is 2 possibly ?</span>
    <span class="token comment">//   Yes: tx -&gt; ty -&gt; t1 -&gt; t2</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="_3-常用-trait" tabindex="-1"><a class="header-anchor" href="#_3-常用-trait" aria-hidden="true">#</a> 3. 常用 Trait</h2><h3 id="_3-1-read" tabindex="-1"><a class="header-anchor" href="#_3-1-read" aria-hidden="true">#</a> 3.1 Read</h3><p>Read Trait 的功能是：从数据源拉取 (Pull) 一定数据到指定的缓冲区，返回读取的字节数。</p><p><strong>关于阻塞：</strong> read 函数不保证 Read 是否会处于阻塞状态，如果一个 read 过程阻塞了而且等待失败，那他就会返回一个 [<code>Err</code>] 标记。</p><p><strong>关于返回值：</strong> 如果<code>read()</code>返回的是 [<code>OK(n)</code>] , 它的实现就必须保证<code>0 &lt;- n &lt; buf.len()</code>。 如果<code>n == 0</code>，那可能有两种情况：</p><ol><li>reader 已经到达了<code>the end of file</code>，而且这个<code>file</code>可能不会在产生新数据。 注意，这里只是 likely，比如：在 linux 系统中，read 可能对一个 [<code>TcpStream</code>] 调用了<code>recv</code>系统调用，0 代表这个连接已经被成功关闭，如果是对 [<code>File</code>] , 那就可能意味着确实读取到了文件的末尾，但是如果有更多的数据被追加 (append) 到文件末尾，那么未来的 read 操作依然能够正常返回被追加的数据</li><li>缓冲区 (buffer) 大小确实就是 0</li></ol><p><code>n</code> 只要小于缓冲区的长度一般就不是个错误，即使文件还没有被读取完，这种情况可能会发生在，当前只有一部分数据是可用的，或者是 read 操作被一个信号打断了</p><p><strong>关于安全性：</strong></p><ul><li><p>因为实现这个 Trait 是安全的，调用者不能用 <code>n &lt; buf.len()</code> 去确保安全，使用 unsafe 是更要小心确保诸如越界问题是否会发生。</p></li><li><p>read 不保证 buf 里的数据是对的，所以不推荐读取缓冲区里的数据，只推荐向缓冲区里写入数据</p></li><li><p>相应的，调用者不能有任何假设，这个 buf 会被 read 怎么使用，read 函数也可能会从中读取内容。所以我们需要保证在调用 read 前，这个 buf 已经被初始化过了，调用没有被初始化的 buf 是不安全的，可能会导致未定义的行为</p></li></ul><p>*<strong>关于错误：</strong> 如果遇到了 Error，那就必须保证没有读取过任何字节，如果遇到了<code>ErrorKind::Interrupted</code>，而且不能作别的事时， 读取过程就必须被回滚</p><p>下面是一个来自 doc 的例子</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// read up to 10 bytes</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The bytes: {:?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-write" tabindex="-1"><a class="header-anchor" href="#_3-2-write" aria-hidden="true">#</a> 3.2 Write</h3><p>Write 的基本功能就是向 writer 中写入一段 buf，返回写入的字节数 <strong>关于阻塞：</strong> write 会尝试向 writer 中写入整个 buf 里的内容，但是写入可能不成功，或者写入时产生了一个错误，调用一次 write 意味着最多一次尝试写入 write 函数同样不保证 Write 是否处于阻塞状态以等待数据被写入，如果一次写入阻塞了，他可能会返回一个 [<code>Err</code>]。</p><p><strong>关于返回值：</strong> 如果<code>write()</code>返回的是 [<code>OK(n)</code>] , 它的实现就必须保证<code>0 &lt;- n &lt; buf.len()</code>。 如果<code>n == 0</code>，那可能有两种情况：</p><ol><li>被写入的东西已经不会接受新数据了，之后也不一定会</li><li>缓冲区 (buffer) 大小确实就是 0</li></ol><p><code>n</code> 只要小于缓冲区的长度一般就不是个错误，即使文件还没有被读取完，这种情况可能会发生在，当前只有一部分数据是可用的，或者是 read 操作被一个信号打断了</p><p>*<strong>关于错误：</strong> 如果遇到了 Error，那就必须保证没有任何字节被成功写入 返回值小于 buf 的长度不被当成是错误 如果遇到了<code>ErrorKind::Interrupted</code>，而且不能作别的事时，写入过程就必须被回滚</p><p>同样是官方的 demo</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// Writes some prefix of the byte string, not necessarily all of it.</span>
    buffer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">b&quot;some bytes&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-3-seek-bufreader-bufwriter" tabindex="-1"><a class="header-anchor" href="#_3-3-seek-bufreader-bufwriter" aria-hidden="true">#</a> 3.3 Seek &amp; BufReader &amp; BufWriter</h3><p>[<code>Read</code>] 和 [<code>Write</code>] 是最重要的两个 Trait，除此之外还有两个重要的 Trait[<code>Seek</code>] 和 [<code>BufRead</code>], 这两个都建立在 reader 只上，用来控制 read 的过程。</p><p>[<code>Seek</code>] 让你控制下一个字节将要读取的来自哪里</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">SeekFrom</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// skip to the last 10 bytes of the file</span>
    f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token class-name">SeekFrom</span><span class="token punctuation">::</span><span class="token class-name">End</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// read up to 10 bytes</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The bytes: {:?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>基于 byte 的接口性能不佳，所以提供了很多基于 buffer 的接口 [<code>BufRead</code>] 就提供了更多 Read 相关的 API</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> reader <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// read a line into buffer</span>
reader<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>[<code>BufWriter</code>] 没有提供更多写入的方法，他只是缓冲了每次调用</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> writer <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// write a byte to the buffer</span>
    writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">// the buffer is flushed once writer goes out of scope</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-其他" tabindex="-1"><a class="header-anchor" href="#_4-其他" aria-hidden="true">#</a> 4. 其他</h2><h3 id="_2-rc-arc" tabindex="-1"><a class="header-anchor" href="#_2-rc-arc" aria-hidden="true">#</a> 2. Rc &amp; Arc</h3><h4 id="介绍" tabindex="-1"><a class="header-anchor" href="#介绍" aria-hidden="true">#</a> 介绍</h4><blockquote><p>The key to our design is the RefCell type. The heart of RefCell is a pair of methods:</p></blockquote><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">borrow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">borrow_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RefMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>Introducing inherited mutability roots to shared types Shared smart pointer types, including Rc and Arc, provide containers that can be cloned and shared between multiple parties. Because the contained values may be multiply-aliased, they can only be borrowed as shared references, not mutable references. Without cells it would be impossible to mutate data inside of shared boxes at all!</p></blockquote><blockquote><p>It&#39;s very common then to put a RefCell inside shared pointer types to reintroduce mutability:</p></blockquote><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shared_map<span class="token punctuation">:</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;africa&quot;</span><span class="token punctuation">,</span> <span class="token number">92388</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;kyoto&quot;</span><span class="token punctuation">,</span> <span class="token number">11837</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;piccadilly&quot;</span><span class="token punctuation">,</span> <span class="token number">11826</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;marbles&quot;</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>Note that this example uses Rc and not Arc. RefCells are for single-threaded scenarios. Consider using Mutex if you need shared mutability in a multi-threaded situation</p></blockquote><h4 id="try-unwrap" tabindex="-1"><a class="header-anchor" href="#try-unwrap" aria-hidden="true">#</a> try_unwrap()</h4><blockquote><p>Get T from Rc&lt;T&gt; try to use <code>try_unwrap()</code>, which moves out the contents of an Rc if its refcount is 1 ::: warning unwrap on Result requires that you can debug-print the error case. RefCell only implements Debug if T does. Node doesn&#39;t implement Debug. try: Rc::try_unwrap(old_head).ok().unwrap().into_inner().elem :::</p></blockquote><h3 id="_4-cell-refcell" tabindex="-1"><a class="header-anchor" href="#_4-cell-refcell" aria-hidden="true">#</a> 4. Cell &amp; RefCell</h3><blockquote><p>Shareable mutable containers.</p><p>Values of the Cell and RefCell types may be mutated through shared references (i.e. the common &amp;T type), whereas most Rust types can only be mutated through unique (&amp;mut T) references. We say that Cell and RefCell provide &#39;interior mutability&#39;, in contrast with typical Rust types that exhibit &#39;inherited mutability&#39;.</p><p>Cell types come in two flavors: Cell and RefCell. Cell provides get and set methods that change the interior value with a single method call. Cell though is only compatible with types that implement Copy. For other types, one must use the RefCell type, acquiring a write lock before mutating.</p><p>RefCell uses Rust&#39;s lifetimes to implement &#39;dynamic borrowing&#39;, a process whereby one can claim temporary, exclusive, mutable access to the inner value. Borrows for RefCells are tracked &#39;at runtime&#39;, unlike Rust&#39;s native reference types which are entirely tracked statically, at compile time. Because RefCell borrows are dynamic it is possible to attempt to borrow a value that is already mutably borrowed; when this happens it results in thread panic.</p></blockquote><h3 id="_5-ref-refmut" tabindex="-1"><a class="header-anchor" href="#_5-ref-refmut" aria-hidden="true">#</a> 5. Ref &amp; RefMut</h3><h4 id="ref-map" tabindex="-1"><a class="header-anchor" href="#ref-map" aria-hidden="true">#</a> Ref::map()</h4><ol><li>example1</li></ol><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Ref</span><span class="token operator">&lt;</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">U</span><span class="token operator">&gt;</span>
<span class="token comment">// Get Ref&lt;T&gt; from Ref&lt;Node&lt;T&gt;&gt;</span>
<span class="token comment">// my example</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">peek_front</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ref</span><span class="token punctuation">::</span><span class="token function">map</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>example2</li></ol><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// Makes a new Ref for a component of the borrowed data.</span>

<span class="token comment">// The RefCell is already immutably borrowed, so this cannot fail.</span>

<span class="token comment">// This is an associated function that needs to be used as Ref::map(...). A method would interfere with methods of the same name on the contents of a RefCell used through Deref.</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">RefCell</span><span class="token punctuation">,</span> <span class="token class-name">Ref</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token char">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b1<span class="token punctuation">:</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b2<span class="token punctuation">:</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Ref</span><span class="token punctuation">::</span><span class="token function">map</span><span class="token punctuation">(</span>b1<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>t<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span>t<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token operator">*</span>b2<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/trdthg/edit/main/rust/rust.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.2196ae99.js" defer></script>
  </body>
</html>
