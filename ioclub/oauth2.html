<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OAuth 2.0 Simplified | Trdthg&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="logo.png">
    <meta name="description" content="我的个人网站">
    
    <link rel="preload" href="/assets/css/0.styles.b52f6a3a.css" as="style"><link rel="preload" href="/assets/js/app.ac04e7f0.js" as="script"><link rel="preload" href="/assets/js/2.8e748a32.js" as="script"><link rel="preload" href="/assets/js/14.1a82f5e5.js" as="script"><link rel="prefetch" href="/assets/js/10.1cd99fe5.js"><link rel="prefetch" href="/assets/js/11.fbdcf8c5.js"><link rel="prefetch" href="/assets/js/12.f749247f.js"><link rel="prefetch" href="/assets/js/13.d283d306.js"><link rel="prefetch" href="/assets/js/15.d6ea9a69.js"><link rel="prefetch" href="/assets/js/16.a7c11532.js"><link rel="prefetch" href="/assets/js/17.198224c3.js"><link rel="prefetch" href="/assets/js/18.d4e73e39.js"><link rel="prefetch" href="/assets/js/19.4895316d.js"><link rel="prefetch" href="/assets/js/20.77d5ec69.js"><link rel="prefetch" href="/assets/js/21.dcd1774d.js"><link rel="prefetch" href="/assets/js/22.c41b2aca.js"><link rel="prefetch" href="/assets/js/23.f9c16c3a.js"><link rel="prefetch" href="/assets/js/24.8002cb2f.js"><link rel="prefetch" href="/assets/js/25.3de0e7ca.js"><link rel="prefetch" href="/assets/js/26.c4c811a8.js"><link rel="prefetch" href="/assets/js/27.28561eb7.js"><link rel="prefetch" href="/assets/js/28.4173ce23.js"><link rel="prefetch" href="/assets/js/29.7fbc8405.js"><link rel="prefetch" href="/assets/js/3.3ec313a7.js"><link rel="prefetch" href="/assets/js/30.7519df6f.js"><link rel="prefetch" href="/assets/js/31.09374044.js"><link rel="prefetch" href="/assets/js/32.b2694f28.js"><link rel="prefetch" href="/assets/js/33.9d656a30.js"><link rel="prefetch" href="/assets/js/34.5cae5c4d.js"><link rel="prefetch" href="/assets/js/35.d45e029f.js"><link rel="prefetch" href="/assets/js/36.678f68a4.js"><link rel="prefetch" href="/assets/js/4.29554731.js"><link rel="prefetch" href="/assets/js/5.1d90f67d.js"><link rel="prefetch" href="/assets/js/6.5163448b.js"><link rel="prefetch" href="/assets/js/7.9a186dae.js"><link rel="prefetch" href="/assets/js/8.e550dfbf.js"><link rel="prefetch" href="/assets/js/9.ca89ae3f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b52f6a3a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Trdthg's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/java/java.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/js/vue.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/python/python.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/wasm.html" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/magic/haskell.html" class="nav-link">
  魔法
</a></div><div class="nav-item"><a href="/ioclub/oauth2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  IO Club
</a></div><div class="nav-item"><a href="/other/other.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/trdthg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/java/java.html" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/js/vue.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/python/python.html" class="nav-link">
  Python
</a></div><div class="nav-item"><a href="/rust/wasm.html" class="nav-link">
  Rust
</a></div><div class="nav-item"><a href="/magic/haskell.html" class="nav-link">
  魔法
</a></div><div class="nav-item"><a href="/ioclub/oauth2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  IO Club
</a></div><div class="nav-item"><a href="/other/other.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/trdthg" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/ioclub/oauth2.html" aria-current="page" class="active sidebar-link">OAuth 2.0 Simplified</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_1-getting-ready-开始" class="sidebar-link">1. Getting ready 开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_1-1-creating-an-application-一般需要-sign-up-as-a-developer" class="sidebar-link">1.1 Creating an Application(一般需要 sign up as a developer)</a></li><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_1-2-redirect-urls-and-state" class="sidebar-link">1.2 Redirect URLs and State</a></li></ul></li><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_2-accessing-data-获取数据-github为例" class="sidebar-link">2. Accessing data 获取数据(github为例)</a></li><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_3-signing-in-with-google" class="sidebar-link">3. Signing in with Google</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_3-1-如何获取用户信息" class="sidebar-link">3.1 如何获取用户信息</a></li><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_3-2-下面以google提供的api为例" class="sidebar-link">3.2 下面以Google提供的api为例</a></li></ul></li><li class="sidebar-sub-header"><a href="/ioclub/oauth2.html#_4-server-side-apps" class="sidebar-link">4 Server-Side Apps</a></li></ul></li><li><a href="/ioclub/share_1.html" class="sidebar-link">B+树以及在数据库中的应用</a></li><li><a href="/ioclub/backend_1.html" class="sidebar-link">第一节课 前导知识</a></li><li><a href="/ioclub/backend_2.html" class="sidebar-link">第二次课 HTTP协议</a></li><li><a href="/ioclub/backend_3.html" class="sidebar-link">第三次课 Cookie登录</a></li><li><a href="/ioclub/backend_4.html" class="sidebar-link">第四次课 SQL</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="oauth-2-0-simplified"><a href="#oauth-2-0-simplified" class="header-anchor">#</a> OAuth 2.0 Simplified</h1> <p><a href="https://www.oauth.com/" target="_blank" rel="noopener noreferrer">www.oauth.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_1-getting-ready-开始"><a href="#_1-getting-ready-开始" class="header-anchor">#</a> 1. Getting ready 开始</h2> <h3 id="_1-1-creating-an-application-一般需要-sign-up-as-a-developer"><a href="#_1-1-creating-an-application-一般需要-sign-up-as-a-developer" class="header-anchor">#</a> 1.1 Creating an Application(一般需要 sign up as a developer)</h3> <p>user -&gt; entering basic information such as the name, website, logo, etc.
server -&gt; return a <strong>client_id</strong> (and a <strong>client_secret</strong> in some cases)</p> <h3 id="_1-2-redirect-urls-and-state"><a href="#_1-2-redirect-urls-and-state" class="header-anchor">#</a> 1.2 Redirect URLs and State</h3> <ol><li>为了使同一个clientID同时拥有多个状态, Some services may allow you to register multiple redirect URLs
比如:</li></ol> <ul><li>Web app and Mobile app</li> <li>development service and production service</li></ul> <ol start="2"><li>为了保证安全: 必须使用https防止在认证过程中code被拦截</li></ol> <ul><li>大多数服务(service)需要路由完全匹配, 这意味着<a href="https://example.com/auth" target="_blank" rel="noopener noreferrer">https://example.com/auth<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的重定向 URL 将与 <a href="https://example.com/auth?destination=account" target="_blank" rel="noopener noreferrer">https://example.com/auth?destination=account<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 不匹配. 所以最佳做法是不在url里使用query string parameters</li> <li>少部分服务需要可以从多种url发起认证，可以选择注册多个重定向url, 或者改变这些请求的重定向url, 但是oauth2提供了一种机制=&gt; 状态参数(State)
State的特点</li></ul> <ol start="3"><li>State</li></ol> <ul><li>可以用来作为加密的salt</li> <li>可以是某种随机数据</li> <li>对与service来说是不可见的 -&gt; 在初始化认证请求时(initial authorization request)传入的任何State都会在用户授权给app(user authorizes the application)后被返回</li></ul> <blockquote><p>state用于额外的安全检查, 当github返回数据时可以确认不是攻击者发出的请求, 比如将攻击者的authorization token发送给github, as well as SCRF attack</p></blockquote> <p>比如: 你可以将一个重定向的url经过encode后like JWT, 在用户返回app后解析这个JWT将用户带回合适的位置</p> <h2 id="_2-accessing-data-获取数据-github为例"><a href="#_2-accessing-data-获取数据-github为例" class="header-anchor">#</a> 2. Accessing data 获取数据(github为例)</h2> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$out_app</span> <span class="token operator">=</span> <span class="token string double-quoted-string">&quot;在github填的homepage&quot;</span>

<span class="token variable">$authorizeURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://github.com/login/oauth/authorize'</span><span class="token punctuation">;</span>
<span class="token comment">// This is the endpoint we'll request an access token from</span>
<span class="token variable">$tokenURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://github.com/login/oauth/access_token'</span><span class="token punctuation">;</span>
<span class="token comment">// This is the GitHub base URL for API requests</span>
<span class="token variable">$apiURLBase</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://api.github.com/'</span><span class="token punctuation">;</span>
<span class="token comment">// The URL for this script, used as the redirect URL</span>
<span class="token variable">$baseURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://'</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><ol><li>获取登录凭证(access_token)</li></ol> <div class="language-php extra-class"><pre class="language-php"><code>           开始
            <span class="token operator">|</span>
            <span class="token operator">|</span> 从某处发起HttpRequest重定向到<span class="token function">authorizeURL</span><span class="token punctuation">(</span>不一定是our<span class="token operator">-</span>app<span class="token punctuation">)</span>
            <span class="token operator">|</span> 携带
            <span class="token operator">|</span> <span class="token punctuation">{</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'response_type'</span><span class="token operator">=</span> <span class="token string single-quoted-string">'code'</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'client_id'</span> <span class="token operator">=</span> <span class="token variable">$githubClientID</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'redirect_uri'</span> <span class="token operator">=</span> <span class="token variable">$baseURL</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'scope'</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'user public_repo'</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'status'</span><span class="token operator">=</span> <span class="token string single-quoted-string">'random_string(10)'</span>
            <span class="token operator">|</span> <span class="token punctuation">}</span>
            ∨
        github认证界面
            <span class="token operator">|</span>
            <span class="token operator">|</span> 点击确认
            <span class="token operator">|</span> <span class="token keyword">if</span> status_send <span class="token operator">==</span> status_resp<span class="token punctuation">:</span>
            <span class="token operator">|</span>     携带code和status重定向到app界面
            ∨
        our<span class="token operator">-</span><span class="token class-name">app</span>
            <span class="token operator">|</span>
            <span class="token operator">|</span> <span class="token class-name">exchange</span> the authorization code <span class="token keyword">for</span> an access token<span class="token operator">.</span>
            <span class="token operator">|</span> 携带
            <span class="token operator">|</span> <span class="token punctuation">{</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'grant_type'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'authorization_code'</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'client_id'</span> <span class="token operator">=&gt;</span> <span class="token variable">$githubClientID</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'client_secret'</span> <span class="token operator">=&gt;</span> <span class="token variable">$githubClientSecret</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'redirect_uri'</span> <span class="token operator">=&gt;</span> <span class="token variable">$baseURL</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string single-quoted-string">'code'</span> <span class="token operator">=&gt;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'code'</span><span class="token punctuation">]</span>
            <span class="token operator">|</span> <span class="token punctuation">}</span>
            <span class="token operator">|</span> 再次请求tokenURL使用code交换<span class="token class-name">token</span>
            <span class="token operator">|</span> <span class="token punctuation">{</span>
            <span class="token operator">|</span>     <span class="token string double-quoted-string">&quot;access_token&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;e2f8c8e136c73b1e909bb1021b3b4c29&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string double-quoted-string">&quot;token_type&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;Bearer&quot;</span><span class="token punctuation">,</span>
            <span class="token operator">|</span>     <span class="token string double-quoted-string">&quot;scope&quot;</span><span class="token punctuation">:</span> <span class="token string double-quoted-string">&quot;public_repo,user&quot;</span>
            <span class="token operator">|</span> <span class="token punctuation">}</span>
            <span class="token operator">|</span> 重定向到<span class="token function">homepage</span><span class="token punctuation">(</span>baseURL<span class="token punctuation">)</span>，用户成功登录
            ∨
        <span class="token class-name">appHomePage</span>
            <span class="token operator">|</span>
            <span class="token operator">|</span> 把access_token存入session<span class="token punctuation">,</span> 下次进入app时就能通过access_token进入登录成功后的界面
            ∨
           End
</code></pre></div><ol start="2"><li>利用access_token获取数据
直接在header里添加access_token请求apiURLBase就完事了</li></ol> <h2 id="_3-signing-in-with-google"><a href="#_3-signing-in-with-google" class="header-anchor">#</a> 3. Signing in with Google</h2> <h3 id="_3-1-如何获取用户信息"><a href="#_3-1-如何获取用户信息" class="header-anchor">#</a> 3.1 如何获取用户信息</h3> <p>两个关键词</p> <ul><li>authorization 鉴权: trying to gain access or modify something that belongs to the user.</li> <li>authentication 校验: just verifying who the user is
OAuth is designed as a authorization protocol(授权协议), 所以access_token不能被用来判断用户是谁
有以下几种不同services为app提供的方法可以判断用户是谁</li></ul> <ol><li>a simple way: 让api顺便返回一些profile_info(用户信息), 不包含在OAuth标准里</li> <li>a advanced approach: use OpenID Connect(an OAuth2.0 extension)
<ul><li>利用id_token</li> <li>使用access_token
如何选择获取user_info的方法
A: For performance-sensitive applications where you might be reading ID tokens on every request or using them to maintain a session, you should definitely validate the ID token locally rather than making a network request.<a href="https://developers.google.com/identity/protocols/OpenIDConnect#validatinganidtoken" target="_blank" rel="noopener noreferrer">https://developers.google.com/identity/protocols/OpenIDConnect#validatinganidtoken<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
B: just for find the user’s name and email after they sign in, then extracting the data from the ID token and storing it in your application session</li></ul></li></ol> <h3 id="_3-2-下面以google提供的api为例"><a href="#_3-2-下面以google提供的api为例" class="header-anchor">#</a> 3.2 下面以Google提供的api为例</h3> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$authorizeURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://accounts.google.com/o/oauth2/v2/auth'</span><span class="token punctuation">;</span>
<span class="token comment">// This is Google's OpenID Connect token endpoint</span>
<span class="token variable">$tokenURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://www.googleapis.com/oauth2/v4/token'</span><span class="token punctuation">;</span>
<span class="token comment">// The URL for this script, used as the redirect URL</span>
<span class="token variable">$baseURL</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'https://'</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SERVER_NAME'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'PHP_SELF'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>与github的不同</p> <ol><li>Google的认证界面只能选择使用那个帐号(用户), 没有点击授权的按钮</li> <li>请求access_token的返回值</li></ol> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;ya29.Glins-oLtuljNVfthQU2bpJVJPTu&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;token_type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Bearer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">3600</span><span class="token punctuation">,</span>
  <span class="token property">&quot;id_token&quot;</span><span class="token operator">:</span> &quot;eyJhbGciOiJSUzI1NiIsImtpZCI6ImFmZmM2MjkwN
  2E0NDYxODJhZGMxZmE0ZTgxZmRiYTYzMTBkY2U2M2YifQ.eyJhenAi
  OiIyNzIxOTYwNjkxNzMtZm81ZWI0MXQzbmR1cTZ1ZXRkc2pkdWdzZX
  V0ZnBtc3QuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJhdWQi
  OiIyNzIxOTYwNjkxNzMtZm81ZWI0MXQzbmR1cTZ1ZXRkc2pkdWdzZX
  V0ZnBtc3QuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJzdWIi
  OiIxMTc4NDc5MTI4NzU5MTM5MDU0OTMiLCJlbWFpbCI6ImFhcm9uLn
  BhcmVja2lAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOnRydWUs
  ImF0X2hhc2giOiJpRVljNDBUR0luUkhoVEJidWRncEpRIiwiZXhwIj
  oxNTI0NTk5MDU2LCJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2ds
  ZS5jb20iLCJpYXQiOjE1MjQ1OTU0NTZ9.ho2czp_1JWsglJ9jN8gCg
  WfxDi2gY4X5-QcT56RUGkgh5BJaaWdlrRhhN_eNuJyN3HRPhvVA_KJ
  Vy1tMltTVd2OQ6VkxgBNfBsThG_zLPZriw7a1lANblarwxLZID4fXD
  YG-O8U-gw4xb-NIsOzx6xsxRBdfKKniavuEg56Sd3eKYyqrMA0DWnI
  agqLiKE6kpZkaGImIpLcIxJPF0-yeJTMt_p1NoJF7uguHHLYr6752h
  qppnBpMjFL2YMDVeg3jl1y5DeSKNPh6cZ8H2p4Xb2UIrJguGbQHVIJ
  vtm_AspRjrmaTUQKrzXDRCfDROSUU-h7XKIWRrEd2-W9UkV5oCg&quot;
<span class="token punctuation">}</span>
</code></pre></div><p>下面是前两端的解码信息段</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RS256&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;kid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;affc62907a446182adc1fa4e81fdba6310dce63f&quot;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;azp&quot;</span><span class="token operator">:</span> <span class="token string">&quot;272196069173-fo5eb41t3nduq6uetdsjdugseutfpmst.apps.googleusercontent.com&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;aud&quot;</span><span class="token operator">:</span> <span class="token string">&quot;272196069173-fo5eb41t3nduq6uetdsjdugseutfpmst.apps.googleusercontent.com&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;sub&quot;</span><span class="token operator">:</span> <span class="token string">&quot;117847912875913905493&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;aaron.parecki@gmail.com&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;email_verified&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;at_hash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;iEYc40TGInRHhTBbudgpJQ&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exp&quot;</span><span class="token operator">:</span> <span class="token number">1524599056</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iss&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://accounts.google.com&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;iat&quot;</span><span class="token operator">:</span> <span class="token number">1524595456</span>
<span class="token punctuation">}</span>
</code></pre></div><p>access_token should be tracted as opaque(不透明), 因为里面没有重要信息
一般来说, 提取id_token中的信息之前进行校验是很重要的, 防止这个token是有其他人下发的, 在上面的示例中, 我们使用了https以确保token确实来自Google
sub是用户的标识符，与帐号绑定，即使更换邮箱也不会变</p> <blockquote><p>下面是一些解释
azp: 授权演示者的client_id 。仅当请求ID令牌的一方与ID令牌的受众不同时才需要此声明。
aud: 此ID令牌的目标受众。它必须是您应用程序的OAuth 2.0客户端ID之一。</p></blockquote> <h2 id="_4-server-side-apps"><a href="#_4-server-side-apps" class="header-anchor">#</a> 4 Server-Side Apps</h2> <ol><li>请求code时的queryString</li></ol> <ul><li>response_type: 想要获取的返回值类型</li> <li>client_id: app的identifier</li> <li>redirect_url(optional): 授权完成后的跳转页面(需要在注册app时设置)</li> <li>scope(optional): Include one or more scope values (space-separated) to request additional levels of access. The values will depend on the particular service.(用空格分隔)</li> <li>status: 会被服务端完整返回，can be used to letyour app persist data between the user being directed to the authorization server and back again，</li></ul> <blockquote><p>比如using it as session_key to indicate what action the app to perform after authorization is complete(比如重定向的链接)
如果每次request的status都是随机生成的，status也能用来保护from CSRF</p></blockquote> <ol start="2"><li>交换access_token的queryString</li></ol> <ul><li>grant_type(required): 必须要设置为authorization_code</li> <li>code(required):  will be in the query string parameter “code” in this request.</li> <li>redirect_uri (possibly required)</li> <li>Client Authentication (required): 一般是client_id和client_secret</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">12/4/2021, 11:29:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/ioclub/share_1.html">
        B+树以及在数据库中的应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ac04e7f0.js" defer></script><script src="/assets/js/2.8e748a32.js" defer></script><script src="/assets/js/14.1a82f5e5.js" defer></script>
  </body>
</html>
