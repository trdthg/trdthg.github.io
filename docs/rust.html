<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-rust/rust">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">Rust è¯­è¨€ | Trdthg&#x27;s blog</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://trdthg.github.io//docs/rust"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Rust è¯­è¨€ | Trdthg&#x27;s blog"><meta data-rh="true" name="description" content="1. ç”Ÿå‘½å‘¨æœŸ"><meta data-rh="true" property="og:description" content="1. ç”Ÿå‘½å‘¨æœŸ"><link data-rh="true" rel="icon" href="/img/logo_png.png"><link data-rh="true" rel="canonical" href="https://trdthg.github.io//docs/rust"><link data-rh="true" rel="alternate" href="https://trdthg.github.io//docs/rust" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://trdthg.github.io//docs/rust" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Trdthg&#39;s blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Trdthg&#39;s blog Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-4TM86KZ83J"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-4TM86KZ83J",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.6b28552f.css">
<link rel="preload" href="/assets/js/runtime~main.ce766e05.js" as="script">
<link rel="preload" href="/assets/js/main.dc8abca6.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="è·³åˆ°ä¸»è¦å†…å®¹"><a href="#" class="skipToContent_fXgn">è·³åˆ°ä¸»è¦å†…å®¹</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo_png.png" alt="Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo_png.png" alt="Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Trdthg</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/trdthg" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="åˆ‡æ¢æµ…è‰²/æš—é»‘æ¨¡å¼ï¼ˆå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ï¼‰" aria-label="åˆ‡æ¢æµ…è‰²/æš—é»‘æ¨¡å¼ï¼ˆå½“å‰ä¸ºæµ…è‰²æ¨¡å¼ï¼‰"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="å›åˆ°é¡¶éƒ¨" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="true" href="/docs/category/-æ‹“å±•">ğŸ”® æ‹“å±•</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒğŸ”® æ‹“å±•ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/async">åç¨‹ä¸å¼‚æ­¥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/bash">Bash</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/cicd">CI/CD</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/fd">æ–‡ä»¶ç³»ç»Ÿ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/go">Go è¯­è¨€</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/hadoop">å¤§æ•°æ®</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/haskell">Haskell è¯­è¨€</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/linuxIO">IO å¤šè·¯å¤ç”¨</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/memory_ordering">åŸå­æ“ä½œä¸å†…å­˜é¡ºåº</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/oscamp2022">2022 ç§‹å†¬å­£å¼€æºæ“ä½œç³»ç»Ÿè®­ç»ƒè¥</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/magic/software_arch">è½¯ä»¶æ¶æ„</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/-rust-è¯­è¨€">ğŸ¦€ Rust è¯­è¨€</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒğŸ¦€ Rust è¯­è¨€ã€" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item green"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/rust">Rust è¯­è¨€</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/lists">Too-Many-Lists</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/mini_tokio">å¼‚æ­¥è¿è¡Œæ—¶</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/net-piercer">å†…ç½‘ç©¿é€å·¥å…·</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/print_into_detail">Rust print! å®</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/rs_channel">Channel æºç å‰–æ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/rust_quiz">Rust Quiz</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/rust/wasm">Wasm å®ç°ç”Ÿå‘½æ¸¸æˆ</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/-å­¦ä¹ ç¬”è®°">ğŸ“š å­¦ä¹ ç¬”è®°</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒğŸ“š å­¦ä¹ ç¬”è®°ã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/-èµ„æ–™åº“">ğŸ“¦ èµ„æ–™åº“</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€ŒğŸ“¦ èµ„æ–™åº“ã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/-io-club">âš½ IO Club</a><button aria-label="æ‰“å¼€/æ”¶èµ·ä¾§è¾¹æ èœå•ã€Œâš½ IO Clubã€" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">æ–‡æ¡£é¡µ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/log">æ—¥å¿—</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="é¡µé¢è·¯å¾„"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ä¸»é¡µé¢" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/-rust-è¯­è¨€"><span itemprop="name">ğŸ¦€ Rust è¯­è¨€</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Rust è¯­è¨€</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">æœ¬é¡µæ€»è§ˆ</button></div><div class="theme-doc-markdown markdown"><h1>Rust è¯­è¨€</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-ç”Ÿå‘½å‘¨æœŸ">1. ç”Ÿå‘½å‘¨æœŸ<a class="hash-link" href="#1-ç”Ÿå‘½å‘¨æœŸ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ">è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ<a class="hash-link" href="#è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Only one reference in input, so the output must be derived from that input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo(&amp;A) -&gt; &amp;B; // sugar for:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo&lt;&#x27;a&gt;(&amp;&#x27;a A) -&gt; &amp;&#x27;a B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Many inputs, assume they&#x27;re all independent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo(&amp;A, &amp;B, &amp;C); // sugar for:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo&lt;&#x27;a, &#x27;b, &#x27;c&gt;(&amp;&#x27;a A, &amp;&#x27;b B, &amp;&#x27;c C);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Methods, assume all output lifetimes are derived from `self`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo(&amp;self, &amp;B, &amp;C) -&gt; &amp;D; // sugar for:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn foo&lt;&#x27;a, &#x27;b, &#x27;c&gt;(&amp;&#x27;a self, &amp;&#x27;b B, &amp;&#x27;c C) -&gt; &amp;&#x27;a D;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-æ™ºèƒ½æŒ‡é’ˆ">2. æ™ºèƒ½æŒ‡é’ˆ<a class="hash-link" href="#2-æ™ºèƒ½æŒ‡é’ˆ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ<a class="hash-link" href="#åŸºæœ¬æ¦‚å¿µ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>å®ç°äº† Deref Trait å’Œ Drop Trait çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆ</p><ol><li>Deref Trait: å…·æœ‰æŒ‡é’ˆè¯­ä¹‰</li><li>Drop Traitï¼šæ‹¥æœ‰å†…å­˜è‡ªåŠ¨ç®¡ç†çš„æœºåˆ¶</li></ol><p>çœ‹ä¸€çœ¼ Box çš„å®ç°</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;T: ?Sized, A: Allocator&gt; Deref for Box&lt;T, A&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type Target = T;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn deref(&amp;self) -&gt; &amp;T {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;**self</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ç®€å•å®ç°">ç®€å•å®ç°<a class="hash-link" href="#ç®€å•å®ç°" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>æˆ‘ä»¬å®ç°ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ˆåªå®ç°äº† Deref Traitï¼‰</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::ops::Deref;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub struct MySmartPointer&lt;T&gt; (T);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;T&gt; MySmartPointer&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub fn new(t: T) -&gt; Self {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MySmartPointer(t)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;T&gt; Deref for MySmartPointer&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type Target = T;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn deref(&amp;self) -&gt; &amp;Self::Target {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &amp;self.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// è°ƒç”¨*x å…¶å®å°±æ˜¯è°ƒç”¨ *x.deref()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let x = 5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let a = MySmartPointer::new(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let b = Box::new(x);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *a.deref());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *a);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *b.deref());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *b);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">print!(&quot;{}&quot;, a.to_string())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº">è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº<a class="hash-link" href="#è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><ul><li><p>é‡åˆ°*è¿ç®—ç¬¦è‡ªåŠ¨æ¥å¼•ç”¨</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *a.deref());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(x, *a);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>é‡åˆ° . è¿ç®—ç¬¦æ¥å¼•ç”¨è°ƒç”¨æ–¹æ³•</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">print!(&quot;{}&quot;, a.to_string())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>å‚æ•°ä¼ é€’è‡ªåŠ¨è§£å¼•ç”¨</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let s = String::from(&quot;aaaa&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn take_str(s: &amp;str) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    print!(&quot;{}&quot;, s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">take_str(&amp;s);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#[stable(feature = &quot;rust1&quot;, since = &quot;1.0.0&quot;)]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl ops::Deref for String {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type Target = str;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    #[inline]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fn deref(&amp;self) -&gt; &amp;str {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        unsafe { str::from_utf8_unchecked(&amp;self.vec) }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="è‡ªåŠ¨ç®¡ç†å†…å­˜">è‡ªåŠ¨ç®¡ç†å†…å­˜<a class="hash-link" href="#è‡ªåŠ¨ç®¡ç†å†…å­˜" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>è‡ªåŠ¨åŒ–ç®¡ç†å†…å­˜ (dropï¼Œä½œç”¨åŸŸå¤–è‡ªåŠ¨é‡Šæ”¾å†…å­˜)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-atomic-åœ¨-rust-ä¸­çš„å®è·µ">2. Atomic åœ¨ rust ä¸­çš„å®è·µ<a class="hash-link" href="#2-atomic-åœ¨-rust-ä¸­çš„å®è·µ" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><p><a href="https://www.youtube.com/watch?v=rMGWeSjctlY" target="_blank" rel="noopener noreferrer">Crust of Rust: Atomics and Memory Ordering</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex">ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex<a class="hash-link" href="#ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::{sync::atomic::{AtomicBool, Ordering, AtomicUsize}, thread::{self, spawn}, cell::UnsafeCell};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const UNLOCKED: bool = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">const LOCKED: bool = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">struct Mutex&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    locked: AtomicBool,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    v: UnsafeCell&lt;T&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unsafe impl&lt;T&gt; Sync for Mutex&lt;T&gt; where T: Send {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">impl&lt;T&gt; Mutex&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub fn new(v: T) -&gt; Self {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Self {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            locked: AtomicBool::new(UNLOCKED),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v: UnsafeCell::new(v)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// æš´éœ²ä¸€ä¸ªå¯å˜å¼•ç”¨å‡ºå»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// å½“çº¿ç¨‹ A å’Œçº¿ç¨‹ B åŒæ—¶æ‰§è¡Œæ—¶ï¼ŒAï¼ŒB å¯èƒ½åŒæ—¶æ‹¿åˆ°ğŸ”“ï¼Œå¹¶åŒæ—¶ä¸Šé”ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰`çœ‹åˆ°`å¯¹æ–¹é¡µæ‹¿åˆ°äº†é”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// æ‰€ä»¥å°±å‡ºå…ˆäº†ï¼Œçº¿ç¨‹ A å’Œ B åŒæ—¶ä»å¯„å­˜å™¨æ‹¿åˆ°å€¼ 1ï¼Œæ”¹ä¸ºäº† 2ï¼Œç„¶åå¤åˆ¶åˆ°å¯„å­˜å™¨å†…ï¼Œåä¿®æ”¹çš„ä¼šè¦†ç›–å‰ä¸€æ¬¡ä¿®æ”¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸‹é¢æ˜¯ä¸€äº›è§£å†³æ–¹æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// æ–¹æ¡ˆ 1ï¼Œä½¿ç”¨`compare_exchange`åˆå¹¶åŠ é”ä¸Šé”è¿‡ç¨‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// #1 compare_exchange æ˜¯ä½æ•ˆçš„ï¼Œå¦‚æœæ˜¯å¤šæ ¸éƒ½åœ¨åŒæ—¶äº‰å¤ºé”ï¼Œ8 ä¸ªæ ¸ä¸­æœ‰ä¸€ä¸ªå’Œå…ˆæ‹¿åˆ°äº†é”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// é‚£ä¹ˆå‰©ä¸‹çš„ 7 ä¸ªæ ¸ä¾ç„¶ä¼šäº’ç›¸ç«äº‰ï¼Œè¿™ä¸ªå˜é‡çš„å†…å­˜å°±ä¼šåœ¨å¤šä¸ªæ ¸ä¸­ä¸æ–­æ‹·è´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// #2 ç›¸æ¯”äº mutexï¼Œmutex æ‹¿ä¸åˆ°é”å°±ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œ compare_exchange æ‹¿ä¸åˆ°å°±ä¼šè¿”å›ä¸€ä¸ª Err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /// #3 rust ä¸­è¿˜æä¾›äº† compare_and_exchange_weakï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///     compare_and_exchange åªå…è®¸åœ¨åˆ¤æ–­ Current v alue å’Œä¼ å…¥çš„å€¼ä¸ä¸€æ ·æ—¶è¿”å› Err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///     compare_and_exchange_weak å³ä½¿åœ¨ä¸€æ ·çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šè¿”å› Errï¼Œè¿™ç§ç»†å°çš„å·®åˆ«èƒ½å¤Ÿç”¨äºæŸäº›åœºæ™¯ï¼Œè®©æ€§èƒ½æ›´å¥½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///     åŸå› æ˜¯ç”±äºåœ¨ä¸åŒå¹³å°ä¸Šçš„å®ç°ä¸åŒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///         x86: compare_and_swap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///         ARM: LDREX STREX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///     åœ¨ x86 ä¸Š weak ä¸æ™®é€šçš„ç›¸åŒï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///     åœ¨ ARM ä¸Šï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///         compare_and_exchange: impl using a loop of LDREX and STREX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ///         compare_and_exchange_weak: LDREX and STREX with no loop, it may be fake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pub fn with_lock&lt;R&gt;(&amp;self, f: impl FnOnce(&amp;mut T) -&gt; R) -&gt; R {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‹¿ğŸ”“ ä¸ŠğŸ”“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // while self.locked.load(Ordering::Relaxed) != UNLOCKED {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // self.locked.store(LOCKED, Ordering::Relaxed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ–¹æ¡ˆ 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ–¹æ¡ˆ 2 åœ¨ arm ä¸‹æœ‰æ›´å¥½çš„æ€§èƒ½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while self.locked.compare_exchange_weak(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‡å¦‚ç°åœ¨ current value å°±æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå·²ç»ä¿®æ”¹ä¸º LOCKED çŠ¶æ€ï¼Œé‚£ä¹ˆå°±å·²ç»æ‹¿åˆ°äº†æ‰€æœ‰æƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åŠ å…¥ç°åœ¨è¿˜æ²¡æœ‰ä¿®æ”¹å®Œæˆï¼Œcurrent value ä¾ç„¶æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šå¡ä½ï¼Œç›´åˆ°æœ‰åˆ«çš„çº¿ç¨‹æˆåŠŸæ‹¿åˆ°äº†æ‰€æœ‰æƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while self.locked.load(Ordering::Relaxed) == LOCKED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                thread::yield_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread::yield_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æš´éœ²æ•°æ®</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        let ret = f(unsafe { &amp;mut *self.v.get() });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è§£ğŸ”“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self.locked.store(UNLOCKED, Ordering::Relaxed);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let l: &amp;&#x27;static _ = Box::leak(Box::new(Mutex::new(0)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let handles: Vec&lt;_&gt; = (0..1000).map(|_| {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        thread::spawn(move || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for _ in 0..1000 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                l.with_lock(|v| {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    *v += 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }).collect();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for handle in handles {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        handle.join().unwrap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™é‡Œä¾ç„¶ä¼šæŠ¥é”™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    assert_eq!(l.with_lock(|v| *v), 1000 * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="acquire-ä¸-release">Acquire ä¸ Release<a class="hash-link" href="#acquire-ä¸-release" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// ä½†æ˜¯å³ä½¿ç”¨äº†ä¸Šé¢çš„ä¸œè¥¿ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œè™½ç„¶åœ¨ X86 64 ä½ç³»ç»Ÿä¸Šæ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºä»–ä¸æ”¯æŒï¼ï¼Œä»–åªæ”¯æŒ Seq çš„ï¼Œä¸è¿‡è¿˜æ˜¯è¦è¯´æ˜é—®é¢˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// å› ä¸ºä¸‹é¢å¯¹å˜é‡ v çš„ä¿®æ”¹å’Œä¸Šé”é‡Šæ”¾é”çš„è¿‡ç¨‹æ¯«ä¸ç›¸å…³ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// æ‰€ä»¥ä¸‹ä¸€è¡Œå¯èƒ½è¢«é‡æ–°æ’åˆ—åœ¨åŠ é”ä¹‹å‰ï¼Œæˆ–è€…è§£é”ä¹‹åï¼Œè¿™ä¸¤ç§éƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä½†æ˜¯ cpu å’Œç¼–è¯‘å™¨å°±å¯èƒ½è¿™æ ·åš</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">///</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// å¯¹æ­¤éœ€è¦ä½¿ç”¨ Acquire å’Œ Release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub fn with_lock2&lt;R&gt;(&amp;self, f: impl FnOnce(&amp;mut T) -&gt; R) -&gt; R {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»»ä½•ä¹‹åçš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Acquire ä¹‹å‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ«çš„çº¿ç¨‹ä¸­çš„å†™æ“ä½œï¼Œå¯¹äºè¿™é‡Œçš„ Acquire éƒ½æ˜¯å¯è§çš„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while self.locked.compare_exchange_weak(UNLOCKED, LOCKED, Ordering::Acquire, Ordering::Relaxed).is_err() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while self.locked.load(Ordering::Relaxed) == LOCKED {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            thread::yield_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        thread::yield_now();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let ret = f(unsafe { &amp;mut *self.v.get() });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»»ä½•ä¹‹å‰çš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Release ä¹‹å</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è¿™ä¸ªçº¿ç¨‹é‡Œçš„æ‰€æœ‰å†™æ“ä½œå¯¹åˆ«çš„çº¿ç¨‹ä¸­çš„ Acquire éƒ½æ˜¯å¯è§çš„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.locked.store(UNLOCKED, Ordering::Release);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ret</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="å¿…éœ€ç”¨-seq-çš„åœºæ™¯">å¿…éœ€ç”¨ Seq çš„åœºæ™¯<a class="hash-link" href="#å¿…éœ€ç”¨-seq-çš„åœºæ™¯" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#[test]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn seq_test() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // fetch_add always succeed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let x: &amp;&#x27;static _ = Box::leak(Box::new(AtomicBool::new(false)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let y: &amp;&#x27;static _ = Box::leak(Box::new(AtomicBool::new(false)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let z: &amp;&#x27;static _ = Box::leak(Box::new(AtomicUsize::new(0)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let tx = thread::spawn(move || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x.store(true, Ordering::Release);                  // ï¼ï¼ï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let ty = thread::spawn(move || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y.store(true, Ordering::Release);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let t1 = spawn(move || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while !x.load(Ordering::Acquire) {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if y.load(Ordering::Acquire) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            z.fetch_add(1, Ordering::Release);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let t2 = spawn(move || {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while !y.load(Ordering::Acquire) {}                    // è¿™è¡Œå’Œä¸‹é¢ä¸€è¡Œå¯èƒ½é‡æ’ (æˆ–è€…è¯´ä¸æ˜¯é‡æ’ï¼Œå•çº¯æ—¶å¯è§æ€§çš„é—®é¢˜ï¼Œä¸‹é¢çš„ x å°±æ˜¯çœ‹åˆ°äº† x æ˜¯ false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if x.load(Ordering::Acquire) {                         // ï¼ï¼ï¼x ä¸º falseï¼Œå½“ x è¢«ä¿®æ”¹ä¸º true åï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            z.fetch_add(1, Ordering::Release);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println!(&quot;{}&quot;, z.load(Ordering::SeqCst));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // What are the possibles for z?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // - is 0 possibly ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   ç»è¿‡åˆ¤æ–­ï¼Œè‡³å°‘æœ‰ä¸‹é¢çš„æ¡ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //     t1 must run after tx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //     t2 must run after ty</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   å‡ ç§æ’åˆ—ç»„åˆåº”è¯¥æ˜¯ 1 æˆ– 2ï¼Œæ²¡æœ‰ 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   ä½†æ˜¯ 0 è¿˜æ˜¯å¯èƒ½çš„ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //           t2    t1,t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   MO(x)  false  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //           t1    t1,t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   MO(y)  false  true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // - is 1 possibly ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   Yes: tx -&gt; t1 -&gt; ty -&gt; t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // - is 2 possibly ?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //   Yes: tx -&gt; ty -&gt; t1 -&gt; t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-å¸¸ç”¨-trait">3. å¸¸ç”¨ Trait<a class="hash-link" href="#3-å¸¸ç”¨-trait" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-read">3.1 Read<a class="hash-link" href="#31-read" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>Read Trait çš„åŠŸèƒ½æ˜¯ï¼šä»æ•°æ®æºæ‹‰å– (Pull) ä¸€å®šæ•°æ®åˆ°æŒ‡å®šçš„ç¼“å†²åŒºï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><p><strong>å…³äºé˜»å¡ï¼š</strong> read å‡½æ•°ä¸ä¿è¯ Read æ˜¯å¦ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œå¦‚æœä¸€ä¸ª read è¿‡ç¨‹é˜»å¡äº†è€Œä¸”ç­‰å¾…å¤±è´¥ï¼Œé‚£ä»–å°±ä¼šè¿”å›ä¸€ä¸ª <!-- -->[<code>Err</code>]<!-- --> æ ‡è®°ã€‚</p><p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>read()</code>è¿”å›çš„æ˜¯ <!-- -->[<code>OK(n)</code>]<!-- --> , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚
å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>reader å·²ç»åˆ°è¾¾äº†<code>the end of file</code>ï¼Œè€Œä¸”è¿™ä¸ª<code>file</code>å¯èƒ½ä¸ä¼šåœ¨äº§ç”Ÿæ–°æ•°æ®ã€‚æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ likelyï¼Œæ¯”å¦‚ï¼šåœ¨ linux
ç³»ç»Ÿä¸­ï¼Œread å¯èƒ½å¯¹ä¸€ä¸ª <!-- -->[<code>TcpStream</code>]<!-- --> è°ƒç”¨äº†<code>recv</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ0 ä»£è¡¨è¿™ä¸ªè¿æ¥å·²ç»è¢«æˆåŠŸå…³é—­ï¼Œå¦‚æœæ˜¯å¯¹ <!-- -->[<code>File</code>]<!-- --> ,
é‚£å°±å¯èƒ½æ„å‘³ç€ç¡®å®è¯»å–åˆ°äº†æ–‡ä»¶çš„æœ«å°¾ï¼Œä½†æ˜¯å¦‚æœæœ‰æ›´å¤šçš„æ•°æ®è¢«è¿½åŠ  (append) åˆ°æ–‡ä»¶æœ«å°¾ï¼Œé‚£ä¹ˆæœªæ¥çš„ read æ“ä½œä¾ç„¶èƒ½å¤Ÿæ­£å¸¸è¿”å›è¢«è¿½åŠ çš„æ•°æ®</li><li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li></ol><p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p><p><strong>å…³äºå®‰å…¨æ€§ï¼š</strong></p><ul><li><p>å› ä¸ºå®ç°è¿™ä¸ª Trait æ˜¯å®‰å…¨çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½ç”¨ <code>n &lt; buf.len()</code> å»ç¡®ä¿å®‰å…¨ï¼Œä½¿ç”¨ unsafe æ˜¯æ›´è¦å°å¿ƒç¡®ä¿è¯¸å¦‚è¶Šç•Œé—®é¢˜æ˜¯å¦ä¼šå‘ç”Ÿã€‚</p></li><li><p>read ä¸ä¿è¯ buf é‡Œçš„æ•°æ®æ˜¯å¯¹çš„ï¼Œæ‰€ä»¥ä¸æ¨èè¯»å–ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œåªæ¨èå‘ç¼“å†²åŒºé‡Œå†™å…¥æ•°æ®</p></li><li><p>ç›¸åº”çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½æœ‰ä»»ä½•å‡è®¾ï¼Œè¿™ä¸ª buf ä¼šè¢« read æ€ä¹ˆä½¿ç”¨ï¼Œread å‡½æ•°ä¹Ÿå¯èƒ½ä¼šä»ä¸­è¯»å–å†…å®¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯åœ¨è°ƒç”¨ read å‰ï¼Œè¿™ä¸ª buf
å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†ï¼Œè°ƒç”¨æ²¡æœ‰è¢«åˆå§‹åŒ–çš„ buf æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º</p></li></ul><p><strong>*å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰è¯»å–è¿‡ä»»ä½•å­—èŠ‚ï¼Œå¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œ
è¯»å–è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¥è‡ª doc çš„ä¾‹å­</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::io;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::io::prelude::*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::fs::File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main() -&gt; io::Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut f = File::open(&quot;foo.txt&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut buffer = [0; 10];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // read up to 10 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let n = f.read(&amp;mut buffer[..])?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println!(&quot;The bytes: {:?}&quot;, &amp;buffer[..n]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-write">3.2 Write<a class="hash-link" href="#32-write" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>Write çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯å‘ writer ä¸­å†™å…¥ä¸€æ®µ bufï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•° <strong>å…³äºé˜»å¡ï¼š</strong> write ä¼šå°è¯•å‘ writer ä¸­å†™å…¥æ•´ä¸ª buf
é‡Œçš„å†…å®¹ï¼Œä½†æ˜¯å†™å…¥å¯èƒ½ä¸æˆåŠŸï¼Œæˆ–è€…å†™å…¥æ—¶äº§ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè°ƒç”¨ä¸€æ¬¡ write æ„å‘³ç€æœ€å¤šä¸€æ¬¡å°è¯•å†™å…¥ write å‡½æ•°åŒæ ·ä¸ä¿è¯ Write
æ˜¯å¦å¤„äºé˜»å¡çŠ¶æ€ä»¥ç­‰å¾…æ•°æ®è¢«å†™å…¥ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥é˜»å¡äº†ï¼Œä»–å¯èƒ½ä¼šè¿”å›ä¸€ä¸ª <!-- -->[<code>Err</code>]<!-- -->ã€‚</p><p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>write()</code>è¿”å›çš„æ˜¯ <!-- -->[<code>OK(n)</code>]<!-- --> , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚
å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>è¢«å†™å…¥çš„ä¸œè¥¿å·²ç»ä¸ä¼šæ¥å—æ–°æ•°æ®äº†ï¼Œä¹‹åä¹Ÿä¸ä¸€å®šä¼š</li><li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li></ol><p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p><p><strong>*å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰ä»»ä½•å­—èŠ‚è¢«æˆåŠŸå†™å…¥ è¿”å›å€¼å°äº buf çš„é•¿åº¦ä¸è¢«å½“æˆæ˜¯é”™è¯¯
å¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œå†™å…¥è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p><p>åŒæ ·æ˜¯å®˜æ–¹çš„ demo</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::io::prelude::*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::fs::File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main() -&gt; std::io::Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut buffer = File::create(&quot;foo.txt&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Writes some prefix of the byte string, not necessarily all of it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    buffer.write(b&quot;some bytes&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-seek--bufreader--bufwriter">3.3 Seek &amp; BufReader &amp; BufWriter<a class="hash-link" href="#33-seek--bufreader--bufwriter" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><p>[<code>Read</code>]<!-- --> å’Œ <!-- -->[<code>Write</code>]<!-- --> æ˜¯æœ€é‡è¦çš„ä¸¤ä¸ª Traitï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„ Trait<!-- -->[<code>Seek</code>]<!-- --> å’Œ <!-- -->[<code>BufRead</code>]<!-- -->,
è¿™ä¸¤ä¸ªéƒ½å»ºç«‹åœ¨ reader åªä¸Šï¼Œç”¨æ¥æ§åˆ¶ read çš„è¿‡ç¨‹ã€‚</p><p>[<code>Seek</code>]<!-- --> è®©ä½ æ§åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚å°†è¦è¯»å–çš„æ¥è‡ªå“ªé‡Œ</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::io;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::io::prelude::*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::io::SeekFrom;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::fs::File;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main() -&gt; io::Result&lt;()&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut f = File::open(&quot;foo.txt&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut buffer = [0; 10];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // skip to the last 10 bytes of the file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f.seek(SeekFrom::End(-10))?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // read up to 10 bytes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let n = f.read(&amp;mut buffer)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println!(&quot;The bytes: {:?}&quot;, &amp;buffer[..n]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Ok(())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>åŸºäº byte çš„æ¥å£æ€§èƒ½ä¸ä½³ï¼Œæ‰€ä»¥æä¾›äº†å¾ˆå¤šåŸºäº buffer çš„æ¥å£ <!-- -->[<code>BufRead</code>]<!-- --> å°±æä¾›äº†æ›´å¤š Read ç›¸å…³çš„ API</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let f = File::open(&quot;foo.txt&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut reader = BufReader::new(f);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let mut buffer = String::new();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// read a line into buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reader.read_line(&amp;mut buffer)?;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>[<code>BufWriter</code>]<!-- --> æ²¡æœ‰æä¾›æ›´å¤šå†™å…¥çš„æ–¹æ³•ï¼Œä»–åªæ˜¯ç¼“å†²äº†æ¯æ¬¡è°ƒç”¨</p><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">let f = File::create(&quot;foo.txt&quot;)?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let mut writer = BufWriter::new(f);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // write a byte to the buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    writer.write(&amp;[42])?;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} // the buffer is flushed once writer goes out of scope</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-å…¶ä»–">4. å…¶ä»–<a class="hash-link" href="#4-å…¶ä»–" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-rc--arc">2. Rc &amp; Arc<a class="hash-link" href="#2-rc--arc" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="ä»‹ç»">ä»‹ç»<a class="hash-link" href="#ä»‹ç»" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h4><blockquote><p>The key to our design is the RefCell type. The heart of RefCell is a pair of
methods:</p></blockquote><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">fn borrow(&amp;self) -&gt; Ref&lt;&#x27;_, T&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn borrow_mut(&amp;self) -&gt; RefMut&lt;&#x27;_, T&gt;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Introducing inherited mutability roots to shared types Shared smart pointer
types, including Rc and Arc, provide containers that can be cloned and shared
between multiple parties. Because the contained values may be
multiply-aliased, they can only be borrowed as shared references, not mutable
references. Without cells it would be impossible to mutate data inside of
shared boxes at all!</p></blockquote><blockquote><p>It&#x27;s very common then to put a RefCell inside shared pointer types to
reintroduce mutability:</p></blockquote><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">use std::collections::HashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::cell::RefCell;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::rc::Rc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fn main() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    let shared_map: Rc&lt;RefCell&lt;_&gt;&gt; = Rc::new(RefCell::new(HashMap::new()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shared_map.borrow_mut().insert(&quot;africa&quot;, 92388);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shared_map.borrow_mut().insert(&quot;kyoto&quot;, 11837);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shared_map.borrow_mut().insert(&quot;piccadilly&quot;, 11826);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    shared_map.borrow_mut().insert(&quot;marbles&quot;, 38);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>Note that this example uses Rc and not Arc. RefCells are for single-threaded
scenarios. Consider using Mutex if you need shared mutability in a
multi-threaded situation</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="try_unwrap">try_unwrap()<a class="hash-link" href="#try_unwrap" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h4><blockquote><p>Get T from Rc<!-- -->&lt;<!-- -->T<!-- -->&gt;<!-- --> try to use <code>try_unwrap()</code>, which moves out the contents
of an Rc if its refcount is 1 ::: warning unwrap on Result requires that you
can debug-print the error case. RefCell only implements Debug if T does. Node
doesn&#x27;t implement Debug. try:
Rc::try_unwrap(old_head).ok().unwrap().into_inner().elem :::</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-cell--refcell">4. Cell &amp; RefCell<a class="hash-link" href="#4-cell--refcell" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><blockquote><p>Shareable mutable containers.</p><p>Values of the Cell and RefCell types may be mutated through shared references
(i.e. the common &amp;T type), whereas most Rust types can only be mutated through
unique (&amp;mut T) references. We say that Cell and RefCell provide &#x27;interior
mutability&#x27;, in contrast with typical Rust types that exhibit &#x27;inherited
mutability&#x27;.</p><p>Cell types come in two flavors: Cell and RefCell. Cell provides get and set
methods that change the interior value with a single method call. Cell though
is only compatible with types that implement Copy. For other types, one must
use the RefCell type, acquiring a write lock before mutating.</p><p>RefCell uses Rust&#x27;s lifetimes to implement &#x27;dynamic borrowing&#x27;, a process
whereby one can claim temporary, exclusive, mutable access to the inner value.
Borrows for RefCells are tracked &#x27;at runtime&#x27;, unlike Rust&#x27;s native reference
types which are entirely tracked statically, at compile time. Because RefCell
borrows are dynamic it is possible to attempt to borrow a value that is
already mutably borrowed; when this happens it results in thread panic.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-ref--refmut">5. Ref &amp; RefMut<a class="hash-link" href="#5-ref--refmut" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="refmap">Ref::map()<a class="hash-link" href="#refmap" title="æ ‡é¢˜çš„ç›´æ¥é“¾æ¥">â€‹</a></h4><ol><li>example1</li></ol><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">map(Ref&lt; T&gt;, f: F) -&gt; Ref&lt;U&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Get Ref&lt;T&gt; from Ref&lt;Node&lt;T&gt;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// my example</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub fn peek_front(&amp;self) -&gt; Option&lt;Ref&lt;T&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self.head.as_ref().map(|node| {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Ref::map(node.borrow(), |node| &amp;node.elem)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>example2</li></ol><div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Makes a new Ref for a component of the borrowed data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// The RefCell is already immutably borrowed, so this cannot fail.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// This is an associated function that needs to be used as Ref::map(...). A method would interfere with methods of the same name on the contents of a RefCell used through Deref.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">use std::cell::{RefCell, Ref};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let c = RefCell::new((5, &#x27;b&#x27;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let b1: Ref&lt;(u32, char)&gt; = c.borrow();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">let b2: Ref&lt;u32&gt; = Ref::map(b1, |t| &amp;t.0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">assert_eq!(*b2, 5)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿" title="å¤åˆ¶" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="æ–‡æ¡£åˆ†é¡µå¯¼èˆª"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/-rust-è¯­è¨€"><div class="pagination-nav__sublabel">ä¸Šä¸€é¡µ</div><div class="pagination-nav__label">ğŸ¦€ Rust è¯­è¨€</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/rust/lists"><div class="pagination-nav__sublabel">ä¸‹ä¸€é¡µ</div><div class="pagination-nav__label">Too-Many-Lists</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-ç”Ÿå‘½å‘¨æœŸ" class="table-of-contents__link toc-highlight">1. ç”Ÿå‘½å‘¨æœŸ</a><ul><li><a href="#è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ" class="table-of-contents__link toc-highlight">è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ</a></li></ul></li><li><a href="#2-æ™ºèƒ½æŒ‡é’ˆ" class="table-of-contents__link toc-highlight">2. æ™ºèƒ½æŒ‡é’ˆ</a><ul><li><a href="#åŸºæœ¬æ¦‚å¿µ" class="table-of-contents__link toc-highlight">åŸºæœ¬æ¦‚å¿µ</a></li><li><a href="#ç®€å•å®ç°" class="table-of-contents__link toc-highlight">ç®€å•å®ç°</a></li><li><a href="#è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº" class="table-of-contents__link toc-highlight">è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº</a></li><li><a href="#è‡ªåŠ¨ç®¡ç†å†…å­˜" class="table-of-contents__link toc-highlight">è‡ªåŠ¨ç®¡ç†å†…å­˜</a></li></ul></li><li><a href="#2-atomic-åœ¨-rust-ä¸­çš„å®è·µ" class="table-of-contents__link toc-highlight">2. Atomic åœ¨ rust ä¸­çš„å®è·µ</a><ul><li><a href="#ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex" class="table-of-contents__link toc-highlight">ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex</a></li><li><a href="#acquire-ä¸-release" class="table-of-contents__link toc-highlight">Acquire ä¸ Release</a></li><li><a href="#å¿…éœ€ç”¨-seq-çš„åœºæ™¯" class="table-of-contents__link toc-highlight">å¿…éœ€ç”¨ Seq çš„åœºæ™¯</a></li></ul></li><li><a href="#3-å¸¸ç”¨-trait" class="table-of-contents__link toc-highlight">3. å¸¸ç”¨ Trait</a><ul><li><a href="#31-read" class="table-of-contents__link toc-highlight">3.1 Read</a></li><li><a href="#32-write" class="table-of-contents__link toc-highlight">3.2 Write</a></li><li><a href="#33-seek--bufreader--bufwriter" class="table-of-contents__link toc-highlight">3.3 Seek &amp; BufReader &amp; BufWriter</a></li></ul></li><li><a href="#4-å…¶ä»–" class="table-of-contents__link toc-highlight">4. å…¶ä»–</a><ul><li><a href="#2-rc--arc" class="table-of-contents__link toc-highlight">2. Rc &amp; Arc</a></li><li><a href="#4-cell--refcell" class="table-of-contents__link toc-highlight">4. Cell &amp; RefCell</a></li><li><a href="#5-ref--refmut" class="table-of-contents__link toc-highlight">5. Ref &amp; RefMut</a></li></ul></li></ul></div></div></div></div></main></div></div></div>
<script src="/assets/js/runtime~main.ce766e05.js"></script>
<script src="/assets/js/main.dc8abca6.js"></script>
</body>
</html>