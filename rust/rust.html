<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.35">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="https://trdthg-img-for-md-1306147581.cos.ap-beijing.myqcloud.com/img/202202022217241.jpg"><title>Rust | Trdthg's blog</title><meta name="description" content="æˆ‘çš„ä¸ªäººç½‘ç«™">
    <link rel="modulepreload" href="/assets/app.2196ae99.js"><link rel="modulepreload" href="/assets/rust.html.358571c0.js"><link rel="modulepreload" href="/assets/rust.html.e78a10d8.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js">
    <link rel="stylesheet" href="/assets/style.e8e8fc80.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">Trdthg&#39;s blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å­¦ä¹ ç¬”è®° ğŸ“š"><span class="title">å­¦ä¹ ç¬”è®° ğŸ“š</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å­¦ä¹ ç¬”è®° ğŸ“š"><span class="title">å­¦ä¹ ç¬”è®° ğŸ“š</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>å‰ç«¯ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/frontend/vdom" class="" aria-label="è™šæ‹Ÿ DOM"><!--[--><!--]--> è™šæ‹Ÿ DOM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/js_advanced" class="" aria-label="Js è¿›é˜¶"><!--[--><!--]--> Js è¿›é˜¶ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/list" class="" aria-label="èµ„æ–™"><!--[--><!--]--> èµ„æ–™ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/vue" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/http" class="" aria-label="HTTP ç›¸å…³"><!--[--><!--]--> HTTP ç›¸å…³ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/flutter" class="" aria-label="Flutter"><!--[--><!--]--> Flutter <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Python ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/other/python" class="" aria-label="æ€»è§ˆ"><!--[--><!--]--> æ€»è§ˆ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/java/java" class="" aria-label="åŸºç¡€çŸ¥è¯†"><!--[--><!--]--> åŸºç¡€çŸ¥è¯† <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/sourceread" class="" aria-label="éƒ¨åˆ†æºç "><!--[--><!--]--> éƒ¨åˆ†æºç  <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/spring" class="" aria-label="Spring æ¡†æ¶"><!--[--><!--]--> Spring æ¡†æ¶ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/springboot" class="" aria-label="å¸¸ç”¨å·¥å…·"><!--[--><!--]--> å¸¸ç”¨å·¥å…· <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å°ç©å…· ğŸ®"><span class="title">å°ç©å…· ğŸ®</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å°ç©å…· ğŸ®"><span class="title">å°ç©å…· ğŸ®</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projects/mini_vue" class="" aria-label="Mini-Vue"><!--[--><!--]--> Mini-Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_bundle" class="" aria-label="æ‰“åŒ…å™¨"><!--[--><!--]--> æ‰“åŒ…å™¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_tokio" class="" aria-label="å¼‚æ­¥è¿è¡Œæ—¶"><!--[--><!--]--> å¼‚æ­¥è¿è¡Œæ—¶ <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Rust ğŸ¦€"><span class="title">Rust ğŸ¦€</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Rust ğŸ¦€"><span class="title">Rust ğŸ¦€</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/rust/rust" class="router-link-active" aria-label="è¯­è¨€ç‰¹æ€§"><!--[--><!--]--> è¯­è¨€ç‰¹æ€§ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/wasm" class="" aria-label="Wasm"><!--[--><!--]--> Wasm <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/lists" class="" aria-label="Rust é“¾è¡¨"><!--[--><!--]--> Rust é“¾è¡¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/go" class="" aria-label="Go å­¦ä¹ ç¬”è®°"><!--[--><!--]--> Go å­¦ä¹ ç¬”è®° <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="é­”æ³• ğŸ”®"><span class="title">é­”æ³• ğŸ”®</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="é­”æ³• ğŸ”®"><span class="title">é­”æ³• ğŸ”®</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/magic/haskell" class="" aria-label="Haskell å­¦ä¹ ç¬”è®°"><!--[--><!--]--> Haskell å­¦ä¹ ç¬”è®° <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/fd" class="" aria-label="æ–‡ä»¶æè¿°ç¬¦"><!--[--><!--]--> æ–‡ä»¶æè¿°ç¬¦ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/linuxIO" class="" aria-label="IO å¤šè·¯å¤ç”¨"><!--[--><!--]--> IO å¤šè·¯å¤ç”¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/memory_ordering" class="" aria-label="åŸå­æ“ä½œ/å†…å­˜é¡ºåº"><!--[--><!--]--> åŸå­æ“ä½œ/å†…å­˜é¡ºåº <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/async" class="" aria-label="åç¨‹å¼‚æ­¥æ€è€ƒ"><!--[--><!--]--> åç¨‹å¼‚æ­¥æ€è€ƒ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/software_arch" class="" aria-label="è½¯ä»¶æ¶æ„"><!--[--><!--]--> è½¯ä»¶æ¶æ„ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/cicd" class="" aria-label="CI/CD"><!--[--><!--]--> CI/CD <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="IO Club âš½"><span class="title">IO Club âš½</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="IO Club âš½"><span class="title">IO Club âš½</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>åˆ†äº«</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/share_1" class="" aria-label="å…³äºæ•°æ®åº“ä¸ B+ æ ‘"><!--[--><!--]--> å…³äºæ•°æ®åº“ä¸ B+ æ ‘ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>æˆè¯¾</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_1" class="" aria-label="åç«¯ 1"><!--[--><!--]--> åç«¯ 1 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_2" class="" aria-label="åç«¯ 2"><!--[--><!--]--> åç«¯ 2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_3" class="" aria-label="åç«¯ 3"><!--[--><!--]--> åç«¯ 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_4" class="" aria-label="åç«¯ 4"><!--[--><!--]--> åç«¯ 4 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å…¶ä»– ğŸ“¦"><span class="title">å…¶ä»– ğŸ“¦</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å…¶ä»– ğŸ“¦"><span class="title">å…¶ä»– ğŸ“¦</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/other/hadoop" class="" aria-label="å¤§æ•°æ®"><!--[--><!--]--> å¤§æ•°æ® <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/script" class="" aria-label="è„šæœ¬"><!--[--><!--]--> è„šæœ¬ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/datastructure" class="" aria-label="æ•°æ®ç»“æ„"><!--[--><!--]--> æ•°æ®ç»“æ„ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/vim" class="" aria-label="Vim"><!--[--><!--]--> Vim <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/git" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/docker" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/analyze" class="" aria-label="æ€§èƒ½ç›‘æµ‹å·¥å…·"><!--[--><!--]--> æ€§èƒ½ç›‘æµ‹å·¥å…· <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oci" class="" aria-label="OCI è§„èŒƒ"><!--[--><!--]--> OCI è§„èŒƒ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oauth2" class="" aria-label="OAuth2.0"><!--[--><!--]--> OAuth2.0 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/article" class="" aria-label="æ–‡ç« ç¿»è¯‘"><!--[--><!--]--> æ–‡ç« ç¿»è¯‘ <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/trdthg" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="åˆ‡æ¢å¤œé—´"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å­¦ä¹ ç¬”è®° ğŸ“š"><span class="title">å­¦ä¹ ç¬”è®° ğŸ“š</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å­¦ä¹ ç¬”è®° ğŸ“š"><span class="title">å­¦ä¹ ç¬”è®° ğŸ“š</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>å‰ç«¯ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/frontend/vdom" class="" aria-label="è™šæ‹Ÿ DOM"><!--[--><!--]--> è™šæ‹Ÿ DOM <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/js_advanced" class="" aria-label="Js è¿›é˜¶"><!--[--><!--]--> Js è¿›é˜¶ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/list" class="" aria-label="èµ„æ–™"><!--[--><!--]--> èµ„æ–™ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/vue" class="" aria-label="Vue"><!--[--><!--]--> Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/http" class="" aria-label="HTTP ç›¸å…³"><!--[--><!--]--> HTTP ç›¸å…³ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/frontend/flutter" class="" aria-label="Flutter"><!--[--><!--]--> Flutter <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Python ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/other/python" class="" aria-label="æ€»è§ˆ"><!--[--><!--]--> æ€»è§ˆ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>Java ç›¸å…³</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/java/java" class="" aria-label="åŸºç¡€çŸ¥è¯†"><!--[--><!--]--> åŸºç¡€çŸ¥è¯† <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/sourceread" class="" aria-label="éƒ¨åˆ†æºç "><!--[--><!--]--> éƒ¨åˆ†æºç  <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/spring" class="" aria-label="Spring æ¡†æ¶"><!--[--><!--]--> Spring æ¡†æ¶ <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/java/springboot" class="" aria-label="å¸¸ç”¨å·¥å…·"><!--[--><!--]--> å¸¸ç”¨å·¥å…· <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å°ç©å…· ğŸ®"><span class="title">å°ç©å…· ğŸ®</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å°ç©å…· ğŸ®"><span class="title">å°ç©å…· ğŸ®</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/projects/mini_vue" class="" aria-label="Mini-Vue"><!--[--><!--]--> Mini-Vue <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_bundle" class="" aria-label="æ‰“åŒ…å™¨"><!--[--><!--]--> æ‰“åŒ…å™¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/projects/mini_tokio" class="" aria-label="å¼‚æ­¥è¿è¡Œæ—¶"><!--[--><!--]--> å¼‚æ­¥è¿è¡Œæ—¶ <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Rust ğŸ¦€"><span class="title">Rust ğŸ¦€</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Rust ğŸ¦€"><span class="title">Rust ğŸ¦€</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/rust/rust" class="router-link-active" aria-label="è¯­è¨€ç‰¹æ€§"><!--[--><!--]--> è¯­è¨€ç‰¹æ€§ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/wasm" class="" aria-label="Wasm"><!--[--><!--]--> Wasm <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/lists" class="" aria-label="Rust é“¾è¡¨"><!--[--><!--]--> Rust é“¾è¡¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/rust/go" class="" aria-label="Go å­¦ä¹ ç¬”è®°"><!--[--><!--]--> Go å­¦ä¹ ç¬”è®° <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="é­”æ³• ğŸ”®"><span class="title">é­”æ³• ğŸ”®</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="é­”æ³• ğŸ”®"><span class="title">é­”æ³• ğŸ”®</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/magic/haskell" class="" aria-label="Haskell å­¦ä¹ ç¬”è®°"><!--[--><!--]--> Haskell å­¦ä¹ ç¬”è®° <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/fd" class="" aria-label="æ–‡ä»¶æè¿°ç¬¦"><!--[--><!--]--> æ–‡ä»¶æè¿°ç¬¦ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/linuxIO" class="" aria-label="IO å¤šè·¯å¤ç”¨"><!--[--><!--]--> IO å¤šè·¯å¤ç”¨ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/memory_ordering" class="" aria-label="åŸå­æ“ä½œ/å†…å­˜é¡ºåº"><!--[--><!--]--> åŸå­æ“ä½œ/å†…å­˜é¡ºåº <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/async" class="" aria-label="åç¨‹å¼‚æ­¥æ€è€ƒ"><!--[--><!--]--> åç¨‹å¼‚æ­¥æ€è€ƒ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/software_arch" class="" aria-label="è½¯ä»¶æ¶æ„"><!--[--><!--]--> è½¯ä»¶æ¶æ„ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/cicd" class="" aria-label="CI/CD"><!--[--><!--]--> CI/CD <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="IO Club âš½"><span class="title">IO Club âš½</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="IO Club âš½"><span class="title">IO Club âš½</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>åˆ†äº«</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/share_1" class="" aria-label="å…³äºæ•°æ®åº“ä¸ B+ æ ‘"><!--[--><!--]--> å…³äºæ•°æ®åº“ä¸ B+ æ ‘ <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><li class="navbar-dropdown-item"><!--[--><h4 class="navbar-dropdown-subtitle"><span>æˆè¯¾</span></h4><ul class="navbar-dropdown-subitem-wrapper"><!--[--><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_1" class="" aria-label="åç«¯ 1"><!--[--><!--]--> åç«¯ 1 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_2" class="" aria-label="åç«¯ 2"><!--[--><!--]--> åç«¯ 2 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_3" class="" aria-label="åç«¯ 3"><!--[--><!--]--> åç«¯ 3 <!--[--><!--]--></a></li><li class="navbar-dropdown-subitem"><a href="/ioclub/backend_4" class="" aria-label="åç«¯ 4"><!--[--><!--]--> åç«¯ 4 <!--[--><!--]--></a></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="å…¶ä»– ğŸ“¦"><span class="title">å…¶ä»– ğŸ“¦</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="å…¶ä»– ğŸ“¦"><span class="title">å…¶ä»– ğŸ“¦</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/other/hadoop" class="" aria-label="å¤§æ•°æ®"><!--[--><!--]--> å¤§æ•°æ® <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/script" class="" aria-label="è„šæœ¬"><!--[--><!--]--> è„šæœ¬ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/datastructure" class="" aria-label="æ•°æ®ç»“æ„"><!--[--><!--]--> æ•°æ®ç»“æ„ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/vim" class="" aria-label="Vim"><!--[--><!--]--> Vim <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/git" class="" aria-label="Git"><!--[--><!--]--> Git <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/docker" class="" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/analyze" class="" aria-label="æ€§èƒ½ç›‘æµ‹å·¥å…·"><!--[--><!--]--> æ€§èƒ½ç›‘æµ‹å·¥å…· <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oci" class="" aria-label="OCI è§„èŒƒ"><!--[--><!--]--> OCI è§„èŒƒ <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/other/oauth2" class="" aria-label="OAuth2.0"><!--[--><!--]--> OAuth2.0 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/magic/article" class="" aria-label="æ–‡ç« ç¿»è¯‘"><!--[--><!--]--> æ–‡ç« ç¿»è¯‘ <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/trdthg" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Rust <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_1-ç”Ÿå‘½å‘¨æœŸ" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. ç”Ÿå‘½å‘¨æœŸ"><!--[--><!--]--> 1. ç”Ÿå‘½å‘¨æœŸ <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ" class="router-link-active router-link-exact-active sidebar-item" aria-label="è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ"><!--[--><!--]--> è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_2-æ™ºèƒ½æŒ‡é’ˆ" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. æ™ºèƒ½æŒ‡é’ˆ"><!--[--><!--]--> 2. æ™ºèƒ½æŒ‡é’ˆ <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#åŸºæœ¬æ¦‚å¿µ" class="router-link-active router-link-exact-active sidebar-item" aria-label="åŸºæœ¬æ¦‚å¿µ"><!--[--><!--]--> åŸºæœ¬æ¦‚å¿µ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#ç®€å•å®ç°" class="router-link-active router-link-exact-active sidebar-item" aria-label="ç®€å•å®ç°"><!--[--><!--]--> ç®€å•å®ç° <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº" class="router-link-active router-link-exact-active sidebar-item" aria-label="è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº"><!--[--><!--]--> è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#è‡ªåŠ¨ç®¡ç†å†…å­˜" class="router-link-active router-link-exact-active sidebar-item" aria-label="è‡ªåŠ¨ç®¡ç†å†…å­˜"><!--[--><!--]--> è‡ªåŠ¨ç®¡ç†å†…å­˜ <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_2-atomic-åœ¨-rust-ä¸­çš„å®è·µ" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. Atomic åœ¨ rust ä¸­çš„å®è·µ"><!--[--><!--]--> 2. Atomic åœ¨ rust ä¸­çš„å®è·µ <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex" class="router-link-active router-link-exact-active sidebar-item" aria-label="ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex"><!--[--><!--]--> ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#acquire-ä¸-release" class="router-link-active router-link-exact-active sidebar-item" aria-label="Acquire ä¸ Release"><!--[--><!--]--> Acquire ä¸ Release <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#å¿…éœ€ç”¨-seq-çš„åœºæ™¯" class="router-link-active router-link-exact-active sidebar-item" aria-label="å¿…éœ€ç”¨ Seq çš„åœºæ™¯"><!--[--><!--]--> å¿…éœ€ç”¨ Seq çš„åœºæ™¯ <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_3-å¸¸ç”¨-trait" class="router-link-active router-link-exact-active sidebar-item" aria-label="3. å¸¸ç”¨ Trait"><!--[--><!--]--> 3. å¸¸ç”¨ Trait <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_3-1-read" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.1 Read"><!--[--><!--]--> 3.1 Read <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_3-2-write" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.2 Write"><!--[--><!--]--> 3.2 Write <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_3-3-seek-bufreader-bufwriter" class="router-link-active router-link-exact-active sidebar-item" aria-label="3.3 Seek &amp; BufReader &amp; BufWriter"><!--[--><!--]--> 3.3 Seek &amp; BufReader &amp; BufWriter <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/rust/rust.html#_4-å…¶ä»–" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. å…¶ä»–"><!--[--><!--]--> 4. å…¶ä»– <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/rust/rust.html#_2-rc-arc" class="router-link-active router-link-exact-active sidebar-item" aria-label="2. Rc &amp; Arc"><!--[--><!--]--> 2. Rc &amp; Arc <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_4-cell-refcell" class="router-link-active router-link-exact-active sidebar-item" aria-label="4. Cell &amp; RefCell"><!--[--><!--]--> 4. Cell &amp; RefCell <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/rust/rust.html#_5-ref-refmut" class="router-link-active router-link-exact-active sidebar-item" aria-label="5. Ref &amp; RefMut"><!--[--><!--]--> 5. Ref &amp; RefMut <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="rust" tabindex="-1"><a class="header-anchor" href="#rust" aria-hidden="true">#</a> Rust</h1><h2 id="_1-ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#_1-ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> 1. ç”Ÿå‘½å‘¨æœŸ</h2><h3 id="è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ" aria-hidden="true">#</a> è‡ªåŠ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸ</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// Only one reference in input, so the output must be derived from that input</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">A</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">B</span><span class="token punctuation">;</span>

<span class="token comment">// Many inputs, assume they&#39;re all independent</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;b</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;c</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;b</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;c</span> <span class="token class-name">C</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Methods, assume all output lifetimes are derived from `self`</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">D</span><span class="token punctuation">;</span> <span class="token comment">// sugar for:</span>
<span class="token keyword">fn</span> <span class="token function-definition function">foo</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;b</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">&#39;c</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token keyword">self</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;b</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;c</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;a</span> <span class="token class-name">D</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_2-æ™ºèƒ½æŒ‡é’ˆ" tabindex="-1"><a class="header-anchor" href="#_2-æ™ºèƒ½æŒ‡é’ˆ" aria-hidden="true">#</a> 2. æ™ºèƒ½æŒ‡é’ˆ</h2><h3 id="åŸºæœ¬æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºæœ¬æ¦‚å¿µ" aria-hidden="true">#</a> åŸºæœ¬æ¦‚å¿µ</h3><p>å®ç°äº† Deref Trait å’Œ Drop Trait çš„å°±æ˜¯æ™ºèƒ½æŒ‡é’ˆ</p><ol><li>Deref Trait: å…·æœ‰æŒ‡é’ˆè¯­ä¹‰</li><li>Drop Traitï¼šæ‹¥æœ‰å†…å­˜è‡ªåŠ¨ç®¡ç†çš„æœºåˆ¶</li></ol><p>çœ‹ä¸€çœ¼ Box çš„å®ç°</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[stable(feature = <span class="token string">&quot;rust1&quot;</span>, since = <span class="token string">&quot;1.0.0&quot;</span>)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token operator">?</span><span class="token class-name">Sized</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token punctuation">:</span> <span class="token class-name">Allocator</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">A</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">T</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token keyword">self</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="ç®€å•å®ç°" tabindex="-1"><a class="header-anchor" href="#ç®€å•å®ç°" aria-hidden="true">#</a> ç®€å•å®ç°</h3><p>æˆ‘ä»¬å®ç°ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆï¼ˆåªå®ç°äº† Deref Traitï¼‰</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>t<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token class-name">MySmartPointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">MySmartPointer</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token class-name">T</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Target</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// è°ƒç”¨*x å…¶å®å°±æ˜¯è°ƒç”¨ *x.deref()</span>
<span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token class-name">MySmartPointer</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº" aria-hidden="true">#</a> è‡ªåŠ¨è§£å¼•ç”¨çš„æ—¶æœº</h3><ul><li><p>é‡åˆ°*è¿ç®—ç¬¦è‡ªåŠ¨æ¥å¼•ç”¨</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">.</span><span class="token function">deref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>é‡åˆ° . è¿ç®—ç¬¦æ¥å¼•ç”¨è°ƒç”¨æ–¹æ³•</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div></li><li><p>å‚æ•°ä¼ é€’è‡ªåŠ¨è§£å¼•ç”¨</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> s <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">&quot;aaaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">take_str</span><span class="token punctuation">(</span>s<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token macro property">print!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">take_str</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[stable(feature = <span class="token string">&quot;rust1&quot;</span>, since = <span class="token string">&quot;1.0.0&quot;</span>)]</span>
<span class="token keyword">impl</span> <span class="token namespace">ops<span class="token punctuation">::</span></span><span class="token class-name">Deref</span> <span class="token keyword">for</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token type-definition class-name">Target</span> <span class="token operator">=</span> <span class="token keyword">str</span><span class="token punctuation">;</span>

    <span class="token attribute attr-name">#[inline]</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">deref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">str</span> <span class="token punctuation">{</span>
        <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>vec<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul><h3 id="è‡ªåŠ¨ç®¡ç†å†…å­˜" tabindex="-1"><a class="header-anchor" href="#è‡ªåŠ¨ç®¡ç†å†…å­˜" aria-hidden="true">#</a> è‡ªåŠ¨ç®¡ç†å†…å­˜</h3><p>è‡ªåŠ¨åŒ–ç®¡ç†å†…å­˜ (dropï¼Œä½œç”¨åŸŸå¤–è‡ªåŠ¨é‡Šæ”¾å†…å­˜)</p><h2 id="_2-atomic-åœ¨-rust-ä¸­çš„å®è·µ" tabindex="-1"><a class="header-anchor" href="#_2-atomic-åœ¨-rust-ä¸­çš„å®è·µ" aria-hidden="true">#</a> 2. Atomic åœ¨ rust ä¸­çš„å®è·µ</h2><p><a href="https://www.youtube.com/watch?v=rMGWeSjctlY" target="_blank" rel="noopener noreferrer">Crust of Rust: Atomics and Memory Ordering<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-atomic-å®ç°ç®€å•çš„-mutex" aria-hidden="true">#</a> ä½¿ç”¨ Atomic å®ç°ç®€å•çš„ Mutex</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">sync<span class="token punctuation">::</span>atomic<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">AtomicBool</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">,</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token keyword">self</span><span class="token punctuation">,</span> spawn<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token namespace">cell<span class="token punctuation">::</span></span><span class="token class-name">UnsafeCell</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">UNLOCKED</span><span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">LOCKED</span><span class="token punctuation">:</span> <span class="token keyword">bool</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    locked<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">,</span>
    v<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">unsafe</span> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Sync</span> <span class="token keyword">for</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token class-name">Mutex</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>v<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            locked<span class="token punctuation">:</span> <span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            v<span class="token punctuation">:</span> <span class="token class-name">UnsafeCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// æš´éœ²ä¸€ä¸ªå¯å˜å¼•ç”¨å‡ºå»</span>
    <span class="token comment">///</span>
    <span class="token comment">/// å½“çº¿ç¨‹ A å’Œçº¿ç¨‹ B åŒæ—¶æ‰§è¡Œæ—¶ï¼ŒAï¼ŒB å¯èƒ½åŒæ—¶æ‹¿åˆ°ğŸ”“ï¼Œå¹¶åŒæ—¶ä¸Šé”ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å¹¶æ²¡æœ‰`çœ‹åˆ°`å¯¹æ–¹é¡µæ‹¿åˆ°äº†é”</span>
    <span class="token comment">/// æ‰€ä»¥å°±å‡ºå…ˆäº†ï¼Œ çº¿ç¨‹ A å’Œ B åŒæ—¶ä»å¯„å­˜å™¨æ‹¿åˆ°å€¼ 1ï¼Œæ”¹ä¸ºäº† 2ï¼Œç„¶åå¤åˆ¶åˆ°å¯„å­˜å™¨å†…ï¼Œåä¿®æ”¹çš„ä¼šè¦†ç›–å‰ä¸€æ¬¡ä¿®æ”¹</span>
    <span class="token comment">/// ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä¸‹é¢æ˜¯ä¸€äº›è§£å†³æ–¹æ³•</span>
    <span class="token comment">///</span>
    <span class="token comment">/// æ–¹æ¡ˆ 1ï¼Œä½¿ç”¨`compare_exchange`åˆå¹¶åŠ é”ä¸Šé”è¿‡ç¨‹</span>
    <span class="token comment">/// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span>
    <span class="token comment">///</span>
    <span class="token comment">/// #1 compare_exchange æ˜¯ä½æ•ˆçš„ï¼Œå¦‚æœæ˜¯å¤šæ ¸éƒ½åœ¨åŒæ—¶äº‰å¤ºé”ï¼Œ8 ä¸ªæ ¸ä¸­æœ‰ä¸€ä¸ªå’Œå…ˆæ‹¿åˆ°äº†é”</span>
    <span class="token comment">/// é‚£ä¹ˆå‰©ä¸‹çš„ 7 ä¸ªæ ¸ä¾ç„¶ä¼šäº’ç›¸ç«äº‰ï¼Œè¿™ä¸ªå˜é‡çš„å†…å­˜å°±ä¼šåœ¨å¤šä¸ªæ ¸ä¸­ä¸æ–­æ‹·è´</span>
    <span class="token comment">/// #2 ç›¸æ¯”äº mutexï¼Œmutex æ‹¿ä¸åˆ°é”å°±ä¼šé˜»å¡çº¿ç¨‹ï¼Œè€Œ compare_exchange æ‹¿ä¸åˆ°å°±ä¼šè¿”å›ä¸€ä¸ª Err</span>
    <span class="token comment">/// #3 rust ä¸­è¿˜æä¾›äº† compare_and_exchange_weakï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯</span>
    <span class="token comment">///     compare_and_exchange åªå…è®¸åœ¨åˆ¤æ–­ Current v alue å’Œä¼ å…¥çš„å€¼ä¸ä¸€æ ·æ—¶è¿”å› Err</span>
    <span class="token comment">///     compare_and_exchange_weak å³ä½¿åœ¨ä¸€æ ·çš„æ—¶å€™ä¹Ÿå¯èƒ½ä¼šè¿”å› Errï¼Œè¿™ç§ç»†å°çš„å·®åˆ«èƒ½å¤Ÿç”¨äºæŸäº›åœºæ™¯ï¼Œè®©æ€§èƒ½æ›´å¥½</span>
    <span class="token comment">///     åŸå› æ˜¯ç”±äºåœ¨ä¸åŒå¹³å°ä¸Šçš„å®ç°ä¸åŒ</span>
    <span class="token comment">///         x86: compare_and_swap</span>
    <span class="token comment">///         ARM: LDREX STREX</span>
    <span class="token comment">///     åœ¨ x86 ä¸Š weak ä¸æ™®é€šçš„ç›¸åŒï¼Œ</span>
    <span class="token comment">///     åœ¨ ARM ä¸Šï¼š</span>
    <span class="token comment">///         compare_and_exchange: impl using a loop of LDREX and STREX</span>
    <span class="token comment">///         compare_and_exchange_weak: LDREX and STREX with no loop, it may be fake</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_lock</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span> <span class="token punctuation">{</span>
        <span class="token comment">// æ‹¿ğŸ”“ ä¸ŠğŸ”“</span>
        <span class="token comment">// while self.locked.load(Ordering::Relaxed) != UNLOCKED {}</span>
        <span class="token comment">// self.locked.store(LOCKED, Ordering::Relaxed);</span>

        <span class="token comment">// æ–¹æ¡ˆ 1</span>
        <span class="token comment">// while self.locked.compare_exchange(UNLOCKED, LOCKED, Ordering::Relaxed, Ordering::Relaxed).is_err() {}</span>

        <span class="token comment">// æ–¹æ¡ˆ 2 åœ¨ arm ä¸‹æœ‰æ›´å¥½çš„æ€§èƒ½</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token constant">LOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å‡å¦‚ç°åœ¨ current value å°±æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå·²ç»ä¿®æ”¹ä¸º LOCKED çŠ¶æ€ï¼Œé‚£ä¹ˆå°±å·²ç»æ‹¿åˆ°äº†æ‰€æœ‰æƒ</span>
            <span class="token comment">// åŠ å…¥ç°åœ¨è¿˜æ²¡æœ‰ä¿®æ”¹å®Œæˆï¼Œcurrent value ä¾ç„¶æ˜¯ UNLOCKED çŠ¶æ€ï¼Œå½“å‰çº¿ç¨‹å°±ä¼šå¡ä½ï¼Œç›´åˆ°æœ‰åˆ«çš„çº¿ç¨‹æˆåŠŸæ‹¿åˆ°äº†æ‰€æœ‰æƒ</span>
            <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOCKED</span> <span class="token punctuation">{</span>
                <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æš´éœ²æ•°æ®</span>
        <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è§£ğŸ”“</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> l<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Mutex</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> handles<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1000</span> <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span><span class="token function">with_lock</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>v <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> handle <span class="token keyword">in</span> handles <span class="token punctuation">{</span>
        handle<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è¿™é‡Œä¾ç„¶ä¼šæŠ¥é”™</span>
    <span class="token macro property">assert_eq!</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">with_lock</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">*</span>v<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br></div></div><h3 id="acquire-ä¸-release" tabindex="-1"><a class="header-anchor" href="#acquire-ä¸-release" aria-hidden="true">#</a> Acquire ä¸ Release</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// ä½†æ˜¯å³ä½¿ç”¨äº†ä¸Šé¢çš„ä¸œè¥¿ä¹Ÿæœ‰å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œè™½ç„¶åœ¨ X86 64 ä½ç³»ç»Ÿä¸Šæ²¡æœ‰å‡ºç°é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸ºä»–ä¸æ”¯æŒï¼ï¼Œä»–åªæ”¯æŒ Seq çš„ï¼Œä¸è¿‡è¿˜æ˜¯è¦è¯´æ˜é—®é¢˜</span>
<span class="token comment">/// å› ä¸ºä¸‹é¢å¯¹å˜é‡ v çš„ä¿®æ”¹å’Œä¸Šé”é‡Šæ”¾é”çš„è¿‡ç¨‹æ¯«ä¸ç›¸å…³ï¼Œ</span>
<span class="token comment">/// æ‰€ä»¥ä¸‹ä¸€è¡Œå¯èƒ½è¢«é‡æ–°æ’åˆ—åœ¨åŠ é”ä¹‹å‰ï¼Œæˆ–è€…è§£é”ä¹‹åï¼Œè¿™ä¸¤ç§éƒ½æ˜¯ä¸å…è®¸çš„ï¼Œä½†æ˜¯ cpu å’Œç¼–è¯‘å™¨å°±å¯èƒ½è¿™æ ·åš</span>
<span class="token comment">///</span>
<span class="token comment">/// å¯¹æ­¤éœ€è¦ä½¿ç”¨ Acquire å’Œ Release</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">with_lock2</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token keyword">impl</span> <span class="token class-name">FnOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">R</span> <span class="token punctuation">{</span>
    <span class="token comment">// ä»»ä½•ä¹‹åçš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Acquire ä¹‹å‰</span>
    <span class="token comment">// åˆ«çš„çº¿ç¨‹ä¸­çš„å†™æ“ä½œï¼Œå¯¹äºè¿™é‡Œçš„ Acquire éƒ½æ˜¯å¯è§çš„</span>
    <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">compare_exchange_weak</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token constant">LOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOCKED</span> <span class="token punctuation">{</span>
            <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">yield_now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> ret <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">unsafe</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token operator">*</span><span class="token keyword">self</span><span class="token punctuation">.</span>v<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä»»ä½•ä¹‹å‰çš„è¯»å†™æ“ä½œä¸ä¼šè¢«é‡æ’åˆ° Release ä¹‹å</span>
    <span class="token comment">// è¿™ä¸ªçº¿ç¨‹é‡Œçš„æ‰€æœ‰å†™æ“ä½œå¯¹åˆ«çš„çº¿ç¨‹ä¸­çš„ Acquire éƒ½æ˜¯å¯è§çš„</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>locked<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token constant">UNLOCKED</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="å¿…éœ€ç”¨-seq-çš„åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#å¿…éœ€ç”¨-seq-çš„åœºæ™¯" aria-hidden="true">#</a> å¿…éœ€ç”¨ Seq çš„åœºæ™¯</h3><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[test]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">seq_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// fetch_add always succeed</span>

    <span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicBool</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> z<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">&#39;static</span> _ <span class="token operator">=</span> <span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">leak</span><span class="token punctuation">(</span><span class="token class-name">Box</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tx <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        x<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">// ï¼ï¼ï¼</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> ty <span class="token operator">=</span> <span class="token namespace">thread<span class="token punctuation">::</span></span><span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        y<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t1 <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span>x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            z<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> t2 <span class="token operator">=</span> <span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span><span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token operator">!</span>y<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                    <span class="token comment">// è¿™è¡Œå’Œä¸‹é¢ä¸€è¡Œå¯èƒ½é‡æ’ (æˆ–è€…è¯´ä¸æ˜¯é‡æ’ï¼Œå•çº¯æ—¶å¯è§æ€§çš„é—®é¢˜ï¼Œä¸‹é¢çš„ x å°±æ˜¯çœ‹åˆ°äº† x æ˜¯ false)</span>
        <span class="token keyword">if</span> x<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Acquire</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                         <span class="token comment">// ï¼ï¼ï¼ x ä¸º falseï¼Œå½“ x è¢«ä¿®æ”¹ä¸º true åï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿæ”¹å˜</span>
            z<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Release</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> z<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">SeqCst</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// What are the possibles for z?</span>
    <span class="token comment">// - is 0 possibly ?</span>
    <span class="token comment">//   ç»è¿‡åˆ¤æ–­ï¼Œè‡³å°‘æœ‰ä¸‹é¢çš„æ¡ä»¶</span>
    <span class="token comment">//     t1 must run after tx</span>
    <span class="token comment">//     t2 must run after ty</span>
    <span class="token comment">//   å‡ ç§æ’åˆ—ç»„åˆåº”è¯¥æ˜¯ 1 æˆ– 2ï¼Œæ²¡æœ‰ 0</span>
    <span class="token comment">//   ä½†æ˜¯ 0 è¿˜æ˜¯å¯èƒ½çš„ï¼Œ</span>
    <span class="token comment">//           t2    t1,t2</span>
    <span class="token comment">//   MO(x)  false  true</span>
    <span class="token comment">//           t1    t1,t2</span>
    <span class="token comment">//   MO(y)  false  true</span>
    <span class="token comment">// - is 1 possibly ?</span>
    <span class="token comment">//   Yes: tx -&gt; t1 -&gt; ty -&gt; t2</span>
    <span class="token comment">// - is 2 possibly ?</span>
    <span class="token comment">//   Yes: tx -&gt; ty -&gt; t1 -&gt; t2</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h2 id="_3-å¸¸ç”¨-trait" tabindex="-1"><a class="header-anchor" href="#_3-å¸¸ç”¨-trait" aria-hidden="true">#</a> 3. å¸¸ç”¨ Trait</h2><h3 id="_3-1-read" tabindex="-1"><a class="header-anchor" href="#_3-1-read" aria-hidden="true">#</a> 3.1 Read</h3><p>Read Trait çš„åŠŸèƒ½æ˜¯ï¼šä»æ•°æ®æºæ‹‰å– (Pull) ä¸€å®šæ•°æ®åˆ°æŒ‡å®šçš„ç¼“å†²åŒºï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><p><strong>å…³äºé˜»å¡ï¼š</strong> read å‡½æ•°ä¸ä¿è¯ Read æ˜¯å¦ä¼šå¤„äºé˜»å¡çŠ¶æ€ï¼Œå¦‚æœä¸€ä¸ª read è¿‡ç¨‹é˜»å¡äº†è€Œä¸”ç­‰å¾…å¤±è´¥ï¼Œé‚£ä»–å°±ä¼šè¿”å›ä¸€ä¸ª [<code>Err</code>] æ ‡è®°ã€‚</p><p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>read()</code>è¿”å›çš„æ˜¯ [<code>OK(n)</code>] , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚ å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>reader å·²ç»åˆ°è¾¾äº†<code>the end of file</code>ï¼Œè€Œä¸”è¿™ä¸ª<code>file</code>å¯èƒ½ä¸ä¼šåœ¨äº§ç”Ÿæ–°æ•°æ®ã€‚ æ³¨æ„ï¼Œè¿™é‡Œåªæ˜¯ likelyï¼Œæ¯”å¦‚ï¼šåœ¨ linux ç³»ç»Ÿä¸­ï¼Œread å¯èƒ½å¯¹ä¸€ä¸ª [<code>TcpStream</code>] è°ƒç”¨äº†<code>recv</code>ç³»ç»Ÿè°ƒç”¨ï¼Œ0 ä»£è¡¨è¿™ä¸ªè¿æ¥å·²ç»è¢«æˆåŠŸå…³é—­ï¼Œå¦‚æœæ˜¯å¯¹ [<code>File</code>] , é‚£å°±å¯èƒ½æ„å‘³ç€ç¡®å®è¯»å–åˆ°äº†æ–‡ä»¶çš„æœ«å°¾ï¼Œä½†æ˜¯å¦‚æœæœ‰æ›´å¤šçš„æ•°æ®è¢«è¿½åŠ  (append) åˆ°æ–‡ä»¶æœ«å°¾ï¼Œé‚£ä¹ˆæœªæ¥çš„ read æ“ä½œä¾ç„¶èƒ½å¤Ÿæ­£å¸¸è¿”å›è¢«è¿½åŠ çš„æ•°æ®</li><li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li></ol><p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p><p><strong>å…³äºå®‰å…¨æ€§ï¼š</strong></p><ul><li><p>å› ä¸ºå®ç°è¿™ä¸ª Trait æ˜¯å®‰å…¨çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½ç”¨ <code>n &lt; buf.len()</code> å»ç¡®ä¿å®‰å…¨ï¼Œä½¿ç”¨ unsafe æ˜¯æ›´è¦å°å¿ƒç¡®ä¿è¯¸å¦‚è¶Šç•Œé—®é¢˜æ˜¯å¦ä¼šå‘ç”Ÿã€‚</p></li><li><p>read ä¸ä¿è¯ buf é‡Œçš„æ•°æ®æ˜¯å¯¹çš„ï¼Œæ‰€ä»¥ä¸æ¨èè¯»å–ç¼“å†²åŒºé‡Œçš„æ•°æ®ï¼Œåªæ¨èå‘ç¼“å†²åŒºé‡Œå†™å…¥æ•°æ®</p></li><li><p>ç›¸åº”çš„ï¼Œè°ƒç”¨è€…ä¸èƒ½æœ‰ä»»ä½•å‡è®¾ï¼Œè¿™ä¸ª buf ä¼šè¢« read æ€ä¹ˆä½¿ç”¨ï¼Œread å‡½æ•°ä¹Ÿå¯èƒ½ä¼šä»ä¸­è¯»å–å†…å®¹ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿è¯åœ¨è°ƒç”¨ read å‰ï¼Œè¿™ä¸ª buf å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†ï¼Œè°ƒç”¨æ²¡æœ‰è¢«åˆå§‹åŒ–çš„ buf æ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœªå®šä¹‰çš„è¡Œä¸º</p></li></ul><p>*<strong>å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰è¯»å–è¿‡ä»»ä½•å­—èŠ‚ï¼Œå¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œ è¯»å–è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæ¥è‡ª doc çš„ä¾‹å­</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// read up to 10 bytes</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The bytes: {:?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-2-write" tabindex="-1"><a class="header-anchor" href="#_3-2-write" aria-hidden="true">#</a> 3.2 Write</h3><p>Write çš„åŸºæœ¬åŠŸèƒ½å°±æ˜¯å‘ writer ä¸­å†™å…¥ä¸€æ®µ bufï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚æ•° <strong>å…³äºé˜»å¡ï¼š</strong> write ä¼šå°è¯•å‘ writer ä¸­å†™å…¥æ•´ä¸ª buf é‡Œçš„å†…å®¹ï¼Œä½†æ˜¯å†™å…¥å¯èƒ½ä¸æˆåŠŸï¼Œæˆ–è€…å†™å…¥æ—¶äº§ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œè°ƒç”¨ä¸€æ¬¡ write æ„å‘³ç€æœ€å¤šä¸€æ¬¡å°è¯•å†™å…¥ write å‡½æ•°åŒæ ·ä¸ä¿è¯ Write æ˜¯å¦å¤„äºé˜»å¡çŠ¶æ€ä»¥ç­‰å¾…æ•°æ®è¢«å†™å…¥ï¼Œå¦‚æœä¸€æ¬¡å†™å…¥é˜»å¡äº†ï¼Œä»–å¯èƒ½ä¼šè¿”å›ä¸€ä¸ª [<code>Err</code>]ã€‚</p><p><strong>å…³äºè¿”å›å€¼ï¼š</strong> å¦‚æœ<code>write()</code>è¿”å›çš„æ˜¯ [<code>OK(n)</code>] , å®ƒçš„å®ç°å°±å¿…é¡»ä¿è¯<code>0 &lt;- n &lt; buf.len()</code>ã€‚ å¦‚æœ<code>n == 0</code>ï¼Œé‚£å¯èƒ½æœ‰ä¸¤ç§æƒ…å†µï¼š</p><ol><li>è¢«å†™å…¥çš„ä¸œè¥¿å·²ç»ä¸ä¼šæ¥å—æ–°æ•°æ®äº†ï¼Œä¹‹åä¹Ÿä¸ä¸€å®šä¼š</li><li>ç¼“å†²åŒº (buffer) å¤§å°ç¡®å®å°±æ˜¯ 0</li></ol><p><code>n</code> åªè¦å°äºç¼“å†²åŒºçš„é•¿åº¦ä¸€èˆ¬å°±ä¸æ˜¯ä¸ªé”™è¯¯ï¼Œå³ä½¿æ–‡ä»¶è¿˜æ²¡æœ‰è¢«è¯»å–å®Œï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šå‘ç”Ÿåœ¨ï¼Œå½“å‰åªæœ‰ä¸€éƒ¨åˆ†æ•°æ®æ˜¯å¯ç”¨çš„ï¼Œæˆ–è€…æ˜¯ read æ“ä½œè¢«ä¸€ä¸ªä¿¡å·æ‰“æ–­äº†</p><p>*<strong>å…³äºé”™è¯¯ï¼š</strong> å¦‚æœé‡åˆ°äº† Errorï¼Œé‚£å°±å¿…é¡»ä¿è¯æ²¡æœ‰ä»»ä½•å­—èŠ‚è¢«æˆåŠŸå†™å…¥ è¿”å›å€¼å°äº buf çš„é•¿åº¦ä¸è¢«å½“æˆæ˜¯é”™è¯¯ å¦‚æœé‡åˆ°äº†<code>ErrorKind::Interrupted</code>ï¼Œè€Œä¸”ä¸èƒ½ä½œåˆ«çš„äº‹æ—¶ï¼Œå†™å…¥è¿‡ç¨‹å°±å¿…é¡»è¢«å›æ»š</p><p>åŒæ ·æ˜¯å®˜æ–¹çš„ demo</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// Writes some prefix of the byte string, not necessarily all of it.</span>
    buffer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">b&quot;some bytes&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_3-3-seek-bufreader-bufwriter" tabindex="-1"><a class="header-anchor" href="#_3-3-seek-bufreader-bufwriter" aria-hidden="true">#</a> 3.3 Seek &amp; BufReader &amp; BufWriter</h3><p>[<code>Read</code>] å’Œ [<code>Write</code>] æ˜¯æœ€é‡è¦çš„ä¸¤ä¸ª Traitï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„ Trait[<code>Seek</code>] å’Œ [<code>BufRead</code>], è¿™ä¸¤ä¸ªéƒ½å»ºç«‹åœ¨ reader åªä¸Šï¼Œç”¨æ¥æ§åˆ¶ read çš„è¿‡ç¨‹ã€‚</p><p>[<code>Seek</code>] è®©ä½ æ§åˆ¶ä¸‹ä¸€ä¸ªå­—èŠ‚å°†è¦è¯»å–çš„æ¥è‡ªå“ªé‡Œ</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>io<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>io<span class="token punctuation">::</span></span><span class="token class-name">SeekFrom</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>fs<span class="token punctuation">::</span></span><span class="token class-name">File</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// skip to the last 10 bytes of the file</span>
    f<span class="token punctuation">.</span><span class="token function">seek</span><span class="token punctuation">(</span><span class="token class-name">SeekFrom</span><span class="token punctuation">::</span><span class="token class-name">End</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// read up to 10 bytes</span>
    <span class="token keyword">let</span> n <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;The bytes: {:?}&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>buffer<span class="token punctuation">[</span><span class="token punctuation">..</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>åŸºäº byte çš„æ¥å£æ€§èƒ½ä¸ä½³ï¼Œæ‰€ä»¥æä¾›äº†å¾ˆå¤šåŸºäº buffer çš„æ¥å£ [<code>BufRead</code>] å°±æä¾›äº†æ›´å¤š Read ç›¸å…³çš„ API</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> reader <span class="token operator">=</span> <span class="token class-name">BufReader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> buffer <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// read a line into buffer</span>
reader<span class="token punctuation">.</span><span class="token function">read_line</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> buffer<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>[<code>BufWriter</code>] æ²¡æœ‰æä¾›æ›´å¤šå†™å…¥çš„æ–¹æ³•ï¼Œä»–åªæ˜¯ç¼“å†²äº†æ¯æ¬¡è°ƒç”¨</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">let</span> f <span class="token operator">=</span> <span class="token class-name">File</span><span class="token punctuation">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;foo.txt&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> writer <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// write a byte to the buffer</span>
    writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token number">42</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token comment">// the buffer is flushed once writer goes out of scope</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="_4-å…¶ä»–" tabindex="-1"><a class="header-anchor" href="#_4-å…¶ä»–" aria-hidden="true">#</a> 4. å…¶ä»–</h2><h3 id="_2-rc-arc" tabindex="-1"><a class="header-anchor" href="#_2-rc-arc" aria-hidden="true">#</a> 2. Rc &amp; Arc</h3><h4 id="ä»‹ç»" tabindex="-1"><a class="header-anchor" href="#ä»‹ç»" aria-hidden="true">#</a> ä»‹ç»</h4><blockquote><p>The key to our design is the RefCell type. The heart of RefCell is a pair of methods:</p></blockquote><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">borrow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">borrow_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">RefMut</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">&#39;_</span><span class="token punctuation">,</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>Introducing inherited mutability roots to shared types Shared smart pointer types, including Rc and Arc, provide containers that can be cloned and shared between multiple parties. Because the contained values may be multiply-aliased, they can only be borrowed as shared references, not mutable references. Without cells it would be impossible to mutate data inside of shared boxes at all!</p></blockquote><blockquote><p>It&#39;s very common then to put a RefCell inside shared pointer types to reintroduce mutability:</p></blockquote><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>collections<span class="token punctuation">::</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token class-name">RefCell</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>rc<span class="token punctuation">::</span></span><span class="token class-name">Rc</span><span class="token punctuation">;</span>
<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shared_map<span class="token punctuation">:</span> <span class="token class-name">Rc</span><span class="token operator">&lt;</span><span class="token class-name">RefCell</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span> <span class="token operator">=</span> <span class="token class-name">Rc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">HashMap</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;africa&quot;</span><span class="token punctuation">,</span> <span class="token number">92388</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;kyoto&quot;</span><span class="token punctuation">,</span> <span class="token number">11837</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;piccadilly&quot;</span><span class="token punctuation">,</span> <span class="token number">11826</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shared_map<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">&quot;marbles&quot;</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p>Note that this example uses Rc and not Arc. RefCells are for single-threaded scenarios. Consider using Mutex if you need shared mutability in a multi-threaded situation</p></blockquote><h4 id="try-unwrap" tabindex="-1"><a class="header-anchor" href="#try-unwrap" aria-hidden="true">#</a> try_unwrap()</h4><blockquote><p>Get T from Rc&lt;T&gt; try to use <code>try_unwrap()</code>, which moves out the contents of an Rc if its refcount is 1 ::: warning unwrap on Result requires that you can debug-print the error case. RefCell only implements Debug if T does. Node doesn&#39;t implement Debug. try: Rc::try_unwrap(old_head).ok().unwrap().into_inner().elem :::</p></blockquote><h3 id="_4-cell-refcell" tabindex="-1"><a class="header-anchor" href="#_4-cell-refcell" aria-hidden="true">#</a> 4. Cell &amp; RefCell</h3><blockquote><p>Shareable mutable containers.</p><p>Values of the Cell and RefCell types may be mutated through shared references (i.e. the common &amp;T type), whereas most Rust types can only be mutated through unique (&amp;mut T) references. We say that Cell and RefCell provide &#39;interior mutability&#39;, in contrast with typical Rust types that exhibit &#39;inherited mutability&#39;.</p><p>Cell types come in two flavors: Cell and RefCell. Cell provides get and set methods that change the interior value with a single method call. Cell though is only compatible with types that implement Copy. For other types, one must use the RefCell type, acquiring a write lock before mutating.</p><p>RefCell uses Rust&#39;s lifetimes to implement &#39;dynamic borrowing&#39;, a process whereby one can claim temporary, exclusive, mutable access to the inner value. Borrows for RefCells are tracked &#39;at runtime&#39;, unlike Rust&#39;s native reference types which are entirely tracked statically, at compile time. Because RefCell borrows are dynamic it is possible to attempt to borrow a value that is already mutably borrowed; when this happens it results in thread panic.</p></blockquote><h3 id="_5-ref-refmut" tabindex="-1"><a class="header-anchor" href="#_5-ref-refmut" aria-hidden="true">#</a> 5. Ref &amp; RefMut</h3><h4 id="ref-map" tabindex="-1"><a class="header-anchor" href="#ref-map" aria-hidden="true">#</a> Ref::map()</h4><ol><li>example1</li></ol><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Ref</span><span class="token operator">&lt;</span> <span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> f<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">U</span><span class="token operator">&gt;</span>
<span class="token comment">// Get Ref&lt;T&gt; from Ref&lt;Node&lt;T&gt;&gt;</span>
<span class="token comment">// my example</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">peek_front</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token class-name">Ref</span><span class="token punctuation">::</span><span class="token function">map</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>node<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span>node<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>example2</li></ol><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">// Makes a new Ref for a component of the borrowed data.</span>

<span class="token comment">// The RefCell is already immutably borrowed, so this cannot fail.</span>

<span class="token comment">// This is an associated function that needs to be used as Ref::map(...). A method would interfere with methods of the same name on the contents of a RefCell used through Deref.</span>

<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>cell<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">RefCell</span><span class="token punctuation">,</span> <span class="token class-name">Ref</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> c <span class="token operator">=</span> <span class="token class-name">RefCell</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token char">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b1<span class="token punctuation">:</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">borrow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b2<span class="token punctuation">:</span> <span class="token class-name">Ref</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">Ref</span><span class="token punctuation">::</span><span class="token function">map</span><span class="token punctuation">(</span>b1<span class="token punctuation">,</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>t<span class="token closure-punctuation punctuation">|</span></span> <span class="token operator">&amp;</span>t<span class="token number">.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token operator">*</span>b2<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/trdthg/edit/main/rust/rust.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page"><!--[--><!--]--> Edit this page <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!----><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.2196ae99.js" defer></script>
  </body>
</html>
